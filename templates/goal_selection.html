{% extends 'base.html' %}

{% block content %}
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- THE SCREEN SURFACE -->
    <div class="screen-surface d-flex flex-column position-relative overflow-hidden" style="min-height: 85vh;">
      
      <!-- 1. HEADER BAR -->
      <div id="gs-header" class="bg-white border-bottom px-5 py-4 d-flex justify-content-between align-items-center shadow-sm z-30 position-relative">
        <div class="d-flex align-items-center gap-4">
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1">Mission Parameter</div>
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display" style="font-size: 2rem;">"{{ user_input }}"</h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0" title="Edit Parameter"><i class="fas fa-pencil-alt"></i></button>
               </div>
           </div>
           <!-- (Edit Container Hidden) -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <div class="d-flex gap-3">
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> RE-CALCULATE
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">ABORT</a>
        </div>
      </div>

      <!-- 2. THE STAGE VIEWPORT (3D Context) -->
      <div id="stage-viewport">
        
        <!-- A. THE GALLERY GRID (Initial State) -->
        <div class="goal-grid" id="goalCardsContainer">
            {% for goal in goals %}
               <div class="flip-card-wrapper {{ 'violation' if not goal.is_compliant else '' }}" 
                    data-card-id="goal-{{ loop.index0 }}"
                    data-card-title="{{ goal.title | e }}"
                    data-color-hue="{{ goal.color_hue | default(180) }}"
                    data-goal-index="{{ loop.index0 }}"
                    onclick="window.selectGoal(this)">
                    <div class="flip-card-inner">
                        <!-- BACK (Monolith) -->
                        <div class="flip-card-back" style="background: {{ goal.card_gradient | default('linear-gradient(135deg, #00bcd4 0%, #2979ff 100%)') }};">
                            <div class="card-texture-overlay"></div>
                            <div class="monolith-content">
                                <div class="monolith-icon-circle"><i class="{{ goal.icon }} monolith-icon"></i></div>
                                {% if not goal.is_compliant %}
                                    <span class="badge bg-black bg-opacity-25 border border-danger text-white font-data px-3 py-2">PROTOCOL VIOLATION</span>
                                {% else %}
                                    <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1">STRUCTURED SPECULATION</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- FRONT (Details) -->
                        <div class="flip-card-front">
                             <div class="card-header-plate" style="background: {{ goal.plate_gradient | default('linear-gradient(135deg, #4dd0e1 0%, #00bcd4 100%)') }};">
                                 <div class="card-texture-overlay"></div>
                                 <div class="card-domain-badge-large">{{ goal.domain | upper }}</div>
                                 <div class="card-icon-float-large"><i class="{{ goal.icon }}" style="color: {{ goal.icon_color | default('#00838f') }};"></i></div>
                             </div>
                             <div class="card-body-large">
                                 <h3 class="card-title-large">{{ goal.title }}</h3>
                                 <p class="card-desc-large">{{ goal.goal }}</p>
                             </div>
                             <div class="card-footer-large">
                                 <button type="button" class="btn-select-pill-large" style="background: {{ goal.btn_gradient | default('linear-gradient(to right, #00bcd4, #00838f)') }};">
                                     {{ 'PROTOCOL VIOLATION' if not goal.is_compliant else 'CHOOSE GOAL' }}
                                 </button>
                             </div>
                        </div>
                    </div>
                    <!-- Dynamic Dock for System Pills -->
                    <div class="system-pill-dock position-absolute top-0 start-0 w-100 p-4 d-flex flex-column gap-2" style="z-index: 5; pointer-events: none;"></div>
               </div>
            {% endfor %}
        </div>

        <!-- B. THE CONFIGURATION WIZARD (Slides in) -->
        <div id="configuration-stage">
            <div class="split-col-right">
                <div class="wizard-container">
                    
                    <!-- HEADER -->
                    <div class="wizard-header d-flex justify-content-between align-items-center">
                        <div>
                            <div class="font-data text-primary small fw-bold tracking-widest mb-2">CONFIGURATION</div>
                            <div class="wizard-progress">
                                <div class="progress-segment active" id="dot-1"></div>
                                <div class="progress-segment" id="dot-2"></div>
                                <div class="progress-segment" id="dot-3"></div>
                            </div>
                        </div>
                        <button class="btn btn-link font-data text-muted small text-decoration-none" onclick="window.skipToSpeculate()">
                            SKIP TO SOLUTION <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>

                    <!-- CONTENT -->
                    <div class="wizard-content" id="wizard-content-area">
                        
                        <!-- STEP 1: IDENTITY -->
                        <div class="wizard-step" id="step-1">
                            <div class="text-center mb-4">
                                <h2 class="font-brand text-dark">Who Is Driving?</h2>
                                <p class="text-muted font-body small">Select the operational entity to calibrate resource leverage.</p>
                            </div>
                            <div class="wizard-identity-grid">
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Individual', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-user"></i></div>
                                    <div class="wizard-identity-text"><h6>INDIVIDUAL AGENT</h6><p>Personal action. High autonomy.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Grassroots', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-users"></i></div>
                                    <div class="wizard-identity-text"><h6>COMMUNITY / GRASSROOTS</h6><p>Volunteer network. Driven by passion.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Team', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-rocket"></i></div>
                                    <div class="wizard-identity-text"><h6>SMALL TEAM / STARTUP</h6><p>Dedicated group. Speed & growth.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('NonProfit', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-hand-holding-heart"></i></div>
                                    <div class="wizard-identity-text"><h6>NON-PROFIT / NGO</h6><p>Mission-driven. Public trust.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Enterprise', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-building"></i></div>
                                    <div class="wizard-identity-text"><h6>CORPORATE / ENTERPRISE</h6><p>Large-scale commercial resources.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Public', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-landmark"></i></div>
                                    <div class="wizard-identity-text"><h6>PUBLIC / CIVIC BODY</h6><p>Regulatory authority. High leverage.</p></div>
                                </div>
                            </div>
                            
                            <!-- Context Helper (Injected via JS) -->
                            <div id="context-helper-box" class="bg-dark text-white p-4 rounded-4 shadow-sm mt-4 d-none opacity-0 transition-all">
                                <div id="context-helper-text"></div>
                            </div>
                        </div>

                        <!-- STEP 2: HORIZON -->
                        <div class="wizard-step d-none" id="step-2">
                            <div class="text-center mb-5">
                                <h2 class="font-brand text-dark">Target Horizon</h2>
                                <p class="text-muted font-body small">When does this possibility collapse into reality?</p>
                            </div>
                            <div class="d-flex justify-content-center">
                                <div class="p-4 border rounded-4 bg-light shadow-inner text-center" style="max-width: 400px; width: 100%;">
                                    <label class="font-data text-muted x-small tracking-widest mb-2">COMPLETION DATE</label>
                                    <input type="date" class="form-control form-control-lg font-brand p-3 text-center fs-3 border-2" 
                                           id="input-horizon" onchange="window.setHorizon(this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3: BUDGET -->
                        <div class="wizard-step d-none" id="step-3">
                            <div class="text-center mb-4">
                                <h2 class="font-brand text-dark">Resource Model</h2>
                                <p class="text-muted font-body small">Define the fuel source for this trajectory.</p>
                            </div>
                            <div class="wizard-identity-grid">
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Bootstrapped', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-hammer"></i></div>
                                    <div class="wizard-identity-text"><h6>BOOTSTRAPPED ($0)</h6><p>Sweat equity and bartering.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Crowdfunded', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-bullhorn"></i></div>
                                    <div class="wizard-identity-text"><h6>CROWDFUNDED</h6><p>Public backing and engagement.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Grant Funded', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-file-signature"></i></div>
                                    <div class="wizard-identity-text"><h6>GRANT FUNDED</h6><p>Compliance-heavy, slow release.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Venture Capital', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="wizard-identity-text"><h6>VENTURE CAPITAL</h6><p>High growth, equity exchange.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Public Budget', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-landmark"></i></div>
                                    <div class="wizard-identity-text"><h6>PUBLIC BUDGET</h6><p>Taxpayer funded. High oversight.</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="wizard-footer border-top p-3 d-flex justify-content-between align-items-center bg-white mt-auto">
                        <button class="btn btn-link text-muted font-data small text-decoration-none" onclick="window.resetStage()">
                            <i class="fas fa-chevron-left me-1"></i> BACK
                        </button>
                        
                        <button class="btn btn-dark rounded-pill px-4 font-data small shadow-sm" id="btn-next" disabled onclick="window.nextStep()">
                            NEXT <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- 3. PAGE FOOTER (The System Bar) -->
      <div class="px-5 py-3 bg-white border-top mt-auto d-flex justify-content-between align-items-center z-20 position-relative">
         <!-- LEFT: FRIENDLY STATUS -->
         <div class="d-flex align-items-center gap-3">
            <div id="global-status-dot" class="rounded-circle bg-success shadow-sm animate-pulse" 
                 style="width: 6px; height: 6px; transition: background-color 0.3s;"></div>
            <span id="global-status-text" class="font-body small text-muted fw-bold">
                {{ system_status }}
            </span>
         </div>

         <!-- RIGHT: VERSION -->
         <span class="font-data text-muted small letter-spacing-2 opacity-75">
             SSPEC HORIZON {{ system_version }}
         </span>
      </div>

    </div>
  </div>
</div>

<!-- HIDDEN SUBMISSION FORM -->
<form id="final-submit-form" method="POST" action="{{ url_for('routes_bp.outcome') }}" class="d-none">
    <input type="hidden" name="selected_goal" id="form-goal">
    <input type="hidden" name="selected_goal_title" id="form-title">
    <input type="hidden" name="domain" id="form-domain">
    <input type="hidden" name="domain_icon" id="form-domain-icon">
    
    <input type="hidden" name="system_operator" id="form-operator">
    <input type="hidden" name="system_horizon" id="form-horizon">
    <input type="hidden" name="system_budget" id="form-budget">
</form>
{% endblock %}

{% block scripts %}
<script>
    // Pass raw goal data to JS for initial state
    window.GOAL_COLOR_DATA = {{ goals | tojson | safe }};
</script>
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
{% endblock %}