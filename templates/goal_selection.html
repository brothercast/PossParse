{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER: Locks to viewport height, no global scroll -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- SCREEN SURFACE: Flex column layout -->
    <div class="screen-surface">
      
      <!-- 1. HEADER BAR: Mission Parameter & Controls -->
      <div id="gs-header" class="bg-white border-bottom px-5 py-2 d-flex justify-content-between align-items-center shadow-sm z-30 position-relative" style="height: 80 px; flex-shrink: 0;">
        
        <!-- Left: Input Display/Edit -->
        <div class="d-flex align-items-center gap-4">
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1"> YOUR POSSIBILITY </div>
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display text-truncate" 
                       style="font-size: 2rem; max-width: 900px;" 
                       title="{{ user_input }}">
                       "{{ user_input }}"
                   </h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0 ms-2" title="Edit Parameter">
                       <i class="fas fa-pencil-alt"></i>
                   </button>
               </div>
           </div>
           
           <!-- Hidden Edit Mode -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <!-- Right: Actions -->
        <div class="d-flex gap-3">
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> GENERATE NEW GOALS
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">START OVER</a>
        </div>
      </div>

      <!-- 2. STAGE VIEWPORT: Consumes remaining height, handles internal scrolling -->
      <div id="stage-viewport">
        
        <!-- A. THE GALLERY GRID (Initial View) -->
        <div class="goal-grid" id="goalCardsContainer">
            {% for goal in goals %}
               <!-- FIX: Removed the stray closing bracket '>' that was cutting off attributes -->
               <div class="flip-card-wrapper {% if not goal.is_compliant %}violation{% endif %}" 
                    data-card-id="goal-{{ loop.index0 }}"
                    data-card-title="{{ goal.title | e }}"
                    data-color-hue="{{ goal.color_hue | default(180) }}"
                    data-goal-index="{{ loop.index0 }}"
                    onclick="window.selectGoal(this)">
                    
                    <div class="flip-card-inner">
                        <!-- BACK FACE (Monolith/Hero) -->
                        <div class="flip-card-back" style="background: {{ goal.card_gradient | default('linear-gradient(135deg, #00bcd4 0%, #2979ff 100%)') }};">
                            <div class="card-texture-overlay"></div>
                            <div class="monolith-content">
                                <div class="monolith-icon-circle"><i class="{{ goal.icon }} monolith-icon"></i></div>
                                {% if not goal.is_compliant %}
                                    <span class="badge bg-black bg-opacity-25 border border-danger text-white font-data px-3 py-2 mt-3">PROTOCOL VIOLATION</span>
                                {% else %}
                                    <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1 mt-3">STRUCTURED SPECULATION</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- FRONT FACE (Goal Details) -->
                        <div class="flip-card-front">
                             <div class="card-header-plate" style="background: {{ goal.plate_gradient | default('linear-gradient(135deg, #4dd0e1 0%, #00bcd4 100%)') }};">
                                 <div class="card-texture-overlay"></div>
                                 <div class="card-domain-badge-large">{{ goal.domain | upper }}</div>
                                 <div class="card-icon-float-large"><i class="{{ goal.icon }}" style="color: {{ goal.icon_color | default('#00838f') }};"></i></div>
                             </div>
                             <div class="card-body-large">
                                 <h3 class="card-title-large">{{ goal.title }}</h3>
                                 <p class="card-desc-large">{{ goal.goal }}</p>
                             </div>
                             <div class="card-footer-large">
                                 <button type="button" class="btn-select-pill-large" style="background: {{ goal.btn_gradient | default('linear-gradient(to right, #00bcd4, #00838f)') }};">
                                     {{ 'PROTOCOL VIOLATION' if not goal.is_compliant else 'CHOOSE GOAL' }}
                                 </button>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Dock for System Pills (Injected by JS) -->
                    <div class="system-pill-dock position-absolute top-0 start-0 w-100 p-4 d-flex flex-column gap-2" style="z-index: 5; pointer-events: none;"></div>
               </div>
            {% endfor %}
        </div>

        <!-- B. CONFIGURATION WIZARD (Slides In) -->
        <div id="configuration-stage">
            <div class="split-col-right">
                
                <!-- The Wizard Container: Strictly Flexbox for No-Scroll Layout -->
                <div class="wizard-container">
                    
                    <!-- Track Header -->
                    <div class="wizard-header">
                        <div class="wizard-progress-track" id="wizard-track">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                    
                    <!-- Main Content: Grows to fill space, Scrolls internally if needed -->
                    <div class="wizard-content" id="wizard-main-area">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted flex-column">
                            <i class="fas fa-circle-notch fa-spin fa-2x mb-3 text-secondary"></i> 
                            <span class="font-data small tracking-widest">INITIALIZING FLIGHT DECK...</span>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="wizard-footer">
                        <button class="wiz-btn-back" id="btn-wiz-back" onclick="window.wizardBack()" style="visibility: hidden;">
                            <i class="fas fa-chevron-left me-2"></i> BACK
                        </button>
                        
                        <button class="wiz-btn-next" id="btn-wiz-next" onclick="window.wizardNext()">
                            NEXT <i class="fas fa-chevron-right ms-2"></i>
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
      
      </div>

      <!-- 3. PAGE FOOTER: System Status -->
      <div class="px-5 py-3 bg-white border-top mt-auto d-flex justify-content-between align-items-center z-20 position-relative" style="height: 60px; flex-shrink: 0;">
         <div class="d-flex align-items-center gap-3">
            <div id="global-status-dot" class="rounded-circle bg-success shadow-sm animate-pulse" style="width: 6px; height: 6px;"></div>
            <span id="global-status-text" class="font-body small text-muted fw-bold">{{ system_status }}</span>
         </div>
         <span class="font-data text-muted small letter-spacing-2 opacity-75">SSPEC HORIZON {{ system_version }}</span>
      </div>

    </div>
  </div>
</div>

<!-- HIDDEN SUBMISSION FORM (Population handled by JS) -->
<form id="final-submit-form" method="POST" action="{{ url_for('routes_bp.outcome') }}" class="d-none">
    <input type="hidden" name="selected_goal" id="form-goal">
    <input type="hidden" name="selected_goal_title" id="form-title">
    <input type="hidden" name="domain" id="form-domain">
    <input type="hidden" name="domain_icon" id="form-domain-icon">
    
    <input type="hidden" name="system_operator" id="form-operator">
    <input type="hidden" name="system_horizon" id="form-horizon">
    <input type="hidden" name="system_budget" id="form-budget">
    
    <!-- Dynamic inputs (DIRECTIVE, AVOIDANCE, etc) appended by JS -->
</form>
{% endblock %}

{% block scripts %}
<script>
    // 1. Inject Visual Data for Cards
    window.GOAL_COLOR_DATA = {{ goals | tojson | safe }};
    
    // 2. Inject Master Configuration from Python (system_nodes.py)
    // This allows the Wizard to dynamically build itself based on the Backend Logic
    window.WIZARD_CONFIG = {{ system_nodes | tojson | safe }};
</script>

<!-- Load the Controller -->
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
{% endblock %}