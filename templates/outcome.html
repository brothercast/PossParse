{% extends 'base.html' %}

{% block content %}
<div class="container">
    <!-- Title Row (Spanning Full Width) -->
    <div class="row">
        <div class="col text-center">
            <h1 class="ssol-title">{{ ssol.ssol_title | safe }}</h1> <!-- Use h1 for main title -->
        </div>
    </div>

    <!-- Image and Domain Row -->
    <div class="row">
        <div class="col-md-4 text-center">
            <!-- Image Wrapper (for stacking) -->
            <div class="image-wrapper">
                <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" alt="Placeholder Image" class="rounded mb-3 placeholder-image" id="placeholderImage">
                <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" alt="Generated Image" class="rounded mb-3 generated-image" id="ssolImage">
            </div>
            <!-- Container for error messages (added) -->
            <div id="image-error-container"></div>

            <h2>Domain</h2>
            <i class="{{ ssol.domain_icon }} fa-3x mb-3"></i>
            <p class="domain domain-text text-center domain-text">{{ ssol.domain | title }}</p>
            <h2>Fulfilled Goal</h2>
            <p><strong>{{ ssol.selected_goal | safe }}</strong></p>
            <div id="ssol-goal" style="display: none;">{{ ssol.selected_goal | safe }}</div>
            <!-- PDF Button (Moved to bottom of left column) -->
            <div class="text-center mt-4">
                <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-info" title="Save as PDF">
                    <i class="fas fa-download me-2"></i>PDF
                </button>
            </div>
        </div>

        <!-- Summary Column -->
        <div class="col-md-8">
                <h1>Preliminary Structured Solution</h1>
                <p id="ssol-summary">{{ ssol.ssol_summary | safe }}</p>
        </div>

    <!-- Phases & COS Row (Remains the Same) -->
   <div class="row">
        <h1>Phases & Conditions of Satisfaction</h1>
        <div class="col">
            <div class="accordion mt-4" id="phase-accordion">
                {% for phase_name, cos_list in ssol.phases.items() %}
                <div class="accordion-item">
                    <h2 class="accordion-header phase-colors" id="heading-{{ phase_name | replace(' ', '_') }}">
                        <button
                            class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ phase_name | replace(' ', '_') }}"
                            aria-expanded="true"
                            aria-controls="collapse-{{ phase_name | replace(' ', '_') }}"
                            style="background-color: var(--phase-{{ loop.index0 }});">
                            {{ phase_name | title }} PHASE
                            <span class="phase-progress-bar">
                                <!-- Optional: Progress bar for phase completion -->
                                <div class="progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                                  <div class="progress-bar" style="width: 60%;"></div>
                                </div>
                            </span>
                        </button>
                    </h2>
                    <div
                        id="collapse-{{ phase_name | replace(' ', '_') }}"
                        class="accordion-collapse collapse show"
                        aria-labelledby="heading-{{ phase_name | replace(' ', '_') }}"
                        data-bs-parent="#phase-accordion">
                        <div class="accordion-body phase-card-container" data-ssol-id="{{ ssol_id }}" style="border: 2px solid var(--phase-{{ loop.index0 }});">
                            {% if cos_list %}
                                <div class="cos-card-grid"> <!-- Grid layout for COS cards -->
                                    {% for cos in cos_list %}
                                    <div class="cos-card" data-cos-id="{{ cos.id }}" data-editing="false">
                                        <div class="cos-card-header">
                                            <span class="status-pill {{ cos.status | get_badge_class_from_status }}">{{ cos.status | upper }}</span>
                                            <div class="cos-actions">
                                                <button class="btn btn-sm btn-primary edit-cos-button" title="Edit COS"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-sm btn-success update-cos-button d-none" title="Update COS"><i class="fas fa-check"></i></button>
                                                <button class="btn btn-sm btn-secondary cancel-cos-button d-none" title="Cancel Edit"><i class="fas fa-times"></i></button>
                                                <button class="btn btn-sm btn-danger delete-cos-button" title="Delete COS"><i class="fas fa-trash"></i></button>
                                                <button class="btn btn-sm btn-info analyze-cos-button" data-cos-id="{{ cos.id }}" title="Analyze COS"><i class="fas fa-search-plus"></i></button>
                                            </div>
                                        </div>
                                        <div class="cos-card-body">
                                            <div class="cos-content-display">
                                                {{ cos.content | safe }}  <!-- Display COS content with CE pills -->
                                            </div>
                                            <div class="cos-content-edit d-none">
                                                <textarea class="form-control form-control-sm cos-content-textarea" rows="3">{{ cos.content }}</textarea>
                                            </div>
                                            <div class="cos-details">
                                                <div class="detail-item">
                                                    <label class="detail-label">Accountable Party:</label>
                                                    <span class="cos-accountable-party-display">{{ cos.accountable_party }}</span>
                                                    <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                                </div>
                                                <div class="detail-item">
                                                    <label class="detail-label">Completion Date:</label>
                                                    <span class="cos-completion-date-display">{{ cos.completion_date }}</span>
                                                    <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ce-pills-container"> <!-- Container for CE pills below COS card -->
                                            <!-- CE pills would be dynamically added here by JS, based on cos.content -->
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button class="btn btn-success btn-sm add-cos" data-bs-toggle="modal" data-bs-target="#addCOSModal" data-phase="{{ phase_name | replace(' ', '_') }}">Add Condition of Satisfaction</button>
                            {% else %}
                                <p>No Conditions of Satisfaction found for this phase.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">{{ error_message }}</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Placeholder for dynamic modals -->
    <div id="dynamicModalContainer"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Necessary JS files - LOAD AS MODULES -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Get SSOL ID and image element
    const ssolId = "{{ ssol_id }}";
    const ssolImage = document.getElementById('ssolImage');
    const placeholderImage = document.getElementById('placeholderImage');
    const imageErrorContainer = document.getElementById('image-error-container'); // Get the error container

    ssolImage.classList.remove('loaded'); // Ensure fade-in class is not present initially

    // 2. Fetch the image path from the backend
    fetch(`/get_ssol_image/${ssolId}`)
      .then(response => {
        if (!response.ok) {
          // Handle non-OK responses (e.g., 404, 500)
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json(); // Parse JSON response
      })
      .then(data => {
        if (data.image_path) {
          // 3. Set the image source and handle onload for fade-in
          ssolImage.src = data.image_path;
          placeholderImage.classList.add('hidden'); // Hide placeholder GIF
          ssolImage.onload = () => {
            ssolImage.classList.add('loaded'); // Add 'loaded' class to trigger fade-in
          };
          ssolImage.onerror = () => {
            console.error('Error loading SSOL image from path:', data.image_path);
            ssolImage.alt = 'Error loading image';
             // Optionally, display a broken image icon or placeholder here
          };
        } else {
          console.warn('No image_path received in JSON response:', data);
          // Handle default image or error message display
          if (data.error) {
              console.error("Server reported image generation error:", data.error);
              // Display data.error in the UI
              const errorDiv = document.createElement('div');
              errorDiv.textContent = data.error;
              errorDiv.classList.add('alert', 'alert-danger'); // Use Bootstrap alert classes
              imageErrorContainer.appendChild(errorDiv); // Append to the error container
          }
        }
      })
      .catch(error => {
        // Handle fetch errors and JSON parsing errors
        console.error('Error fetching or processing image data:', error);
        ssolImage.alt = 'Error generating image';
        // Optionally display error message in the UI.
        const errorDiv = document.createElement('div');
        errorDiv.textContent = 'An unexpected error occurred while loading the image.';
        errorDiv.classList.add('alert', 'alert-danger'); // Use Bootstrap alert classes
        imageErrorContainer.appendChild(errorDiv);
      });
  });
</script>
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>

<!-- Include Tabulator CSS and JS -->
<link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>


<!-- Pass necessary data to JavaScript -->
<script>
    const NODES = {{ nodes|tojson }};
    const tableData = {};  // Define tableData here. Update this with actual data if needed.
</script>
{% endblock %}