{% extends 'base.html' %}

{% block content %}
  <div class="container">
    <div class="row outcome-header">
      <div class="col-md-4 text-center">
        {% if generated_image_path %}  
          <img src="/{{ generated_image_path }}" alt="Generated Image" class="rounded mb-3 generated-image" style="width: 100%; max-width: 300px;">  
        {% endif %}   
        <h2>Domain</h2>
        <i class="{{ domain_icon }} fa-3x mb-3"></i>
        <p class="domain domain-text text-center">{{ domain | title }}</p>
        <h2>Fulfilled Goal</h2>
        <p><strong>{{ ssol.goal | safe }}</strong></p>
      </div>
      <div class="col-md-8">
        <div>
          <h1>Preliminary Structured Solution</h1>
          <p>{{ ssol_summary | safe }}</p>
        </div>
      </div>
    </div>

    <div class="row">
      <h1>Phases & Conditional Elements</h1>
      <div class="col">
        <div class="accordion mt-4" id="phase-accordion">
        {% for phase_name, ce_list in ssol.phases.items() %}
          <div class="accordion-item">
            <h2 class="accordion-header phase-colors" id="heading-{{ phase_name }}">
              <button
                class="accordion-button"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ phase_name }}"
                aria-expanded="true"
                aria-controls="collapse-{{ phase_name }}"
                style="background-color: var(--phase-{{ loop.index0 }});"
              >
                {{ phase_name | title }} PHASE
              </button>
            </h2>
            <div
              id="collapse-{{ phase_name }}"
              class="accordion-collapse collapse show"
              aria-labelledby="heading-{{ phase_name }}"
              data-bs-parent="#phase-accordion"
            >
              <div class="accordion-body" style="border: 2px solid var(--phase-{{ loop.index0 }});">
                {% if ce_list %}
                  <table class="table table-striped phase-table" id="{{ phase_name }}-table">  
                    <thead>
                      <tr>
                        <th scope="col">Status</th>
                        <th scope="col">Condition of Satisfaction</th>
                        <th scope="col">Accountable Party</th>
                        <th scope="col">Completion Date</th>
                        <th scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for ce in ce_list %}
                        <tr class="ce-row" data-ce-id="{{ ce.id }}"> <!-- Ensure data-ce-id is set correctly -->
                          <td class="status-cell">
                            <span class="badge {{ ce.status | get_badge_class_from_status }} status-pill">{{ ce.status }}</span>
                          </td>
                          <td class="ce-content-cell">{{ ce.content }}</td>
                          <td class="ce-accountable-party-cell">{{ ce.accountable_party }}</td>
                          <td class="ce-completion-date-cell">{{ ce.completion_date }}</td>
                          <td>
                            <button class="btn btn-sm btn-primary edit-ce-button">Edit</button>
                            <button class="btn btn-sm btn-success update-ce-button d-none">Update</button> <!-- Add update button -->
                            <button class="btn btn-sm btn-secondary cancel-ce-button d-none">Cancel</button> <!-- Add cancel button -->
                            <button class="btn btn-sm btn-danger delete-ce-button">Delete</button>
                            <button class="btn btn-sm btn-info analyze-ce-button" data-ce-id="{{ ce.id }}">Analyze</button>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>                    
                  </table>
                  <button class="btn btn-success btn-sm add-ce" data-bs-toggle="modal" data-bs-target="#addCEModal" data-phase="{{ phase_name }}">Add Condition of Satisfaction</button>
                {% else %}
                  <p>No Conditional Elements found for this phase.</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
        </div>
      </div>
    </div>

    <!-- Add CE Modal -->
    <div class="modal fade" id="addCEModal" tabindex="-1" aria-labelledby="addCEModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCEModalLabel">Add Condition of Satisfaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addCEForm">
              <!-- Modal form content goes here -->
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ce_table.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>
{% endblock %}
