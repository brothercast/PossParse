‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC Build Metadata (v202502260296)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
As a senior dev, I've analyzed the changes for version `202502260296`. This release introduces significant enhancements across AI capabilities, UI/UX, and architectural robustness. The focus appears to be on integrating advanced AI governance, providing more dynamic and visually rich user interfaces, and improving resource management.

Here's a summary of the technical changes:

### `ai_service.py`

*   **Request-Scoped Gemini Client Management:**
    *   Introduced `ContextVar` (`_gemini_client_context`) for `genai.Client` instances, ensuring a dedicated client per request context.
    *   Implemented `cleanup_gemini_client()` to asynchronously close the `aiohttp` session of the Gemini client after each request, preventing resource leaks.
*   **New Bicameral AI Governance System:**
    *   Added `generate_governance_report` function, which orchestrates two distinct AI roles:
        *   **Ombud:** Focuses on strict constraint checking and identifying violations (negative feedback loop, low temperature).
        *   **Advocate:** Provides strategic synthesis and identifies opportunities (positive feedback loop, higher temperature).
    *   This system leverages `SAFETY_PROTOCOL` (imported from `system_nodes`) as a core charter for the Ombud.
*   **Enhanced AI Prompting & Safety:**
    *   `generate_chat_response` now supports an optional `system_instruction` which is prepended to the first user message, offering more granular control over AI behavior.
    *   Default `safety_settings` (blocking only high-severity content for various harm categories) are now consistently applied to Gemini API calls if not explicitly overridden.
    *   `generate_chat_response_with_node_types` was added to dynamically inject valid node types into the system instruction, guiding the AI to produce structured JSON.
*   **Improved Image Generation:**
    *   `generate_image` now explicitly sets `response_modalities=["TEXT", "IMAGE"]` in the generation configuration.
    *   Enhanced logic for extracting image data from multi-part Gemini responses, iterating through candidates and parts.
    *   Incorporated `sanitize_filename` for secure and valid file naming when saving generated images.
*   **Refined Message Handling:** The `send_request_to_gemini` function includes more robust parsing and conversion of input messages into `google.genai.types.Content` objects, including role mapping for `assistant`/`model` roles.

### `routes.py`

*   **Robust Resource Cleanup:**
    *   Integrated `cleanup_gemini_client()` into a `@routes_bp.teardown_app_request` handler, ensuring the Gemini client's resources are released at the end of every request.
*   **Centralized Hybrid Data Persistence:**
    *   Created `speculate_update_ssol_system_node_internal` as a unified helper for updating SSOL `system_data` (JSON column) across both database and in-memory storage, reducing code duplication.
*   **Dynamic AI Attenuation Layer:**
    *   The `/speculate_context` route now dynamically constructs AI `system_instructions` by incorporating SSOL context (e.g., `target_date`, `owner`) and `prompt_injection` configurations from `SYSTEM_NODES`. This allows "system physics" to influence AI generation.
    *   This route also now contains a dedicated branch to trigger the new `generate_governance_report` for bicameral AI feedback.
*   **Enhanced Outcome Generation Flow (`/outcome`):**
    *   Wizard inputs for system constraints are now dynamically extracted based on `SYSTEM_NODES` keys, making the constraint definition more flexible.
    *   AI-generated `system_params` are intelligently merged with user-defined `system_constraints`, prioritizing user input.
    *   `generate_image` is now called asynchronously to avoid blocking the user interface during image generation.
    *   Key data points like `raw_summary` and `domain_icon` are explicitly saved to `system_data` using the new internal update helper.
*   **Improved SSOL Visualization (`/ssol/<uuid:ssol_id>`):**
    *   Enhanced hybrid data fetching logic for SSOL and COS entities, supporting both database and in-memory modes.
    *   Improved distribution of Conditional Elements (COS) across predefined project phases (`Discovery`, `Engagement`, `Action`, `Completion`, `Legacy`) for better visual organization.
    *   Added fallbacks for `system_data` and `domain_icon` to ensure consistent display.
*   **Flexible System Node Updates:**
    *   The `update_ssol_system_node` route now handles specific system nodes like `HORIZON` (which updates `target_date`) and `OPERATOR` (which updates `owner`) as direct SSOL attributes, alongside their storage in `system_data`.

### `system_templates.py`

*   **New UI Components for System Monitoring & Governance:**
    *   **`HORIZON_GAUGE_TEMPLATE`:** Introduced a sophisticated, single-line visual component displaying project timeline, progress percentage, health-based color coding, milestones, and a real-time countdown.
    *   **`GOVERNANCE_WIDGET_TEMPLATE`:** Added a dedicated widget to display the structured feedback from the Ombud (oversight) and Advocate (insight) AI roles, including status badges and a refresh button.
    *   **`SYSTEM_EDITOR_MODAL_TEMPLATE` (Calibration Wizard):** A major overhaul of the system configuration modal into a two-panel, carousel-driven interface. Features include:
        *   Dynamic content display (definition, guide, examples).
        *   "Specify" vs. "Speculate" protocol toggles for different AI interaction modes.
        *   "Hard Constraint" vs. "Soft Guideline" selection.
        *   Rationale input field.
        *   Carousel navigation for iterating through system nodes.
*   **Refined `SYSTEM_SIDEBAR_STACK_TEMPLATE`:** Updated to use a "System Pill" design, aligning with the new visual language, and renamed to "System Physics" stack.
*   **Dynamic Template Rendering Logic:** `render_command_deck` now includes complex date calculations, health-based color assignments, and dynamic parameter enrichment to power the new Horizon Gauge and System Sidebar components.

### `styles.css`

*   **Comprehensive Design System Implementation:**
    *   **Extensive CSS Variables:** Introduced a wide array of variables for consistent branding, phase-specific colors, and fluid responsive typography/spacing, laying the groundwork for a scalable design system.
    *   **Typography Overhaul:** Integrated new font families (`Righteous`, `Manrope`, `Antonio`, `Mr Dafoe`, `Unica One`) to establish a distinct and modern visual hierarchy across the application.
*   **Dynamic & Thematic Backgrounds:**
    *   The `aurora-background` now utilizes phase-specific blob colors, visually tying background elements to project stages.
    *   Dynamic opacity and grayscale filtering (`body.state-outcome`) were added to visually indicate different application states.
*   **Console Housing & Input Stage Redesign:**
    *   Introduced `horizon-wrapper` and `console-housing` with new background patterns, `backdrop-filter`, and shadows for a polished, app-like feel.
    *   The input stage (`input-bezel`, `huge-input`, `btn-launch`) received significant styling updates for a more modern appearance, including animations, gradients, and subtle visual effects.
*   **Advanced UI Component Styling:**
    *   Developed extensive CSS to bring the new `HORIZON_GAUGE_TEMPLATE`, `GOVERNANCE_WIDGET_TEMPLATE`, `SYSTEM_SIDEBAR_STACK_TEMPLATE` (system pills), and the `SYSTEM_EDITOR_MODAL_TEMPLATE` (carousel, two-panel layout, toggles, constraint cards) to life with detailed visual specifications.
*   **Improved Goal Selection UI:**
    *   Applied `aspect-ratio` to `.flip-card-wrapper` for consistent card sizing.
    *   Implemented a dynamic "floor shadow" (`::after` pseudo-element) for flip cards, enhancing depth and interaction feedback.

Overall, this version represents a substantial leap forward in both functionality and user experience, particularly in the AI interaction and visual design aspects. The architectural changes around client management and hybrid persistence also indicate a move towards a more robust and scalable application.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC PossPath Essential Files
Date: 2026-01-20
Version: 202502260296
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üåê Structured Speculation Possibility Pathfinder ("SSPEC PossPath")

üìÅ Included Files:
 * üì± app.py
 * üÉè system_cards.py
 * üüß ai_service.py
 * üü© goal_selection.html
 * üü• routes.py
 * üß© system_templates.py
 * üé® styles.css
 * üîµ system_cards.js
 * üü™ cos_table.js
 * ‚¨ú speculate.py
 * üè™ store.py
 * üîµ ce_cards.js
 * üè≥Ô∏è‚Äçüåà ce_nodes.py
 * üéØ goal_selection.js
 * üß© ce_templates.py
 * üîÆ system_nodes.js
 * üü® utilities.py
 * üè≥Ô∏è‚Äçüåà system_nodes.py
 * üìÜ models.py
 * üü¶ outcome.html

üì± app.py:
# app.py
import os
import sys
import logging
import asyncio
from datetime import datetime
from flask import Flask
from flask_migrate import Migrate
from sqlalchemy import text
from dotenv import load_dotenv
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from rich.text import Text
from rich.logging import RichHandler

# ----------------------
# Windows asyncio fix
# ----------------------
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

# ----------------------
# Load environment variables
# ----------------------
load_dotenv()
ARCHIVE_FOLDER = os.environ.get("SSPEC_ARCHIVE_FOLDER", "./SSPEC_Prompt_Archive")

# ----------------------
# Rich console setup
# ----------------------
ms365_theme = {
    "white": "#FFFFFF",
    "tan": "#CC3802",
    "teal": "#047E84",
    "plum": "#9A348E",
    "blush": "#DA627D",
    "salmon": "#FCA17D",
    "mint": "#64C5B1",
    "sky": "#86BBD8",
    "info": "#86BBD8",
    "warning": "#FCA17D",
    "danger": "#CC3802",
    "success": "#64C5B1"
}
console = Console()

# ----------------------
# Logging config
# ----------------------
logging.basicConfig(
    level="INFO",
    format="%(message)s",
    handlers=[RichHandler(console=console, rich_tracebacks=True)]
)
logger = logging.getLogger("rich")

# Suppress duplicate Werkzeug logs and ANSI codes, but not startup messages
werkzeug_logger = logging.getLogger("werkzeug")
werkzeug_logger.propagate = False
werkzeug_logger.setLevel(logging.WARNING)

# ----------------------
# Flask init
# ----------------------
app = Flask(__name__)
migrate = Migrate()
app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

# ----------------------
# Database setup & auto-migrations
# ----------------------
from models import db
if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    db.init_app(app)
    migrate.init_app(app, db)

    with app.app_context():
        try:
            with db.engine.connect() as conn:
                try:
                    conn.execute(text("SELECT system_data FROM ssol LIMIT 1"))
                except Exception:
                    logger.warning("[tan]Column 'system_data' missing. Adding...[/tan]")
                    conn.execute(text("ALTER TABLE ssol ADD COLUMN system_data TEXT"))
                    conn.commit()
                    logger.info("[success]Column 'system_data' added[/success]")
        except Exception as e:
            logger.debug(f"[sky]DB fresh or missing table, skipping auto-migration: {e}[/sky]")

# ----------------------
# Template filters / context processors
# ----------------------
@app.template_filter()
def get_badge_class_from_status(status):
    return {
        'Proposed': 'bg-info',
        'In Progress': 'bg-warning text-dark',
        'Completed': 'bg-success',
        'Rejected': 'bg-danger'
    }.get(status, 'bg-secondary')

from ce_nodes import NODES
@app.context_processor
def inject_nodes():
    from system_nodes import SYSTEM_NODES
    return dict(nodes=NODES, system_nodes=SYSTEM_NODES)

# ----------------------
# --- TERMINAL TITLE SCREEN ---
# ----------------------
def get_latest_version(archive_folder: str) -> str:
    if not os.path.exists(archive_folder):
        return "v0001"
    versions = []
    for f in os.listdir(archive_folder):
        if f.startswith("SSPEC_Template_") and f.endswith(".txt"):
            try:
                num = int(f.split("_")[-1].split(".")[0])
                versions.append(num)
            except ValueError:
                continue
    return f"v{max(versions):04d}" if versions else "v0001"

def print_title_screen():
    version = get_latest_version(ARCHIVE_FOLDER)
    table = Table.grid(padding=1)
    table.add_row("[cyan]Author:[/cyan]", "Tone Pettit")
    table.add_row("[cyan]Organization:[/cyan]", "Structured Speculation Foundation")
    table.add_row("[cyan]Version:[/cyan]", version)
    table.add_row("[cyan]Date:[/cyan]", datetime.now().strftime("%Y-%m-%d"))

    panel = Panel(
        table,
        title="[bold magenta]SSPEC Horizon Possibility Parser[/bold magenta]",
        subtitle="[green]Structured Speculation Foundation[/green]",
        border_style="bright_blue",
        padding=(1, 2),
        expand=False
    )
    console.clear()
    console.print(Text("‚ú® POSSIBILITY PATHFINDER ‚ú®", style="bold white on purple"), justify="center")
    console.print("\n")
    console.print(panel, justify="center")
    console.print("\n")

# ----------------------
# Routes
# ----------------------
from routes import routes_bp
app.register_blueprint(routes_bp)

# ----------------------
# Startup banner
# ----------------------
def print_startup_banner():
    sys_info = Table.grid(padding=1)
    sys_info.add_row("[tan]Runtime:[/tan]", f"[white]Python {sys.version.split()[0]}[/white]")
    sys_info.add_row("[tan]Framework:[/tan]", "[white]Flask[/white]")
    sys_info.add_row("[tan]Storage:[/tan]", f"[sky]{'Postgres/SQLite' if USE_DATABASE else 'In-Memory'}[/sky]")
    sys_info.add_row("[tan]Status:[/tan]", "[mint]ONLINE[/mint]")

    panel = Panel(
        sys_info,
        title="[bold white]SSPEC HORIZON v2026.01[/bold white]",
        border_style="teal",
        subtitle="[blush]Serving at http://127.0.0.1:5000[/blush]",
        padding=(1, 4),
        expand=False
    )
    console.print(panel, justify="center")

# ----------------------
# Main
# ----------------------
if __name__ == '__main__':
    print_title_screen()
    print_startup_banner()
    # Run Flask app normally: CTRL+C message will appear
    app.run(debug=True, port=5000)


üüß ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

# ai_service.py (Additions)

async def generate_governance_report(ssol_context: dict):
    """
    Runs the Bicameral Governance Check:
    1. Ombud: Strict constraint checking (Negative Feedback Loop).
    2. Advocate: Strategic synthesis (Positive Feedback Loop).
    """
    from system_nodes import SAFETY_PROTOCOL
    
    # Extract Context
    title = ssol_context.get('title')
    constraints = ssol_context.get('system_data', {})
    horizon = constraints.get('HORIZON', 'Unknown')
    budget = constraints.get('BUDGET', 'Unknown')
    
    # 1. THE OMBUD (The Brake)
    ombud_prompt = f"""
    ROLE: The Ombud. You are the impartial guardian of constraints.
    CONTEXT: Project '{title}'. 
    CONSTRAINTS: Horizon: {horizon}, Budget: {budget}.
    CHARTER: {SAFETY_PROTOCOL}
    
    TASK: Scan the project definition. 
    1. Are the constraints realistic? 
    2. Is there a Charter violation?
    
    OUTPUT JSON: {{ "status": "Stable" | "Risk" | "Violation", "message": "Short, stern assessment." }}
    """

    # 2. THE ADVOCATE (The Accelerator)
    advocate_prompt = f"""
    ROLE: The Advocate. You are the strategic synthesizer.
    CONTEXT: Project '{title}'.
    
    TASK: Look for opportunities.
    1. What is the most exciting synergy missing?
    2. How can we speed this up without breaking constraints?
    
    OUTPUT JSON: {{ "insight": "Inspiring, forward-looking advice." }}
    """

    try:
        # Run in parallel (Conceptual, sequentially here for simplicity)
        ombud_res = await generate_chat_response(
            [{"role": "user", "content": ombud_prompt}], "user", "ombud", temperature=0.2
        )
        advocate_res = await generate_chat_response(
            [{"role": "user", "content": advocate_prompt}], "user", "advocate", temperature=0.7
        )
        
        return {
            "ombud": json.loads(ombud_res.replace("```json", "").replace("```", "")),
            "advocate": json.loads(advocate_res.replace("```json", "").replace("```", ""))
        }
    except Exception as e:
        return {
            "ombud": {"status": "Offline", "message": "Governance link severed."},
            "advocate": {"insight": "Reconnecting to neural net..."}
        }    

üü© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER: Locks to viewport height, no global scroll -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- SCREEN SURFACE: Flex column layout -->
    <div class="screen-surface">
      
      <!-- 1. HEADER BAR: Mission Parameter & Controls -->
      <div id="gs-header" class="bg-white border-bottom px-5 py-2 d-flex justify-content-between align-items-center shadow-sm z-30 position-relative" style="height: 80 px; flex-shrink: 0;">
        
        <!-- Left: Input Display/Edit -->
        <div class="d-flex align-items-center gap-4">
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1"> YOUR POSSIBILITY </div>
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display text-truncate" 
                       style="font-size: 2rem; max-width: 900px;" 
                       title="{{ user_input }}">
                       "{{ user_input }}"
                   </h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0 ms-2" title="Edit Parameter">
                       <i class="fas fa-pencil-alt"></i>
                   </button>
               </div>
           </div>
           
           <!-- Hidden Edit Mode -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <!-- Right: Actions -->
        <div class="d-flex gap-3">
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> GENERATE NEW GOALS
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">START OVER</a>
        </div>
      </div>

      <!-- 2. STAGE VIEWPORT: Consumes remaining height, handles internal scrolling -->
      <div id="stage-viewport">
        
        <!-- A. THE GALLERY GRID (Initial View) -->
        <div class="goal-grid" id="goalCardsContainer">
            {% for goal in goals %}
               <!-- FIX: Removed the stray closing bracket '>' that was cutting off attributes -->
               <div class="flip-card-wrapper {% if not goal.is_compliant %}violation{% endif %}" 
                    data-card-id="goal-{{ loop.index0 }}"
                    data-card-title="{{ goal.title | e }}"
                    data-color-hue="{{ goal.color_hue | default(180) }}"
                    data-goal-index="{{ loop.index0 }}"
                    onclick="window.selectGoal(this)">
                    
                    <div class="flip-card-inner">
                        <!-- BACK FACE (Monolith/Hero) -->
                        <div class="flip-card-back" style="background: {{ goal.card_gradient | default('linear-gradient(135deg, #00bcd4 0%, #2979ff 100%)') }};">
                            <div class="card-texture-overlay"></div>
                            <div class="monolith-content">
                                <div class="monolith-icon-circle"><i class="{{ goal.icon }} monolith-icon"></i></div>
                                {% if not goal.is_compliant %}
                                    <span class="badge bg-black bg-opacity-25 border border-danger text-white font-data px-3 py-2 mt-3">PROTOCOL VIOLATION</span>
                                {% else %}
                                    <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1 mt-3">STRUCTURED SPECULATION</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- FRONT FACE (Goal Details) -->
                        <div class="flip-card-front">
                             <div class="card-header-plate" style="background: {{ goal.plate_gradient | default('linear-gradient(135deg, #4dd0e1 0%, #00bcd4 100%)') }};">
                                 <div class="card-texture-overlay"></div>
                                 <div class="card-domain-badge-large">{{ goal.domain | upper }}</div>
                                 <div class="card-icon-float-large"><i class="{{ goal.icon }}" style="color: {{ goal.icon_color | default('#00838f') }};"></i></div>
                             </div>
                             <div class="card-body-large">
                                 <h3 class="card-title-large">{{ goal.title }}</h3>
                                 <p class="card-desc-large">{{ goal.goal }}</p>
                             </div>
                             <div class="card-footer-large">
                                 <button type="button" class="btn-select-pill-large" style="background: {{ goal.btn_gradient | default('linear-gradient(to right, #00bcd4, #00838f)') }};">
                                     {{ 'PROTOCOL VIOLATION' if not goal.is_compliant else 'CHOOSE GOAL' }}
                                 </button>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Dock for System Pills (Injected by JS) -->
                    <div class="system-pill-dock position-absolute top-0 start-0 w-100 p-4 d-flex flex-column gap-2" style="z-index: 5; pointer-events: none;"></div>
               </div>
            {% endfor %}
        </div>

        <!-- B. CONFIGURATION WIZARD (Slides In) -->
        <div id="configuration-stage">
            <div class="split-col-right">
                
                <!-- The Wizard Container: Strictly Flexbox for No-Scroll Layout -->
                <div class="wizard-container">
                    
                    <!-- Track Header -->
                    <div class="wizard-header">
                        <div class="wizard-progress-track" id="wizard-track">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                    
                    <!-- Main Content: Grows to fill space, Scrolls internally if needed -->
                    <div class="wizard-content" id="wizard-main-area">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted flex-column">
                            <i class="fas fa-circle-notch fa-spin fa-2x mb-3 text-secondary"></i> 
                            <span class="font-data small tracking-widest">INITIALIZING FLIGHT DECK...</span>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="wizard-footer">
                        <button class="wiz-btn-back" id="btn-wiz-back" onclick="window.wizardBack()" style="visibility: hidden;">
                            <i class="fas fa-chevron-left me-2"></i> BACK
                        </button>
                        
                        <button class="wiz-btn-next" id="btn-wiz-next" onclick="window.wizardNext()">
                            NEXT <i class="fas fa-chevron-right ms-2"></i>
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
      
      </div>

      <!-- 3. PAGE FOOTER: System Status -->
      <div class="px-5 py-3 bg-white border-top mt-auto d-flex justify-content-between align-items-center z-20 position-relative" style="height: 60px; flex-shrink: 0;">
         <div class="d-flex align-items-center gap-3">
            <div id="global-status-dot" class="rounded-circle bg-success shadow-sm animate-pulse" style="width: 6px; height: 6px;"></div>
            <span id="global-status-text" class="font-body small text-muted fw-bold">{{ system_status }}</span>
         </div>
         <span class="font-data text-muted small letter-spacing-2 opacity-75">SSPEC HORIZON {{ system_version }}</span>
      </div>

    </div>
  </div>
</div>

<!-- HIDDEN SUBMISSION FORM (Population handled by JS) -->
<form id="final-submit-form" method="POST" action="{{ url_for('routes_bp.outcome') }}" class="d-none">
    <input type="hidden" name="selected_goal" id="form-goal">
    <input type="hidden" name="selected_goal_title" id="form-title">
    <input type="hidden" name="domain" id="form-domain">
    <input type="hidden" name="domain_icon" id="form-domain-icon">
    
    <input type="hidden" name="system_operator" id="form-operator">
    <input type="hidden" name="system_horizon" id="form-horizon">
    <input type="hidden" name="system_budget" id="form-budget">
    
    <!-- Dynamic inputs (DIRECTIVE, AVOIDANCE, etc) appended by JS -->
</form>
{% endblock %}

{% block scripts %}
<script>
    // 1. Inject Visual Data for Cards
    window.GOAL_COLOR_DATA = {{ goals | tojson | safe }};
    
    // 2. Inject Master Configuration from Python (system_nodes.py)
    // This allows the Wizard to dynamically build itself based on the Backend Logic
    window.WIZARD_CONFIG = {{ system_nodes | tojson | safe }};
</script>

<!-- Load the Controller -->
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
{% endblock %}

üü• routes.py:
# routes.py
import os
import json
import uuid
import logging
import asyncio
import pdfkit
from uuid import UUID
from datetime import date, timedelta, datetime
from dotenv import load_dotenv
from bs4 import BeautifulSoup
from werkzeug.exceptions import BadRequest, NotFound
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory

# --- App Context & Stores ---
from app import USE_DATABASE
from store import ssol_store, cos_store # <--- Added for In-Memory Support

# --- Data Models & Config ---
from models import get_engine_and_session, SSOL, COS
from ce_nodes import NODES
from system_nodes import SYSTEM_NODES
from system_templates import (
    render_command_deck, 
    render_system_config_modal
)

# --- Service Layers ---
from ai_service import cleanup_gemini_client, generate_chat_response, generate_governance_report
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, generate_image, \
                    format_ssol_text

# --- Speculation Operations ---
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol

# --- Template Generators ---
from ce_templates import generate_dynamic_modal

load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# ==============================================================================
# 1. LIFECYCLE MANAGEMENT
# ==============================================================================

@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up AI resources after each request."""
    await cleanup_gemini_client()

# ==============================================================================
# 2. INTERNAL HELPERS (Data Persistence - Hybrid Support)
# ==============================================================================

def speculate_update_ssol_system_node_internal(ssol_id_str, key, value):
    """
    Updates the system_data JSON column directly from backend logic.
    Handles both SQL and In-Memory stores.
    """
    ssol_id_str = str(ssol_id_str)
    
    if USE_DATABASE:
        engine, session = get_engine_and_session()
        try:
            ssol = session.query(SSOL).get(UUID(ssol_id_str))
            if ssol:
                # SQLAlchemy requires reassignment of JSON types
                current_data = dict(ssol.system_data or {})
                current_data[key] = value
                ssol.system_data = current_data
                session.commit()
                return True
            return False
        except Exception as e:
            current_app.logger.error(f"Internal System Node Update Failed (DB): {e}")
            session.rollback()
            return False
        finally:
            session.close()
    else:
        # In-Memory Logic
        if ssol_id_str in ssol_store:
            current_data = ssol_store[ssol_id_str].get('system_data', {})
            current_data[key] = value
            ssol_store[ssol_id_str]['system_data'] = current_data
            return True
        return False

# ==============================================================================
# 3. BASIC NAVIGATION
# ==============================================================================

@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

@routes_bp.route('/')
def index():
    return render_template('input.html')

@routes_bp.route('/about')
def about():
    return render_template('about.html')

@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    text = request.form.get('user_text')
    if not text:
        return jsonify({'error': 'No text provided'}), 400
    
    return jsonify({
        'keywords': await analyze_user_input(text), 
        'compliance': await is_input_compliant(text)
    })

# ==============================================================================
# 4. GOAL SELECTION WIZARD
# ==============================================================================

@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            current_app.logger.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)

            if not goal_options:
                flash("Could not generate goal options. Please try again.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            current_app.logger.error(f"Error in goal_selection: {e}", exc_info=True)
            flash(f"An error occurred: {e}", "error")
            return render_template('input.html', user_text=user_input)
    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 5. OUTCOME GENERATION (The Bootstrapper - POST)
# ==============================================================================

@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        # 1. EXTRACT CORE IDENTITY
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        # 2. DYNAMICALLY EXTRACT SYSTEM PHYSICS
        system_constraints = {}
        
        # Iterate through the Master Ontology to capture Wizard inputs
        for node_key in SYSTEM_NODES.keys():
            # The Wizard sends keys exactly matching the SYSTEM_NODES keys (e.g. "OPERATOR")
            val = request.form.get(node_key)
            
            if val:
                # SPECIAL HANDLING FOR TAGS (Arrays)
                config = SYSTEM_NODES.get(node_key, {})
                if config.get('ui_type') == 'tags':
                    # Clean up list formatting (remove trailing commas etc)
                    cleaned_val = ", ".join([x.strip() for x in val.split(',') if x.strip()])
                    system_constraints[node_key] = cleaned_val
                else:
                    system_constraints[node_key] = val.strip()

        # 3. GENERATE INTELLIGENCE (With Attenuation)
        try:
            # We pass the constraints to the AI to influence the text generation
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, 
                ssol_description=selected_goal_text, 
                domain=domain,
                forced_constraints=system_constraints 
            )
            
            # Merge AI params with User Constraints (User wins conflicts)
            ai_params = structured_solution_json.get('system_params', {})
            final_system_data = {**ai_params, **system_constraints}

            # 4. CREATE SSOL CONTAINER
            ssol_id_str = speculate_create_ssol(
                USE_DATABASE, 
                selected_goal_title, 
                selected_goal_text, 
                domain=domain,
                system_data=final_system_data 
            )
            ssol_id_uuid = UUID(ssol_id_str)

            # 5. CREATE PHASES & CONDITIONS (Standard Logic)
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    for cos_content_with_tags in cos_items:
                        if not cos_content_with_tags: continue
                        try:
                            await speculate_create_cos(
                                USE_DATABASE, 
                                ssol_id=ssol_id_uuid, 
                                content=cos_content_with_tags, 
                                status='Proposed'
                            )
                        except Exception as cos_err:
                            current_app.logger.error(f"Error generating COS: {cos_err}")

            # 6. ASYNC IMAGE GENERATION
            try:
                image_prompt = f"""
                A vibrant, isometric, mid-century retro illustration of '{selected_goal_title}: {selected_goal_text}' 
                fulfilled. Context: {domain}. Style: 1950s Popular Science magazine cover meets Mary Blair.
                Characteristics: Saturated technicolor palette (#ff7043, #26c6da, #ab47bc, #ffa726), 
                painterly lithograph texture, idealized realism, optimistic composition. No text.
                """
                await generate_image(image_prompt, ssol_id_str)
            except Exception as e:
                current_app.logger.warning(f"Image gen trigger failed: {e}")

            # 7. SAVE ARTIFACTS & REDIRECT
            
            # A. Save Raw Summary
            raw_ai_summary = structured_solution_json.get('ssolsummary', '')
            speculate_update_ssol_system_node_internal(ssol_id_str, 'raw_summary', raw_ai_summary)
            
            # Save the Domain Icon specifically for the Dashboard Hero view
            if domain_icon:
                speculate_update_ssol_system_node_internal(ssol_id_str, 'domain_icon', domain_icon)
                
            # Save the Raw Summary for the Charter
            raw_ai_summary = structured_solution_json.get('ssolsummary', '')
            speculate_update_ssol_system_node_internal(ssol_id_str, 'raw_summary', raw_ai_summary)

            return redirect(url_for('routes_bp.view_ssol', ssol_id=ssol_id_str))

        except Exception as e:
            current_app.logger.error(f"CRITICAL error in /outcome: {e}", exc_info=True)
            flash(f"System Critical Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 6. OUTCOME VISUALIZATION (The Console Loader - GET)
# ==============================================================================

@routes_bp.route('/ssol/<uuid:ssol_id>', methods=['GET'])
def view_ssol(ssol_id):
    """
    Re-hydrates the SSPEC Dashboard.
    Supports both SQL and In-Memory modes via Hybrid Logic.
    """
    
    ssol_data_payload = {}
    all_cos_list = []
    
    # --- DATA FETCHING (Hybrid) ---
    if USE_DATABASE:
        engine, session = get_engine_and_session()
        try:
            ssol_obj = session.query(SSOL).get(ssol_id)
            if not ssol_obj:
                flash("Structured Solution not found.", "error")
                return redirect(url_for('routes_bp.index'))
            
            # Populate basic data
            ssol_data_payload = ssol_obj.to_dict() # Helper creates dict
            # Add dynamic field fallback
            ssol_data_payload['system_data'] = ssol_obj.system_data or {}
            
            # Fetch COS
            all_cos_list = [c.to_dict() for c in ssol_obj.cos]
            
        except Exception as e:
            current_app.logger.error(f"DB Error viewing SSOL: {e}")
            flash("Database Error.", "error")
            return redirect(url_for('routes_bp.index'))
        finally:
            session.close()
    else:
        # IN-MEMORY LOGIC
        ssol_id_str = str(ssol_id)
        raw_ssol = ssol_store.get(ssol_id_str)
        
        if not raw_ssol:
            flash("Structured Solution not found (In-Memory).", "error")
            return redirect(url_for('routes_bp.index'))
            
        ssol_data_payload = raw_ssol.copy()
        if 'system_data' not in ssol_data_payload:
            ssol_data_payload['system_data'] = {}
            
        # Manually filter COS for this SSOL
        all_cos_list = [c for c in cos_store.values() if c['ssol_id'] == ssol_id_str]

    # --- UI REHYDRATION (Common Logic) ---
    try:
        # 1. Command Deck
        deck_params_list = []
        sys_data = ssol_data_payload.get('system_data', {})
        
        for key, val in sys_data.items():
            if key in SYSTEM_NODES:
                deck_params_list.append({
                    'type': key,
                    'id': f'sys_{key}_{str(ssol_id)}',
                    'value': val
                })
        
        if not any(p['type'] == 'HORIZON' for p in deck_params_list):
             deck_params_list.append({'type': 'HORIZON', 'id': 'horizon_def', 'value': 'Unset'})

        components = render_command_deck(deck_params_list)
        config_modal = render_system_config_modal()

        # 2. Executive Charter
        raw_summary = sys_data.get('raw_summary', ssol_data_payload.get('description', ""))
        formatted_summary = format_ssol_text(raw_summary, phase_index=0, system_data=sys_data)

        # 3. Phase Grid Reconstruction
        phases_ordered = ['Discovery', 'Engagement', 'Action', 'Completion', 'Legacy']
        phases_map = {p: [] for p in phases_ordered}
        
        if all_cos_list:
            chunk_size = max(1, len(all_cos_list) // 5)
            cos_iter = iter(all_cos_list)
            
            for i, phase in enumerate(phases_ordered):
                if i == 4:
                    phases_map[phase] = list(cos_iter)
                else:
                    items = []
                    try:
                        for _ in range(chunk_size): items.append(next(cos_iter))
                    except StopIteration: pass
                    phases_map[phase] = items

        # 4. Final Payload Overrides
        ssol_data_payload['ssol_summary'] = formatted_summary
        ssol_data_payload['selected_goal'] = ssol_data_payload.get('description')
        ssol_data_payload['ssol_title'] = ssol_data_payload.get('title')
        
        if 'domain_icon' in sys_data:
            ssol_data_payload['domain_icon'] = sys_data['domain_icon']
        elif 'domain_icon' not in ssol_data_payload:
            ssol_data_payload['domain_icon'] = "fas fa-cube"

        return render_template(
            'outcome.html',
            ssol=ssol_data_payload,
            ssol_id=str(ssol_id),
            phases=phases_map, # Pass explicitly if template expects it separate
            horizon_gauge_html=components['horizon_html'],
            system_pills_html=components['sidebar_html'],
            system_config_modal_html=config_modal
        )

    except Exception as e:
        current_app.logger.error(f"Template Rendering Error: {e}", exc_info=True)
        flash("Error rendering solution.", "error")
        return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 7. SYSTEM CONFIG & SPECULATION APIs
# ==============================================================================

@routes_bp.route('/update_ssol_system_node', methods=['POST'])
def update_ssol_system_node():
    data = request.get_json()
    ssol_id = data.get('ssol_id')
    key = data.get('key')   
    value = data.get('value') 

    if not ssol_id or not key:
        return jsonify({'success': False, 'error': 'Missing ID/Key'}), 400

    # Hybrid Logic for Update
    if USE_DATABASE:
        engine, session = get_engine_and_session()
        try:
            ssol = session.query(SSOL).get(UUID(ssol_id))
            if not ssol: return jsonify({'success': False}), 404

            # Specific column updates vs JSON updates
            current_data = dict(ssol.system_data or {})
            
            if key == 'HORIZON':
                try:
                    dt = datetime.strptime(value, '%Y-%m-%d').date()
                    ssol.target_date = dt
                except: pass
                current_data['HORIZON'] = value
            elif key == 'OPERATOR':
                ssol.owner = value
                current_data['OPERATOR'] = value
            else:
                current_data[key] = value
                
            ssol.system_data = current_data
            session.commit()
            return jsonify({'success': True})
        except Exception as e:
            session.rollback()
            return jsonify({'success': False, 'error': str(e)}), 500
        finally:
            session.close()
    else:
        # In-Memory Update
        if ssol_id in ssol_store:
            ssol = ssol_store[ssol_id]
            current_data = ssol.get('system_data', {})
            current_data[key] = value
            
            if key == 'HORIZON': ssol['target_date'] = value
            if key == 'OPERATOR': ssol['owner'] = value
            
            ssol['system_data'] = current_data
            return jsonify({'success': True})
        return jsonify({'success': False, 'error': 'Not Found'}), 404
        
@routes_bp.route('/speculate_context', methods=['POST'])
async def speculate_context_route():
    try:
        data = request.get_json()
        ce_type = data.get('ce_type', 'Default')
        context = data.get('context') 
        sub_context = data.get('sub_context', '') 
        cos_text = data.get('cos_text', '')
        ssol_id = data.get('ssol_id')
        
        # ==========================================================
        # 1. HYBRID CONTEXT FETCHING
        #    Retrieves Title + System Physics for AI Attenuation
        # ==========================================================
        ssol_context = {}
        if ssol_id:
            if USE_DATABASE:
                engine, session = get_engine_and_session()
                try:
                    obj = session.query(SSOL).get(UUID(str(ssol_id)))
                    if obj: 
                        ssol_context = {
                            'title': obj.title, # Critical for Governance Prompt
                            'target_date': obj.target_date, 
                            'owner': obj.owner, 
                            'system_data': obj.system_data or {}
                        }
                finally:
                    session.close()
            else:
                ssol_context = ssol_store.get(str(ssol_id), {})

        # ==========================================================
        # 2. GOVERNANCE BRANCH (Ombud/Advocate)
        #    Bypasses standard CE logic to run the Bicameral Check
        # ==========================================================
        if context == 'governance':
            if not ssol_context:
                return jsonify({'success': False, 'error': 'SSOL Context Not Found'}), 404
            
            # Delegates to ai_service.py logic defined in previous step
            report = await generate_governance_report(ssol_context)
            return jsonify({'success': True, 'report': report})

        # ==========================================================
        # 3. STANDARD ATTENUATION LAYER (The Physics Block)
        #    Constructs the prompt rules for standard CE generation
        # ==========================================================
        system_instructions = []
        
        if ssol_context:
            if ssol_context.get('target_date'):
                system_instructions.append(f"TEMPORAL: Hard deadline {ssol_context['target_date']}.")
            if ssol_context.get('owner'):
                system_instructions.append(f"OPERATOR: Entity is '{ssol_context['owner']}'.")
            
            # Dynamic Node Injection (Budget, Scale, Modality, etc.)
            if ssol_context.get('system_data'):
                for key, val in ssol_context['system_data'].items():
                    config = SYSTEM_NODES.get(key)
                    if config and 'prompt_injection' in config and val:
                        # Format the specific injection string
                        try:
                            system_instructions.append(config['prompt_injection'].format(value=val))
                        except Exception:
                            # Fallback if formatting fails
                            system_instructions.append(f"{key}: {val}")

        # Default fallback if no physics exist
        global_context_block = "\n".join(system_instructions) or "Standard procedures apply."

        # ==========================================================
        # 4. STANDARD NODE PROMPTING
        #    Narrative generation or List/Collection generation
        # ==========================================================
        node_config = NODES.get(ce_type, NODES['Default'])
        prompts_map = node_config.get('prompts', {})
        default_prompts = NODES['Default'].get('prompts', {})
        
        # A. Narrative Mode (Single Text Block)
        if context == 'narrative':
            base_prompt = prompts_map.get('narrative', default_prompts.get('narrative'))
            prompt_content = base_prompt.format(cos_text=cos_text, field=sub_context, node_type=ce_type)
            final_prompt = f"*** SYSTEM PHYSICS ***\n{global_context_block}\n\n*** TASK ***\n{prompt_content}"
            
            ai_response = await generate_chat_response(
                messages=[{"role": "user", "content": final_prompt}], 
                role="SSPEC Engine", 
                task=f"{ce_type}-narrative",
                system_instruction="You are the SSPEC Speculation Engine. Return pure JSON { 'text': ... }.",
                temperature=0.75 
            )

        # B. Collection Mode (Lists of Prereqs, Stakeholders, etc.)
        else:
            base_prompt = prompts_map.get(context, default_prompts.get(context)) or f"Analyze '{cos_text}'. List 3 items for {context}."
            prompt_content = base_prompt.format(cos_text=cos_text)
            final_prompt = f"*** SYSTEM PHYSICS ***\n{global_context_block}\n\n*** TASK ***\n{prompt_content}"

            ai_response = await generate_chat_response(
                messages=[{"role": "user", "content": final_prompt}], 
                role="SSPEC Engine", 
                task=f"{ce_type}-{context}",
                system_instruction="You are the SSPEC Speculation Engine. Return pure JSON array or object.",
                temperature=0.75 
            )
        
        # ==========================================================
        # 5. PARSING & RETURN
        # ==========================================================
        clean_json = ai_response.replace("```json", "").replace("```", "").strip()
        parsed = json.loads(clean_json)

        if context == 'narrative':
            txt = parsed.get('text', '') if isinstance(parsed, dict) else str(parsed)
            return jsonify({'success': True, 'text': txt, 'field': sub_context})
        else:
            suggestions = parsed if isinstance(parsed, list) else parsed.get('items', [])
            # Fallback if AI wraps array in a key
            if not isinstance(suggestions, list) and isinstance(parsed, dict):
                suggestions = next((v for k, v in parsed.items() if isinstance(v, list)), [])
                
            return jsonify({'success': True, 'suggestions': suggestions, 'context': context})

    except Exception as e:
        current_app.logger.error(f"Speculate Context Error: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

# ==============================================================================
# 8. CORE CRUD & MODAL APIs
# ==============================================================================

@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        ce_text = data.get('ce_text', 'Conditional Element')
        
        ce_id_obj = None
        if ce_id_str:
            try: ce_id_obj = UUID(ce_id_str)
            except ValueError: pass

        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        
        if not ce_data or 'data' not in ce_data:
            ce_data = {'id': str(ce_id_str) if ce_id_str else 'new_ce', 'node_type': ce_type, 'data': {
                'details_data': {}, 'resources': [], 'prerequisites': [], 'stakeholders': [], 'assumptions': [], 'connections': []
            }}

        node_config = NODES.get(ce_type, NODES['Default'])
        cos_content_html = data.get('cos_content', '')
        cos_text_only = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)
        
        ai_generated_data = await generate_ai_data(ce_type, cos_text_only, data.get('ssol_goal', ''), 'context')

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type, ce_text=ce_text, ce_data=ce_data, node_info=node_config,
            cos_content=cos_content_html, ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''), phase_index=data.get('phase_index', 0)
        )
        return jsonify(modal_html=modal_html, ce_data=ce_data)
    except Exception as e:
        current_app.logger.error(f"Error generating CE Modal: {e}", exc_info=True)
        return jsonify(error=str(e)), 500

@routes_bp.route('/update_ce/<uuid:ce_id>', methods=['PUT'])
def update_ce_route(ce_id):
    data = request.get_json()
    if speculate_update_ce_by_id(USE_DATABASE, ce_id, data): return jsonify(success=True)
    return jsonify(success=False), 500

@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        ssol_uuid_obj = UUID(data['ssol_id'])
        cos_data = await speculate_create_cos(
            USE_DATABASE, ssol_uuid_obj, data['content'], 
            data.get('status', 'Proposed'), data.get('accountable_party'), data.get('completion_date')
        )
        if cos_data: return jsonify(success=True, cos=cos_data), 201
        return jsonify(success=False), 500
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        res = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)
        if res['success']: return jsonify(success=True, cos=res['cos'])
        return jsonify(success=False, error=res['message']), res['status_code']
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    if speculate_delete_cos_by_id(USE_DATABASE, cos_id): return jsonify(success=True)
    return jsonify(success=False), 404

@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    p = f"images/ssol_image_{ssol_id}.png"
    if os.path.exists(os.path.join(current_app.static_folder, p)):
        return jsonify({'image_path': url_for('static', filename=p), 'status': 'found'})
    return jsonify({'status': 'pending'})

@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        html = request.get_json()['htmlContent'].replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')
        pdf_options = {"page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in", "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8", "no-outline": None, "enable-local-file-access": None}
        pdf = pdfkit.from_string(html, False, options=pdf_options, css=os.path.join(current_app.root_path, 'static', 'styles.css'))
        r = make_response(pdf)
        r.headers['Content-Type'] = 'application/pdf'
        r.headers['Content-Disposition'] = f'attachment; filename="SSPEC_{ssol_id}.pdf"'
        return r
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

üß© system_templates.py:
# system_templates.py
from flask import render_template_string
from system_nodes import SYSTEM_NODES
import datetime

# ==============================================================================
# 1. HORIZON GAUGE (Strict Single-Line Layout)
# ==============================================================================
HORIZON_GAUGE_TEMPLATE = """
<div class="card border-0 shadow-sm mb-4 overflow-visible system-node-card cursor-pointer group"
     onclick="openSystemEditor('{{ id }}', 'HORIZON', '{{ value }}')"
     title="Click to Calibrate Horizon">
    
    <!-- Main Container: Forced Flex Row with Inline Overrides -->
    <div class="d-flex align-items-stretch flex-nowrap w-100" 
         style="height: 80px; display: flex !important; flex-direction: row !important; overflow: visible;">
        
        <!-- COL 1: ICON STRIP (Strict Fixed Width) -->
        <div class="bg-warning bg-opacity-10 d-flex align-items-center justify-content-center border-end" 
             style="width: 72px; min-width: 72px; flex: 0 0 72px;">
            <i class="{{ icon }} fa-lg text-warning group-hover:scale-110 transition-transform"></i>
        </div>
        
        <!-- COL 2: TIMELINE DATA (Fluid Middle) -->
        <div class="position-relative d-flex align-items-center justify-content-between gap-3 px-4" 
             style="flex: 1 1 auto; min-width: 0; overflow: visible;">
            
            <!-- Origin Date -->
            <div class="text-nowrap">
                <div class="font-data text-muted x-small tracking-widest opacity-75 mb-1">ORIGIN</div>
                <div class="font-body fw-bold text-dark small">{{ start_date }}</div>
            </div>

            <!-- The Bar (Takes all remaining space) -->
            <div class="progress rounded-pill flex-grow-1 position-relative mx-3" style="height: 6px; background-color: #f1f5f9; overflow: visible;">
                
                <!-- Fill -->
                <div class="progress-bar rounded-pill position-relative" role="progressbar" 
                     style="width: {{ time_elapsed_percent }}%; background-color: {{ health_color }}; box-shadow: 0 2px 10px {{ health_color }}60;" 
                     aria-valuenow="{{ time_elapsed_percent }}" aria-valuemin="0" aria-valuemax="100">
                     
                     <!-- Current Head Marker -->
                     <div class="position-absolute top-50 translate-middle" style="right: -12px;">
                        <div class="bg-white border border-2 rounded-circle shadow-sm" 
                             style="width: 14px; height: 14px; border-color: {{ health_color }};"></div>
                        
                        <!-- THE PHASE INDICATOR (Floating Badge) -->
                        <div class="position-absolute bottom-100 start-50 translate-middle-x mb-2 text-nowrap" style="z-index: 10;">
                            <span class="badge bg-dark text-white border font-data x-small rounded-pill px-2 shadow-sm py-1">
                                <i class="fas fa-map-marker-alt text-warning me-1"></i> DISCOVERY
                            </span>
                        </div>
                     </div>
                </div>

                <!-- Milestones -->
                <div class="position-absolute top-50 start-20 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 20%;"></div>
                <div class="position-absolute top-50 start-40 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 40%;"></div>
                <div class="position-absolute top-50 start-60 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 60%;"></div>
                <div class="position-absolute top-50 start-80 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 80%;"></div>
            </div>

            <!-- Target Date -->
            <div class="text-end text-nowrap">
                <div class="font-data text-muted x-small tracking-widest opacity-75 mb-1">REALIZATION</div>
                <div class="font-body fw-bold text-dark small">{{ target_date_display }}</div>
            </div>
        </div>

        <!-- COL 3: COUNTDOWN (Strict Fixed Width) -->
        <div class="border-start bg-light d-flex flex-column align-items-center justify-content-center" 
             style="width: 100px; min-width: 100px; flex: 0 0 100px;">
            <div class="font-data text-muted x-small tracking-widest mb-1">WINDOW</div>
            <div class="font-brand text-dark fs-3 lh-1">{{ days_remaining }}</div>
            <div class="font-data text-muted x-small mt-1 opacity-75">DAYS</div>
        </div>

    </div>
</div>
"""

# ==============================================================================
# 2. SIDEBAR STACK (Refined "Monolith" Style)
# ==============================================================================
SYSTEM_SIDEBAR_STACK_TEMPLATE = """
<div class="d-flex flex-column gap-2 mt-4" id="system-anchor-stack">
    
    <div class="d-flex align-items-center justify-content-between px-1 mb-2">
        <span class="font-data text-white-50 small tracking-widest opacity-75">SYSTEM PHYSICS</span>
        <i class="fas fa-cog text-white-50 cursor-pointer hover-text-white transition-colors" title="Configure System"></i>
    </div>
    
    {% for param in system_params %}
    <!-- SYSTEM PILL (Matches Goal Selection "Precision" Pills) -->
    <div class="system-pill-static"
         onclick="openSystemEditor('{{ param.id }}', '{{ param.type }}', '{{ param.value }}')"
         title="Calibrate {{ param.label }}">
        
        <!-- Icon -->
        <div class="pill-icon-box" style="background-color: {{ param.color }};">
            <i class="{{ param.icon }}"></i>
        </div>
        
        <!-- Text -->
        <div class="pill-content">
            <div class="pill-label">{{ param.label }}</div>
            <div class="pill-value text-truncate">{{ param.value }}</div>
        </div>

        <!-- Edit Hint -->
        <div class="pill-action">
            <i class="fas fa-sliders-h"></i>
        </div>
    </div>
    {% endfor %}

    <button class="btn btn-outline-light border-dashed w-100 rounded-pill font-data x-small py-2 mt-3 opacity-50 hover-opacity-100"
            onclick="openSystemEditor('new', '', '')">
        <i class="fas fa-plus me-2"></i> ADD CONSTRAINT
    </button>
</div>
"""

# ==============================================================================
# 3. CAROUSEL MODAL (The "Calibration Wizard")
# ==============================================================================
SYSTEM_EDITOR_MODAL_TEMPLATE = """
<div class="modal fade" id="systemConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 rounded-4 shadow-2xl overflow-visible">
            
            <!-- Nav Arrows -->
            <div class="sys-nav-arrow sys-nav-prev" onclick="navigateSystemNode(-1)"><i class="fas fa-chevron-left fa-lg"></i></div>
            <div class="sys-nav-arrow sys-nav-next" onclick="navigateSystemNode(1)"><i class="fas fa-chevron-right fa-lg"></i></div>

            <div class="row g-0" style="min-height: 600px;">
                
                <!-- LEFT: Identity & State (Visualizer) -->
                <div class="col-md-5 sys-modal-left p-5" id="sys-identity-panel" style="background-color: #333; transition: background-color 0.5s;">
                    <div class="sys-modal-texture"></div>
                    
                    <div class="position-relative z-1 h-100 d-flex flex-column justify-content-between">
                        <!-- Header -->
                        <div>
                            <div class="bg-white bg-opacity-25 rounded-3 d-flex align-items-center justify-content-center mb-4 shadow-sm backdrop-blur" 
                                 style="width: 64px; height: 64px;">
                                <i class="fas fa-cube fa-2x text-white" id="sys-display-icon"></i>
                            </div>
                            <h2 class="font-brand text-white display-6 mb-2" id="sys-display-label">LOADING...</h2>
                            <div class="font-data text-white-50 small letter-spacing-2 mb-5">SYSTEM NODE CONFIGURATION</div>
                        </div>

                        <!-- THE STATE MONITOR (Bespoke Visualizer) -->
                        <div class="flex-grow-1 d-flex flex-column justify-content-center">
                             <div class="font-data text-white-50 x-small tracking-widest mb-2">CURRENT STATE VECTOR</div>
                             <!-- JS populates this based on node type (Stack vs Gauge vs Pill) -->
                             <div id="sys-visualizer-container" class="w-100"></div>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-end mt-4">
                            <div class="font-data text-white-50 small" id="sys-counter">CARD 1 / X</div>
                            <div class="sys-pagination" id="sys-dots-container"></div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Ontology & Config (The Context) -->
                <div class="col-md-7 bg-white p-5 d-flex flex-column">
                    
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                        <div class="font-data text-muted small tracking-widest">
                            <i class="fas fa-sliders-h me-2"></i> CALIBRATION CONSOLE
                        </div>
                        <div class="d-flex gap-2">
                             <span class="badge bg-light text-muted border font-data rounded-pill px-3" id="sys-status-badge">PENDING</span>
                        </div>
                    </div>
                    
                    <!-- Scrollable Area -->
                    <div class="flex-grow-1 overflow-y-auto pe-2 custom-scrollbar d-flex flex-column gap-4">
                        
                        <!-- 1. DEFINITION CARD (Context) -->
                        <div class="bg-light rounded-3 p-4 border border-light-subtle">
                             <div class="d-flex gap-3">
                                <div class="mt-1"><i class="fas fa-info-circle text-primary"></i></div>
                                <div>
                                    <h6 class="font-data text-dark small mb-1">ONTOLOGICAL DEFINITION</h6>
                                    <p class="font-body text-secondary small mb-2" id="sys-display-desc" style="line-height: 1.5;">Description...</p>
                                    <div class="mt-2 pt-2 border-top border-light-subtle">
                                        <span class="font-data x-small text-muted uppercase me-1">Tip:</span>
                                        <span class="font-body x-small text-muted fst-italic" id="sys-display-guide">...</span>
                                    </div>
                                    <!-- Examples Container (New) -->
                                    <div id="sys-examples-container" class="d-flex flex-wrap gap-2 mt-3 pt-2 border-top border-dashed"></div>
                                </div>
                             </div>
                        </div>

                        <!-- 2. PROTOCOL TOGGLE -->
                        <div class="sys-protocol-toggle">
                            <button type="button" class="sys-protocol-btn active" id="mode-specify" onclick="setProtocolMode('SPECIFY')">
                                <i class="fas fa-pen-to-square me-2"></i> Specify
                            </button>
                            <button type="button" class="sys-protocol-btn" id="mode-speculate" onclick="setProtocolMode('SPECULATE')">
                                <i class="fas fa-wand-magic-sparkles me-2"></i> Speculate
                            </button>
                        </div>

                        <!-- 3. ACTIVE INPUT AREA (Bespoke) -->
                        <form id="system-node-form">
                            <input type="hidden" name="param_id" id="sys-param-id">
                            <input type="hidden" name="sys_type" id="sys-param-type">
                            <!-- JS Injects the correct inputs here -->
                            <div id="sys-input-container" class="mb-4"></div>
                            
                            <!-- 4. CONFIGURATION (Hard/Soft) -->
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all selected-mode-card h-100" 
                                         id="constraint-hard" onclick="setConstraintMode('HARD')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-lock me-2 text-primary"></i> HARD CONSTRAINT</div>
                                        <div class="text-muted x-small">Strict adherence.</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all opacity-50 h-100" 
                                         id="constraint-soft" onclick="setConstraintMode('SOFT')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-unlock me-2"></i> SOFT GUIDELINE</div>
                                        <div class="text-muted x-small">Trade-offs permitted.</div>
                                    </div>
                                </div>
                                <input type="hidden" name="constraint_mode" id="sys-constraint-input" value="HARD">
                            </div>

                            <!-- Rationale -->
                            <div>
                                <label class="font-data text-muted x-small mb-1">RATIONALE</label>
                                <textarea name="rationale" id="sys-rationale" class="form-control bg-light border-0 small" rows="2" placeholder="Why is this constraint set?"></textarea>
                            </div>
                        </form>

                    </div>
                    
                    <!-- Footer -->
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-light rounded-pill font-data px-4" data-bs-dismiss="modal">CANCEL</button>
                        <button type="button" class="btn btn-primary rounded-pill font-data px-5 shadow-lg" onclick="submitSystemForm()">
                            <i class="fas fa-save me-2"></i> COMMIT ANCHOR
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
"""

# ==============================================================================
# 4. RENDER FUNCTIONS
# ==============================================================================

def render_command_deck(system_params):
    """
    Orchestrates the Command Deck.
    Splits Horizon (Time) from the Anchors (Identity/Physics).
    """
    horizon_node = next((p for p in system_params if p['type'] == 'HORIZON'), None)
    other_params = [p for p in system_params if p['type'] != 'HORIZON']

    # Enrich generic params with Icon/Color from SYSTEM_NODES
    enriched_params = []
    for p in other_params:
        config = SYSTEM_NODES.get(p['type'], SYSTEM_NODES['OPERATOR'])
        enriched_params.append({
            **p,
            "icon": config['icon'],
            "color": config['color'],
            "label": config['label']
        })

    html_payload = {
        'horizon_html': "",
        'sidebar_html': ""
    }
    
    # 1. Render Horizon
    if horizon_node:
        import datetime
        # Logic: In real app, fetch creation_date from DB. For MVP, assume -7 days start.
        start_date = (datetime.date.today() - datetime.timedelta(days=7))
        val = horizon_node.get('value')
        
        # Display Logic
        target_display = val or "Unset"
        percent = 15 # Default MVP visual
        days_rem_str = "--" # Default
        
        # Try parsing date for real math
        try:
            if val and '-' in val:
                target_date = datetime.datetime.strptime(val, '%Y-%m-%d').date()
                total_days = (target_date - start_date).days
                days_left = (target_date - datetime.date.today()).days
                if total_days > 0:
                    percent = 100 - int((days_left / total_days) * 100)
                # Cap percentage between 0 and 100 for visual sanity
                percent = max(0, min(100, percent))
                days_rem_str = str(days_left)
                target_display = target_date.strftime('%b %d, %Y')
        except:
            pass

        # Color Logic based on health/time
        if percent > 90: health = "#ef5350" # Red
        elif percent > 75: health = "#ffa726" # Amber
        else: health = "#26c6da" # Teal

        html_payload['horizon_html'] = render_template_string(HORIZON_GAUGE_TEMPLATE, 
            start_date=start_date.strftime('%b %d, %Y'), 
            target_date_display=target_display,
            time_elapsed_percent=percent, 
            health_color=health,
            days_remaining=days_rem_str,
            value=val,
            id=horizon_node.get('id'),
            icon=SYSTEM_NODES['HORIZON']['icon']
        )
    
    # 2. Render Sidebar
    html_payload['sidebar_html'] = render_template_string(SYSTEM_SIDEBAR_STACK_TEMPLATE, system_params=enriched_params)
    
    return html_payload

def render_system_config_modal():
    return render_template_string(SYSTEM_EDITOR_MODAL_TEMPLATE, nodes=SYSTEM_NODES)

# ==============================================================================
# 5. GOVERNANCE WIDGET (The AI Clamps)
# ==============================================================================
GOVERNANCE_WIDGET_TEMPLATE = """
<div class="governance-console mb-4 fade-in">
    <div class="row g-0">
        <!-- OMBUD (Constraints) -->
        <div class="col-md-6 border-end border-light-subtle">
            <div class="p-3 d-flex align-items-start gap-3">
                <div class="gov-icon-box ombud">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div>
                    <div class="font-data x-small text-muted tracking-widest mb-1">OMBUD OVERSIGHT</div>
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="badge bg-success-subtle text-success border border-success-subtle font-data" id="ombud-status">COMPLIANT</span>
                        <span class="text-muted x-small" id="ombud-timestamp">Synced Just Now</span>
                    </div>
                    <p class="font-body x-small text-secondary mb-0" id="ombud-msg">
                        System constraints (Budget, Horizon) are aligned with projected velocity. No Charter violations detected.
                    </p>
                </div>
            </div>
        </div>

        <!-- ADVOCATE (Harmony) -->
        <div class="col-md-6">
            <div class="p-3 d-flex align-items-start gap-3">
                <div class="gov-icon-box advocate">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div>
                    <div class="font-data x-small text-muted tracking-widest mb-1">ADVOCATE INSIGHT</div>
                    <p class="font-body x-small text-dark fw-medium mb-0" id="advocate-msg">
                        <i class="fas fa-quote-left text-muted me-1 opacity-50"></i>
                        Consider creating a public-facing "Legacy" milestone early in the Engagement phase to build momentum before major resource expenditure.
                    </p>
                    <button class="btn btn-link p-0 text-decoration-none font-data x-small mt-1 text-primary" onclick="triggerGovernanceRefresh()">
                        <i class="fas fa-sync-alt me-1"></i> RE-SYNTHESIZE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
"""

üé® styles.css:
/* styles.css - SSPEC "Horizon Fusion" v2025.38 (PROTOTYPE VISUALS + WIZARD) */

/* ================================================== */
/* ==============  1. FONTS & VARIABLES  ============ */
/* ================================================== */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Manrope:wght@400;500;600;700;800&family=Antonio:wght@700&family=Mr+Dafoe&family=Unica+One&display=swap');

:root {
  /* --- Horizon Palette --- */
  --bg-warm: #e3f2fd;
  --surface-white: #ffffff;
  --surface-screen: #f8fafc;
  
  /* Brand Colors */
  --aviation-teal: #00bcd4;
  --deep-space-blue: #2c3e50;
  --retro-coral: #ff7043;
  
  /* Functional Colors */
  --danger: #ef5350;
  --success: #66bb6a;
  --warning: #ffca28;
  --text-dark: #1e293b;
  --text-muted: #64748b;

  /* Phase Colors */
  --phase-0: #ff7043; /* Discovery */
  --phase-1: #26c6da; /* Engagement */
  --phase-2: #ab47bc; /* Action */
  --phase-3: #ffa726; /* Completion */
  --phase-4: #66bd0e; /* Legacy */
  
  /* Typography Tokens */
  --font-brand: 'Righteous', cursive; 
  --font-retro: 'Unica One', cursive;
  --font-script: 'Mr Dafoe', cursive;
  --font-data: 'Antonio', sans-serif; 
  --font-body: 'Manrope', sans-serif;

  /* --- FLUID RESPONSIVE MATH --- */
  --font-size-base: clamp(0.875rem, 0.8rem + 0.25vw, 1rem); 
  --spacing-fluid: clamp(1rem, 2vw, 2rem);
  --radius-fluid: clamp(12px, 1.5vw, 24px);
}

body {
  font-family: var(--font-body);
  font-size: var(--font-size-base);
  background-color: transparent;
  color: var(--text-dark);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* Typography Overrides */
h1.display-script { font-family: var(--font-script); font-weight: 400; }
h1, h2, h3, .navbar-brand { font-family: var(--font-brand); letter-spacing: 1px; }

h4, h5, h6, .font-data, .ce-title, .card-domain-badge, .btn, .nav-link { 
    font-family: var(--font-data); letter-spacing: 0.5px; text-transform: uppercase; 
}
.font-retro { font-family: var(--font-retro); letter-spacing: 1px; text-transform: uppercase; }
.font-body, .card-desc { font-family: var(--font-body); }

/* ================================================== */
/* ==============  2. NAVIGATION  =================== */
/* ================================================== */
nav.navbar {
    background: transparent;
    padding-top: clamp(0.5rem, 1vw, 1.2rem);
    padding-bottom: clamp(0.5rem, 1vw, 1.2rem);
    z-index: 10;
}
.navbar-brand { text-decoration: none; }

/* ================================================== */
/* ==============  3. BACKGROUND ATMOSPHERE  ======== */
/* ================================================== */
.aurora-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; overflow: hidden;
    background-color: #f8fafc;
    transition: all 1s ease-in-out;
}

.aurora-noise {
    position: absolute; inset: 0; z-index: 2; opacity: 0.06;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
}

.aurora-blob {
    position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
    mix-blend-mode: multiply; animation-timing-function: ease-in-out; 
    animation-iteration-count: infinite; animation-direction: alternate;
}

.blob-1 { background-color: var(--phase-0); top: -10%; left: -10%; width: 70vw; height: 70vw; animation: float1 25s infinite; }
.blob-2 { background-color: var(--phase-1); top: -10%; right: -10%; width: 60vw; height: 60vw; animation: float2 28s infinite; }
.blob-3 { background-color: var(--phase-2); bottom: -20%; left: 20%; width: 70vw; height: 70vw; animation: float3 32s infinite; }
.blob-4 { background-color: var(--phase-3); bottom: -10%; right: -10%; width: 50vw; height: 50vw; animation: float1 22s infinite; opacity: 0.3; }
.blob-5 { background-color: var(--phase-4); top: 40%; left: 40%; width: 40vw; height: 40vw; animation: float3 35s infinite; opacity: 0.3; }

@keyframes float1 { from { transform: translate(0, 0) scale(1); } to { transform: translate(40px, 50px) scale(1.1); } }
@keyframes float2 { from { transform: translate(0, 0) scale(1); } to { transform: translate(-50px, 30px) scale(1.2); } }
@keyframes float3 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(30px, -40px) rotate(10deg); } }

body.state-outcome .aurora-background { opacity: 0.2; filter: grayscale(80%); }

/* ================================================== */
/* ==============  4. THE CONSOLE HOUSING =========== */
/* ================================================== */

.horizon-wrapper {
  /* 1. Geometry */
  padding: 0 1rem 1rem 1rem;
  height: calc(100vh - 120px); 
  width: 100%; /* Ensure the wrapper itself spans the screen */
  
  /* 2. Flexbox Centering */
  display: flex;
  flex-direction: column;
  justify-content: center; /* Centers Vertically */
  align-items: center;     /* Centers Horizontally (THE FIX) */
  
  overflow: hidden;
}

.console-housing {
  /* 4. Fill the calculated wrapper exactly */
  height: 100%; 
  width: 100%;
  max-width: 1440px;
  
  /* Visuals */
  background-color: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(24px);
  background-image: radial-gradient(#94a3b8 1.5px, transparent 1.5px);
  background-size: 24px 24px;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
  border: 1px solid rgba(255,255,255,0.8);
  
  /* Layout Internals */
  position: relative;
  overflow: hidden;
  display: flex;        /* Ensure holy grail layout for internal footer */
  flex-direction: column; 
}

.brand-strip {
  background: linear-gradient(90deg, #00bcd4 0%, #26c6da 50%, #ff7043 100%);
  height: 6px; width: 100%; position: absolute; top: 0; left: 0; z-index: 5;
}

.screen-surface {
    background: transparent;
    height: 100%;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Internal scrolling only */
}

/* ================================================== */
/* ===========  5. INPUT STAGE (Refined) ============ */
/* ================================================== */
.input-stage {
  flex-grow: 1;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.8) 100%);
  border-radius: 16px; 
}

.input-stage-wrapper {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 70vh; width: 100%;
}

.input-bezel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(25px);
    padding: clamp(1.5rem, 4vw, 3rem) !important;
    border-radius: clamp(16px, 3vw, 32px);
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 50px -10px rgba(0,0,0,0.1); 
    max-width: 900px;
    width: 90%;
    text-align: center;
    animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    position: relative;
}
@keyframes floatUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

.huge-input {
    border: none; border-bottom: 2px solid #cbd5e1;
    font-family: var(--font-body); font-weight: 300;
    color: var(--text-dark);
    width: 100%; text-align: center; 
    background: transparent; outline: none; transition: all 0.3s;
    font-size: clamp(1.2rem, 3vw, 2rem);
    padding: clamp(0.5rem, 1vw, 1rem);
}
.huge-input:focus { border-bottom-color: var(--aviation-teal); background: rgba(255,255,255,0.5); }
.huge-input::placeholder { color: #94a3b8; font-style: italic; }

.btn-launch {
    background: linear-gradient(135deg, var(--retro-coral) 0%, #f4511e 100%);
    color: white; font-family: var(--font-data); letter-spacing: 2px;
    border-radius: 50px; border: none;
    box-shadow: 0 8px 15px rgba(244, 81, 30, 0.2); transition: all 0.2s;
    padding: clamp(0.6rem, 1vw, 0.8rem) clamp(2rem, 3vw, 3rem);
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    margin-top: clamp(1.5rem, 2vw, 2rem);
}
.btn-launch:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(244, 81, 30, 0.3); }

/* =================================================== */
/* ======  7. GOAL SELECTION PAGE (FULL SECTION) ===== */
/* =================================================== */

/*
 * ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 * ‚îÇ  THE SACRED DIAGONAL FLIP - DESIGN PHILOSOPHY                          ‚îÇ
 * ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  Axis: rotate3d(1, 1, 0, Xdeg)                                         ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  This rotates around a diagonal line from bottom-left to top-right:    ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
 * ‚îÇ      ‚îÇ‚ï≤            ‚îÇ                                                   ‚îÇ
 * ‚îÇ      ‚îÇ ‚ï≤    ‚ü≥     ‚îÇ  ‚Üê Rotation axis                                  ‚îÇ
 * ‚îÇ      ‚îÇ  ‚ï≤         ‚îÇ                                                    ‚îÇ
 * ‚îÇ      ‚îÇ   ‚ï≤        ‚îÇ                                                    ‚îÇ
 * ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚ï≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                    ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  STATE ROTATION MAP:                                                   ‚îÇ
 * ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                   ‚îÇ
 * ‚îÇ  DEALING/REVEALING  ‚Üí  0deg    ‚Üí  Monolith (Back Face)                ‚îÇ
 * ‚îÇ  SELECTION          ‚Üí  180deg  ‚Üí  Goal Details (Front Face)           ‚îÇ
 * ‚îÇ  CONFIG             ‚Üí  360deg  ‚Üí  Hero Content (Back Face, full flip) ‚îÇ
 * ‚îÇ  RETURNING          ‚Üí  180deg  ‚Üí  Goal Details (Front Face)           ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 */

/* --- 7.1 STAGE VIEWPORT --- */
#stage-viewport {
    position: relative;
    flex: 1;       /* Grow to fill available space */
    min-height: 0; /* Critical for nested flex scrolling */
    width: 100%;
    overflow-y: auto; /* Enable internal scroll if cards are too tall */
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    padding: 1rem 2rem; /* Reduced padding */
}

#stage-viewport::-webkit-scrollbar { display: none; }

.goal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 2.5rem;
    padding: 1rem;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    align-items: start;
    justify-content: center;
    overflow: visible; 
}

/* --- 7.2 FLIP CARD WRAPPER (The Container) --- */
.flip-card-wrapper {
    position: relative;
    width: 100%;
    /* Strict Geometry Enforcement */
    aspect-ratio: 2/3 !important; 
    min-height: 0; /* Prevents grid blowout */
    height: auto;  /* Allows aspect-ratio to drive height */
    
    cursor: pointer;
    z-index: 10;
    margin: 0 auto;
    perspective: 1500px;
    
    opacity: 0; 
    transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* FIX: The "Floor Shadow" - Decoupled from rotation */
.flip-card-wrapper::after {
    content: "";
    position: absolute;
    z-index: -1;
    bottom: 0;
    left: 5%;
    width: 90%;
    height: 40px;
    border-radius: 50%;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0.2) 0%, transparent 70%);
    opacity: 0; 
    transition: opacity 0.5s ease, transform 0.3s ease;
    transform: translateY(15px) scale(0.9);
    pointer-events: none;
}

/* Shadow logic: Visible when revealed, shrinks when lifted */
.flip-card-wrapper.state-selection::after { opacity: 1; }
.flip-card-wrapper.state-selection:hover::after { opacity: 0.6; transform: translateY(30px) scale(0.7); }

/* --- 7.3 FLIP CARD INNER (The Gyroscope) --- */
.flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transform-origin: center center;
    /* Default: Front Face Visible */
    transform: rotate3d(1, 1, 0, 180deg); 
    transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1), border-radius 0.5s ease;
    border-radius: 32px;
}

/* --- 7.4 FACES (Diagonal Orientation) --- */
.flip-card-front, 
.flip-card-back {
    position: absolute;
    inset: 0;
    border-radius: 32px;
    overflow: hidden;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    background: white;
    transition: border-radius 0.5s ease;
}

/* Front: The Selection Interface */
.flip-card-front {
    transform: rotate3d(1, 1, 0, 180deg);
    z-index: 2;
    display: flex;
    flex-direction: column;
    border: 1px solid #e2e8f0;
}

/* Back: The Monolith / Hero */
.flip-card-back {
    transform: rotate3d(1, 1, 0, 0deg);
    z-index: 1;
    background: #2c3e50; 
    color: white;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    padding-left: 0px;
    padding-right: 0px;
    padding-top: 10px;
}

.card-texture-overlay {
    position: absolute; inset: 0; pointer-events: none;
    background-image: radial-gradient(rgba(255, 255, 255, 0.3) 1.5px, transparent 1.5px);
    background-size: 20px 20px;
    z-index: 1; opacity: 0.6;
}

/* --- 7.5 CONTENT LAYERS (No White Flash) --- */
.monolith-content {
    position: absolute; /* Absolute to overlay */
    inset: 0;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    transition: opacity 0.5s ease;
    opacity: 1;
    z-index: 5;
    pointer-events: none;
}

.hero-card-content {
    position: absolute; 
    inset: 0; 
    padding: .5rem;
    display: flex; 
    flex-direction: column;
    opacity: 0; 
    transition: opacity 0.6s ease;
    z-index: 6;
    color: white;
    pointer-events: auto;
}

.monolith-content .badge {
    white-space: nowrap;
    z-index: 10;
    max-width: 90%;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.7rem; /* Ensure it fits */
}

/* --- 7.6 STATE MACHINE CLASSES --- */

/* A. DEALING (Hidden -> Visible) */
.flip-card-wrapper.state-dealing { 
    opacity: 0; 
    transform: translateY(120px) scale(0.9); 
    pointer-events: none; 
}
/* Dealing shows Back Face (0deg) */
.flip-card-wrapper.state-dealing .flip-card-inner { transform: rotate3d(1, 1, 0, 0deg); }

/* B. REVEALING */
.flip-card-wrapper.state-revealing { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
    pointer-events: none; 
}
.flip-card-wrapper.state-revealing .flip-card-inner { transform: rotate3d(1, 1, 0, 0deg); }

/* C. SELECTION (Flip to Front - 180deg) */
.flip-card-wrapper.state-selection { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
    pointer-events: auto; 
    cursor: pointer; 
}
.flip-card-wrapper.state-selection .flip-card-inner { transform: rotate3d(1, 1, 0, 180deg); }

.flip-card-wrapper.state-selection:hover { 
    transform: translateY(-12px) scale(1.02); 
    z-index: 15; 
}
.flip-card-wrapper.state-selection:hover .flip-card-front { 
    box-shadow: 0 45px 80px -20px rgba(0, 0, 0, 0.35); 
}

/* D. CONFIG (Flip to Back, Dock Left - STATIC & SACRED) */
.flip-card-wrapper.state-config {
    position: absolute; 
    top: 0; 
    left: 0; 
    height: 100%; 
    width: 35%; 
    max-width: 480px; 
    margin: 0; 
    z-index: 100; 
    pointer-events: auto;
    border-radius: 0 24px 24px 0;
    
    /* DISABLE WRAPPER TRANSFORMS (No Wiggle) */
    transform: none !important; 
    transition: none; 
}

/* FORCE INNER TO ROTATE 360 (The Flip) */
.flip-card-wrapper.state-config .flip-card-inner { 
    transform: rotate3d(1, 1, 0, 360deg) !important; 
    border-radius: 0 24px 24px 0;
    box-shadow: none; 
}

/* Override Selection Hover */
.flip-card-wrapper.state-config:hover {
    transform: none !important;
    z-index: 100;
}

.flip-card-wrapper.state-config .flip-card-front,
.flip-card-wrapper.state-config .flip-card-back { border-radius: 0 24px 24px 0; }
.flip-card-wrapper.state-config .flip-card-back { box-shadow: 15px 0 50px -10px rgba(0, 0, 0, 0.30); }

/* E. RETURNING */
.flip-card-wrapper.state-returning { z-index: 100; pointer-events: none; }
.flip-card-wrapper.state-returning .flip-card-inner { transform: rotate3d(1, 1, 0, 180deg); border-radius: 32px; }
.flip-card-wrapper.state-returning .flip-card-front,
.flip-card-wrapper.state-returning .flip-card-back { border-radius: 32px; }

/* Utilities */
.flip-card-wrapper.violation .flip-card-inner { 
    opacity: 0.9; /* Less transparent */
    filter: grayscale(100%) contrast(1.2); /* High contrast B&W instead of muddy */
    box-shadow: none;
}

/* Add a red warning border to the back face of violations */
.flip-card-wrapper.violation .flip-card-back {
    border: 4px solid #ef5350; /* Red Border */
    background: #ac060e !important; /* Force dark background, ignore muddy gradients */
}

/* Ensure the Badge doesn't wrap/crush */
.monolith-content .badge {
    white-space: nowrap;
    z-index: 10;
    max-width: 90%;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.7rem; /* Ensure it fits */
}

/* --- 7.7 CARD CONTENT --- */
.monolith-icon-circle {
    width: 140px !important; height: 140px !important; min-width: 140px; min-height: 140px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.2); border-radius: 50%; margin-bottom: 1.5rem;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), inset 0 0 30px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px); padding: 0 !important;
}
.monolith-icon { font-size: 4rem; color: rgba(255, 255, 255, 0.95); filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2)); line-height: 1; display: block; }

.card-header-plate { 
    position: relative; flex: 0 0 33%; min-height: 160px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    overflow: visible; transform: translateZ(20px); 
}
.card-domain-badge-large {
    position: relative; z-index: 5; 
    font-family: var(--font-data); font-size: 0.7rem; font-weight: 800; letter-spacing: 0.2em;
    text-transform: uppercase; color: white; 
    background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.5); padding: 0.5rem 1.2rem; 
    border-radius: 50px; margin-bottom: 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-10px); 
}
.card-icon-float-large {
    position: absolute; bottom: 0; left: 50%; transform: translate(-50%, 50%); 
    z-index: 10; width: 7rem; height: 7rem; 
    background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15), 0 0 0 6px white;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
}
.flip-card-wrapper.state-selection:hover .card-icon-float-large { transform: translate(-50%, 42%) scale(1.05); }
.card-icon-float-large i { font-size: 3rem; transition: transform 0.3s ease; }

.card-body-large { 
    flex-grow: 1; display: flex; flex-direction: column; align-items: center; 
    justify-content: flex-start; text-align: center; padding: 4.5rem 2rem 1rem 2rem; 
}
.card-title-large { 
    font-family: var(--font-brand); font-size: clamp(1.4rem, 2.5vw, 1.8rem); 
    color: #1e293b; margin-bottom: 0.5rem; line-height: 1.1; 
    display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; 
}
.card-desc-large { 
    font-family: var(--font-body); font-size: 0.9rem; font-weight: 500; color: #64748b; 
    line-height: 1.5; max-width: 320px; 
    display: -webkit-box; -webkit-line-clamp: 4; line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; 
}
.card-footer-large { 
    padding: 1.5rem 2rem 2rem 2rem; 
    margin-top: auto; 
    width: 100%;
    position: relative; 
    z-index: 20; 
}

/* FIX: Button Clickability */
.btn-select-pill-large { 
    display: block; width: 100%; padding: 1rem 2rem; border: none; border-radius: 50px; 
    font-family: var(--font-data); font-size: 0.8rem; font-weight: 800; letter-spacing: 0.2em; 
    text-transform: uppercase; color: white; cursor: pointer; 
    box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.2); 
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    
    /* FORCE ON TOP OF TEXTURE LAYERS */
    position: relative;
    z-index: 50; 
    pointer-events: auto;
}
.btn-select-pill-large:hover { transform: translateY(-2px); box-shadow: 0 12px 30px -5px rgba(0, 0, 0, 0.25); }

/* ================================================== */
/* =========  7.9 HERO CONTENT ELEMENTS   =========== */
/* ================================================== */

.hero-card-content { 
    position: relative; 
    z-index: 10; 
    height: 100%; 
    display: flex; 
    flex-direction: column; 
    padding: 3rem 2.5rem 2.5rem 2.5rem; /* Tighter Top Padding */
    color: white; 
}

.hero-ghost-icon { 
    position: absolute; 
    bottom: -10%; 
    right: -10%; 
    font-size: 18rem; 
    color: rgba(255, 255, 255, 0.08); 
    transform: rotate(-12deg); 
    pointer-events: none; 
    z-index: 1; 
}

/* Return Button */
.hero-return-button {
    position: absolute; 
    top: 1.5rem; 
    left: 2.5rem;
    z-index: 50; 
    display: flex; align-items: center; gap: 0.5rem;
    color: rgba(255, 255, 255, 0.6); 
    font-family: var(--font-data); font-size: 0.7rem; font-weight: 800; 
    letter-spacing: 0.15em; text-transform: uppercase;
    background: none; border: none; padding: 0; 
    cursor: pointer; transition: all 0.2s ease;
}
.hero-return-button:hover { color: white; transform: translateX(-5px); }

/* Header Group */
.hero-header-group {
    margin-bottom: 1.5rem;
    display: flex; flex-direction: column; align-items: flex-start;
    width: 100%;
}

.hero-domain-label {
    font-family: var(--font-data); font-size: 0.65rem;
    letter-spacing: 0.2em; text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.5rem; display: block; text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    width: 100%; padding-bottom: 4px;
}

/* --- UPDATED: INVERTED DOMAIN PILL --- */
.hero-domain-pill {
    position: relative; 
    z-index: 10; 
    display: inline-flex; align-items: center; gap: 0.75rem;
    
    /* Saturated Background / White Text */
    background: var(--active-theme-color); 
    color: white; 
    
    border-radius: 50px; 
    padding: 0.5rem 1.25rem;
    margin-top: 0.25rem;
    width: auto; min-width: 160px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255,255,255,0.1);
}

.hero-domain-pill i { 
    font-size: 1.1rem; 
    color: rgba(255,255,255,0.9);
}

.hero-domain-pill span { 
    font-family: var(--font-data); font-size: 0.8rem; 
    font-weight: 800; letter-spacing: 0.1em; 
    color: white;
}

/* Hero Typography */
.hero-title { 
    position: relative; z-index: 10; 
    font-family: var(--font-brand); 
    font-size: clamp(1.8rem, 3.5vw, 2.5rem); 
    line-height: 1.1; margin-bottom: 1.5rem; text-align: left;
}

.hero-desc-box { 
    display: flex; gap: 1rem; margin-bottom: 2.5rem; 
    position: relative; z-index: 20; 
}
.hero-desc-accent { 
    width: 4px; background-color: rgba(255,255,255,0.6); 
    border-radius: 4px; flex-shrink: 0; 
}
.hero-desc-text { 
    font-family: var(--font-body); font-size: 1rem; 
    line-height: 1.6; font-weight: 500; 
    color: rgba(255,255,255,0.95); text-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    text-align: left;
}

/* System Config Stack */
#system-config-container { width: 100%; margin-top: 0; }
.sys-config-label {
    font-family: var(--font-data); font-size: 0.65rem;
    letter-spacing: 0.2em; text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
    border-bottom: 1px solid rgba(255,255,255,0.2); 
    padding-bottom: 4px; margin-bottom: 1rem;
    text-align: left; display: block; width: 100%;
}
#sys-pill-stack { 
    display: flex; flex-direction: column; gap: 0.6rem; 
    align-items: flex-start; width: 100%; position: relative; z-index: 10;
}

/* --- 7.10 CONFIG PANEL (Sliding Wizard) --- */
#configuration-stage {
    position: absolute;
    top: 0; 
    bottom: 0; 
    right: 0;
    left: calc(28% + 0.0125rem);; /* Docked to left 35% */
    width: auto;
    z-index: 50;
    pointer-events: none;
    
    /* Enter Animation: Hidden and shifted right by default */
    opacity: 0; 
    visibility: hidden; 
    transform: translateX(50px);
    transition: 
        opacity 0.5s ease, 
        transform 0.6s cubic-bezier(0.23, 1, 0.32, 1),
        visibility 0s linear 0.5s;
        
    display: flex;
    flex-direction: column;
}

#configuration-stage.active {
    opacity: 1 !important; 
    visibility: visible !important; 
    transform: translateX(0) !important; 
    pointer-events: auto;
    transition-delay: 0.2s;
}

.split-col-right {
    height: 100%; 
    width: 100%; 
    background: white;
    /* Only round the right corners or keep left sharp to butt against card */
    border-radius: 24px; 
    box-shadow: -5px 0 30px rgba(0, 0, 0, 0.08);
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
    border-left: none; /* Clean look */
}

/* ================================================== */
/* ==============  8. SPECULATION MODAL  ============ */
/* ================================================== */
.ce-app-shell {
    height: 85vh; 
    display: flex; flex-direction: column; overflow: hidden;
    background-color: #ffffff; border-radius: 16px; 
    box-shadow: 0 30px 80px -20px rgba(0,0,0,0.4); border: 1px solid #e2e8f0; 
}
.ce-modal-header {
    background: linear-gradient(135deg, var(--phase-color), rgba(0,0,0,0.15) 100%);
    color: white; flex-shrink: 0; padding: 0.8rem 1.5rem; 
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: space-between;
    position: relative; overflow: hidden; z-index: 20;
}
.node-icon-box {
    width: 48px; height: 48px;
    background: rgba(255,255,255,0.2); backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.3); border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    font-size: 1.4rem; color: #fff; flex-shrink: 0; margin-right: 1rem;
}
.header-text-block { display: flex; flex-direction: column; justify-content: center; }
.ce-modal-header .ce-title {
    font-family: var(--font-brand); font-weight: 500; font-size: 1.5rem;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0;
    line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
.ce-header-metadata {
    font-family: var(--font-data); font-size: 0.75rem; letter-spacing: 1px;
    text-transform: uppercase; opacity: 0.9; margin-top: 2px;
}
.header-ghost-icon {
    position: absolute; right: 10%; top: 50%;
    transform: translateY(-50%) rotate(-15deg);
    font-size: 10rem; color: white; opacity: 0.08;
    pointer-events: none; z-index: 0;
}
.btn-glass {
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
    color: white; border-radius: 50px; padding: 6px 14px; font-family: var(--font-data);
    font-size: 0.8rem; letter-spacing: 1px; transition: all 0.2s; backdrop-filter: blur(4px);
}
.btn-glass:hover {
    background: rgba(255,255,255,0.3); transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,255,255,0.1);
}
.btn-close-custom {
    background: none; border: none; color: rgba(255,255,255,0.7);
    font-size: 1.2rem; transition: color 0.2s;
}
.btn-close-custom:hover { color: white; }

.ce-micro-timeline {
    background: white; border-bottom: 1px solid #e2e8f0; padding: 0.8rem 1.5rem;
}
.milestone-segment {
    flex: 1; height: 4px; background: #e2e8f0; border-radius: 2px;
    margin: 0 2px; position: relative; transition: all 0.3s;
}
.milestone-segment.active { background: var(--phase-color); }
.milestone-segment .ms-bar { height: 100%; width: 100%; }
.ms-label {
    position: absolute; top: 8px; left: 0; width: 100%; text-align: center;
    font-family: var(--font-data); font-size: 0.55rem; color: #94a3b8;
    opacity: 0; transition: opacity 0.2s;
}
.milestone-segment.active .ms-label { opacity: 1; color: var(--phase-color); }
.ce-workspace-body { flex-grow: 1; display: flex; flex-direction: row; overflow: hidden; }
.ce-main-column { flex: 1; display: flex; flex-direction: column; min-width: 0; background-color: var(--surface-screen); position: relative; }
.ai-sidebar {
    width: 300px; flex-shrink: 0; border-left: 1px solid #e2e8f0;
    background-color: #ffffff; display: flex; flex-direction: column;
    z-index: 15; box-shadow: -5px 0 30px rgba(0,0,0,0.03);
}
.ce-nav-tabs {
    background: white; padding: 0 1.2rem; border-bottom: 1px solid #e2e8f0;
    flex-shrink: 0; display: flex; gap: 0.8rem; overflow-x: auto;
}
.ce-nav-tabs .nav-link {
    border: none; border-bottom: 3px solid transparent; color: var(--text-muted);
    font-family: var(--font-data); font-size: 0.9rem; letter-spacing: 0.5px;
    text-transform: uppercase; padding: 0.8rem 0.4rem; transition: all 0.2s; white-space: nowrap;
}
.ce-nav-tabs .nav-link:hover { color: var(--text-dark); }
.ce-nav-tabs .nav-link.active {
    color: var(--phase-color); background: transparent; border-bottom-color: var(--phase-color);
}
.count-badge { font-family: var(--font-body); font-weight: 800; vertical-align: top; font-size: 0.65em; }
.ce-app-content { flex-grow: 1; overflow-y: auto; padding: 0; position: relative; }
.bg-technical-grid {
    background-color: var(--surface-screen);
    background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px), radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 20px 20px; background-position: 0 0, 10px 10px;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.02);
}

/* ================================================== */
/* ==============  9. LOADING & UTILITIES  ========== */
/* ================================================== */
.loading-spinner-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(15, 23, 42, 0.4); backdrop-filter: blur(5px);
    display: flex; justify-content: center; align-items: center; 
    
    /* CRITICAL: Must be higher than .horizon-system-bar (usually z-100) */
    z-index: 10000; 
    
    transition: opacity 0.3s ease;
}
.loading-spinner-overlay.d-none { display: none !important; }

.spinner-box {
    width: 90%; max-width: 600px;
    padding: clamp(1.5rem, 3vw, 2.5rem);
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid #cbd5e1; border-radius: 15px;
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6);
    display: flex; align-items: center; gap: clamp(1rem, 2vw, 2.5rem);
    position: relative; overflow: hidden;
}
@media (max-width: 576px) {
    .spinner-box { flex-direction: column; text-align: center; }
    .spinner-content { align-items: center; }
    .spinner-text-stage { text-align: center; }
    .spinner-message { width: 100%; left: 0; text-align: center; }
}
.spinner-box::before {
    content: ""; position: absolute; top: 0; left: 0; bottom: 0; width: 15px;
    background: linear-gradient(180deg, #ff7043, #26c6da, #ab47bc, #ffa726, #66bd0e, #e91e63);
    background-size: 100% 400%; animation: phase-swirl 3s linear infinite; z-index: 10;
}
@keyframes phase-swirl { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }
.spinner-box::after {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
    transform: translateX(-100%); animation: shimmer 3s infinite;
}
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

.spinner-visual-stack {
    position: relative; width: 64px; height: 64px; flex-shrink: 0;
    display: flex; justify-content: center; align-items: center;
}
.la-ball-atom, .la-ball-atom > div { position: relative; box-sizing: border-box; }
.la-ball-atom { display: block; font-size: 0; color: #fff; width: 64px; height: 64px; }
.la-ball-atom > div { display: inline-block; float: none; background-color: currentColor; border: 0 solid currentColor; }
.la-ball-atom > div:nth-child(1) {
    position: absolute; top: 50%; left: 50%; z-index: 1; width: 70%; height: 70%; 
    background: var(--retro-coral); border-radius: 100%; transform: translate(-50%, -50%);
}
.la-ball-atom > div:not(:nth-child(1)) {
    position: absolute; left: 0; z-index: 0; width: 100%; height: 100%; background: none;
    animation: ball-atom-zindex 1.5s 0s infinite steps(2, end);
}
.la-ball-atom > div:not(:nth-child(1)):before {
    position: absolute; top: 0; left: 0; width: 14px; height: 14px; margin-top: -7px; margin-left: -7px;
    content: ""; border-radius: 50%; opacity: .85;
    animation: ball-atom-position 1.5s 0s infinite ease, ball-atom-size 1.5s 0s infinite ease;
}
.la-ball-atom > div:nth-child(2):before { background: var(--warning); }
.la-ball-atom > div:nth-child(3) { transform: rotate(120deg); }
.la-ball-atom > div:nth-child(3):before { background: var(--aviation-teal); }
.la-ball-atom > div:nth-child(4) { transform: rotate(240deg); }
.la-ball-atom > div:nth-child(4):before { background: #9c27b0; }

@keyframes ball-atom-position { 50% { top: 100%; left: 100%; } }
@keyframes ball-atom-size { 50% { transform: scale(.5, .5); } }
@keyframes ball-atom-zindex { 50% { z-index: 10; } }

.spinner-overlay-icon {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 20; color: white; font-size: 1.4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}
.spinner-content {
    display: flex; flex-direction: column; flex-grow: 1; 
    justify-content: center; position: relative; min-height: 60px;
    text-align: left; align-items: flex-start;
}
.spinner-title { 
    font-family: var(--font-data); font-size: clamp(1.4rem, 2vw, 1.8rem); 
    color: #0f172a; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 1px; line-height: 1;
}
.spinner-text-stage { position: relative; width: 100%; height: 1.5rem; text-align: left; }
.spinner-message {
    font-family: var(--font-body); font-size: 1.1rem; color: #64748b; font-weight: 500;
    position: absolute; top: 0; left: 0; width: 100%; white-space: nowrap; overflow: hidden;
}
.fade-out { opacity: 0; pointer-events: none; }
.wipe-out { animation: textWipeOut 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; }
.wipe-in { 
    animation: textWipeIn 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; 
    animation-delay: 0.15s; 
    clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%);
    -webkit-mask-image: linear-gradient(to right, transparent, black);
    mask-image: linear-gradient(to right, transparent, black);
}
@keyframes textWipeOut { 
    0% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 
    100% { clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%); } 
}
@keyframes textWipeIn { 
    0% { clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%); } 
    100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 
}

/* ================================================== */
/* =======  10. HORIZON SYSTEM MASTHEAD  ============ */
/* ================================================== */
.horizon-system-bar {
    width: 100%; max-width: 1400px; margin: 0 auto; 
    display: flex; justify-content: space-between; align-items: center;
    padding: clamp(0.5rem, 1.5vw, 1.5rem) clamp(1rem, 2vw, 2rem);
    z-index: 100; position: relative;
}
.masthead-spacer { width: 120px; display: none; }
@media(min-width: 992px) { .masthead-spacer { display: block; } }
.masthead-title-lockup { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.masthead-pill {
    background: var(--aviation-teal); color: white; font-family: 'Antonio', sans-serif;
    font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase;
    padding: 3px 10px; border-radius: 50px; margin-bottom: 4px; font-weight: 700;
}
.masthead-brand { line-height: 0.8; color: var(--deep-space-blue); text-shadow: 0 1px 0px rgba(255,255,255,0.6); }
.brand-script {
    font-family: 'Mr Dafoe', cursive; font-size: clamp(1.8rem, 3vw, 2.5rem);
    color: var(--retro-coral); margin-right: 8px; display: inline-block;
    transform: rotate(-4deg) translateY(-3px);
}
.brand-display {
    font-family: 'Righteous', cursive; font-size: clamp(1.4rem, 2.5vw, 2rem);
    text-transform: uppercase; letter-spacing: 1px; color: #37474f; 
}
.masthead-controls { display: flex; gap: 0.6rem; align-items: center; width: auto; justify-content: flex-end; }
@media(min-width: 992px) { .masthead-controls { width: 120px; } }

.btn-masthead {
    width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.8); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    cursor: pointer; transition: all 0.2s; font-size: 1.1rem; text-decoration: none;
}
.btn-masthead:hover { 
    background: white; color: var(--aviation-teal); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}
.user-avatar {
    width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, #ff7043, #d84315);
    color: white; display: flex; align-items: center; justify-content: center; 
    font-weight: bold; font-family: 'Antonio', sans-serif; border: 2px solid white; 
    box-shadow: 0 4px 10px rgba(244, 81, 30, 0.3); cursor: pointer;
}

/* ================================================== */
/* ========  11. DASHBOARD & SYSTEM WIDGETS  ======== */
/* ================================================== */

/* --- A. The Sidebar Stack (Vertical Anchors) --- */
.system-anchor-card {
    /* Base Container */
    background: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle border */
    border-radius: 16px; /* High radius for "App" feel */
    
    /* Layout */
    display: flex; 
    align-items: center; 
    gap: 12px;
    padding: 0.6rem 0.8rem; 
    margin-bottom: 0.5rem;
    
    /* Interaction */
    cursor: pointer; 
    position: relative; 
    overflow: hidden; 
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    /* Default Shadow */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.system-anchor-card:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    background: white;
    z-index: 10;
}

/* The Icon Circle inside the card */
.system-anchor-card .rounded-circle {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); /* Inner depth for icon bg */
}

/* Typography Overrides for Sidebar */
.system-anchor-card .font-data {
    color: #94a3b8; /* Muted label */
    letter-spacing: 0.05em;
}
.system-anchor-card .font-body {
    color: #334155; /* Darker value text */
}

/* --- B. Horizon Gauge Container --- */
.system-node-card { 
    background: #ffffff; 
    border: 1px solid #e2e8f0; 
    border-radius: 12px; 
    transition: transform 0.2s ease, box-shadow 0.2s ease; 
}
.system-node-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 10px 25px -10px rgba(0, 188, 212, 0.15) !important; 
    border-color: var(--aviation-teal); 
}
.system-node-card.group:hover i { 
    transform: scale(1.1); 
    color: var(--aviation-teal) !important; 
}
.system-node-card i { 
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
}

/* --- C. Utility: Borders & Layouts --- */
.border-dashed { border-style: dashed !important; }
.console-housing .row { min-height: 85vh; align-items: stretch; }
.command-deck-wrapper .lead { font-weight: 400; color: #2c3e50; letter-spacing: 0.01em; }

/* ================================================== */
/* ========  12. STRATEGIC CHARTER STYLING  ========= */
/* ================================================== */
.charter-card {
    background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.6); border-top: 4px solid var(--aviation-teal);
    border-radius: 16px; position: relative; overflow: hidden;
    box-shadow: 0 10px 30px -5px rgba(0, 188, 212, 0.15);
}
.charter-header-text {
    font-family: 'Righteous', cursive; font-size: 1.1rem; letter-spacing: 1px;
    color: var(--aviation-teal); text-transform: uppercase;
}
.charter-content {
    position: relative; z-index: 2; font-family: 'Manrope', sans-serif;
    color: #263238; text-shadow: 0 1px 0 rgba(255,255,255,0.8);
    text-align: left; line-height: 1.8;
}
.domain-ghost-watermark {
    position: absolute; bottom: -20px; right: 10px;
    font-size: 12rem; color: var(--aviation-teal); opacity: 0.06;
    transform: rotate(-15deg); pointer-events: none; z-index: 0; transition: all 0.5s ease;
}

/* ================================================== */
/* ======  13. PILL SYSTEMS (ANCHORS & ATOMS)  ====== */
/* ================================================== */

/* --- A. CE CAPSULE ("Action Atoms" - The Standard Tags) --- */
.ce-capsule {
    display: inline-flex !important; 
    align-items: center; 
    vertical-align: middle;
    width: auto !important; 
    max-width: 100%; 
    flex-shrink: 0;
    
    background-color: var(--node-color, #78909c); 
    color: white !important;
    
    padding: 3px 12px 3px 4px; /* Space for icon on left */
    border-radius: 50px; 
    margin: 0 4px;
    
    font-family: var(--font-body); 
    font-weight: 700; 
    font-size: 0.75rem;
    text-transform: uppercase; 
    letter-spacing: 0.5px;
    
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15); 
    border: 1px solid rgba(255,255,255,0.2);
    line-height: 1.4; 
    white-space: nowrap;
}

.ce-capsule:hover {
    transform: translateY(-1px); 
    box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
    filter: brightness(1.1);
}

.ce-capsule i {
    background-color: white; 
    color: var(--node-color, #78909c); 
    width: 20px; height: 20px; 
    border-radius: 50%;
    display: inline-flex; 
    justify-content: center; 
    align-items: center;
    margin-right: 8px; 
    font-size: 0.7em; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* --- B. SYSTEM HIGHLIGHT ("The Wizard Pills" in Text) --- */
.sys-highlight {
    display: inline-flex !important;
    align-items: center;
    vertical-align: middle;
    width: auto !important;
    flex-shrink: 0;
    
    /* Capsule Look (White Background, Colored Border) */
    background-color: white;
    border: 2px solid var(--sys-color, #cbd5e1);
    border-radius: 999px;
    
    padding: 2px 10px 2px 3px; /* Tight padding left for icon */
    margin: 0 4px;
    
    /* Interactive Props */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    
    /* Text Styling */
    color: #475569; /* Slate Text */
    line-height: 1.2;
}

.sys-highlight:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    background-color: #f8fafc;
    border-color: var(--sys-color); /* Reinforce border color */
}

/* The Icon inside the System Highlight */
.sys-highlight .sys-highlight-icon i {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 22px; 
    height: 22px; 
    border-radius: 50%;
    
    /* Filled Color Logic */
    background-color: var(--sys-color, #64748b);
    color: white !important;
    
    margin-right: 6px;
    font-size: 0.7rem;
    flex-shrink: 0;
}

/* The Text inside the System Highlight */
.sys-highlight-text {
    font-family: var(--font-data);
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--sys-color, #475569); /* Text matches the system color */
    position: relative;
    top: 1px; /* Optical alignment */
}

/* --- C. SYSTEM CONSOLE INPUTS (Legacy / Backup) --- */
.system-pill-input-container {
    background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 50px; padding: 6px 16px;
    display: flex; align-items: center; gap: 10px;
    transition: all 0.2s ease; backdrop-filter: blur(4px);
}
.system-pill-input-container:hover,
.system-pill-input-container:focus-within {
    background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4);
    box-shadow: 0 0 15px rgba(255,255,255,0.05);
}
.system-pill-select, 
.system-pill-date {
    background: transparent; border: none; color: white;
    font-family: var(--font-body); font-weight: 600; font-size: 0.9rem;
    width: 100%; outline: none; cursor: pointer; appearance: none;
}
.system-pill-input-container::after {
    content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900;
    color: rgba(255,255,255,0.5); font-size: 0.7rem; pointer-events: none;
}
.system-pill-date::-webkit-calendar-picker-indicator { 
    filter: invert(1); cursor: pointer; opacity: 0.6;
}
.system-pill-date::-webkit-calendar-picker-indicator:hover { opacity: 1; }
.system-pill-select option { background: #1e293b; color: white; padding: 10px; }

/* --- Outcome Image Portal --- */
.image-portal {
    width: 100%;
    /* No max-width restriction for sidebar containment */
    border-radius: 16px;
    overflow: hidden;
    position: relative; 
    background: #ffffff;
    margin: 0 auto;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
}

.image-portal img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; 
    transition: opacity 1s ease-in-out; 
}

/* ================================================== */
/* ========  14. SYSTEM SIDEBAR WIDGETS (Modal) ===== */
/* ================================================== */
.sys-modal-left {
    color: white; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between;
}
.sys-modal-texture {
    position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.2; pointer-events: none; z-index: 0;
}
.sys-protocol-toggle {
    display: flex; background-color: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 1.5rem;
}
.sys-protocol-btn {
    flex: 1; border: none; background: transparent; padding: 8px;
    font-family: var(--font-data); font-size: 0.7rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px; color: #94a3b8;
    border-radius: 6px; transition: all 0.2s;
}
.sys-protocol-btn.active { background: white; color: #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.sys-protocol-btn.active.speculate { color: #6366f1; }

.sys-entity-card {
    background: white; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-left: 4px solid var(--sys-color); margin-bottom: 8px;
    animation: slideInLeft 0.3s ease forwards;
}
.sys-entity-avatar {
    width: 28px; height: 28px; border-radius: 50%; background: #f1f5f9; color: #64748b;
    display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;
}

/* ================================================== */
/* ======  15. COLLECTION CARDS & DASHBOARD  ======== */
/* ================================================== */
.system-hero-card {
    background-color: var(--phase-color);
    background-image: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.05) 100%);
    border-radius: 12px; padding: 1.5rem; position: relative; overflow: hidden;
    color: white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
    min-height: 200px; border: 1px solid rgba(255,255,255,0.2);
    display: flex; flex-direction: column; justify-content: center;
}
.system-hero-card .hero-ghost-icon {
    position: absolute; right: -20px; bottom: -40px;
    font-size: 10rem; color: rgba(255,255,255,0.3);
    transform: rotate(-15deg); pointer-events: none; z-index: 1;
}
.hero-label {
    font-family: 'Antonio', sans-serif; font-size: 0.75rem; letter-spacing: 2px;
    text-transform: uppercase; opacity: 0.9; margin-bottom: 0.5rem; position: relative; z-index: 2;
}
.status-card-value {
    font-family: 'Righteous', cursive; font-size: 2.2rem;
    line-height: 1; margin-bottom: 0.8rem; text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative; z-index: 2;
}

.metric-tile {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px;
    padding: 1.2rem; height: 100%; display: flex; flex-direction: column; justify-content: space-between;
    box-shadow: 0 2px 4px rgba(0,0,0,0.01); transition: all 0.2s ease;
}
.metric-tile:hover {
    transform: translateY(-2px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.08); border-color: var(--phase-color);
}
.metric-number {
    font-family: 'Righteous', cursive; font-size: 2rem; color: var(--text-dark);
    line-height: 1; margin: 0.2rem 0;
}
.metric-label {
    font-family: 'Antonio', sans-serif; font-size: 0.7rem; letter-spacing: 1.5px;
    color: var(--text-muted); text-transform: uppercase;
}

/* Collection Cards */
.collection-container { padding: 1.2rem; }
.collection-card-modern {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    padding: 1rem; margin-bottom: 0.6rem; display: flex; align-items: center;
    position: relative; overflow: hidden; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.collection-card-modern::before {
    content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background-color: var(--phase-color); transition: width 0.2s;
}
.collection-card-modern:hover { transform: translateX(2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.collection-card-modern:hover::before { width: 6px; }
.collection-card-modern.border-dashed { border-style: dashed; border-color: #6366f1; background-color: #f8faff; }
.collection-card-modern.border-dashed::before { background-color: #6366f1; }
.card-title-modern { font-family: var(--font-data); font-size: 1rem; color: var(--text-dark); margin-bottom: 2px; }
.card-subtitle-modern { font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); }

/* --- Possibility Cards --- */
.collection-card-modern.possibility-card {
    background-color: #f0fdf4; border: 1px dashed #6366f1; opacity: 0.9;
}
.collection-card-modern.possibility-card:hover {
    opacity: 1; background-color: #fff; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.15); transform: translateY(-2px);
}
.badge.bg-primary-soft { background-color: rgba(99, 102, 241, 0.1); color: #6366f1 !important; border: 1px solid rgba(99, 102, 241, 0.2); }
.animate-pulse { animation: pulse-text 2s infinite; }
@keyframes pulse-text { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

/* ================================================== */
/* ========  16. RESPONSIVE OVERRIDES  ============== */
/* ================================================== */
/* 1. FIX THE SIDEBAR SQUISH (Outcome Page) */
@media (max-width: 1400px) {
    .col-lg-3 { width: 33.33333%; }
    .col-lg-9 { width: 66.66667%; }
}
@media (max-width: 992px) {
    .console-housing .row { flex-direction: column; }
    .col-lg-3, .col-lg-9 { width: 100%; border-right: none !important; border-bottom: 1px solid #e2e8f0; }
    .image-portal { display: none; }
    .masthead-spacer { display: none; }
    .ce-app-shell { height: 85vh; }
    .ce-workspace-body { flex-direction: column; overflow-y: auto; }
    .ai-sidebar { width: 100%; height: auto; border-left: none; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
}

/* --- THEATER MODE RESPONSIVE (NEW) --- */
@media (max-width: 1200px) {
    .goal-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem; padding: 1.5rem 2rem;
    }
    .flip-card-wrapper.morph-active {
    transform: perspective(1500px) rotateY(8deg);
    box-shadow: -20px 20px 60px rgba(0,0,0,0.3);}
    .split-col-right { width: 60%; }
}

@media (max-width: 768px) {
    .goal-grid {
        grid-template-columns: 1fr;
        gap: 1rem; padding: 1rem;
    }
    .flip-card-wrapper.morph-active {
        width: 100% !important;
        height: 50vh !important;
    }
    .split-col-right {
        width: 100%; top: 50vh; height: 50vh;
        border-radius: 24px 24px 0 0;
    }
    .identity-grid { grid-template-columns: 1fr; }
}

/* ================================================== */
/* ======  SECTION 17: WIZARD UI & SYSTEM PILLS   === */
/* ================================================== */

/* 17.1 Container Structure */
.wizard-container {
    display: flex; flex-direction: column;
    height: 100%; min-height: 100%;
    background: white; overflow: hidden; position: relative;
    --active-theme-color: var(--aviation-teal); 
    --theme-light: rgba(0, 188, 212, 0.1);
}

/* 17.2 Header Area (Compressed) */
.wizard-header {
    padding: 1.5rem 2.5rem 0.5rem; /* Reduced bottom padding */
    flex-shrink: 0; background: white; z-index: 10;
}
.wizard-header.hidden { display: none; }

/* 17.3 Content Area */
.wizard-content {
    flex: 1; overflow-y: auto; 
    padding: 0.5rem 2.5rem; /* Tight vertical padding */
    display: flex; flex-direction: column; justify-content: center; 
    scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;
}
.wizard-content::-webkit-scrollbar { width: 6px; }
.wizard-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

/* 17.4 The Footer (Compressed) */
.wizard-footer {
    flex-shrink: 0; margin-top: auto;
    padding: 1rem 2.5rem 1.5rem; /* Tight vertical padding */
    background: white; border-top: 1px solid #f1f5f9;
    z-index: 20; display: flex; justify-content: space-between;
    align-items: center; gap: 2rem;
}

/* 17.5 Breadcrumbs */
.wizard-progress-track { display: flex; gap: 0.5rem; }
.wizard-step-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #e2e8f0; transition: all 0.3s; cursor: pointer;
}
.wizard-step-dot.active { background: var(--active-theme-color); transform: scale(1.2); }
.wizard-step-dot.completed { background: var(--success); }
.wizard-track-label {
    font-family: var(--font-data); font-size: 0.75rem; color: #94a3b8;
    margin-right: 1rem; text-transform: uppercase; letter-spacing: 1px;
}

/* =========================================
   SECTION 17.6: STANDARD OPTION CARDS
   ========================================= */

.option-grid-compact {
    display: grid; grid-template-columns: repeat(2, 1fr);
    gap: 1rem; width: 100%; margin-bottom: 1rem; min-height: 0;
}

/* Base Interactive Card (Main Wizard) */
.option-card {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.5rem 1rem; width: 100%;
    min-height: 60px; /* Reduced Height for Density */
    
    background-color: white;
    border: 2px solid #e2e8f0;
    border-radius: 999px; /* Capsule Shape */
    
    cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative; overflow: hidden; text-align: left;
    
    /* Dynamic Tint Logic */
    --opt-primary: var(--active-theme-color);
    background-color: color-mix(in srgb, var(--opt-primary) 3%, white);
    border-color: color-mix(in srgb, var(--opt-primary) 15%, #e2e8f0);
}

.option-card:hover {
    background-color: color-mix(in srgb, var(--opt-primary) 8%, white);
    border-color: var(--opt-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.05); z-index: 2;
}
.option-card:active { transform: scale(0.98); }

.option-card.selected {
    background-color: color-mix(in srgb, var(--opt-primary) 12%, white);
    border-color: var(--opt-primary);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 0 0 1px var(--opt-primary);
}

.option-icon {
    height: 2.5rem; width: 2.5rem; flex-shrink: 0;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    background-color: color-mix(in srgb, var(--opt-primary) 15%, white);
    color: var(--opt-primary); 
    transition: all 0.2s; font-size: 1.1rem;
}

.option-card.selected .option-icon {
    background-color: var(--opt-primary); color: white; transform: scale(1.05);
}

.option-label {
    flex: 1; font-family: var(--font-data);
    font-weight: 800; font-size: 0.8rem;
    text-transform: uppercase; letter-spacing: 0.05em;
    color: #475569; line-height: 1.2; transition: color 0.2s;
}
.option-card.selected .option-label { color: #0f172a; }

/* Checkmark Badge */
.option-card::after {
    content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
    font-size: 0.9rem; color: var(--opt-primary); margin-right: 0.25rem;
    opacity: 0; transform: scale(0.5);
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.option-card.selected::after { opacity: 1; transform: scale(1); }


/* =========================================
   SECTION 17.11: FORK SCREEN & SYSTEM PILLS
   ========================================= */

/* The Fork "Generate" Button */
.wiz-btn-gen {
    position: relative; overflow: hidden;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
    border: none; z-index: 10;
}
.wiz-btn-gen:hover {
    transform: scale(1.03) translateY(-3px);
    box-shadow: 0 15px 30px -5px rgba(0, 188, 212, 0.4);
}
.wiz-btn-gen:active { transform: scale(0.98) translateY(0); }

/* The "Precision" System Pills (Rounded & Detailed) */
.option-card-pill {
    /* Layout */
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    
    /* Skin */
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    position: relative;
    overflow: hidden;
    padding: 0.75rem 1rem; /* Slightly taller for breathing room */
}

.option-card-pill:hover {
    border-color: var(--opt-primary, #94a3b8);
    background-color: #f8fafc;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.option-card-pill.selected {
    background-color: color-mix(in srgb, var(--opt-primary) 6%, white);
    border-color: var(--opt-primary);
    box-shadow: 0 4px 15px -3px rgba(0,0,0,0.1);
}

.option-card-pill .pill-icon-circle {
    background-color: #f1f5f9;
    color: #94a3b8;
    width: 42px; height: 42px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
    transition: all 0.2s ease;
}

.option-card-pill.selected .pill-icon-circle {
    background-color: var(--opt-primary);
    color: white;
    transform: scale(1.1);
}

.option-card-pill .pill-title {
    font-family: var(--font-data);
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.5px;
    color: #334155;
    margin-bottom: 2px;
    line-height: 1;
    transition: color 0.2s;
}

.option-card-pill.selected .pill-title {
    color: var(--opt-primary);
}

.option-card-pill .pill-desc {
    font-family: var(--font-body);
    font-weight: 500;
    font-size: 0.7rem; color: #64748b; line-height: 1.2;
}

/* --- THE RIGHT-ALIGNED CHECK INDICATOR --- */
.pill-check-indicator {
    width: 28px; 
    height: 28px; 
    border-radius: 50%;
    border: 2px solid #cbd5e1; /* Unselected Gray Ring */
    
    /* Flexbox Magic: This pushes it to the far right */
    margin-left: auto; 
    
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 0.8rem;
    color: transparent; /* Hide checkmark when unselected */
    background: white;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
}

/* Selected State for Indicator */
.option-card-pill.selected .pill-check-indicator {
    background-color: var(--opt-primary);
    border-color: var(--opt-primary);
    color: white; /* Show checkmark */
    transform: scale(1.1);
}

/* Hide the old ::after pseudo-element checkmark to avoid duplicates */
.option-card-pill::after { display: none; }

/* =========================================
   SECTION 17.6: SYSTEM PILL (OPTION CARD)
   ========================================= */

.option-grid-compact {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    width: 100%;
    margin-bottom: 1.5rem;
    min-height: 0;
}

/* Base Interactive Pill */
.option-card, .option-card-pill {
    /* Layout */
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem; /* Reduced padding */
    width: 100%;
    min-height: 60px;
    
    /* Shape & Skin */
    background-color: white; /* Fallback */
    border: 2px solid #e2e8f0; /* Default border */
    border-radius: 9999px; /* Pill Shape */
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    text-align: left; /* Align text left */

    /* DYNAMIC COLOR LOGIC (The Slick Prototype look) */
    /* Fallback color if JS doesn't inject one */
    --opt-primary: var(--active-theme-color);
    
    /* 1. Default State (Unselected but Tinted) */
    /* Creates a 3% tint of the specific option color over white */
    background-color: color-mix(in srgb, var(--opt-primary) 3%, white);
    /* Slightly tinted border (15% mix with slate) */
    border-color: color-mix(in srgb, var(--opt-primary) 15%, #e2e8f0);
}

/* Hover State */
.option-card:hover, .option-card-pill:hover {
    background-color: color-mix(in srgb, var(--opt-primary) 8%, white);
    border-color: var(--opt-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.05);
    z-index: 2;
}

/* The "Physical" Press effect */
.option-card:active, .option-card-pill:active {
    transform: scale(0.98);
}

/* Selected State */
.option-card.selected, .option-card-pill.selected {
    /* Darker tint (12%) */
    background-color: color-mix(in srgb, var(--opt-primary) 12%, white);
    border-color: var(--opt-primary);
    /* Inner glow of the primary color */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 0 0 1px var(--opt-primary);
}

/* Icon Container */
.option-icon, .pill-icon-circle {
    height: 2.5rem; width: 2.5rem;
    flex-shrink: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* 2. Icon Background (Always tinted) */
    background-color: color-mix(in srgb, var(--opt-primary) 15%, white);
    color: var(--opt-primary); /* Glyph takes the color */
    
    transition: all 0.2s;
    font-size: 1.1rem;
    margin-bottom: 0; 
}

/* Selected Icon State (Inversion) */
.option-card.selected .option-icon,
.option-card-pill.selected .pill-icon-circle {
    background-color: var(--opt-primary); /* Solid color */
    color: white; /* White glyph */
    transform: scale(1.05);
}

/* Text Label */
.option-label, .pill-title {
    flex: 1;
    font-family: var(--font-data);
    font-weight: 800;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #475569; /* Slate 600 */
    line-height: 1.2;
    transition: color 0.2s;
}

.option-card.selected .option-label,
.option-card-pill.selected .pill-title {
    color: #0f172a; /* Slate 900 (Darker) */
}

.pill-desc {
    display: none; /* Hide description in grid view to keep it clean */
}

/* Checkmark Badge (Hidden until selected) */
.option-card::after, .option-card-pill::after {
    content: '\f00c'; /* FA Check */
    font-family: "Font Awesome 6 Free"; 
    font-weight: 900;
    font-size: 0.9rem;
    color: var(--opt-primary);
    margin-right: 0.25rem;
    
    /* Animation */
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.option-card.selected::after, .option-card-pill.selected::after {
    opacity: 1;
    transform: scale(1);
}

/* 17.7 Tag Input (Ingredients) */
.tag-input-container {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    min-height: 120px;
    align-content: flex-start;
    transition: border-color 0.2s, box-shadow 0.2s;
    cursor: text;
}

.tag-input-container:focus-within {
    border-color: var(--active-theme-color);
    box-shadow: 0 0 0 4px var(--theme-light);
}

.tag-pill {
    background: white;
    border: 2px solid var(--active-theme-color);
    color: var(--text-dark);
    padding: 0.35rem 1rem;
    border-radius: 50px;
    font-family: var(--font-data);
    font-size: 0.75rem;
    font-weight: 800;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.tag-input-field {
    border: none; outline: none; flex-grow: 1; min-width: 120px;
    font-family: var(--font-body); font-size: 1rem; color: #334155;
    background: transparent;
}

/* 17.8 Context Insight Box */
.context-insight-box {
    background: #f8fafc;
    border-left: 4px solid var(--active-theme-color); 
    padding: 1rem 1.5rem;
    border-radius: 0 12px 12px 0;
    margin-top: auto; 
    animation: slideUpFade 0.3s ease-out;
}

.context-insight-title {
    font-family: var(--font-data); font-size: 0.65rem;
    letter-spacing: 0.15em; font-weight: 800; color: #94a3b8;
    margin-bottom: 0.4rem; text-transform: uppercase;
    display: flex; align-items: center; gap: 0.5rem;
}

.context-insight-body {
    font-family: var(--font-body); font-size: 0.95rem;
    color: #1e293b; line-height: 1.4; font-weight: 500;
}

/* 17.9 Navigation Buttons */
.wiz-btn-next, .wiz-btn-back {
    border: none; border-radius: 50px; padding: 0.8rem 2rem;
    font-family: var(--font-data); font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;
}

.wiz-btn-next {
    background-color: var(--text-dark); color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.wiz-btn-next:hover { transform: translateY(-2px); background-color: black; }

.wiz-btn-back { background: transparent; color: #94a3b8; }
.wiz-btn-back:hover { color: var(--text-dark); background: #f1f5f9; }

/* 17.10 Embedded Loader (Morph) */
.wizard-container.loading-state { justify-content: center; align-items: center; }
.wizard-container.loading-state .wizard-header,
.wizard-container.loading-state .wizard-content,
.wizard-container.loading-state .wizard-footer { display: none; }

.embedded-spinner-wrapper {
    display: none; flex-direction: column; align-items: center;
    justify-content: center; width: 100%; height: 100%;
    animation: fadeIn 0.5s ease-out;
}
.wizard-container.loading-state .embedded-spinner-wrapper { display: flex; }

.embedded-spinner-wrapper .spinner-box {
    box-shadow: none; border: none; background: transparent; padding: 0;
    max-width: 100%; flex-direction: column; text-align: center; gap: 1.5rem;
}
.embedded-spinner-wrapper .spinner-visual-stack { width: 80px; height: 80px; margin: 0 auto; }
.embedded-spinner-wrapper .spinner-title {
    font-family: var(--font-brand); font-size: 2rem; margin-bottom: 1rem; color: var(--text-dark);
}
.embedded-spinner-wrapper .spinner-message { text-align: center; font-size: 1.1rem; width: 100%; }

/* ================================================== */
/* ===  17.11 WIZARD FORK & SPECIAL ACTIONS       === */
/* ================================================== */

/* --- The Big "Generate" Button (Hero Action) --- */
.wiz-btn-gen {
    position: relative;
    overflow: hidden; /* Contains the shimmer */
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
    border: none;
    z-index: 10;
}

.wiz-btn-gen:hover {
    transform: scale(1.03) translateY(-3px);
    box-shadow: 0 15px 30px -5px rgba(0, 188, 212, 0.4); /* Glow effect */
}

.wiz-btn-gen:active {
    transform: scale(0.98) translateY(0);
}

/* Shimmer Animation Element */
.shimmer-effect {
    position: absolute;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
    transform: skewX(-20deg) translateX(-150%);
    transition: transform 0.5s;
    z-index: 1;
    pointer-events: none;
}

/* Run shimmer on hover */
.wiz-btn-gen:hover .shimmer-effect {
    transform: skewX(-20deg) translateX(150%);
    transition: transform 0.7s ease-in-out;
}

/* --- Optional "Fork" Pills (The Extra Precision Options) --- */
.option-card-pill {
    /* Layout */
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    
    /* Skin */
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.option-card-pill:hover {
    border-color: var(--opt-primary, #94a3b8);
    background-color: #f8fafc;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.option-card-pill.selected {
    background-color: color-mix(in srgb, var(--opt-primary) 6%, white);
    border-color: var(--opt-primary);
    box-shadow: 0 4px 15px -3px rgba(0,0,0,0.1);
}

.option-card-pill .pill-icon-circle {
    background-color: #f1f5f9;
    color: #94a3b8;
    transition: all 0.2s ease;
}

.option-card-pill.selected .pill-icon-circle {
    background-color: var(--opt-primary);
    color: white;
    transform: scale(1.1) rotate(-5deg);
}

.option-card-pill .pill-title {
    font-family: var(--font-data);
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.5px;
    color: #334155;
    transition: color 0.2s;
}

.option-card-pill.selected .pill-title {
    color: var(--opt-primary);
}

.option-card-pill .pill-desc {
    font-family: var(--font-body);
    font-weight: 500;
}

/* ================================================== */
/* ========  SECTION 18: INPUTS & CONTROLS  ========= */
/* ================================================== */

/* 18.1 General */
.form-select, .form-control { cursor: pointer; }
.hover-lift { transition: transform 0.2s, box-shadow 0.2s; will-change: transform, box-shadow; }
.hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08); }

/* --- 18.2 HERO TIMELINE WRAPPER (Replaces old Date Picker) --- */
.timeline-hero-wrapper {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 24px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
    position: relative;
}

.timeline-label-small {
    font-family: var(--font-data);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    color: #94a3b8;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.timeline-date-display {
    font-family: var(--font-brand); /* Righteous font */
    font-size: clamp(2.5rem, 5vw, 4rem);
    color: #1e293b;
    line-height: 1;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    cursor: pointer;
    transition: color 0.2s;
}

.timeline-date-display:hover {
    color: var(--active-theme-color);
}

.timeline-icon-trigger {
    font-size: 2rem;
    color: #cbd5e1;
    transition: color 0.2s;
}
.timeline-date-display:hover .timeline-icon-trigger {
    color: var(--active-theme-color);
}

/* Hidden real input, triggered by clicking the text */
.timeline-real-input {
    position: absolute;
    top: 50%; left: 50%;
    opacity: 0;
    pointer-events: none;
    width: 1px; height: 1px;
}

/* --- 18.3 MODERN QUICK CHIPS --- */
.chip-row {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    padding-top: 1.5rem;
    border-top: 2px solid #f1f5f9;
}

.date-chip-modern {
    background: white;
    border: 2px solid #e2e8f0;
    padding: 0.6rem 1.25rem;
    border-radius: 50px;
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.9rem;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
}

.date-chip-modern:hover {
    border-color: #cbd5e1;
    transform: translateY(-2px);
}

.date-chip-modern.active {
    border-color: var(--active-theme-color);
    color: var(--active-theme-color);
    background-color: white; /* Keep white bg, color border/text */
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* --- 18.4 PHYSICS INFO BOX (New Addition) --- */
.timeline-physics-box {
    background: #fff7ed; /* Light Orange/Yellow tint */
    border: 1px solid #ffedd5;
    border-radius: 16px;
    padding: 1.25rem;
    display: flex;
    gap: 1rem;
    text-align: left;
    margin-top: 1rem;
}

.physics-icon {
    color: #f97316; /* Orange */
    font-size: 1.25rem;
    margin-top: 2px;
}

.physics-content h6 {
    color: #9a3412; /* Dark Orange */
    font-family: var(--font-data);
    font-weight: 800;
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
    text-transform: uppercase; letter-spacing: 0.05em;
}

.physics-content p {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: #7c2d12;
    margin-bottom: 0;
    line-height: 1.4;
}

/* ================================================== */
/* ======  SECTION 19: ANIMATIONS (WIPE FX)  ======== */
/* ================================================== */

.wipe-text-target { display: inline-block; position: relative; white-space: nowrap; will-change: clip-path; }
.wipe-out { animation: textWipeOut 0.4s cubic-bezier(0.7, 0, 0.84, 0) forwards; }
.wipe-in { animation: textWipeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

@keyframes textWipeOut { 0% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); opacity: 1; } 100% { clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%); opacity: 0.5; } }
@keyframes textWipeIn { 0% { clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%); opacity: 0; } 100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); opacity: 1; } }
@keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ================================================== */
/* ===  SECTION 20: CLASSIC ATOM LOADER (WIZARD)  === */
/* ================================================== */

/* --- 20.1 Backgrounds & Scene --- */
.atom-wrapper {
    position: absolute; inset: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: white; overflow: hidden;
    z-index: 100;
}

.atom-rainbow-border {
    position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: linear-gradient(180deg, #ff7043, #26c6da, #ab47bc, #ffa726);
    background-size: 100% 400%;
    animation: rainbow-flow 4s ease infinite;
    z-index: 10;
}

.atom-bg-dots {
    position: absolute; inset: 0; opacity: 0.3; pointer-events: none;
    background-image: radial-gradient(#94a3b8 1.5px, transparent 1.5px);
    background-size: 20px 20px;
    animation: slide-diagonal 2s linear infinite;
}

.atom-scene {
    position: relative; width: 16rem; height: 16rem;
    display: flex; align-items: center; justify-content: center;
    perspective: 1000px; z-index: 20; margin-bottom: 2.5rem;
}

.atom-core {
    width: 100%; height: 100%; position: relative;
    display: flex; align-items: center; justify-content: center;
    transform-style: preserve-3d;
    animation: float-core 6s ease-in-out infinite;
}

/* --- 20.2 The Nucleus --- */
.atom-nucleus {
    position: relative; width: 6rem; height: 6rem;
    background: linear-gradient(135deg, #4f46e5, #9333ea, #db2777);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    z-index: 20;
    transform: translateZ(1px); /* Force layer */
}

.nucleus-ring {
    position: absolute; inset: -6px; border-radius: 50%;
    border: 1px dashed rgba(148, 163, 184, 0.6);
    animation: spin 20s linear infinite;
}

.nucleus-glow {
    position: absolute; inset: 0; background: rgba(255, 255, 255, 0.1);
    border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.nucleus-icon {
    font-size: 2.2rem; color: white; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1));
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.nucleus-icon.pop-in { transform: scale(0.5); opacity: 0; }
.nucleus-icon.visible { transform: scale(1); opacity: 1; }

/* --- 20.3 The Orbits --- */
.orbit-plane {
    position: absolute; width: 14rem; height: 14rem;
    transform-style: preserve-3d;
}

/* Three distinct angles */
.orbit-plane-1 { transform: rotateZ(0deg) rotateX(65deg); }
.orbit-plane-2 { transform: rotateZ(60deg) rotateX(65deg); }
.orbit-plane-3 { transform: rotateZ(120deg) rotateX(65deg); }

.orbit-track-wrapper {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    transform-style: preserve-3d;
    /* animation: orbit-spin [duration] linear infinite; Set inline per orbit */
}

/* SVG Styling */
.orbit-svg { width: 100%; height: 100%; overflow: visible; }
.orbit-trail { fill: none; stroke-width: 2.5; stroke-linecap: round; }
.orbit-ring-faint { fill: none; stroke-opacity: 0.15; stroke-width: 0.5; }

/* The Electron (Sphere) */
.electron-sphere {
    position: absolute; width: 1.5rem; height: 1.5rem; border-radius: 50%;
    top: 2%; left: 50%; margin-left: -0.75rem; margin-top: -0.75rem;
    box-shadow: 0 0 12px currentColor; /* Inherits text color for shadow */
    /* animation: counter-spin [duration] linear infinite; Set inline */
}

/* --- 20.4 Text & Messages --- */
.atom-text-area {
    position: relative; z-index: 20; text-align: center; padding: 0 2rem; max-width: 28rem;
}
.atom-title {
    font-family: var(--font-brand); font-size: 1.8rem; color: #1e293b;
    margin-bottom: 0.5rem; text-transform: uppercase;
}
.atom-message-box {
    height: 2rem; position: relative;
    font-family: var(--font-data); color: #94a3b8; letter-spacing: 0.15em;
    font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
}
.atom-msg {
    position: absolute; width: 100%; text-align: center;
    transition: opacity 0.3s; opacity: 0; transform: translateY(5px);
}
.atom-msg.active { opacity: 1; transform: translateY(0); }

/* --- 20.5 Keyframes --- */
@keyframes rainbow-flow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes slide-diagonal {
    0% { background-position: 0 0; }
    100% { background-position: 40px -40px; }
}
@keyframes float-core {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
@keyframes orbit-spin {
    0% { transform: rotateZ(0deg); }
    100% { transform: rotateZ(360deg); }
}
@keyframes counter-spin-normal {
    0% { transform: rotateZ(0deg) rotateX(-65deg); }
    100% { transform: rotateZ(-360deg) rotateX(-65deg); }
}
@keyframes counter-spin-reverse {
    0% { transform: rotateZ(0deg) rotateX(-65deg); }
    100% { transform: rotateZ(360deg) rotateX(-65deg); }
}

üîµ system_cards.js:
// static/js/system_cards.js
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Unified State Management ---
let sysState = {
    config: {},             // Loaded from window.SYSTEM_NODES_CONFIG
    nodeKeys: [],           // Array of node types (['HORIZON', 'OPERATOR', ...])
    currentIndex: 0,        // Current slide index
    ssolId: null,           // Context SSOL ID
    
    // Entity Store for the OPERATOR stack (client-side cache)
    entityStore: { 
        'OPERATOR': [] 
    },

    // Transient Editing State (The "Buffer")
    editingId: null,        // DB ID of the node being edited (or '' for new)
    tempValue: null,        // Current value in the input field
    isSpeculating: false,   // Loading state flag
    constraintMode: 'HARD'  // HARD vs SOFT constraint
};

/**
 * Initializes the System Card Controller.
 * Called from outcome.html once the DOM is ready.
 */
export function initSystemCards(ssolId) {
    sysState.ssolId = ssolId;
    
    // 1. Load Configuration (Injected in base.html)
    if(window.SYSTEM_NODES_CONFIG) {
        sysState.config = window.SYSTEM_NODES_CONFIG;
        sysState.nodeKeys = Object.keys(sysState.config);
    }

    // 2. Bind Global Functions for HTML OnClick Attributes
    window.openSystemEditor = openSystemEditor;
    window.navigateSystemNode = navigateSystemNode;
    window.setProtocolMode = setProtocolMode;
    window.setConstraintMode = setConstraintMode;
    window.submitSystemForm = submitSystemForm;
    window.addEntity = addEntity;
}

/**
 * Opens the Modal and jumps to specific node type.
 * @param {string} existingId - The specific DB ID (or 'new')
 * @param {string} type - The System Node Type (e.g., 'BUDGET', 'OPERATOR')
 * @param {string} currentValue - The current value to pre-fill
 */
function openSystemEditor(existingId, type, currentValue) {
    // 1. Set Carousel Index
    if (type && sysState.nodeKeys.includes(type)) {
        sysState.currentIndex = sysState.nodeKeys.indexOf(type);
    } else {
        sysState.currentIndex = 0; 
    }

    // 2. Hydrate State
    sysState.editingId = existingId === 'new' ? '' : existingId;
    // Handle 'None' string from Jinja template if field is empty
    sysState.tempValue = (currentValue && currentValue !== 'None') ? currentValue : '';
    sysState.constraintMode = 'HARD'; // Reset to default

    updateModalView();
    
    // 3. Launch Bootstrap Modal
    const modalEl = document.getElementById('systemConfigModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

/**
 * Handles Carousel Navigation (Prev/Next)
 */
function navigateSystemNode(direction) {
    // 1. Update Index
    sysState.currentIndex += direction;
    
    // Loop navigation
    if (sysState.currentIndex < 0) sysState.currentIndex = sysState.nodeKeys.length - 1;
    if (sysState.currentIndex >= sysState.nodeKeys.length) sysState.currentIndex = 0;
    
    // 2. Reset Transient State for the new card
    sysState.editingId = ""; 
    sysState.tempValue = ""; 
    // In a real app, you might want to fetch the existing value for this next node here
    // For now, we start fresh or relying on what passed in via click (limit of this carousel implementation)

    updateModalView();
}

/**
 * CORE RENDER LOGIC
 * Updates the Left (Visual) and Right (Input) panels based on the State.
 */
function updateModalView() {
    const typeKey = sysState.nodeKeys[sysState.currentIndex];
    const config = sysState.config[typeKey] || {};
    
    // --- 1. Identity Panel (Left) ---
    const identityPanel = document.getElementById('sys-identity-panel');
    identityPanel.style.backgroundColor = config.color;
    
    document.getElementById('sys-display-icon').className = `fas ${config.icon} fa-2x text-white`;
    document.getElementById('sys-display-label').textContent = config.label;
    
    // VISUALIZER: Render the correct state view (Gauge, Stack, or Text)
    renderVisualizer(typeKey, sysState.tempValue, config.color);

    // --- 2. Calibration Console (Right) ---
    // Ontology & Guide
    document.getElementById('sys-display-desc').textContent = config.description;
    document.getElementById('sys-display-guide').textContent = config.guide;

    // Examples Container (New Feature)
    const exContainer = document.getElementById('sys-examples-container');
    exContainer.innerHTML = "";
    if(config.examples && Array.isArray(config.examples)) {
        config.examples.forEach(ex => {
            const badge = document.createElement('span');
            badge.className = "badge bg-white border text-secondary fw-normal cursor-pointer hover-shadow";
            badge.textContent = ex;
            badge.onclick = () => {
                // Click to fill
                sysState.tempValue = ex;
                renderBespokeInput(typeKey, sysState.tempValue, config.color, config);
                renderVisualizer(typeKey, sysState.tempValue, config.color);
            };
            exContainer.appendChild(badge);
        });
    }

    // Hidden Form Inputs
    document.getElementById('sys-param-type').value = typeKey;
    document.getElementById('sys-param-id').value = sysState.editingId;

    // Render Input Fields
    renderBespokeInput(typeKey, sysState.tempValue, config.color, config);
    
    // Update Badge Status
    const statusBadge = document.getElementById('sys-status-badge');
    if(sysState.tempValue) {
        statusBadge.className = "badge bg-success-subtle text-success border border-success-subtle font-data rounded-pill px-3";
        statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i> CALIBRATED';
    } else {
        statusBadge.className = "badge bg-secondary-subtle text-secondary border border-secondary-subtle font-data rounded-pill px-3";
        statusBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size:8px;"></i> UNSET';
    }

    // Pagination Dots
    document.getElementById('sys-counter').textContent = `CARD ${sysState.currentIndex + 1} / ${sysState.nodeKeys.length}`;
    const dotContainer = document.getElementById('sys-dots-container');
    dotContainer.innerHTML = sysState.nodeKeys.map((k, i) => 
        `<div class="sys-dot ${i === sysState.currentIndex ? 'active' : ''}" style="opacity: ${i === sysState.currentIndex ? '1' : '0.3'}"></div>`
    ).join('');
}

/**
 * Renders the Left Column State Monitor (Visual Feedback)
 */
function renderVisualizer(type, value, color) {
    const container = document.getElementById('sys-visualizer-container');
    container.innerHTML = ''; 

    // CASE: OPERATOR (Stack of Identity Cards)
    if (type === 'OPERATOR') {
        const entities = sysState.entityStore['OPERATOR'];
        
        if ((!entities || entities.length === 0) && !value) {
             container.innerHTML = `
                <div class="bg-white bg-opacity-10 border-2 border-dashed border-white border-opacity-25 rounded-xl p-5 text-center text-white-50">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="small font-bold">NO CHAMPIONS ASSIGNED</div>
                </div>`;
        } else {
            // Visualize entities OR the text value
            const displayEntities = (entities && entities.length > 0) 
                ? entities 
                : [{name: value, role: 'Primary Contact', org: 'Entity'}];
            
            displayEntities.forEach(ent => {
                container.innerHTML += `
                <div class="sys-entity-card">
                     <div class="sys-entity-avatar" style="color:${color}; background: #fff;">${ent.name ? ent.name[0] : '?'}</div>
                     <div style="flex-grow:1; overflow:hidden;">
                        <div class="font-bold text-dark text-truncate" style="font-size:0.85rem;">${ent.name || 'Unknown'}</div>
                        <div class="font-data text-muted x-small text-truncate">${ent.role} ‚Ä¢ ${ent.org}</div>
                     </div>
                     <div class="badge bg-light text-muted border"><i class="fas fa-box"></i></div>
                </div>`;
            });
        }
        return;
    }

    // CASE: HORIZON (Velocity Gauge)
    if (type === 'HORIZON') {
        container.innerHTML = `
             <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-2xl p-4 backdrop-blur-sm text-center">
                 <div class="font-data text-white-50 x-small uppercase tracking-widest mb-2">TIMELINE VELOCITY</div>
                 <div class="display-4 font-brand text-white mb-0">${value ? value.split('-')[0] : '--'}</div>
                 <div class="font-data text-white-50 x-small uppercase tracking-wide mb-3">TARGET HORIZON</div>
                 <div class="progress" style="height: 4px; background-color: rgba(255,255,255,0.2);">
                    <div class="progress-bar bg-white" style="width: ${value ? '65%' : '0%'}"></div>
                 </div>
             </div>`;
        return;
    }

    // DEFAULT: Big Typographic Display (The "Active Pill")
    if (value && value.trim() !== "") {
        container.innerHTML = `
            <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-pill p-3 pe-5 d-flex align-items-center backdrop-blur transition-all">
                <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center shadow-sm me-3" 
                     style="width: 42px; height: 42px; flex-shrink: 0;">
                    <!-- Use icon from current config in state -->
                    <i class="fas ${sysState.config[type].icon} fa-lg" style="color: ${color}"></i>
                </div>
                <div>
                    <div class="font-data text-white-50 x-small uppercase tracking-wide mb-0">ANCHOR VALUE</div>
                    <div class="font-body text-white fw-bold fs-5 leading-tight text-truncate" style="max-width: 220px;">
                        ${value}
                    </div>
                </div>
            </div>`;
    } else {
        container.innerHTML = `
             <div class="border border-dashed border-white border-opacity-25 rounded-pill p-4 text-center text-white-50 font-data small">
                <i class="fas fa-terminal me-2"></i> AWAITING INPUT
             </div>
        `;
    }
}

/**
 * Renders the Right Column Input Area and attaches Live Listeners
 */
function renderBespokeInput(type, value, color, config) {
    const container = document.getElementById('sys-input-container');
    container.innerHTML = '';

    // 1. OPERATOR (Contact Form)
    if (type === 'OPERATOR') {
        container.innerHTML = `
            <div class="bg-light rounded-3 p-3 border border-light-subtle">
                <div class="d-flex align-items-center gap-2 mb-3 text-muted border-bottom pb-2">
                    <i class="fas fa-user-plus small"></i>
                    <span class="font-data x-small fw-bold tracking-widest">ADD CHAMPION</span>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" id="ent-name" class="form-control form-control-sm" placeholder="Entity Name" value="${value}">
                    </div>
                    <div class="col-6"><input type="text" id="ent-role" class="form-control form-control-sm" placeholder="Role / Title"></div>
                    <div class="col-6"><input type="text" id="ent-org" class="form-control form-control-sm" placeholder="Organization"></div>
                </div>
                <button type="button" class="btn btn-dark w-100 btn-sm mt-3 font-data" onclick="addEntity()">
                    <i class="fas fa-plus-circle me-1"></i> ADD TO STACK
                </button>
                <input type="hidden" name="value" id="real-value-input" value="${value}">
            </div>
        `;
        
        // Attach listener for single-value simple entry
        document.getElementById('ent-name').oninput = (e) => {
            sysState.tempValue = e.target.value;
            document.getElementById('real-value-input').value = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
        return;
    }

    // 2. SELECT DROPDOWN
    if (config.options && Array.isArray(config.options)) {
        const opts = config.options.map(opt => 
            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
        ).join('');
        
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">SELECT CONFIGURATION</label>
                <select name="value" id="sys-param-value" class="form-select form-select-lg font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none bg-transparent">
                    <option value="" disabled ${!value ? 'selected' : ''}>Choose...</option>
                    ${opts}
                </select>
            </div>
        `;
    } 
    // 3. HORIZON (Date)
    else if (type === 'HORIZON') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">TARGET DATE</label>
                <input type="date" name="value" id="sys-param-value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                       value="${value}" style="background:transparent;">
            </div>
        `;
    } 
    // 4. DEFAULT (Text)
    else {
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">ANCHOR VALUE</label>
                <input type="text" name="value" id="sys-param-value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                       value="${value}" placeholder="Define value..." autocomplete="off" style="background:transparent;">
            </div>
        `;
    }

    // Bind Live Update Listener
    const mainInput = document.getElementById('sys-param-value');
    if(mainInput) {
        mainInput.oninput = (e) => {
            sysState.tempValue = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
        // For Select, onchange is better
        mainInput.onchange = (e) => {
            sysState.tempValue = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
    }
}

// --- Interaction Handlers ---

function setProtocolMode(mode) {
    // UI Toggle
    document.querySelectorAll('.sys-protocol-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`mode-${mode.toLowerCase()}`).classList.add('active');
    
    const container = document.getElementById('sys-input-container');
    const type = document.getElementById('sys-param-type').value;

    if (mode === 'SPECULATE') {
        sysState.isSpeculating = true;
        container.innerHTML = `
            <div class="bg-light border border-primary-subtle rounded-3 p-5 text-center animate-in fade-in">
                <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="font-body small text-muted">Connecting to SSPEC Engine...</p>
                <div class="font-data x-small text-muted tracking-widest mt-2">OPTIMIZING ${type}</div>
            </div>
        `;
        
        // Mock Simulation (In real app: fetch /speculate_system_node)
        setTimeout(() => {
            let suggestion = "AI Optimized Value";
            if(type === 'HORIZON') suggestion = "2026-11-15"; 
            if(type === 'OPERATOR') suggestion = "Strategic Consortium";
            if(type === 'BUDGET') suggestion = "Grant Funded";
            
            // Switch back to Specify
            sysState.isSpeculating = false;
            setProtocolMode('SPECIFY');
            
            // Update State
            sysState.tempValue = suggestion;
            
            // Re-render inputs and visualizer
            const typeKey = sysState.nodeKeys[sysState.currentIndex];
            const config = sysState.config[typeKey];
            
            setTimeout(() => {
                renderBespokeInput(typeKey, suggestion, config.color, config);
                renderVisualizer(typeKey, suggestion, config.color);
                
                // For Operator, sync specific fields
                if(type === 'OPERATOR') {
                    const entInput = document.getElementById('ent-name');
                    const realInput = document.getElementById('real-value-input');
                    if(entInput) entInput.value = suggestion;
                    if(realInput) realInput.value = suggestion;
                }
            }, 50);
        }, 1200);
    } else {
        // Cancel Speculation / Return to form
        if(!sysState.isSpeculating) {
            updateModalView();
        }
    }
}

function setConstraintMode(mode) {
    sysState.constraintMode = mode;
    
    document.querySelector('.selected-mode-card').classList.remove('selected-mode-card');
    
    document.getElementById('constraint-hard').classList.add('opacity-50');
    document.getElementById('constraint-soft').classList.add('opacity-50');
    
    const target = document.getElementById(`constraint-${mode.toLowerCase()}`);
    target.classList.remove('opacity-50');
    target.classList.add('selected-mode-card');
    
    document.getElementById('sys-constraint-input').value = mode;
}

function addEntity() {
    const name = document.getElementById('ent-name').value;
    const role = document.getElementById('ent-role').value || 'Lead';
    const org = document.getElementById('ent-org').value || 'External';
    
    if(name) {
        // Update Store
        if(!sysState.entityStore['OPERATOR']) sysState.entityStore['OPERATOR'] = [];
        sysState.entityStore['OPERATOR'].push({name, role, org, id: Date.now()});
        
        // Update State
        sysState.tempValue = sysState.entityStore['OPERATOR'].map(e => e.name).join(', ');
        
        // Update Visualizer
        const config = sysState.config['OPERATOR'];
        renderVisualizer('OPERATOR', sysState.tempValue, config.color);
        
        // Update Hidden Input
        const realInput = document.getElementById('real-value-input');
        if(realInput) realInput.value = sysState.tempValue;

        // Clear Form
        document.getElementById('ent-name').value = '';
        document.getElementById('ent-role').value = '';
        document.getElementById('ent-org').value = '';
    }
}

function submitSystemForm() {
    const form = document.getElementById('system-node-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    data.ssol_id = sysState.ssolId;
    data.key = data.sys_type;

    // UI Feedback
    const btn = document.querySelector('button[onclick="submitSystemForm()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i> SAVING...';
    btn.disabled = true;

    fetch('/update_ssol_system_node', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        if (response.success) {
            const modalEl = document.getElementById('systemConfigModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // Reload to reflect changes on main dashboard
            location.reload(); 
        } else {
            alert("Error saving: " + (response.error || "Unknown error"));
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Network Error");
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

üü™ cos_table.js:
// cos_table.js
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions ---

function getBadgeColorVar(status) {
    switch (status) {
        case 'Proposed': return '#17a2b8'; // Info cyan
        case 'Active': return 'var(--warning)';
        case 'In Progress': return 'var(--warning)';
        case 'Completed': return 'var(--success)';
        case 'Verified': return 'var(--success)';
        case 'Rejected': return 'var(--danger)';
        default: return '#94a3b8'; // Muted gray
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State ---

function storeOriginalValues(cosRow) {
    const statusBlock = cosRow.querySelector('.status-cell .status-block');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountableDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');

    cosRow.dataset.originalValues = JSON.stringify({
        status: statusBlock ? statusBlock.textContent.trim() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountable: accountableDisplay ? accountableDisplay.textContent.trim() : '',
        date: dateDisplay ? dateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);

    // Revert Status
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(original.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${original.status}</span>`;
    }

    // Revert Content
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;

    // Revert Meta
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = original.accountable;
    
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = original.date;

    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    // 1. Update Status Block
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(cosData.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${cosData.status.toUpperCase()}</span>`;
    }

    // 2. Update Content (with potential new Pills)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;

    // 3. Update Fields
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = cosData.accountable_party || 'N/A';

    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = cosData.completion_date || 'TBD';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();

    // Toggle visibility classes
    // Using Bootstrap .d-none utilities
    const elements = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];

    elements.forEach(pair => {
        const disp = cosRow.querySelector(pair.display);
        const edit = cosRow.querySelector(pair.edit);
        if (disp) disp.classList.toggle('d-none', editing);
        if (edit) edit.classList.toggle('d-none', !editing);
    });

    // Toggle Status Dropdown
    const statusCell = cosRow.querySelector('.status-cell');
    const currentBlock = statusCell.querySelector('.status-block');
    
    if (editing) {
        if (currentBlock) {
            const currentVal = currentBlock.textContent.trim();
            currentBlock.classList.add('d-none');
            if(!statusCell.querySelector('select')) {
                statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentVal));
            }
        }
    } else {
        const select = statusCell.querySelector('select');
        if (select) select.remove();
        if (currentBlock) currentBlock.classList.remove('d-none');
    }

    // Toggle Action Buttons
    const viewBtns = cosRow.querySelector('.actions-cell .btn-group:not(.d-none)');
    const editBtns = cosRow.querySelector('.actions-cell .btn-group.d-none');
    
    // This logic handles the swapping of button groups defined in outcome.html
    const actionsCell = cosRow.querySelector('.actions-cell');
    const groups = actionsCell.querySelectorAll('.btn-group');
    
    if (groups.length >= 2) {
        // Group 0 is View actions, Group 1 is Edit actions
        groups[0].classList.toggle('d-none', editing);
        groups[1].classList.toggle('d-none', !editing);
    }
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'Active', 'Completed', 'Verified', 'Rejected'];
    const options = statuses.map(s => 
        `<option value="${s}" ${s.toUpperCase() === selectedStatus.toUpperCase() ? 'selected' : ''}>${s.toUpperCase()}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select shadow-none border-secondary">${options}</select>`;
}

// --- EVENT HANDLERS ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;

    // 1. CE Pill Click (Launch Modal)
    const pill = target.closest('.ce-pill, .ce-capsule');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    // 2. Action Buttons
    const button = target.closest('button');
    if (!button) return;

    const cosRow = button.closest('.cos-row');
    if (!cosRow) return;

    event.preventDefault();
    const cosId = cosRow.dataset.cosId;

    if (button.classList.contains('edit-cos-button')) {
        handleEditCOS(cosRow);
    } else if (button.classList.contains('update-cos-button')) {
        handleUpdateCOS(cosRow, cosId);
    } else if (button.classList.contains('cancel-cos-button')) {
        revertToOriginalValues(cosRow);
    } else if (button.classList.contains('delete-cos-button')) {
        handleDeleteCOS(cosRow, cosId);
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);

    // Pre-populate textarea (strip existing HTML/Pills for editing)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const textarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && textarea) {
        textarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    // Gather Data
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountable = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim();
    const newDate = cosRow.querySelector('.cos-completion-date-edit')?.value;

    // UI Feedback
    const btn = cosRow.querySelector('.update-cos-button');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            content: newContent, 
            status: newStatus, 
            accountable_party: newAccountable, 
            completion_date: newDate 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error('Failed to return COS data');
        }
    })
    .catch(err => alert(err.message))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = origHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (!confirm('Are you sure? This will delete the Condition and all its internal logic nodes.')) return;

    fetch(`/delete_cos/${cosId}`, { method: 'DELETE' })
    .then(handleApiResponse)
    .then(() => cosRow.remove())
    .catch(err => alert(err.message));
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    
    // 1. Locate Context
    const container = button.closest('.phase-table-container');
    if (!container) return console.error("Phase container not found.");
    
    const ssolId = container.dataset.ssolId;
    if (!ssolId) return alert("System Error: SSOL Context Missing.");

    // 2. Visual Feedback (Loading State)
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-circle-notch fa-spin me-2"></i> INITIALIZING...`;

    // 3. Construct Payload
    const payload = {
        // Default placeholder text inviting definition
        content: "New Condition of Satisfaction - Click edit to define parameters.",
        status: "Proposed",
        ssol_id: ssolId
    };

    // 4. Network Request
    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse) // Expects standard helper
    .then(data => {
        if (data.success && data.cos) {
            // 5. Inject into DOM
            const table = container.querySelector('table.retro-table');
            const newRowHtml = createRowHTML(data.cos); // Generate Row HTML

            if (table) {
                // SCENARIO A: Table exists, append row
                const tbody = table.querySelector('tbody');
                tbody.insertAdjacentHTML('beforeend', newRowHtml);
            } else {
                // SCENARIO B: Empty State (No table yet)
                // We must remove the "No protocols" placeholder and build the table skeleton
                const emptyState = container.querySelector('.text-center.text-muted');
                if(emptyState) emptyState.remove();

                // The wrapper for the table needs to go BEFORE the button footer
                // Note: outcome.html structure puts button in a div.p-3 at bottom of container
                const tableSkeleton = `
                    <table class="table table-hover mb-0 align-middle retro-table">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 110px;">Status</th>
                                <th>Condition of Satisfaction</th>
                                <th style="width: 18%;">Accountable</th>
                                <th style="width: 12%;">Target</th>
                                <th class="text-end pe-4" style="width: 100px;">Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${newRowHtml}
                        </tbody>
                    </table>
                `;
                
                // Insert as first element in the body (pushing the footer down)
                container.insertAdjacentHTML('afterbegin', tableSkeleton);
            }
        }
    })
    .catch(err => {
        console.error("COS Creation Failed:", err);
        alert("Failed to initialize new Condition. Check console.");
    })
    .finally(() => {
        // 6. Restore Button State
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}


// --- HTML Generator for New Rows (Matches outcome.html structure) ---
function createRowHTML(cos) {
    return `
    <tr class="cos-row" data-cos-id="${cos.id}" data-editing="false">
        <td class="status-cell">
            <span class="status-block" style="background-color: #17a2b8;">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell">
            <div class="cos-content-display">${cos.content}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm">${stripHtmlForTextarea(cos.content)}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell">
            <span class="cos-accountable-party-display">N/A</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none">
        </td>
        <td class="cos-completion-date-cell font-data">
            <span class="cos-completion-date-display">TBD</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none">
        </td>
        <td class="text-end actions-cell">
            <div class="btn-group cos-actions">
                <button class="btn btn-sm btn-link text-muted edit-cos-button"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-cos-button"><i class="fas fa-trash"></i></button>
            </div>
            <div class="btn-group cos-actions d-none">
                <button class="btn btn-sm btn-success update-cos-button"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button"><i class="fas fa-times"></i></button>
            </div>
        </td>
    </tr>`;
}

// --- MAIN: Launch the CE Modal Application ---

export function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    
    // Safe access to NODES using window object (injected in base.html)
    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cube';
    
    showLoadingSpinner(`INITIALIZING ${ceType.toUpperCase()} NODE...`, iconClass);

    // Scrape context for the modal initialization
    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.getElementById('ssol-goal')?.textContent.trim() || "Goal";
    const cosContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || '';
    
    const accItem = cosRow?.closest('.accordion-item');
    const phaseText = accItem?.querySelector('.phase-title')?.textContent.trim() || "Unknown";
    
    // Calculate phase index based on DOM order
    const allItems = Array.from(document.querySelectorAll('.accordion-item'));
    const phaseIndex = accItem ? allItems.indexOf(accItem) : 0;

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            ce_id: ceId, 
            cos_content: cosContent, 
            phase_name: phaseText,
            phase_index: phaseIndex,
            ssol_goal: ssolGoal 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if(data.modal_html) {
            // Launch the full application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        }
    })
    .catch(err => {
        console.error(err);
        alert("System Error: Could not load node application.");
    })
    .finally(() => hideLoadingSpinner());
}

// --- GLOBAL LISTENERS ---

document.addEventListener('DOMContentLoaded', () => {
    // Table Actions (Delegated)
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    // Add COS Buttons
    document.querySelectorAll('.add-cos').forEach(btn => {
        btn.addEventListener('click', handleAddCOSButtonClick);
    });

    // PDF Export
    const pdfBtn = document.getElementById('save-as-pdf-button');
    if(pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
            // e.target.dataset.ssolId might need bubbling check if icon clicked
            const id = e.currentTarget.dataset.ssolId;
            // Call PDF function (omitted for brevity, assume similar to existing)
            alert("Generating PDF report...");
        });
    }
});

‚¨ú speculate.py:
# speculate.py
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from difflib import get_close_matches  # <--- CRITICAL IMPORT ADDED HERE

# Local Imports
from ce_nodes import NODES, get_valid_node_types
from ai_service import generate_chat_response_with_node_types
from datetime import date, datetime, timedelta

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def normalize_ce_type(raw_type: str) -> str:
    """
    Uses fuzzy matching to correct common AI hallucinations.
    Example: 'Risk Analysis' -> 'Risk', 'Stakeholder Map' -> 'Stakeholder'
    """
    if not raw_type: return 'Default'
    
    # 1. Exact Match (Case Insensitive)
    valid_types = list(NODES.keys())
    key_map = {k.lower(): k for k in valid_types}
    if raw_type.lower() in key_map:
        return key_map[raw_type.lower()]
    
    # 2. Fuzzy Match
    matches = get_close_matches(raw_type, valid_types, n=1, cutoff=0.5)
    if matches:
        # Use a safe logger if outside app context, otherwise current_app
        if current_app:
            current_app.logger.info(f"Normalized Node Type: '{raw_type}' -> '{matches[0]}'")
        return matches[0]
        
    # 3. Fallback
    if current_app:
        current_app.logger.warning(f"Unknown Node Type '{raw_type}' defaulted.")
    return 'Default'

def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """
    Generates the Horizon-Style CE Capsule HTML.
    Handles case-insensitive lookup and fallbacks via normalization.
    """
    # Normalize the type first
    real_key = normalize_ce_type(ce_type)
    
    node_info = NODES.get(real_key, NODES['Default'])
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-cube')
    
    # Fallback Color Generator (for hallucinations that couldn't be normalized but still exist)
    if real_key == 'Default' and ce_type.lower() != 'default':
        hash_val = sum(ord(c) for c in ce_type)
        colors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#ff5722']
        node_color = colors[hash_val % len(colors)]
        node_icon = 'fa-solid fa-tag'
    
    return (
        f'<span class="ce-capsule" data-ce-id="{ce_id}" data-ce-type="{real_key}" '
        f'title="{real_key} Node" style="--node-color: {node_color};">'
        f'<i class="{node_icon}"></i>{html.escape(ce_text)}'
        f'</span>'
    )

# --- AI Analysis ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content to identify CEs. Returns structured JSON for creation/updating.
    """
    node_types_str = ', '.join(get_valid_node_types())
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify ALL distinct Conditional Elements (CEs) within this text. "
        f"Valid NodeTypes: {node_types_str}. "
        "Return JSON with keys 'analyzed_cos_text' (original text with <ce type='Type'>Title</ce> tags) "
        "and 'identified_ces' (array of {text, type})."
    )
    messages = [{"role": "user", "content": prompt}]
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS')
        # Parse logic
        match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", response_text, re.DOTALL)
        clean_text = match.group(1).strip() if match else response_text.strip()
        
        response_json = json.loads(clean_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}", exc_info=True)
        # Fallback: return original text, no CEs detected
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

# --- SSOL Operations ---

def create_ssol(USE_DATABASE: bool, title: str, description: str, domain: str = None, system_data: dict = None) -> str:
    """
    Creates the SSOL Container.
    Now supports atomic injection of System Physics (system_data) at creation time.
    """
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    # MVP Rule: Set a default "Horizon" of 1 year from creation if not specified
    default_target_date = date.today() + timedelta(days=365)
    
    # Clean system_data default
    if system_data is None:
        system_data = {}

    # Extract Horizon Date from system_data if present for the SQL column
    target_date_obj = default_target_date
    if 'HORIZON' in system_data:
        try:
            # Try to parse the physics string into a real date object
            target_date_obj = datetime.strptime(system_data['HORIZON'], '%Y-%m-%d').date()
        except:
            # Keep default if parsing fails (e.g. "3 Months" string)
            pass

    # Extract Owner from system_data for the SQL column
    owner_str = system_data.get('OPERATOR', None)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            
            ssol = SSOL(
                id=new_ssol_uuid, 
                title=title, 
                description=description,
                domain=domain,
                status='Active', 
                target_date=target_date_obj,
                owner=owner_str,
                integrity_score=100,
                completion_percentage=0,
                system_data=system_data # <--- SAVED AT BIRTH
            )
            
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {
            'id': ssol_id, 
            'title': title, 
            'description': description, 
            'domain': domain,
            'status': 'Active',
            'target_date': target_date_obj.isoformat(),
            'owner': owner_str,
            'integrity_score': 100,
            'completion_percentage': 0,
            'system_data': system_data, # <--- SAVED IN MEMORY
            'phases': {}
        }
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    return ssol_store.get(str(ssol_id))

# --- COS Operations ---

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> dict:
    from models import COS, CE, get_engine_and_session
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    if isinstance(content, dict):
        content = content.get('text') or content.get('content') or json.dumps(content)
    elif not isinstance(content, str):
        content = str(content)

    try:
        # 1. Parse & Pill Logic
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        new_ce_instances = []
        
        for tag in ce_tags:
            ce_text = tag.string
            raw_type = tag.get('type', 'Default')
            if not ce_text: continue

            # NORMALIZE TYPE HERE
            real_type = normalize_ce_type(raw_type)

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': real_type, # Use Normalized Type
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "prerequisites": [], "stakeholders": [], "assumptions": [], "resources": [], "connections": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace with Horizon HTML
            pill_html = _render_ce_pill_html(str(new_ce_uuid), real_type, ce_text)
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        content_with_pills = str(soup)

        # 2. Persist & Return Data
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos_instance = COS(
                    id=new_cos_uuid, 
                    content=content_with_pills, 
                    status=status, 
                    ssol_id=ssol_id,
                    accountable_party=accountable_party, 
                    completion_date=completion_date
                )
                session.add(cos_instance)
                
                for ce_rec in new_ce_instances:
                    ce_instance = CE(
                        id=ce_rec['id'], 
                        node_type=ce_rec['node_type'], 
                        cos_id=new_cos_uuid, 
                        data=ce_rec['data']
                    )
                    session.add(ce_instance)
                
                session.commit()
                final_data = cos_instance.to_dict()
                session.close()
                return final_data
        else:
            result = {
                'id': cos_id_str, 
                'content': content_with_pills, 
                'status': status, 
                'ssol_id': str(ssol_id),
                'accountable_party': accountable_party,
                'completion_date': completion_date
            }
            cos_store[cos_id_str] = result
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
            return result

    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        raise
    
async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from app import app

    new_content = updated_data.get('content')
    
    try:
        new_ce_instances = []
        
        if new_content is not None:
            if isinstance(new_content, dict): new_content = json.dumps(new_content)
            elif not isinstance(new_content, str): new_content = str(new_content)
                    
            analysis = await analyze_cos(new_content, str(cos_id))
            soup = BeautifulSoup(analysis['content_with_tags'], 'html.parser')
            ce_tags = soup.find_all('ce')
            
            for tag in ce_tags:
                c_txt = tag.string
                raw_type = tag.get('type', 'Default')
                real_type = normalize_ce_type(raw_type) # Normalize

                new_id = uuid.uuid4()
                new_ce_instances.append({
                    'id': new_id, 'node_type': real_type, 
                    'data': {"details_data": {}, "resources": [], "prerequisites": [], "stakeholders": [], "assumptions": [], "connections": []}
                })
                pill = _render_ce_pill_html(str(new_id), real_type, c_txt)
                tag.replace_with(BeautifulSoup(pill, 'html.parser'))
            
            updated_data['content'] = str(soup)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id)
                if not cos: 
                    session.close()
                    return {'success': False, 'message': 'COS not found', 'status_code': 404}
                
                for k, v in updated_data.items():
                    if hasattr(cos, k) and k not in ['id', 'ssol_id']: 
                        setattr(cos, k, v)
                
                if new_content is not None:
                    session.query(CE).filter_by(cos_id=cos_id).delete()
                    for nc in new_ce_instances:
                        session.add(CE(id=nc['id'], node_type=nc['node_type'], cos_id=cos_id, data=nc['data']))
                
                session.commit()
                cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': cos_dict, 'status_code': 200}
        
        return {'success': False, 'message': 'DB Required', 'status_code': 500}

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return {'success': False, 'message': str(e), 'status_code': 500}


def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            res = cos.to_dict() if cos else None
            session.close()
            return res
    return cos_store.get(str(cos_id))

def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(cos_id=cos_id).delete()
            cos = session.query(COS).get(cos_id)
            if cos:
                session.delete(cos)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

# --- CE Operations ---

def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id_param if isinstance(ce_id_param, UUID) else UUID(str(ce_id_param))
    
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            result = ce.to_dict() if ce else None
            session.close()
            return result
    return ce_store.get(str(ce_id_uuid))

def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id)
            if ce:
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from app import app
    new_id = uuid.uuid4()
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.add(CE(id=new_id, node_type=node_type, cos_id=cos_id, data=data))
            session.commit()
            session.close()
    return str(new_id)

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(id=ce_id).delete()
            session.commit()
            session.close()
            return True
    return False

üè™ store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

üîµ ce_cards.js:
// static/js/ce_cards.js
// SSPEC "Horizon Fusion" - Condition Element Application Controller (v2025.40)

import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// =============================================================================
// 1. CENTRAL STATE MANAGEMENT
// =============================================================================

const DEFAULT_STATE = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    details_data: {},
    nodeSchema: {},
    isSaving: false,
    isScanning: false
};

let state = { ...DEFAULT_STATE };

// =============================================================================
// 2. PERSONA MATRIX & CONFIG
// =============================================================================

const PERSONAS = {
    "Research": { title: "DEEP TRUTH ENGINE", icon: "fa-flask", class: "persona-research", tone: "Empirical" },
    "Risk": { title: "SECURITY OVERWATCH", icon: "fa-shield-virus", class: "persona-risk", tone: "Critical" },
    "Stakeholder": { title: "NETWORK DIPLOMAT", icon: "fa-handshake", class: "persona-stakeholder", tone: "Strategic" },
    "Advocacy": { title: "AMPLIFIER", icon: "fa-bullhorn", class: "persona-advocacy", tone: "Persuasive" },
    "Environment": { title: "SYSTEM ECOLOGIST", icon: "fa-leaf", class: "persona-research", tone: "Holistic" },
    "Timeline": { title: "TEMPORAL ARCHITECT", icon: "fa-stopwatch", class: "persona-default", tone: "Linear" },
    "Default": { title: "SPECULATE CO-PILOT", icon: "fa-brain", class: "persona-default", tone: "Helpful" }
};

// =============================================================================
// 3. INITIALIZATION & LIFECYCLE
// =============================================================================

export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    if (!modalContainer) return console.error("Critical: Modal container missing.");
    
    modalContainer.innerHTML = modalHtml;
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    if (!modalElement) return console.error("Critical: Modal DOM insertion failed.");

    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        // 1. Resolve Schema
        const nodeConfig = (window.NODES && window.NODES[p_ceType]) ? window.NODES[p_ceType] : (window.NODES['Default']);

        // 2. Hydrate State (Resetting cleanly)
        const d = ceData?.data || {};
        state = {
            modalElement, 
            ceId, 
            ceType: p_ceType, 
            activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
            nodeSchema: nodeConfig,
            isSaving: false,
            isScanning: false
        };
        
        // 3. Boot System
        render(); 
        setupEventListeners();
        
        // 4. "One-Hit Production" Check
        // If the node is empty, wake up the engine.
        checkAndTriggerAutoPopulation();

    }, { once: true });

    modalElement.addEventListener('hidden.bs.modal', () => {
        state = { ...DEFAULT_STATE }; // GC helper
        modalElement.remove();
    });

    modal.show();
}

// =============================================================================
// 4. AUTOMATION LOGIC ("ONE-HIT PRODUCTION")
// =============================================================================

function checkAndTriggerAutoPopulation() {
    // Logic: If critical collections are empty, we assume it's a fresh node.
    const isFresh = ['prerequisites', 'stakeholders', 'assumptions'].every(k => state.collections[k].length === 0);
    
    // Also check if summary is empty
    const hasSummary = state.details_data.summary && state.details_data.summary.length > 5;

    if (isFresh && !hasSummary) {
        console.log("System Scan Initiated: Fresh Node Detected");
        state.isScanning = true;
        updateDashboard(); // Updates the visual "Scanning" state

        // Staggered Execution (Waterfall Effect)
        // 1. Narrative (Immediate)
        triggerEnhancement('summary', null, true); 
        
        // 2. Collections (Staggered 1.5s intervals)
        setTimeout(() => triggerSpeculation('prerequisites', null, true), 1200);
        setTimeout(() => triggerSpeculation('stakeholders', null, true), 2800);
        setTimeout(() => triggerSpeculation('assumptions', null, true), 4200);
        
        // End Scan visual state after last item
        setTimeout(() => {
            state.isScanning = false;
            updateDashboard();
        }, 5000);
    }
}

// =============================================================================
// 5. RENDER PIPELINE
// =============================================================================

function render() {
    if (!state.modalElement) return;
    
    // Batch rendering
    renderAllCollections();
    renderOverviewStream();
    renderSidebarPersona();
    renderAiSidebarContent();
    updateDashboard();
}

function renderAllCollections() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(type => {
        renderCollectionList(type);
    });
}

function renderOverviewStream() {
    const container = state.modalElement.querySelector('#overview-logic-stream');
    if(!container) return;

    let signals = [];
    
    // Extract Critical Signals (Top items)
    (state.collections.prerequisites || []).slice(0, 3).forEach(i => 
        signals.push({ type: 'PREREQ', text: i.title, icon: 'fa-check-square', color: 'text-primary' })
    );
    (state.collections.assumptions || []).slice(0, 2).forEach(i => 
        signals.push({ type: 'RISK', text: i.hypothesis, icon: 'fa-exclamation-circle', color: 'text-danger' })
    );

    if (signals.length === 0) {
        container.innerHTML = `<div class="text-center p-4 opacity-50"><i class="fas fa-wind mb-2"></i><div class="font-data small">No Signals</div></div>`;
        return;
    }

    container.innerHTML = `<ul class="list-group list-group-flush">` + signals.map(s => `
        <li class="list-group-item px-3 py-2 border-0 border-bottom signal-item type-${s.type} bg-transparent">
            <div class="d-flex align-items-center">
                <i class="fas ${s.icon} ${s.color} me-3"></i>
                <div class="text-truncate font-body small fw-bold text-dark">${s.text || 'Untitled'}</div>
            </div>
        </li>
    `).join('') + `</ul>`;
}

function renderCollectionList(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];

    // --- Empty State ---
    if (items.length === 0) {
        let icon = "fa-wind";
        let text = "Auto-Generate";
        let btnIcon = "fa-magic";
        
        // Context-aware empty states
        if (type === 'stakeholders' || type === 'resources') { 
            text = "Query SSPEC Network"; 
            btnIcon = "fa-globe";
        } else {
            text = "Run Speculate Engine";
            btnIcon = "fa-microchip";
        }
        
        container.innerHTML = `
            <div class="text-center p-5 opacity-50 border border-dashed rounded bg-light mt-3">
                <i class="fas ${icon} fa-2x mb-3 text-muted"></i>
                <p class="font-data small text-muted mb-3">DATA STREAM EMPTY</p>
                <button class="btn btn-sm btn-outline-primary font-data rounded-pill px-4 btn-speculate-collection" data-collection="${type}">
                    <i class="fas ${btnIcon} me-2"></i> ${text}
                </button>
            </div>`;
        return;
    }

    // --- Dynamic Schema Mapping ---
    const schemaKey = type.slice(0, -1) + '_schema';
    const fields = state.nodeSchema[schemaKey] || [];
    const titleKey = fields[0]?.key || 'title';
    const subKey = fields[1]?.key || 'status';

    // --- Render Cards ---
    container.innerHTML = items.map(item => {
        const title = item[titleKey] || 'Untitled';
        const subtitle = item[subKey] || 'Pending';
        
        // POSSIBILITY LOGIC:
        // Items tagged "AI" are "Possibilities" (Dashed, Ethereal)
        // Items accepted are "Reality" (Solid)
        const isProposed = item.tags && item.tags.includes("AI");

        const extraClass = isProposed ? "possibility-card border-dashed" : "border-start border-4";
        
        // Visual Color Coding for Reality
        let stripStyle = "";
        if (!isProposed) {
            let color = "var(--phase-color)"; // Default
            if (['Verified','Signed','Met','Complete'].includes(item.status)) color = "#10b981"; // Green
            else if (['Blocked','High'].includes(item.status)) color = "#ef4444"; // Red
            stripStyle = `border-left-color: ${color} !important;`;
        }

        return `
        <div class="collection-card-modern ${extraClass}" style="${stripStyle} transition: all 0.2s;">
            <div class="flex-grow-1 ps-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="card-title-modern">${title}</div>
                    ${isProposed ? '<span class="badge bg-primary-soft text-primary font-data" style="font-size:0.6em">POSSIBILITY</span>' : ''}
                </div>
                <div class="card-subtitle-modern text-truncate">${subtitle}</div>
            </div>
            <div class="d-flex align-items-center gap-1">
                ${isProposed 
                    ? `<button class="btn btn-sm btn-outline-success btn-accept p-1 px-2 shadow-sm" data-col="${type}" data-id="${item.id}" title="Accept Possibility"><i class="fas fa-check"></i></button>`
                    : `<button class="btn btn-sm btn-link text-muted p-1 btn-edit-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>`
                }
                <button class="btn btn-sm btn-link text-danger p-1 btn-delete-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-times"></i></button>
            </div>
        </div>`;
    }).join('');
}

// =============================================================================
// 6. DASHBOARD & SIDEBAR METRICS
// =============================================================================

function updateDashboard() {
    // 1. Update Collection Badges
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(k => {
        const count = (state.collections[k] || []).length;
        const badge = state.modalElement.querySelector(`.count-badge[data-collection="${k}"]`);
        if (badge) {
            badge.textContent = count;
            if(count > 0) {
                badge.classList.remove('bg-light', 'text-dark');
                badge.classList.add('bg-primary', 'text-white');
            }
        }
    });

    // 2. Calculate Confidence Score (Heuristic)
    let score = 0;
    const totalGoal = 60; 
    
    // Points for existing
    Object.values(state.collections).flat().forEach(i => {
        if (i.tags !== "AI") score += 5; // Real items count more
        if (['Verified', 'Met', 'Signed', 'Active'].includes(i.status)) score += 5;
    });
    // Points for narrative
    if (state.details_data.summary && state.details_data.summary.length > 20) score += 10;

    const percent = Math.min(100, Math.floor((score / totalGoal) * 100));
    
    // 3. Update Visual Displays
    const bar = state.modalElement.querySelector('#ce-progress-bar'); // If existing in template
    const scoreDisplay = state.modalElement.querySelector('#confidence-score-display');
    
    if(scoreDisplay) scoreDisplay.innerText = `${percent}%`;

    // 4. Update Status Card (Handling Scanning State)
    const statusCard = state.modalElement.querySelector('.system-status-card'); // Optional UI hook
    const statusVal = state.modalElement.querySelector('.status-card-value');
    
    if (statusCard && statusVal) {
        if (state.isScanning) {
            statusVal.innerText = "SCANNING...";
            statusVal.className = "status-card-value text-primary animate-pulse";
            statusCard.classList.add('scanning');
        } else {
            statusCard.classList.remove('scanning');
            statusVal.className = "status-card-value"; // Reset classes
            
            if (percent === 0) statusVal.innerText = "INITIALIZED";
            else if (percent < 30) { statusVal.innerText = "ANALYZING"; statusVal.classList.add('text-warning'); }
            else if (percent < 80) { statusVal.innerText = "CALIBRATING"; statusVal.classList.add('text-info'); }
            else { statusVal.innerText = "OPTIMIZED"; statusVal.classList.add('text-success'); }
        }
    }
}

function renderSidebarPersona() {
    const header = state.modalElement.querySelector('#ai-sidebar-header');
    if(!header) return;
    
    const persona = PERSONAS[state.ceType] || PERSONAS['Default'];
    header.className = 'sidebar-persona-header ' + (persona.class || 'persona-default');
    header.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="fas ${persona.icon} fa-lg"></i>
                <span class="font-brand" style="letter-spacing:1px;">${persona.title}</span>
            </div>
            ${state.isScanning ? '<i class="fas fa-circle-notch fa-spin text-white"></i>' : '<i class="fas fa-circle text-white fa-xs opacity-75"></i>'}
        </div>
        <div class="small opacity-75 mt-1 font-data" style="letter-spacing:0.5px;">MODE: ${persona.tone.toUpperCase()}</div>
    `;
}

function renderAiSidebarContent() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if(!content) return;
    const tab = state.activeTab;
    
    // Helper for buttons
    const mkBtn = (txt, icon, color, action, isNetwork = false) => 
        `<button class="btn btn-light border w-100 text-start mb-2 shadow-sm ${action}">
            <i class="fas ${icon} me-2 text-${color}"></i> 
            ${txt}
            ${isNetwork ? '<span class="float-end badge bg-light text-muted border font-data" style="font-size:0.6em">NET</span>' : '<span class="float-end badge bg-light text-muted border font-data" style="font-size:0.6em">AI</span>'}
         </button>`;

    // --- LOGIC: SPLIT BRANDING ---
    let header = "";
    
    if (['stakeholders', 'resources'].includes(tab)) {
        // --- SSPEC NETWORK MODE ---
        header = `
            <div class="mb-3 pb-2 border-bottom">
                <div class="font-data text-primary small fw-bold tracking-widest"><i class="fas fa-globe me-2"></i>SSPEC NETWORK</div>
                <div class="font-body x-small text-muted">Searching distributed ledger for partners.</div>
            </div>`;
            
        const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
        
        // Network Actions
        header += mkBtn(`Query ${label} Pool`, "search-location", "primary", `btn-speculate-collection" data-collection="${tab}`, true);
        header += mkBtn("Match Capabilities", "link", "info", "", true);
        
    } else {
        // --- SPECULATE ENGINE MODE ---
        header = `
            <div class="mb-3 pb-2 border-bottom">
                <div class="font-data text-danger small fw-bold tracking-widest"><i class="fas fa-microchip me-2"></i>SPECULATE ENGINE</div>
                <div class="font-body x-small text-muted">Generative model active (v2025.23).</div>
            </div>`;

        if (tab === 'overview') {
            header += mkBtn("Strategic Synthesis", "chess-board", "danger", "btn-trigger-ai' data-context='narrative' data-sub='context");
            header += mkBtn("Analyze Critical Path", "project-diagram", "warning", "btn-trigger-ai' data-context='assumptions");
        } else {
            // Prereqs, Assumptions, etc.
            const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
            header += mkBtn(`Speculate ${label}s`, "bolt", "danger", `btn-speculate-collection" data-collection="${tab}`);
            header += mkBtn("Validate Logic", "check-double", "success", "");
        }
    }
    
    // Footer Logic (Direct Uplink)
    content.innerHTML = header + `
        <div class="mt-auto pt-4 border-top">
            <label class="font-data small text-muted mb-2">
                ${['stakeholders', 'resources'].includes(tab) ? 'NETWORK UPLINK' : 'ENGINE PROMPT'}
            </label>
            <input type="text" class="form-control form-control-sm font-body" 
                   placeholder="${['stakeholders', 'resources'].includes(tab) ? 'Search Entity Database...' : 'Input Parameter...'}">
        </div>`;
}

// =============================================================================
// 7. SERVER ACTIONS (API INTERACTION)
// =============================================================================

function triggerSpeculation(type, btn = null, isAuto = false) {
    let origHtml = '';
    
    // 1. Differentiate UI
    const isNetwork = ['stakeholders', 'resources'].includes(type);
    const loadingText = isNetwork ? 'SCANNING NETWORK...' : 'CALCULATING...';
    const loadingIcon = isNetwork ? 'fa-satellite-dish' : 'fa-circle-notch';

    if (btn) { 
        origHtml = btn.innerHTML; 
        btn.disabled = true; 
        btn.innerHTML = `<i class="fas ${loadingIcon} fa-spin me-2"></i> ${loadingText}`; 
    } 

    // 2. Scrape Context
    const contextGoalEl = state.modalElement.querySelector('.source-cos-card p');
    const contextGoal = contextGoalEl ? contextGoalEl.textContent.trim() : "Project Goal";

    // 3. Execute
    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: type, 
            cos_text: contextGoal,
            ssol_id: window.SSOL_ID || null 
        })
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP Error ${r.status}`);
        return r.json();
    })
    .then(data => {
        if (data.success && data.suggestions) {
            data.suggestions.forEach(item => {
                // Generate Client-Side ID to prevent key collisions
                item.id = self.crypto.randomUUID();
                item.tags = "AI"; 
                item.status = "Proposed";
                state.collections[type].push(item);
            });
            render(); 
        } else {
            throw new Error(data.error || "No suggestions returned.");
        }
    })
    .catch(err => {
        console.error("Speculation Error:", err);
        if (btn) {
            btn.classList.add('btn-danger', 'text-white');
            btn.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> FAILED`;
            setTimeout(() => {
                btn.classList.remove('btn-danger', 'text-white');
                btn.innerHTML = origHtml;
                btn.disabled = false;
            }, 3000);
        }
    })
    .finally(() => {
        // Restore button if no error occurred handled in catch
        if (btn && !btn.innerHTML.includes("FAILED")) { 
            btn.innerHTML = origHtml; 
            btn.disabled = false; 
        }
        updateDashboard();
    });
}

function triggerEnhancement(fieldKey, btn = null, isAuto = false) {
    if (btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> RUNNING ENGINE...'; 
    }

    const cosTextEl = state.modalElement.querySelector('.source-cos-card p');
    const cosText = cosTextEl ? cosTextEl.textContent.trim() : "Project Goal";

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: 'narrative', 
            sub_context: fieldKey, 
            cos_text: cosText,
            ssol_id: window.SSOL_ID || null
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.success && data.text) {
            state.details_data[fieldKey] = data.text;
            
            // DOM Update (to avoid full re-render flickering)
            const input = state.modalElement.querySelector(`[name="${fieldKey}"]`);
            if(input) {
                input.value = data.text;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            updateDashboard();
        }
    })
    .catch(err => {
        console.error("Narrative Error:", err);
        if(btn && !isAuto) alert("Speculation failed. Please try again.");
    })
    .finally(() => { 
        if (btn) { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-microchip me-2"></i> SPECULATE ENGINE'; 
        } 
    });
}

function saveDataPacket() {
    const btn = state.modalElement.querySelector('.btn-save-changes');
    const status = state.modalElement.querySelector('#save-status');
    const origText = btn.innerHTML; 
    
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> COMMITTING...';
    btn.disabled = true;

    // 1. Capture Narrative Data (since it might be edited without hitting 'save' locally)
    const narrForm = state.modalElement.querySelector(`#narrative-form-${state.ceId}`);
    if (narrForm) {
        const fd = new FormData(narrForm);
        state.details_data = Object.fromEntries(fd.entries());
    }

    const packet = {
        details_data: state.details_data,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        resources: state.collections.resources,
        connections: state.collections.connections
    };

    // 2. Network Request with Error Boundary
    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    })
    .then(data => {
        if(data.success) {
            // Success Feedback
            if(status) status.innerHTML = `<span class="text-success font-data fw-bold"><i class="fas fa-check-circle me-2"></i>SYNC COMPLETE</span>`;
            
            btn.classList.replace('btn-primary', 'btn-success');
            btn.innerHTML = `<i class="fas fa-check"></i> SAVED`;
            
            setTimeout(() => { 
                btn.classList.replace('btn-success', 'btn-primary');
                btn.innerHTML = origText;
                btn.disabled = false;
            }, 2000);
        } else {
            throw new Error(data.error || "Server rejected save.");
        }
    })
    .catch(err => {
        console.error("Save Failed:", err);
        
        // Error Feedback
        if(status) status.innerHTML = `<span class="text-danger font-data fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>SAVE FAILED</span>`;
        
        btn.classList.replace('btn-primary', 'btn-danger');
        btn.innerHTML = `<i class="fas fa-redo me-2"></i> RETRY SAVE`;
        
        // Don't auto-reset the button immediately; let user see the error
        btn.disabled = false;
        
        // Clean up visual state after 4 seconds
        setTimeout(() => {
             if (btn.classList.contains('btn-danger')) {
                 btn.classList.replace('btn-danger', 'btn-primary');
                 btn.innerHTML = origText;
             }
        }, 4000);
    });
}

// =============================================================================
// 8. EVENT LISTENER DELEGATION
// =============================================================================

function setupEventListeners() {
    const m = state.modalElement;

    // A. Tabs -> Context Switching
    const nav = m.querySelector('.ce-nav-tabs');
    if(nav) {
        nav.addEventListener('shown.bs.tab', e => {
            const tid = e.target.getAttribute('data-bs-target');
            if(tid.includes('overview')) state.activeTab = 'overview';
            else if(tid.includes('narrative')) state.activeTab = 'narrative';
            else {
                // Extract collection name from ID (e.g., view-stakeholders-123)
                const parts = tid.split('-'); 
                // Careful parsing
                if(parts.length >= 2) state.activeTab = parts[1];
            }
            renderAiSidebarContent();
        });
    }

    // B. Central Click Delegation
    m.addEventListener('click', e => {
        const t = e.target;

        // 1. AI Triggers
        const specBtn = t.closest('.btn-speculate-collection');
        if(specBtn) triggerSpeculation(specBtn.dataset.collection, specBtn);
        
        const enhBtn = t.closest('.btn-enhance-field');
        if(enhBtn) triggerEnhancement(enhBtn.dataset.field, enhBtn);
        
        const aiBtn = t.closest('.btn-trigger-ai');
        if(aiBtn) triggerSpeculation(aiBtn.dataset.context, aiBtn);

        // 2. Editor Controls
        const addBtn = t.closest('.btn-add-item');
        if(addBtn) toggleEditor(addBtn.dataset.collection, true);
        
        const editBtn = t.closest('.btn-edit-item');
        if(editBtn) {
            const col = editBtn.dataset.collection;
            const item = state.collections[col].find(i => i.id === editBtn.dataset.id);
            if(item) toggleEditor(col, true, item);
        }

        const cancelBtn = t.closest('.btn-cancel-edit');
        if(cancelBtn) {
            const type = cancelBtn.closest('form').dataset.collection;
            toggleEditor(type, false);
        }

        // 3. Item Lifecycle Actions
        const accBtn = t.closest('.btn-accept');
        if(accBtn) {
            const col = accBtn.dataset.col;
            const item = state.collections[col].find(i => i.id === accBtn.dataset.id);
            if(item) { 
                item.tags = ""; // Remove AI tag
                item.status = "Active"; // Convert to Reality
                render(); 
                // Implicit save could happen here, or wait for manual save
            }
        }
        
        const delBtn = t.closest('.btn-delete-item');
        if(delBtn && confirm("Permanently remove this element?")) {
            const col = delBtn.dataset.col;
            state.collections[col] = state.collections[col].filter(i => i.id !== delBtn.dataset.id);
            render();
        }

        // 4. Save
        if(t.closest('.btn-save-changes')) saveDataPacket();
    });

    // C. Editor Form Submissions
    m.querySelectorAll('.editor-form').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const col = form.dataset.collection;
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());

            // Handle Checkboxes manually
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                data[cb.name] = cb.checked;
            });

            if(form.dataset.editingId) {
                // Update Existing
                const idx = state.collections[col].findIndex(i => i.id === form.dataset.editingId);
                if(idx > -1) state.collections[col][idx] = {...state.collections[col][idx], ...data};
            } else {
                // Create New (Manual)
                data.id = self.crypto.randomUUID();
                data.status = "Active";
                state.collections[col].push(data);
            }
            toggleEditor(col, false);
            render();
        });
    });
}

function toggleEditor(type, show, itemData=null) {
    const cont = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    const edit = state.modalElement.querySelector(`#editor-${type}-${state.ceId}`);
    const form = edit.querySelector('form');

    if(show) {
        cont.style.display = 'none';
        edit.style.display = 'block';
        form.reset();
        
        if(itemData) {
            form.dataset.editingId = itemData.id;
            // Hydrate Inputs
            Object.keys(itemData).forEach(k => {
                const input = form.querySelector(`[name="${k}"]`);
                if(input) {
                    if(input.type === 'checkbox') input.checked = itemData[k] === true;
                    else input.value = itemData[k];
                    
                    // Smart Slider Update
                    if(input.type === 'range' && input.nextElementSibling) {
                        input.nextElementSibling.innerText = input.value + '%';
                    }
                }
            });
        } else {
            delete form.dataset.editingId;
        }
    } else {
        cont.style.display = 'block';
        edit.style.display = 'none';
    }
}

üè≥Ô∏è‚Äçüåà ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST (v2026 - Engine Compatible)
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It couples 'Smart Schemas' (for the UI) with 'Strategic Prompts' (for the AI).

PROMPT VARIABLES:
- {cos_text}: The text of the source Condition of Satisfaction.
- {field}: The specific field being enhanced (e.g., "Executive Summary", "Objective").
- {node_type}: The type of the node (e.g., "Research", "Risk").

NOTE: Double braces {{ }} are used to escape JSON structure examples in Python f-strings.
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Generalist)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are a sub-routine of the SPECULATE Engine.
                TASK: Write a concise, professional '{field}' for a '{node_type}' element needed to achieve the specific Condition: '{cos_text}'.
                CONSTRAINT: Strictly adhere to the System Physics (Budget, Operator, Horizon) provided in the context.
                OUTPUT: JSON {{ "text": "Your text here." }}
            """,
            "prerequisites": "Analyze '{cos_text}'. Considering the System Constraints, what 3 precursors are physically required? Return JSON array: [{{\"title\": \"Prereq\", \"status\": \"Pending\"}}]",
            "stakeholders": "Who is involved in '{cos_text}'? Ensure they match the OPERATOR context (e.g. Grassroots vs Corp). Return JSON array: [{{\"name\": \"Name/Role\", \"role\": \"Description\"}}]",
            "assumptions": "What are we assuming about '{cos_text}'? Return JSON array: [{{\"hypothesis\": \"Assumption...\", \"risk\": \"Medium\"}}]",
            "resources": "Suggest 3 resources for '{cos_text}' compatible with the BUDGET context. Return JSON array: [{{\"title\": \"Resource Name\", \"url\": \"#\"}}]"
        }
    },

    # ==============================================================================
    # 2. RESEARCH (The Scientist)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink
        "details_schema": [
            {"key": "research_question", "label": "Primary Research Question", "type": "textarea", "rows": 2},
            {"key": "summary", "label": "Executive Synthesis", "type": "textarea", "rows": 6}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Paper/Source Title", "type": "text"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset"]},
            {"key": "url", "label": "Source URL", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Research Module of the SPECULATE Engine.
                TASK: Define the epistemic requirements for: '{cos_text}'. Write the '{field}'.
                ATTENUATION: Ensure the scope of research fits the HORIZON constraint.
                OUTPUT: JSON {{ "text": "Your research text here." }}
            """,
            "prerequisites": """
                To answer the research question implied by: '{cos_text}', what data is required?
                Return JSON array: [{{\"data_req\": \"Specific Dataset\", \"access_status\": \"Unknown\"}}]
            """,
            "stakeholders": """
                Suggest 3 types of SMEs needed for: '{cos_text}'.
                Return JSON array: [{{\"name\": \"Role Title\", \"expertise\": \"Academic Field\"}}]
            """,
            "assumptions": """
                What theoretical assumptions are we making in '{cos_text}'?
                Return JSON array: [{{\"premise\": \"Theory...\", \"validation_method\": \"Lit Review\"}}]
            """,
            "resources": """
                Find 3 relevant papers/sources for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Paper Title\", \"type\": \"Paper\", \"url\": \"https://scholar.google.com/\"}}]
            """
        }
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text"},
            {"key": "confidence", "label": "Confidence (0-100)", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "tool_name", "label": "Mitigation Tool", "type": "text"},
            {"key": "cost", "label": "Est. Cost", "type": "currency"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Risk Assessment Module.
                TASK: Write a '{field}' analysis for: '{cos_text}'.
                ATTENUATION: Consider the AVOIDANCE constraint provided in the system physics.
                OUTPUT: JSON {{ "text": "Your analysis here." }}
            """,
            "prerequisites": """
                For the risk scenario in '{cos_text}', what indicators must be monitored?
                Return JSON array: [{{\"indicator\": \"Metric to watch\", \"threshold\": \"Value\"}}]
            """,
            "stakeholders": """
                Who owns the risk associated with '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Role\", \"impacted_group\": \"Population\"}}]
            """,
            "assumptions": """
                What 'safety assumptions' are we making about '{cos_text}' that could be false?
                Return JSON array: [{{\"mitigation_theory\": \"We assume...\", \"confidence\": 50}}]
            """,
            "resources": """
                Suggest 3 mitigation frameworks/tools for: '{cos_text}'.
                Return JSON array: [{{\"tool_name\": \"Framework Name\", \"cost\": \"0\"}}]
            """
        }
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Diplomat)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text"},
            {"key": "material_needs", "label": "Materials Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Document", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Diplomacy Module.
                TASK: Write a '{field}' strategy for: '{cos_text}'.
                ATTENUATION: Adjust tone and targets based on the SCALE and OPERATOR constraints (e.g. Grassroots vs. Global).
                OUTPUT: JSON {{ "text": "Your strategy here." }}
            """,
            "prerequisites": """
                To engage stakeholders for '{cos_text}', what materials are prerequisites?
                Return JSON array: [{{\"intro_path\": \"Via Industry Group\", \"material_needs\": \"Pitch Deck\"}}]
            """,
            "stakeholders": """
                Who are the key decision makers for: '{cos_text}'?
                Return JSON array: [{{\"name\": \"Role/Title\", \"influence\": 80, \"stance\": \"Neutral\"}}]
            """,
            "assumptions": """
                Why do we think these stakeholders will align with '{cos_text}'?
                Return JSON array: [{{\"incentive_theory\": \"They benefit by...\", \"validated\": false}}]
            """,
            "resources": """
                What agreements are standard for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Contract\", \"status\": \"Draft\"}}]
            """
        }
    },

    # ==============================================================================
    # 5. PRAXIS (The Operator)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Est", "type": "text"},
            {"key": "resource_avail", "label": "Resources Available?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "instructions", "label": "SOP/Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Operations Module.
                TASK: Write a '{field}' plan for: '{cos_text}'.
                ATTENUATION: Ensure the logistical complexity fits the BUDGET and OPERATOR constraints.
                OUTPUT: JSON {{ "text": "Your plan here." }}
            """,
            "prerequisites": """
                What must physically exist before '{cos_text}' can start?
                Return JSON array: [{{\"dependency\": \"Task X Complete\", \"status\": \"Blocked\"}}]
            """,
            "stakeholders": """
                Who executes and who approves: '{cos_text}'?
                Return JSON array: [{{\"executor\": \"Role\", \"approver\": \"Manager/Client\"}}]
            """,
            "assumptions": """
                What are the time/resource assumptions for '{cos_text}'?
                Return JSON array: [{{\"time_est\": \"2 Weeks\", \"resource_avail\": true}}]
            """,
            "resources": """
                What tools or SOPs are needed for: '{cos_text}'?
                Return JSON array: [{{\"tool\": \"Tool Name\", \"instructions\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Ecologist)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulation", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Community", "type": "text"},
            {"key": "regulator", "label": "Regulator", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Systems Ecology Module.
                TASK: Write a '{field}' assessment for: '{cos_text}'.
                ATTENUATION: Align impact assessment with the SCALE and DIRECTIVE (Ethics) constraints.
                OUTPUT: JSON {{ "text": "Your assessment here." }}
            """,
            "prerequisites": """
                What regulatory permits or baselines are required for: '{cos_text}'?
                Return JSON array: [{{\"permit\": \"Permit Type\", \"baseline_data\": \"Survey Needed\"}}]
            """,
            "stakeholders": """
                Which communities or regulators gatekeep: '{cos_text}'?
                Return JSON array: [{{\"community\": \"Local Group\", \"regulator\": \"Agency\"}}]
            """,
            "assumptions": """
                What external trends are we assuming hold stable for '{cos_text}'?
                Return JSON array: [{{\"trend\": \"Trend Description\", \"stability\": 60}}]
            """,
            "resources": """
                Find impact studies relevant to: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Report Title\", \"url\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 7. TIMELINE (The Scheduler)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "slack_analysis", "label": "Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors", "type": "text"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "date", "label": "Target Date", "type": "date"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Temporal Logistics Module.
                TASK: Write a '{field}' description for: '{cos_text}'.
                ATTENUATION: Critical! Ensure all lead times fit strictly within the HORIZON date provided.
                OUTPUT: JSON {{ "text": "Your analysis here." }}
            """,
            "prerequisites": """
                What events must happen *before* '{cos_text}'?
                Return JSON array: [{{\"event\": \"Precursor Event\", \"lead_time\": \"2 Weeks\"}}]
            """,
            "stakeholders": """
                Who is responsible for the schedule of: '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Project Manager / Role\"}}]
            """,
            "assumptions": """
                What assumptions about speed/delays affect '{cos_text}'?
                Return JSON array: [{{\"velocity\": \"Standard Pace\", \"external_factors\": \"Weather/Shipping\"}}]
            """,
            "resources": """
                Suggest key calendar deadlines for: '{cos_text}'.
                Return JSON array: [{{\"event\": \"Milestone Name\", \"date\": \"2025-01-01\"}}]
            """
        }
    },

    # ==============================================================================
    # 8. ADVOCACY (The Campaigner)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action", "type": "text"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset", "type": "text"},
            {"key": "platform", "label": "Platform Ready?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience", "type": "text"},
            {"key": "influencer", "label": "Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Post", "Video", "Article"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Campaign Strategy Module.
                TASK: Write a compelling '{field}' for: '{cos_text}'.
                ATTENUATION: Adjust the narrative voice to match the OPERATOR and DIRECTIVE (Ethics) constraints.
                OUTPUT: JSON {{ "text": "Your narrative here." }}
            """,
            "prerequisites": """
                What assets must be ready before advocating for '{cos_text}'?
                Return JSON array: [{{\"asset\": \"Video/Graphics\", \"platform\": false}}]
            """,
            "stakeholders": """
                Who is the target audience for '{cos_text}'?
                Return JSON array: [{{\"audience\": \"Demographic\", \"influencer\": \"Personality/Org\"}}]
            """,
            "assumptions": """
                What are we assuming the public feels about '{cos_text}'?
                Return JSON array: [{{\"sentiment\": \"Positive/Skeptical\", \"resonance\": 70}}]
            """,
            "resources": """
                Suggest 3 content media types for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Viral Video Concept\", \"type\": \"Video\"}}]
            """
        }
    },

    # ==============================================================================
    # 9. COLLABORATION (The Connector)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual"]}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Partnership Module.
                TASK: Write a '{field}' regarding the alliance for: '{cos_text}'.
                ATTENUATION: Ensure governance models fit the OPERATOR type (e.g. DAO vs Corp).
                OUTPUT: JSON {{ "text": "Your strategy here." }}
            """,
            "prerequisites": """
                What legal safeguards are needed before collaborating on '{cos_text}'?
                Return JSON array: [{{\"intro\": true, \"nda\": true}}]
            """,
            "stakeholders": """
                Identify potential partner organizations for: '{cos_text}'.
                Return JSON array: [{{\"partner_org\": \"Org Name\", \"poc\": \"Title/Role\"}}]
            """,
            "assumptions": """
                Why do we assume these partners want to work on '{cos_text}'?
                Return JSON array: [{{\"alignment\": \"Strategic Fit...\", \"resource_sharing\": 80}}]
            """,
            "resources": """
                What governance documents are required for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Teaming Agreement\", \"status\": \"Drafting\"}}]
            """
        }
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

üéØ goal_selection.js:
// static/js/goal_selection.js
// SSPEC "Horizon Fusion" - Goal Selection Controller (v2026.16 - Architectural Integrity)

import {
    regenerateGoals,
    showLoadingSpinner,
    hideLoadingSpinner
} from './base_functions.js';

// =============================================================================
// 1. DATA DEFAULTS (THE ONTOLOGY)
// =============================================================================

const DEFAULTS = {
    OPERATOR: [
        { id: 'Individual', label: 'Just Me (Individual Contributor)', icon: 'fa-user-astronaut', hint: "Maximum autonomy, finite bandwidth. The Engine will prioritize automation, AI tools, and freelancers to multiply your output." },
        { id: 'Grassroots', label: 'Community Group (Volunteers)', icon: 'fa-hands-holding-circle', hint: "Powered by people, not payroll. The Engine will focus on social capital, viral messaging, and reducing friction for volunteers." },
        { id: 'Startup', label: 'Small Team / Startup', icon: 'fa-rocket', hint: "High speed, high risk. The Engine will structure for 'Fail Fast' iterations, rapid prototyping, and growth metrics." },
        { id: 'NonProfit', label: 'Non-Profit / NGO', icon: 'fa-heart', hint: "Mission over profit. The Engine will emphasize grant compliance, stakeholder alignment, and transparency reporting." },
        { id: 'Enterprise', label: 'Established Corp / Enterprise', icon: 'fa-building', hint: "Resource rich, process heavy. The Engine will account for legal compliance, data security, and departmental integration." },
        { id: 'Public', label: 'Government / Public Agency', icon: 'fa-landmark', hint: "Public trust is paramount. The Engine will map out procurement cycles, regulatory hurdles, and civic engagement." }
    ],
    BUDGET: [
        { id: 'Zero', label: 'Zero Budget (Time & Effort)', icon: 'fa-hammer', hint: "No money, just grit. We will look for free-tier tools, barter networks, open-source assets, and organic growth." },
        { id: 'SelfFunded', label: 'Self-Funded (Personal Savings)', icon: 'fa-piggy-bank', hint: "You pay the bills. We will prioritize low-overhead solutions and 'revenue-first' tactics to protect your runway." },
        { id: 'Crowd', label: 'Crowd-Backed (Public Support)', icon: 'fa-bullhorn', hint: "Funded by the audience. We will prioritize marketing assets, video storytelling, and community management." },
        { id: 'Grant', label: 'Grant / Philanthropic', icon: 'fa-file-signature', hint: "Money with strings attached. We will align the roadmap with funding tranches and impact reporting requirements." },
        { id: 'Investor', label: 'Investor Capital (Equity)', icon: 'fa-chart-line', hint: "Fuel for the fire. We will focus on scalability, burn rate, and building defensible 'moats' against competitors." },
        { id: 'Taxpayer', label: 'Public / Taxpayer Funds', icon: 'fa-scale-balanced', hint: "Strict oversight. We will ensure adherence to budget codes, audits, and public procurement laws." }
    ],
    SCALE: [
        { id: 'Household', label: 'Household / Neighborhood', icon: 'fa-home', hint: "Hyper-local. Impact is face-to-face. Logistics are walkable. Success relies on personal trust." },
        { id: 'City', label: 'City / Municipality', icon: 'fa-city', hint: "Civic scale. Involves local government, zoning laws, and civic infrastructure." },
        { id: 'Regional', label: 'State / Regional', icon: 'fa-map', hint: "Broad geography. Requires supply chains, distribution networks, and broader coordination." },
        { id: 'National', label: 'National', icon: 'fa-flag-usa', hint: "Mass scale. Dealing with federal regulations, mass media markets, and country-wide logistics." },
        { id: 'Global', label: 'Global / International', icon: 'fa-earth-americas', hint: "Boundary-less physical impact. Dealing with international trade, localization, and cross-border logistics." },
        { id: 'Digital', label: 'Digital / Decentralized', icon: 'fa-network-wired', hint: "Everywhere and nowhere. Focus on server architecture, protocols, and digital distribution." }
    ],
    MODALITY: [
        { id: 'Iterative', label: 'Iterative (Build & Learn)', icon: 'fa-rotate', hint: "The 'Agile' approach. We build a small version, test it, learn, and improve. Best for unknowns." },
        { id: 'Linear', label: 'Linear Planning (Step-by-Step)', icon: 'fa-layer-group', hint: "The 'Waterfall' approach. Measure twice, cut once. We plan everything before starting. Best for construction/hardware." },
        { id: 'Swarm', label: 'Decentralized Swarm', icon: 'fa-hive', hint: "No central command. Parallel autonomous groups working on shared protocols. Best for movements." },
        { id: 'Crisis', label: 'Emergency Response (Triage)', icon: 'fa-truck-medical', hint: "Speed is life. We prioritize immediate action over efficiency or cost. Best for disasters." },
        { id: 'Consensus', label: 'Consensus (Democratic)', icon: 'fa-users-rectangle', hint: "Slow but steady. Decisions are made by vote or agreement. High buy-in, slower execution." },
        { id: 'Research', label: 'Experimental / Research', icon: 'fa-flask', hint: "The Lab approach. The goal is discovery, not shipping a product. We focus on data validity and hypothesis testing." }
    ]
};

// =============================================================================
// 2. CANONICAL HELPERS (The Source of Truth)
// =============================================================================

/**
 * 2a. Icon Resolution Strategy
 * 1. Ontology: Check DEFAULTS for exact ID or Label match.
 * 2. Heuristics: Fallback to keyword matching if data is missing.
 */
function getIconForOption(opt) {
    const fromOntology = _getIconFromOntology(opt);
    if (fromOntology) return fromOntology;
    
    return _getIconFromHeuristics(opt);
}

function _getIconFromOntology(opt) {
    for (let cat in DEFAULTS) {
        const match = DEFAULTS[cat].find(o => o.id === opt || o.label === opt);
        if (match) return match.icon;
    }
    return null;
}

function _getIconFromHeuristics(opt) {
    const lower = opt.toLowerCase();
    if (lower.includes('team') || lower.includes('start')) return 'fa-rocket';
    if (lower.includes('fund') || lower.includes('capital')) return 'fa-coins';
    if (lower.includes('community')) return 'fa-users';
    if (lower.includes('research')) return 'fa-flask';
    return 'fa-check-circle'; // Safe default
}

/**
 * 2b. Color Logic (Thematic Buckets)
 * Resolves color based on semantic category keywords.
 */
function getColorForOption(opt) {
    const themes = {
        'cyan': '#06b6d4',   // Identity / Drivers
        'green': '#22c55e',  // Fuel / Growth / Zero-Cost
        'orange': '#f97316', // Velocity / Iteration
        'pink': '#ec4899',   // Social / Community / Grant
        'indigo': '#6366f1', // Structure / Enterprise / Scale
        'slate': '#64748b'   // Default / Neutral
    };

    const lower = opt.toLowerCase();

    // DRIVER / IDENTITY
    if (lower.includes('me') || lower.includes('individual') || lower.includes('operator')) return themes.cyan;
    
    // FUEL / RESOURCES
    if (lower.includes('sweat') || lower.includes('zero') || lower.includes('self') || lower.includes('boot')) return themes.green;
    
    // SPEED / PROCESS
    if (lower.includes('start') || lower.includes('agile') || lower.includes('iter') || lower.includes('crisis')) return themes.orange;
    
    // SOCIAL / GRANTS
    if (lower.includes('non') || lower.includes('profit') || lower.includes('crowd') || lower.includes('grant')) return themes.pink;
    
    // STRUCTURE / SCALE
    if (lower.includes('enter') || lower.includes('corp') || lower.includes('public') || lower.includes('linear')) return themes.indigo;

    return themes.slate; 
}

/**
 * 2c. Date Logic (Safe Clone)
 * Prevents mutation side-effects on the Date object.
 */
function getSmartHorizonDate(label) {
    const today = new Date();
    const target = new Date(today); // Explicit clone for safety
    
    const map = {
        "3 Months": 3, "6 Months": 6, "1 Year": 12, "2 Years": 24, "5 Years": 60, "ASAP": 1
    };
    
    const months = map[label] || 0;
    target.setMonth(today.getMonth() + months);
    return target.toISOString().split('T')[0];
}

function formatDateFriendly(dateStr) {
    if (!dateStr) return "Pending Calibration...";
    const date = new Date(dateStr);
    if(isNaN(date.getTime())) return "Invalid Date";
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

/**
 * 2d. Hint Resolution
 * Extracts the 'hint' text from the DEFAULTS ontology matching the label.
 * Returns actionable advice for the Insight Box.
 */
function getHintForOption(optLabel) {
    for (let cat in DEFAULTS) {
        // Check for match in label or id
        const match = DEFAULTS[cat].find(o => o.label === optLabel || o.id === optLabel);
        if (match && match.hint) return match.hint;
    }
    return "Refines the structural constraints of the solution.";
}

// =============================================================================
// 3. STATE MANAGEMENT
// =============================================================================

const State = {
    phase: 'INIT', 
    selectedCardId: null,
    selectedCardData: null,
    sysConfig: window.WIZARD_CONFIG || {},
    colorData: window.GOAL_COLOR_DATA || [],
    currentStepIndex: 0,
    steps: [], 
    config: {},     
    extraParams: [] 
};

// =============================================================================
// 4. GLOBAL BINDINGS (Public Interface)
// =============================================================================

// Expose these explicitly for HTML onclick attributes
window.selectGoal = function(cardWrapper) { handleCardClick(cardWrapper); };
window.selectOption = function(key, value) {
    State.config[key] = value;
    let icon = getIconForOption(value);
    injectPillToHero(key, value, icon);
    renderWizard();
};
window.toggleExtraParam = function(id) { toggleExtraParamLogic(id); };
window.wizardNext = function() { wizardNavigation('next'); };
window.wizardBack = function() { wizardNavigation('back'); };
window.jumpToStep = function(idx) { wizardNavigation('jump', idx); };
window.submitConfig = function() { submitConfigLogic(); };
window.exitStage = function() { if (State.phase === 'CONFIG') transitionTo('RETURNING'); };

// Insight Hover Helpers
window.updateInsightText = function(text) {
    const box = document.getElementById('active-insight-box');
    if(box) box.querySelector('.context-insight-body').innerText = text;
};
window.resetInsightText = function() {
    const box = document.getElementById('active-insight-box');
    if(box) {
        // Matches the default state in renderStandardStep
        box.querySelector('.context-insight-body').innerText = "Hover over an option to preview its impact on the pathway.";
    }
};
window.handleTagInput = handleTagInput;
window.removeTag = removeTag;

// =============================================================================
// 5. BUSINESS LOGIC (Internal)
// =============================================================================

function toggleExtraParamLogic(id) {
    const idx = State.extraParams.indexOf(id);
    // Visual toggle in DOM
    const btn = document.querySelector(`.option-card-pill[onclick*="${id}"]`);
    const icon = btn.querySelector('.pill-icon-circle i');
    const defIcon = btn.dataset.defIcon || 'fa-circle'; // Fallback if needed, though renderForkScreen handles redraw usually

    if(idx > -1) {
        // Remove
        State.extraParams.splice(idx, 1);
        State.steps = State.steps.filter(s => s.id !== id);
        if(btn) {
            btn.classList.remove('selected');
            // Hacky icon toggle or just let re-render handle it? 
            // Re-rendering is safer for icons, but let's toggle class for speed
            // ideally we just re-render the button icon here
        }
    } else {
        // Add
        State.extraParams.push(id);
        if(btn) btn.classList.add('selected');
        
        let conf = {};
        if (id === 'DIRECTIVE') {
            conf = { step_label: 'Core Values', step_icon: 'fa-heart', question: 'What do we stand for?', helper: 'The Engine needs your moral compass.', ui_type: 'tags', placeholder: 'e.g. Transparency, Zero Waste' };
        } else if (id === 'AVOIDANCE') {
            conf = { step_label: 'Dealbreakers', step_icon: 'fa-ban', question: 'What must we avoid?', helper: 'Negative constraints are vital.', ui_type: 'tags', placeholder: 'e.g. Debt, Burnout' };
        } else if (id === 'SCALE') {
            conf = { step_label: 'Scale', step_icon: 'fa-map', question: 'What is the footprint?', helper: 'Geography dictates physics.', options: DEFAULTS.SCALE.map(o => o.label) };
        } else if (id === 'MODALITY') {
            conf = { step_label: 'Work Style', step_icon: 'fa-users-gear', question: 'How do we coordinate?', helper: 'Rhythm dictates structure.', options: DEFAULTS.MODALITY.map(o => o.label) };
        }

        const stepDef = { id: id, ...conf };
        // Insert after current step (which is FORK)
        // Wait, standard insert logic:
        const forkIndex = State.steps.findIndex(s => s.id === 'FORK');
        // We actually want to append them after FORK in order of appearance
        // Re-sorting might be needed if user clicks out of order, 
        // but for now appending to the queue is fine.
        if (State.currentStepIndex + 1 < State.steps.length) {
             State.steps.splice(State.currentStepIndex + 1, 0, stepDef);
        } else {
             State.steps.push(stepDef);
        }
    }
    
    // --- FOOTER LOGIC ---
    updateForkFooter();
    
    // Re-render to update icons (checkmarks)
    const mainContainer = document.getElementById('wizard-main-area');
    mainContainer.innerHTML = renderForkScreen();
}

function updateForkFooter() {
    const nextBtn = document.querySelector('.wiz-btn-next');
    if (!nextBtn) return; // Safety check
    
    if (State.steps[State.currentStepIndex].id === 'FORK') {
        if (State.extraParams.length > 0) {
            nextBtn.innerHTML = `CONFIGURE EXTRAS (${State.extraParams.length}) <i class="fas fa-arrow-right ms-2"></i>`;
            nextBtn.style.visibility = 'visible';
            nextBtn.classList.add('btn-primary', 'text-white', 'border-0');
        } else {
            nextBtn.style.visibility = 'hidden';
            nextBtn.classList.remove('btn-primary', 'text-white', 'border-0');
        }
    }
}

function wizardNavigation(action, idx=null) {
    if (action === 'next') {
        if(State.currentStepIndex < State.steps.length - 1) {
            State.currentStepIndex++;
            renderWizard();
        } else {
            window.submitConfig();
        }
    } else if (action === 'back') {
        if(State.currentStepIndex > 0) {
            State.currentStepIndex--;
            renderWizard();
        }
    } else if (action === 'jump') {
        if(idx <= State.currentStepIndex + 1) {
            State.currentStepIndex = idx;
            renderWizard();
        }
    }
    
    // Update footer logic after render
    setTimeout(updateForkFooter, 50); 
}

function submitConfigLogic() {
    // 1. Populate Hidden Form
    const form = document.getElementById('final-submit-form');
    document.getElementById('form-goal').value = State.selectedCardData.goal;
    document.getElementById('form-title').value = State.selectedCardData.title;
    document.getElementById('form-domain').value = State.selectedCardData.domain;
    document.getElementById('form-domain-icon').value = State.selectedCardData.icon;
    
    // Clear old dynamics
    form.querySelectorAll('.dynamic-param').forEach(e => e.remove());

    Object.keys(State.config).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key; 
        let val = State.config[key];
        if (Array.isArray(val)) val = val.join(', ');
        input.value = val;
        input.className = 'dynamic-param';
        form.appendChild(input);
    });

    // 2. Prepare Wizard Container
    const wizardContainer = document.querySelector('.wizard-container');
    if (!wizardContainer) { form.submit(); return; }

    wizardContainer.classList.add('loading-state');
    
    // 3. Inject CLASSIC ATOM SPINNER
    // Helper to generate an Orbit SVG string
    const getOrbitHtml = (color, duration, reverse, sphereGradient) => {
        const dir = reverse ? 'reverse' : 'normal';
        const counterAnim = reverse ? 'counter-spin-reverse' : 'counter-spin-normal';
        const flipStyle = reverse ? 'transform: scaleX(-1);' : '';
        
        // Define unique gradient ID
        const gradId = `grad-${color.replace('#','')}`;
        
        return `
        <div class="orbit-track-wrapper" style="animation: orbit-spin ${duration} linear infinite; animation-direction: ${dir};">
            <svg viewBox="0 0 100 100" class="orbit-svg" style="${flipStyle}">
                <defs>
                    <linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="${color}" stop-opacity="0" />
                        <stop offset="100%" stop-color="${color}" stop-opacity="1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="48" class="orbit-ring-faint" stroke="${color}" />
                <path d="M 16,84 A 48,48 0 0 1 50,2" class="orbit-trail" stroke="url(#${gradId})" />
            </svg>
            <div class="electron-sphere" 
                 style="background: ${sphereGradient}; color: ${color}; animation: ${counterAnim} ${duration} linear infinite;">
            </div>
        </div>`;
    };

    const atomHtml = `
    <div class="atom-wrapper fade-in">
        <div class="atom-rainbow-border"></div>
        <div class="atom-bg-dots"></div>
        
        <!-- 3D Scene -->
        <div class="atom-scene">
            <div class="atom-core">
                
                <!-- ORBIT 1: CYAN -->
                <div class="orbit-plane orbit-plane-1">
                    ${getOrbitHtml('#22d3ee', '1.5s', false, 'radial-gradient(circle at 35% 35%, #67e8f9 0%, #22d3ee 60%, #06b6d4 100%)')}
                </div>

                <!-- ORBIT 2: ORANGE -->
                <div class="orbit-plane orbit-plane-2">
                    ${getOrbitHtml('#fb923c', '2s', true, 'radial-gradient(circle at 35% 35%, #fdba74 0%, #fb923c 60%, #ea580c 100%)')}
                </div>

                <!-- ORBIT 3: PURPLE -->
                <div class="orbit-plane orbit-plane-3">
                    ${getOrbitHtml('#c084fc', '2.5s', false, 'radial-gradient(circle at 35% 35%, #d8b4fe 0%, #c084fc 60%, #9333ea 100%)')}
                </div>

                <!-- NUCLEUS -->
                <div class="atom-nucleus">
                    <div class="nucleus-ring"></div>
                    <div class="nucleus-glow"></div>
                    <i id="atom-icon" class="fas fa-rocket nucleus-icon visible"></i>
                </div>

            </div>
        </div>

        <!-- Text Wipe -->
        <div class="atom-text-area">
            <div class="atom-title">GENERATING YOUR STRUCTURED SOLUTION</div>
            <div class="atom-message-box">
                <div id="atom-msg-display" class="atom-msg active">ACCESSING SSPEC NEURAL NETWORK...</div>
            </div>
        </div>
    </div>`;

    // Clear and Inject
    // If embedded wrapper exists reuse it, else append
    let wrapper = wizardContainer.querySelector('.embedded-spinner-wrapper');
    if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'embedded-spinner-wrapper';
        wrapper.style.cssText = "display: flex; flex:1; width:100%; height:100%;";
        wizardContainer.innerHTML = ''; // clear wizard content
        wizardContainer.appendChild(wrapper);
    }
    wrapper.innerHTML = atomHtml;

    // 4. Start Animations (Icon & Text Cycling)
    const icons = ['fa-rocket', 'fa-bolt', 'fa-globe', 'fa-microchip', 'fa-layer-group', 'fa-database'];
    const messages = [
        "Vectorizing inputs...",
        "Calibrating Horizon constraints...",
        "Optimizing resource paths...",
        "Drafting executive language...",
        "Finalizing data packet..."
    ];
    
    let iIdx = 0;
    let mIdx = 0;
    const iconEl = document.getElementById('atom-icon');
    const msgEl = document.getElementById('atom-msg-display');

    const animInterval = setInterval(() => {
        // Swap Icon
        iIdx = (iIdx + 1) % icons.length;
        if(iconEl) {
            iconEl.classList.remove('visible');
            iconEl.classList.add('pop-in');
            
            setTimeout(() => {
                iconEl.className = `fas ${icons[iIdx]} nucleus-icon pop-in`;
                requestAnimationFrame(() => {
                    iconEl.classList.remove('pop-in');
                    iconEl.classList.add('visible');
                });
            }, 150); // wait for fade out
        }

        // Swap Text (Slower cycle, every 2nd tick maybe? or just every tick is fine)
        // Let's do text every 2 ticks (2.4s)
        if (iIdx % 2 === 0) {
            mIdx = (mIdx + 1) % messages.length;
            if(msgEl) {
                msgEl.style.opacity = 0;
                msgEl.style.transform = "translateY(-5px)";
                setTimeout(() => {
                    msgEl.innerText = messages[mIdx];
                    msgEl.style.opacity = 1;
                    msgEl.style.transform = "translateY(0)";
                }, 300);
            }
        }

    }, 1200);

    // 5. Submit after delay
    setTimeout(() => { 
        clearInterval(animInterval);
        form.submit(); 
    }, 4500); // 4.5s simulation
}
function handleTagInput(key, event) {
    if (event.key === 'Enter' || event.key === ',') {
        event.preventDefault();
        const val = event.target.value.trim();
        if (val) {
            let current = State.config[key] || [];
            if (!Array.isArray(current)) current = [];
            if (!current.includes(val)) {
                current.push(val);
                State.config[key] = current;
                renderWizard(); 
                injectPillToHero(key, val, 'fa-tag'); 
            }
            setTimeout(() => {
                const el = document.getElementById(`tag-input-${key}`);
                if(el) el.focus();
            }, 50);
        }
    }
}

function removeTag(key, index, event) {
    event.stopPropagation(); 
    let current = State.config[key];
    if (Array.isArray(current)) {
        current.splice(index, 1);
        State.config[key] = current;
        renderWizard();
    }
}

// =============================================================================
// 6. VISUAL RENDERING (The Theater)
// =============================================================================

function handleCardClick(cardWrapper) {
    if (State.phase !== 'SELECTION' && State.phase !== 'DEALING') return;
    if (cardWrapper.classList.contains('violation')) return;
    
    const cardId = cardWrapper.dataset.cardId;
    const colorHue = parseFloat(cardWrapper.dataset.colorHue) || 180;
    const backendData = (State.colorData || []).find(g => (g.title || "").toLowerCase().replace(/\s+/g, '-') === cardId) || {};
    
    const goalData = {
        id: cardId,
        title: cardWrapper.dataset.cardTitle || "Unknown Goal",
        goal: cardWrapper.querySelector('.card-desc-large')?.innerText || "",
        domain: cardWrapper.querySelector('.card-domain-badge-large')?.innerText || "",
        icon: cardWrapper.querySelector('.card-icon-float-large i')?.className || "fas fa-cube",
        colorHue: colorHue,
        iconColor: backendData.icon_color || `hsl(${colorHue}, 90%, 30%)`
    };
    transitionTo('CONFIG', { cardWrapper, goalData: goalData });
}

function transitionTo(newPhase, payload = {}) {
    State.phase = newPhase;
    switch (newPhase) {
        case 'DEALING': handleDealingPhase(); break;
        case 'SELECTION': handleSelectionPhase(); break;
        case 'CONFIG': handleConfigPhase(payload.cardWrapper, payload.goalData); break;
        case 'RETURNING': handleReturningPhase(); break;
    }
}

// --- Transitions ---
function handleDealingPhase() {
    const cards = document.querySelectorAll('.flip-card-wrapper');
    cards.forEach((card, index) => {
        // Reset states
        card.classList.remove('state-selection', 'state-config', 'state-dimmed', 'state-returning');
        card.style.cssText = '';
        
        // 1. Initial State: Invisible, shifted down
        card.classList.add('state-dealing');
        void card.offsetWidth; // Force Reflow
        
        // 2. Reveal Sequence (Staggered)
        setTimeout(() => {
            card.classList.remove('state-dealing'); 
            card.classList.add('state-revealing'); // Card rises up, showing BACK face (Monolith)
            
            // 3. The Flip (Delayed)
            // INCREASED from 600 to 1200 to hold the Monolith view longer
            setTimeout(() => { 
                card.classList.remove('state-revealing'); 
                card.classList.add('state-selection'); // Triggers the 180deg flip to text
            }, 1200); 

        }, 300 + (index * 200));
    });

    // 4. Update State Logic Phase
    // Increased buffer to match new animation duration (cards.length * 200 + 1400)
    setTimeout(() => { 
        if (State.phase === 'DEALING') transitionTo('SELECTION'); 
    }, 400 + (cards.length * 200) + 1400);
}

function handleSelectionPhase() {
    document.querySelectorAll('.flip-card-wrapper').forEach(card => {
        card.classList.remove('state-dealing', 'state-revealing', 'state-config', 'state-dimmed', 'state-returning');
        card.classList.add('state-selection');
        card.style.cssText = '';
    });
}

function handleConfigPhase(cardWrapper, goalData) {
    if (!cardWrapper) return;
    State.selectedCardData = goalData;
    
    // Config Setup
    const coreKeys = ['OPERATOR', 'HORIZON', 'BUDGET'];
    State.steps = coreKeys.map(key => {
        let wizardConf = (State.sysConfig[key] && State.sysConfig[key].wizard) ? State.sysConfig[key].wizard : null;
        if (!wizardConf) wizardConf = { step_label: key, icon: 'fa-cube' };
        
        // Use DEFAULTS if available for labels
        if(DEFAULTS[key]) wizardConf.options = DEFAULTS[key].map(o => o.label);
        
        return { id: key, ...wizardConf };
    });
    State.steps.push({ id: 'FORK', step_label: 'Ready', step_icon: 'fa-bolt' });
    
    State.config = {};
    State.extraParams = [];
    State.currentStepIndex = 0;

    // ANIMATION LOGIC 
    const viewport = document.getElementById('stage-viewport');
    
    // 1. Dim others
    document.querySelectorAll('.flip-card-wrapper').forEach(c => { 
        if (c !== cardWrapper) c.classList.add('state-dimmed'); 
    });
    
    // 2. Calculate Geometry
    const rect = cardWrapper.getBoundingClientRect();
    const viewRect = viewport.getBoundingClientRect();
    
    // 3. Create Placeholder
    const placeholder = document.createElement('div');
    placeholder.className = 'grid-placeholder';
    placeholder.id = 'active-card-placeholder';
    placeholder.style.width = rect.width + 'px'; 
    placeholder.style.height = rect.height + 'px';
    cardWrapper.parentNode.insertBefore(placeholder, cardWrapper);
    
    // 4. Promote to Viewport & Fix Position
    viewport.appendChild(cardWrapper);
    cardWrapper.style.position = 'absolute';
    cardWrapper.style.top = (rect.top - viewRect.top) + 'px';
    cardWrapper.style.left = (rect.left - viewRect.left) + 'px';
    cardWrapper.style.width = rect.width + 'px'; 
    cardWrapper.style.height = rect.height + 'px';
    
    // FORCE REFLOW (Critical for CSS transition to catch)
    void cardWrapper.offsetWidth; 

    // 5. Trigger the State Change (The Flip & Dock)
    cardWrapper.classList.add('state-config');
    
    // 6. Animate to Docked Position
    requestAnimationFrame(() => {
        cardWrapper.style.top = '0px'; 
        cardWrapper.style.left = '0px'; 
        cardWrapper.style.height = '100%';
    });
    
    setTimeout(() => {
        const stage = document.getElementById('configuration-stage');
        if(stage) stage.classList.add('active');
        injectHeroContent(cardWrapper, goalData);
        renderWizard();
    }, 400);
}

function handleReturningPhase() {
    const cardWrapper = document.querySelector('.flip-card-wrapper.state-config');
    const placeholder = document.getElementById('active-card-placeholder');
    if (!cardWrapper || !placeholder) { transitionTo('SELECTION'); return; }
    
    const stage = document.getElementById('configuration-stage');
    if(stage) stage.classList.remove('active');
    
    const backFace = cardWrapper.querySelector('.flip-card-back');
    if(backFace) {
        backFace.style.opacity = '0';
        setTimeout(() => { 
            restoreMonolithContent(cardWrapper);
            backFace.style.opacity = '1'; 
        }, 150);
    }

    const viewport = document.getElementById('stage-viewport');
    const pRect = placeholder.getBoundingClientRect();
    const vRect = viewport.getBoundingClientRect();
    
    cardWrapper.classList.remove('state-config'); 
    cardWrapper.classList.add('state-returning');
    
    requestAnimationFrame(() => {
        cardWrapper.style.top = (pRect.top - vRect.top) + 'px';
        cardWrapper.style.left = (pRect.left - vRect.left) + 'px';
        cardWrapper.style.width = pRect.width + 'px'; 
        cardWrapper.style.height = pRect.height + 'px';
    });
    
    setTimeout(() => {
        cardWrapper.style.cssText = '';
        placeholder.parentNode.insertBefore(cardWrapper, placeholder);
        placeholder.remove();
        transitionTo('SELECTION');
    }, 800);
}


// =============================================================================
// 7. WIZARD & COMPONENT RENDERERS
// =============================================================================

function renderWizard() {
    const currentStep = State.steps[State.currentStepIndex];
    if(!currentStep) return;

    const headerContainer = document.querySelector('.wizard-header');
    const mainContainer = document.getElementById('wizard-main-area');
    const footerContainer = document.querySelector('.wizard-footer');
    const wizardMeta = (State.sysConfig[currentStep.id] && State.sysConfig[currentStep.id].wizard) ? State.sysConfig[currentStep.id].wizard : currentStep; 
    
    // Render Main Content
    if (currentStep.id === 'FORK') {
        headerContainer.classList.add('hidden'); 
        mainContainer.innerHTML = renderForkScreen();
    } else {
        headerContainer.classList.remove('hidden');
        headerContainer.innerHTML = `
            <div class="fade-in">
                <h2 class="font-brand text-dark mb-2" style="font-size: 2.2rem; line-height: 1.1;">
                    ${wizardMeta.question || currentStep.step_label}
                </h2>
                <p class="font-body text-muted" style="font-size: 1rem; max-width: 95%;">
                    ${wizardMeta.helper}
                </p>
            </div>`;
        mainContainer.innerHTML = renderStandardStep(currentStep);
    }

    // Render Progress Dots
    const dotsHtml = State.steps.map((s, idx) => {
        let status = idx === State.currentStepIndex ? 'active' : (idx < State.currentStepIndex ? 'completed' : '');
        return `<div class="wizard-step-dot ${status}" onclick="window.jumpToStep(${idx})" title="${s.step_label || s.id}"></div>`;
    }).join('');

    // --- NAVIGATION BUTTON LOGIC ---
    
    // 1. Back Button
    const backBtnHtml = State.currentStepIndex === 0 
        ? `<button class="wiz-btn-back" style="visibility: hidden">Back</button>`
        : `<button class="wiz-btn-back" onclick="window.wizardBack()"><i class="fas fa-arrow-left"></i> Back</button>`;
        
    // 2. Next Button (The Fix)
    // We ALWAYS create the button structure, but we control visibility/text based on state.
    let nextVisibility = 'visible';
    let nextText = `Next <i class="fas fa-arrow-right ms-2"></i>`;
    let nextClass = '';

    if (currentStep.id === 'FORK') {
        if (State.extraParams.length > 0) {
            nextText = `CONFIGURE EXTRAS (${State.extraParams.length}) <i class="fas fa-arrow-right ms-2"></i>`;
            nextClass = 'btn-primary text-white border-0'; // Add pop for the action
        } else {
            nextVisibility = 'hidden'; // Hide if no extras selected yet
        }
    }

    const nextBtnHtml = `
        <button class="wiz-btn-next ${nextClass}" 
                style="visibility: ${nextVisibility};" 
                onclick="window.wizardNext()">
            ${nextText}
        </button>`;

    // Render Footer
    footerContainer.innerHTML = `
        <div class="d-flex align-items-center"><span class="wizard-track-label">Step ${State.currentStepIndex + 1}/${State.steps.length}</span><div class="wizard-progress-track">${dotsHtml}</div></div>
        <div class="d-flex gap-3 align-items-center">${backBtnHtml}${nextBtnHtml}</div>
    `;
}

function renderStandardStep(step) {
    const existingVal = State.config[step.id] || '';
    const backendNode = State.sysConfig[step.id] || {};
    const wizardMeta = backendNode.wizard || step; 
    
    let innerContent = '';

    // A. OPTIONS (The Grid View)
    if (step.options && step.options.length > 0) {
        innerContent = `
            <div class="option-grid-compact fade-in">
                ${step.options.map(optLabel => {
                    const iconClass = getIconForOption(optLabel); 
                    const colorHex = getColorForOption(optLabel);
                    const isSelected = existingVal === optLabel;
                    
                    // --- REWIRED HINT LOGIC ---
                    const hintText = getHintForOption(optLabel);
                    // Safe escape for HTML attributes
                    const safeHint = hintText.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `
                    <div class="option-card ${isSelected ? 'selected' : ''}" 
                         style="--opt-primary: ${colorHex};"
                         onclick="window.selectOption('${step.id}', '${optLabel}')"
                         onmouseenter="window.updateInsightText('${safeHint}')"
                         onmouseleave="window.resetInsightText()">
                        <div class="option-icon"><i class="fas ${iconClass}"></i></div>
                        <div class="option-label">${optLabel}</div>
                    </div>`;
                }).join('')}
            </div>`;
    }
    // B. TAGS
    else if (backendNode.ui_type === 'tags' || step.ui_type === 'tags') {
        const currentTags = Array.isArray(existingVal) ? existingVal : (existingVal ? existingVal.split(',') : []);
        innerContent = `
            <div class="fade-in">
                <div class="tag-input-container" onclick="document.getElementById('tag-input-${step.id}').focus()">
                    ${currentTags.map((tag, i) => `<span class="tag-pill">${tag} <i class="fas fa-times tag-remove" onclick="window.removeTag('${step.id}', ${i}, event)"></i></span>`).join('')}
                    <input type="text" id="tag-input-${step.id}" class="tag-input-field" 
                           placeholder="${wizardMeta.placeholder || 'Type and press Enter...'}"
                           autocomplete="off" onkeydown="window.handleTagInput('${step.id}', event)">
                </div>
            </div>`;
    }
    // C. DATE (THE HERO TIMELINE)
    else if (step.id === 'HORIZON' || backendNode.ui_type === 'date') {
        const quicks = wizardMeta.quick_selects || ["3 Months", "6 Months", "1 Year", "2 Years", "5 Years"];
        
        // Logic to show a default "Today" or the selected date
        let displayDate = existingVal ? existingVal : new Date().toISOString().split('T')[0];
        
        // Helper to trigger the hidden date input
        window.triggerDateInput = () => document.getElementById('real-date-input').showPicker();

        innerContent = `
            <div class="fade-in">
                
                <!-- Hero Wrapper -->
                <div class="timeline-hero-wrapper">
                    <div class="timeline-label-small">TARGET COMPLETION DATE</div>
                    
                    <!-- The Big Clickable Text -->
                    <div class="timeline-date-display" onclick="window.triggerDateInput()">
                        <span id="date-text-display">${existingVal ? existingVal : '-- / -- / --'}</span>
                        <i class="far fa-calendar-alt timeline-icon-trigger"></i>
                    </div>

                    <!-- Hidden Input -->
                    <input type="date" id="real-date-input" class="timeline-real-input"
                           value="${existingVal}" 
                           onchange="window.selectOption('${step.id}', this.value); document.getElementById('date-text-display').innerText = this.value;">

                    <!-- Quick Chips -->
                    <div class="chip-row">
                        ${quicks.map(label => {
                            const calcDate = getSmartHorizonDate(label);
                            const isActive = existingVal === calcDate;
                            return `<div class="date-chip-modern ${isActive ? 'active' : ''}" 
                                         onclick="window.selectOption('${step.id}', '${calcDate}')">
                                         ${label}
                                    </div>`;
                        }).join('')}
                    </div>
                </div>

                <!-- Physics/Insight Box -->
                <div class="timeline-physics-box">
                    <div class="physics-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="physics-content">
                        <h6>TIMELINE PHYSICS</h6>
                        <p>
                            Short horizons (months) force "Hack" strategies and MVP compromises. 
                            Long horizons (years) allow for Infrastructure, Deep Research, and Institutional building.
                        </p>
                    </div>
                </div>

            </div>`;
    }
    // D. FALLBACK TEXTAREA
    else {
        innerContent = `<div class="fade-in"><textarea class="form-control bg-light border-0 font-body p-3 shadow-inner" rows="4" placeholder="Enter details..." oninput="window.selectOption('${step.id}', this.value)">${existingVal}</textarea></div>`;
    }

    return `
        <div class="d-flex flex-column h-100 justify-content-center">
            ${innerContent}
            <!-- UPDATED INSIGHT BOX COPY -->
            <div class="context-insight-box mt-auto" id="active-insight-box">
                <div class="context-insight-title"><i class="fas fa-info-circle me-1"></i> SYSTEM INSIGHT</div>
                <div class="context-insight-body">Hover over an option to preview its impact on the roadmap.</div>
            </div>
        </div>`;
}

function renderForkScreen() {
    const extraOptions = [
        { id: 'DIRECTIVE', label: 'Core Values', icon: 'fa-heart', desc: 'Ethical Standards' },
        { id: 'AVOIDANCE', label: 'Dealbreakers', icon: 'fa-ban', desc: 'Risks to Prevent' },
        { id: 'SCALE', label: 'Scale', icon: 'fa-map', desc: 'Physical Footprint' },
        { id: 'MODALITY', label: 'Work Style', icon: 'fa-people-group', desc: 'Team Rhythm' }
    ];

    return `
        <div class="wizard-step fade-in h-100 d-flex flex-column">
            <!-- HEADER -->
            <div class="text-center pt-2 mb-4">
                <div class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2 mb-3 font-data">
                    <i class="fas fa-check-circle me-2"></i> BASELINES ESTABLISHED
                </div>
                <h2 class="font-brand display-5 mb-2 text-dark">Ready to Engineer</h2>
            </div>

            <!-- GENERATE BUTTON (Primary Action) -->
            <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center mb-4">
                <p class="text-muted font-body text-center mx-auto mb-4" style="max-width: 500px; font-size: 1.05rem;">
                    The Engine has enough context to reverse-engineer a valid path. <br>
                    You can generate the solution now, or add <strong>precision constraints</strong> below.
                </p>
                <button class="btn wiz-btn-gen rounded-pill px-5 py-3 font-data text-white shadow-lg hover-lift" 
                        onclick="window.submitConfig()"
                        style="background-color: var(--active-theme-color); font-size: 1.1rem; min-width: 260px; position: relative; overflow: hidden;">
                    <span class="position-relative z-2"><i class="fas fa-bolt me-2"></i> GENERATE STRUCTURED SOLUTION</span>
                    <div class="shimmer-effect"></div>
                </button>
            </div>

            <!-- SYSTEM PILLS (Secondary Configuration) -->
            <div class="border-top pt-4 mt-auto">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex flex-column">
                        <h6 class="font-data text-dark fw-bold small mb-0" style="letter-spacing: 1px;">INCREASE PRECISION (OPTIONAL)</h6>
                        <span class="font-body x-small text-muted">Select factors to fine-tune the Engine's logic.</span>
                    </div>
                </div>
                
                <!-- PILL GRID -->
                <div class="option-grid-compact">
                    ${extraOptions.map(p => {
                        const isChecked = State.extraParams.includes(p.id);
                        
                        return `
                        <div class="option-card-pill ${isChecked ? 'selected' : ''}" 
                                onclick="window.toggleExtraParam('${p.id}')"
                                style="--opt-primary: var(--active-theme-color);">
                            
                            <!-- Left: Icon -->
                            <div class="pill-icon-circle">
                                <i class="fas ${p.icon}"></i>
                            </div>
                            
                            <!-- Middle: Text -->
                            <div class="pill-content d-flex flex-column">
                                <span class="pill-title">${p.label}</span>
                                <span class="pill-desc font-body text-muted x-small">${p.desc}</span>
                            </div>

                            <!-- Right: The New Check Indicator -->
                            <div class="pill-check-indicator">
                                <i class="fas fa-check"></i>
                            </div>

                        </div>`;
                    }).join('')}
                </div>
            </div>
        </div>`;
}

function injectHeroContent(cardWrapper, goalData) {
    const backFace = cardWrapper.querySelector('.flip-card-back');
    if (!backFace) return;
    
    // 1. Calculate Colors
    const hue = goalData.colorHue || 180;
    const activeColor = `hsl(${hue}, 70%, 45%)`; 
    cardWrapper.style.setProperty('--active-theme-color', activeColor);

    // 2. TIMING SEQUENCE:
    // A. Hold the "Monolith" view for 600ms (The "Beat")
    setTimeout(() => {
        
        // B. Fade Out the Monolith (prepare for swap)
        // Ensure transition is active for this inline style change
        backFace.style.transition = 'opacity 0.4s ease';
        backFace.style.opacity = '0';
        
        // C. Swap Content & Fade In (After 400ms fade-out completes)
        setTimeout(() => {
            backFace.innerHTML = `
                <div class="card-texture-overlay"></div>
                <!-- CRITICAL FIX: style="opacity: 1" overrides the CSS default of 0 -->
                <div class="hero-card-content" style="opacity: 1 !important;"> 
                    <i class="${goalData.icon} hero-ghost-icon"></i>
                    
                    <button onclick="window.exitStage()" class="hero-return-button" style="pointer-events: auto;">
                        <i class="fas fa-arrow-left"></i> RETURN TO CHOICES
                    </button>
                    
                    <!-- Header Group: Domain & Title -->
                    <div class="hero-header-group">
                        <span class="hero-domain-label">SYSTEM DOMAIN</span>
                        <div class="hero-domain-pill" style="color: ${activeColor};">
                            <i class="${goalData.icon}"></i> 
                            <span>${goalData.domain}</span>
                        </div>
                    </div>
    
                    <h2 class="hero-title">${goalData.title}</h2>
                    
                    <div class="hero-desc-box">
                        <div class="hero-desc-accent"></div>
                        <p class="hero-desc-text">${goalData.goal}</p>
                    </div>
                    
                    <!-- System Config aligned below description -->
                    <div id="system-config-container">
                        <span class="sys-config-label">SYSTEM CONFIGURATION</span>
                        <div id="sys-pill-stack"></div>
                    </div>
                </div>`;
            
            // D. Force Reflow & Fade In
            void backFace.offsetWidth; 
            backFace.style.opacity = '1';
            
        }, 400); // Wait for fade-out
        
    }, 800); // Hold time
}

function restoreMonolithContent(cardWrapper) {
    const backFace = cardWrapper.querySelector('.flip-card-back');
    if (!backFace) return;
    const originalIcon = cardWrapper.dataset.originalIcon || 'fas fa-cube';
    
    backFace.style.opacity = '0';
    setTimeout(() => {
        backFace.innerHTML = `
            <div class="card-texture-overlay"></div>
            <div class="monolith-content">
                <div class="monolith-icon-circle"><i class="${originalIcon} monolith-icon"></i></div>
                <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1">STRUCTURED SPECULATION</div>
            </div>`;
        backFace.style.opacity = '1';
    }, 150);
}

function injectPillToHero(type, value, icon) {
    const stack = document.getElementById('sys-pill-stack');
    if(!stack) return;
    const existing = stack.querySelector(`[data-type="${type}"]`);
    if(existing) existing.remove();

    const pill = document.createElement('div');
    pill.className = 'system-pill-display shadow-sm'; 
    pill.setAttribute('data-type', type);
    pill.title = "Click to Edit";
    
    pill.style.cssText = `display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.4rem 1rem 0.4rem 0.4rem; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255,255,255,0.5); border-radius: 50px; margin-bottom: 0.5rem; cursor: pointer; backdrop-filter: blur(4px);`;
    
    pill.onclick = () => {
        const stepIndex = State.steps.findIndex(s => s.id === type);
        if (stepIndex !== -1) window.jumpToStep(stepIndex);
    };

    let dispValue = value.length > 25 ? value.substring(0, 22) + '...' : value;
    pill.innerHTML = `
        <div class="icon-box" style="width: 28px; height: 28px; border-radius: 50%; background: var(--active-theme-color, #333); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;"><i class="fas ${icon}"></i></div>
        <div style="display: flex; flex-direction: column; line-height: 1.1;"><span style="font-size: 0.55rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; color: #64748b; margin-bottom: 1px;">${type}</span><span class="value-text" style="font-size: 0.8rem; font-weight: 700; color: #1e293b;">${dispValue}</span></div>`;
    stack.appendChild(pill);
}

// =============================================================================
// 8. BOOTSTRAP (Init)
// =============================================================================

function renderNewGoals(goals, gridElement) {
    // 1. Clear Grid
    gridElement.innerHTML = '';
    
    // 2. Iterate & Build
    goals.forEach((goal, index) => {
        const hue = goal.color_hue || (index * 60) % 360;
        const cardId = `goal-${index}`;
        const cardWrapper = document.createElement('div');
        
        // Base Classes - Add 'violation' class if non-compliant
        cardWrapper.className = `flip-card-wrapper ${!goal.is_compliant ? 'violation' : ''}`;
        
        // Data Attributes for Logic
        cardWrapper.dataset.cardId = cardId;
        cardWrapper.dataset.cardTitle = goal.title;
        cardWrapper.dataset.colorHue = hue;
        cardWrapper.dataset.goalIndex = index;
        
        // Visual Gradients (Use backend values or generate fallbacks)
        const cardGrad = goal.card_gradient || `linear-gradient(135deg, hsl(${hue}, 70%, 50%), hsl(${hue + 30}, 80%, 40%))`;
        const plateGrad = goal.plate_gradient || `linear-gradient(135deg, hsl(${hue}, 70%, 60%), hsl(${hue}, 70%, 50%))`;
        const btnGrad = goal.btn_gradient || `linear-gradient(to right, hsl(${hue}, 70%, 50%), hsl(${hue}, 80%, 40%))`;
        const iconColor = goal.icon_color || '#fff';

        // Inner HTML Construction
        cardWrapper.innerHTML = `
            <div class="flip-card-inner">
                
                <!-- BACK FACE (Monolith) -->
                <div class="flip-card-back" style="background: ${!goal.is_compliant ? '#2c3e50' : cardGrad};">
                    <div class="card-texture-overlay"></div>
                    <div class="monolith-content">
                        <div class="monolith-icon-circle">
                            <i class="${goal.icon} monolith-icon"></i>
                        </div>
                        
                        ${!goal.is_compliant 
                            ? `<!-- VIOLATION STATE -->
                               <div class="d-flex flex-column align-items-center mt-4 fade-in">
                                 <i class="fas fa-ban text-danger fa-2x mb-3"></i>
                                 <div class="badge bg-danger text-white border border-white border-opacity-50 font-data px-4 py-2" 
                                      style="font-size: 0.8rem; letter-spacing: 2px;">
                                      PROTOCOL VIOLATION
                                 </div>
                                 <div class="text-white-50 font-body x-small mt-2 text-center px-4">
                                    Safety constraints active.
                                 </div>
                               </div>` 
                            : `<!-- VALID STATE -->
                               <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1 mt-3">
                                   STRUCTURED SPECULATION
                               </div>`
                        }
                    </div>
                </div>
                
                <!-- FRONT FACE (Goal Details) -->
                <div class="flip-card-front">
                     <div class="card-header-plate" style="background: ${plateGrad};">
                         <div class="card-texture-overlay"></div>
                         <div class="card-domain-badge-large">${(goal.domain || 'GENERAL').toUpperCase()}</div>
                         <div class="card-icon-float-large">
                            <i class="${goal.icon}" style="color: ${iconColor};"></i>
                         </div>
                     </div>
                     
                     <div class="card-body-large">
                         <h3 class="card-title-large">${goal.title}</h3>
                         <p class="card-desc-large">${goal.goal}</p>
                     </div>
                     
                     <div class="card-footer-large">
                         <button type="button" class="btn-select-pill-large" 
                                 style="background: ${!goal.is_compliant ? '#94a3b8' : btnGrad}; ${!goal.is_compliant ? 'cursor: not-allowed; opacity: 0.8;' : ''}">
                             ${!goal.is_compliant ? '<i class="fas fa-lock me-2"></i> RESTRICTED' : 'CHOOSE GOAL'}
                         </button>
                     </div>
                </div>
            </div>
            
            <!-- Pill Dock (Used for animations) -->
            <div class="system-pill-dock position-absolute top-0 start-0 w-100 p-4 d-flex flex-column gap-2" style="z-index: 5; pointer-events: none;"></div>
        `;
        
        // 3. Attach Event Listeners
        // Only attach click events if it is COMPLIANT
        if (goal.is_compliant) {
            const btn = cardWrapper.querySelector('.btn-select-pill-large');
            
            // Primary Button Click
            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card wrapper bubbling
                    window.selectGoal(cardWrapper);
                });
            }
            
            // Fallback Wrapper Click
            // (Handled via delegation in init, but added here for safety if DOM is replaced)
            cardWrapper.onclick = () => window.selectGoal(cardWrapper);
        } else {
            // Violation Click Feedback (Shake effect)
            cardWrapper.onclick = () => {
                cardWrapper.classList.add('animate-shake'); // Assuming you have a shake animation class
                setTimeout(() => cardWrapper.classList.remove('animate-shake'), 500);
            };
        }
        
        // 4. Mount to Grid
        gridElement.appendChild(cardWrapper);
    });
    
    // 5. Re-init Navigation Dots (if present in footer)
    if (typeof initFooterDots === 'function') initFooterDots();
}

function initFooterDots() {
    const dots = document.querySelectorAll('.trinity-dot');
    const goals = window.GOAL_COLOR_DATA || [];
    dots.forEach((dot, idx) => {
        const goal = goals[idx];
        if (goal) {
            let color = goal.accent_color;
            if (!color && goal.color_hue !== undefined) color = `hsl(${goal.color_hue}, 70%, 50%)`;
            dot.style.setProperty('--dot-color', color || '#cbd5e1');
            dot.title = `Switch to: ${goal.title}`; 
            dot.onclick = (e) => { e.stopPropagation(); handleFooterDotClick(idx); };
            dot.style.display = 'inline-block';
        } else {
            dot.style.display = 'none';
        }
    });
}

function handleFooterDotClick(index) {
    const targetCardId = `goal-${index}`;
    const targetCard = document.querySelector(`[data-card-id="${targetCardId}"]`);
    if (!targetCard) return;
    if (State.selectedCardData && State.selectedCardData.id === targetCardId && State.phase === 'CONFIG') return; 
    updateActiveDot(index);
    if (State.phase === 'CONFIG') {
        window.exitStage();
        setTimeout(() => handleCardClick(targetCard), 850);
    } else {
        handleCardClick(targetCard);
    }
}

function updateActiveDot(index) {
    document.querySelectorAll('.trinity-dot').forEach(d => d.classList.remove('active'));
    if (index !== null && index !== undefined) {
        document.querySelector(`.trinity-dot[data-index="${index}"]`)?.classList.add('active');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('[SSPEC] Goal Selection Module Initialized');
    
    // 1. Setup Event Delegation (The Fix for Clickability)
    const gridContainer = document.getElementById('goalCardsContainer');
    
    if(gridContainer) {
        gridContainer.addEventListener('click', (e) => {
            // Check if we clicked the button (or icon inside it)
            const btn = e.target.closest('.btn-select-pill-large');
            const wrapper = e.target.closest('.flip-card-wrapper');
            
            if (btn && wrapper) {
                e.stopPropagation(); // Stop bubbling
                console.log("Button Click Detected via Delegation");
                if (wrapper.classList.contains('violation')) return;
                
                handleCardClick(wrapper);
                return;
            }
            
            // Allow card body click as fallback
            if (wrapper && !btn) {
                if (wrapper.classList.contains('violation')) return;
                handleCardClick(wrapper);
            }
        });
    }
    
    // 2. Cache Original Icons (Critical for the "Returning" animation)
    const existingCards = document.querySelectorAll('.flip-card-wrapper');
    existingCards.forEach(card => {
        const iconEl = card.querySelector('.monolith-icon');
        if (iconEl) card.dataset.originalIcon = iconEl.className;
    });

    // 3. START THE ENGINE (This was missing!)
    // This removes 'opacity: 0' and triggers the dealt animation
    transitionTo('DEALING');
    
    // 4. Initialize Navigation Dots
    initFooterDots();

    // 5. Bind "Generate New Goals" Button
    const newSpeculateBtn = document.getElementById('generate-new-goals');
    if (newSpeculateBtn) {
        // Clone to remove old listeners (safety)
        const clone = newSpeculateBtn.cloneNode(true);
        newSpeculateBtn.parentNode.replaceChild(clone, newSpeculateBtn);
        
        clone.addEventListener('click', async () => {
            const display = document.querySelector('.user-input-display');
            const edit = document.querySelector('.user-input-edit');
            const grid = document.getElementById('goalCardsContainer');
            
            let text = "";
            if (display && !display.classList.contains('d-none')) {
                text = display.innerText.replace(/^"|"$/g, '').trim(); 
            } else if (edit) {
                text = edit.value.trim();
            }

            if (text) {
                showLoadingSpinner('Analysing Trajectories...', 'fa-sync-alt');
                try {
                    const data = await regenerateGoals(text);
                    if (data && data.goals) {
                        State.colorData = data.goals;
                        window.GOAL_COLOR_DATA = data.goals;
                        renderNewGoals(data.goals, grid);
                        
                        State.phase = 'INIT';
                        State.selectedCardId = null;
                        setTimeout(() => transitionTo('DEALING'), 50);
                    }
                } catch (error) { 
                    console.error("Failed to regenerate goals:", error); 
                } finally { 
                    hideLoadingSpinner(); 
                }
            }
        });
    }
});

üß© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER: SYSTEM IDENTITY -->
            <div class="ce-modal-header">
                <div class="node-icon-box"><i class="{{ node_info.icon }}"></i></div>
                <div class="header-text-block ms-3 flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="modal-title ce-title mb-0 text-white leading-tight">{{ ceType.replace('_', ' ').upper() }}</h2>
                            <div class="ce-header-metadata text-white opacity-75 small">// {{ phase_name.upper() }} PHASE <span class="mx-2">|</span> ID: {{ ceId.split('-')[0].upper() }}</div>
                        </div>
                        <!-- INTELLIGENCE BUTTON -->
                        <div class="d-flex gap-2">
                             <button class="btn btn-glass font-data d-none d-md-flex align-items-center gap-2" id="speculate-sidebar-toggle">
                                <i class="fas fa-brain"></i> ENGINE
                            </button>
                            <div class="vr bg-white opacity-50 mx-2" style="height: 24px;"></div>
                            <button type="button" class="btn-close-custom" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <div class="header-ghost-icon"><i class="{{ node_info.icon }}"></i></div>
            </div>

            <!-- MICRO-TIMELINE (THE 4 QUADRANTS) -->
            <div class="ce-micro-timeline bg-white border-bottom px-4 py-2">
                <div class="row align-items-center g-0">
                    <div class="col-auto me-3 font-data small text-muted tracking-widest">EXECUTION PROTOCOL:</div>
                    <div class="col">
                        <div class="d-flex w-100 gap-1">
                            <div class="milestone-segment active" id="ms-q1"><div class="ms-bar"></div><span class="ms-label">DEFINITION</span></div>
                            <div class="milestone-segment" id="ms-q2"><div class="ms-bar"></div><span class="ms-label">ALIGNMENT</span></div>
                            <div class="milestone-segment" id="ms-q3"><div class="ms-bar"></div><span class="ms-label">EVIDENCE</span></div>
                            <div class="milestone-segment" id="ms-q4"><div class="ms-bar"></div><span class="ms-label">VALIDATION</span></div>
                        </div>
                    </div>
                    <div class="col-auto ms-3">
                        <span class="badge rounded-pill bg-light text-dark border" id="milestone-status">Q1: DRAFTING</span>
                    </div>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex">
                
                <!-- LEFT COLUMN -->
                <div class="ce-main-column">
                    <!-- NAVIGATION -->
                    <ul class="nav nav-tabs ce-nav-tabs pt-2 px-4 bg-white" role="tablist">
                        <li class="nav-item"><button class="nav-link font-data active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">OVERVIEW</button></li>
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <li class="nav-item"><button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-{{ collection }}-{{ ceId }}">{{ collection|upper }} <span class="badge rounded-pill bg-light text-dark border ms-1 count-badge" data-collection="{{ collection }}">0</span></button></li>
                        {% endfor %}
                        <li class="nav-item ms-auto"><button class="nav-link font-data text-muted" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i></button></li>
                    </ul>

                    <div class="ce-app-content tab-content bg-surface-screen">
                        
                        <!-- 1. OVERVIEW DASHBOARD (Bento) -->
                        <div class="tab-pane fade show active p-4" id="view-overview-{{ ceId }}">
                            <div class="row g-4 h-100">
                                
                                <!-- HERO: Editable Narrative Context -->
                                <div class="col-lg-8 d-flex flex-column">
                                    <div class="system-hero-card flex-grow-1 p-0 position-relative overflow-hidden">
                                        <div class="scan-line" style="opacity:0;"></div> 
                                        <div class="hero-ghost-icon"><i class="{{ node_info.icon }}"></i></div>

                                        <div class="d-flex flex-column h-100 position-relative z-2">
                                            <div class="p-4 pb-0 d-flex justify-content-between align-items-start">
                                                <div class="font-data text-white-50 small letter-spacing-2">STRATEGIC CONTEXT</div>
                                                
                                                <!-- BRANDING FIX: SPECULATE -->
                                                <button class="btn btn-sm btn-glass text-white btn-enhance-field" data-field="summary">
                                                    <i class="fas fa-brain me-2"></i> SPECULATE
                                                </button>
                                            </div>
                                            
                                            <!-- The Editable Area -->
                                            <div class="flex-grow-1 p-4">
                                                <form id="narrative-form-{{ ceId }}" class="h-100">
                                                    <textarea name="summary" 
                                                              class="form-control bg-transparent border-0 text-white font-body fs-5 h-100 p-0 shadow-none hero-textarea" 
                                                              style="resize: none; line-height: 1.6;" 
                                                              placeholder="Describe the strategic function of this node..."
                                                    >{{ ce_data.data.details_data.get('summary', '') }}</textarea>
                                                </form>
                                            </div>
                                            
                                            <!-- Footer -->
                                            <div class="px-4 py-3 bg-black bg-opacity-10 border-top border-white border-opacity-10 d-flex align-items-center gap-3">
                                                 <i class="fas fa-info-circle text-white-50"></i>
                                                 <span class="font-data small text-white-50">Direct input overrides generative model.</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Source COS -->
                                    <div class="mt-4 card border-0 shadow-sm">
                                        <div class="card-body p-4">
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-crosshairs text-secondary"></i>
                                                <span class="font-data text-muted small">SOURCE REQUIREMENT</span>
                                            </div>
                                            <div class="font-body fst-italic text-dark">{{ cos_content_with_pills | safe }}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT METRICS -->
                                <div class="col-lg-4 d-flex flex-column gap-3">
                                    <!-- Confidence -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center p-4">
                                            <span class="font-data text-muted small">COMPLETION CONFIDENCE</span>
                                            <div class="display-3 font-brand text-dark my-2" id="confidence-score-display">0%</div>
                                            <!-- Sparkline -->
                                            <div class="d-flex justify-content-center gap-1 opacity-50" style="height: 10px;">
                                                <div class="bg-success w-1 rounded" style="height:40%"></div>
                                                <div class="bg-success w-1 rounded" style="height:60%"></div>
                                                <div class="bg-success w-1 rounded" style="height:30%"></div>
                                                <div class="bg-success w-1 rounded" style="height:80%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logic Stream -->
                                    <div class="card border-0 shadow-sm flex-grow-1">
                                        <div class="card-header bg-white border-bottom">
                                            <span class="font-data small text-danger"><i class="fas fa-bolt me-2"></i>CRITICAL SIGNALS</span>
                                        </div>
                                        <div class="card-body p-0 position-relative overflow-y-auto" id="overview-logic-stream" style="max-height: 200px;">
                                            <!-- Injected via JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLLECTIONS -->
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                             <!-- Toolbar -->
                             <div class="px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-white font-data px-4 btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-2"></i> MANUAL</button>
                                    <!-- BRANDING FIX: SPECULATE -->
                                    <button class="btn btn-white font-data px-4 text-primary btn-speculate-collection" data-collection="{{ collection }}">
                                        <i class="fas fa-brain me-2"></i> SPECULATE
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm w-auto font-body" placeholder="Filter...">
                            </div>
                            <div class="flex-grow-1 p-4 overflow-y-auto collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}"></div>
                             
                             <!-- Dynamic Editor -->
                             <div class="collection-editor p-4 bg-white border-top shadow-lg position-absolute bottom-0 w-100" id="editor-{{ collection }}-{{ ceId }}" style="display:none; z-index: 50;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="font-brand mb-0">EDIT {{ collection[:-1]|upper }}</h5>
                                    <button type="button" class="btn-close btn-cancel-edit"></button>
                                </div>
                                <form class="editor-form" data-collection="{{ collection }}">
                                    {% set schema = node_info.get(collection[:-1] + '_schema', []) %}
                                    <div class="row g-3">
                                        {% for field in schema %}
                                        <div class="col-12 {{ 'col-md-6' if field.type != 'textarea' else '' }}">
                                            <label class="font-data text-muted small mb-1">{{ field.label }}</label>
                                            {% if field.type == 'textarea' %}<textarea name="{{ field.key }}" class="form-control bg-light" rows="2"></textarea>
                                            {% elif field.type == 'select' %}<select name="{{ field.key }}" class="form-select font-body">{% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}</select>
                                            {% elif field.type == 'slider' %}<div class="ce-range-wrap"><input type="range" class="ce-range-input" name="{{ field.key }}" min="0" max="100" step="10"><span class="ce-range-value">50%</span></div>
                                            {% elif field.type == 'toggle' %}<div class="mt-2"><label class="ce-toggle-switch"><input type="checkbox" name="{{ field.key }}"><span class="ce-toggle-slider"></span></label></div>
                                            {% else %}<input type="text" name="{{ field.key }}" class="form-control">{% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-4 text-end"><button type="submit" class="btn btn-success font-data px-4 rounded-pill">SAVE ENTRY</button></div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- CONNECTIONS -->
                        <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                            <div class="text-center p-5 text-muted"><i class="fas fa-project-diagram fa-3x mb-3 opacity-25"></i><h5 class="font-brand">VECTOR MAP</h5><p class="small">No connections yet.</p></div>
                        </div>

                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column border-start bg-white">
                    <div class="sidebar-persona-header" id="ai-sidebar-header"></div>
                    <div class="p-3 flex-grow-1 overflow-y-auto" id="ai-sidebar-content"></div>
                </div>

            </div>
            <!-- FOOTER -->
            <div class="modal-footer ce-modal-footer"><div class="font-data text-muted small me-auto" id="save-status">STATUS: UNSAVED</div><div class="d-flex gap-2"><button class="btn btn-outline-secondary rounded-pill px-4 font-data" data-bs-dismiss="modal">EXIT</button><button class="btn btn-primary rounded-pill px-4 font-data btn-save-changes">SAVE {{ ceType.upper() }}</button></div></div>
        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    
    # --- CRITICAL FIX: Ensure ID is a string before template rendering ---
    # Handle UUID objects or None types safely
    raw_id = ce_data.get('id', 'new_ce')
    safe_ce_id = str(raw_id) if raw_id else 'new_ce'

    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=safe_ce_id,  # Use the safe string version
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

üü® utilities.py:
# utilities.py
import re
import json
import logging
import hashlib
import uuid
from datetime import date
from bs4 import BeautifulSoup
from flask import current_app
from typing import Dict, List, Tuple, Optional, Any
from dateutil.relativedelta import relativedelta

# --- EXTERNAL SERVICES ---
# We rely on ai_service for the raw LLM/Image calls to keep this file clean.
from ai_service import generate_chat_response, get_grounded_data, generate_image as service_generate_image

# --- CONFIGURATION ---
from ce_nodes import NODES, get_valid_node_types
from system_nodes import SYSTEM_NODES, get_valid_system_types

# --- LOGGING ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# ==============================================================================
# SECTION 1: VISUAL SYSTEM (Colors & Phases)
# ==============================================================================
# These semantic anchors ensure the UI feels deterministic and structured.

PHASE_COLORS = {
    0: { 'name': 'Discovery', 'hue': 187, 'saturation': 0.72, 'lightness': 0.58, 'hex': '#17a2b8', 'hex_light': '#4dd0e1', 'hex_dark': '#00838f', 'semantic': 'exploration' },
    1: { 'name': 'Engagement', 'hue': 262, 'saturation': 0.52, 'lightness': 0.47, 'hex': '#6f42c1', 'hex_light': '#9575cd', 'hex_dark': '#512da8', 'semantic': 'connection' },
    2: { 'name': 'Action', 'hue': 24, 'saturation': 0.85, 'lightness': 0.54, 'hex': '#e8590c', 'hex_light': '#ff8a50', 'hex_dark': '#bf360c', 'semantic': 'execution' },
    3: { 'name': 'Completion', 'hue': 145, 'saturation': 0.63, 'lightness': 0.42, 'hex': '#28a745', 'hex_light': '#66bb6a', 'hex_dark': '#1b5e20', 'semantic': 'achievement' },
    4: { 'name': 'Legacy', 'hue': 340, 'saturation': 0.65, 'lightness': 0.50, 'hex': '#d63384', 'hex_light': '#f06292', 'hex_dark': '#ad1457', 'semantic': 'impact' }
}

def text_to_phase_index(text: str) -> int:
    """Deterministically maps any string to a Phase Index (0-4)."""
    if not text: return 0
    hash_obj = hashlib.md5(text.lower().strip().encode('utf-8'))
    return int(hash_obj.hexdigest()[:8], 16) % 5

def get_phase_anchor(text: str) -> Dict:
    """Returns the Semantic Color Data for a given string."""
    idx = text_to_phase_index(text)
    return { 'index': idx, **PHASE_COLORS[idx] }

def hsl_to_hex(h: float, s: float, l: float) -> str:
    """Converts HSL values to a HEX string."""
    h_norm = (h % 360) / 360.0
    if s == 0: return '#{:02x}{:02x}{:02x}'.format(int(l*255), int(l*255), int(l*255))
    def hue_to_rgb(p, q, t):
        if t < 0: t += 1
        if t > 1: t -= 1
        if t < 1/6: return p + (q - p) * 6 * t
        if t < 1/2: return q
        if t < 2/3: return p + (q - p) * (2/3 - t) * 6
        return p
    q = l * (1 + s) if l < 0.5 else l + s - l * s
    p = 2 * l - q
    r = int(hue_to_rgb(p, q, h_norm + 1/3) * 255)
    g = int(hue_to_rgb(p, q, h_norm) * 255)
    b = int(hue_to_rgb(p, q, h_norm - 1/3) * 255)
    return '#{:02x}{:02x}{:02x}'.format(r, g, b)

def generate_near_harmonic(phase: Dict, seed: str = '') -> Dict:
    """Generates a cohesive secondary color."""
    base_hue, base_sat, base_light = phase['hue'], phase['saturation'], phase['lightness']
    seed_hash = int(hashlib.md5(seed.encode()).hexdigest()[:4], 16) if seed else 1234
    
    hue_offset = 20 + (seed_hash % 21)
    hue_dir = 1 if (seed_hash % 2) == 0 else -1
    new_hue = (base_hue + (hue_offset * hue_dir)) % 360
    new_sat = min(1.0, base_sat * (0.60 + ((seed_hash % 21) / 100)))
    new_light = min(0.85, base_light + (0.05 + ((seed_hash % 11) / 100)))
    
    return {
        'role': 'near_harmonic', 'hue': new_hue, 'saturation': new_sat, 'lightness': new_light,
        'hex': hsl_to_hex(new_hue, new_sat, new_light),
        'hex_light': hsl_to_hex(new_hue, new_sat * 0.7, min(0.92, new_light + 0.15)),
        'hex_dark': hsl_to_hex(new_hue, min(1.0, new_sat * 1.1), max(0.25, new_light - 0.18))
    }

def generate_distant_harmonic(phase: Dict, seed: str = '') -> Dict:
    """Generates a contrasting tertiary color."""
    base_hue, base_sat, base_light = phase['hue'], phase['saturation'], phase['lightness']
    seed_hash = int(hashlib.md5(seed.encode()).hexdigest()[:4], 16) if seed else 5678
    
    hue_offset = 90 + (seed_hash % 51)
    hue_dir = 1 if (seed_hash % 3) != 0 else -1
    new_hue = (base_hue + (hue_offset * hue_dir)) % 360
    new_sat = min(base_sat, base_sat * (0.70 + ((seed_hash % 31) / 100)))
    new_light = max(0.30, base_light - (0.05 + ((seed_hash % 8) / 100)))
    
    return {
        'role': 'distant_harmonic', 'hue': new_hue, 'saturation': new_sat, 'lightness': new_light,
        'hex': hsl_to_hex(new_hue, new_sat, new_light),
        'hex_light': hsl_to_hex(new_hue, new_sat * 0.7, min(0.90, new_light + 0.18)),
        'hex_dark': hsl_to_hex(new_hue, min(1.0, new_sat * 1.1), max(0.22, new_light - 0.15))
    }

def assign_goal_colors(goals: List[Dict]) -> List[Dict]:
    """Applies the harmonic color system to a list of Goals."""
    if not goals: return goals
    anchor_title = goals[0].get('title', 'default')
    phase_anchor = get_phase_anchor(anchor_title)
    
    current_app.logger.info(f"Phase Anchor: '{anchor_title}' ‚Üí {phase_anchor['name']} (Hue {phase_anchor['hue']}¬∞)")
    
    near = generate_near_harmonic(phase_anchor, anchor_title + '_n')
    distant = generate_distant_harmonic(phase_anchor, anchor_title + '_d')
    slots = [(phase_anchor, 'phase_anchor'), (near, 'near_harmonic'), (distant, 'distant_harmonic')]
    
    for i, goal in enumerate(goals):
        # Violation Theme Logic
        if not goal.get('is_compliant', True):
            goal.update({
                'color_role': 'violation', 'color_hue': 0, 'icon_color': '#b71c1c',
                'card_gradient': 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 50%, #b71c1c 100%)',
                'plate_gradient': 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%)',
                'btn_gradient': 'linear-gradient(to right, #ef5350 0%, #c62828 100%)'
            })
            continue
            
        c, role = slots[i % 3]
        goal.update({
            'color_role': role, 'color_hue': c['hue'], 'icon_color': c['hex_dark'],
            'card_gradient': f"linear-gradient(135deg, {c['hex_light']} 0%, {c['hex']} 50%, {c['hex_dark']} 100%)",
            'plate_gradient': f"linear-gradient(135deg, {c['hex_light']} 0%, {c['hex']} 100%)",
            'btn_gradient': f"linear-gradient(to right, {c['hex']} 0%, {c['hex_dark']} 100%)",
            'accent_color': c['hex']
        })
    return goals

# ==============================================================================
# SECTION 2: DYNAMIC TEXT ENGINE (The "Magic Parsing" Logic)
# ==============================================================================

def get_system_pill_color(sys_type: str, phase_index: Optional[int] = None) -> Dict[str, str]:
    config = SYSTEM_NODES.get(sys_type, SYSTEM_NODES.get('CUSTOM', {}))
    default = config.get('color', '#64748b')
    
    if phase_index is not None and phase_index in PHASE_COLORS:
        phase = PHASE_COLORS[phase_index]
        sys_hue = (phase['hue'] + 30) % 360
        sys_hex = hsl_to_hex(sys_hue, phase['saturation'] * 0.7, phase['lightness'] + 0.1)
        sys_dark = hsl_to_hex(sys_hue, phase['saturation'] * 0.85, phase['lightness'] - 0.1)
        return {'background': sys_hex, 'border': sys_dark, 'icon_color': '#ffffff', 'text': sys_dark}
    
    return {'background': default, 'border': default, 'icon_color': '#ffffff', 'text': default}

def get_ce_pill_color(ce_type: str, phase_index: Optional[int] = None) -> Dict[str, str]:
    config = NODES.get(ce_type, NODES.get('Default', {}))
    default = config.get('color', '#6c757d')
    
    if phase_index is not None and phase_index in PHASE_COLORS:
        phase = PHASE_COLORS[phase_index]
        ce_hue = (phase['hue'] + 150) % 360
        ce_hex = hsl_to_hex(ce_hue, phase['saturation'] * 0.8, phase['lightness'] + 0.05)
        ce_dark = hsl_to_hex(ce_hue, phase['saturation'] * 0.9, phase['lightness'] - 0.15)
        return {'background': ce_hex, 'icon_color': ce_dark}
        
    return {'background': default, 'icon_color': default}

def replace_ce_tags_with_pills(content: str, phase_index: Optional[int] = None) -> str:
    """Parses <ce> tags into interactive pills for the dashboard."""
    if not content: return ""
    soup = BeautifulSoup(str(content), 'html.parser')
    for tag in soup.find_all('ce'):
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        colors = get_ce_pill_color(ce_type, phase_index)
        icon_cls = NODES.get(ce_type, NODES['Default']).get('icon', 'fa-cube')
        
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-capsule',
            'data-ce-id': tag.get('id', ''),
            'data-ce-type': ce_type,
            'style': f"--node-color: {colors['background']}; --node-icon-color: {colors['icon_color']};"
        })
        icon = soup.new_tag('i', attrs={'class': icon_cls})
        new_tag.append(icon)
        new_tag.append(soup.new_string(ce_text))
        tag.replace_with(new_tag)
    return str(soup)

def replace_sys_tags_with_highlights(content: str, phase_index: Optional[int] = None, system_data: Optional[Dict] = None) -> str:
    """
    Parses <sys> tags. 
    **CRITICAL**: If `system_data` is provided, it dynamically overrides the tag's text 
    with the live value from the database.
    """
    if not content: return ""
    soup = BeautifulSoup(str(content), 'html.parser')
    for tag in soup.find_all('sys'):
        sys_type = tag.get('type', 'CUSTOM').upper()
        
        # --- DYNAMIC INJECTION ---
        if system_data and sys_type in system_data and system_data[sys_type]:
            sys_text = str(system_data[sys_type])
        else:
            sys_text = tag.get_text()
        # -------------------------

        colors = get_system_pill_color(sys_type, phase_index)
        config = SYSTEM_NODES.get(sys_type, SYSTEM_NODES.get('CUSTOM', {}))
        
        wrapper = soup.new_tag('span', attrs={
            'class': 'sys-highlight',
            'data-type': sys_type,
            'title': f"{config.get('label', sys_type)}: {sys_text}",
            'style': f"--sys-color: {colors['background']}; --sys-border: {colors['border']};"
        })
        
        icon_span = soup.new_tag('span', attrs={'class': 'sys-highlight-icon'})
        icon_span.append(soup.new_tag('i', attrs={'class': config.get('icon', 'fa-tag')}))
        wrapper.append(icon_span)
        
        text_span = soup.new_tag('span', attrs={'class': 'sys-highlight-text'})
        text_span.string = sys_text
        wrapper.append(text_span)
        
        tag.replace_with(wrapper)
        
    return str(soup)

def format_ssol_text(content: str, phase_index: Optional[int] = None, system_data: Optional[Dict] = None) -> str:
    """
    The master formatter used by routes.py.
    Orchestrates both System Highlight injection and CE Pill rendering.
    """
    step_one = replace_sys_tags_with_highlights(content, phase_index, system_data)
    final_output = replace_ce_tags_with_pills(step_one, phase_index)
    return final_output

# ==============================================================================
# SECTION 3: THE SPECULATE ENGINE (AI Wrappers)
# ==============================================================================

async def generate_goal(user_input: str) -> List[Dict]:
    """
    Generates high-level goal options with visual themes.
    """
    prompt = f"""
    Generate 3 distinct high-level goal options for input: '{user_input}'.
    Return JSON array of objects: {{ "domain": "String", "title": "String", "goal": "String", "icon": "fa-solid class", "is_compliant": Boolean }}
    Strict JSON. No Markdown.
    """
    try:
        resp = await generate_chat_response(
            [{"role": "user", "content": prompt}], 
            "user", "goal gen", 
            generation_config={"response_mime_type": "application/json"}
        )
        cleaned = re.sub(r"```(?:json)?|```", "", resp).strip()
        data = json.loads(cleaned)
        goals = data if isinstance(data, list) else data.get('goals', [])
        return assign_goal_colors(goals)
    except Exception as e:
        current_app.logger.error(f"Goal Gen Error: {e}")
        return []

async def generate_outcome_data(ssol_title, ssol_description, domain, forced_constraints=None):
    """
    The Core Engine. Generates the structured phases and content.
    Includes the 'Attenuation Layer' (System Physics).
    """
    from system_nodes import SYSTEM_NODES 

    constraint_block = []
    
    if forced_constraints:
        constraint_block.append("\n*** SYSTEM PHYSICS (ATTENUATION LAYER) ***")
        constraint_block.append("The user has explicitly defined the following constraints. You MUST adhere to them:")
        
        for key, value in forced_constraints.items():
            if not value: continue
            
            # Look for specific Prompt Injection logic
            node_config = SYSTEM_NODES.get(key, {})
            injection_template = node_config.get('prompt_injection')
            
            if injection_template:
                try:
                    formatted_instruction = injection_template.format(value=value)
                    constraint_block.append(f"- {formatted_instruction}")
                except:
                    constraint_block.append(f"- {key}: {value}")
            else:
                constraint_block.append(f"- {key}: {value}")

    constraint_text = "\n".join(constraint_block)

    prompt = f"""
    IDENTITY: SPECULATE ENGINE. Reverse-Engineer a 100% completed future.
    INPUT: Title: '{ssol_title}', Context: {ssol_description}, Domain: '{domain}'
    
    {constraint_text}
    
    PHASE 1: EXEC CHARTER. Write a summary using <sys type="TYPE">Value</sys> tags for anchors.
    PHASE 2: ROADMAP. 5 Phases (Discovery, Engagement, Action, Completion, Legacy). 
    3-5 COS per phase. Embed <ce type="Type">Label</ce> tags.
    Valid CEs: {', '.join(get_valid_node_types())}
    
    RETURN JSON: {{ "ssolsummary": "html...", "system_params": {{...}}, "phases": {{ "Discovery": ["cos..."], ... }} }}
    """
    
    try:
        resp = await generate_chat_response(
            [{"role": "user", "content": prompt}], 
            "user", "speculate engine", 
            temperature=0.35 # Lower temperature for logic
        )
        clean = re.sub(r"```(?:json)?|```", "", resp).strip()
        return json.loads(clean)
    except Exception as e:
        current_app.logger.error(f"Speculate Error: {e}")
        # Fallback Structure to prevent crash
        return {
            "ssolsummary": "<p>Signal interference. Raw input data preserved.</p>",
            "phases": {"Discovery": ["Analyze input failure."], "Action": ["Manual override required."]},
            "system_params": forced_constraints or {}
        }

async def generate_ai_data(node_type, cos_content, ssol_goal, agent_mode='context'):
    """Used by the CE Modal to populate the sidebar insights."""
    if agent_mode == 'speculate':
        return await get_grounded_data(f"Research {node_type} for {ssol_goal}", node_type)
    
    prompt = f"Explain strategic purpose of '{node_type}'. Context: Goal '{ssol_goal}', Req '{cos_content}'. Return JSON {{ 'contextual_description': '...' }}"
    try:
        resp = await generate_chat_response([{"role": "user", "content": prompt}], "user", "insight", generation_config={"response_mime_type": "application/json"})
        return json.loads(resp.replace("```json", "").replace("```", "").strip())
    except: return {}

# ==============================================================================
# SECTION 4: LEGACY & HELPERS
# ==============================================================================

async def generate_image(prompt: str, ssol_id: str):
    """Wrapper to route image requests through ai_service."""
    return await service_generate_image(prompt, ssol_id)

def sanitize_filename(filename: str) -> str:
    """Safe filename generator."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

def calculate_smart_horizon(label: str) -> str:
    """Converts '3 Months' to a Date String."""
    offsets = {"3 Months": 3, "6 Months": 6, "1 Year": 12, "2 Years": 24, "5 Years": 60, "ASAP": 1}
    return (date.today() + relativedelta(months=offsets.get(label, 0))).isoformat()

async def analyze_user_input(text: str) -> List[str]:
    """Extracts keywords from input."""
    try:
        resp = await generate_chat_response([{"role": "user", "content": f'Extract 3 keywords from "{text}". JSON {{ "keywords": [] }}'}], "user", "keywords", generation_config={"response_mime_type": "application/json"})
        return json.loads(resp).get('keywords', [])
    except: return []

async def is_input_compliant(text: str) -> dict:
    """Safety check."""
    try:
        resp = await generate_chat_response([{"role": "user", "content": f'Compliance check: "{text}". JSON {{ "compliant": bool, "reason": str }}'}], "user", "compliance", generation_config={"response_mime_type": "application/json"})
        return json.loads(resp)
    except: return {"compliant": False, "reason": "Error"}

üè≥Ô∏è‚Äçüåà system_nodes.py:
# system_nodes.py
"""
THE SYSTEM PARAMETER MANIFEST (v2026.05 - Spiritual Successor Edition)
------------------------------------
Configuration source for SSPEC System Nodes.
Acts as the bridge between the Frontend Wizard (goal_selection.js) and the Backend Intelligence (utilities.py).

CHANGELOG:
- REBRAND: "Individual Agent" -> "Just Me (Individual)"
- REBRAND: "Bootstrapped ($0)" -> "Sweat Equity (Time > Money)"
- SCALE: "Sphere of Influence" (Ontological approach)
"""

SYSTEM_NODES = {
    # ==============================================================================
    # 0. THE MASTER NODE (The Root Container)
    # ==============================================================================
    "GOAL": {
        "label": "The Future Fulfilled",
        "icon": "fa-solid fa-bullseye",
        "color": "#212121", 
        "description": "The destination as a completed fact.",
        "guide": "Speak from the future. The park IS open. The app IS launched.",
        "ui_type": "textarea",
        "prompt_injection": "PRIME DIRECTIVE ATTENUATION: The user has defined the Future Fulfilled as: '{value}'. All generated content must act as history leading up to this established fact."
    },

    # ==============================================================================
    # 1. CORE CONSTRAINTS (Identity & Time)
    # ==============================================================================
    "OPERATOR": {
        "label": "The Driver",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#03a9f4", 
        "description": "Who is accountable for this outcome?",
        "guide": "The identity of the driver determines available leverage.",
        "ui_type": "select",
        "options": [
            "Just Me (Individual)", 
            "Community / Grassroots", 
            "Small Team / Startup", 
            "Non-Profit / NGO", 
            "Corporate / Enterprise", 
            "Public / Civic Body",
            "Unsure / TBD"
        ],
        "wizard": {
            "question": "Who is Accountable?",
            "helper": "The Engine tailors the plan to your bandwidth. A solo mission needs automation; a team needs coordination.",
            "insight_map": {
                "Just Me (Individual)": "High autonomy, finite bandwidth. We will prioritize leverage, automation, and low-code solutions.",
                "Community / Grassroots": "Powered by enrollment. We will focus on social capital, volunteerism, and shared ownership.",
                "Small Team / Startup": "Optimized for speed. We will structure for agile sprints, rapid iteration, and growth metrics.",
                "Non-Profit / NGO": "Mission-driven. We will focus on grant cycles, stakeholder alignment, and transparency.",
                "Corporate / Enterprise": "Resource-rich but process-heavy. We will account for compliance, security, and integration.",
                "Public / Civic Body": "High authority. We will map regulatory frameworks, procurement, and public mandates.",
                "Unsure / TBD": "The System will analyze the goal's complexity and suggest the optimal vehicle."
            }
        },
        "prompt_injection": "OPERATOR ATTENUATION: The executing agent is defined as: '{value}'. Filter all suggestions to match the capabilities and limitations of this entity type."
    },

    "HORIZON": {
        "label": "Time Horizon",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ff9800", 
        "description": "The date this reality is fully realized.",
        "guide": "Is this a sprint or a marathon?",
        "ui_type": "date", 
        "wizard": {
            "question": "When do we Arrive?",
            "helper": "Deadlines create leverage. The Engine works backwards from this date to tell you what to do today.",
            "quick_selects": ["3 Months", "6 Months", "1 Year", "2 Years", "5 Years", "ASAP"]
        },
        "prompt_injection": "TEMPORAL ATTENUATION: The system has a hard stop at '{value}'. All roadmaps, lead times, and resource acquisitions must mathematically fit within this window."
    },

    # ==============================================================================
    # 2. PHYSICS & LOGISTICS (The Engine)
    # ==============================================================================

    "BUDGET": {
        "label": "Resource Model",
        "icon": "fa-solid fa-bolt", 
        "color": "#4caf50", 
        "description": "The energy source for the project.",
        "ui_type": "select",
        "options": [
            "Sweat Equity (Time > Money)", 
            "Crowdfunded / Backed", 
            "Grant Funded", 
            "Venture Capital", 
            "Public Budget",
            "Undetermined"
        ],
        "wizard": {
            "question": "How is this Fueled?",
            "helper": "Money is just one form of energy. The source determines the speed and the strings attached.",
            "insight_map": {
                "Sweat Equity (Time > Money)": "The Hustle. We will prioritize free tools, barter networks, and organic growth.",
                "Crowdfunded / Backed": "Public mandate. Marketing assets, video storytelling, and community management are critical.",
                "Grant Funded": "Milestone driven. Reporting, impact metrics, and compliance are top priorities.",
                "Venture Capital": "High octane. Focus on rapid scaling, burn rate, and defensible moats.",
                "Public Budget": "Oversight heavy. Procurement, auditing, and RFP processes will be factors.",
                "Undetermined": "The Engine will estimate resource requirements based on the goal scope."
            }
        },
        "prompt_injection": "ECONOMIC ATTENUATION: The project operates on a '{value}' model. Filter resource suggestions to match this economic physics."
    },

    "SCALE": {
        "label": "Sphere of Influence",
        "icon": "fa-solid fa-earth-americas",
        "color": "#3f51b5", 
        "description": "The level of transformation being generated.",
        "ui_type": "select",
        "options": [
            "Personal (Self)", 
            "Interpersonal (Group)", 
            "Organizational (Community)", 
            "Global (World)", 
            "Digital / Universal"
        ],
        "wizard": {
            "question": "What is the Impact?",
            "helper": "Define the scope of transformation you are committed to causing.",
            "insight_map": {
                "Personal (Self)": "Transformation of Self. We will focus on personal integrity, habits, and individual environments.",
                "Interpersonal (Group)": "Transformation of Relationship. We will focus on communication, agreement, and enrolling others.",
                "Organizational (Community)": "Transformation of Community. We will focus on systems, leadership, and collective action.",
                "Global (World)": "Transformation of the World. We will focus on systemic change, paradigms, and universal contribution.",
                "Digital / Universal": "Boundary-less impact. We will focus on scalability, networks, and viral distribution."
            }
        },
        "prompt_injection": """
            ONTOLOGICAL SCALE ATTENUATION: The solution is designed for the '{value}' sphere. 
            If Personal, focus on individual habits/resources. 
            If Group/Community, focus on enrollment and shared agreement. 
            If Global, focus on systemic change and universal paradigms.
        """
    },

    "MODALITY": {
        "label": "Work Style",
        "icon": "fa-solid fa-people-carry-box",
        "color": "#607d8b", 
        "description": "The rhythm of coordination.",
        "ui_type": "select",
        "options": [
            "Agile / Iterative", 
            "Waterfall / Planned", 
            "Swarm / Decentralized", 
            "Crisis Response"
        ],
        "wizard": {
            "question": "How do we Coordinate?",
            "helper": "The rhythm of the team dictates the structure of the plan.",
            "insight_map": {
                "Agile / Iterative": "Build, measure, learn. We will structure via Sprints and feedback loops.",
                "Waterfall / Planned": "Measure twice, cut once. We will structure via Dependencies and sequencing.",
                "Swarm / Decentralized": "Parallel autonomy. We will structure via independent Nodes and shared context.",
                "Crisis Response": "Speed over efficiency. We will structure via Immediate Actions and triage."
            }
        },
        "prompt_injection": "METHODOLOGICAL ATTENUATION: Work is performed using a '{value}' style. Structure Prerequisites and Milestones accordingly."
    },

    # ==============================================================================
    # 3. VALUES & ETHICS (The Filter - Tag Interfaces)
    # ==============================================================================

    "DIRECTIVE": {
        "label": "Non-Negotiables",
        "icon": "fa-solid fa-heart",
        "color": "#9c27b0", 
        "description": "The immutable standards we uphold.",
        "ui_type": "tags", # SIGNALS FRONTEND TO USE PILL INTERFACE
        "wizard": {
            "question": "What are the Core Values?",
            "helper": "Type a value and press Enter (e.g. 'Integrity', 'Open Source', 'Inclusion').",
            "placeholder": "Add a value...",
            "insight_map": {} 
        },
        "prompt_injection": """
            ETHICAL ATTENUATION: The project is strictly bound by these Core Values: [{value}]. 
            Any AI suggestion that conflicts with these standards must be rejected. 
            Prioritize alignment with these values over speed or cost efficiency.
        """
    },

    "AVOIDANCE": { 
        "label": "Dealbreakers",
        "icon": "fa-solid fa-ban", 
        "color": "#ef5350", 
        "description": "Outcomes we must prevent at all costs.",
        "ui_type": "tags", # SIGNALS FRONTEND TO USE PILL INTERFACE
        "wizard": {
            "question": "What must we Avoid?",
            "helper": "Type a risk and press Enter (e.g. 'Debt', 'Displacement', 'Pollution').",
            "placeholder": "Add a risk to avoid...",
            "insight_map": {}
        },
        "prompt_injection": """
            RISK ATTENUATION: The project must specifically avoid: [{value}]. 
            Scan all generated CEs for second-order effects that might trigger these negative outcomes.
        """
    },

    # ==============================================================================
    # 4. THE ARTIFACT
    # ==============================================================================

    "FULFILLMENT": {
        "label": "The Proof",
        "icon": "fa-solid fa-signature",
        "color": "#009688", # Teal
        "description": "The tangible evidence of completion.",
        "ui_type": "text",
        "wizard": {
            "question": "What is the Final Artifact?",
            "helper": "When the dust settles, what physical object proves we finished?",
            "placeholder": "e.g. The Signed Treaty, The Occupied Building...",
            "insight_map": {}
        },
        "prompt_injection": "ARTIFACT ATTENUATION: The final output must be a '{value}'. Reverse-engineer the 'Production' CEs required to manufacture this specific object."
    }
}

def get_valid_system_types():
    """Returns a list of all valid system node keys."""
    return list(SYSTEM_NODES.keys())

def get_system_node_config(key):
    """Safe retrieval of config with fallback."""
    return SYSTEM_NODES.get(key, SYSTEM_NODES['OPERATOR'])

üìÜ models.py:
# models.py
import os
import json
import uuid
from datetime import date
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date, Integer, Float)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()

# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # --- CORE IDENTITY ---
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    
    # --- SCOPE & CONSTRAINTS (The MVP Project Container) ---
    domain = Column(String(100), nullable=True)     # Context for AI (e.g. "Bio-Tech")
    status = Column(String(50), default='Draft')    # Lifecycle (Draft, Active, Paused, Complete)
    owner = Column(String(255), nullable=True)      # The human champion
    target_date = Column(Date, nullable=True)       # The horizon/deadline
    system_data = Column(JsonType, nullable=True, default={})
    
    # --- METRICS ---
    integrity_score = Column(Integer, default=100)  # 0-100 Health Metric
    completion_percentage = Column(Integer, default=0) # Derived from COS completion
    
    # --- RELATIONSHIPS ---
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'domain': self.domain,
            'status': self.status,
            'owner': self.owner,
            'target_date': self.target_date.isoformat() if self.target_date else None,
            'integrity_score': self.integrity_score,
            'completion_percentage': self.completion_percentage,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    
    # --- STATUS TRACKING ---
    status = Column(String(50), nullable=False, default='Proposed') # Proposed, Active, Complete, Verified
    
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE STRATEGIC PAYLOAD ---
    # Stores the complete state of the Speculation Environment.
    # Initializing with all keys ensures the "Fresh Node" check in JS works reliably.
    data = Column(JsonType, nullable=False, default=lambda: {
        "details_data": {}, 
        "prerequisites": [],
        "stakeholders": [], 
        "assumptions": [],
        "resources": [],
        "connections": []
    })

    def to_dict(self):
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data 
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

üü¶ outcome.html:
{% extends 'base.html' %}

{% block content %}

<!-- 1. JINJA LOGIC: Pre-calculate System Stats for visualizers -->
{% set total_ces = 0 %}
{% set active_ces = 0 %}
{% set verified_ces = 0 %}
{% if ssol.phases %}
    {% for phase_name, cos_list in ssol.phases.items() %}
        {% if cos_list %}
            {% for cos in cos_list %}
                {% if cos.conditional_elements %}
                    {% set total_ces = total_ces + cos.conditional_elements|length %}
                    {% for ce in cos.conditional_elements %}
                        {# Check internal data status if available #}
                        {% if ce.data and ce.data.get('status') == 'Active' %}{% set active_ces = active_ces + 1 %}{% endif %}
                        {% if ce.data and ce.data.get('status') == 'Verified' %}{% set verified_ces = verified_ces + 1 %}{% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endif %}

<!-- THE HORIZON WRAPPER (Locked Viewport) -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- MAIN CONSOLE GRID (2-Column Layout) -->
    <div class="row g-0 bg-white" style="height: 100%;">
        
        <!-- ============================================= -->
        <!-- A. LEFT COLUMN: HERO CONSOLE (Fixed Sidebar)  -->
        <!-- ============================================= -->
        <div class="col-lg-3 border-end d-flex flex-column position-relative z-10" 
             style="background: linear-gradient(160deg, #00bcd4 0%, #0097a7 100%); color: white; overflow: hidden; height: 100%;">
            
            <!-- Context Header: UPDATED -->
            <div class="py-3 px-4 d-flex align-items-center justify-content-between" 
                 style="border-bottom: 1px solid rgba(255,255,255,0.2); height: 70px; flex-shrink: 0;">
                <a href="{{ url_for('routes_bp.index') }}" class="text-white text-decoration-none font-data tracking-widest small fw-bold opacity-75 hover-opacity-100 transition-all">
                    <i class="fas fa-chevron-left me-2"></i>RETURN TO GOAL SELECTION
                </a>
                <div class="dropdown">
                    <i class="fas fa-ellipsis-v opacity-50 small cursor-pointer" data-bs-toggle="dropdown"></i>
                    <ul class="dropdown-menu dropdown-menu-dark font-data small">
                        <li><a class="dropdown-item" href="#" onclick="window.print()"><i class="fas fa-print me-2"></i> Print View</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('routes_bp.index') }}"><i class="fas fa-power-off me-2"></i> Exit Session</a></li>
                    </ul>
                </div>
            </div>

            <!-- SCROLLABLE SIDEBAR CONTENT -->
            <div class="p-4 flex-grow-1 d-flex flex-column gap-4 overflow-y-auto custom-scrollbar-dark" style="z-index: 5;">
                
                <!-- 1. Visualization Portal -->
                <div class="image-portal shadow-lg mx-auto position-relative" style="width: 100%; aspect-ratio: 1/1; border: 4px solid rgba(255,255,255,0.8); border-radius: 12px; background: #000;">
                    <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" id="placeholderImage" class="fade-in" style="object-fit: cover; width:100%; height:100%;" alt="System Processing">
                    <img src="" id="ssolImage" class="fade-in" style="opacity: 0; object-fit: cover; width:100%; height:100%; transition: opacity 1s;" alt="Generated Outcome Visualization">
                </div>

                <!-- 2. Hero Identity Block -->
                <div class="text-center">
                    <!-- Domain Pill: UPDATED (Larger) -->
                    <div class="d-inline-flex align-items-center gap-2 px-4 py-2 rounded-pill mb-3 shadow-sm" 
                         style="background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.4);">
                        <i class="{{ ssol.domain_icon }} text-white fs-6"></i>
                        <span class="font-data text-white fs-6 fw-bold tracking-widest">{{ ssol.domain | upper }}</span>
                    </div>
                    
                    <!-- Hidden hook for AI Context -->
                    <div id="ssol-goal" class="d-none">{{ ssol.selected_goal }}</div>
                    
                    <div class="font-body text-white opacity-75 small mt-1 fst-italic">"{{ ssol.selected_goal }}"</div>
                </div>

                <!-- 3. Strategic Anchors (System Pills) -->
                <div class="w-100 mt-2">
                    {{ system_pills_html | default('') | safe }}
                </div>
            </div>

            <!-- Ghost Watermark -->
            <div class="position-absolute bottom-0 end-0 opacity-10 pointer-events-none" style="transform: translate(20%, 20%) rotate(-15deg); z-index: 0;">
                <i class="{{ ssol.domain_icon }}" style="font-size: 18rem; color: white;"></i>
            </div>

            <!-- Footer Metadata -->
            <div class="p-3 border-top text-center" style="border-color: rgba(255,255,255,0.2) !important; background: rgba(0,0,0,0.1); flex-shrink: 0; z-index: 10;">
                <span class="font-data text-white small opacity-50">ID: {{ ssol_id.split('-')[0] | upper }}</span>
            </div>
        </div>


        <!-- ============================================= -->
        <!-- B. RIGHT COLUMN: WORKSPACE (Tabbed)          -->
        <!-- ============================================= -->
        <div class="col-lg-9 d-flex flex-column position-relative bg-surface-screen" style="height: 100%; overflow: hidden;">
            
            <!-- Brand Strip -->
            <div class="brand-strip"></div>

            <!-- 1. Header (Fixed Top) -->
            <div class="px-5 py-3 border-bottom bg-white d-flex justify-content-between align-items-center shadow-sm z-20" style="height: 80px; flex-shrink: 0;">
                <div style="min-width: 0; padding-right: 20px;">
                    <div class="font-data text-muted x-small mb-0 tracking-widest">SSPEC SOLUTION</div>
                    <!-- TITLE: Larger Headline -->
                    <h1 class="font-brand display-6 text-dark mb-0 text-truncate" style="line-height: 1.1;" title="{{ ssol.ssol_title }}">{{ ssol.ssol_title }}</h1>
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                    <button class="btn btn-outline-secondary font-data rounded-pill px-4 btn-sm" onclick="alert('Link copied to clipboard')">
                        <i class="fas fa-share-nodes me-2"></i> SHARE
                    </button>
                    <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-info text-white font-data rounded-pill px-4 btn-sm shadow-sm">
                        <i class="fas fa-file-pdf me-2"></i> EXPORT
                    </button>
                </div>
            </div>

            <!-- 2. TAB NAVIGATION (New) -->
            <div class="px-5 pt-4 bg-white border-bottom flex-shrink-0">
                <ul class="nav nav-tabs ce-nav-tabs border-0 gap-4" id="mainTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link font-data active px-0 pb-3" id="charter-tab" data-bs-toggle="tab" data-bs-target="#tab-charter" type="button" role="tab">
                            <i class="fas fa-layer-group me-2"></i>EXECUTIVE CHARTER
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link font-data px-0 pb-3" id="phases-tab" data-bs-toggle="tab" data-bs-target="#tab-phases" type="button" role="tab">
                            <i class="fas fa-list-check me-2"></i>PHASES & CONDITIONS
                        </button>
                    </li>
                </ul>
            </div>

            <!-- 3. Scrollable Content Area -->
            <div class="p-5 flex-grow-1 overflow-y-auto custom-scrollbar tab-content bg-surface-screen" id="mainTabContent">
                
                <!-- TAB 1: CHARTER & HORIZON -->
                <div class="tab-pane fade show active" id="tab-charter" role="tabpanel">
                    
                    <!-- A. Executive Charter (Glass Card) -->
                    <div class="bg-white rounded-4 border shadow-sm position-relative overflow-hidden charter-card mb-5">
                        <div class="domain-ghost-watermark" style="opacity: 0.05;"><i class="{{ ssol.domain_icon }}"></i></div>
                        <div class="charter-content font-body text-dark lead position-relative p-5" style="font-size: 1.15rem; line-height: 1.8;">
                            {{ ssol.ssol_summary | safe }}
                        </div>
                    </div>

                    <!-- B. Flight Path Timeline (Horizon Gauge) -->
                    <div class="mb-5">
                        {{ horizon_gauge_html | default('<div class="alert alert-light border text-muted font-data small">TIMELINE CALIBRATING...</div>') | safe }}
                    </div>
                </div>

                <!-- TAB 2: PHASES & CONDITIONS -->
                <div class="tab-pane fade" id="tab-phases" role="tabpanel">
                    
                    <!-- C. Phase Execution Grid -->
                    <div class="border rounded-3 overflow-hidden shadow-sm bg-white mb-4">
                        <!-- Legend (Header) -->
                        <div class="bg-light px-4 py-3 border-bottom d-flex justify-content-between align-items-center">
                            <span class="font-data text-muted small fw-bold tracking-widest">PROTOCOL SEQUENCE</span>
                            <div class="d-none d-lg-flex gap-4 font-data text-muted small tracking-widest align-items-center">
                                {% for phase_name in ssol.phases.keys() %}
                                <span class="phase-legend-item d-flex align-items-center gap-2 cursor-pointer hover-text-dark transition-colors" 
                                      data-target-id="collapse{{ loop.index }}" 
                                      title="Scroll to {{ phase_name }}">
                                    <div class="rounded-circle" style="width:8px;height:8px;background:var(--phase-{{ loop.index0 }});"></div> 
                                    {{ phase_name.upper() }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Accordion -->
                        <div class="accordion accordion-flush" id="phaseAccordion">
                            {% for phase_name, cos_list in ssol.phases.items() %}
                            <div class="accordion-item border-bottom mb-0">
                                <!-- Phase Header -->
                                <div class="module-header collapsed cursor-pointer py-3 px-4 transition-all text-white position-relative overflow-hidden" 
                                     data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" id="heading{{ loop.index }}"
                                     style="background-color: var(--phase-{{ loop.index0 }}); border-bottom: 1px solid rgba(0,0,0,0.1);">
                                    <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 8px 8px; opacity: 0.3;"></div>
                                    <div class="d-flex align-items-center justify-content-between w-100 position-relative z-1">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="phase-icon text-dark bg-white shadow-sm" style="opacity: 0.9; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold;">{{ phase_name[0] }}</div>
                                            <div class="text-white">
                                                <div class="phase-title font-brand" style="font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">{{ phase_name }} PHASE</div>
                                                <div class="font-data small opacity-75 letter-spacing-2">SEQUENCE 0{{ loop.index }}</div>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-down text-white opacity-75 transition-transform"></i>
                                    </div>
                                </div>
                                <!-- Phase Body -->
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show bg-white" data-bs-parent="#phaseAccordion">
                                    <div class="accordion-body p-0 phase-table-container" data-ssol-id="{{ ssol_id }}">
                                        {% if cos_list %}
                                        <table class="table table-hover mb-0 align-middle retro-table">
                                            <thead class="bg-surface-screen border-bottom">
                                                <tr>
                                                    <th class="ps-5 text-muted small font-data py-3" style="width: 110px;">STATUS</th>
                                                    <th class="text-muted small font-data py-3">CONDITION OF SATISFACTION</th> 
                                                    <th class="text-muted small font-data py-3" style="width: 18%;">ACCOUNTABLE</th>
                                                    <th class="text-muted small font-data py-3" style="width: 12%;">TARGET</th>
                                                    <th class="text-end pe-5 text-muted small font-data py-3" style="width: 100px;">EDIT</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for cos in cos_list %}
                                                <tr class="cos-row" data-cos-id="{{ cos.id }}" data-editing="false">
                                                    <td class="status-cell ps-5">
                                                        <span class="status-block font-data shadow-sm" style="background-color: {{ 'var(--success)' if cos.status == 'Completed' else 'var(--warning)' if cos.status == 'Active' else '#17a2b8' }}; color: white; font-size: 0.65rem; padding: 4px 10px; border-radius: 4px;">{{ cos.status | upper }}</span>
                                                    </td>
                                                    <td class="cos-content-cell py-4">
                                                        <div class="cos-content-display font-body text-dark fs-6">{{ cos.content | safe }}</div>
                                                        <div class="cos-content-edit d-none"><textarea class="form-control font-body bg-light border-0 p-3 shadow-inner">{{ cos.content | striptags }}</textarea></div>
                                                    </td>
                                                    <td class="cos-accountable-party-cell">
                                                        <div class="d-flex align-items-center gap-2 font-body fw-bold text-secondary small">
                                                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-muted border" style="width:32px;height:32px;"><i class="fas fa-user small"></i></div>
                                                            <span class="cos-accountable-party-display">{{ cos.accountable_party or 'N/A' }}</span>
                                                            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                                        </div>
                                                    </td>
                                                    <td class="cos-completion-date-cell font-data text-muted small">
                                                        <span class="cos-completion-date-display">{{ cos.completion_date or 'TBD' }}</span>
                                                        <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date if cos.completion_date else '' }}">
                                                    </td>
                                                    <td class="text-end actions-cell pe-5">
                                                        <div class="btn-group cos-actions opacity-50 hover-opacity-100 transition">
                                                            <button class="btn btn-sm btn-link text-muted edit-cos-button p-2"><i class="fas fa-cog"></i></button>
                                                            <button class="btn btn-sm btn-link text-danger delete-cos-button p-2"><i class="fas fa-trash"></i></button>
                                                        </div>
                                                        <div class="btn-group cos-actions d-none">
                                                            <button class="btn btn-sm btn-success update-cos-button p-1"><i class="fas fa-check"></i></button>
                                                            <button class="btn btn-sm btn-secondary cancel-cos-button p-1"><i class="fas fa-times"></i></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <div class="p-3 bg-white border-top d-flex justify-content-center">
                                            <button class="btn btn-white border font-data rounded-pill px-5 py-2 text-secondary hover-shadow add-cos" data-phase="{{ phase_name }}"><i class="fas fa-plus me-2 text-primary"></i> ADD CONDITION UNIT</button>
                                        </div>
                                        {% else %}
                                        <div class="p-5 text-center text-muted font-body opacity-50"><i class="fas fa-folder-open fa-3x mb-3"></i><p class="small">No conditions initialized.</p></div>
                                        <div class="p-3 bg-white border-top d-flex justify-content-center"><button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}"><i class="fas fa-plus me-2"></i> INITIALIZE</button></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Footer Pad -->
                <div style="height: 50px;"></div>
            </div>
            
            <!-- 3. System Status Footer -->
            <div class="px-5 py-3 bg-white border-top d-flex justify-content-between align-items-center" style="flex-shrink: 0; z-index: 20;">
                <div class="font-data small text-muted d-flex align-items-center">
                    <div class="rounded-circle bg-success me-2 animate-pulse" style="width:8px; height:8px;"></div>
                    SYSTEM ONLINE
                </div>
                <div class="font-data small text-muted">SSPEC HORIZON v2025.32</div>
            </div>

        </div>

    </div>
  </div>
</div>

<!-- Modal Injectors -->
<div class="modal fade" id="errorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body font-body" id="errorMessageContent"></div></div></div></div>
{{ system_config_modal_html | default('') | safe }}
<div id="dynamicModalContainer"></div>

<!-- STYLES Specific to this Layout -->
<style>
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .hover-text-dark:hover { color: var(--text-dark) !important; }
    .transition-colors { transition: color 0.2s; }
    .transition-transform { transition: transform 0.2s; }
    .module-header:not(.collapsed) .fa-chevron-down { transform: rotate(180deg); }
    .flex-shrink-0 { flex-shrink: 0 !important; }
    
    /* Table Styling */
    .retro-table thead th { font-weight: 700; letter-spacing: 1px; }
    
    /* Custom Scrollbar for Dark Sidebar */
    .custom-scrollbar-dark::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar-dark::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    .custom-scrollbar-dark::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .custom-scrollbar-dark::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
    
    /* TAB STYLING OVERRIDES */
    .nav-tabs .nav-link {
        color: #94a3b8; /* Muted */
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    .nav-tabs .nav-link:hover {
        color: var(--text-dark);
        border-color: transparent;
    }
    .nav-tabs .nav-link.active {
        color: var(--aviation-teal);
        background: transparent;
        border-color: var(--aviation-teal);
        font-weight: 700;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Inject Python System Node Configuration into JS Scope
    window.SYSTEM_NODES_CONFIG = {{ system_nodes | tojson }};
    window.SSOL_ID = "{{ ssol_id }}"; 
    window.SSOL_STATS = { total: {{ total_ces }}, active: {{ active_ces }}, verified: {{ verified_ces }}, integrity: {{ ssol.integrity_score }} };
</script>

<!-- Module Imports -->
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/system_cards.js') }}"></script>

<script type="module">
    import { initSystemCards } from "{{ url_for('static', filename='js/system_cards.js') }}";
    document.addEventListener('DOMContentLoaded', () => {
        initSystemCards("{{ ssol_id }}");
        const legendItems = document.querySelectorAll('.phase-legend-item');
        legendItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.targetId; 
                const targetCollapse = document.getElementById(targetId);
                const targetItem = targetCollapse?.closest('.accordion-item');
                if (targetCollapse) {
                    new bootstrap.Collapse(targetCollapse, { toggle: false }).show();
                    setTimeout(() => targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                }
            });
        });
        const ssolImageElement = document.getElementById('ssolImage'); 
        const placeholderImageElement = document.getElementById('placeholderImage');
        if (ssolImageElement) {
            function checkImage() {
                fetch(`/get_ssol_image/{{ ssol_id }}`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.status === 'found' && data.image_path) {
                            ssolImageElement.src = data.image_path;
                            ssolImageElement.onload = () => {
                                placeholderImageElement.style.opacity = 0;
                                ssolImageElement.style.opacity = 1;
                            };
                        } else {
                            setTimeout(checkImage, 2000);
                        }
                    }).catch(e => console.error(e));
            }
            checkImage();
        }
    });
</script>
{% endblock %}
