‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC Build Metadata (v202502260197)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC PossPath Essential Files
Date: 2025-12-05
Version: 202502260197
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üåê Structured Speculation Possibility Pathfinder ("SSPEC PossPath")

üìÅ Included Files:
 * üîÆ system_nodes.js
 * üü¶ outcome.html
 * üß© system_templates.py
 * üè≥Ô∏è‚Äçüåà ce_nodes.py
 * üü™ cos_table.js
 * üìÜ models.py
 * üÉè system_cards.py
 * üß© ce_templates.py
 * üü• routes.py
 * üîµ system_cards.js
 * üé® styles.css
 * üì± app.py
 * üüß ai_service.py
 * üîµ ce_cards.js
 * üè≥Ô∏è‚Äçüåà system_nodes.py
 * üè™ store.py
 * ‚¨ú speculate.py
 * üü© goal_selection.html
 * üü® utilities.py

üü¶ outcome.html:
{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- MAIN CONSOLE GRID (2-Column Layout) -->
    <div class="row g-0 bg-white" style="min-height: 85vh;">
        
        <!-- ============================================= -->
        <!-- A. LEFT COLUMN: CONTEXT & IDENTITY (Sidebar)  -->
        <!-- ============================================= -->
        <div class="col-lg-3 border-end bg-surface-screen d-flex flex-column position-relative z-10">
            
            <!-- Context Header (MATCHES BRAND STRIP EXACTLY) -->
            <div class="py-3 px-4 d-flex align-items-center justify-content-between text-white" 
                 style="background: linear-gradient(90deg, #00bcd4 0%, #26c6da 100%); border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px;">
                <span class="font-data tracking-widest small">
                    <i class="fas fa-satellite-dish me-2 opacity-50"></i>MISSION CONTEXT
                </span>
                <i class="fas fa-ellipsis-v opacity-50 small"></i>
            </div>

            <div class="p-4 flex-grow-1 d-flex flex-column gap-4">
                <!-- 1. Visualization Portal -->
                <div class="image-portal border shadow-sm">
                    <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" id="placeholderImage" class="fade-in" alt="System Processing">
                    <img src="" id="ssolImage" class="fade-in" style="opacity: 0;" alt="Generated Outcome Visualization">
                </div>

                <!-- 2. Domain Context (Centered below image) -->
                <div class="text-center">
                    <div class="d-inline-flex align-items-center px-3 py-1 bg-white border rounded-pill shadow-sm">
                        <i class="{{ ssol.domain_icon }} text-info me-2"></i>
                        <span class="font-body fw-bold small text-dark">{{ ssol.domain | upper }}</span>
                    </div>
                </div>

                <!-- 3. System Goal (The Target) -->
                <div class="border-top pt-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-crosshairs text-danger"></i>
                        <div class="font-data text-danger small tracking-widest fw-bold">SYSTEM GOAL</div>
                    </div>
                    
                    <!-- Hidden hook for AI Context -->
                    <div id="ssol-goal" class="d-none">{{ ssol.selected_goal }}</div>
                    
                    <p class="font-body text-dark fw-bold fst-italic lh-sm mb-0">
                        "{{ ssol.selected_goal }}"
                    </p>
                </div>

                <!-- 4. System Variables (The Anchors Stack) -->
                <!-- Injected via backend from system_templates.py -->
                <div class="w-100">
                    {{ system_pills_html | default('') | safe }}
                </div>
            </div>

            <!-- Metadata Footer -->
            <div class="p-3 border-top text-center bg-white mt-auto">
                <span class="font-data text-muted small opacity-50">ID: {{ ssol_id.split('-')[0] | upper }}</span>
            </div>
        </div>


        <!-- ============================================= -->
        <!-- B. RIGHT COLUMN: WORKSPACE (The Engine)      -->
        <!-- ============================================= -->
        <div class="col-lg-9 d-flex flex-column position-relative">
            
            <!-- Brand Strip (Top Accent) -->
            <div class="brand-strip"></div>

            <!-- Adjusted Padding for cleaner spacing -->
            <div class="p-4 p-lg-5 flex-grow-1 overflow-y-auto">
                
                <!-- 1. Title Header & Actions -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <div class="font-data text-muted small mb-1">SSPEC SOLUTION</div>
                        <h1 class="font-brand display-5 text-dark mb-0">{{ ssol.ssol_title }}</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary font-data rounded-pill px-4" title="Share Link"><i class="fas fa-share-nodes"></i></button>
                        <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-info text-white font-data rounded-pill px-4 shadow-sm">
                            <i class="fas fa-file-pdf me-2"></i> EXPORT REPORT
                        </button>
                    </div>
                </div>

                <!-- 2. Command Deck -->
                <div class="command-deck-wrapper mb-5 d-flex flex-column gap-4">
                    
                    <!-- A. Strategic Charter (Executive Summary) -->
                    <div class="bg-white rounded-4 border shadow-sm position-relative overflow-hidden" style="min-height: 200px;">
                        
                        <!-- Internal Header -->
                        <div class="py-3 px-4 border-bottom d-flex align-items-center gap-3" 
                             style="background: linear-gradient(90deg, #00bcd4, #26c6da, transparent);">
                            <div class="p-2 bg-white bg-opacity-25 rounded-3 backdrop-blur-sm text-white d-flex align-items-center justify-content-center" 
                                 style="width:36px; height:36px;">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <span class="font-data text-white small tracking-widest fw-bold" style="letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">EXECUTIVE CHARTER</span>
                        </div>

                        <!-- Ghost Watermark (Domain Icon) -->
                        <div class="domain-ghost-watermark" style="opacity: 0.1;">
                           <i class="{{ ssol.domain_icon }}"></i>
                        </div>

                        <!-- Content with "Magic Parsing" Highlighting -->
                        <div class="charter-content font-body text-dark lead position-relative p-5" style="line-height: 1.8; font-size: 1.1rem;">
                            {{ ssol.ssol_summary | safe }}
                        </div>
                    </div>

                    <!-- B. Horizon Gauge (Timeline) -->
                    <!-- Using the 'd-flex' row layout from previous steps -->
                    {{ horizon_gauge_html | default('<div class="alert alert-light border text-muted font-data small">TIMELINE NOT ESTABLISHED</div>') | safe }}
                    
                </div>

                <!-- 3. Phase Execution Grid -->
                <div class="border rounded-3 overflow-hidden shadow-sm bg-white mb-4">
                    
                    <!-- Grid Header -->
                    <div class="bg-light px-4 py-3 border-bottom d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                             <div class="p-2 bg-white rounded-circle border shadow-sm text-muted"><i class="fas fa-layer-group"></i></div>
                             <h2 class="h6 mb-0 text-secondary font-brand letter-spacing-1">PHASES & CONDITIONS</h2>
                        </div>
                        
                        <!-- Interactive Legend -->
                        <div class="d-none d-lg-flex gap-4 font-data text-muted small tracking-widest align-items-center">
                            {% for phase_name in ssol.phases.keys() %}
                            <span class="phase-legend-item d-flex align-items-center gap-2 cursor-pointer hover-text-dark transition-colors" 
                                  data-target-id="collapse{{ loop.index }}" 
                                  title="Scroll to {{ phase_name }}">
                                <div class="rounded-circle" style="width:8px;height:8px;background:var(--phase-{{ loop.index0 }});"></div> 
                                {{ phase_name.upper() }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Accordion Stack -->
                    <div class="accordion accordion-flush" id="phaseAccordion">
                        {% for phase_name, cos_list in ssol.phases.items() %}
                        <div class="accordion-item border-bottom mb-0">
                            
                            <!-- Phase Header (Vibrant Full Color) -->
                            <div class="module-header collapsed cursor-pointer py-3 px-4 transition-all text-white position-relative overflow-hidden" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#collapse{{ loop.index }}" 
                                 id="heading{{ loop.index }}"
                                 style="background-color: var(--phase-{{ loop.index0 }}); border-bottom: 1px solid rgba(0,0,0,0.1);">
                                
                                <!-- Subtle texture overlay for headers -->
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 8px 8px; opacity: 0.3;"></div>

                                <div class="d-flex align-items-center justify-content-between w-100 position-relative z-1">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="phase-icon text-dark bg-white shadow-sm" style="opacity: 0.9;">
                                            {{ phase_name[0] }}
                                        </div>
                                        <div class="text-white">
                                            <div class="phase-title font-brand" style="font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">{{ phase_name }} PHASE</div>
                                            <div class="font-data small opacity-75 letter-spacing-2">SEQUENCE 0{{ loop.index }}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Phase Progress Bar -->
                                    <div class="progress phase-progress flex-grow-1 mx-4 bg-white bg-opacity-25 border border-white border-opacity-25" style="height: 6px; max-width: 200px;">
                                        <div class="progress-bar bg-white shadow-sm" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>

                                    <i class="fas fa-chevron-down text-white opacity-75 transition-transform"></i>
                                </div>
                            </div>

                            <!-- Phase Body -->
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show bg-white" data-bs-parent="#phaseAccordion">
                                <div class="accordion-body p-0 phase-table-container" data-ssol-id="{{ ssol_id }}">
                                    {% if cos_list %}
                                    <table class="table table-hover mb-0 align-middle retro-table">
                                        <thead class="bg-surface-screen border-bottom">
                                            <tr>
                                                <th class="ps-5 text-muted small font-data py-3" style="width: 130px;">STATUS</th>
                                                <th class="text-muted small font-data py-3">CONDITION OF SATISFACTION</th> 
                                                <th class="text-muted small font-data py-3" style="width: 18%;">ACCOUNTABLE</th>
                                                <th class="text-muted small font-data py-3" style="width: 12%;">TARGET</th>
                                                <th class="text-end pe-5 text-muted small font-data py-3" style="width: 100px;">EDIT</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cos in cos_list %}
                                            <tr class="cos-row" data-cos-id="{{ cos.id }}" data-cos-status="{{ cos.status }}" data-editing="false">
                                                <td class="status-cell ps-5">
                                                    <!-- Interactive Status Badge -->
                                                    <span class="status-block cursor-pointer font-data shadow-sm {{ cos.status | get_badge_class_from_status }}" 
                                                          title="Click to Change Status"
                                                          style="padding: 5px 10px; font-size: 0.6rem;">
                                                        {{ cos.status | upper }}
                                                    </span>
                                                </td>
                                                <td class="cos-content-cell py-4">
                                                    <div class="cos-content-display font-body text-dark fs-6">{{ cos.content | safe }}</div>
                                                    <div class="cos-content-edit d-none"><textarea class="form-control font-body bg-light border-0 p-3 shadow-inner">{{ cos.content | striptags }}</textarea></div>
                                                </td>
                                                <td class="cos-accountable-party-cell">
                                                    <div class="d-flex align-items-center gap-2 font-body fw-bold text-secondary small">
                                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-muted border" style="width:32px;height:32px;"><i class="fas fa-user small"></i></div>
                                                        <span class="cos-accountable-party-display">{{ cos.accountable_party or 'N/A' }}</span><input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                                    </div>
                                                </td>
                                                <td class="cos-completion-date-cell font-data text-muted small">
                                                    <span class="cos-completion-date-display">{{ cos.completion_date or 'TBD' }}</span>
                                                    <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date if cos.completion_date else '' }}">
                                                </td>
                                                <td class="text-end actions-cell pe-5">
                                                    <div class="btn-group cos-actions opacity-50 hover-opacity-100 transition">
                                                        <!-- "Mark Complete" Short-cut Action -->
                                                        <button class="btn btn-sm btn-link text-success p-2 complete-cos-button" title="Mark Verified">
                                                            <i class="fas fa-check-circle"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-link text-muted edit-cos-button p-2"><i class="fas fa-cog"></i></button>
                                                        <button class="btn btn-sm btn-link text-danger delete-cos-button p-2"><i class="fas fa-trash"></i></button>
                                                    </div>
                                                    <div class="btn-group cos-actions d-none">
                                                        <button class="btn btn-sm btn-success update-cos-button p-1"><i class="fas fa-check"></i></button>
                                                        <button class="btn btn-sm btn-secondary cancel-cos-button p-1"><i class="fas fa-times"></i></button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <div class="p-3 bg-white border-top d-flex justify-content-center">
                                        <button class="btn btn-white border font-data rounded-pill px-5 py-2 text-secondary hover-shadow add-cos" data-phase="{{ phase_name }}">
                                            <i class="fas fa-plus me-2 text-primary"></i> ADD CONDITION UNIT
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="p-5 text-center text-muted font-body opacity-50"><i class="fas fa-folder-open fa-3x mb-3"></i><p class="small">No conditions initialized.</p></div>
                                    <div class="p-3 bg-white border-top d-flex justify-content-center"><button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}"><i class="fas fa-plus me-2"></i> INITIALIZE</button></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
            
            <!-- Page Footer -->
            <div class="px-5 py-3 bg-white border-top mt-auto d-flex justify-content-between align-items-center">
                <div class="font-data small text-muted d-flex align-items-center">
                    <div class="rounded-circle bg-success me-2 animate-pulse" style="width:8px; height:8px;"></div>
                    SYSTEM ONLINE
                </div>
                <div class="font-data small text-muted">SSPEC HORIZON v2025.26</div>
            </div>

        </div>

    </div>
  </div>
</div>

<!-- Modal Injectors -->
<div class="modal fade" id="errorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body font-body" id="errorMessageContent"></div></div></div></div>
{{ system_config_modal_html | default('') | safe }}
<div id="dynamicModalContainer"></div>

<style>
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .hover-text-dark:hover { color: var(--text-dark) !important; }
    .transition-transform { transition: transform 0.2s; }
    .module-header:not(.collapsed) .fa-chevron-down { transform: rotate(180deg); }
    .flex-shrink-0 { flex-shrink: 0 !important; }
</style>
{% endblock %}

{% block scripts %}
<script>
    // --- CRITICAL: Inject Python System Node Configuration into JS Scope ---
    // This allows the client-side system_cards.js to know the "Physics" of the anchors
    // without needing a network call just to get colors/icons.
    window.SYSTEM_NODES_CONFIG = {{ system_nodes | tojson }};
</script>

<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/system_cards.js') }}"></script>
<script type="module">
    import { initSystemCards } from "{{ url_for('static', filename='js/system_cards.js') }}";
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the System Anchors Logic
        initSystemCards("{{ ssol_id }}");
        
        const legendItems = document.querySelectorAll('.phase-legend-item');
        legendItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.targetId; 
                const targetCollapse = document.getElementById(targetId);
                const targetItem = targetCollapse?.closest('.accordion-item');
                if (targetCollapse) {
                    new bootstrap.Collapse(targetCollapse, { toggle: false }).show();
                    setTimeout(() => targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                }
            });
        });

        // Async Image Loading
        const ssolImageElement = document.getElementById('ssolImage'); 
        const placeholderImageElement = document.getElementById('placeholderImage');
        if (ssolImageElement) {
            function checkImage() {
                fetch(`/get_ssol_image/{{ ssol_id }}`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.status === 'found' && data.image_path) {
                            ssolImageElement.src = data.image_path;
                            ssolImageElement.onload = () => {
                                placeholderImageElement.style.opacity = 0;
                                ssolImageElement.style.opacity = 1;
                            };
                        } else {
                            setTimeout(checkImage, 2000);
                        }
                    }).catch(e => console.error(e));
            }
            checkImage();
        }
    });
</script>
{% endblock %}

üß© system_templates.py:
# system_templates.py
from flask import render_template_string
from system_nodes import SYSTEM_NODES
import datetime

# ==============================================================================
# 1. HORIZON GAUGE (Visualizes Time / Top of Main Column)
# ==============================================================================
HORIZON_GAUGE_TEMPLATE = """
<div class="card border-0 shadow-sm mb-4 overflow-hidden system-node-card cursor-pointer group"
     onclick="openSystemEditor('{{ id }}', 'HORIZON', '{{ value }}')"
     title="Click to Calibrate Horizon">
    <div class="card-body p-0 d-flex align-items-stretch">
        <!-- Icon Strip -->
        <div class="bg-light d-flex align-items-center justify-content-center p-3 border-end" 
             style="width: 80px; background-color: #fff8e1;">
            <i class="{{ icon }} fa-2x text-warning group-hover:scale-110 transition-transform"></i>
        </div>
        
        <!-- Data Visualization Area (Single Row Layout) -->
        <div class="flex-grow-1 p-3 d-flex align-items-center">
            <div class="d-flex align-items-center w-100 gap-3">
                
                <!-- Origin Date -->
                <div class="text-nowrap">
                    <span class="font-data text-muted small text-uppercase letter-spacing-1 d-block" style="font-size:0.65rem;">ORIGIN</span>
                    <span class="font-body fw-bold text-dark small">{{ start_date }}</span>
                </div>
                
                <!-- Progress Bar (The Bridge) -->
                <!-- flex-grow-1 allows it to stretch and fill all available space between dates -->
                <div class="progress rounded-pill flex-grow-1" style="height: 8px; background-color: #f1f5f9; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ time_elapsed_percent }}%; background-color: {{ health_color }}; box-shadow: 0 0 10px {{ health_color }}80;" 
                         aria-valuenow="{{ time_elapsed_percent }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>

                <!-- Realization Date -->
                <div class="text-end text-nowrap">
                    <span class="font-data text-muted small text-uppercase letter-spacing-1 d-block" style="font-size:0.65rem;">REALIZATION</span>
                    <span class="font-body fw-bold text-dark small">{{ target_date_display }}</span>
                </div>
            </div>
        </div>

        <!-- Countdown Readout -->
        <div class="p-3 border-start text-center d-flex flex-column justify-content-center bg-light" style="min-width: 120px;">
            <div class="font-data text-muted small" style="font-size: 0.6rem; letter-spacing:1px;">WINDOW</div>
            <div class="d-flex align-items-baseline justify-content-center gap-1">
                <span class="font-brand text-dark fs-3 lh-1">{{ days_remaining }}</span>
                <span class="font-data text-muted small" style="font-size: 0.5rem;">DAYS</span>
            </div>
        </div>
    </div>
</div>
"""

# ==============================================================================
# 2. SIDEBAR STACK (The "System Anchors" / Left Column)
# ==============================================================================
SYSTEM_SIDEBAR_STACK_TEMPLATE = """
<div class="d-flex flex-column mt-4" id="system-anchor-stack">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3 px-1">
        <span class="font-data text-muted small tracking-widest">STRATEGIC ANCHORS</span>
        <i class="far fa-question-circle text-muted opacity-50" style="font-size:0.8rem;"></i>
    </div>
    
    <!-- Cards -->
    {% for param in system_params %}
    <div class="system-anchor-card" 
         style="--sys-color: {{ param.color }};"
         onclick="openSystemEditor('{{ param.id }}', '{{ param.type }}', '{{ param.value }}')">
        
        <!-- Icon -->
        <div class="sys-icon-circle">
            <i class="{{ param.icon }}"></i>
        </div>
        
        <!-- Content -->
        <div class="sys-meta-col">
            <div class="sys-label">
                {{ param.label }}
                <!-- Mocking "Suggested" status for vibe - could be real data -->
                {% if loop.index == 1 or loop.index == 4 %}
                <span class="badge-suggested"><i class="fas fa-sparkles"></i> SUGGESTED</span>
                {% endif %}
            </div>
            <span class="sys-value">{{ param.value }}</span>
        </div>
    </div>
    {% endfor %}

    <!-- Add Button -->
    <button class="btn btn-outline-secondary border-dashed w-100 rounded-pill font-data small py-2 mt-2"
            onclick="openSystemEditor('new', '', '')">
        <i class="fas fa-plus me-2"></i> ADD PARAMETER
    </button>
</div>
"""

# ==============================================================================
# 3. CAROUSEL MODAL (The "Calibration Wizard")
# ==============================================================================
SYSTEM_EDITOR_MODAL_TEMPLATE = """
<div class="modal fade" id="systemConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 rounded-4 shadow-2xl overflow-visible">
            
            <!-- Nav Arrows -->
            <div class="sys-nav-arrow sys-nav-prev" onclick="navigateSystemNode(-1)"><i class="fas fa-chevron-left fa-lg"></i></div>
            <div class="sys-nav-arrow sys-nav-next" onclick="navigateSystemNode(1)"><i class="fas fa-chevron-right fa-lg"></i></div>

            <div class="row g-0" style="min-height: 600px;">
                
                <!-- LEFT: Identity & State (Visualizer) -->
                <div class="col-md-5 sys-modal-left p-5" id="sys-identity-panel" style="background-color: #333; transition: background-color 0.5s;">
                    <div class="sys-modal-texture"></div>
                    
                    <div class="position-relative z-1 h-100 d-flex flex-column justify-content-between">
                        <!-- Header -->
                        <div>
                            <div class="bg-white bg-opacity-25 rounded-3 d-flex align-items-center justify-content-center mb-4 shadow-sm backdrop-blur" 
                                 style="width: 64px; height: 64px;">
                                <i class="fas fa-cube fa-2x text-white" id="sys-display-icon"></i>
                            </div>
                            <h2 class="font-brand text-white display-6 mb-2" id="sys-display-label">LOADING...</h2>
                            <div class="font-data text-white-50 small letter-spacing-2 mb-5">SYSTEM NODE CONFIGURATION</div>
                        </div>

                        <!-- THE STATE MONITOR (Bespoke Visualizer) -->
                        <div class="flex-grow-1 d-flex flex-column justify-content-center">
                             <div class="font-data text-white-50 x-small tracking-widest mb-2">CURRENT STATE VECTOR</div>
                             <!-- JS populates this based on node type (Stack vs Gauge vs Pill) -->
                             <div id="sys-visualizer-container" class="w-100"></div>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-end mt-4">
                            <div class="font-data text-white-50 small" id="sys-counter">CARD 1 / X</div>
                            <div class="sys-pagination" id="sys-dots-container"></div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Ontology & Config (The Context) -->
                <div class="col-md-7 bg-white p-5 d-flex flex-column">
                    
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                        <div class="font-data text-muted small tracking-widest">
                            <i class="fas fa-sliders-h me-2"></i> CALIBRATION CONSOLE
                        </div>
                        <div class="d-flex gap-2">
                             <span class="badge bg-light text-muted border font-data rounded-pill px-3" id="sys-status-badge">PENDING</span>
                        </div>
                    </div>
                    
                    <!-- Scrollable Area -->
                    <div class="flex-grow-1 overflow-y-auto pe-2 custom-scrollbar d-flex flex-column gap-4">
                        
                        <!-- 1. DEFINITION CARD (Context) -->
                        <div class="bg-light rounded-3 p-4 border border-light-subtle">
                             <div class="d-flex gap-3">
                                <div class="mt-1"><i class="fas fa-info-circle text-primary"></i></div>
                                <div>
                                    <h6 class="font-data text-dark small mb-1">ONTOLOGICAL DEFINITION</h6>
                                    <p class="font-body text-secondary small mb-2" id="sys-display-desc" style="line-height: 1.5;">Description...</p>
                                    <div class="mt-2 pt-2 border-top border-light-subtle">
                                        <span class="font-data x-small text-muted uppercase me-1">Tip:</span>
                                        <span class="font-body x-small text-muted fst-italic" id="sys-display-guide">...</span>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <!-- 2. PROTOCOL TOGGLE -->
                        <div class="sys-protocol-toggle">
                            <button type="button" class="sys-protocol-btn active" id="mode-specify" onclick="setProtocolMode('SPECIFY')">
                                <i class="fas fa-pen-to-square me-2"></i> Specify
                            </button>
                            <button type="button" class="sys-protocol-btn" id="mode-speculate" onclick="setProtocolMode('SPECULATE')">
                                <i class="fas fa-wand-magic-sparkles me-2"></i> Speculate
                            </button>
                        </div>

                        <!-- 3. ACTIVE INPUT AREA (Bespoke) -->
                        <form id="system-node-form">
                            <input type="hidden" name="param_id" id="sys-param-id">
                            <input type="hidden" name="sys_type" id="sys-param-type">
                            <!-- JS Injects the correct inputs here -->
                            <div id="sys-input-container" class="mb-4"></div>
                            
                            <!-- 4. CONFIGURATION (Hard/Soft) -->
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all selected-mode-card h-100" 
                                         id="constraint-hard" onclick="setConstraintMode('HARD')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-lock me-2 text-primary"></i> HARD CONSTRAINT</div>
                                        <div class="text-muted x-small">Strict adherence.</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all opacity-50 h-100" 
                                         id="constraint-soft" onclick="setConstraintMode('SOFT')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-unlock me-2"></i> SOFT GUIDELINE</div>
                                        <div class="text-muted x-small">Trade-offs permitted.</div>
                                    </div>
                                </div>
                                <input type="hidden" name="constraint_mode" id="sys-constraint-input" value="HARD">
                            </div>

                            <!-- Rationale -->
                            <div>
                                <label class="font-data text-muted x-small mb-1">RATIONALE</label>
                                <textarea name="rationale" id="sys-rationale" class="form-control bg-light border-0 small" rows="2" placeholder="Why is this constraint set?"></textarea>
                            </div>
                        </form>

                    </div>
                    
                    <!-- Footer -->
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-light rounded-pill font-data px-4" data-bs-dismiss="modal">CANCEL</button>
                        <button type="button" class="btn btn-primary rounded-pill font-data px-5 shadow-lg" onclick="submitSystemForm()">
                            <i class="fas fa-save me-2"></i> COMMIT ANCHOR
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
"""


# ==============================================================================
# 4. RENDER FUNCTIONS
# ==============================================================================

def render_command_deck(system_params):
    """
    Orchestrates the Command Deck.
    Splits Horizon (Time) from the Anchors (Identity/Physics).
    """
    horizon_node = next((p for p in system_params if p['type'] == 'HORIZON'), None)
    other_params = [p for p in system_params if p['type'] != 'HORIZON']

    # Enrich generic params with Icon/Color from SYSTEM_NODES
    enriched_params = []
    for p in other_params:
        config = SYSTEM_NODES.get(p['type'], SYSTEM_NODES['OPERATOR'])
        enriched_params.append({
            **p,
            "icon": config['icon'],
            "color": config['color'],
            "label": config['label']
        })

    html_payload = {
        'horizon_html': "",
        'sidebar_html': ""
    }
    
    # 1. Render Horizon
    if horizon_node:
        import datetime
        # Logic: In real app, fetch creation_date from DB. For MVP, assume -7 days start.
        start_date = (datetime.date.today() - datetime.timedelta(days=7))
        val = horizon_node.get('value')
        
        # Display Logic
        target_display = val or "Unset"
        percent = 15 # Default MVP visual
        
        # Try parsing date for real math
        try:
            if val and '-' in val:
                target_date = datetime.datetime.strptime(val, '%Y-%m-%d').date()
                total_days = (target_date - start_date).days
                days_left = (target_date - datetime.date.today()).days
                if total_days > 0:
                    percent = 100 - int((days_left / total_days) * 100)
                days_rem_str = str(days_left)
            else:
                days_rem_str = "--"
        except:
            days_rem_str = "--"

        # Color Logic
        if percent > 90: health = "#ef5350" # Red
        elif percent > 75: health = "#ffa726" # Amber
        else: health = "#26c6da" # Teal

        html_payload['horizon_html'] = render_template_string(HORIZON_GAUGE_TEMPLATE, 
            start_date=start_date.strftime('%b %d, %Y'), 
            target_date_display=target_display,
            time_elapsed_percent=percent, 
            health_color=health,
            days_remaining=days_rem_str,
            value=val,
            id=horizon_node.get('id'),
            icon=SYSTEM_NODES['HORIZON']['icon']
        )
    
    # 2. Render Sidebar
    html_payload['sidebar_html'] = render_template_string(SYSTEM_SIDEBAR_STACK_TEMPLATE, system_params=enriched_params)
    
    return html_payload

def render_system_config_modal():
    return render_template_string(SYSTEM_EDITOR_MODAL_TEMPLATE, nodes=SYSTEM_NODES)

üè≥Ô∏è‚Äçüåà ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It couples 'Smart Schemas' (for the UI) with 'Strategic Prompts' (for the AI).

PROMPT VARIABLES:
- {cos_text}: The text of the source Condition of Satisfaction.
- {field}: The specific field being enhanced (e.g., "Executive Summary", "Objective").
- {node_type}: The type of the node (e.g., "Research", "Risk").

NOTE: Double braces {{ }} are used to escape JSON structure examples in Python f-strings.
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Generalist)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Strategic Project Manager. Write a concise, professional '{field}' 
                for a '{node_type}' element needed to achieve this goal: '{cos_text}'.
                Focus on clarity, actionability, and value.
                Return JSON: {{ "text": "Your text here." }}
            """,
            "prerequisites": "Analyze '{cos_text}'. List 3 precursors needed. Return JSON array: [{{\"title\": \"Prereq\", \"status\": \"Pending\"}}]",
            "stakeholders": "Who is involved in '{cos_text}'? Return JSON array: [{{\"name\": \"Name/Role\", \"role\": \"Description\"}}]",
            "assumptions": "What are we assuming about '{cos_text}'? Return JSON array: [{{\"hypothesis\": \"Assumption...\", \"risk\": \"Medium\"}}]",
            "resources": "Suggest 3 general resources for '{cos_text}'. Return JSON array: [{{\"title\": \"Resource Name\", \"url\": \"#\"}}]"
        }
    },

    # ==============================================================================
    # 2. RESEARCH (The Scientist)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink
        "details_schema": [
            {"key": "research_question", "label": "Primary Research Question", "type": "textarea", "rows": 2},
            {"key": "summary", "label": "Executive Synthesis", "type": "textarea", "rows": 6}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Paper/Source Title", "type": "text"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset"]},
            {"key": "url", "label": "Source URL", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Lead Researcher. Write a precise '{field}' to address knowledge gaps regarding: '{cos_text}'.
                Ensure the language is objective, evidence-based, and methodologically sound.
                Return JSON: {{ "text": "Your research text here." }}
            """,
            "prerequisites": """
                To answer the research question implied by: '{cos_text}', what data or baseline access is needed first?
                Return JSON array: [{{\"data_req\": \"Specific Dataset\", \"access_status\": \"Unknown\"}}]
            """,
            "stakeholders": """
                Suggest 3 types of Subject Matter Experts (SMEs) needed for: '{cos_text}'.
                Return JSON array: [{{\"name\": \"Role Title\", \"expertise\": \"Academic Field\"}}]
            """,
            "assumptions": """
                What theoretical assumptions are we making in '{cos_text}' that require validation?
                Return JSON array: [{{\"premise\": \"Theory...\", \"validation_method\": \"Lit Review\"}}]
            """,
            "resources": """
                Find 3 relevant academic papers, datasets, or whitepapers for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Paper Title\", \"type\": \"Paper\", \"url\": \"https://scholar.google.com/\"}}]
            """
        }
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text"},
            {"key": "confidence", "label": "Confidence (0-100)", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "tool_name", "label": "Mitigation Tool", "type": "text"},
            {"key": "cost", "label": "Est. Cost", "type": "currency"}
        ],
        "prompts": {
            "narrative": """
                Act as a Chief Risk Officer. Write a '{field}' analysis for the threat context of: '{cos_text}'.
                Focus on severity, probability, and concrete mitigation steps. Avoid vague reassurances.
                Return JSON: {{ "text": "Your risk analysis here." }}
            """,
            "prerequisites": """
                For the risk scenario in '{cos_text}', what monitoring or indicators must be established first?
                Return JSON array: [{{\"indicator\": \"Metric to watch\", \"threshold\": \"Value\"}}]
            """,
            "stakeholders": """
                Who owns the risk associated with '{cos_text}' and who suffers if it fails?
                Return JSON array: [{{\"owner\": \"Role\", \"impacted_group\": \"Population\"}}]
            """,
            "assumptions": """
                What 'safety assumptions' are we making about '{cos_text}' that could be false?
                Return JSON array: [{{\"mitigation_theory\": \"We assume...\", \"confidence\": 50}}]
            """,
            "resources": """
                Suggest 3 standard frameworks or tools to mitigate risks in: '{cos_text}'.
                Return JSON array: [{{\"tool_name\": \"Framework Name\", \"cost\": \"0\"}}]
            """
        }
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Diplomat)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text"},
            {"key": "material_needs", "label": "Materials Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Document", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Community Organizer or Diplomat. Write a '{field}' that defines how to engage partners for: '{cos_text}'.
                Focus on shared value, incentives, and relationship building.
                Return JSON: {{ "text": "Your engagement strategy here." }}
            """,
            "prerequisites": """
                To engage stakeholders for '{cos_text}', what introductions or materials are prerequisites?
                Return JSON array: [{{\"intro_path\": \"Via Industry Group\", \"material_needs\": \"Pitch Deck\"}}]
            """,
            "stakeholders": """
                Who are the key decision makers or influencers for: '{cos_text}'?
                Return JSON array: [{{\"name\": \"Role/Title\", \"influence\": 80, \"stance\": \"Neutral\"}}]
            """,
            "assumptions": """
                Why do we think these stakeholders will align with '{cos_text}'?
                Return JSON array: [{{\"incentive_theory\": \"They benefit by...\", \"validated\": false}}]
            """,
            "resources": """
                What agreements or contracts are standard for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Contract\", \"status\": \"Draft\"}}]
            """
        }
    },

    # ==============================================================================
    # 5. PRAXIS (The Operator)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Est", "type": "text"},
            {"key": "resource_avail", "label": "Resources Available?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "instructions", "label": "SOP/Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Operations Director. Write a '{field}' plan to execute: '{cos_text}'.
                Focus on logistics, friction points, and clear definitions of 'done'.
                Return JSON: {{ "text": "Your operational plan here." }}
            """,
            "prerequisites": """
                What must literally be completed before the task '{cos_text}' can physically start?
                Return JSON array: [{{\"dependency\": \"Task X Complete\", \"status\": \"Blocked\"}}]
            """,
            "stakeholders": """
                Who executes and who approves the action: '{cos_text}'?
                Return JSON array: [{{\"executor\": \"Role\", \"approver\": \"Manager/Client\"}}]
            """,
            "assumptions": """
                What are the logistical assumptions regarding time and availability for '{cos_text}'?
                Return JSON array: [{{\"time_est\": \"2 Weeks\", \"resource_avail\": true}}]
            """,
            "resources": """
                What software, hardware, or SOPs are needed to perform: '{cos_text}'?
                Return JSON array: [{{\"tool\": \"Tool Name\", \"instructions\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Ecologist)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulation", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Community", "type": "text"},
            {"key": "regulator", "label": "Regulator", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Environmental Scientist or Systems Analyst. Write a '{field}' assessment regarding: '{cos_text}'.
                Focus on systemic impacts, circularity, and regulatory landscapes.
                Return JSON: {{ "text": "Your impact assessment here." }}
            """,
            "prerequisites": """
                What regulatory permits or environmental baselines are required for: '{cos_text}'?
                Return JSON array: [{{\"permit\": \"Permit Type\", \"baseline_data\": \"Survey Needed\"}}]
            """,
            "stakeholders": """
                Which communities or regulatory bodies act as gatekeepers for: '{cos_text}'?
                Return JSON array: [{{\"community\": \"Local Group\", \"regulator\": \"Agency\"}}]
            """,
            "assumptions": """
                What trends (market or climate) are we assuming will hold stable for '{cos_text}'?
                Return JSON array: [{{\"trend\": \"Trend Description\", \"stability\": 60}}]
            """,
            "resources": """
                Find Environmental Impact Statements or Market Studies relevant to: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Report Title\", \"url\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 7. TIMELINE (The Scheduler)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "slack_analysis", "label": "Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors", "type": "text"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "date", "label": "Target Date", "type": "date"}
        ],
        "prompts": {
            "narrative": """
                Act as a Project Scheduler. Write a '{field}' description for the milestone: '{cos_text}'.
                Focus on critical path dependencies, slack times, and sequencing.
                Return JSON: {{ "text": "Your timeline analysis here." }}
            """,
            "prerequisites": """
                What events must happen *before* the milestone '{cos_text}' can occur?
                Return JSON array: [{{\"event\": \"Precursor Event\", \"lead_time\": \"2 Weeks\"}}]
            """,
            "stakeholders": """
                Who is responsible for keeping the schedule for: '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Project Manager / Role\"}}]
            """,
            "assumptions": """
                What assumptions about speed or external delays affect '{cos_text}'?
                Return JSON array: [{{\"velocity\": \"Standard Pace\", \"external_factors\": \"Weather/Shipping\"}}]
            """,
            "resources": """
                Suggest key calendar events or deadlines associated with: '{cos_text}'.
                Return JSON array: [{{\"event\": \"Milestone Name\", \"date\": \"2025-01-01\"}}]
            """
        }
    },

    # ==============================================================================
    # 8. ADVOCACY (The Campaigner)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action", "type": "text"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset", "type": "text"},
            {"key": "platform", "label": "Platform Ready?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience", "type": "text"},
            {"key": "influencer", "label": "Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Post", "Video", "Article"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Campaign Strategist. Write a compelling '{field}' to support the goal: '{cos_text}'.
                Focus on emotion, resonance, and a clear call to action.
                Return JSON: {{ "text": "Your campaign narrative here." }}
            """,
            "prerequisites": """
                What creative assets or platform accounts must be ready before advocating for '{cos_text}'?
                Return JSON array: [{{\"asset\": \"Video/Graphics\", \"platform\": false}}]
            """,
            "stakeholders": """
                Who is the target audience for '{cos_text}' and who influences them?
                Return JSON array: [{{\"audience\": \"Demographic\", \"influencer\": \"Personality/Org\"}}]
            """,
            "assumptions": """
                What are we assuming the public feels about '{cos_text}'?
                Return JSON array: [{{\"sentiment\": \"Positive/Skeptical\", \"resonance\": 70}}]
            """,
            "resources": """
                Suggest 3 types of content content media for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Viral Video Concept\", \"type\": \"Video\"}}]
            """
        }
    },

    # ==============================================================================
    # 9. COLLABORATION (The Connector)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual"]}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Partnership Lead. Write a '{field}' regarding the alliance for: '{cos_text}'.
                Focus on shared values, resource exchange, and long-term synergy.
                Return JSON: {{ "text": "Your partnership strategy here." }}
            """,
            "prerequisites": """
                What introductions or legal safeguards (NDAs) are needed before collaborating on '{cos_text}'?
                Return JSON array: [{{\"intro\": true, \"nda\": true}}]
            """,
            "stakeholders": """
                Identify potential partner organizations for: '{cos_text}'.
                Return JSON array: [{{\"partner_org\": \"Org Name\", \"poc\": \"Title/Role\"}}]
            """,
            "assumptions": """
                Why do we assume these partners want to work on '{cos_text}'?
                Return JSON array: [{{\"alignment\": \"Strategic Fit...\", \"resource_sharing\": 80}}]
            """,
            "resources": """
                What governance documents are required for this collaboration: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Teaming Agreement\", \"status\": \"Drafting\"}}]
            """
        }
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

üü™ cos_table.js:
// cos_table.js
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions ---

function getBadgeColorVar(status) {
    switch (status) {
        case 'Proposed': return '#17a2b8'; // Info cyan
        case 'Active': return 'var(--warning)';
        case 'In Progress': return 'var(--warning)';
        case 'Completed': return 'var(--success)';
        case 'Verified': return 'var(--success)';
        case 'Rejected': return 'var(--danger)';
        default: return '#94a3b8'; // Muted gray
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State ---

function storeOriginalValues(cosRow) {
    const statusBlock = cosRow.querySelector('.status-cell .status-block');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountableDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');

    cosRow.dataset.originalValues = JSON.stringify({
        status: statusBlock ? statusBlock.textContent.trim() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountable: accountableDisplay ? accountableDisplay.textContent.trim() : '',
        date: dateDisplay ? dateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);

    // Revert Status
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(original.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${original.status}</span>`;
    }

    // Revert Content
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;

    // Revert Meta
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = original.accountable;
    
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = original.date;

    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    // 1. Update Status Block
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(cosData.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${cosData.status.toUpperCase()}</span>`;
    }

    // 2. Update Content (with potential new Pills)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;

    // 3. Update Fields
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = cosData.accountable_party || 'N/A';

    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = cosData.completion_date || 'TBD';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();

    // Toggle visibility classes
    // Using Bootstrap .d-none utilities
    const elements = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];

    elements.forEach(pair => {
        const disp = cosRow.querySelector(pair.display);
        const edit = cosRow.querySelector(pair.edit);
        if (disp) disp.classList.toggle('d-none', editing);
        if (edit) edit.classList.toggle('d-none', !editing);
    });

    // Toggle Status Dropdown
    const statusCell = cosRow.querySelector('.status-cell');
    const currentBlock = statusCell.querySelector('.status-block');
    
    if (editing) {
        if (currentBlock) {
            const currentVal = currentBlock.textContent.trim();
            currentBlock.classList.add('d-none');
            if(!statusCell.querySelector('select')) {
                statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentVal));
            }
        }
    } else {
        const select = statusCell.querySelector('select');
        if (select) select.remove();
        if (currentBlock) currentBlock.classList.remove('d-none');
    }

    // Toggle Action Buttons
    const viewBtns = cosRow.querySelector('.actions-cell .btn-group:not(.d-none)');
    const editBtns = cosRow.querySelector('.actions-cell .btn-group.d-none');
    
    // This logic handles the swapping of button groups defined in outcome.html
    const actionsCell = cosRow.querySelector('.actions-cell');
    const groups = actionsCell.querySelectorAll('.btn-group');
    
    if (groups.length >= 2) {
        // Group 0 is View actions, Group 1 is Edit actions
        groups[0].classList.toggle('d-none', editing);
        groups[1].classList.toggle('d-none', !editing);
    }
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'Active', 'Completed', 'Verified', 'Rejected'];
    const options = statuses.map(s => 
        `<option value="${s}" ${s.toUpperCase() === selectedStatus.toUpperCase() ? 'selected' : ''}>${s.toUpperCase()}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select shadow-none border-secondary">${options}</select>`;
}

// --- EVENT HANDLERS ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;

    // 1. CE Pill Click (Launch Modal)
    const pill = target.closest('.ce-pill, .ce-capsule');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    // 2. Action Buttons
    const button = target.closest('button');
    if (!button) return;

    const cosRow = button.closest('.cos-row');
    if (!cosRow) return;

    event.preventDefault();
    const cosId = cosRow.dataset.cosId;

    if (button.classList.contains('edit-cos-button')) {
        handleEditCOS(cosRow);
    } else if (button.classList.contains('update-cos-button')) {
        handleUpdateCOS(cosRow, cosId);
    } else if (button.classList.contains('cancel-cos-button')) {
        revertToOriginalValues(cosRow);
    } else if (button.classList.contains('delete-cos-button')) {
        handleDeleteCOS(cosRow, cosId);
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);

    // Pre-populate textarea (strip existing HTML/Pills for editing)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const textarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && textarea) {
        textarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    // Gather Data
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountable = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim();
    const newDate = cosRow.querySelector('.cos-completion-date-edit')?.value;

    // UI Feedback
    const btn = cosRow.querySelector('.update-cos-button');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            content: newContent, 
            status: newStatus, 
            accountable_party: newAccountable, 
            completion_date: newDate 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error('Failed to return COS data');
        }
    })
    .catch(err => alert(err.message))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = origHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (!confirm('Are you sure? This will delete the Condition and all its internal logic nodes.')) return;

    fetch(`/delete_cos/${cosId}`, { method: 'DELETE' })
    .then(handleApiResponse)
    .then(() => cosRow.remove())
    .catch(err => alert(err.message));
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    
    // 1. Locate Context
    const container = button.closest('.phase-table-container');
    if (!container) return console.error("Phase container not found.");
    
    const ssolId = container.dataset.ssolId;
    if (!ssolId) return alert("System Error: SSOL Context Missing.");

    // 2. Visual Feedback (Loading State)
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-circle-notch fa-spin me-2"></i> INITIALIZING...`;

    // 3. Construct Payload
    const payload = {
        // Default placeholder text inviting definition
        content: "New Condition of Satisfaction - Click edit to define parameters.",
        status: "Proposed",
        ssol_id: ssolId
    };

    // 4. Network Request
    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse) // Expects standard helper
    .then(data => {
        if (data.success && data.cos) {
            // 5. Inject into DOM
            const table = container.querySelector('table.retro-table');
            const newRowHtml = createRowHTML(data.cos); // Generate Row HTML

            if (table) {
                // SCENARIO A: Table exists, append row
                const tbody = table.querySelector('tbody');
                tbody.insertAdjacentHTML('beforeend', newRowHtml);
            } else {
                // SCENARIO B: Empty State (No table yet)
                // We must remove the "No protocols" placeholder and build the table skeleton
                const emptyState = container.querySelector('.text-center.text-muted');
                if(emptyState) emptyState.remove();

                // The wrapper for the table needs to go BEFORE the button footer
                // Note: outcome.html structure puts button in a div.p-3 at bottom of container
                const tableSkeleton = `
                    <table class="table table-hover mb-0 align-middle retro-table">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 110px;">Status</th>
                                <th>Condition of Satisfaction</th>
                                <th style="width: 18%;">Accountable</th>
                                <th style="width: 12%;">Target</th>
                                <th class="text-end pe-4" style="width: 100px;">Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${newRowHtml}
                        </tbody>
                    </table>
                `;
                
                // Insert as first element in the body (pushing the footer down)
                container.insertAdjacentHTML('afterbegin', tableSkeleton);
            }
        }
    })
    .catch(err => {
        console.error("COS Creation Failed:", err);
        alert("Failed to initialize new Condition. Check console.");
    })
    .finally(() => {
        // 6. Restore Button State
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}


// --- HTML Generator for New Rows (Matches outcome.html structure) ---
function createRowHTML(cos) {
    return `
    <tr class="cos-row" data-cos-id="${cos.id}" data-editing="false">
        <td class="status-cell">
            <span class="status-block" style="background-color: #17a2b8;">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell">
            <div class="cos-content-display">${cos.content}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm">${stripHtmlForTextarea(cos.content)}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell">
            <span class="cos-accountable-party-display">N/A</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none">
        </td>
        <td class="cos-completion-date-cell font-data">
            <span class="cos-completion-date-display">TBD</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none">
        </td>
        <td class="text-end actions-cell">
            <div class="btn-group cos-actions">
                <button class="btn btn-sm btn-link text-muted edit-cos-button"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-cos-button"><i class="fas fa-trash"></i></button>
            </div>
            <div class="btn-group cos-actions d-none">
                <button class="btn btn-sm btn-success update-cos-button"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button"><i class="fas fa-times"></i></button>
            </div>
        </td>
    </tr>`;
}

// --- MAIN: Launch the CE Modal Application ---

export function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    
    // Safe access to NODES using window object (injected in base.html)
    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cube';
    
    showLoadingSpinner(`INITIALIZING ${ceType.toUpperCase()} NODE...`, iconClass);

    // Scrape context for the modal initialization
    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.getElementById('ssol-goal')?.textContent.trim() || "Goal";
    const cosContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || '';
    
    const accItem = cosRow?.closest('.accordion-item');
    const phaseText = accItem?.querySelector('.phase-title')?.textContent.trim() || "Unknown";
    
    // Calculate phase index based on DOM order
    const allItems = Array.from(document.querySelectorAll('.accordion-item'));
    const phaseIndex = accItem ? allItems.indexOf(accItem) : 0;

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            ce_id: ceId, 
            cos_content: cosContent, 
            phase_name: phaseText,
            phase_index: phaseIndex,
            ssol_goal: ssolGoal 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if(data.modal_html) {
            // Launch the full application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        }
    })
    .catch(err => {
        console.error(err);
        alert("System Error: Could not load node application.");
    })
    .finally(() => hideLoadingSpinner());
}

// --- GLOBAL LISTENERS ---

document.addEventListener('DOMContentLoaded', () => {
    // Table Actions (Delegated)
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    // Add COS Buttons
    document.querySelectorAll('.add-cos').forEach(btn => {
        btn.addEventListener('click', handleAddCOSButtonClick);
    });

    // PDF Export
    const pdfBtn = document.getElementById('save-as-pdf-button');
    if(pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
            // e.target.dataset.ssolId might need bubbling check if icon clicked
            const id = e.currentTarget.dataset.ssolId;
            // Call PDF function (omitted for brevity, assume similar to existing)
            alert("Generating PDF report...");
        });
    }
});

üìÜ models.py:
# models.py
import os
import json
import uuid
from datetime import date
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date, Integer, Float)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()

# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # --- CORE IDENTITY ---
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    
    # --- SCOPE & CONSTRAINTS (The MVP Project Container) ---
    domain = Column(String(100), nullable=True)     # Context for AI (e.g. "Bio-Tech")
    status = Column(String(50), default='Draft')    # Lifecycle (Draft, Active, Paused, Complete)
    owner = Column(String(255), nullable=True)      # The human champion
    target_date = Column(Date, nullable=True)       # The horizon/deadline
    system_data = Column(JsonType, nullable=True, default={})
    
    # --- METRICS ---
    integrity_score = Column(Integer, default=100)  # 0-100 Health Metric
    completion_percentage = Column(Integer, default=0) # Derived from COS completion
    
    # --- RELATIONSHIPS ---
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'domain': self.domain,
            'status': self.status,
            'owner': self.owner,
            'target_date': self.target_date.isoformat() if self.target_date else None,
            'integrity_score': self.integrity_score,
            'completion_percentage': self.completion_percentage,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    
    # --- STATUS TRACKING ---
    status = Column(String(50), nullable=False, default='Proposed') # Proposed, Active, Complete, Verified
    
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE STRATEGIC PAYLOAD ---
    # Stores the complete state of the Speculation Environment.
    # Initializing with all keys ensures the "Fresh Node" check in JS works reliably.
    data = Column(JsonType, nullable=False, default=lambda: {
        "details_data": {}, 
        "prerequisites": [],
        "stakeholders": [], 
        "assumptions": [],
        "resources": [],
        "connections": []
    })

    def to_dict(self):
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data 
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

üß© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER: SYSTEM IDENTITY -->
            <div class="ce-modal-header">
                <div class="node-icon-box"><i class="{{ node_info.icon }}"></i></div>
                <div class="header-text-block ms-3 flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="modal-title ce-title mb-0 text-white leading-tight">{{ ceType.replace('_', ' ').upper() }}</h2>
                            <div class="ce-header-metadata text-white opacity-75 small">// {{ phase_name.upper() }} PHASE <span class="mx-2">|</span> ID: {{ ceId.split('-')[0].upper() }}</div>
                        </div>
                        <!-- INTELLIGENCE BUTTON -->
                        <div class="d-flex gap-2">
                             <button class="btn btn-glass font-data d-none d-md-flex align-items-center gap-2" id="speculate-sidebar-toggle">
                                <i class="fas fa-brain"></i> ENGINE
                            </button>
                            <div class="vr bg-white opacity-50 mx-2" style="height: 24px;"></div>
                            <button type="button" class="btn-close-custom" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <div class="header-ghost-icon"><i class="{{ node_info.icon }}"></i></div>
            </div>

            <!-- MICRO-TIMELINE (THE 4 QUADRANTS) -->
            <div class="ce-micro-timeline bg-white border-bottom px-4 py-2">
                <div class="row align-items-center g-0">
                    <div class="col-auto me-3 font-data small text-muted tracking-widest">EXECUTION PROTOCOL:</div>
                    <div class="col">
                        <div class="d-flex w-100 gap-1">
                            <div class="milestone-segment active" id="ms-q1"><div class="ms-bar"></div><span class="ms-label">DEFINITION</span></div>
                            <div class="milestone-segment" id="ms-q2"><div class="ms-bar"></div><span class="ms-label">ALIGNMENT</span></div>
                            <div class="milestone-segment" id="ms-q3"><div class="ms-bar"></div><span class="ms-label">EVIDENCE</span></div>
                            <div class="milestone-segment" id="ms-q4"><div class="ms-bar"></div><span class="ms-label">VALIDATION</span></div>
                        </div>
                    </div>
                    <div class="col-auto ms-3">
                        <span class="badge rounded-pill bg-light text-dark border" id="milestone-status">Q1: DRAFTING</span>
                    </div>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex">
                
                <!-- LEFT COLUMN -->
                <div class="ce-main-column">
                    <!-- NAVIGATION -->
                    <ul class="nav nav-tabs ce-nav-tabs pt-2 px-4 bg-white" role="tablist">
                        <li class="nav-item"><button class="nav-link font-data active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">OVERVIEW</button></li>
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <li class="nav-item"><button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-{{ collection }}-{{ ceId }}">{{ collection|upper }} <span class="badge rounded-pill bg-light text-dark border ms-1 count-badge" data-collection="{{ collection }}">0</span></button></li>
                        {% endfor %}
                        <li class="nav-item ms-auto"><button class="nav-link font-data text-muted" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i></button></li>
                    </ul>

                    <div class="ce-app-content tab-content bg-surface-screen">
                        
                        <!-- 1. OVERVIEW DASHBOARD (Bento) -->
                        <div class="tab-pane fade show active p-4" id="view-overview-{{ ceId }}">
                            <div class="row g-4 h-100">
                                
                                <!-- HERO: Editable Narrative Context -->
                                <div class="col-lg-8 d-flex flex-column">
                                    <div class="system-hero-card flex-grow-1 p-0 position-relative overflow-hidden">
                                        <div class="scan-line" style="opacity:0;"></div> 
                                        <div class="hero-ghost-icon"><i class="{{ node_info.icon }}"></i></div>

                                        <div class="d-flex flex-column h-100 position-relative z-2">
                                            <div class="p-4 pb-0 d-flex justify-content-between align-items-start">
                                                <div class="font-data text-white-50 small letter-spacing-2">STRATEGIC CONTEXT</div>
                                                
                                                <!-- BRANDING FIX: SPECULATE -->
                                                <button class="btn btn-sm btn-glass text-white btn-enhance-field" data-field="summary">
                                                    <i class="fas fa-brain me-2"></i> SPECULATE
                                                </button>
                                            </div>
                                            
                                            <!-- The Editable Area -->
                                            <div class="flex-grow-1 p-4">
                                                <form id="narrative-form-{{ ceId }}" class="h-100">
                                                    <textarea name="summary" 
                                                              class="form-control bg-transparent border-0 text-white font-body fs-5 h-100 p-0 shadow-none hero-textarea" 
                                                              style="resize: none; line-height: 1.6;" 
                                                              placeholder="Describe the strategic function of this node..."
                                                    >{{ ce_data.data.details_data.get('summary', '') }}</textarea>
                                                </form>
                                            </div>
                                            
                                            <!-- Footer -->
                                            <div class="px-4 py-3 bg-black bg-opacity-10 border-top border-white border-opacity-10 d-flex align-items-center gap-3">
                                                 <i class="fas fa-info-circle text-white-50"></i>
                                                 <span class="font-data small text-white-50">Direct input overrides generative model.</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Source COS -->
                                    <div class="mt-4 card border-0 shadow-sm">
                                        <div class="card-body p-4">
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-crosshairs text-secondary"></i>
                                                <span class="font-data text-muted small">SOURCE REQUIREMENT</span>
                                            </div>
                                            <div class="font-body fst-italic text-dark">{{ cos_content_with_pills | safe }}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT METRICS -->
                                <div class="col-lg-4 d-flex flex-column gap-3">
                                    <!-- Confidence -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center p-4">
                                            <span class="font-data text-muted small">COMPLETION CONFIDENCE</span>
                                            <div class="display-3 font-brand text-dark my-2" id="confidence-score-display">0%</div>
                                            <!-- Sparkline -->
                                            <div class="d-flex justify-content-center gap-1 opacity-50" style="height: 10px;">
                                                <div class="bg-success w-1 rounded" style="height:40%"></div>
                                                <div class="bg-success w-1 rounded" style="height:60%"></div>
                                                <div class="bg-success w-1 rounded" style="height:30%"></div>
                                                <div class="bg-success w-1 rounded" style="height:80%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logic Stream -->
                                    <div class="card border-0 shadow-sm flex-grow-1">
                                        <div class="card-header bg-white border-bottom">
                                            <span class="font-data small text-danger"><i class="fas fa-bolt me-2"></i>CRITICAL SIGNALS</span>
                                        </div>
                                        <div class="card-body p-0 position-relative overflow-y-auto" id="overview-logic-stream" style="max-height: 200px;">
                                            <!-- Injected via JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLLECTIONS -->
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                             <!-- Toolbar -->
                             <div class="px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-white font-data px-4 btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-2"></i> MANUAL</button>
                                    <!-- BRANDING FIX: SPECULATE -->
                                    <button class="btn btn-white font-data px-4 text-primary btn-speculate-collection" data-collection="{{ collection }}">
                                        <i class="fas fa-brain me-2"></i> SPECULATE
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm w-auto font-body" placeholder="Filter...">
                            </div>
                            <div class="flex-grow-1 p-4 overflow-y-auto collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}"></div>
                             
                             <!-- Dynamic Editor -->
                             <div class="collection-editor p-4 bg-white border-top shadow-lg position-absolute bottom-0 w-100" id="editor-{{ collection }}-{{ ceId }}" style="display:none; z-index: 50;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="font-brand mb-0">EDIT {{ collection[:-1]|upper }}</h5>
                                    <button type="button" class="btn-close btn-cancel-edit"></button>
                                </div>
                                <form class="editor-form" data-collection="{{ collection }}">
                                    {% set schema = node_info.get(collection[:-1] + '_schema', []) %}
                                    <div class="row g-3">
                                        {% for field in schema %}
                                        <div class="col-12 {{ 'col-md-6' if field.type != 'textarea' else '' }}">
                                            <label class="font-data text-muted small mb-1">{{ field.label }}</label>
                                            {% if field.type == 'textarea' %}<textarea name="{{ field.key }}" class="form-control bg-light" rows="2"></textarea>
                                            {% elif field.type == 'select' %}<select name="{{ field.key }}" class="form-select font-body">{% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}</select>
                                            {% elif field.type == 'slider' %}<div class="ce-range-wrap"><input type="range" class="ce-range-input" name="{{ field.key }}" min="0" max="100" step="10"><span class="ce-range-value">50%</span></div>
                                            {% elif field.type == 'toggle' %}<div class="mt-2"><label class="ce-toggle-switch"><input type="checkbox" name="{{ field.key }}"><span class="ce-toggle-slider"></span></label></div>
                                            {% else %}<input type="text" name="{{ field.key }}" class="form-control">{% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-4 text-end"><button type="submit" class="btn btn-success font-data px-4 rounded-pill">SAVE ENTRY</button></div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- CONNECTIONS -->
                        <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                            <div class="text-center p-5 text-muted"><i class="fas fa-project-diagram fa-3x mb-3 opacity-25"></i><h5 class="font-brand">VECTOR MAP</h5><p class="small">No connections yet.</p></div>
                        </div>

                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column border-start bg-white">
                    <div class="sidebar-persona-header" id="ai-sidebar-header"></div>
                    <div class="p-3 flex-grow-1 overflow-y-auto" id="ai-sidebar-content"></div>
                </div>

            </div>
            <!-- FOOTER -->
            <div class="modal-footer ce-modal-footer"><div class="font-data text-muted small me-auto" id="save-status">STATUS: UNSAVED</div><div class="d-flex gap-2"><button class="btn btn-outline-secondary rounded-pill px-4 font-data" data-bs-dismiss="modal">EXIT</button><button class="btn btn-primary rounded-pill px-4 font-data btn-save-changes">SAVE {{ ceType.upper() }}</button></div></div>
        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    
    # --- CRITICAL FIX: Ensure ID is a string before template rendering ---
    # Handle UUID objects or None types safely
    raw_id = ce_data.get('id', 'new_ce')
    safe_ce_id = str(raw_id) if raw_id else 'new_ce'

    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=safe_ce_id,  # Use the safe string version
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

üü• routes.py:
# routes.py
import os
import json
import uuid
import logging
import asyncio
import pdfkit
from uuid import UUID
from datetime import date, timedelta, datetime
from dotenv import load_dotenv
from bs4 import BeautifulSoup
from werkzeug.exceptions import BadRequest, NotFound
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory

# --- App Context ---
from app import USE_DATABASE

# --- Data Models & Config ---
from models import get_engine_and_session, SSOL, COS
from ce_nodes import NODES
from system_nodes import SYSTEM_NODES
from system_templates import (
    render_command_deck, 
    render_system_config_modal
)

# --- Service Layers ---
from ai_service import cleanup_gemini_client, generate_chat_response
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, generate_image, \
                    format_ssol_text

# --- Speculation Operations ---
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol

# --- Template Generators ---
from ce_templates import generate_dynamic_modal

load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# ==============================================================================
# 1. LIFECYCLE MANAGEMENT
# ==============================================================================

@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up AI resources after each request."""
    await cleanup_gemini_client()

# ==============================================================================
# 2. BASIC NAVIGATION & UTILITIES
# ==============================================================================

@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

@routes_bp.route('/')
def index():
    return render_template('input.html')

@routes_bp.route('/about')
def about():
    return render_template('about.html')

@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    text = request.form.get('user_text')
    if not text:
        return jsonify({'error': 'No text provided'}), 400
    
    return jsonify({
        'keywords': await analyze_user_input(text), 
        'compliance': await is_input_compliant(text)
    })

# ==============================================================================
# 3. GOAL SELECTION
# ==============================================================================

@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            current_app.logger.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)

            if not goal_options:
                flash("Could not generate goal options. Please try again.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            current_app.logger.error(f"Error in goal_selection: {e}", exc_info=True)
            flash(f"An error occurred: {e}", "error")
            return render_template('input.html', user_text=user_input)
    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 4. OUTCOME GENERATION (The Bootstrapper)
# ==============================================================================

@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        # 1. EXTRACT FORM DATA
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        if not selected_goal_text:
            flash("No goal selected. Please try again.", "error")
            return redirect(url_for('routes_bp.index'))
            
        try:
            current_app.logger.info(f"Initializing Outcome for: {selected_goal_title}")

            # ------------------------------------------------------------------
            # 2. GENERATE INTELLIGENCE (Structure + System Nodes)
            # ------------------------------------------------------------------
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, 
                ssol_description=selected_goal_text, 
                domain=domain
            )
            
            raw_summary = structured_solution_json.get('ssolsummary', 'Analysis pending...')
            # Apply Formatting (Magic Parsing for System Tags)
            ssol_summary = format_ssol_text(raw_summary)
            
            ai_system_params = structured_solution_json.get('system_params', {})

            # ------------------------------------------------------------------
            # 3. CREATE SSOL CONTAINER
            # ------------------------------------------------------------------
            ssol_id_str = speculate_create_ssol(
                USE_DATABASE, 
                selected_goal_title, 
                selected_goal_text, 
                domain=domain
            )
            ssol_id_uuid = UUID(ssol_id_str)

            # ------------------------------------------------------------------
            # 4. BOOTSTRAP SYSTEM NODES (DB Save)
            # ------------------------------------------------------------------
            if USE_DATABASE:
                engine, session = get_engine_and_session()
                try:
                    ssol_obj = session.query(SSOL).get(ssol_id_uuid)
                    if ssol_obj:
                        ssol_obj.system_data = ai_system_params
                        if 'OPERATOR' in ai_system_params:
                            ssol_obj.owner = ai_system_params['OPERATOR']
                        session.commit()
                        current_app.logger.info("Saved inferred System Nodes to DB.")
                except Exception as db_e:
                    current_app.logger.error(f"Failed to save System Data: {db_e}")
                finally:
                    session.close()

            # ------------------------------------------------------------------
            # 5. CREATE PHASES & CONDITIONS (Refactored for Reliability)
            # ------------------------------------------------------------------
            phases_for_template = {}
            
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    phases_for_template[phase_name] = []
                    
                    for cos_content_with_tags in cos_items:
                        if not cos_content_with_tags: continue
                            
                        try:
                            # CREATE AND GET DATA IN ONE SHOT
                            cos_data = await speculate_create_cos(
                                USE_DATABASE, 
                                ssol_id=ssol_id_uuid, 
                                content=cos_content_with_tags, 
                                status='Proposed'
                            )
                            
                            if cos_data:
                                phases_for_template[phase_name].append(cos_data)
                            else:
                                current_app.logger.warning(f"COS creation returned empty data for phase {phase_name}")
                                    
                        except Exception as cos_err:
                            current_app.logger.error(f"Error generating COS: {cos_err}")

            # ------------------------------------------------------------------
            # 6. RENDER COMMAND DECK UI (Visuals)
            # ------------------------------------------------------------------
            # We build the master list, then pass it to the single render function.
            deck_params_list = []
            
            # A. Prepare Horizon (Default 1 year)
            import datetime
            default_horizon = (datetime.date.today() + datetime.timedelta(days=365)).strftime('%Y-%m-%d')
            deck_params_list.append({
                'type': 'HORIZON', 
                'id': f'horizon_{ssol_id_str}', 
                'value': default_horizon 
            })
            
            # B. Prepare System Anchors
            for key, val in ai_system_params.items():
                if key in SYSTEM_NODES and key != 'HORIZON':
                    deck_params_list.append({
                        'type': key,
                        'id': f'sys_{key}_{str(uuid.uuid4())[:8]}',
                        'value': val
                    })

            # C. Render Components
            # render_command_deck returns {'horizon_html': ..., 'sidebar_html': ...}
            components = render_command_deck(deck_params_list) 
            
            gauge_html = components['horizon_html']
            pills_html = components['sidebar_html']
            
            config_modal = render_system_config_modal()

            # ------------------------------------------------------------------
            # 7. ASYNC IMAGE GENERATION
            # ------------------------------------------------------------------
            try:
                image_prompt = f"""
                A vibrant, isometric, mid-century retro illustration of '{selected_goal_title}: {selected_goal_text}' 
                fulfilled. Style: 1950s Popular Science magazine cover meets Syd Mead.
                Characteristics: Saturated technicolor palette (teal, orange, cream), painterly lithograph texture,
                idealized realism, optimistic composition. No text.
                """
                await generate_image(image_prompt, ssol_id_str)
            except Exception as e:
                current_app.logger.warning(f"Image gen trigger failed: {e}")

            # ------------------------------------------------------------------
            # 8. FINAL RENDER
            # ------------------------------------------------------------------
            outcome_data = {
                'ssol_id': ssol_id_str,
                'ssol_title': selected_goal_title,
                'selected_goal': selected_goal_text,
                'domain': domain,
                'domain_icon': domain_icon,
                'ssol_summary': ssol_summary,
                'phases': phases_for_template
            }

            return render_template(
                'outcome.html', 
                ssol=outcome_data, 
                nodes=NODES, 
                ssol_id=ssol_id_str,
                horizon_gauge_html=gauge_html,
                system_pills_html=pills_html,
                system_config_modal_html=config_modal
            )

        except Exception as e:
            current_app.logger.error(f"CRITICAL error in /outcome: {e}", exc_info=True)
            flash(f"System Critical Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 5. INTELLIGENCE & CONFIG
# ==============================================================================
@routes_bp.route('/update_ssol_system_node', methods=['POST'])
def update_ssol_system_node():
    data = request.get_json()
    ssol_id = data.get('ssol_id')
    key = data.get('key')   # e.g., 'BUDGET'
    value = data.get('value') # e.g., 'Bootstrapped'

    if not ssol_id or not key:
        return jsonify({'success': False}), 400

    engine, session = get_engine_and_session()
    try:
        ssol = session.query(SSOL).get(UUID(ssol_id))
        if not ssol:
            return jsonify({'success': False, 'error': 'SSOL not found'}), 404

        # Specialized handling for CORE fields that have their own columns
        if key == 'HORIZON':
            try:
                # Try to parse date, fallback to text if user typed "Next Summer"
                from datetime import datetime
                dt = datetime.strptime(value, '%Y-%m-%d').date()
                ssol.target_date = dt
            except:
                # If fuzzy date, store in system_data instead
                current_data = dict(ssol.system_data or {})
                current_data['HORIZON_TEXT'] = value
                ssol.system_data = current_data
        
        elif key == 'OPERATOR':
            ssol.owner = value
            # Also store in JSON for the prompt engine
            current_data = dict(ssol.system_data or {})
            current_data['OPERATOR'] = value
            ssol.system_data = current_data
            
        else:
            # Generic System Node (Budget, Directive, etc.)
            # Mutable dict approach for SQLAlchemy JSON tracking
            current_data = dict(ssol.system_data or {})
            current_data[key] = value
            ssol.system_data = current_data

        session.commit()
        return jsonify({'success': True})
    except Exception as e:
        session.rollback()
        current_app.logger.error(f"Error in update_ssol_system_node: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        session.close()

@routes_bp.route('/speculate_context', methods=['POST'])
async def speculate_context_route():
    try:
        data = request.get_json()
        ce_type = data.get('ce_type', 'Default')
        context = data.get('context') # e.g., 'prerequisites', 'narrative'
        sub_context = data.get('sub_context', '') # e.g., 'summary'
        cos_text = data.get('cos_text', '')
        ssol_id = data.get('ssol_id')
        
        # 2. SYSTEM ATTENUATION (The "Telepathy" Layer)
        system_instructions = []
        
        if ssol_id and USE_DATABASE:
            try:
                engine, session = get_engine_and_session()
                ssol = session.query(SSOL).get(UUID(ssol_id))
                
                if ssol:
                    if ssol.target_date:
                        system_instructions.append(f"TEMPORAL CONSTRAINT: Hard deadline is {ssol.target_date}. All steps must fit this timeline.")
                    if ssol.owner:
                        system_instructions.append(f"OPERATOR CONTEXT: The acting entity is '{ssol.owner}'. Suggest resources accessible to them.")
                    if ssol.system_data:
                        for key, val in ssol.system_data.items():
                            config = SYSTEM_NODES.get(key)
                            if config and 'prompt_injection' in config:
                                instruction = config['prompt_injection'].format(value=val)
                                system_instructions.append(instruction)
                session.close()
            except Exception as db_e:
                current_app.logger.warning(f"Attenuation Layer skipped (DB Error): {db_e}")

        global_context_block = "\n".join(system_instructions)
        if not global_context_block:
            global_context_block = "CONTEXT: Standard operating procedure. No specific constraints defined."

        # 3. NODE-SPECIFIC PROMPT ASSEMBLY
        node_config = NODES.get(ce_type, NODES['Default'])
        prompts_map = node_config.get('prompts', {})
        default_prompts = NODES['Default'].get('prompts', {})
        
        if context == 'narrative':
            base_prompt = prompts_map.get('narrative', default_prompts.get('narrative'))
            prompt_content = base_prompt.format(cos_text=cos_text, field=sub_context, node_type=ce_type)
            final_prompt = f"*** SYSTEM PHYSICS (NON-NEGOTIABLE CONSTRAINTS) ***\n{global_context_block}\n\n*** SPECIFIC TASK ***\n{prompt_content}"
            system_inst = "Return strictly JSON: { \"text\": \"...\" }"
            
        else:
            base_prompt = prompts_map.get(context, default_prompts.get(context))
            if not base_prompt:
                base_prompt = f"Analyze '{cos_text}'. List 3 items for {context}."
            prompt_content = base_prompt.format(cos_text=cos_text)
            final_prompt = f"*** SYSTEM PHYSICS (NON-NEGOTIABLE CONSTRAINTS) ***\n{global_context_block}\n\n*** SPECIFIC TASK ***\n{prompt_content}"
            system_inst = "Return a valid JSON array of objects."

        # 4. EXECUTE ENGINE
        ai_response = await generate_chat_response(
            messages=[{"role": "user", "content": final_prompt}], 
            role="SSPEC Engine", 
            task=f"{ce_type}-{context}",
            system_instruction=system_inst,
            temperature=0.75 
        )
        
        clean_json = ai_response.replace("```json", "").replace("```", "").strip()
        parsed = json.loads(clean_json)

        if context == 'narrative':
            txt = parsed.get('text', '') if isinstance(parsed, dict) else str(parsed)
            return jsonify({'success': True, 'text': txt, 'field': sub_context})
        else:
            suggestions = []
            if isinstance(parsed, dict):
                for key, val in parsed.items():
                    if isinstance(val, list):
                        suggestions = val
                        break
            elif isinstance(parsed, list):
                suggestions = parsed
            return jsonify({'success': True, 'suggestions': suggestions, 'context': context})

    except Exception as e:
        current_app.logger.error(f"Speculation Error: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

# ==============================================================================
# 7. CORE CRUD & EXPORT 
# ==============================================================================

@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        ce_text = data.get('ce_text', 'Conditional Element')
        
        # Ensure we have a valid UUID object for DB lookup, but keep string for fallback
        ce_id_obj = None
        if ce_id_str:
            try:
                ce_id_obj = UUID(ce_id_str)
            except ValueError:
                pass # Handle non-UUID strings if necessary

        # Fetch Data
        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        
        # Initialize structure if missing
        if not ce_data or 'data' not in ce_data:
            # Ensure the ID in the fallback dict is a STRING
            ce_data = {'id': str(ce_id_str) if ce_id_str else 'new_ce', 'node_type': ce_type, 'data': {
                'details_data': {}, 'resources': [], 'prerequisites': [], 'stakeholders': [], 'assumptions': [], 'connections': []
            }}

        node_config = NODES.get(ce_type, NODES['Default'])
        cos_content_html = data.get('cos_content', '')
        
        # Strip HTML to feed plain text to AI
        cos_text_only = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)
        
        # Get context summary
        ai_generated_data = await generate_ai_data(ce_type, cos_text_only, data.get('ssol_goal', ''), 'context')

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type, ce_text=ce_text, ce_data=ce_data, node_info=node_config,
            cos_content=cos_content_html, ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''), phase_index=data.get('phase_index', 0)
        )
        return jsonify(modal_html=modal_html, ce_data=ce_data)
    except Exception as e:
        # Improved error logging to catch these issues in console
        current_app.logger.error(f"Error generating CE Modal: {e}", exc_info=True)
        return jsonify(error=str(e)), 500

@routes_bp.route('/update_ce/<uuid:ce_id>', methods=['PUT'])
def update_ce_route(ce_id):
    data = request.get_json()
    if speculate_update_ce_by_id(USE_DATABASE, ce_id, data): return jsonify(success=True)
    return jsonify(success=False), 500

@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        cos_data = await speculate_create_cos(
            USE_DATABASE, UUID(data['ssol_id']), data['content'], 
            data.get('status', 'Proposed'), data.get('accountable_party'), data.get('completion_date')
        )
        if cos_data: return jsonify(success=True, cos=cos_data), 201
        return jsonify(success=False), 500
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        res = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)
        if res['success']: return jsonify(success=True, cos=res['cos'])
        return jsonify(success=False, error=res['message']), res['status_code']
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    if speculate_delete_cos_by_id(USE_DATABASE, cos_id): return jsonify(success=True)
    return jsonify(success=False), 404

@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    p = f"images/ssol_image_{ssol_id}.png"
    if os.path.exists(os.path.join(current_app.static_folder, p)):
        return jsonify({'image_path': url_for('static', filename=p), 'status': 'found'})
    return jsonify({'status': 'pending'})

@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        html = request.get_json()['htmlContent'].replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')
        pdf_options = {"page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in", "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8", "no-outline": None, "enable-local-file-access": None}
        pdf = pdfkit.from_string(html, False, options=pdf_options, css=os.path.join(current_app.root_path, 'static', 'styles.css'))
        r = make_response(pdf)
        r.headers['Content-Type'] = 'application/pdf'
        r.headers['Content-Disposition'] = f'attachment; filename="SSPEC_{ssol_id}.pdf"'
        return r
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

üîµ system_cards.js:
// static/js/system_cards.js
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- State Management ---
let systemNodesConfig = {}; 
let currentNodesArray = []; 
let currentIndex = 0;       
let currentSSOLId = null;

// Mock Entity Store for Prototype (In a full app, this would fetch from the DB relationship)
// We use this to visually stack cards in the left panel for the OPERATOR node.
let entityStore = {
    'OPERATOR': [] 
};

/**
 * Initializes the System Card Controller.
 * Called from outcome.html once the DOM is ready.
 */
export function initSystemCards(ssolId) {
    currentSSOLId = ssolId;
    
    // 1. Load Configuration (Injected in base.html via Python context processor)
    if(window.SYSTEM_NODES_CONFIG) {
        systemNodesConfig = window.SYSTEM_NODES_CONFIG;
        currentNodesArray = Object.keys(systemNodesConfig);
    }

    // 2. Bind Global Functions for OnClick Attributes in HTML
    window.openSystemEditor = openSystemEditor;
    window.navigateSystemNode = navigateSystemNode;
    window.setProtocolMode = setProtocolMode;
    window.setConstraintMode = setConstraintMode;
    window.submitSystemForm = submitSystemForm;
    window.addEntity = addEntity; // Specific to Operator Node
}

/**
 * Opens the Modal and jumps to specific node type.
 * @param {string} existingId - The specific DB ID (optional)
 * @param {string} type - The System Node Type (e.g., 'BUDGET', 'OPERATOR')
 * @param {string} currentValue - The current value to pre-fill
 */
function openSystemEditor(existingId, type, currentValue) {
    if (type && currentNodesArray.includes(type)) {
        currentIndex = currentNodesArray.indexOf(type);
    } else {
        currentIndex = 0; 
    }

    const modalEl = document.getElementById('systemConfigModal');
    modalEl.dataset.editingId = existingId === 'new' ? '' : existingId;
    
    // Store initial value in dataset to survive re-renders
    if(currentValue && currentValue !== 'None') {
        modalEl.dataset.tempValue = currentValue;
    } else {
        delete modalEl.dataset.tempValue;
    }

    updateModalView();
    
    // Launch Bootstrap Modal
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

/**
 * Handles Carousel Navigation (Prev/Next)
 */
function navigateSystemNode(direction) {
    currentIndex += direction;
    if (currentIndex < 0) currentIndex = currentNodesArray.length - 1;
    if (currentIndex >= currentNodesArray.length) currentIndex = 0;
    
    // Reset temporary state when sliding
    const modalEl = document.getElementById('systemConfigModal');
    delete modalEl.dataset.tempValue; 
    modalEl.dataset.editingId = ""; 

    updateModalView();
}

/**
 * CORE RENDER LOGIC
 * Updates the Left (Visual) and Right (Input) panels based on the current Node Type.
 */
function updateModalView() {
    const typeKey = currentNodesArray[currentIndex];
    const config = systemNodesConfig[typeKey] || {};
    const modalEl = document.getElementById('systemConfigModal');
    const savedVal = modalEl.dataset.tempValue || '';

    // --- 1. Identity Panel (Left) ---
    document.getElementById('sys-identity-panel').style.backgroundColor = config.color;
    document.getElementById('sys-display-icon').className = `fas ${config.icon} fa-2x text-white`;
    document.getElementById('sys-display-label').textContent = config.label;
    
    // VISUALIZER: Render the correct state view (Gauge, Stack, or Text)
    renderVisualizer(typeKey, savedVal, config.color);

    // --- 2. Calibration Console (Right) ---
    // Info Text
    document.getElementById('sys-display-desc').textContent = config.description;
    document.getElementById('sys-display-guide').textContent = config.guide;

    // Hidden Form Inputs
    document.getElementById('sys-param-type').value = typeKey;
    document.getElementById('sys-param-id').value = modalEl.dataset.editingId;

    // Render Input Fields based on Type
    renderBespokeInput(typeKey, savedVal, config.color, config);
    
    // Pagination Dots
    document.getElementById('sys-counter').textContent = `CARD ${currentIndex + 1} / ${currentNodesArray.length}`;
    const dotContainer = document.getElementById('sys-dots-container');
    dotContainer.innerHTML = currentNodesArray.map((k, i) => 
        `<div class="sys-dot ${i === currentIndex ? 'active' : ''}" style="opacity: ${i === currentIndex ? '1' : '0.3'}"></div>`
    ).join('');
}

/**
 * Renders the Left Column State Monitor
 */
function renderVisualizer(type, value, color) {
    const container = document.getElementById('sys-visualizer-container');
    container.innerHTML = ''; // Clear

    // CASE: OPERATOR (Stack of Identity Cards)
    if (type === 'OPERATOR') {
        if (entityStore['OPERATOR'].length === 0 && !value) {
             container.innerHTML = `
                <div class="bg-white bg-opacity-10 border-2 border-dashed border-white border-opacity-25 rounded-xl p-5 text-center text-white-50">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="small font-bold">NO CHAMPIONS ASSIGNED</div>
                </div>`;
        } else {
            // Visualize either the stored entity stack OR the single value if simple text was used
            const displayEntities = entityStore['OPERATOR'].length > 0 
                ? entityStore['OPERATOR'] 
                : [{name: value, role: 'Primary Contact', org: 'Entity'}];
            
            displayEntities.forEach(ent => {
                container.innerHTML += `
                <div class="sys-entity-card">
                     <div class="sys-entity-avatar" style="color:${color}; background: #fff;">${ent.name ? ent.name[0] : '?'}</div>
                     <div style="flex-grow:1; overflow:hidden;">
                        <div class="font-bold text-dark text-truncate" style="font-size:0.85rem;">${ent.name || 'Unknown'}</div>
                        <div class="font-data text-muted x-small text-truncate">${ent.role} ‚Ä¢ ${ent.org}</div>
                     </div>
                     <div class="badge bg-light text-muted border"><i class="fas fa-box"></i></div>
                </div>`;
            });
        }
        return;
    }

    // CASE: HORIZON (Velocity Gauge)
    if (type === 'HORIZON') {
        container.innerHTML = `
             <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-2xl p-4 backdrop-blur-sm text-center">
                 <div class="font-data text-white-50 x-small uppercase tracking-widest mb-2">TIMELINE VELOCITY</div>
                 <div class="display-4 font-brand text-white mb-0">${value ? value.split('-')[0] : '--'}</div>
                 <div class="font-data text-white-50 x-small uppercase tracking-wide mb-3">TARGET HORIZON</div>
                 <div class="progress" style="height: 4px; background-color: rgba(255,255,255,0.2);">
                    <div class="progress-bar bg-white" style="width: ${value ? '65%' : '0%'}"></div>
                 </div>
             </div>`;
        return;
    }

    // DEFAULT: Big Typographic Display
    container.innerHTML = `
        <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-xl p-4 backdrop-blur-sm shadow-inner">
             <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-white" style="width: 8px; height: 8px;"></div>
                <div class="fs-3 fw-bold text-white text-break lh-sm">${value || 'Unset'}</div>
             </div>
        </div>`;
}

/**
 * Renders the Right Column Input Area
 */
function renderBespokeInput(type, value, color, config) {
    const container = document.getElementById('sys-input-container');
    container.innerHTML = '';

    // 1. OPERATOR (Contact Form)
    if (type === 'OPERATOR') {
        container.innerHTML = `
            <div class="bg-light rounded-3 p-3 border border-light-subtle">
                <div class="d-flex align-items-center gap-2 mb-3 text-muted border-bottom pb-2">
                    <i class="fas fa-user-plus small"></i>
                    <span class="font-data x-small fw-bold tracking-widest">ADD CHAMPION</span>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" id="ent-name" class="form-control form-control-sm" placeholder="Entity Name (e.g. Acme Corp)" value="${value}">
                    </div>
                    <div class="col-6"><input type="text" id="ent-role" class="form-control form-control-sm" placeholder="Role / Title"></div>
                    <div class="col-6"><input type="text" id="ent-org" class="form-control form-control-sm" placeholder="Organization"></div>
                </div>
                <button type="button" class="btn btn-dark w-100 btn-sm mt-3 font-data" onclick="addEntity()">
                    <i class="fas fa-plus-circle me-1"></i> ADD TO STACK
                </button>
                <!-- Hidden real value field for submission -->
                <input type="hidden" name="value" id="real-value-input" value="${value}">
            </div>
        `;
        return;
    }

    // 2. SELECT DROPDOWN (If 'options' exist in config)
    if (config.options && Array.isArray(config.options)) {
        const opts = config.options.map(opt => 
            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
        ).join('');
        
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">SELECT CONFIGURATION</label>
                <select name="value" class="form-select form-select-lg font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none bg-transparent">
                    <option value="" disabled ${!value ? 'selected' : ''}>Choose...</option>
                    ${opts}
                </select>
            </div>
        `;
        return;
    }

    // 3. HORIZON (Date Picker)
    if (type === 'HORIZON') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">TARGET DATE</label>
                <input type="date" name="value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                       value="${value}" style="background:transparent;">
            </div>
        `;
        return;
    }

    // 4. DEFAULT (Text Input)
    container.innerHTML = `
        <div class="mb-3">
            <label class="font-data text-muted x-small mb-2" style="color:${color} !important">ANCHOR VALUE</label>
            <input type="text" name="value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                   value="${value}" placeholder="Define value..." autocomplete="off" style="background:transparent;">
        </div>
    `;
}

// --- Interaction Handlers ---

function setProtocolMode(mode) {
    // UI Toggle
    document.querySelectorAll('.sys-protocol-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`mode-${mode.toLowerCase()}`).classList.add('active');
    
    const container = document.getElementById('sys-input-container');
    const type = document.getElementById('sys-param-type').value;

    if (mode === 'SPECULATE') {
        // AI LOADING STATE
        container.innerHTML = `
            <div class="bg-light border border-primary-subtle rounded-3 p-5 text-center animate-in fade-in">
                <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="font-body small text-muted">Connecting to SSPEC Engine...</p>
                <div class="font-data x-small text-muted tracking-widest mt-2">OPTIMIZING ${type}</div>
            </div>
        `;
        
        // Mock Simulation for Prototype (In real app, fetch /speculate_system_node)
        // This simulates the AI "Thinking" and returning a smart value
        setTimeout(() => {
            let suggestion = "AI Optimization";
            if(type === 'HORIZON') suggestion = "2026-11-15"; // AI picks a date
            if(type === 'OPERATOR') suggestion = "Strategic Consortium";
            if(type === 'BUDGET') suggestion = "Grant Funded";
            
            // Switch back to Specify mode to show the result
            setProtocolMode('SPECIFY');
            
            // Slight delay to allow DOM to repaint before injecting value
            setTimeout(() => {
                const inp = document.querySelector('[name="value"]');
                const sel = document.querySelector('select[name="value"]');
                
                if(inp) inp.value = suggestion;
                if(sel) sel.value = suggestion;
                
                // For Operator, fill the visible input too
                if(type === 'OPERATOR') {
                    document.getElementById('ent-name').value = suggestion;
                    document.getElementById('real-value-input').value = suggestion;
                }
                
                // Trigger Visualizer Update
                renderVisualizer(type, suggestion, systemNodesConfig[type].color);
            }, 50);
        }, 1200);
    } else {
        // Re-render standard inputs (Cancel Speculation)
        updateModalView();
    }
}

function setConstraintMode(mode) {
    // UI Toggle for Hard/Soft Constraints
    document.querySelector('.selected-mode-card').classList.remove('selected-mode-card');
    
    // Add opacity to unselected
    document.getElementById('constraint-hard').classList.add('opacity-50');
    document.getElementById('constraint-soft').classList.add('opacity-50');
    
    // Activate selected
    const target = document.getElementById(`constraint-${mode.toLowerCase()}`);
    target.classList.remove('opacity-50');
    target.classList.add('selected-mode-card');
    
    document.getElementById('sys-constraint-input').value = mode;
}

/**
 * Adds an entity to the Operator Stack (Client-side visual only for now)
 */
function addEntity() {
    const name = document.getElementById('ent-name').value;
    const role = document.getElementById('ent-role').value || 'Lead';
    const org = document.getElementById('ent-org').value || 'External';
    
    if(name) {
        // Add to store
        entityStore['OPERATOR'].push({name, role, org, id: Date.now()});
        
        // Update Visualizer
        renderVisualizer('OPERATOR', null, systemNodesConfig['OPERATOR'].color);
        
        // Update Hidden Input (Comma separated for simple storage)
        const realInput = document.getElementById('real-value-input');
        const currentVals = entityStore['OPERATOR'].map(e => e.name).join(', ');
        realInput.value = currentVals;

        // Clear Form
        document.getElementById('ent-name').value = '';
        document.getElementById('ent-role').value = '';
        document.getElementById('ent-org').value = '';
    }
}

/**
 * Submits the data to the backend
 */
function submitSystemForm() {
    const form = document.getElementById('system-node-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Add SSOL ID context
    data.ssol_id = currentSSOLId;
    data.key = data.sys_type; // Match backend expectation

    // UI Feedback
    const btn = document.querySelector('button[onclick="submitSystemForm()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i> SAVING...';
    btn.disabled = true;

    fetch('/update_ssol_system_node', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        if (response.success) {
            // Close Modal
            const modalEl = document.getElementById('systemConfigModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // Reload page to update the Sidebar (simplest way to refresh global context)
            location.reload(); 
        } else {
            alert("Error saving: " + (response.error || "Unknown error"));
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Network Error");
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

üé® styles.css:
/* styles.css - SSPEC "Horizon Fusion" v2025.25 (DEFINITIVE MASTER) */

/* ================================================== */
/* ==============  1. FONTS & VARIABLES  ============ */
/* ================================================== */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Manrope:wght@400;500;600;700&family=Antonio:wght@700&family=Mr+Dafoe&family=Unica+One&display=swap');

:root {
  /* --- Horizon Palette --- */
  --bg-warm: #e3f2fd;
  --surface-white: #ffffff;
  --surface-screen: #f8fafc;
  
  /* Brand Colors */
  --aviation-teal: #00bcd4;
  --deep-space-blue: #2c3e50;
  --retro-coral: #ff7043;
  
  /* Functional Colors */
  --danger: #ef5350;
  --success: #66bb6a;
  --warning: #ffca28;
  --text-dark: #1e293b;
  --text-muted: #64748b;

  /* Phase Colors (Horizon Standard) */
  --phase-0: #ff7043; /* Discovery - Coral */
  --phase-1: #26c6da; /* Engagement - Cyan */
  --phase-2: #ab47bc; /* Action - Purple */
  --phase-3: #ffa726; /* Completion - Amber */
  --phase-4: #66bd0e; /* Legacy - Green */
  
  /* Typography Tokens */
  --font-brand: 'Righteous', cursive; 
  --font-retro: 'Unica One', cursive;
  --font-script: 'Mr Dafoe', cursive;
  --font-data: 'Antonio', sans-serif; 
  --font-body: 'Manrope', sans-serif;
}

body {
  font-family: var(--font-body);
  /* Background handled by Section 3 (Aurora) */
  background-color: transparent;
  color: var(--text-dark);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Typography Overrides */
h1.display-script { font-family: var(--font-script); font-weight: 400; }
h1, h2, h3, .navbar-brand { font-family: var(--font-brand); letter-spacing: 1px; }

/* Data / UI Fonts */
h4, h5, h6, .font-data, .ce-title, .card-domain-badge, .btn, .nav-link { 
    font-family: var(--font-data); letter-spacing: 0.5px; text-transform: uppercase; 
}
.font-retro { font-family: var(--font-retro); letter-spacing: 1px; text-transform: uppercase; }
.font-body, .card-desc { font-family: var(--font-body); }

/* ================================================== */
/* ==============  2. NAVIGATION  =================== */
/* ================================================== */
nav.navbar {
    background: transparent;
    padding-top: 1.5rem; padding-bottom: 1.5rem;
    z-index: 10;
}
.navbar-brand { text-decoration: none; }

/* ================================================== */
/* ==============  3. BACKGROUND ATMOSPHERE  ======== */
/* ================================================== */
.aurora-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; overflow: hidden;
    background-color: #f8fafc; /* Lightest slate base */
    transition: all 1s ease-in-out;
}

/* Texture */
.aurora-noise {
    position: absolute; inset: 0; z-index: 2; opacity: 0.06;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
}

/* Living Blobs */
.aurora-blob {
    position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
    mix-blend-mode: multiply; animation-timing-function: ease-in-out; 
    animation-iteration-count: infinite; animation-direction: alternate;
}

.blob-1 { background-color: var(--phase-0); top: -10%; left: -10%; width: 70vw; height: 70vw; animation: float1 25s infinite; }
.blob-2 { background-color: var(--phase-1); top: -10%; right: -10%; width: 60vw; height: 60vw; animation: float2 28s infinite; }
.blob-3 { background-color: var(--phase-2); bottom: -20%; left: 20%; width: 70vw; height: 70vw; animation: float3 32s infinite; }
.blob-4 { background-color: var(--phase-3); bottom: -10%; right: -10%; width: 50vw; height: 50vw; animation: float1 22s infinite; opacity: 0.3; }
.blob-5 { background-color: var(--phase-4); top: 40%; left: 40%; width: 40vw; height: 40vw; animation: float3 35s infinite; opacity: 0.3; }

@keyframes float1 { from { transform: translate(0, 0) scale(1); } to { transform: translate(40px, 50px) scale(1.1); } }
@keyframes float2 { from { transform: translate(0, 0) scale(1); } to { transform: translate(-50px, 30px) scale(1.2); } }
@keyframes float3 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(30px, -40px) rotate(10deg); } }

/* Outcome Mode: Dimmed */
body.state-outcome .aurora-background { opacity: 0.2; filter: grayscale(80%); }

/* ================================================== */
/* ==============  4. THE CONSOLE HOUSING =========== */
/* ================================================== */
.horizon-wrapper {
  padding: 2rem 1rem; 
  min-height: 85vh;
  display: flex; 
  justify-content: center;
}

.console-housing {
  background-color: rgba(255,255,255,0.9);
  backdrop-filter: blur(24px);
  border-radius: 32px;
  box-shadow: 0 30px 60px -12px rgba(0,96,100,0.25);
  padding: 16px;
  border: 4px solid #ffffff;
  width: 100%;
  max-width: 1320px; 
  position: relative;
}
  
/* The Inner Glowing Rim */
.console-housing::after {
  content: ''; position: absolute; inset: 0; border-radius: 24px;
  border: 2px solid rgba(0,188,212,0.25); /* Aviation Teal Glow */
  pointer-events: none; z-index: 100;
  margin: -2px; /* Offset to hug the white border */
}

.screen-surface {
  background: var(--surface-screen);
  border-radius: 16px;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.04);
  border: 1px solid #e2e8f0;
  overflow: hidden; 
  position: relative;
  /* min-height removed so it fits content snugly if needed */
  display: flex; 
  flex-direction: column;
}

/* The rainbow strip at the top */
.brand-strip {
  background: linear-gradient(90deg, var(--aviation-teal) 0%, #26c6da 50%, var(--retro-coral) 100%);
  height: 8px; width: 100%; position: absolute; top: 0; left: 0; z-index: 5;
}

/* ================================================== */
/* ===========  5. INPUT STAGE (The Bezel) ========== */
/* ================================================== */
.input-stage {
  flex-grow: 1;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  /* GRID APPLIED HERE ONLY (Inside the machine) */
  background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
  background-size: 30px 30px;
  /* Vignette */
  background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.8) 100%),
              radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
  background-size: 100% 100%, 30px 30px;
  border-radius: 16px; /* Match screen surface inner radius */
}

.input-stage-wrapper {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 80vh; width: 100%;
}

.input-bezel {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(25px);
    padding: 5rem; 
    border-radius: 40px;
    /* RESTORED: The Glassy Double Bezel */
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 
        0 30px 70px -15px rgba(0,0,0,0.15), /* Deep Drop */
        0 0 0 8px rgba(255, 255, 255, 0.3), /* Outer Glass Ring */
        inset 0 0 20px rgba(255,255,255,0.5); /* Inner Glow */
    max-width: 1100px; width: 90%;
    text-align: center;
    animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    position: relative;
}
@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

.huge-input {
    border: none; border-bottom: 3px solid #cbd5e1;
    font-family: var(--font-body); font-size: 2rem; font-weight: 300;
    color: var(--text-dark);
    width: 100%; text-align: center; padding: 1.5rem;
    background: transparent; outline: none; transition: all 0.3s;
}
.huge-input:focus { border-bottom-color: var(--aviation-teal); background: rgba(255,255,255,0.5); }
.huge-input::placeholder { color: #94a3b8; font-style: italic; }

.btn-launch {
    background: linear-gradient(135deg, var(--retro-coral) 0%, #f4511e 100%);
    color: white; font-family: var(--font-data); font-size: 1.2rem; letter-spacing: 2px;
    padding: 1rem 3.5rem; border-radius: 50px; border: none;
    box-shadow: 0 10px 20px rgba(244, 81, 30, 0.3); transition: all 0.2s;
    margin-top: 2rem;
}
.btn-launch:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(244, 81, 30, 0.4); }


/* ================================================== */
/* ======  6. GOAL SELECTION (Monolith Flip) ======== */
/* ================================================== */
.goal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap: 3rem; 
    padding: 4rem; 
    perspective: 2500px;
    justify-content: center;
    /* RESTORED: The Dot Grid behind the cards */
    background-color: #f8fafc;
    background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 24px 24px;
    /* Inner Shadow to create depth for the grid area */
    box-shadow: inset 0 0 40px rgba(0,0,0,0.03);
}

.flip-card {
    height: 520px; width: 100%; cursor: pointer; position: relative;
    opacity: 0; 
    animation: slide-up-deal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
@keyframes slide-up-deal { from { opacity: 0; transform: translateY(60px); } to { opacity: 1; transform: translateY(0); } }

.flip-card-inner {
    position: relative; width: 100%; height: 100%;
    /* The Heavy Monolith Physics Easing */
    transition: transform 2.2s cubic-bezier(0.19, 1, 0.22, 1);
    transform-style: preserve-3d; 
    transform-origin: center center;
    /* START STATE: 0 degrees on the DIAGONAL Axis (X=1, Y=1, Z=0) */
    transform: rotate3d(1, 1, 0, 0deg);
}

/* THE TRIGGER: Rotate 180 degrees on the Diagonal Axis */
.flip-card.revealed .flip-card-inner { 
    transform: rotate3d(1, 1, 0, 180deg); 
}

.flip-card-front, .flip-card-back {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden; border-radius: 24px;
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
    overflow: hidden; background: white;
    -webkit-font-smoothing: antialiased;
}

/* --- BACK (Starts Visible, Face Down relative to flip axis) --- */
.flip-card-back { 
    z-index: 2; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    border: 4px solid white;
    /* No rotation needed, it starts facing the user */
    transform: rotate3d(0,0,0,0); 
}

/* --- FRONT (Starts Hidden, Pre-Rotated Diagonally) --- */
.flip-card-front { 
    z-index: 1; 
    /* Pre-rotate 180deg on the SAME 1,1,0 axis so it matches up when flipped */
    transform: rotate3d(1, 1, 0, 180deg); 
    display: flex; flex-direction: column; justify-content: space-between; padding: 0;
    border: 1px solid #e2e8f0;
}

/* Card Content Styling */
.card-header-plate { height: 140px; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; }

.card-domain-badge {
    position: absolute; top: 20px;
    background: rgba(255,255,255,0.3); backdrop-filter: blur(4px);
    padding: 6px 16px; border-radius: 20px; color: white;
    font-family: var(--font-data); font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.5);
}

.card-icon-float {
    position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%);
    width: 70px; height: 70px; background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 4px solid white;
}

.card-body { padding: 50px 30px 20px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.card-title { font-size: 1.5rem; color: #263238; margin-bottom: 0.75rem; line-height: 1.2; }
.card-footer { padding: 0 30px 30px; }

.btn-select-pill {
    width: 100%; padding: 16px 0; border-radius: 50px; border: none;
    font-family: var(--font-data); font-size: 0.9rem; letter-spacing: 2px;
    color: white; cursor: pointer; transition: all 0.2s;
}
.btn-select-pill:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); }

/* Rejected State */
.flip-card.rejected .card-body { background: #fff1f0; }
.flip-card.rejected .flip-card-front { border-color: #ffcdd2; }
.flip-card.rejected .btn-select-pill { background: var(--danger) !important; cursor: not-allowed; opacity: 0.8; }

/* Pattern Overlay */
.card-pattern-overlay {
  position: absolute; inset: 0;
  background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
  background-size: 24px 24px; pointer-events: none;
}

/* ================================================== */
/* ==============  7. OUTCOME DASHBOARD  ============ */
/* ================================================== */
.header-sidebar {
    background-color: #f8fafc; border-right: 1px solid #e2e8f0;
    padding: 2.5rem; display: flex; flex-direction: column; align-items: center; text-align: center;
}

.image-portal {
    width: 100%; aspect-ratio: 1/1; border-radius: 20px;
    background: white; border: 4px solid white;
    box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
    position: relative; overflow: hidden; margin-bottom: 1.5rem;
}
/* Stacking fix for Image Fade */
.image-portal img {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; transition: opacity 0.8s ease-in-out;
}

.domain-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: white; border: 1px solid #cbd5e1; border-radius: 50px;
    padding: 8px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Accordion & Tables */
.module-header {
    padding: 1.2rem 2rem; display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; border-left: 6px solid transparent; background-color: #fff;
    margin-bottom: 1px; border-radius: 6px; transition: all 0.2s;
}
.module-header:hover { transform: translateX(4px); }
.phase-icon {
    width: 32px; height: 32px; background: rgba(255,255,255,0.25); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-brand); color: white; backdrop-filter: blur(2px);
}

.retro-table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
.retro-table thead th {
    background-color: #f8fafc; font-family: var(--font-data); 
    letter-spacing: 1px; padding: 12px 20px; border-bottom: 2px solid #e2e8f0;
}
.retro-table td { padding: 16px 20px; border-bottom: 1px dashed #e2e8f0; vertical-align: middle; }

.phase-title {
    /* NEW: Using Righteous font */
    font-family: var(--font-brand); 
    font-size: 1.2rem; 
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* Legend Items (Clickable) */
.phase-legend-item {
    cursor: pointer;
    transition: all 0.2s;
    padding: 4px 8px;
    border-radius: 4px;
}
.phase-legend-item:hover {
    background-color: rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

/* CE Pills */
.ce-capsule {
    display: inline-flex; align-items: center;
    /* Ensure background comes from var */
    background-color: var(--node-color, #78909c); 
    border-radius: 50px; 
    padding: 3px 12px 3px 4px; 
    margin: 0 3px;
    cursor: pointer; 
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.3);
}
.ce-capsule:hover { 
    transform: translateY(-1px); 
    box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
    filter: brightness(1.1);
}

.ce-icon-box {
    width: 22px; height: 22px; 
    border-radius: 50%;
    background-color: rgba(255,255,255,0.2); /* Subtle contrast */
    color: white;
    display: flex; align-items: center; justify-content: center;
    margin-right: 8px;
    font-size: 0.7rem;
}

.ce-pill-text {
    font-family: 'Manrope', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    color: white; /* Force White Text */
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ce-pill {
  display: inline-flex; align-items: center; padding: 3px 10px 3px 4px; margin: 0 3px;
  border-radius: 50px; 
  color: white; background-color: var(--node-color, #78909c);
  border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  cursor: pointer; transition: transform 0.1s;
  font-family: var(--font-body); font-size: 0.75rem; font-weight: 700;
}
.ce-pill:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

/* The Icon Circle: White BG, Colored Icon */
.ce-pill-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 18px; height: 18px; border-radius: 50%; margin-right: 6px;
  background: white; color: var(--node-color, #78909c);
}
.status-block {
  font-family: var(--font-data); font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  padding: 6px 12px; border-radius: 8px; display: inline-block; min-width: 80px; text-align: center; color: white;
}

/* ================================================== */
/* ==============  8. SPECULATION MODAL  ============ */
/* ================================================== */

/* --- A. The App Shell (Horizon Layout) --- */
.ce-app-shell {
    height: 90vh; /* Fixed viewport height */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-color: #ffffff;
    border-radius: 16px; /* Modern Radius */
    box-shadow: 
        0 30px 80px -20px rgba(0,0,0,0.4),
        0 0 0 1px rgba(0,0,0,0.05);
    border: 4px solid #ffffff; /* White bezel */
}

/* --- B. The System Identity Header --- */
.ce-modal-header {
    /* Dynamic Phase Color + Texture */
    background: linear-gradient(135deg, var(--phase-color), rgba(0,0,0,0.15) 100%);
    color: white;
    flex-shrink: 0;
    padding: 1rem 2rem;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    overflow: hidden; /* Clips the ghost icon */
    z-index: 20;
}

/* Icon Box */
.node-icon-box {
    width: 56px; height: 56px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    font-size: 1.8rem; color: #fff;
    flex-shrink: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    margin-right: 1.2rem;
}

/* Text Stack */
.header-text-block {
    display: flex; flex-direction: column; justify-content: center;
}
.ce-modal-header .ce-title {
    font-family: var(--font-brand);
    font-weight: 500;
    font-size: 2rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0;
    line-height: 1;
    text-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
.ce-header-metadata {
    font-family: var(--font-data);
    font-size: 0.8rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    opacity: 0.9;
    margin-top: 4px;
}

/* Giant Ghost Icon (Background) */
.header-ghost-icon {
    position: absolute;
    right: 15%; 
    top: 50%;
    transform: translateY(-50%) rotate(-15deg);
    font-size: 12rem;
    color: white;
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
}

/* Header Controls */
.btn-glass {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    border-radius: 50px;
    padding: 8px 18px;
    font-family: var(--font-data);
    font-size: 0.9rem;
    letter-spacing: 1px;
    transition: all 0.2s;
    backdrop-filter: blur(4px);
}
.btn-glass:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(255,255,255,0.1);
}
.btn-close-custom {
    background: none; border: none;
    color: rgba(255,255,255,0.7);
    font-size: 1.5rem; transition: color 0.2s;
}
.btn-close-custom:hover { color: white; }


/* --- C. Readiness Bar --- */
.progress-bar-container {
    background: white;
    padding: 0;
    height: 6px; 
    flex-shrink: 0;
    border-bottom: 1px solid #e2e8f0;
    z-index: 19;
}
.progress-bar-container .progress-bar { 
    background-color: var(--phase-color);
    box-shadow: 0 2px 10px var(--phase-color);
}


/* --- D. Workspace Layout (Split View) --- */
.ce-workspace-body {
    flex-grow: 1;
    display: flex;
    flex-direction: row;
    overflow: hidden;
}

.ce-main-column {
    flex: 1;
    display: flex; flex-direction: column;
    min-width: 0;
    background-color: var(--surface-screen);
    position: relative;
}

/* Sidebar */
.ai-sidebar {
    width: 340px;
    flex-shrink: 0;
    border-left: 1px solid #e2e8f0;
    background-color: #ffffff;
    display: flex; flex-direction: column;
    z-index: 15;
    box-shadow: -5px 0 30px rgba(0,0,0,0.03);
}


/* --- E. Tab Navigation --- */
.ce-nav-tabs {
    background: white;
    padding: 0 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    flex-shrink: 0;
    display: flex; gap: 1rem;
}
.ce-nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-data);
    font-size: 1rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 1rem 0.4rem;
    transition: all 0.2s;
}
.ce-nav-tabs .nav-link:hover { color: var(--text-dark); }
.ce-nav-tabs .nav-link.active {
    color: var(--phase-color);
    background: transparent;
    border-bottom-color: var(--phase-color);
}
/* Tab Counts */
.count-badge { font-family: var(--font-body); font-weight: 800; vertical-align: top; font-size: 0.65em; }


/* --- F. Content Area & Grids --- */
.ce-app-content {
    flex-grow: 1; overflow-y: auto; padding: 0; position: relative;
}

/* The Lithographic Grid Pattern (High Density Vibe) */
.bg-technical-grid {
    background-color: var(--surface-screen);
    background-image: 
        radial-gradient(#cbd5e1 1.5px, transparent 1.5px),
        radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.02);
}


/* --- G. THE DASHBOARD (Hero & Metrics) --- */

/* 1. System Hero Card (Strategic Context) */
.system-hero-card {
    background-color: var(--phase-color);
    /* Overlay a subtle gradient for depth */
    background-image: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.05) 100%);
    border-radius: 16px;
    padding: 2rem;
    position: relative;
    overflow: hidden;
    color: white;
    box-shadow: 0 15px 40px -10px rgba(0,0,0,0.2);
    min-height: 240px; /* Taller to accommodate the ghost icon */
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; 
    flex-direction: column; 
    justify-content: center;
}

/* The Massive Ghost Icon */
.system-hero-card .hero-ghost-icon {
    position: absolute;
    right: -20px; bottom: -40px;
    font-size: 14rem;
    color: rgba(255,255,255,0.3);
    transform: rotate(-15deg);
    pointer-events: none;
    z-index: 1;
}

/* Typography inside Hero */
.hero-label {
    font-family: 'Antonio', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

/* The Main Status Text (e.g. "AWAITING INPUT") */
.status-card-value {
    font-family: 'Righteous', cursive;
    font-size: 3rem;
    line-height: 1;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}

/* 2. Metric Tiles (The White Squares) */
.metric-tile {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 4px 6px rgba(0,0,0,0.01);
    transition: all 0.2s ease;
}

.metric-tile:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
    border-color: var(--phase-color);
}

.metric-number {
    font-family: 'Righteous', cursive;
    font-size: 2.5rem;
    color: var(--text-dark);
    line-height: 1;
    margin: 0.5rem 0;
}

.metric-label {
    font-family: 'Antonio', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    text-transform: uppercase;
}

/* 3. Logic Stream / Alert Cards */
.bg-danger-soft {
    background-color: #fef2f2;
    border: 1px solid #fee2e2;
}

/* 4. Animation Utilities (Scan Line) */
.scan-overlay {
    position: absolute; top: 0; left: 0; bottom: 0; width: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    transform: translateX(-100%);
    animation: scan 2s infinite;
    opacity: 0.3;
    pointer-events: none;
    z-index: 3;
}
@keyframes scan { 
    0% { transform: translateX(-100%); } 
    100% { transform: translateX(200%); } 
}

/* --- H. Collection Cards (Vertical Strips) --- */
.collection-container { padding: 1.5rem; }

.collection-card-modern {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px;
    padding: 1.2rem; margin-bottom: 0.8rem;
    display: flex; align-items: center;
    position: relative; overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
/* The Color Strip */
.collection-card-modern::before {
    content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
    background-color: var(--phase-color); transition: width 0.2s;
}
.collection-card-modern:hover { transform: translateX(4px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
.collection-card-modern:hover::before { width: 8px; }

/* AI Proposed Variant */
.collection-card-modern.border-dashed {
    border-style: dashed; border-color: #6366f1; background-color: #f8faff;
}
.collection-card-modern.border-dashed::before { background-color: #6366f1; }

.card-title-modern { font-family: var(--font-data); font-size: 1.1rem; color: var(--text-dark); margin-bottom: 2px; }
.card-subtitle-modern { font-family: var(--font-body); font-size: 0.85rem; color: var(--text-muted); }


/* --- I. The Intelligence Sidebar --- */
/* Sidebar Header Gradient */
.sidebar-persona-header {
    color: white; padding: 1rem; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Default */
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: background 0.3s;
}
/* Context Gradients */
.persona-research { background: linear-gradient(135deg, #00b09b, #96c93d); }
.persona-risk { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
.persona-stakeholder { background: linear-gradient(135deg, #ffb347, #ffcc33); }
.persona-advocacy { background: linear-gradient(135deg, #f12711, #f5af19); }
.persona-default { background: linear-gradient(135deg, #667eea, #764ba2); }

#ai-sidebar-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

.btn-gradient-purple {
    background: linear-gradient(45deg, #6f42c1, #3b82f6); border: none; color: white;
    font-family: var(--font-data); letter-spacing: 1px;
}
.btn-gradient-purple:hover { color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3); }

/* --- J. Footer --- */
.ce-modal-footer { 
    background-color: #ffffff; border-top: 1px solid #e2e8f0; 
    flex-shrink: 0; padding: 0.8rem 1.5rem;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.02);
}

/* --- K. Smart Widgets --- */
/* Range Slider */
.ce-range-input { 
    -webkit-appearance: none; appearance: none; width: 100%; height: 6px; 
    background: #e2e8f0; border-radius: 10px; outline: none;
}
.ce-range-input::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 18px; height: 18px; 
    border-radius: 50%; background: var(--phase-color, #6366f1); border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s ease;
}
.ce-range-input::-webkit-slider-thumb:hover { transform: scale(1.2); }

/* Toggle Switch */
.ce-toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.ce-toggle-slider {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1; border-radius: 34px; transition: .4s; cursor: pointer;
}
.ce-toggle-slider:before {
    content: ""; position: absolute; height: 18px; width: 18px;
    left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s;
}
input:checked + .ce-toggle-slider { background-color: var(--phase-color, #10b981); }
input:checked + .ce-toggle-slider:before { transform: translateX(20px); }

/* ================================================== */
/* ==============  9. LOADING & UTILITIES  ========== */
/* ================================================== */

.loading-spinner-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(10px);
    display: flex; justify-content: center; align-items: center; 
    z-index: 9999; transition: opacity 0.3s ease;
}
.loading-spinner-overlay.d-none { display: none !important; }

/* The HUD Container */
.spinner-box {
    min-width: 560px; 
    padding: 2.5rem 3rem 2.5rem 3.5rem;
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid #cbd5e1; 
    border-radius: 4px;
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6);
    display: flex; align-items: center; gap: 2.5rem; /* Gap between Atom and Text */
    position: relative; overflow: hidden;
}

/* Swirling Bar */
.spinner-box::before {
    content: ""; position: absolute; top: 0; left: 0; bottom: 0; width: 6px;
    background: linear-gradient(180deg, #e91e63, #00bcd4, #9c27b0, #ffc107, #66bd0e, #e91e63);
    background-size: 100% 400%; 
    animation: phase-swirl 3s linear infinite; z-index: 10;
}
@keyframes phase-swirl { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }

/* Background Shimmer */
.spinner-box::after {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
    transform: translateX(-100%); animation: shimmer 3s infinite;
}
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

/* --- VISUAL FIX: ATOM & ICON STACKING --- */

/* 1. Container keeps the atom and icon together */
.spinner-visual-stack {
    position: relative; 
    width: 64px; height: 64px; 
    flex-shrink: 0;
    display: flex; justify-content: center; align-items: center;
}

/* 2. The Atom (Background) */
.la-ball-atom, .la-ball-atom > div { position: relative; box-sizing: border-box; }
.la-ball-atom { display: block; font-size: 0; color: #fff; width: 64px; height: 64px; }
.la-ball-atom > div { display: inline-block; float: none; background-color: currentColor; border: 0 solid currentColor; }
.la-ball-atom > div:nth-child(1) {
    position: absolute; top: 50%; left: 50%; z-index: 1; 
    width: 70%; height: 70%; background: var(--retro-coral); 
    border-radius: 100%;
    transform: translate(-50%, -50%); /* Keep Nucleus stable */
    /* Removed nucleus shrink animation so icon stays framed nicely */
}
.la-ball-atom > div:not(:nth-child(1)) {
    position: absolute; left: 0; z-index: 0; width: 100%; height: 100%; background: none;
    animation: ball-atom-zindex 1.5s 0s infinite steps(2, end);
}
.la-ball-atom > div:not(:nth-child(1)):before {
    position: absolute; top: 0; left: 0; width: 14px; height: 14px; margin-top: -7px; margin-left: -7px;
    content: ""; border-radius: 50%; opacity: .85;
    animation: ball-atom-position 1.5s 0s infinite ease, ball-atom-size 1.5s 0s infinite ease;
}
/* Electron Colors */
.la-ball-atom > div:nth-child(2):before { background: var(--warning); } /* Amber */
.la-ball-atom > div:nth-child(3) { transform: rotate(120deg); }
.la-ball-atom > div:nth-child(3):before { background: var(--aviation-teal); } /* Cyan */
.la-ball-atom > div:nth-child(4) { transform: rotate(240deg); }
.la-ball-atom > div:nth-child(4):before { background: #9c27b0; } /* Purple */

@keyframes ball-atom-position { 50% { top: 100%; left: 100%; } }
@keyframes ball-atom-size { 50% { transform: scale(.5, .5); } }
@keyframes ball-atom-zindex { 50% { z-index: 10; } }


/* 3. The Domain Icon (Foreground) */
/* Positioned absolutely over the nucleus, never rotating */
.spinner-overlay-icon {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 20; /* Above the nucleus */
    color: white;
    font-size: 1.4rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}


/* --- CONTENT ALIGNMENT (Flush Left) --- */
.spinner-content {
    display: flex; flex-direction: column; flex-grow: 1; 
    justify-content: center; position: relative; min-height: 60px;
    /* VISUAL FIX: Force Left Alignment */
    text-align: left;
    align-items: flex-start;
}

.spinner-title { 
    font-family: var(--font-data); font-size: 1.8rem; color: #0f172a; 
    text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 1px;
    line-height: 1;
}

.spinner-text-stage {
    position: relative; width: 100%; height: 1.5rem;
    text-align: left; /* Ensure message sits left */
}

.spinner-message {
    font-family: var(--font-body); font-size: 1.1rem; color: #64748b; font-weight: 500;
    position: absolute; top: 0; left: 0; width: 100%;
    white-space: nowrap; overflow: hidden;
}

.fade-out { opacity: 0; pointer-events: none; }

.wipe-out { animation: textWipeOut 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; }
.wipe-in { animation: textWipeIn 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; animation-delay: 0.15s; clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%); }
@keyframes textWipeOut { 0% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 100% { clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%); } }
@keyframes textWipeIn { 0% { clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%); } 100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } }

/* ================================================== */
/* =======  10. HORIZON SYSTEM MASTHEAD  ============ */
/* ================================================== */
.horizon-system-bar {
    width: 100%; 
    max-width: 1400px;
    margin: 0 auto; /* Center the bar itself */
    display: flex; 
    justify-content: space-between; /* Space items across full width */
    align-items: center;
    padding: 1.5rem 2rem; 
    z-index: 100; 
    position: relative;
}

/* Left Spacer */
.masthead-spacer { width: 140px; } 

/* Center Lockup */
.masthead-title-lockup {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.masthead-pill {
    background: var(--aviation-teal);
    color: white;
    font-family: 'Antonio', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 50px;
    margin-bottom: 6px;
    box-shadow: 0 2px 8px rgba(0,188,212,0.3);
    font-weight: 700;
}

.masthead-brand {
    line-height: 0.8;
    color: var(--deep-space-blue); /* Dark Blue */
    text-shadow: 0 2px 0px rgba(255,255,255,0.6);
}

.brand-script {
    font-family: 'Mr Dafoe', cursive;
    font-size: 2.8rem;
    color: var(--retro-coral); /* Pop Color */
    margin-right: 10px;
    display: inline-block;
    transform: rotate(-4deg) translateY(-4px);
    text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
}

.brand-display {
    font-family: 'Righteous', cursive;
    font-size: 2.4rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #37474f; /* Slate */
}

/* Right Controls */
.masthead-controls { 
    display: flex; gap: 0.8rem; align-items: center; width: 140px; justify-content: flex-end;
}

.btn-masthead {
    width: 42px; height: 42px; 
    border-radius: 50%; 
    background: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.8); 
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    cursor: pointer; transition: all 0.2s;
    font-size: 1.1rem;
    text-decoration: none;
}
.btn-masthead:hover { 
    background: white; color: var(--aviation-teal); transform: translateY(-2px); 
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 38px; height: 38px; 
    border-radius: 50%; 
    background: linear-gradient(135deg, #ff7043, #d84315);
    color: white; 
    display: flex; align-items: center; justify-content: center; 
    font-weight: bold;
    font-family: 'Antonio', sans-serif; 
    border: 2px solid white; 
    box-shadow: 0 4px 10px rgba(244, 81, 30, 0.3);
    cursor: pointer;
}

/* ================================================== */
/* ========  11. DASHBOARD & SYSTEM WIDGETS  ======== */
/* ================================================== */

/* --- A. The Sidebar Stack (Vertical Anchors) --- */
.system-anchor-card {
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    border: 1px solid #e2e8f0;
    /* Clean, technical background */
    background: linear-gradient(to right, #ffffff, #fafafa); 
}

.system-anchor-card:hover {
    transform: translateX(4px); /* Slide out towards the content */
    border-color: #cbd5e1;
    background: #ffffff;
    box-shadow: 0 4px 15px -3px rgba(0,0,0,0.08) !important;
    z-index: 2; /* Pop above neighbors */
}

/* Typography for the anchors */
.system-anchor-card .font-body {
    font-family: 'Manrope', sans-serif;
    letter-spacing: -0.01em;
}

/* --- B. The Horizon Gauge (Top Widget) --- */
.system-node-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.system-node-card:hover {
    transform: translateY(-2px); /* Lift up */
    box-shadow: 0 12px 30px -10px rgba(0, 188, 212, 0.15) !important; /* Teal glow */
    border-color: var(--aviation-teal);
}

/* Icon Animation Group Hook */
/* When hovering the card, animate the icon inside */
.system-node-card.group:hover i {
    transform: scale(1.1);
    color: var(--aviation-teal) !important;
}
.system-node-card i { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }


/* --- C. Utility: Borders & Layouts --- */
.border-dashed {
    border-style: dashed !important;
}

/* Ensure the sidebar goes all the way down */
.console-housing .row {
    min-height: 85vh; /* Match container height */
    align-items: stretch;
}

/* Refined typography for the Executive Summary box */
.command-deck-wrapper .lead {
    font-weight: 400;
    color: #2c3e50;
    letter-spacing: 0.01em;
}

/* ================================================== */
/* ========  12. STRATEGIC CHARTER STYLING  ========= */
/* ================================================== */

/* The "Fun" Executive Summary Box */
.charter-card {
    background: rgba(255, 255, 255, 0.85); /* Slightly see-through */
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.6);
    border-top: 4px solid var(--aviation-teal); /* Pop of color on top */
    border-radius: 16px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px -5px rgba(0, 188, 212, 0.15);
}

.charter-header-text {
    font-family: 'Righteous', cursive; /* Requested Font */
    font-size: 1.1rem;
    letter-spacing: 1px;
    color: var(--aviation-teal);
    text-transform: uppercase;
}

.charter-content {
    position: relative; z-index: 2;
    font-family: 'Manrope', sans-serif;
    color: #263238; /* Darker slate for readability */
    text-shadow: 0 1px 0 rgba(255,255,255,0.8);
}

/* The Ghost Icon remains the same */
.domain-ghost-watermark {
    position: absolute; bottom: -20px; right: 10px;
    font-size: 12rem; color: var(--aviation-teal); opacity: 0.06;
    transform: rotate(-15deg); pointer-events: none; z-index: 0;
    transition: all 0.5s ease;
}


/* ================================================== */
/* ======  13. PILL SYSTEMS (ANCHORS & ATOMS)  ====== */
/* ================================================== */

/* --- A. CE CAPSULE ("Action Atoms" - Colored Fill) --- */
/* Used in Phase Tables, Lists, and Narratives */
.ce-capsule {
    display: inline-flex; align-items: center;
    vertical-align: middle;
    /* Solid Color Body */
    background-color: var(--node-color, #78909c); 
    color: white !important;
    
    /* Pill Shape */
    border-radius: 50px; 
    padding: 3px 12px 3px 3px; /* Tight left for the dot */
    margin: 2px 3px;
    
    /* Interaction */
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    line-height: 1.2;
    max-width: 100%;
}

.ce-capsule:hover {
    transform: translateY(-2px) scale(1.02);
    filter: brightness(1.1);
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    z-index: 10;
}

/* The White Dot containing the Colored Icon */
.ce-capsule i, 
.ce-capsule .ce-icon-box { 
    display: flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; 
    border-radius: 50%;
    
    /* Inverted Colors */
    background-color: white; 
    color: var(--node-color, #78909c) !important;
    
    margin-right: 8px;
    font-size: 0.75rem;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
    flex-shrink: 0;
}

/* Text Label */
.ce-capsule-text {
    font-family: var(--font-body);
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


/* --- B. SYSTEM HIGHLIGHT ("Context Tags" - White Fill) --- */
/* Used Inline within the Executive Charter text */
.sys-highlight {
    display: inline-flex; align-items: center;
    vertical-align: middle;
    
    /* White Body with Colored Border */
    background-color: white;
    border: 2px solid var(--sys-color, #cbd5e1); 
    border-radius: 50px;
    
    padding: 2px 10px 2px 2px; 
    margin: 0 3px;
    
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    cursor: help; 
    transition: all 0.2s ease;
    max-width: 100%;
    white-space: nowrap;
}

.sys-highlight:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background-color: #f8fafc;
    border-color: var(--sys-color);
}

/* The Colored Dot containing the White Icon */
.sys-highlight-dot,
.sys-highlight .sys-highlight-icon {
    display: flex; align-items: center; justify-content: center;
    width: 20px; height: 20px; 
    border-radius: 50%;
    
    /* Standard Colors */
    background-color: var(--sys-color, #64748b);
    color: white !important;
    
    margin-right: 6px;
    font-size: 0.65rem;
    flex-shrink: 0;
}

/* Text Label */
.sys-highlight-text {
    font-family: var(--font-data); 
    font-size: 0.75rem; 
    font-weight: 700;
    text-transform: uppercase; 
    color: #475569; /* Slate 600 */
    letter-spacing: 0.5px;
}


/* ================================================== */
/* ========  14. SYSTEM SIDEBAR WIDGETS        ====== */
/* ================================================== */

/* --- A. The Sidebar Stack (Rounded Cards) --- */
.system-anchor-card {
    display: flex; align-items: center;
    
    /* Pill Shape & Border */
    background-color: white;
    border: 2px solid var(--sys-color, #cbd5e1);
    border-radius: 50px; /* Fully Rounded */
    
    padding: 4px 16px 4px 4px; /* Space for right text */
    margin-bottom: 0.75rem;
    
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    position: relative; 
    overflow: hidden;
    min-height: 48px;
}

.system-anchor-card:hover {
    transform: translateX(4px) scale(1.01);
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    background-color: #fff; /* Keep white to contrast border */
}

/* The Large Colored Icon Circle */
.sys-icon-circle {
    width: 38px; height: 38px;
    border-radius: 50%;
    
    /* Colored Fill */
    background-color: var(--sys-color, #64748b);
    color: white;
    
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    font-size: 0.9rem;
}

/* Data Column */
.sys-meta-col {
    display: flex; flex-direction: column;
    justify-content: center;
    flex-grow: 1;
    min-width: 0; /* Fix for flexbox truncation */
    line-height: 1.1;
}

/* Label (Top small text) */
.sys-label {
    font-family: var(--font-data); 
    font-size: 0.6rem; 
    text-transform: uppercase; 
    color: var(--sys-color); 
    letter-spacing: 1px; 
    opacity: 0.8; 
    margin-bottom: 2px;
    font-weight: 700;
    display: flex; justify-content: space-between;
}

/* Value (Main text) */
.sys-value {
    font-family: var(--font-body); 
    font-weight: 700; 
    font-size: 0.9rem; 
    color: #1e293b; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis;
}

/* --- B. "Add Parameter" Button --- */
#system-anchor-stack .btn-outline-secondary {
    border-radius: 50px;
    border: 2px dashed #cbd5e1;
    color: #94a3b8;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.2s;
}
#system-anchor-stack .btn-outline-secondary:hover {
    border-color: var(--aviation-teal);
    color: var(--aviation-teal);
    background: #f0fdff;
}

/* --- C. System Modal Layouts --- */
/* Left Panel */
.sys-modal-left {
    color: white;
    position: relative;
    overflow: hidden;
    display: flex; flex-direction: column; justify-content: space-between;
}
/* Texture */
.sys-modal-texture {
    position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.2; pointer-events: none; z-index: 0;
}

/* Protocol Toggle (Specify vs Speculate) */
.sys-protocol-toggle {
    display: flex; 
    background-color: #f1f5f9; 
    padding: 4px; 
    border-radius: 8px;
    margin-bottom: 1.5rem;
}
.sys-protocol-btn {
    flex: 1;
    border: none;
    background: transparent;
    padding: 8px;
    font-family: var(--font-data);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #94a3b8;
    border-radius: 6px;
    transition: all 0.2s;
}
.sys-protocol-btn.active {
    background: white;
    color: #1e293b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.sys-protocol-btn.active.speculate {
    color: #6366f1; /* Indigo for AI */
}

/* Entity Stack (Left Column Visualizer) */
.sys-entity-card {
    background: white;
    border-radius: 8px;
    padding: 8px 12px;
    display: flex; align-items: center; gap: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    border-left: 4px solid var(--sys-color);
    margin-bottom: 8px;
    animation: slideInLeft 0.3s ease forwards;
}
.sys-entity-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: #f1f5f9;
    color: #64748b;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: bold;
}

üì± app.py:
# app.py (Auto-Migration Logic Added)
import os
import logging
import asyncio
import sys
from flask import Flask
from flask_migrate import Migrate
from dotenv import load_dotenv
from models import db
from sqlalchemy import text # Import text for raw sql
import colorlog
from ce_nodes import NODES

if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

load_dotenv()

app = Flask(__name__)
migrate = Migrate()

app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

handler = colorlog.StreamHandler()
handler.setFormatter(colorlog.ColoredFormatter(
    '%(log_color)s%(asctime)s - %(name)s - %(levelname)s - %(message)s'
))
logger = logging.getLogger()
logger.setLevel(logging.INFO)
if not logger.handlers:
    logger.addHandler(handler)

@app.template_filter()
def get_badge_class_from_status(status):
   return {
       'Proposed': 'bg-info',
       'In Progress': 'bg-warning text-dark',
       'Completed': 'bg-success',
       'Rejected': 'bg-danger'
   }.get(status, 'bg-secondary')

# app.py
@app.context_processor
def inject_nodes():
    from system_nodes import SYSTEM_NODES
    from ce_nodes import NODES
    return dict(nodes=NODES, system_nodes=SYSTEM_NODES)

if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    db.init_app(app)
    migrate.init_app(app, db)
    
    # --- AUTO-MIGRATION CHECK ---
    with app.app_context():
        try:
            # Check if system_data column exists
            with db.engine.connect() as conn:
                # This query is SQLite specific, usually safe for local dev
                # For Postgres you'd check information_schema
                try:
                    result = conn.execute(text("SELECT system_data FROM ssol LIMIT 1"))
                except Exception:
                    logger.warning("Column 'system_data' missing in 'ssol'. Attempting to add it...")
                    # Add the column. JSONType in models.py maps to TEXT for SQLite
                    conn.execute(text("ALTER TABLE ssol ADD COLUMN system_data TEXT"))
                    conn.commit()
                    logger.info("Successfully added 'system_data' column.")
        except Exception as e:
            logger.error(f"Auto-migration check failed: {e}")

from routes import routes_bp
app.register_blueprint(routes_bp)

if __name__ == '__main__':
    app.run(debug=True, port=5000)

üüß ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

üîµ ce_cards.js:
// ce_cards.js (The Speculation Environment Controller - Horizon Fusion v2025.23)

import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- 1. STATE MANAGEMENT ---
let state = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    details_data: {},
    nodeSchema: {},
    isSaving: false
};

// --- 2. PERSONA MATRIX ---
const PERSONAS = {
    "Research": { title: "DEEP TRUTH ENGINE", icon: "fa-flask", class: "persona-research", tone: "Empirical" },
    "Risk": { title: "SECURITY OVERWATCH", icon: "fa-shield-virus", class: "persona-risk", tone: "Critical" },
    "Stakeholder": { title: "NETWORK DIPLOMAT", icon: "fa-handshake", class: "persona-stakeholder", tone: "Strategic" },
    "Advocacy": { title: "AMPLIFIER", icon: "fa-bullhorn", class: "persona-advocacy", tone: "Persuasive" },
    "Environment": { title: "SYSTEM ECOLOGIST", icon: "fa-leaf", class: "persona-research", tone: "Holistic" },
    "Timeline": { title: "TEMPORAL ARCHITECT", icon: "fa-stopwatch", class: "persona-default", tone: "Linear" },
    "Default": { title: "SPECULATE CO-PILOT", icon: "fa-brain", class: "persona-default", tone: "Helpful" }
};

// --- 3. INITIALIZATION ---

export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    modalContainer.innerHTML = modalHtml;
    
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    if (!modalElement) return console.error("Modal element not found.");

    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        // 1. Resolve Schema
        const nodeConfig = (window.NODES && window.NODES[p_ceType]) ? window.NODES[p_ceType] : (window.NODES['Default']);

        // 2. Hydrate State
        const d = ceData?.data || {};
        state = {
            modalElement, 
            ceId, 
            ceType: p_ceType, 
            activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
            nodeSchema: nodeConfig,
            isSaving: false
        };
        
        // 3. Boot System
        render(); 
        setupEventListeners();
        
        // 4. Auto-Start ("One-Hit" Check)
        checkAndTriggerAutoPopulation();

    }, { once: true });

    modalElement.addEventListener('hidden.bs.modal', () => modalElement.remove());
    modal.show();
}

// --- 4. AUTOMATION LOGIC ---

function checkAndTriggerAutoPopulation() {
    const isFresh = ['prerequisites', 'stakeholders', 'assumptions'].every(k => state.collections[k].length === 0);
    
    if (isFresh) {
        console.log("System Scan Initiated: Fresh Node Detected");
        
        const statusCard = state.modalElement.querySelector('.system-status-card');
        const statusValue = state.modalElement.querySelector('.status-card-value');
        
        if (statusCard && statusValue) {
            statusValue.innerText = "SCANNING...";
            statusValue.classList.add('text-primary');
            statusCard.classList.add('scanning'); 
        }

        triggerEnhancement('summary', null); 
        setTimeout(() => triggerSpeculation('prerequisites'), 1200);
        setTimeout(() => triggerSpeculation('stakeholders'), 2800);
        setTimeout(() => triggerSpeculation('assumptions'), 4200);
    }
}

// Core View Updater
function updateModalView() {
    const typeKey = currentNodesArray[currentIndex];
    const config = systemNodesConfig[typeKey] || {};
    const modalEl = document.getElementById('systemConfigModal');
    
    // --- 1. Identity Panel (LEFT) ---
    const panel = document.getElementById('sys-identity-panel');
    panel.style.backgroundColor = config.color || '#333';
    document.getElementById('sys-display-icon').className = `fas ${config.icon} fa-2x text-white`;
    document.getElementById('sys-display-label').textContent = config.label;
    
    // --- 2. Calibration Console (RIGHT) ---
    // Definition
    document.getElementById('sys-display-desc').textContent = config.description;
    
    // Examples (NEW)
    const exContainer = document.getElementById('sys-examples-container');
    exContainer.innerHTML = "";
    if(config.examples && Array.isArray(config.examples)) {
        config.examples.forEach(ex => {
            const badge = document.createElement('span');
            badge.className = "badge bg-white border text-secondary fw-normal cursor-pointer hover-shadow";
            badge.textContent = ex;
            badge.onclick = () => {
                document.getElementById('sys-param-value').value = ex;
                updateInjectionPreview(typeKey);
                updateActivePill(config.icon); // Update Visuals immediately
            };
            exContainer.appendChild(badge);
        });
    }

    // Pre-Populate Input (Fixed Logic)
    document.getElementById('sys-param-type').value = typeKey;
    const input = document.getElementById('sys-param-value');
    
    // We use dataset.tempValue which was set in openSystemEditor
    const savedVal = modalEl.dataset.tempValue;
    
    // Visual State Logic:
    // If 'savedVal' exists, the anchor is set. If not, it's pending.
    if(savedVal) {
        input.value = savedVal;
        document.getElementById('sys-status-badge').className = "badge bg-success-subtle text-success border border-success-subtle font-data rounded-pill px-3";
        document.getElementById('sys-status-badge').innerHTML = '<i class="fas fa-check-circle me-1"></i> CALIBRATED';
    } else {
        input.value = '';
        document.getElementById('sys-status-badge').className = "badge bg-secondary-subtle text-secondary border border-secondary-subtle font-data rounded-pill px-3";
        document.getElementById('sys-status-badge').innerHTML = '<i class="fas fa-circle me-1" style="font-size:8px;"></i> UNSET';
    }

    // --- 3. Visual Pill Renderer (LEFT Panel) ---
    updateActivePill(config.icon);

    // Live Listeners
    input.oninput = () => {
        updateInjectionPreview(typeKey);
        updateActivePill(config.icon);
    };
    
    updateInjectionPreview(typeKey);

    // Pagination Rendering... (Same as before)
}

// Helper to render the Giant Pill on the Left
function updateActivePill(iconClass) {
    const val = document.getElementById('sys-param-value').value;
    const container = document.getElementById('sys-active-pill-container');
    
    if (val && val.trim() !== "") {
        // Render Active State
        container.innerHTML = `
            <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-pill p-3 pe-5 d-flex align-items-center backdrop-blur transition-all">
                <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center shadow-sm me-3" 
                     style="width: 42px; height: 42px; flex-shrink: 0;">
                    <i class="fas ${iconClass} fa-lg"></i>
                </div>
                <div>
                    <div class="font-data text-white-50 x-small uppercase tracking-wide mb-0">ANCHOR VALUE</div>
                    <div class="font-body text-white fw-bold fs-5 leading-tight text-truncate" style="max-width: 220px;">
                        ${val}
                    </div>
                </div>
            </div>
        `;
    } else {
        // Render "Empty Slot" State
        container.innerHTML = `
             <div class="border border-dashed border-white border-opacity-25 rounded-pill p-4 text-center text-white-50 font-data small">
                <i class="fas fa-terminal me-2"></i> AWAITING INPUT
             </div>
        `;
    }
}

// --- 5. RENDER PIPELINE ---

function render() {
    if (!state.modalElement) return;
    renderAllCollections();
    renderOverviewStream();
    renderSidebarPersona();
    renderAiSidebarContent();
    updateDashboard();
}

function renderAllCollections() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(type => {
        renderCollectionList(type);
    });
}

function renderOverviewStream() {
    const container = state.modalElement.querySelector('#overview-logic-stream');
    if(!container) return;

    let signals = [];
    (state.collections.prerequisites || []).slice(0, 3).forEach(i => 
        signals.push({ type: 'PREREQ', text: i.title, icon: 'fa-check-square', color: 'text-primary' })
    );
    (state.collections.assumptions || []).slice(0, 2).forEach(i => 
        signals.push({ type: 'RISK', text: i.hypothesis, icon: 'fa-exclamation-circle', color: 'text-danger' })
    );

    if (signals.length === 0) {
        container.innerHTML = `<div class="text-center p-4 opacity-50"><i class="fas fa-wind mb-2"></i><div class="font-data small">No Signals</div></div>`;
        return;
    }

    container.innerHTML = `<ul class="list-group list-group-flush">` + signals.map(s => `
        <li class="list-group-item px-3 py-2 border-0 border-bottom signal-item type-${s.type}">
            <div class="d-flex align-items-center">
                <i class="fas ${s.icon} ${s.color} me-3"></i>
                <div class="text-truncate font-body small fw-bold text-dark">${s.text || 'Untitled'}</div>
            </div>
        </li>
    `).join('') + `</ul>`;
}

function renderCollectionList(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];

    if (items.length === 0) {
        let icon = "fa-wind";
        let text = "Auto-Generate";
        if (type === 'prerequisites') { icon = "fa-list-check"; text = "Speculate Prerequisites"; }
        if (type === 'stakeholders') { icon = "fa-users-viewfinder"; text = "Query Network"; }
        
        container.innerHTML = `
            <div class="text-center p-5 opacity-50 border border-dashed rounded bg-light mt-3">
                <i class="fas ${icon} fa-2x mb-3 text-muted"></i>
                <p class="font-data small text-muted mb-3">DATA STREAM EMPTY</p>
                <button class="btn btn-sm btn-outline-primary font-data rounded-pill px-4 btn-speculate-collection" data-collection="${type}">
                    <i class="fas fa-magic me-2"></i> ${text}
                </button>
            </div>`;
        return;
    }

    const schemaKey = type.slice(0, -1) + '_schema';
    const fields = state.nodeSchema[schemaKey] || [];
    const titleKey = fields[0]?.key || 'title';
    const subKey = fields[1]?.key || 'status';

    container.innerHTML = items.map(item => {
        const title = item[titleKey] || 'Untitled';
        const subtitle = item[subKey] || 'Pending';
        const isProposed = item.tags && item.tags.includes("AI");

        const extraClass = isProposed ? "border-dashed" : "";
        let stripColor = "var(--phase-color)";
        
        if (isProposed) stripColor = "#6366f1"; 
        else if (['Verified','Signed','Met'].includes(item.status)) stripColor = "#10b981"; 

        return `
        <div class="collection-card-modern ${extraClass}" style="position:relative;">
            <div style="position:absolute; left:0; top:0; bottom:0; width:5px; background-color:${stripColor};"></div>
            <div class="flex-grow-1 ps-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="card-title-modern">${title}</div>
                    ${isProposed ? '<span class="badge bg-primary-soft text-primary font-data" style="font-size:0.6em">PROPOSED</span>' : ''}
                </div>
                <div class="card-subtitle-modern text-truncate">${subtitle}</div>
            </div>
            <div class="d-flex align-items-center gap-1">
                ${isProposed 
                    ? `<button class="btn btn-sm btn-outline-success btn-accept p-1 px-2 shadow-sm" data-col="${type}" data-id="${item.id}" title="Accept"><i class="fas fa-check"></i></button>`
                    : `<button class="btn btn-sm btn-link text-muted p-1 btn-edit-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>`
                }
                <button class="btn btn-sm btn-link text-danger p-1 btn-delete-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-times"></i></button>
            </div>
        </div>`;
    }).join('');
}

// --- 6. DASHBOARD & METRICS ---

function updateDashboard() {
    // 1. Update Badges
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(k => {
        const count = (state.collections[k] || []).length;
        const badge = state.modalElement.querySelector(`.count-badge[data-collection="${k}"]`);
        if (badge) {
            badge.textContent = count;
            if(count > 0) {
                badge.classList.remove('bg-light', 'text-dark');
                badge.classList.add('bg-primary', 'text-white');
            }
        }
    });

    // 2. Calculate Score
    let score = 0;
    const totalGoal = 60; 
    Object.values(state.collections).flat().forEach(i => {
        score += 5; 
        if (['Verified', 'Met', 'Signed', 'Active'].includes(i.status)) score += 5;
    });
    if (state.details_data.summary && state.details_data.summary.length > 20) score += 10;

    const percent = Math.min(100, Math.floor((score / totalGoal) * 100));
    
    // 3. Update Bars (With Safety Checks)
    const bar = state.modalElement.querySelector('#ce-progress-bar');
    const lbl = state.modalElement.querySelector('#ce-progress-label');
    if(bar) bar.style.width = `${percent}%`;
    if(lbl) lbl.innerText = `${percent}%`;

    // 4. Update Status Card (CRITICAL FIX: Null Checks)
    const statusCard = state.modalElement.querySelector('.system-status-card');
    const statusVal = state.modalElement.querySelector('.status-card-value');
    
    if (statusCard && statusVal) {
        // Only update if we aren't in the middle of a scan
        if (!statusCard.classList.contains('scanning')) {
            statusVal.classList.remove('text-primary');
            if (percent === 0) statusVal.innerText = "INITIALIZED";
            else if (percent < 30) statusVal.innerText = "ANALYZING";
            else if (percent < 80) statusVal.innerText = "CALIBRATING";
            else statusVal.innerHTML = "<span class='text-success'>OPTIMIZED</span>";
        }
    }
}

function renderSidebarPersona() {
    const header = state.modalElement.querySelector('#ai-sidebar-header');
    if(!header) return;
    
    const persona = PERSONAS[state.ceType] || PERSONAS['Default'];
    header.className = 'sidebar-persona-header ' + (persona.class || 'persona-default');
    header.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="fas ${persona.icon} fa-lg"></i>
                <span class="font-brand" style="letter-spacing:1px;">${persona.title}</span>
            </div>
            <i class="fas fa-circle text-white fa-xs opacity-75 animate-pulse"></i>
        </div>
        <div class="small opacity-75 mt-1 font-data" style="letter-spacing:0.5px;">MODE: ${persona.tone.toUpperCase()}</div>
    `;
}

function renderAiSidebarContent() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if(!content) return;
    const tab = state.activeTab;
    const mkBtn = (txt, icon, color, action) => 
        `<button class="btn btn-light border w-100 text-start mb-2 shadow-sm ${action}"><i class="fas ${icon} me-2 text-${color}"></i> ${txt}</button>`;

    let html = `<h6 class="font-data text-muted small mb-3">AVAILABLE PROTOCOLS</h6>`;

    if (tab === 'overview') {
        html += mkBtn("Strategic Analysis", "chess-board", "primary", "btn-trigger-ai' data-context='narrative' data-sub='context");
        html += mkBtn("Critical Risk Scan", "shield-alt", "danger", "btn-trigger-ai' data-context='assumptions");
    } else if (['prerequisites','stakeholders','assumptions','resources'].includes(tab)) {
        const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
        html += `<button class="btn btn-gradient-purple w-100 text-start mb-2 shadow-sm text-white btn-speculate-collection" data-collection="${tab}"><i class="fas fa-bolt me-2"></i> Speculate ${label}s</button>`;
        html += `<div class="small text-muted mb-2 mt-2 font-data">Refinement</div>`;
        html += mkBtn("Validate Entries", "check-double", "success", "");
    } else {
        html += mkBtn("Auto-Draft Content", "magic", "purple", "btn-enhance-field' data-field='summary");
    }
    
    content.innerHTML = html + `<div class="mt-auto pt-4 border-top"><label class="font-data small text-muted mb-2">DIRECT UPLINK</label><input type="text" class="form-control form-control-sm font-body" placeholder="Query the Engine..."></div>`;
}

// --- 7. SERVER ACTIONS ---

function triggerSpeculation(type, btn = null) {
    let origHtml = '';
    if(btn) { origHtml = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; }
    else { updateDashboard(); }

    const contextGoal = state.modalElement.querySelector('.source-cos-card p')?.textContent.trim();

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: type, 
            cos_text: contextGoal 
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.suggestions) {
            data.suggestions.forEach(i => {
                i.id = self.crypto.randomUUID();
                i.tags = "AI"; 
                i.status = "Proposed";
                state.collections[type].push(i);
            });
            render(); 
        }
    })
    .finally(() => {
        if(btn) { btn.disabled = false; btn.innerHTML = origHtml; }
        const statusCard = state.modalElement.querySelector('.system-status-card');
        if(statusCard) statusCard.classList.remove('scanning');
        updateDashboard();
    });
}

// ce_cards.js - Narrative Enhancement Logic

function triggerEnhancement(fieldKey, btn = null, isAuto = false) {
    // 1. Set Visual Loading State (if triggered by a button)
    if (btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> THINKING...'; 
    }

    // 2. Scrape Context for AI
    // We need the Parent Goal (COS) to ground the generated text.
    const cosTextEl = state.modalElement.querySelector('.source-cos-card p');
    const cosText = cosTextEl ? cosTextEl.textContent.trim() : "Project Goal";

    // 3. Send Request to 'Narrative Mode' endpoint
    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: 'narrative', // Special context for text generation
            sub_context: fieldKey, // e.g., 'summary', 'research_question'
            cos_text: cosText 
        })
    })
    .then(r => r.json())
    .then(data => {
        // 4. Handle Successful Response
        if(data.success && data.text) {
            // Update Local State
            state.details_data[fieldKey] = data.text;
            
            // Update DOM Input/Textarea directly
            const input = state.modalElement.querySelector(`[name="${fieldKey}"]`);
            if(input) {
                input.value = data.text;
                // Trigger input event to notify other listeners (like autosave)
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            // Update Dashboard (e.g. Readiness score jumps up because field is filled)
            updateDashboard();
        }
    })
    .catch(err => {
        console.error("Narrative Speculation Error:", err);
        if(btn && !isAuto) alert("Could not generate narrative. Please try again.");
    })
    .finally(() => { 
        // 5. Reset Button State
        if (btn) { 
            btn.disabled = false; 
            // BRANDING UPDATE: Restore 'SPECULATE' label instead of 'ENHANCE'
            btn.innerHTML = '<i class="fas fa-brain me-2"></i> SPECULATE'; 
        } 
    });
}

function saveDataPacket() {
    const btn = state.modalElement.querySelector('.btn-save-changes');
    const orig = btn.innerHTML; // Capture the dynamic "SAVE RISK" text
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> COMMITTING...';

    // Scrape Narrative Form if it exists
    const narrForm = state.modalElement.querySelector(`#narrative-form-${state.ceId}`);
    if (narrForm) {
        const fd = new FormData(narrForm);
        state.details_data = Object.fromEntries(fd.entries());
    }

    // Build Packet
    const packet = {
        details_data: state.details_data,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        resources: state.collections.resources,
        connections: state.collections.connections
    };

    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    })
    .then(r => r.json())
    .then(data => {
        if(data.success) {
            const status = state.modalElement.querySelector('#save-status');
            // Contextual success message
            if(status) status.innerHTML = `<span class="text-success font-data">${state.ceType.toUpperCase()} COMMITTED</span>`;
            
            btn.classList.remove('btn-primary'); btn.classList.add('btn-success');
            btn.innerHTML = `<i class="fas fa-check"></i> SAVED`;
            
            setTimeout(() => { 
                btn.classList.remove('btn-success'); btn.classList.add('btn-primary');
                btn.innerHTML = orig; // Restore "SAVE RISK"
            }, 1500);
        }
    });
}

// --- 8. EVENT LISTENERS ---

function setupEventListeners() {
    const m = state.modalElement;

    // Tabs -> Context Switching
    const nav = m.querySelector('.ce-nav-tabs');
    if(nav) {
        nav.addEventListener('shown.bs.tab', e => {
            const tid = e.target.getAttribute('data-bs-target');
            if(tid.includes('overview')) state.activeTab = 'overview';
            else if(tid.includes('narrative')) state.activeTab = 'narrative';
            else {
                const p = tid.split('-'); if(p.length > 1) state.activeTab = p[1];
            }
            renderAiSidebarContent();
        });
    }

    // Central Click Handler
    m.addEventListener('click', e => {
        const t = e.target;

        // 1. Suggest / Enhance / AI Triggers
        const specBtn = t.closest('.btn-speculate-collection');
        if(specBtn) triggerSpeculation(specBtn.dataset.collection, specBtn);
        
        const enhBtn = t.closest('.btn-enhance-field');
        if(enhBtn) triggerEnhancement(enhBtn.dataset.field, enhBtn);
        
        const aiBtn = t.closest('.btn-trigger-ai');
        if(aiBtn) triggerSpeculation(aiBtn.dataset.context, aiBtn);

        // 2. Editor Controls
        const addBtn = t.closest('.btn-add-item');
        if(addBtn) toggleEditor(addBtn.dataset.collection, true);
        
        const editBtn = t.closest('.btn-edit-item');
        if(editBtn) {
            const col = editBtn.dataset.collection;
            const item = state.collections[col].find(i => i.id === editBtn.dataset.id);
            if(item) toggleEditor(col, true, item);
        }

        const cancelBtn = t.closest('.btn-cancel-edit');
        if(cancelBtn) {
            const type = cancelBtn.closest('form').dataset.collection;
            toggleEditor(type, false);
        }

        // 3. Item Actions
        const accBtn = t.closest('.btn-accept');
        if(accBtn) {
            const col = accBtn.dataset.col;
            const item = state.collections[col].find(i => i.id === accBtn.dataset.id);
            if(item) { item.tags = ""; item.status = "Active"; render(); }
        }
        
        const delBtn = t.closest('.btn-delete-item');
        if(delBtn && confirm("Purge item?")) {
            const col = delBtn.dataset.col;
            state.collections[col] = state.collections[col].filter(i => i.id !== delBtn.dataset.id);
            render();
        }

        // 4. Save
        if(t.closest('.btn-save-changes')) saveDataPacket();
    });

    // Forms
    m.querySelectorAll('.editor-form').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const col = form.dataset.collection;
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());

            // Handle Smart Widget (Checkboxes) manually
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                data[cb.name] = cb.checked;
            });

            if(form.dataset.editingId) {
                const idx = state.collections[col].findIndex(i => i.id === form.dataset.editingId);
                if(idx > -1) state.collections[col][idx] = {...state.collections[col][idx], ...data};
            } else {
                data.id = self.crypto.randomUUID();
                data.status = "Active";
                state.collections[col].push(data);
            }
            toggleEditor(col, false);
            render();
        });
    });
}

function toggleEditor(type, show, itemData=null) {
    const cont = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    const edit = state.modalElement.querySelector(`#editor-${type}-${state.ceId}`);
    const form = edit.querySelector('form');

    if(show) {
        cont.style.display = 'none';
        edit.style.display = 'block';
        form.reset();
        if(itemData) {
            form.dataset.editingId = itemData.id;
            Object.keys(itemData).forEach(k => {
                const input = form.querySelector(`[name="${k}"]`);
                if(input) {
                    if(input.type === 'checkbox') input.checked = itemData[k] === true;
                    else input.value = itemData[k];
                    // Smart Slider Update
                    if(input.type === 'range' && input.nextElementSibling) input.nextElementSibling.innerText = input.value + '%';
                }
            });
        } else delete form.dataset.editingId;
    } else {
        cont.style.display = 'block';
        edit.style.display = 'none';
    }
}

üè≥Ô∏è‚Äçüåà system_nodes.py:
# system_nodes.py
"""
THE SYSTEM PARAMETER MANIFEST (v4.0 - Networked Autonomy)
------------------------------------
This file defines the "Physics" of the SSOL Universe.
These nodes act as the 'Environmental Variables' for the Speculation Engine.

CONCEPTS:
- MASTER NODE: The "GOAL" node acting as the primary container.
- ATTENUATION: 'prompt_injection' fields are prepended to every AI call,
  ensuring CEs (currency) automatically align with these constraints.
"""

SYSTEM_NODES = {
    # ==============================================================================
    # 0. THE MASTER NODE (The Root Container)
    # ==============================================================================
    "GOAL": {
        "label": "Prime Objective",
        "icon": "fa-solid fa-bullseye",
        "color": "#212121", # Black/Dark Grey (The Singularity)
        "description": "The Singularity. The absolute definition of the future state. All other nodes orbit this gravity well.",
        "guide": "State the outcome as a completed fact in the past tense (e.g., 'The Ocean was cleaned').",
        "ui_type": "textarea",
        "examples": ["The Event was successfully hosted", "The Prototype is functional"],
        "prompt_injection": """
            PRIME DIRECTIVE: The ultimate purpose of every element generated must directly contribute to: '{value}'.
            Discard any suggestion that does not have a causal link to this outcome.
        """
    },

    # ==============================================================================
    # 1. CORE CONSTRAINTS (Time & Identity)
    # ==============================================================================
    "HORIZON": {
        "label": "Target Deadline",
        "icon": "fa-solid fa-calendar-day",
        "color": "#ff9800", # Amber (Urgency)
        "description": "The Temporal Boundary. When does this possibility collapse into reality?",
        "guide": "Is this a hard stop (Election Day) or a soft target (Quarter 4)?",
        "ui_type": "date_manager", 
        "prompt_injection": """
            TEMPORAL ATTENUATION: The system has a hard stop at '{value}'. 
            All generated roadmaps, lead times, and resource acquisitions must mathematically fit within this window. 
            Flag any CEs that inherently require more time than available.
        """
    },
    
    "OPERATOR": {
        "label": "Project Champion",
        "icon": "fa-solid fa-user-check",
        "color": "#03a9f4", # Light Blue (Identity)
        "description": "The Driver. The specific entity types responsible for execution.",
        "guide": "Who is driving? A DAO? A Non-Profit? A Corporation? This dictates available leverage.",
        "ui_type": "entity_stack",
        "examples": ["Community Land Trust", "Agile Software Team", "Solo Founder"],
        "prompt_injection": """
            OPERATOR ATTENUATION: The executing agent is defined as: '{value}'. 
            Ensure all suggestions (budgeting style, legal frameworks, organizational hierarchy) are native to this specific type of entity.
            Do not suggest corporate strategies for grassroots operators, and vice versa.
        """
    },

    # ==============================================================================
    # 2. VALUES & ETHICS (The Filter)
    # ==============================================================================

    "DIRECTIVE": {
        "label": "Core Value",
        "icon": "fa-solid fa-heart",
        "color": "#9c27b0", # Deep Purple (Spirit)
        "description": "The Immutable Law. The ethical framework that filters all decisions.",
        "guide": "What rule is unbreakable? (e.g. Radical Transparency, Zero Waste).",
        "ui_type": "text",
        "examples": ["Open Source Only", "Local Sourcing", "Consensus Governance"],
        "prompt_injection": """
            ETHICAL ATTENUATION: The value of '{value}' is non-negotiable. 
            Filter out any 'efficient' solutions that violate this principle. 
            Prioritize inefficient solutions if they better align with this value.
        """
    },

    "AVOIDANCE": { 
        "label": "Anti-Goal", 
        "icon": "fa-solid fa-triangle-exclamation",
        "color": "#ef5350", # Red (Danger)
        "description": "The Third Rail. Outcomes that constitute failure, even if the goal is met.",
        "guide": "What are we afraid of? (Gentrification, Debt, Burnout).",
        "ui_type": "text",
        "examples": ["Displacing Residents", "Vendor Lock-in", "Public Debt"],
        "prompt_injection": """
            RISK ATTENUATION: The project must specifically avoid: '{value}'. 
            Scan all generated CEs for second-order effects that might trigger this negative outcome.
        """
    },

    # ==============================================================================
    # 3. PHYSICS & LOGISTICS (The Engine)
    # ==============================================================================

    "BUDGET": {
        "label": "Fuel Source",
        "icon": "fa-solid fa-piggy-bank",
        "color": "#4caf50", # Green (Money)
        "description": "The Economic Physics. Defines the sustainability and acquisition logic.",
        "guide": "How is this powered? Grants? Sales? Sweat Equity?",
        "ui_type": "select",
        "options": ["Bootstrapped ($0)", "Crowdfunded", "Grant Funded", "Venture Capital", "Public Budget"],
        "prompt_injection": """
            ECONOMIC ATTENUATION: The project operates on a '{value}' model. 
            Adjust resource granularity accordingly. 
            (e.g., if Bootstrapped, suggest 'sweat equity' and 'barter'. If VC, suggest 'hiring' and 'saas tools').
        """
    },

    "SCALE": {
        "label": "Impact Reach",
        "icon": "fa-solid fa-map-location-dot",
        "color": "#3f51b5", # Indigo (Space)
        "description": "The Spatial Footprint. Determines regulatory and logistical complexity.",
        "guide": "Where does this exist? A single room? A city? The internet?",
        "ui_type": "select",
        "options": ["Hyper-Local (Neighborhood)", "Municipal (City)", "Regional", "Global / Digital"],
        "prompt_injection": """
            SPATIAL ATTENUATION: The solution is scoped to a '{value}' footprint. 
            Ensure Stakeholder suggestions match this jurisdiction (e.g., City Council vs. UN).
            Ensure Resource suggestions match this logistics chain.
        """
    },

    "MODALITY": {
        "label": "Execution Style", 
        "icon": "fa-solid fa-people-carry-box",
        "color": "#607d8b", # Blue Grey (Method)
        "description": "The Rhythm of Work. How does the team coordinate?",
        "ui_type": "select",
        "options": ["Agile / Iterative", "Waterfall / Planned", "Swarm / Decentralized", "Crisis Response"],
        "prompt_injection": """
            METHODOLOGICAL ATTENUATION: Work is performed using a '{value}' style. 
            Structure Prerequisites as 'Sprints' or 'Milestones' accordingly.
            Define 'Done' based on this philosophy.
        """
    },

    # ==============================================================================
    # 4. THE ARTIFACT
    # ==============================================================================

    "FULFILLMENT": {
        "label": "Final Deliverable",
        "icon": "fa-solid fa-box-open",
        "color": "#009688", # Teal (Tangible)
        "description": "The Artifact. What physical or digital object remains when the project ends?",
        "guide": "Is it a PDF? A Building? A Law? A Community Garden?",
        "ui_type": "text",
        "examples": ["Legislative Bill", "Physical Prototype", "Research Paper", "Community Center"],
        "prompt_injection": """
            ARTIFACT ATTENUATION: The final output must be a '{value}'. 
            Reverse-engineer the 'Production' CEs required to manufacture/author/build this specific object.
        """
    },

    # ==============================================================================
    # 5. WILDCARD
    # ==============================================================================
    "CUSTOM": {
        "label": "Custom Vector",
        "icon": "fa-solid fa-fingerprint",
        "color": "#e91e63", # Pink (Unique)
        "description": "User-Defined Constraint. Any specific variable not covered above.",
        "ui_type": "text",
        "prompt_injection": """
            CUSTOM ATTENUATION: adhere strictly to this user-defined constraint: '{value}'.
        """
    }
}

def get_valid_system_types():
    """Returns a list of all valid system node keys."""
    return list(SYSTEM_NODES.keys())

def get_system_node_config(key):
    """Safe retrieval of config with fallback."""
    return SYSTEM_NODES.get(key, SYSTEM_NODES['OPERATOR'])

üè™ store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

‚¨ú speculate.py:
# speculate.py
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from ce_nodes import NODES, get_valid_node_types
from ai_service import generate_chat_response_with_node_types
from datetime import date, timedelta

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """
    Generates the Horizon-Style CE Capsule HTML.
    Handles case-insensitive lookup and fallbacks.
    """
    # 1. Case-insensitive lookup
    # Create a mapping of lower_case -> RealKey
    key_map = {k.lower(): k for k in NODES.keys()}
    clean_type = ce_type.strip()
    real_key = key_map.get(clean_type.lower(), 'Default')
    
    node_info = NODES.get(real_key)
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-cube')
    
    # 2. Fallback Color Generator (for hallucinations like "Market Need")
    # If it's truly unknown, give it a distinct color instead of gray
    if real_key == 'Default' and clean_type.lower() != 'default':
        # Hash the string to get a consistent color
        hash_val = sum(ord(c) for c in clean_type)
        colors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#ff5722']
        node_color = colors[hash_val % len(colors)]
        node_icon = 'fa-solid fa-tag'
    else:
        node_color = node_info.get('color', '#6c757d')
        node_icon = node_info.get('icon', 'fa-solid fa-cube')
    
    return (
        f'<span class="ce-capsule" data-ce-id="{ce_id}" data-ce-type="{ce_type}" '
        f'style="background-color: {node_color};">'
        f'<i class="{node_icon} me-1"></i>{html.escape(ce_text)}'
        f'</span>'
    )
# --- AI Analysis ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content to identify CEs. Returns structured JSON for creation/updating.
    """
    node_types_str = ', '.join(get_valid_node_types())
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify ALL distinct Conditional Elements (CEs) within this text. "
        f"Valid NodeTypes: {node_types_str}. "
        "Return JSON with keys 'analyzed_cos_text' (original text with <ce type='Type'>Title</ce> tags) "
        "and 'identified_ces' (array of {text, type})."
    )
    messages = [{"role": "user", "content": prompt}]
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS')
        # Parse logic
        match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", response_text, re.DOTALL)
        clean_text = match.group(1).strip() if match else response_text.strip()
        
        response_json = json.loads(clean_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}", exc_info=True)
        # Fallback: return original text, no CEs detected
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

# --- SSOL Operations ---

def create_ssol(USE_DATABASE: bool, title: str, description: str, domain: str = None) -> str:
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    # MVP Rule: Set a default "Horizon" of 1 year from creation
    default_target_date = date.today() + timedelta(days=365)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            
            ssol = SSOL(
                id=new_ssol_uuid, 
                title=title, 
                description=description,
                domain=domain,
                status='Active', 
                target_date=default_target_date,
                integrity_score=100,
                completion_percentage=0
            )
            
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {
            'id': ssol_id, 
            'title': title, 
            'description': description, 
            'domain': domain,
            'status': 'Active',
            'target_date': default_target_date.isoformat(),
            'integrity_score': 100,
            'completion_percentage': 0,
            'phases': {}
        }
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    return ssol_store.get(str(ssol_id))

# --- COS Operations ---

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> dict:
    """
    Creates a COS and returns the FULL DATA DICTIONARY immediately.
    This avoids Read-After-Write race conditions.
    """
    from models import COS, CE, get_engine_and_session
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    if isinstance(content, dict):
        content = content.get('text') or content.get('content') or json.dumps(content)
    elif not isinstance(content, str):
        content = str(content)

    try:
        # 1. Parse & Pill Logic
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        new_ce_instances = []
        
        for tag in ce_tags:
            ce_text = tag.string
            ce_type = tag.get('type', 'Default')
            if not ce_text: continue

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': ce_type,
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "prerequisites": [], "stakeholders": [], "assumptions": [], "resources": [], "connections": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace with Horizon HTML
            # We use a simplified helper here or ensure _render_ce_pill_html is available
            from speculate import _render_ce_pill_html 
            pill_html = _render_ce_pill_html(str(new_ce_uuid), ce_type, ce_text)
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        content_with_pills = str(soup)

        # 2. Persist & Return Data
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos_instance = COS(
                    id=new_cos_uuid, 
                    content=content_with_pills, 
                    status=status, 
                    ssol_id=ssol_id,
                    accountable_party=accountable_party, 
                    completion_date=completion_date
                )
                session.add(cos_instance)
                
                for ce_rec in new_ce_instances:
                    ce_instance = CE(
                        id=ce_rec['id'], 
                        node_type=ce_rec['node_type'], 
                        cos_id=new_cos_uuid, 
                        data=ce_rec['data']
                    )
                    session.add(ce_instance)
                
                session.commit()
                
                # CRITICAL FIX: Serialize inside the session
                final_data = cos_instance.to_dict()
                session.close()
                return final_data
        else:
            # In-memory store fallback
            result = {
                'id': cos_id_str, 
                'content': content_with_pills, 
                'status': status, 
                'ssol_id': str(ssol_id),
                'accountable_party': accountable_party,
                'completion_date': completion_date
            }
            cos_store[cos_id_str] = result
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
            return result

    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        raise
    
async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from app import app

    new_content = updated_data.get('content')
    
    try:
        new_ce_instances = []
        
        if new_content is not None:
            if isinstance(new_content, dict): new_content = json.dumps(new_content)
            elif not isinstance(new_content, str): new_content = str(new_content)
                    
            analysis = await analyze_cos(new_content, str(cos_id))
            soup = BeautifulSoup(analysis['content_with_tags'], 'html.parser')
            ce_tags = soup.find_all('ce')
            
            for tag in ce_tags:
                c_txt, c_type = tag.string, tag.get('type')
                new_id = uuid.uuid4()
                new_ce_instances.append({
                    'id': new_id, 'node_type': c_type, 
                    'data': {"details_data": {}, "resources": [], "prerequisites": [], "stakeholders": [], "assumptions": [], "connections": []}
                })
                # REPLACE WITH HORIZON CAPSULE HTML
                pill = _render_ce_pill_html(str(new_id), c_type, c_txt)
                tag.replace_with(BeautifulSoup(pill, 'html.parser'))
            
            updated_data['content'] = str(soup)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id)
                if not cos: 
                    session.close()
                    return {'success': False, 'message': 'COS not found', 'status_code': 404}
                
                for k, v in updated_data.items():
                    if hasattr(cos, k) and k not in ['id', 'ssol_id']: 
                        setattr(cos, k, v)
                
                if new_content is not None:
                    session.query(CE).filter_by(cos_id=cos_id).delete()
                    for nc in new_ce_instances:
                        session.add(CE(id=nc['id'], node_type=nc['node_type'], cos_id=cos_id, data=nc['data']))
                
                session.commit()
                cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': cos_dict, 'status_code': 200}
        
        return {'success': False, 'message': 'DB Required', 'status_code': 500}

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return {'success': False, 'message': str(e), 'status_code': 500}


def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            res = cos.to_dict() if cos else None
            session.close()
            return res
    return cos_store.get(str(cos_id))

def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(cos_id=cos_id).delete()
            cos = session.query(COS).get(cos_id)
            if cos:
                session.delete(cos)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

# --- CE Operations ---

def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id_param if isinstance(ce_id_param, UUID) else UUID(str(ce_id_param))
    
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            result = ce.to_dict() if ce else None
            session.close()
            return result
    return ce_store.get(str(ce_id_uuid))

def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id)
            if ce:
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from app import app
    new_id = uuid.uuid4()
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.add(CE(id=new_id, node_type=node_type, cos_id=cos_id, data=data))
            session.commit()
            session.close()
    return str(new_id)

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(id=ce_id).delete()
            session.commit()
            session.close()
            return True
    return False

üü© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<div class="horizon-wrapper">
  <div class="console-housing">
    <div class="screen-surface d-flex flex-column" style="min-height: 80vh;">
      
      <!-- 1. HEADER BAR -->
      <div class="bg-white border-bottom px-5 py-4 d-flex justify-content-between align-items-center shadow-sm z-20 flex-shrink-0">
        <div class="d-flex align-items-center gap-4">
           
           <!-- User Input Group -->
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1">Mission Parameter</div>
               
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display" style="font-size: 2rem;">"{{ user_input }}"</h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0" title="Edit"><i class="fas fa-pencil-alt"></i></button>
               </div>

               <!-- Horizon Instruction -->
               <div class="horizon-instruction">
                   Analogs Detected. Select Optimal Protocol Trajectory.
               </div>
           </div>
           
           <!-- Hidden Edit Form -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <div class="d-flex gap-3">
             <!-- "Speculate New" triggers JS in goal_selection.js -->
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> Re-Calculate
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">
               Abort
             </a>
        </div>
      </div>

      <!-- 2. THE GOAL GRID -->
      <div class="goal-grid flex-grow-1 d-flex align-items-center justify-content-center bg-light" id="goalCardsContainer">
        
        {% for goal in goals %}
           <div class="flip-card {{ 'rejected' if not goal.is_compliant else '' }}" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
            <div class="flip-card-inner" data-delay="{{ 800 + (loop.index0 * 300) }}">
              
              <!-- BACK (Face Down) -->
              <div class="flip-card-back" 
                   style="background: {{ 'linear-gradient(135deg, #ffeb3b 0%, #ff9800 40%, #d32f2f 100%)' if not goal.is_compliant else 
                           ('linear-gradient(135deg, #ff7043 0%, #f4511e 100%)' if loop.index0 % 3 == 0 else 
                           'linear-gradient(135deg, #26c6da 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 
                           'linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%)') }};">
                <div class="card-pattern-overlay"></div>
                <div class="position-relative z-2 d-flex flex-column align-items-center">
                  <div class="bg-white bg-opacity-25 p-4 rounded-circle border border-2 border-white border-opacity-50 shadow-lg mb-3 backdrop-blur">
                    <i class="{{ goal.icon }} fa-3x text-white drop-shadow"></i>
                  </div>
                  {% if not goal.is_compliant %}
                  <div class="font-data text-white small bg-black bg-opacity-25 px-3 py-1 rounded-pill border border-white border-opacity-25 mt-2">Protocol Violation</div>
                  {% endif %}
                </div>
              </div>

              <!-- FRONT (Face Up) -->
              <div class="flip-card-front">
                <div class="card-header-plate" style="background: {{ 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%)' if not goal.is_compliant else ('linear-gradient(135deg, #ffcc80 0%, #ff7043 100%)' if loop.index0 % 3 == 0 else 'linear-gradient(135deg, #80deea 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 'linear-gradient(135deg, #e1bee7 0%, #ab47bc 100%)') }};">
                    <div class="card-domain-badge shadow-sm">{{ goal.domain | upper }}</div>
                    <div class="card-icon-float">
                        <i class="{{ goal.icon }} fa-2x" style="color: {{ '#ef5350' if not goal.is_compliant else ('#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc') }};"></i>
                    </div>
                </div>

                <div class="card-body">
                  <h3 class="card-title">{{ goal.title }}</h3>
                  <p class="card-desc">{{ goal.goal }}</p>
                </div>

                <div class="card-footer bg-transparent border-0 pb-4">
                    {% if goal.is_compliant %}
                      <!-- The Outcome Form -->
                      <form action="{{ url_for('routes_bp.outcome') }}" method="post" class="outcome-form">
                        <input type="hidden" name="selected_goal" value="{{ goal.goal }}">
                        <input type="hidden" name="domain" value="{{ goal.domain }}">
                        <input type="hidden" name="domain_icon" value="{{ goal.icon }}">
                        <input type="hidden" name="selected_goal_title" value="{{ goal.title }}">
                        
                        <button type="submit" 
                                class="btn-select-pill w-100 shadow-md" 
                                style="background-color: {{ '#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc' }};">
                          INITIALIZE
                        </button>
                      </form>
                    {% else %}
                      <button class="btn-select-pill w-100" style="background-color: #ef5350; cursor: not-allowed; opacity: 0.8;">VIOLATION</button>
                    {% endif %}
                </div>
              </div>

            </div>
          </div>
        {% endfor %}
          
      </div>
    
    <!-- 3. FOOTER -->
    <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-white border-top mt-auto flex-shrink-0">
       <div class="d-flex gap-2">
          <div class="rounded-circle bg-success shadow-sm animate-pulse" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-warning shadow-sm" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-info shadow-sm" style="width: 8px; height: 8px;"></div>
       </div>
       <span class="font-data text-muted small letter-spacing-2">SSPEC HORIZON v2025.23</span>
    </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Core logic for regenerations/edit (if kept external) -->
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>

<script type="module">
    import { showLoadingSpinner } from '{{ url_for("static", filename="js/base_functions.js") }}';

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Trigger Flip Animations on Load
        const cards = document.querySelectorAll('.flip-card-inner');
        cards.forEach(card => {
            const delay = parseInt(card.dataset.delay) || 1000;
            setTimeout(() => {
                card.closest('.flip-card').classList.add('revealed');
            }, delay);
        });

        // 2. Intercept Outcome Form Submission for HUD Spinner
        const forms = document.querySelectorAll('.outcome-form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                // The form will submit naturally, we just fire the visual overlay immediately
                const title = this.querySelector('input[name="selected_goal_title"]').value;
                const domain = this.querySelector('input[name="domain"]').value;
                
                // Show the Horizon HUD Spinner
                showLoadingSpinner(`INITIALIZING: ${title.toUpperCase()}`, "fa-solid fa-network-wired");
            });
        });
        
        // 3. Loading State for Regeneration Button
        const regenBtn = document.getElementById('generate-new-goals');
        if(regenBtn) {
            regenBtn.addEventListener('click', () => {
                 // Let goal_selection.js handle the fetch, but show spinner visually
                 // Note: goal_selection.js should ideally call hideLoadingSpinner() when done.
                 // If not, the page reload that often happens on regeneration will clear it.
                 showLoadingSpinner("SPECULATING NEW TRAJECTORIES", "fa-sync fa-spin");
            });
        }
    });
</script>
{% endblock %}

üü® utilities.py:
# utilities.py

import logging
import json
import re
import uuid
from typing import Dict, List
from bs4 import BeautifulSoup
from flask import current_app

# Import AI services
from ai_service import generate_chat_response, get_grounded_data, generate_image

# Local Imports
from ce_nodes import NODES, get_valid_node_types
from system_nodes import SYSTEM_NODES, get_valid_system_types

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO)

# ==============================================================================
# 1. TEXT PARSING & FORMATTING (The "Magic Parsing" Layer)
# ==============================================================================

def replace_ce_tags_with_pills(content):
    """
    Parses <ce type="Risk">Text</ce> tags into Solid Color Pills (.ce-capsule).
    Used for Actionable Elements (Atoms).
    """
    if not content:
        return ""

    # Use HTML parser
    soup = BeautifulSoup(str(content), 'html.parser')
    ce_tags = soup.find_all('ce')

    for tag in ce_tags:
        ce_id_str = tag.get('id') # Optional ID if linking to DB
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        
        # 1. Get Config
        node_config = NODES.get(ce_type, NODES['Default'])
        bg_color = node_config.get('color', '#6c757d')
        icon_cls = node_config.get('icon', 'fa-solid fa-cube')

        # 2. Build Horizon Capsule HTML
        # Structure: <span class="ce-capsule" style="bg-color:..."> <i class="icon"></i> Text </span>
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-capsule', 
            'data-ce-id': ce_id_str,
            'data-ce-type': ce_type,
            'title': f"{ce_type} | Click to Open Speculation Engine",
            'style': f'background-color: {bg_color};' 
        })
        
        # Icon
        icon_i = soup.new_tag('i', attrs={'class': f"{icon_cls} me-1"})
        new_tag.append(icon_i)
        
        # Text
        text_node = soup.new_string(ce_text)
        new_tag.append(text_node)

        tag.replace_with(new_tag)

    return str(soup)


def replace_sys_tags_with_highlights(content):
    """
    Parses <sys> tags into "Slick" Inline Pills.
    Structure: <span class="sys-highlight"><span class="sys-highlight-icon"><i class="fa..."></i></span><span class="sys-highlight-text">Value</span></span>
    """
    if not content: return ""
    
    # Import locally to avoid circular imports
    from system_nodes import SYSTEM_NODES 
    from bs4 import BeautifulSoup

    soup = BeautifulSoup(str(content), 'html.parser')
    sys_tags = soup.find_all('sys')

    for tag in sys_tags:
        sys_type = tag.get('type', 'CUSTOM').upper()
        sys_text = tag.get_text()
        
        # Lookup config
        config = SYSTEM_NODES.get(sys_type, SYSTEM_NODES['CUSTOM'])
        color = config.get('color', '#666')
        icon = config.get('icon', 'fa-tag')

        # 1. Main Container
        wrapper = soup.new_tag('span', attrs={
            'class': 'sys-highlight',
            'data-type': sys_type,
            'title': f"{config['label']}: {sys_text}",
            'style': f'--sys-color: {color};'
        })
        
        # 2. Icon Circle
        icon_span = soup.new_tag('span', attrs={'class': 'sys-highlight-icon'})
        icon_i = soup.new_tag('i', attrs={'class': icon})
        icon_span.append(icon_i)
        wrapper.append(icon_span)
        
        # 3. Text Label
        text_span = soup.new_tag('span', attrs={'class': 'sys-highlight-text'})
        text_span.string = sys_text
        wrapper.append(text_span)
        
        tag.replace_with(wrapper)

    return str(soup)


def format_ssol_text(content):
    """
    Master formatter for SSOL Summaries. 
    Runs both parsers to ensure the Executive Summary looks rich and connected.
    """
    # 1. Process System Anchors (Context Tags)
    step_one = replace_sys_tags_with_highlights(content)
    
    # 2. Process Conditional Elements (Action Pills)
    final_output = replace_ce_tags_with_pills(step_one)
    
    return final_output


# ==============================================================================
# 2. INPUT ANALYSIS (Goal Selection)
# ==============================================================================

async def generate_goal(user_input: str) -> List[Dict]:
    prompt = f"""
    Based on the user input '{user_input}', generate three distinct, high-level goal options. 
    Each goal must be a JSON object with keys: "domain", "title", "goal", "icon", "is_compliant". 
    
    ICON RULES: Use 'FontAwesome 6 Free' classes (e.g., 'fa-solid fa-rocket').
    Output Format: JSON Array of 3 objects.
    """
    
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(
            messages, 
            role="user", 
            task="goal generation", 
            system_instruction="You are a JSON-only API. Respond with a valid JSON array only.",
            generation_config={"response_mime_type": "application/json", "temperature": 0.7}
        )
        
        cleaned = response_str.replace("```json", "").replace("```", "").strip()
        ai_goals = json.loads(cleaned)

        validated_goals = []
        for goal in ai_goals:
            if not isinstance(goal, dict): continue
            validated_goals.append({
                'domain': goal.get('domain', 'General'),
                'title': goal.get('title', 'Untitled Goal'),
                'goal': goal.get('goal', 'No description provided.'),
                'icon': goal.get('icon', 'fa-solid fa-question-circle'),
                'is_compliant': goal.get('is_compliant', goal.get('iscompliant', True))
            })
        return validated_goals

    except Exception as e:
        logging.error(f"Error in generate_goal: {e}", exc_info=True)
        return []

async def analyze_user_input(user_text: str) -> List[str]:
    prompt = f'Analyze text and extract 3-5 key keywords. Text: "{user_text}". Return JSON: {{ "keywords": [] }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="keyword extraction", generation_config={"response_mime_type": "application/json"})
        return json.loads(response_str).get('keywords', [])
    except Exception:
        return []

async def is_input_compliant(user_text: str) -> dict:
    prompt = f'Analyze compliance. Text: "{user_text}". Return JSON: {{ "compliant": boolean, "reason": string }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="compliance check", generation_config={"response_mime_type": "application/json"})
        result = json.loads(response_str)
        return {"compliant": result.get('compliant', True), "reason": result.get('reason', '')}
    except Exception:
        return {"compliant": False, "reason": "System error."}


# ==============================================================================
# 3. OUTCOME GENERATION (The Architect)
# ==============================================================================

async def generate_outcome_data(ssol_title, ssol_description, domain):
    """
    The primary bootstrap function. 
    Architects the solution structure and infers System Nodes.
    """
    
    # Prepare Lists for the Prompt
    node_types_str = ', '.join(get_valid_node_types())
    sys_types_str = ', '.join(get_valid_system_types())
    
    prompt = f"""
    Act as a Visionary Systems Architect for the SSPEC Project Management Engine.
    
    *** MISSION PARAMETERS ***
    GOAL: '{ssol_title}'
    DOMAIN: '{domain}'
    CONTEXT: {ssol_description}
    
    *** INSTRUCTIONS ***

    1. SYSTEM CONFIGURATION (Inference):
    Based on the context, infer the critical "System Anchors" (Who, How, Why, Scale).
    Valid Types: {sys_types_str}.
    
    2. EXECUTIVE SUMMARY (The Narrative):
    Write a cohesive HTML paragraph summarizing the strategy.
    - Use <sys type="TYPE">Value</sys> tags to highlight System Anchors.
    - DO NOT USE <ce> tags in this summary. This section is for high-level context only.
    - Ensure the tone is professional, visionary, and confident.
    
    3. PHASE STRUCTURE (STRICT ADHERENCE REQUIRED):
    You must use EXACTLY these 5 Phase names. Do NOT rename them.
    - Discovery
    - Engagement
    - Action
    - Completion
    - Legacy

    For each phase, define 3-5 "Conditions of Satisfaction" (COS).
    A COS is a state of reality, not just a task.
    Embed Conditional Elements (CEs) in the COS text using <ce type="ValidType">Label</ce>.
    Valid CE Types: {node_types_str}.
    
    *** RESPONSE FORMAT (JSON ONLY) ***
    {{
        "ssolsummary": "<p>The <sys type='OPERATOR'>Global Team</sys> will...</p>",
        "system_params": {{
            "HORIZON": "Quarter 4 2025",
            "OPERATOR": "Consortium",
            "SCALE": "Global",
            "DIRECTIVE": "Open Source"
        }},
        "phases": {{
            "Discovery": ["COS Sentence 1...", "COS Sentence 2..."],
            "Engagement": [...],
            "Action": [...],
            "Completion": [...],
            "Legacy": [...]
        }}
    }}
    """
    
    # Execute AI Call
    messages = [{"role": "user", "content": prompt}]
    response_str = await generate_chat_response(
        messages, 
        role="user", 
        task="ssol generation", 
        temperature=0.5 # Lower temp to enforce strict phase naming
    )
    
    # Clean and Parse
    clean_json = response_str.replace("```json", "").replace("```", "").strip()
    
    try:
        return json.loads(clean_json)
    except json.JSONDecodeError:
        logging.error(f"Failed to parse AI JSON for SSOL. Response: {clean_json}")
        return {
            "ssolsummary": "<p>Error generating solution structure. Please try again.</p>",
            "phases": {},
            "system_params": {}
        }


async def generate_ai_data(node_type: str, cos_content: str, ssol_goal: str, agent_mode: str = 'context') -> dict:
    """Generates context data for a specific Node Modal."""
    try:
        if agent_mode == 'speculate':
            return await get_grounded_data(f"Research {node_type} for {ssol_goal}", node_type)
            
        else: # Context mode (Narrative generation)
            prompt = f"Briefly explain the strategic purpose of this '{node_type}' element in the Context: Overall Goal '{ssol_goal}', Specific Requirement '{cos_content}'. Return JSON with key 'contextual_description'."
            messages = [{"role": "user", "content": prompt}]
            
            response_str = await generate_chat_response(
                messages, 
                role="user", 
                task="contextual insight",
                generation_config={"response_mime_type": "application/json", "temperature": 0.7}
            )
            
            cleaned = response_str.replace("```json", "").replace("```", "").strip()
            return json.loads(cleaned)

    except Exception as e:
        logging.error(f"Error in generate_ai_data ({agent_mode}): {e}", exc_info=True)
        return {}
