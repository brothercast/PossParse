â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC PossPath Build Metadata
Version: 202502260125 | Date: 2025-11-18
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

| File | Last Modified | Size (KB) | Status |
|------|---------------|-----------|--------|
| ğŸŸ§ ai_service.py | 2025-11-14 21:54:47 | 13.73 | âœ“ |
| ğŸŸ¥ routes.py | 2025-11-16 16:29:59 | 18.59 | âœ“ |
| ğŸŸ© goal_selection.html | 2025-10-29 21:42:54 | 3.31 | âœ“ |
| ğŸ“± app.py | 2025-11-06 21:56:27 | 2.6 | âœ“ |
| ğŸŸ¦ outcome.html | 2025-10-31 20:15:02 | 14.8 | âœ“ |
| ğŸ“† models.py | 2025-10-30 20:12:27 | 4.16 | âœ“ |
| ğŸ”µ ce_cards.js | 2025-11-18 23:00:06 | 10.8 | âœ“ |
| ğŸ§© ce_templates.py | 2025-11-18 22:59:18 | 13.75 | âœ“ |
| ğŸ³ï¸â€ğŸŒˆ ce_nodes.py | 2025-11-18 14:56:11 | 16.61 | âœ“ |
| ğŸŸ¨ utilities.py | 2025-11-18 22:55:40 | 10.94 | âœ“ |
| ğŸ¨ styles.css | 2025-11-18 21:06:22 | 37.4 | âœ“ |
| ğŸª store.py | 2024-08-28 16:42:16 | 0.06 | âœ“ |
| â¬œ speculate.py | 2025-11-11 17:12:02 | 20.12 | âœ“ |
| ğŸŸª cos_table.js | 2025-11-11 17:43:24 | 21.71 | âœ“ |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC PossPath Essential Files
Date: 2025-11-18
Version: 202502260125
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŒ Structured Speculation Possibility Pathfinder ("SSPEC PossPath") for short.
Your task is to develop the Flask Web App as an innovative tool for mass collaboration.

Essential app files:
ğŸ“± app.py:
# app.py (Final Refactor using Application Factory Pattern)
import os
import logging
import asyncio
import sys
from flask import Flask
from flask_migrate import Migrate
from dotenv import load_dotenv
from models import db # Only import the 'db' object from models
import colorlog
from ce_nodes import NODES

# --- FIX for asyncio on Windows ---
# This is the standard fix for `RuntimeError: Event loop is closed` on Windows.
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
# --- END FIX ---

load_dotenv()

# --- 1. Create App and Extension Instances (Uninitialized) ---
app = Flask(__name__)
migrate = Migrate() # Create the Migrate object, but don't connect it to the app yet.

# --- App Configuration ---
app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

# --- Logger Configuration ---
handler = colorlog.StreamHandler()
handler.setFormatter(colorlog.ColoredFormatter(
    '%(log_color)s%(asctime)s - %(name)s - %(levelname)s - %(message)s'
))
logger = logging.getLogger()
logger.setLevel(logging.INFO)
if not logger.handlers:
    logger.addHandler(handler)

# --- Jinja Filter ---
@app.template_filter()
def get_badge_class_from_status(status):
   return {
       'Proposed': 'bg-info',
       'In Progress': 'bg-warning text-dark',
       'Completed': 'bg-success',
       'Rejected': 'bg-danger'
   }.get(status, 'bg-secondary')

@app.context_processor
def inject_nodes():
    """Injects the NODES dictionary into all templates."""
    return dict(nodes=NODES)

# --- 2. Initialize Extensions Conditionally ---
# This is the core of the fix. We now initialize the extensions inside the 'if' block.
if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    app.config['SQLALCHEMY_ECHO'] = os.environ.get('SQLALCHEMY_ECHO', 'False').lower() in ('true', '1', 't')

    # Now, connect the db and migrate objects to the configured app.
    # This ensures the 'db' command is registered only when USE_DATABASE is true.
    db.init_app(app)
    migrate.init_app(app, db)

# --- 3. Blueprint Registration ---
# Import blueprints AFTER the app is configured.
from routes import routes_bp
app.register_blueprint(routes_bp)

# --- Main Execution (for `python app.py`) ---
if __name__ == '__main__':
    # This block is for direct execution and is not run by the 'flask' command.
    app.run(debug=True, port=5000)

ğŸŸ¥ routes.py:
# routes.py
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory
import os
import json
import uuid
import pdfkit
import logging
import asyncio
from bs4 import BeautifulSoup
from app import USE_DATABASE
from uuid import UUID
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, \
                    generate_image
from ai_service import cleanup_gemini_client
from dotenv import load_dotenv
from ce_templates import generate_dynamic_modal
from ce_nodes import NODES
from werkzeug.exceptions import BadRequest, NotFound
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol
from models import get_engine_and_session, SSOL, COS


load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# --- FIX: Add the teardown handler to the blueprint ---
@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up resources after each request."""
    await cleanup_gemini_client()

# --- Utility Route ---
@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

# --- Basic Pages ---
@routes_bp.route('/')
def index():
    return render_template('input.html')


@routes_bp.route('/about')
def about():
    return render_template('about.html')


# --- Goal Selection ---
@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            logging.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)
            logging.debug(f"generate_goal returned: {goal_options}")

            if not goal_options:
                flash("Could not generate goal options. Please try again or rephrase your input.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            flash(f"An unexpected error occurred while generating goals: {e}", "error")
            logging.error(f"Unexpected error in goal_selection: {e}", exc_info=True)
            return render_template('input.html', user_text=user_input, error_message=str(e))
    return redirect(url_for('routes_bp.index'))

# --- Outcome Generation ---
@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        if not selected_goal_text:
            flash("No goal selected. Please try again.", "error")
            return redirect(url_for('routes_bp.index'))
            
        try:
            # --- Main Logic for SSOL/COS Generation ---
            ssol_id_str = speculate_create_ssol(USE_DATABASE, selected_goal_title, selected_goal_text)
            ssol_id_uuid = UUID(ssol_id_str)
            logging.info(f"SSOL created with ID: {ssol_id_str}")

            # This is the single, efficient API call to get the entire structure
            logging.info("Generating structured solution from AI in a single call...")
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, ssol_description=selected_goal_text, domain=domain
            )
            ssol_summary = structured_solution_json.get('ssolsummary', 'AI failed to generate a summary.')

            # This is the fast, local-only loop with no new API calls
            logging.info("Saving generated COS and their CEs...")
            phases_for_template = {}
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    phases_for_template[phase_name] = []
                    for cos_content_with_tags in cos_items:
                        if cos_content_with_tags:
                            new_cos_id_str = await speculate_create_cos(
                                USE_DATABASE, ssol_id=ssol_id_uuid, content=cos_content_with_tags, status='Proposed'
                            )
                            newly_created_cos = speculate_get_cos_by_id(USE_DATABASE, UUID(new_cos_id_str))
                            if newly_created_cos:
                                phases_for_template[phase_name].append(newly_created_cos.to_dict() if USE_DATABASE else newly_created_cos)

            outcome_data_for_template = {
                'ssol_id': ssol_id_str,
                'ssol_title': selected_goal_title,
                'selected_goal': selected_goal_text,
                'domain': domain,
                'domain_icon': domain_icon,
                'ssol_summary': ssol_summary,
                'phases': phases_for_template,
            }

            # --- GRACEFUL IMAGE GENERATION ---
            # This nested try/except block ensures that an image failure
            # will NOT prevent the main page from loading.
            try:
                logging.info("Constructing image prompt...")
                image_prompt_text = f"A vibrant, visually stunning retro-futuristic illustration depicting '{selected_goal_text}' as a fulfilled goal, isometric, similar to lithographs from Popular Science, 1958, do not include text or captions."
                logging.info(f"Calling image generation service for SSOL {ssol_id_str}...")
                await generate_image(image_prompt_text, ssol_id_str)
            except Exception as img_exc:
                # If image generation fails, we log the error but do not crash.
                # The user experience continues seamlessly. The frontend will handle
                # showing a default image if the generated one is not found.
                current_app.logger.error(
                    f"NON-CRITICAL ERROR: Image generation failed for SSOL {ssol_id_str}. "
                    f"The outcome page will be rendered without it. Reason: {img_exc}",
                    exc_info=True
                )
            # --- END GRACEFUL HANDLING ---
            
            # This return statement is now reached even if image generation fails.
            return render_template('outcome.html', ssol=outcome_data_for_template, nodes=NODES, ssol_id=ssol_id_str, selected_goal_title=selected_goal_title)

        except Exception as e:

            current_app.logger.error(f"CRITICAL error in /outcome route during SSOL/COS creation: {e}", exc_info=True)
            flash(f"A critical error occurred while generating the solution. Please try again. Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    # Redirect if the request method is not POST
    return redirect(url_for('routes_bp.index'))

# --- Input Analysis ---
@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    if request.method == 'POST':
        user_text = request.form.get('user_text')
        if not user_text:
            return jsonify({'error': 'No text provided'}), 400
        try:
            keywords = await analyze_user_input(user_text)
            compliance_data = await is_input_compliant(user_text)
            return jsonify({'keywords': keywords, 'compliance': compliance_data})
        except Exception as e:
            logging.error(f"Error analyzing user input: {e}", exc_info=True)
            return jsonify({'error': 'Error analyzing input'}), 500
    return jsonify({'error': 'Invalid request method'}), 405

# --- PDF Export ---
@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        data = request.get_json()
        if not data or 'htmlContent' not in data:
            raise ValueError("Invalid request: No HTML content provided.")
        html_content = data['htmlContent']

        css_file_path = os.path.join(current_app.root_path, 'static', 'styles.css')
        css_param = css_file_path if os.path.exists(css_file_path) else None
        if not css_param:
             current_app.logger.error(f"CSS file not found at: {css_file_path}")

        html_content = html_content.replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')

        options = {
            "page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in",
            "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8",
            "no-outline": None, "enable-local-file-access": None,
        }

        pdf = pdfkit.from_string(html_content, False, options=options, css=css_param)

        response = make_response(pdf)
        response.headers['Content-Type'] = 'application/pdf'
        response.headers['Content-Disposition'] = f'attachment; filename="SSPEC_Solution_{ssol_id}.pdf"'
        return response

    except Exception as e:
        current_app.logger.error(f"Exception in save_as_pdf for SSOL {ssol_id}: {e}", exc_info=True)
        return jsonify(success=False, error=str(e)), 500

# --- COS CRUD Routes ---
@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        if not data: raise BadRequest('No JSON payload received.')

        content = data.get('content')
        ssol_id_str = data.get('ssol_id')
        if not content or not ssol_id_str:
            raise BadRequest('Missing required fields: content and ssol_id are required.')
        
        ssol_id_uuid = UUID(ssol_id_str)

        new_cos_id_str = await speculate_create_cos(
            USE_DATABASE,
            ssol_id=ssol_id_uuid,
            content=content,
            status=data.get('status', 'Proposed'),
            accountable_party=data.get('accountable_party'),
            completion_date=data.get('completion_date')
        )

        if not new_cos_id_str:
            raise Exception("Failed to create COS record in the data store.")

        created_cos_obj = speculate_get_cos_by_id(USE_DATABASE, UUID(new_cos_id_str))
        if not created_cos_obj:
             return jsonify(success=False, error="COS created but could not be retrieved."), 500

        cos_dict = created_cos_obj.to_dict() if USE_DATABASE else created_cos_obj
        return jsonify(success=True, cos=cos_dict), 201

    except BadRequest as e:
        return jsonify(success=False, error=str(e)), 400
    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        return jsonify(success=False, error="An unexpected error occurred while creating the COS."), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        if not data: raise BadRequest('No JSON payload received')
        
        update_result = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)

        if update_result['success']:
            return jsonify(success=True, cos=update_result['cos']), 200
        return jsonify(success=False, error=update_result['message']), update_result.get('status_code', 404)
    except BadRequest as e:
        return jsonify(success=False, error=str(e)), 400
    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return jsonify(success=False, error="An unexpected error occurred."), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    try:
        success = speculate_delete_cos_by_id(USE_DATABASE, cos_id)
        if success:
            return jsonify(success=True), 200
        return jsonify(success=False, error="COS not found or could not be deleted."), 404
    except Exception as e:
        current_app.logger.error(f"Error deleting COS {cos_id}: {e}", exc_info=True)
        return jsonify(success=False, error="An unexpected error occurred."), 500

# --- SSOL Image ---
@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    ssol_id_str = str(ssol_id)
    image_filename = f"ssol_image_{ssol_id_str}.png"
    image_web_path_relative = os.path.join('images', image_filename).replace("\\", "/")
    image_fs_path = os.path.join(current_app.static_folder, 'images', image_filename)
    
    current_app.logger.info(f"GET_SSOL_IMAGE: Checking for {image_fs_path}")
    
    if os.path.exists(image_fs_path):
        current_app.logger.info(f"GET_SSOL_IMAGE: Found image {image_filename} for SSOL {ssol_id_str}.")
        return jsonify({'image_path': url_for('static', filename=image_web_path_relative), 'status': 'found'})
    else:
        current_app.logger.warning(f"GET_SSOL_IMAGE: Image {image_filename} for SSOL {ssol_id_str} not found.")
        return jsonify({ 'status': 'pending_or_not_found', 'message': 'Image is processing or was not found.' }), 200

# --- CE Routes ---
@routes_bp.route('/get_ce_by_id', methods=['GET'])
def get_ce_by_id_route():
    ce_id_str = request.args.get('ce_id')
    if not ce_id_str:
        return jsonify(error="Missing 'ce_id' parameter"), 400
    try:
        ce_id = UUID(ce_id_str)
        ce = speculate_get_ce_by_id(USE_DATABASE, ce_id)
        if ce:
            return jsonify(ce=ce.to_dict() if USE_DATABASE else ce)
        return jsonify(error="CE not found"), 404
    except ValueError:
        return jsonify(error=f"Invalid CE ID format: {ce_id_str}"), 400
    except Exception as e:
        current_app.logger.error(f"Error getting CE {ce_id_str}: {e}", exc_info=True)
        return jsonify(error="An unexpected error occurred."), 500

@routes_bp.route('/analyze_cos/<uuid:cos_id>', methods=['GET'])
async def analyze_cos_by_id_route(cos_id):
    try:
        cos_content_to_analyze = ""
        if USE_DATABASE:
            cos_instance = speculate_get_cos_by_id(USE_DATABASE, cos_id)
            if not cos_instance:
                return jsonify({'success': False, 'message': 'COS not found'}), 404
            cos_content_to_analyze = cos_instance.content
        else:
            from store import cos_store
            cos_data = cos_store.get(str(cos_id))
            if not cos_data:
                return jsonify({'success': False, 'message': 'COS not found'}), 404
            cos_content_to_analyze = cos_data['content']
        
        analysis_results = await speculate_analyze_cos(cos_content_to_analyze, str(cos_id))
        return jsonify({'success': True, 'analysis_results': analysis_results}), 200
    except Exception as e:
        current_app.logger.error(f"Error analyzing COS {cos_id}: {e}", exc_info=True)
        return jsonify({'success': False, 'message': 'An unexpected error occurred during analysis.'}), 500

@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        
        # --- FIX: Receive ce_text from the frontend payload ---
        ce_text = data.get('ce_text', 'Conditional Element') # Use a default for safety

        ce_id_obj = UUID(ce_id_str) if ce_id_str else None

        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        if not ce_data or 'data' not in ce_data:
            ce_data = {'id': ce_id_str, 'node_type': ce_type, 'data': {'details_data': {}, 'resources': []}}

        node_config = NODES.get(ce_type, NODES['Default'])
        cos_content_html = data.get('cos_content', '')
        cos_content_text_only = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)

        ai_generated_data = await generate_ai_data(
            node_type=ce_type,
            cos_content=cos_content_text_only,
            ssol_goal=data.get('ssol_goal', ''),
            agent_mode='context'
        )

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type,
            ce_text=ce_text,  # --- FIX: Pass the ce_text to the template function ---
            ce_data=ce_data,
            node_info=node_config,
            cos_content=cos_content_html,
            ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''),
            phase_index=data.get('phase_index', 0)
        )
        
        return jsonify(modal_html=modal_html, ce_data=ce_data)

    except Exception as e:
        current_app.logger.error(f"Error in get_ce_modal_route for type {ce_type}: {e}", exc_info=True)
        return jsonify(error=f"An error occurred: {str(e)}"), 500

@routes_bp.route('/ai-query-endpoint', methods=['POST'])
async def ai_query_route():
    try:
        data = request.get_json()
        if not data: return jsonify({'error': 'No JSON payload received'}), 400

        required_params = ['ce_type', 'cos_content', 'ssol_goal']
        if not all(key in data for key in required_params):
            return jsonify({'error': f'Missing required parameters: {required_params}'}), 400
        
        ai_response = await generate_ai_data(
            node_type=data.get('ce_type'),
            cos_content=data.get('cos_content'),
            ssol_goal=data.get('ssol_goal'),
            agent_mode=data.get('agent_mode', 'speculate') # e.g., 'speculate', 'generate'
        )
        return jsonify({'success': True, 'ai_response': ai_response})

    except Exception as e:
        current_app.logger.error(f"Error in ai_query_route: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

ğŸŸ© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>What is your Commitment?</h1>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Your Input</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="user-input">
          <span class="user-input-display">{{ user_input }}</span>
          <input type="text" class="form-control form-control-sm user-input-edit d-none" value="{{ user_input }}">
        </td>
        <td class="text-end">
          <button type="button" class="btn btn-primary btn-sm edit-user-input">Edit</button>
          <button type="button" class="btn btn-success btn-sm save-user-input d-none">Update</button>
          <button type="button" class="btn btn-danger btn-sm cancel-user-input d-none">Cancel</button>
        </td>
      </tr>
    </tbody>
  </table>
  <p>
    Based on your input, we have speculated three high-level outcomes.
    Please choose the one that is closest to your desired result, or click the "Speculate New Outcomes" button to
    generate a new set of possibilities.
  </p>
  <div class="row card-container">
    {% for goal in goals %}
      <div class="col-md-4 mb-4">
        <div class="card retro-futuristic-card text-center diagonal-pivot-container {% if not goal.is_compliant %}non-compliant{% endif %}">
            <div class="diagonal-pivot-frame"></div>
            <div class="diagonal-pivot-frame"></div>
            <div class="diagonal-pivot-frame"></div>

            <div class="card-body card-content diagonal-pivot-content">
                <div class="card-upper-content">
                    <i class="{{ goal.icon }} fa-2x mt-3 mb-3 goal-content-item"></i>
                    <p class="domain domain-text goal-content-item">{{ goal.domain | title }}</p>
                    <div class="goal-description goal-text goal-content-item">
                        {{ goal.goal | replace('\n', '<br>') | safe }}
                    </div>
                </div>
                <form action="/outcome" method="post" class="goal-selection-form">
                  <input type="hidden" name="selected_goal" value="{{ goal.goal }}">
                  <input type="hidden" name="domain" value="{{ goal.domain }}">
                  <input type="hidden" name="domain_icon" value="{{ goal.icon }}">
                  <input type="hidden" name="selected_goal_title" value="{{ goal.title }}">
                  {% if goal.is_compliant %}
                    <button type="submit" class="btn btn-primary">Select</button>
                  {% else %}
                    <a href="{{ url_for('routes_bp.index') }}" class="btn btn-danger">Start Over</a>
                  {% endif %}
                </form>
            </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="text-center">
    <button type="button" class="btn btn-outline-primary" id="generate-new-goals">
      <span class="refresh-icon"><i class="fas fa-sync-alt"></i></span> Speculate New Outcomes</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- All JavaScript logic will now be driven by goal_selection.js and base_functions.js -->
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
{% endblock %}

ğŸŸ§ ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

ğŸŸ¦ outcome.html:
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <!-- Title Row (Spanning Full Width) -->
    <div class="row">
        <div class="col text-center">
            <h1 class="ssol-title">{{ ssol.ssol_title | safe }}</h1>
        </div>
    </div>

    <!-- Image and Domain Row -->
    <div class="row outcome-header">
        <div class="col-md-4 text-center">
            <!-- Image Wrapper (for stacking) -->
            <div class="image-wrapper">
                <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" alt="Loading Structure..." class="rounded mb-3 placeholder-image" id="placeholderImage">
                <img src="" alt="Structured Solution Visualization" class="rounded mb-3 generated-image" id="ssolImage"> {# src will be set by JS #}
            </div>
            <!-- Container for error/status messages -->
            <div id="image-status-container" class="mt-2 small"></div>

            <h2>Domain</h2>
            <i class="{{ ssol.domain_icon }} fa-3x mb-3"></i>
            <p class="domain domain-text text-center">{{ ssol.domain | title }}</p>
            <h2>Fulfilled Goal</h2>
            <p><strong>{{ ssol.selected_goal | safe }}</strong></p>
            <div id="ssol-goal" style="display: none;">{{ ssol.selected_goal | safe }}</div>
            <div class="text-center mt-4">
                <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-info" title="Save as PDF">
                    <i class="fas fa-download me-2"></i>PDF
                </button>
            </div>
        </div>

        <!-- Summary Column -->
        <div class="col-md-8">
            <h1>Preliminary Structured Solution</h1>
            <p id="ssol-summary">{{ ssol.ssol_summary | safe }}</p>
        </div>
    </div>

    <!-- Phases & Conditions of Satisfaction Row (Table structure remains the same) -->
    <div class="row">
        <h1>Phases & Conditions of Satisfaction</h1>
        <div class="col">
            <div class="accordion mt-4" id="phase-accordion">
                {% for phase_name, cos_list in ssol.phases.items() %}
                <div class="accordion-item">
                    <h2 class="accordion-header phase-colors" id="heading-{{ phase_name | replace(' ', '_') }}">
                        <button
                            class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ phase_name | replace(' ', '_') }}"
                            aria-expanded="true" 
                            aria-controls="collapse-{{ phase_name | replace(' ', '_') }}"
                            style="background-color: var(--phase-{{ loop.index0 }});">
                            {{ phase_name | title }} PHASE
                        </button>
                    </h2>
                    <div
                        id="collapse-{{ phase_name | replace(' ', '_') }}"
                        class="accordion-collapse collapse show" 
                        aria-labelledby="heading-{{ phase_name | replace(' ', '_') }}"
                        data-bs-parent="#phase-accordion">
                        <div class="accordion-body phase-table-container" data-ssol-id="{{ ssol_id }}" style="border: 2px solid var(--phase-{{ loop.index0 }});">
                            {% if cos_list %}
                            <table class="table table-striped table-hover phase-table" id="{{ phase_name | replace(' ', '_') }}-table">
                                <thead>
                                    <tr>
                                        <th scope="col" style="width: 10%;">Status</th>
                                        <th scope="col" style="width: 40%;">Condition of Satisfaction</th>
                                        <th scope="col" style="width: 15%;">Accountable Party</th>
                                        <th scope="col" style="width: 15%;">Completion Date</th>
                                        <th scope="col" class="text-end actions-header" style="width: 20%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cos in cos_list %}
                                    <tr class="cos-row" data-cos-id="{{ cos.id }}" data-editing="false">
                                        <td class="status-cell align-middle">
                                            <span class="status-pill {{ cos.status | get_badge_class_from_status }}">{{ cos.status | upper }}</span>
                                        </td>
                                        <td class="cos-content-cell align-middle">
                                            <div class="cos-content-display">{{ cos.content | safe }}</div>
                                            <div class="cos-content-edit d-none">
                                                <textarea class="form-control form-control-sm cos-content-textarea" rows="3">{{ cos.content | striptags }}</textarea>
                                            </div>
                                        </td>
                                        <td class="cos-accountable-party-cell align-middle">
                                            <span class="cos-accountable-party-display">{{ cos.accountable_party or 'N/A' }}</span>
                                            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                        </td>
                                        <td class="cos-completion-date-cell align-middle">
                                            <span class="cos-completion-date-display">{{ cos.completion_date or 'N/A' }}</span>
                                            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date if cos.completion_date else '' }}">
                                        </td>
                                        <td class="text-end actions-cell align-middle">
                                            <div class="btn-group cos-actions" role="group">
                                                <button class="btn btn-sm btn-primary edit-cos-button" title="Edit COS"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-sm btn-success update-cos-button d-none" title="Update COS"><i class="fas fa-check"></i></button>
                                                <button class="btn btn-sm btn-secondary cancel-cos-button d-none" title="Cancel Edit"><i class="fas fa-times"></i></button>
                                                <button class="btn btn-sm btn-danger delete-cos-button" title="Delete COS"><i class="fas fa-trash"></i></button>
                                                <button class="btn btn-sm btn-info analyze-cos-button" data-cos-id="{{ cos.id }}" title="Analyze COS"><i class="fas fa-search-plus"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button class="btn btn-success btn-sm add-cos mt-2" data-phase="{{ phase_name | replace(' ', '_') }}">
                                <i class="fas fa-plus"></i> Add Condition of Satisfaction
                            </button>
                            {% else %}
                            <p>No Conditions of Satisfaction found for this phase.</p>
                            <button class="btn btn-success btn-sm add-cos mt-2" data-phase="{{ phase_name | replace(' ', '_') }}">
                                <i class="fas fa-plus"></i> Add Condition of Satisfaction
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">{{ error_message }}</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Placeholder for dynamic modals -->
    <div id="dynamicModalContainer"></div>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>

<link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const ssolId = "{{ ssol_id }}"; // From Flask template
    const ssolImageElement = document.getElementById('ssolImage'); 
    const placeholderImageElement = document.getElementById('placeholderImage');
    const imageStatusContainer = document.getElementById('image-status-container'); // Renamed for clarity

    const defaultStaticImagePath = "{{ url_for('static', filename='images/sspec_default.png') }}";
    const loadingGifPath = "{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}";

    if (ssolImageElement && placeholderImageElement) {
        // Initial state for fade effect
        ssolImageElement.src = ""; // Start with empty src for the final image
        ssolImageElement.style.opacity = '0';
        placeholderImageElement.src = loadingGifPath;
        placeholderImageElement.style.opacity = '1';
        if (imageStatusContainer) imageStatusContainer.innerHTML = ''; // Clear previous messages

        let attempts = 0;
        const maxAttempts = 7; // Increased attempts
        const retryDelay = 2500; // Slightly longer delay

        function fetchImageWithRetry() {
            attempts++;
            if (imageStatusContainer) { // Update status message
                imageStatusContainer.innerHTML = `<p class="text-info">Fetching image (attempt ${attempts}/${maxAttempts})...</p>`;
            }

            fetch(`/get_ssol_image/${ssolId}`)
              .then(response => {
                if (!response.ok) {
                  return response.json().then(err => {
                    throw new Error(err.error || err.message || `HTTP error! status: ${response.status}`);
                  }).catch(() => {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                  });
                }
                return response.json();
              })
              .then(data => {
                console.log(`Image fetch attempt ${attempts}:`, data); 
                // Check if a valid, non-default, non-placeholder image path is found
                if (data.image_path && data.status === 'found' && 
                    data.image_path !== defaultStaticImagePath && 
                    data.image_path !== loadingGifPath &&
                    !data.image_path.includes('SSPEC_Logo_Motion.gif') && // Explicitly check against GIF name part
                    !data.image_path.includes('sspec_default.png')      // Explicitly check against default name part
                   ) {
                  ssolImageElement.src = data.image_path;
                  ssolImageElement.alt = "Structured Solution Visualization";
                  ssolImageElement.onload = () => {
                    placeholderImageElement.style.opacity = '0';
                    ssolImageElement.style.opacity = '1';
                    placeholderImageElement.classList.add('hidden');
                    ssolImageElement.classList.add('loaded');
                    if (imageStatusContainer) imageStatusContainer.innerHTML = ''; // Clear status on success
                  };
                  ssolImageElement.onerror = () => {
                    console.error('Error loading final SSOL image from path:', data.image_path);
                    displayDefaultImage("Could not load the retrieved image. Displaying default.");
                  };
                } else if (attempts < maxAttempts && (data.status === 'pending_or_not_found' || !data.image_path || data.image_path.includes('sspec_default.png'))) {
                  // If status is pending, or if the path returned is still a default path, retry
                  setTimeout(fetchImageWithRetry, retryDelay);
                } else { 
                  // Max attempts reached or a non-retryable issue (e.g., explicit error from server that's not 'pending')
                  displayDefaultImage(data.message || 'Image not available after retries. Displaying default.');
                }
              })
              .catch(error => {
                console.error(`Error fetching image data (attempt ${attempts}):`, error);
                if (attempts < maxAttempts) {
                  if (imageStatusContainer) imageStatusContainer.innerHTML = `<p class="text-danger">Error fetching image (attempt ${attempts}/${maxAttempts}). Retrying...</p>`;
                  setTimeout(fetchImageWithRetry, retryDelay);
                } else {
                  displayDefaultImage('Image loading failed after multiple attempts.');
                }
              });
        }

        function displayDefaultImage(message) {
            placeholderImageElement.style.opacity = '0'; // Hide placeholder
            ssolImageElement.src = defaultStaticImagePath;
            ssolImageElement.alt = "Default SSPEC Image";
            ssolImageElement.style.opacity = '1'; // Show default
            ssolImageElement.classList.add('loaded');
            if (imageStatusContainer) {
                imageStatusContainer.innerHTML = `<p class="text-warning small mt-1">${message}</p>`;
            }
        }

        fetchImageWithRetry(); // Initial call
    } else {
        console.warn("Required image elements (ssolImage or placeholderImage) not found.");
    }
  });
</script>

{% endblock %}

â¬œ speculate.py:
# speculate.py (Complete and Final Refactor)
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from ce_nodes import NODES, get_valid_node_types
from sqlalchemy.exc import SQLAlchemyError
from ai_service import generate_chat_response_with_node_types, generate_chat_response

# No longer importing from ce_templates

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """Helper function to generate the standard HTML for a CE pill."""
    node_info = NODES.get(ce_type, NODES['Default'])
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-question-circle')
    
    return (
        f'<span class="ce-pill" data-ce-id="{ce_id}" data-ce-type="{ce_type}" style="--node-color: {node_color};">'
        f'<span class="ce-pill-icon"><i class="{node_icon}"></i></span>'
        f'<span class="ce-pill-text">{html.escape(ce_text)}</span>'
        f'</span>'
    )

# --- COS Analysis and CE Creation ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content using an AI model to identify potential CEs.
    This function's primary role is to get a structured JSON response from the AI.
    It does NOT generate the final HTML pills.
    """
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify all Conditional Elements (CEs) within this text. "
        f"For each CE found, determine its most appropriate 'NodeType' from this list ONLY: {', '.join(get_valid_node_types())}. "
        "Your response MUST be a valid JSON object with two keys: "
        "'analyzed_cos_text': The original COS text with each CE wrapped in <ce type='NodeType'>CE Text</ce> tags. "
        "And 'identified_ces': an array of objects, where each object has 'text' and 'type' keys. "
        "Example: {'analyzed_cos_text': 'The <ce type=\\'Research\\'>literature review</ce> must be done.', 'identified_ces': [{'text': 'literature review', 'type': 'Research'}]}"
    )

    messages = [
        {"role": "system", "content": "You are an expert in analyzing text to identify conditional elements and structure them in JSON. Ensure NodeTypes are from the provided list."},
        {"role": "user", "content": prompt},
    ]
    response_text = ""
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS for CEs')
        response_json = json.loads(response_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}. AI Response: '{response_text}'", exc_info=True)
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> str:
    """
    Creates a COS and its associated CEs by parsing a pre-tagged content string.
    This function NO LONGER makes an API call.
    """
    from models import COS, CE, db
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    try:
        # 1. Parse the pre-tagged content string to find all <ce> tags.
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        
        new_ce_instances = []
        content_with_pills = content # Start with the original tagged content

        # 2. Create CE records and simultaneously build the final HTML for the COS content.
        for tag in ce_tags:
            ce_text = tag.string
            ce_type = tag.get('type')
            if not ce_text or not ce_type or ce_type not in NODES:
                continue

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': ce_type,
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "resources": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace the simple <ce> tag with a full, rendered HTML pill.
            pill_html = _render_ce_pill_html(str(new_ce_uuid), ce_type, ce_text)
            
            # This is a bit tricky; we need to replace the tag without destroying the soup
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        # Get the final HTML string from the modified soup
        content_with_pills = str(soup)

        # 3. Save everything to the database or in-memory store.
        if USE_DATABASE:
            with app.app_context():
                cos_instance = COS(
                    id=new_cos_uuid, content=content_with_pills, status=status, ssol_id=ssol_id,
                    accountable_party=accountable_party, completion_date=completion_date
                )
                db.session.add(cos_instance)

                for ce_rec in new_ce_instances:
                    ce_instance = CE(id=ce_rec['id'], node_type=ce_rec['node_type'], cos_id=new_cos_uuid, data=ce_rec['data'])
                    db.session.add(ce_instance)
                db.session.commit()
        else:
            cos_store[cos_id_str] = {'id': cos_id_str, 'content': content_with_pills, 'status': status, 'ssol_id': str(ssol_id)}
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
        
        return cos_id_str

    except Exception as e:
        current_app.logger.error(f"Error creating COS (SSOL: {ssol_id}): {e}", exc_info=True)
        if USE_DATABASE: db.session.rollback()
        raise

async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    """
    Updates a COS. If the content changes, it re-analyzes CEs and rebuilds the content with new pills.
    """
    from models import COS, CE, db
    from store import cos_store, ce_store
    from app import app

    new_content_text = updated_data.get('content')
    
    try:
        if new_content_text is not None:
            # If content is being updated, we must re-run the entire CE creation and pill generation process.
            analysis_result = await analyze_cos(new_content_text, str(cos_id))
            content_with_tags = analysis_result['content_with_tags']
            ces_to_create = analysis_result['identified_ces']
            
            new_ce_instances = []
            content_with_pills = content_with_tags

            for ce_data in ces_to_create:
                ce_text, ce_type = ce_data.get('text'), ce_data.get('type')
                if not ce_text or not ce_type: continue
                new_ce_uuid = uuid.uuid4()
                new_ce_instances.append({'id': new_ce_uuid, 'node_type': ce_type, 'cos_id': cos_id})
                ce_tag_to_replace = f"<ce type=\"{ce_type}\">{ce_text}</ce>"
                pill_html = _render_ce_pill_html(str(new_ce_uuid), ce_type, ce_text)
                content_with_pills = content_with_pills.replace(ce_tag_to_replace, pill_html, 1)
            
            updated_data['content'] = content_with_pills # Replace raw text with final HTML
        
        if USE_DATABASE:
            with app.app_context():
                cos = db.session.query(COS).get(cos_id)
                if not cos: return {'success': False, 'message': f"COS {cos_id} not found.", 'status_code': 404}
                
                # Update COS fields
                for key, value in updated_data.items():
                    if hasattr(cos, key) and key not in ['id', 'ssol_id']:
                        setattr(cos, key, value)
                
                if new_content_text is not None:
                    # Clear old CEs and add new ones
                    db.session.query(CE).filter_by(cos_id=cos_id).delete()
                    for ce_rec in new_ce_instances:
                        ce_instance = CE(id=ce_rec['id'], node_type=ce_rec['node_type'], cos_id=cos_id)
                        db.session.add(ce_instance)
                
                db.session.commit()
                return {'success': True, 'cos': cos.to_dict()}
        else:
            # In-memory logic...
            pass # (Can be filled in if needed)

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        if USE_DATABASE: db.session.rollback()
        return {'success': False, 'message': f"Unexpected error: {str(e)}", 'status_code': 500}

def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app

    if USE_DATABASE:
        if not isinstance(cos_id, UUID):
            try:
                cos_id = UUID(str(cos_id))
            except ValueError:
                current_app.logger.error(f"Invalid UUID format for cos_id: {cos_id}")
                return None
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            session.close()
            return cos
    else:
        return cos_store.get(str(cos_id))

async def update_cos_by_id(USE_DATABASE: bool, cos_id_param: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from store import cos_store, ce_store
    from app import app

    analysis_result = {}
    try:
        cos_id_uuid = cos_id_param
        cos_id_str = str(cos_id_uuid)

        new_content_text = updated_data.get('content')
        content_with_pills_for_update = None
        new_ces_data_list_from_analysis = []

        if new_content_text is not None:
            analysis_result = await analyze_cos(new_content_text, cos_id_str)
            content_with_pills_for_update = analysis_result['content_with_ce']
            new_ces_data_list_from_analysis = analysis_result['ces_data_list']
            updated_data['content'] = content_with_pills_for_update
        
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id_uuid)
                if not cos:
                    session.close()
                    return {'success': False, 'message': f"COS {cos_id_str} not found.", 'status_code': 404}

                for key, value in updated_data.items():
                    if key not in ['conditional_elements', 'id', 'ssol_id']:
                        setattr(cos, key, value)
                
                if new_content_text is not None:
                    session.query(CE).filter_by(cos_id=cos_id_uuid).delete(synchronize_session=False)
                    session.flush()

                    for ce_data in new_ces_data_list_from_analysis:
                        new_ce_instance = CE(
                            id=UUID(ce_data['id']),
                            node_type=ce_data['node_type'],
                            cos_id=cos_id_uuid
                        )
                        session.add(new_ce_instance)
                
                session.commit()
                updated_cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': updated_cos_dict}
        else:
            cos_record = cos_store.get(cos_id_str)
            if not cos_record:
                return {'success': False, 'message': f"COS {cos_id_str} not found.", 'status_code': 404}

            for key, value in updated_data.items():
                if key != 'conditional_elements':
                    cos_record[key] = value
            
            if new_content_text is not None:
                if 'conditional_elements' in cos_record:
                    for old_ce in cos_record['conditional_elements']:
                        ce_store.pop(old_ce['id'], None)
                cos_record['conditional_elements'] = []

                for ce_data in new_ces_data_list_from_analysis:
                    new_ce_dict = {
                        'id': ce_data['id'],
                        'node_type': ce_data['node_type'],
                        'cos_id': cos_id_str
                    }
                    ce_store[ce_data['id']] = new_ce_dict
                    cos_record['conditional_elements'].append(new_ce_dict)
            
            return {'success': True, 'cos': cos_record}

    except KeyError as e:
        current_app.logger.error(f"KeyError updating COS {cos_id_param}: {e}. Analysis result: {analysis_result}", exc_info=True)
        return {'success': False, 'message': f"Data error: {str(e)}", 'status_code': 400}
    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id_param}: {e}", exc_info=True)
        if USE_DATABASE and 'session' in locals() and session.is_active:
            session.rollback(); session.close()
        return {'success': False, 'message': f"Unexpected error: {str(e)}", 'status_code': 500}


def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from store import cos_store, ce_store
    from app import app

    try:
        cos_id_uuid = cos_id
        cos_id_str = str(cos_id_uuid)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                session.query(CE).filter_by(cos_id=cos_id_uuid).delete(synchronize_session=False)
                cos = session.query(COS).get(cos_id_uuid)
                if cos:
                    session.delete(cos)
                    session.commit()
                    session.close()
                    return True
                session.close()
                return False
        else:
            if cos_id_str in cos_store:
                cos_record = cos_store.get(cos_id_str, {})
                for ce_data in cos_record.get('conditional_elements', []):
                    ce_store.pop(ce_data['id'], None)
                del cos_store[cos_id_str]
                return True
            return False
    except Exception as e:
        current_app.logger.error(f"Error deleting COS {cos_id}: {e}", exc_info=True)
        if USE_DATABASE and 'session' in locals() and session.is_active:
            session.rollback()
            session.close()
        return False

# --- SSOL CRUD Operations ---
def create_ssol(USE_DATABASE: bool, title: str, description: str) -> str:
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            ssol = SSOL(id=new_ssol_uuid, title=title, description=description)
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {'id': ssol_id, 'title': title, 'description': description, 'phases': {}}
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    else:
        return ssol_store.get(str(ssol_id))

# --- CE CRUD Operations ---
def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app

    ce_id_uuid = None
    if isinstance(ce_id_param, UUID):
        ce_id_uuid = ce_id_param
    else:
        try:
            ce_id_uuid = UUID(str(ce_id_param))
        except ValueError:
            current_app.logger.error(f"Invalid UUID format for ce_id: '{ce_id_param}'")
            return None

    try:
        if USE_DATABASE:
            with app.app_context():
                engine, SessionLocal = get_engine_and_session()
                session = SessionLocal()
                try:
                    ce_db_instance = session.query(CE).get(ce_id_uuid)
                    if ce_db_instance:
                        ce_data_to_return = ce_db_instance.to_dict()
                    else:
                        current_app.logger.debug(f"CE with ID {ce_id_uuid} not found in database.")
                        ce_data_to_return = None
                except Exception as db_exc:
                    current_app.logger.error(f"Database error retrieving CE {ce_id_uuid}: {db_exc}", exc_info=True)
                    ce_data_to_return = None
                finally:
                    session.close()
            return ce_data_to_return
        else:
            return ce_store.get(str(ce_id_uuid))

    except ValueError as ve:
        current_app.logger.error(f"ValueError processing CE ID '{ce_id_param}': {ve}", exc_info=True)
        return None
    except Exception as e:
        current_app.logger.error(f"Unexpected error in get_ce_by_id for CE ID '{ce_id_param}': {e}", exc_info=True)
        return None


def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app

    new_ce_uuid = uuid.uuid4()
    ce_id_str = str(new_ce_uuid)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = CE(id=new_ce_uuid, node_type=node_type, cos_id=cos_id, data=data)
            session.add(ce)
            session.commit()
            session.close()
    else:
        ce_data = {'id': ce_id_str, 'node_type': node_type, 'cos_id': str(cos_id), 'data': data}
        ce_store[ce_id_str] = ce_data
    return ce_id_str


def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app

    ce_id_uuid = ce_id
    ce_id_str = str(ce_id_uuid)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            if ce:
                # The 'data' column is the one we update with the entire payload
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    else:
        if ce_id_str in ce_store:
            # We update the 'data' field, but keep id, node_type, etc.
            if 'data' not in ce_store[ce_id_str]:
                 ce_store[ce_id_str]['data'] = {}
            ce_store[ce_id_str]['data'] = ce_data
            return True
        return False

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id
    ce_id_str = str(ce_id_uuid)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            if ce:
                session.delete(ce)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    else:
        return bool(ce_store.pop(ce_id_str, None))


ğŸ“† models.py:
# models.py
import os
import json
import uuid
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date) # FIX: Added Text and Date to imports
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()


# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    status = Column(String(50), nullable=False, default='Proposed')
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE CORE REFACTOR ---
    # All flexible data is now stored in a single, extensible JSON field.
    # The old 'content' and 'details' columns are removed.
    # The default ensures new CEs start with the correct empty structure, preventing errors.
    data = Column(JsonType, nullable=False, default=lambda: {"details_data": {}, "resources": []})

    def to_dict(self):
        # The to_dict method now simply returns the stored data along with the ID info.
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data  # This will contain 'details_data' and 'resources'
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

ğŸ”µ ce_cards.js:
// ce_cards.js

let state = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    // We now store all collections in a unified object
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    details_data: {},
    aiSidebarContent: '', // Cache content
};

function render() {
    if (!state.modalElement) return;
    renderProgressBar();
    renderAllCollections(); // Renders all lists (prerequisites, stakeholders, etc.)
    renderAiSidebar();
    updateCounts();
}

function renderAllCollections() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(type => {
        renderCollection(type);
    });
}

// Generic renderer for any list-based tab
function renderCollection(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5 text-muted border border-dashed rounded">
                <i class="fas fa-folder-open fa-2x mb-3 opacity-25"></i>
                <p>No ${type} added yet.</p>
            </div>`;
        return;
    }

    // Generate Card HTML based on data
    container.innerHTML = items.map(item => `
        <div class="card mb-2 border-start-0 border-end-0 border-top-0 border-bottom shadow-sm" style="border-left: 4px solid var(--phase-color) !important;">
            <div class="card-body p-3 d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="fw-bold mb-1">${item.title || item.name || item.hypothesis || 'Untitled'}</h6>
                    <p class="small text-muted mb-0 text-truncate" style="max-width: 400px;">
                        ${item.role || item.risk || item.url || ''}
                    </p>
                     ${item.tags ? `<span class="badge bg-light text-dark border mt-2">${item.tags}</span>` : ''}
                </div>
                <button class="btn btn-sm btn-light text-primary btn-edit-item" 
                    data-collection="${type}" data-id="${item.id}">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function renderAiSidebar() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if (!content) return;

    let actionsHtml = '';
    
    // Context-Aware Actions
    if (state.activeTab === 'overview') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-rocket text-primary me-2"></i> Suggest Critical Path</button>
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-microchip text-primary me-2"></i> Analyze Feasibility</button>
        `;
    } else if (state.activeTab === 'stakeholders') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-user-plus text-success me-2"></i> Identify Key Players</button>
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-handshake text-info me-2"></i> Suggest Alignment Strategy</button>
        `;
    } else if (state.activeTab === 'assumptions') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-shield-alt text-warning me-2"></i> Challenge Assumptions</button>
        `;
    } else {
        // Default
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border"><i class="fas fa-lightbulb text-warning me-2"></i> Generate Ideas</button>
        `;
    }

    content.innerHTML = `
        <div class="mb-4">
            <h6 class="small fw-bold text-muted text-uppercase mb-3">Context: ${state.activeTab}</h6>
            ${actionsHtml}
        </div>
        <div class="mb-4">
            <h6 class="small fw-bold text-muted text-uppercase mb-3">Chat</h6>
            <textarea class="form-control form-control-sm mb-2" rows="3" placeholder="Ask SPECULATE..."></textarea>
            <button class="btn btn-primary btn-sm w-100">Send</button>
        </div>
    `;
}

function updateCounts() {
    state.modalElement.querySelectorAll('.count-badge').forEach(badge => {
        const type = badge.dataset.collection;
        if (state.collections[type]) {
            badge.textContent = state.collections[type].length;
        }
    });
    
    // Overall progress (mock logic)
    const totalItems = Object.values(state.collections).flat().length;
    const progress = Math.min(100, totalItems * 5);
    const bar = state.modalElement.querySelector('#ce-progress-bar');
    const label = state.modalElement.querySelector('#ce-progress-label');
    if (bar) bar.style.width = `${progress}%`;
    if (label) label.textContent = `${progress}%`;
}

// --- ACTIONS ---

function toggleEditor(collectionType, show, itemData = null) {
    const container = state.modalElement.querySelector(`#container-${collectionType}-${state.ceId}`);
    const editor = state.modalElement.querySelector(`#editor-${collectionType}-${state.ceId}`);
    const form = editor.querySelector('form');

    if (show) {
        container.style.display = 'none';
        editor.style.display = 'block';
        form.reset();
        // Pre-fill if editing
        if (itemData) {
            form.dataset.editingId = itemData.id;
            Object.keys(itemData).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = itemData[key];
            });
        } else {
            delete form.dataset.editingId;
        }
    } else {
        container.style.display = 'block';
        editor.style.display = 'none';
        delete form.dataset.editingId;
    }
}

// --- LISTENERS ---

function setupEventListeners() {
    const modal = state.modalElement;

    // Tab Switching -> Update Sidebar Context
    const tabEl = modal.querySelector('.ce-nav-tabs');
    if (tabEl) {
        tabEl.addEventListener('shown.bs.tab', event => {
            const targetId = event.target.getAttribute('data-bs-target'); // e.g. #view-stakeholders-UUID
            // Extract middle part "stakeholders"
            const parts = targetId.split('-');
            state.activeTab = parts[1]; 
            renderAiSidebar();
        });
    }

    modal.addEventListener('click', event => {
        const t = event.target;
        
        // Add Item Button
        const addBtn = t.closest('.btn-add-item');
        if (addBtn) {
            toggleEditor(addBtn.dataset.collection, true);
        }

        // Cancel Edit Button
        if (t.closest('.btn-cancel-edit')) {
            // Find parent collection type
            const editor = t.closest('.collection-editor');
            const type = editor.id.split('-')[1];
            toggleEditor(type, false);
        }
        
        // Edit specific item
        const editBtn = t.closest('.btn-edit-item');
        if (editBtn) {
            const type = editBtn.dataset.collection;
            const id = editBtn.dataset.id;
            const item = state.collections[type].find(i => i.id === id);
            if (item) toggleEditor(type, true, item);
        }
        
        // Save Main Button
        if (t.closest('.btn-save-changes')) {
            saveDataPacket();
        }
    });

    // Form Submissions (Generic Handler for all collection editors)
    modal.addEventListener('submit', event => {
        if (event.target.classList.contains('editor-form')) {
            event.preventDefault();
            const form = event.target;
            const type = form.dataset.collection;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            if (form.dataset.editingId) {
                // Update
                const index = state.collections[type].findIndex(i => i.id === form.dataset.editingId);
                if (index > -1) state.collections[type][index] = { ...state.collections[type][index], ...data };
            } else {
                // Add
                data.id = self.crypto.randomUUID();
                state.collections[type].push(data);
            }
            
            toggleEditor(type, false);
            render();
        }
    });
}

function saveDataPacket() {
    const btn = state.modalElement.querySelector('.btn-save-changes');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Harvest text areas from Narrative tab
    const narrativeForm = state.modalElement.querySelector(`#narrative-form-${state.ceId}`);
    if(narrativeForm) {
        const fd = new FormData(narrativeForm);
        state.details_data = Object.fromEntries(fd.entries());
    }

    // Build Packet matching `CE` model `data` JSON structure
    const packet = {
        details_data: state.details_data,
        resources: state.collections.resources,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        connections: state.collections.connections
    };

    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    }).then(res => res.json()).then(data => {
        btn.innerHTML = '<i class="fas fa-check"></i> Saved';
        setTimeout(() => btn.innerHTML = 'Save Changes', 2000);
    });
}

export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    modalContainer.innerHTML = modalHtml;
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        const d = ceData?.data || {};
        state = {
            modalElement, ceId, ceType: p_ceType, activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
        };
        render();
        setupEventListeners();
    }, { once: true });

    modalElement.addEventListener('hidden.bs.modal', () => modalElement.remove());
    modal.show();
}

ğŸ§© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER -->
            <div class="modal-header ce-modal-header">
                <div class="node-icon"><i class="{{ node_info.icon }}"></i></div>
                <div class="ms-3 flex-grow-1 text-truncate">
                    <div class="modal-title ce-title">{{ ceType.replace('_', ' ').title() }}</div>
                    <div class="phase-name opacity-90">// {{ ce_text }} // {{ phase_name.title() }} PHASE</div>
                </div>
                <div class="ms-auto d-flex align-items-center gap-2">
                     <button class="btn btn-header-action" id="speculate-sidebar-toggle" title="Open Co-Pilot">
                        <i class="fas fa-columns"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>

            <!-- PROGRESS BAR -->
            <div class="progress-bar-container">
                <div class="d-flex align-items-center">
                    <span class="small text-uppercase fw-bold text-muted me-3" style="font-size: 0.7rem; letter-spacing: 0.5px;">Readiness</span>
                    <div class="progress flex-grow-1" style="height: 6px; background-color: #e9ecef;">
                        <div id="ce-progress-bar" class="progress-bar" role="progressbar" style="width: 0%; transition: width 0.6s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="ce-progress-label" class="small fw-bold ms-3 text-muted" style="width: 35px; text-align: right;">0%</span>
                </div>
            </div>

            <!-- MAIN WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex overflow-hidden">
                
                <div class="ce-main-column d-flex flex-column flex-grow-1 overflow-hidden" style="min-width: 0;">
                    
                    <!-- STRATEGIC TABS -->
                    <ul class="nav nav-tabs ce-nav-tabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">Overview</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-narrative-{{ ceId }}">Narrative</button></li>
                        
                        <!-- Dynamic Collection Tabs -->
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-prerequisites-{{ ceId }}">Prerequisites <span class="badge rounded-pill bg-light text-dark ms-1 count-badge" data-collection="prerequisites">0</span></button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-stakeholders-{{ ceId }}">Stakeholders <span class="badge rounded-pill bg-light text-dark ms-1 count-badge" data-collection="stakeholders">0</span></button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-assumptions-{{ ceId }}">Assumptions <span class="badge rounded-pill bg-light text-dark ms-1 count-badge" data-collection="assumptions">0</span></button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-resources-{{ ceId }}">Resources <span class="badge rounded-pill bg-light text-dark ms-1 count-badge" data-collection="resources">0</span></button></li>
                        
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}">Connections <span class="badge rounded-pill bg-light text-dark ms-1 count-badge" data-collection="connections">0</span></button></li>
                    </ul>

                    <div class="ce-app-content tab-content flex-grow-1 overflow-y-auto bg-light">
                        
                        <!-- 1. OVERVIEW -->
                        <div class="tab-pane fade show active p-4" id="view-overview-{{ ceId }}">
                            <!-- (Overview content same as before, focused on dashboard metrics) -->
                             <div class="card ai-context-card border-0 shadow-sm mb-4">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-start gap-3">
                                        <div class="text-primary mt-1"><i class="fas fa-sparkles fa-lg"></i></div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold text-uppercase small text-muted mb-2">Strategic Insight</h6>
                                            <p class="text-dark mb-0" style="line-height: 1.6;">
                                                {{ ai_generated_data.contextual_description or 'Analyzing strategic context...' }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Source COS -->
                            <div class="card border shadow-sm source-cos-card">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary text-uppercase small mb-2"><i class="fas fa-crosshairs me-2"></i>Source Requirement</h6>
                                    <div class="p-3 bg-white rounded border border-light-subtle">
                                        <p class="fst-italic mb-0 text-dark small">{{ cos_content_with_pills | safe }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. NARRATIVE (Previously Details) -->
                        <div class="tab-pane fade p-4" id="view-narrative-{{ ceId }}">
                            <div class="details-form-container mx-auto">
                                <form id="narrative-form-{{ ceId }}">
                                {% for field in node_info.details_schema %}
                                <div class="card mb-3 shadow-sm border-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0 fw-bold text-secondary">{{ field.label }}</label>
                                            <button type="button" class="btn btn-sm btn-light text-primary btn-enhance-field" data-field="{{ field.key }}"><i class="fas fa-magic"></i></button>
                                        </div>
                                        <textarea name="{{ field.key }}" class="form-control bg-light border-0" rows="4">{{ ce_data.data.details_data.get(field.key, '') }}</textarea>
                                    </div>
                                </div>
                                {% endfor %}
                                </form>
                            </div>
                        </div>

                        <!-- 3-6. UNIVERSAL COLLECTIONS (Generated Loop) -->
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        {% set schema = node_info[collection[:-1] + '_schema'] %}
                        <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                            
                            <!-- Toolbar -->
                            <div class="p-3 border-bottom bg-white flex-shrink-0 d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-1"></i> Add {{ collection[:-1]|capitalize }}</button>
                                    <button class="btn btn-outline-primary btn-speculate-collection" data-collection="{{ collection }}"><i class="fas fa-brain me-1"></i> Suggest</button>
                                </div>
                                <input type="text" class="form-control form-control-sm w-auto search-collection" data-collection="{{ collection }}" placeholder="Filter...">
                            </div>

                            <!-- List Container -->
                            <div class="flex-grow-1 p-3 overflow-y-auto collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}">
                                <!-- JS renders cards here -->
                            </div>

                            <!-- Hidden Editor (One per collection type to handle schema differences) -->
                            <div class="collection-editor p-4 bg-white border-top" id="editor-{{ collection }}-{{ ceId }}" style="display: none;">
                                <h5 class="mb-3 fw-bold">Edit {{ collection[:-1]|capitalize }}</h5>
                                <form class="editor-form" data-collection="{{ collection }}">
                                    {% for field in schema %}
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted text-uppercase">{{ field.label }}</label>
                                        {% if field.type == 'textarea' %}
                                            <textarea name="{{ field.key }}" class="form-control" rows="2"></textarea>
                                        {% elif field.type == 'select' %}
                                            <select name="{{ field.key }}" class="form-select">
                                                {% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}
                                            </select>
                                        {% elif field.type == 'slider' %}
                                            <input type="range" name="{{ field.key }}" class="form-range" min="0" max="100">
                                        {% else %}
                                            <input type="text" name="{{ field.key }}" class="form-control">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-light btn-cancel-edit">Cancel</button>
                                        <button type="submit" class="btn btn-success">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- 7. CONNECTIONS TAB -->
                         <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                            <div id="connections-container" class="text-center p-5 text-muted">
                                <i class="fas fa-project-diagram fa-3x mb-3 opacity-25"></i>
                                <h5>Knowledge Graph</h5>
                                <p>Connections allow for vectorizing the relationship between this CE and the broader SSOL.</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- AI SIDEBAR (Right Column) -->
                <div class="ai-sidebar d-flex flex-column border-start">
                    <div class="sidebar-header p-3 text-white bg-primary d-flex align-items-center">
                         <h6 class="mb-0 fw-bold"><i class="fas fa-brain me-2"></i> SPECULATE Engine</h6>
                    </div>
                    <div class="p-3 overflow-y-auto flex-grow-1" id="ai-sidebar-content"></div>
                </div>

            </div>

            <div class="modal-footer ce-modal-footer">
                <div class="small text-muted me-auto"><i class="fas fa-circle text-success" style="font-size: 8px;"></i> Systems Active</div>
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary px-4 btn-save-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>
"""

# Generate function remains the same
async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=ce_data.get('id', 'new_ce'),
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

ğŸ³ï¸â€ğŸŒˆ ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It goes beyond simple data entry, defining "Smart Schemas" that guide
users and AI agents to think strategically about each specific domain.

Schema Field Types for UI Rendering:
- text, textarea, number, date, link
- select (requires 'options')
- slider (0-100 range for confidence/impact)
- tags (array of strings)
- toggle (boolean switch)
- currency (financial values)
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Fallback)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4, "help": "High-level overview."},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ]
    },

    # ==============================================================================
    # 2. RESEARCH (The Knowledge Engine)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink (Discovery)
        "details_schema": [
            {"key": "research_question", "label": "Core Question", "type": "textarea", "help": "What is the single most important thing we need to know?", "rows": 2},
            {"key": "hypothesis", "label": "Working Hypothesis", "type": "textarea", "rows": 2},
            {"key": "synthesis", "label": "Synthesis of Findings", "type": "textarea", "rows": 6, "help": "AI Generated summary of all attached resources."}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]},
            {"key": "blocker", "label": "Blockers", "type": "tags"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "tags"},
            {"key": "credibility", "label": "Credibility Score", "type": "slider"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]},
            {"key": "validated", "label": "Validated?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Title", "type": "text", "width": "full"},
            {"key": "url", "label": "Source URL", "type": "link", "width": "half"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset", "Interview"], "width": "half"},
            {"key": "relevance", "label": "Relevance", "type": "slider", "width": "third"},
            {"key": "snippet", "label": "Key Insight", "type": "textarea", "width": "full"},
            {"key": "ai_summary", "label": "AI Analysis", "type": "textarea", "readonly": True, "width": "full"}
        ]
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red (Warning)
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text", "help": "Where is the threat coming from?"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [ # Using Prerequisites to track "Early Warning Signs"
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"},
            {"key": "monitoring", "label": "Monitoring Active?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text", "help": "Why do we think our plan will work?"},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "resource_schema": [ # Specific schema for Risk Resources (Mitigation Tools)
            {"key": "tool_name", "label": "Mitigation Tool/Protocol", "type": "text"},
            {"key": "cost", "label": "Implementation Cost", "type": "currency"},
            {"key": "effectiveness", "label": "Est. Effectiveness", "type": "slider"}
        ]
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Social Graph)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber (Engagement)
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea", "help": "What does 'success' look like for this group?"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea", "help": "What do they get out of it?"},
            {"key": "friction_points", "label": "Potential Friction", "type": "tags"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text", "help": "Who introduces us?"},
            {"key": "material_needs", "label": "Materials Needed", "type": "tags"}
        ],
        "stakeholder_schema": [ # This is recursive! Sub-stakeholders or team members
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "interest", "label": "Interest (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Supporter", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed via Interview?", "type": "toggle"}
        ],
        "resource_schema": [ # Resources here are CRM-like
            {"key": "title", "label": "Document/Contract", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]},
            {"key": "link", "label": "Link", "type": "link"}
        ]
    },

    # ==============================================================================
    # 5. PRAXIS (The Action Engine)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo (Action)
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "definition_of_done", "label": "Definition of Done", "type": "textarea", "rows": 3, "help": "Verifiable completion criteria."},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea", "help": "Why is this hard?"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready", "Complete"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Estimation Assumption", "type": "text"},
            {"key": "resource_avail", "label": "Resource Availability Assumption", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "access_link", "label": "Access Link", "type": "link"},
            {"key": "instructions", "label": "SOP/Instructions", "type": "textarea"}
        ]
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Context)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green (Sustainability)
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4},
            {"key": "circularity", "label": "Circularity/Regeneration Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulatory Approval", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Local Community", "type": "text"},
            {"key": "regulator", "label": "Regulatory Body", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "data_points", "label": "Key Data Points", "type": "tags"},
            {"key": "url", "label": "Link", "type": "link"}
        ]
    },

    # ==============================================================================
    # 7. TIMELINE (The Temporal Backbone)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "critical_path", "label": "Is Critical Path?", "type": "toggle"},
            {"key": "slack_analysis", "label": "Slack/Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors (Weather/Supply)", "type": "tags"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "start", "label": "Start Date", "type": "date"},
            {"key": "end", "label": "End Date", "type": "date"},
            {"key": "status", "label": "Status", "type": "select", "options": ["On Track", "At Risk", "Late"]}
        ]
    },

    # ==============================================================================
    # 8. ADVOCACY (The Voice)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action (CTA)", "type": "text"},
            {"key": "channels", "label": "Key Channels", "type": "tags"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset Needed", "type": "text"},
            {"key": "platform", "label": "Platform Readiness", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience Segment", "type": "text"},
            {"key": "influencer", "label": "Key Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Public Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Video", "Article", "Social Post", "Event"]},
            {"key": "url", "label": "Link", "type": "link"}
        ]
    },

    # ==============================================================================
    # 9. COLLABORATION (The Glue)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea", "help": "What can we do together that we can't do alone?"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual", "JV"]},
            {"key": "trust_level", "label": "Current Trust Level", "type": "slider"}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Strategic Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Resource Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement/MOU", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Negotiating", "Signed"]},
            {"key": "link", "label": "Link", "type": "link"}
        ]
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

ğŸ¨ styles.css:
/* styles.css - Complete and Consolidated Styles (Refactored for Bootstrap Table COS Layout & CE Modals) */

/* ================================================== */
/* ==============  1. Base Typography & Root Vars ==== */
/* ================================================== */
:root {
  --phase-0: #e91e63; /* Discovery */
  --phase-1: #00bcd4; /* Engagement */
  --phase-2: #9c27b0; /* Action */
  --phase-3: #ffc107; /* Completion */
  --phase-4: #66bd0e; /* Legacy */
}

body {
  font-family: 'Jost', sans-serif;
  font-weight: 400;
  background-color: #f5f5f5;
  color: #333;
}

h1 {
  font-family: 'Mr Dafoe', cursive;
  font-weight: 400;
  color: #ffa726;
  text-shadow: 1px 1px 0px #e91e63;
  font-size: 3.0rem;
  text-align: center;
  margin-top: 1rem;
  margin-bottom: 1rem;
}

h2, .section-heading {
  font-family: 'Unica One', sans-serif;
  font-weight: 500;
  text-transform: uppercase;
  color: #104a3a;
  text-shadow: 1px 1px 0px #000000; /* Consider a more subtle shadow or none */
}

/* Specific h2 styling for outcome page sections if needed */
.outcome-header h2,
.row > h1 { /* Targeting the "Phases & Conditions of Satisfaction" h1 */
    margin-top: 1.5rem;
    margin-bottom: .5rem;
}

.section-heading { /* Used in CE Modals */
    font-size: 1.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e0e0e0;
}

h3, .sub-heading {
  font-family: 'Unica One', sans-serif;
  font-weight: 500;
  text-transform: uppercase;
  color: #555;
}

.sub-heading { /* Used in CE Modals */
    font-family: 'Unica One', sans-serif;
    font-weight: 500;
    color: #333;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.25rem;
}


/* ================================================== */
/* ==============  2. Navigation Bar  =============== */
/* ================================================== */
nav.navbar {
  background-image: linear-gradient(120deg, #673ab7 0%, #00bcd4 100%);
  border-bottom: 5px solid #e91e63;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}

nav.navbar .navbar-brand {
  color: #ffffff;
  font-weight: 500;
  font-size: 4.5rem; 
  padding-top: 0;
  padding-bottom: 0;
}

.navbar-brand h1 { /* If h1 is directly in navbar-brand */
  font-size: inherit; /* Inherit from .navbar-brand for consistency */
  color: #ffa726; /* Match general h1 color */
  text-shadow: 1px 1px 0px #e91e63; /* Match general h1 shadow */
  margin-bottom: 0;
  line-height: 1;
}

.structured-speculation {
  display: block;
  font-family: 'Unica One', sans-serif;
  font-weight: 700;
  text-align: center;
  font-size: 1rem; /* Adjusted for better fit */
  text-transform: uppercase;
  color: rgba(0, 0, 0, 0.85); /* Lighter for better contrast on gradient */
  letter-spacing: 0.7em; /* Adjusted */
  line-height: 1;
  margin-top: 5px; /* Pull up slightly under the main brand text */
}


/* ================================================== */
/* =========  3. Retro-futuristic Background Pattern ======== */
/* ================================================== */
body:before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: radial-gradient(circle at 10% 20%, #e91e63 10%, transparent 10%),
                    radial-gradient(circle at 90% 20%, #00bcd4 10%, transparent 10%),
                    radial-gradient(circle at 40% 60%, #9c27b0 10%, transparent 10%),
                    radial-gradient(circle at 60% 80%, #ffc107 10%, transparent 10%);
  background-size: 40px 40px;
  background-attachment: fixed;
  opacity: 0.3; /* Slightly more subtle */
  z-index: -1;
}


/* ================================================== */
/* ===========  4. General Container & Card Styles ========== */
/* ================================================== */
.container { /* Main page container */
  background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white for depth */
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  margin-top: 20px;
  margin-bottom: 20px;
}

.card { /* General card styling, like for Goal Selection */
  background-color: #ffffff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  transition: box-shadow 0.3s ease-in-out;
}

.card:hover {
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.card-header,
.card-footer { /* Bootstrap default card header/footer */
  background-color: #673ab7;
  color: #ffffff;
  border-radius: 8px 8px 0 0; /* Match card radius if header is at top */
}
.card-footer {
  border-radius: 0 0 8px 8px;
}


/* Retro-futuristic Card (Specific card style for goal selection cards) */
retro-futuristic-card {
  border: 3px solid #00bcd4;
  height: 100%;
}
.retro-futuristic-card.non-compliant { border-color: red; }
.retro-futuristic-card.non-compliant:hover { box-shadow: 0 8px 16px rgba(196, 93, 93, 0.2); }


/* --- Diagonal Pivot Frame Animation --- */


.diagonal-pivot-container.card {
    position: relative;
    perspective: 1200px;
    transform-style: preserve-3d;
    padding: 0;
    /* --- NEW: Make card invisible by default for staggered fade-in --- */
    opacity: 0;
    transition: opacity 0.4s ease-in;
}

/* --- NEW: Add class to trigger the card's visibility --- */
.diagonal-pivot-container.card.animate {
    opacity: 1;
}

.diagonal-pivot-frame {
    position: absolute;
    inset: 0;
    border: 4px solid;
    border-radius: 10px; 
    background: transparent; /* Make frame background transparent */
    transform: rotate3d(1, -1, 0, 90deg);
    pointer-events: none;
    /* --- MODIFIED: Remove box-shadow from base state --- */
    transition: box-shadow 0.3s ease-in-out; /* Add transition for smooth glow */
}

/* --- NEW: Glow on Hover --- */
.diagonal-pivot-container:hover .diagonal-pivot-frame:nth-child(1) {
    box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
}
.diagonal-pivot-container:hover .diagonal-pivot-frame:nth-child(2) {
    box-shadow: 0 10px 40px rgba(0, 255, 0, 0.3);
}
.diagonal-pivot-container:hover .diagonal-pivot-frame:nth-child(3) {
    box-shadow: 0 10px 40px rgba(0, 191, 255, 0.4);
}
.non-compliant:hover .diagonal-pivot-frame:nth-child(1) {
    box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
}
.non-compliant:hover .diagonal-pivot-frame:nth-child(2) {
    box-shadow: 0 10px 40px rgba(255, 165, 0, 0.3);
}
.non-compliant:hover .diagonal-pivot-frame:nth-child(3) {
    box-shadow: 0 10px 40px rgba(220, 53, 69, 0.4);
}


.diagonal-pivot-frame.animate {
    animation: diagonalCardFlip 1.2s ease-out forwards;
}

/* Default Compliant Card Colors */
.diagonal-pivot-frame:nth-child(1) {
    opacity: 0.6;
    border-color: #FFD700;
    animation-delay: 0s;
}

.diagonal-pivot-frame:nth-child(2) {
    opacity: 0.7;
    border-color: #00FF00;
    animation-delay: 0.15s;
}

.diagonal-pivot-frame:nth-child(3) {
    opacity: 1;
    border-color: #00BFFF;
    animation-delay: 0.3s;
}

/* Non-Compliant/Restricted Card Pivot Animation Colors */
.non-compliant .diagonal-pivot-frame:nth-child(1) {
    border-color: #FFD700; 
}
.non-compliant .diagonal-pivot-frame:nth-child(2) {
    border-color: #FFA500; 
}
.non-compliant .diagonal-pivot-frame:nth-child(3) {
    border-color: #DC3545; 
}


@keyframes diagonalCardFlip {
    to {
        transform: rotate3d(1, -1, 0, 0deg);
    }
}

.diagonal-pivot-content.card-body {
    position: relative;
    z-index: 10; 
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    
    /* FIX: Change solid background to a semi-transparent one using rgba */
    background: rgba(255, 255, 255, 0.5); /* 85% opaque white */
    backdrop-filter: blur(2px); /* Optional: Adds a subtle "frosted glass" effect */
    
    border-radius: 6px; 
    padding: 20px;
}

/* --- NEW: Styles for staggered content fade-in --- */
.goal-content-item {
    opacity: 0;
    transition: opacity 0.6s ease-out; /* Slower fade for a smoother effect */
}

.goal-content-item.animate {
    opacity: 1;
}

/* ================================================== */
/* ===============  5. Button Styles  ================ */
/* ================================================== */
.btn { /* General button enhancements */
    transition: all 0.2s ease-in-out;
}
.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-primary {
  background-color: #ff5722;
  border-color: #ff5722;
}
.btn-primary:hover, .btn-primary:focus, .btn-primary:active {
  background-color: #e64a19 !important; /* Ensure override */
  border-color: #d84315 !important;
}

.btn-danger {
  color: #fff;
  background-color: #dc3545;
  border-color: #dc3545;
}
.btn-danger:hover {
  color: #fff;
  background-color: #c82333 !important;
  border-color: #bd2130 !important;
}
.btn-info { /* Used for PDF button */
    background-color: #17a2b8;
    border-color: #17a2b8;
}
.btn-info:hover {
    background-color: #138496 !important;
    border-color: #117a8b !important;
}
.btn-success { /* Used for Add COS, Update COS */
    background-color: #28a745;
    border-color: #28a745;
}
.btn-success:hover {
    background-color: #218838 !important;
    border-color: #1e7e34 !important;
}


/* ================================================== */
/* ==============  6. Outcome Page Styles  ============ */
/* ================================================== */
.outcome-header { /* Row containing image/domain and summary */
  margin-bottom: 2rem;
}
.outcome-header .col-md-4 h2 { /* Specific to H2s in the left column like DOMAIN, FULFILLED GOAL */
    text-align: center;    /* Align these to center */
    font-size: 1.5rem;     /* Keep or adjust existing font-size */
    margin-bottom: 0.5rem; /* Keep or adjust existing margin */
}
.outcome-header .col-md-8 h1 { /* For the H1 in the right column (e.g., Preliminary Structured Solution) */
    text-align: center;      /* Keep this left-aligned or adjust as desired */
}


/* ================================================== */
/* ===========  7. Loading Spinner Styles  ============= */
/* ================================================== */
.loading-spinner-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.spinner-box {
  width: 50vw; /* Responsive width for the box */
  max-width: 550px; /* Maximum width for the box */
  height: 30vh; /* Responsive height for the box */
  max-height: 175px; /* Maximum height for the box */
  background-color: rgba(255, 255, 255, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
  padding: 20px;
}

.spinner-container { /* This is implicitly the container for icon and text */
  display: flex;
  flex-direction: column;
  align-items: center;
}

.spinner-text {
  margin-top: 20px;
  font-family: 'Unica One', sans-serif;
  text-transform: uppercase;
  color: rgba(0, 0, 0, 0.75);
  letter-spacing: 0.4em;
  text-align: center;
  white-space: nowrap; /* Prevent text wrapping */
}

/* Animations in section 17 */


/* ================================================== */
/* ===========  8. Refresh Icon Animation  =========== */
/* ================================================== */
#generate-new-goals .refresh-icon { display: inline-block; transition: transform 0.5s ease; }
#generate-new-goals:hover .refresh-icon { transform: rotate(360deg); }


/* ================================================== */
/* ============  9. Domain Icon Styles  ============== */
/* ================================================== */
.domain-text {
  font-family: 'Unica One', sans-serif;
  text-transform: uppercase;
  font-size: 1.3rem; /* Slightly adjusted */
  color: #555;
}
.outcome-header .fa-3x { /* Domain icon on outcome page */
    color: #00bcd4; /* Match a theme color */
}


/* ================================================== */
/* ==========  10. Report Section Title (Unused) ======== */
/* ================================================== */
/* .report-section-title { ... } */


/* ================================================== */
/* == 11. Phase Accordion & COS Table Styles == */
/* ================================================== */
.accordion-header {
  color: #ffffff;
  border-radius: 5px 5px 0 0; /* Rounded top corners */
  margin-bottom: 0; /* No margin if border is directly on accordion-item */
}
.accordion-item {
    margin-bottom: 10px; /* Space between accordion items */
    border-radius: 5px;
    border: 1px solid #ddd; /* Overall border for accordion item */
}
.accordion-button {
  text-transform: uppercase;
  font-family: 'Unica One', sans-serif;
  font-weight: 500;
  font-size: 1rem;
  text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
  color: #ffffff;
  border-radius: 4px 4px 0 0 !important;
}

.accordion-button:focus { outline: none; box-shadow: none; }
.accordion-button:not(.collapsed) { color: #ffffff; }

.accordion-body.phase-table-container { /* Where the table resides */
  background-color: #ffffff; /* White background for table area */
  border-radius: 0 0 5px 5px; /* Rounded bottom corners */
  padding: 15px;
  /* border-top: none; */ /* Top border is handled by header */
}


/* COS Table Styling */
.phase-table {
    margin-bottom: 1rem; /* Space below table before "Add COS" button */
    border-collapse: separate; /* Allows border-spacing */
    border-spacing: 0; /* Remove default spacing if any */
}
.phase-table thead th {
    background-color: #f8f9fa; /* Light grey for table header */
    color: #343a40;
    border-bottom-width: 2px; /* Bootstrap default */
    font-family: 'Jost', sans-serif;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    vertical-align: middle;
}
.phase-table tbody tr.cos-row { /* Each COS row */
    background-color: #fff; /* Ensure white background for rows */
}
.phase-table tbody tr.cos-row:hover {
    background-color: #f1f8ff; /* Light blue hover for rows */
}
.phase-table td {
    vertical-align: middle; /* Default vertical alignment for all cells */
    padding: 0.75rem; /* Standard Bootstrap padding */
    font-size: 0.9rem;
}

/* Specific Cell Styling */
.status-cell { text-align: center; } /* Center the status pill */
.cos-content-cell .cos-content-display {
    line-height: 1.6;
    word-break: break-word; /* Ensure long content wraps */
}
.cos-content-cell {
    margin-right: 4px;
    margin-bottom: 4px; /* For wrapping */
}

.cos-content-display {
    display: inline-block; /* Or 'inline-flex' if it has an icon inside */
    width: auto;           /* Explicitly tell it not to take full width */
    max-width: 100%;       /* Prevent it from overflowing on very small screens */
    vertical-align: middle; /* Aligns it nicely with the surrounding text */
}

.ce-pill {
    display: inline-flex; /* Use inline-flex for perfect alignment of icon and text */
    align-items: center;  /* Vertically align content within the pill */
    width: auto;          /* Only take up as much space as needed */
    max-width: 100%;      /* Prevent overflow on small screens */
    vertical-align: middle; /* Align nicely with surrounding text */
    margin: 0 2px;        /* Give it a little breathing room */
  }

.cos-content-textarea { /* Textarea when editing COS content */
  width: 100%;
  border-radius: 4px;
  border: 1px solid #ced4da;
  padding: 0.5rem 0.75rem;
  font-size: 0.9rem;
  min-height: 80px; /* Adjust as needed */
}
.actions-cell .btn-group.cos-actions { /* Ensure buttons in group are tight */
    white-space: nowrap;
}
.actions-cell .btn-group.cos-actions .btn {
    margin-right: 3px; /* Small space between buttons */
}
.actions-cell .btn-group.cos-actions .btn:last-child {
    margin-right: 0;
}

.add-cos.btn { /* "Add Condition of Satisfaction" button */
    margin-top: 0.5rem; /* Space above it */
}


/* ================================================== */
/* =========  12. Status & CE Pill Styles  =========== */
/* ================================================== */
.status-pill {
  color: #fff !important;
  text-align: center;
  text-transform: uppercase;
  font-size: 0.65em;
  font-weight: 600;
  text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.2);
  padding: .3em .7em;
  border-radius: 10rem;
  line-height: 1;
  display: inline-block;
}

/* --- THE DEFINITIVE CE PILL STYLE (v2) --- */
.ce-pill {
  display: inline-flex; 
  align-items: stretch; /* FIX 1: Make child elements stretch to fill the pill's height */
  margin: 0 4px; 
  border-radius: 6px;
  overflow: hidden;
  border: 1.5px solid var(--node-color, #6c757d);
  background-color: #fff;
  width: auto;
  max-width: 100%;
  vertical-align: middle;
  cursor: pointer;
  transition: box-shadow 0.2s ease;
}
.ce-pill:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.ce-pill-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 .6rem; /* FIX 2: Adjust padding for vertical balance */
  background-color: var(--node-color, #6c757d);
  color: white;
}
.ce-pill-text {
  padding: .25rem .7rem;
  font-size: 0.85rem;
  font-weight: 500;
  line-height: 1.4;
  white-space: nowrap;
  display: flex; /* Add flex to help with vertical alignment */
  align-items: center;
}

.modal .content-block .card-text {
    line-height: 1.8; /* Give a little extra line height to accommodate pills */
}

/* ================================================== */
/* ==========  13. Badge Color Overrides  ============ */
/* ================================================== */
.bg-info { background-color: #007bff !important; } /* Bootstrap 4 blue */
.bg-warning { color: #212529 !important; background-color: #ffc107 !important; }
.bg-success { background-color: #28a745 !important; }
.bg-danger { background-color: #dc3545 !important; }
.bg-secondary { background-color: #6c757d !important; }


/* ================================================== */
/* ===========  14. Action Column Styles  ============ */
/* ================================================== */
.actions-header { /* th for Actions column */
  white-space: nowrap;
  min-width: 210px; /* Adjusted for 5 small buttons with icons */
}
.actions-cell { /* td for Actions column */
    white-space: nowrap; /* Keep buttons on one line if possible */
}
.actions-cell .btn-group {
    flex-wrap: nowrap; /* Prevent button group from wrapping */
}


/* ================================================== */
/* == 15. Card Grid Layout (Goal Selection) == */
/* ================================================== */
.card-container { flex-wrap: nowrap !important; justify-content: center; }
.card { display: flex; flex-direction: column; height: 100%; }
.card-body { flex-grow: 1; display: flex; flex-direction: column; }
.card-upper-content { flex-grow: 1; display: flex; flex-direction: column; }
.card-content { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
.goal-selection-form { margin-top: auto; padding-top: 1rem; }

/* ================================================== */
/* ======  16. Generated Image & Placeholder Styles  ==== */
/* ================================================== */
.ssol-title {
    text-align: center; margin-bottom: 10px; display: block;
    font-family: 'Unica One', sans-serif; font-weight: 500;
    font-size: 3.5rem; /* Changed from 2.8rem */
    color: #326eb6; text-transform: uppercase; text-shadow: 1px 1px 0px #000000;
    letter-spacing: 0.2em; /* Changed from 0.15em */
    line-height: 90%; /* Changed from 1 */
}

.image-wrapper {
    position: relative; /* For potential future overlay elements if any */
    display: inline-block; /* Or block, depending on desired centering within col-md-4 */
    width: 100%; /* Make wrapper take full width of its column */
    max-width: 300px; /* Max width of the image itself */
    aspect-ratio: 1 / 1; /* Enforce a square aspect ratio for the space */
    background-color: #f0f0f0; /* Light background for the reserved space */
    border-radius: 25px; /* Match image border-radius */
    margin-bottom: 20px; /* Consistent margin */
    overflow: hidden; /* If image is not perfectly square, it will be contained */
}

.ssol-dynamic-image { /* Targets the single image tag by its new class */
    display: block; /* Remove extra space below inline images */
    width: 100%;    /* Image fills the wrapper width */
    height: 100%;   /* Image fills the wrapper height */
    object-fit: cover; /* Scales the image to maintain its aspect ratio while filling the elementâ€™s entire content box. If the image's aspect ratio does not match the aspect ratio of its box, then the object will be clipped to fit. */
    border-radius: 25px; /* Rounded corners for the image itself */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Subtle shadow */
    /* No opacity or transition here, it's a direct src change */
}

.placeholder-image, .generated-image {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; 
    border-radius: 25px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
}
.placeholder-image { opacity: 1; z-index: 1; transition: opacity 0.5s ease-out; }
.placeholder-image.hidden { opacity: 0; z-index: -1; }
.generated-image {
    opacity: 0; z-index: 2; transition: opacity 0.5s ease-in;
    background-color: #eee; 
}
.generated-image.loaded { opacity: 1; }

/* ================================================== */
/* ========  17. Consolidated Fade Animations  ========= */
/* ================================================== */
@keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
.fade-in { opacity: 0; transition: opacity 1s ease-in; }
.fade-in.loaded { opacity: 1; }

@keyframes fadeInBlur { 0% { opacity: 0; filter: blur(5px); } 100% { opacity: 1; filter: blur(0); } }
.loading-spinner-overlay.fade-in { animation: fadeInBlur 0.5s ease-in-out forwards; }

@keyframes fadeOutBlur { 0% { opacity: 1; filter: blur(0px); } 100% { opacity: 0; filter: blur(5px); } }
.loading-spinner-overlay.fade-out { animation: fadeOutBlur 0.5s ease-in-out forwards; }

@keyframes fadeInScale { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } } /* Adjusted scale */
@keyframes fadeOutScale { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.95); } } /* Adjusted scale */
.modal.fade-in { animation: fadeInScale 0.3s forwards; } /* Faster modal fade */
.modal.fade-out { animation: fadeOutScale 0.3s forwards; }

@keyframes wipeOn { 0% { opacity: 0; transform: scaleX(0); } 100% { opacity: 1; transform: scaleX(1); } }
.text-wipe-on span { display: inline-block; overflow: hidden; animation: wipeOn 0.1s forwards; opacity: 0; transform-origin: left; }

.text-fade-in { opacity: 0; transition: opacity 0.5s ease-in-out; }
.fonts-loaded .text-fade-in { opacity: 1; }


/* ================================================== */
/* == 18. Text Input Styles (Goal Input - Unchanged) == */
/* ================================================== */
.user-input { font-weight: bold; font-size: 1.2rem; }
.user-input-display { font-weight: bold; font-size: 1.2rem; }
.user-input-edit {
  font-weight: bold; font-size: 1.2rem; border: none;
  width: 100%; background-color: transparent; padding: 0.25rem;
}
.user-input-edit:focus {
  background-color: #e9ecef; outline: none;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* ================================================== */
/* == 19. Table Row Styles (Goal Input - Unchanged) === */
/* ================================================== */
.table-bordered > thead > tr > th { border-bottom: 2px dotted #dee2e6; }


/* ================================================== */
/* ==========  20. Editing State Styles (COS Table)  ============= */
/* ================================================== */
/* These control visibility of display spans vs edit inputs within table cells */
.cos-row td .cos-content-edit,
.cos-row td .cos-accountable-party-edit,
.cos-row td .cos-completion-date-edit,
.cos-row td select.status-edit-select {
    display: none; /* Hide edit fields by default */
}

.cos-row[data-editing="true"] td .cos-content-display,
.cos-row[data-editing="true"] td .cos-accountable-party-display,
.cos-row[data-editing="true"] td .cos-completion-date-display,
.cos-row[data-editing="true"] td .status-pill { /* Hide display spans/pill in edit mode */
    display: none !important;
}

.cos-row[data-editing="true"] td .cos-content-edit,
.cos-row[data-editing="true"] td .cos-accountable-party-edit,
.cos-row[data-editing="true"] td .cos-completion-date-edit,
.cos-row[data-editing="true"] td select.status-edit-select {
    display: block; /* Show edit fields in edit mode */
    width: 100%; /* Make inputs take full cell width */
}
.cos-row[data-editing="true"] td select.status-edit-select {
    font-size: 0.8rem; /* Smaller font for select in table */
}


/* Button visibility toggling (JS also helps with d-none, this is CSS backup/primary) */
.cos-row .update-cos-button,
.cos-row .cancel-cos-button {
    display: none;
}
.cos-row[data-editing="true"] .edit-cos-button,
.cos-row[data-editing="true"] .delete-cos-button, /* Hide delete/analyze during edit */
.cos-row[data-editing="true"] .analyze-cos-button {
    display: none !important;
}
.cos-row[data-editing="true"] .update-cos-button,
.cos-row[data-editing="true"] .cancel-cos-button {
    display: inline-block !important;
}


/* ================================================== */
/* ===========  21. Modal Custom Styling  ============ */
/* ================================================== */
.modal-content {
  border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
  border: 2px solid transparent; max-height: 90vh;
  display: flex; flex-direction: column;
}
.modal-header.ce-modal-header {
  display: flex; align-items: center; justify-content: flex-start; /* Changed */
  padding: 1rem 1.5rem; border-top-left-radius: 8px; border-top-right-radius: 8px;
  position: relative; color: white;
}
.ce-modal-header .node-icon {
  background-color: white; border-radius: 5px; padding: 8px 10px;
  margin-right: 1rem; flex-shrink: 0; display: inline-flex;
  align-items: center; justify-content: center;
}
.ce-modal-header .node-icon i { font-size: 1.25rem; }

.ce-modal-header .modal-title.ce-title {
  font-family: 'Unica One', sans-serif; font-weight: 500; text-transform: uppercase;
  text-shadow: 1px 1px 1px rgba(0,0,0,0.4); color: white;
  font-size: 1.6rem; margin-right: 0.5rem; line-height: 1.2;
}

.ce-modal-header .phase-name {
  font-family: 'Jost', sans-serif; font-size: 0.85rem; font-style: italic;
  text-transform: uppercase; color: rgba(255, 255, 255, 0.9);
  margin-left: 1rem; white-space: nowrap; line-height: 1.2;
}

.content-block p {
    display: inline; /* This is a key part of the fix */
}


.modal-header .btn-close {
    margin-left: auto; /* Push close button to the far right */
    filter: invert(1) grayscale(100%) brightness(200%); /* Make it white */
}

.modal-body.ce-modal-body {
  flex-grow: 1; overflow-y: auto; padding: 2rem;
  box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
}
.ce-modal-body .section { margin-bottom: 2rem; }
.ce-modal-body .section:last-child { margin-bottom: 0.5rem; }
.ce-modal-body .sub-section { margin-bottom: 1.5rem; }

.modal-body .context-label {
  font-family: 'Unica One', sans-serif; font-size: 1rem; font-weight: 500;
  color: #104a3a; margin-bottom: 0.5rem; text-transform: uppercase; display: block;
}
.modal-body .content-block {
  background-color: #f8f9fa; border-left: 3px solid #dee2e6;
  padding: 0.75rem 1rem; margin-bottom: 1rem; color: #212529; line-height: 1.5;
}
.modal-body .content-block.italic { font-style: italic; }

.modal-footer { padding: 1rem 1.5rem; background-color: #f8f9fa; border-top: 1px solid #dee2e6; }

/* =================================================================== */
/* =========  22. SPECULATION ENVIRONMENT MODAL STYLING  =============== */
/* =================================================================== */

/* --- A. SHELL & LAYOUT --- */
.ce-app-shell {
    height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-color: #ffffff;
    border-radius: 0.5rem;
    border: 1px solid rgba(0,0,0,0.1);
}

/* Horizontal container for Main Content + Sidebar */
.ce-workspace-body {
    flex-grow: 1;
    display: flex;
    flex-direction: row; /* Split horizontally */
    padding: 0;
    overflow: hidden; /* Prevent scroll on container */
}

/* Left Column: Tabs + Views */
.ce-main-column {
    flex: 1; /* Takes up all available space */
    display: flex;
    flex-direction: column;
    min-width: 0; /* Crucial for text truncation inside flex items */
    position: relative;
}

/* Right Column: Fixed Sidebar */
.ai-sidebar { 
    width: 340px; /* Fixed width */
    flex-shrink: 0; /* Don't shrink */
    border-left: 1px solid #dee2e6; 
    background-color: #ffffff; 
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 24px rgba(0,0,0,0.02);
}

/* --- B. SCROLLING AREAS --- */
/* The actual scrollable area for the main views */
.ce-app-content {
    flex-grow: 1;
    overflow-y: auto; 
    background-color: #f8f9fa;
    display: flex;
    flex-direction: column;
}

/* The scrollable area inside the sidebar */
#ai-sidebar-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
}

.tab-content, .tab-pane { height: 100%; }

/* Custom Scrollbars */
.ce-app-content::-webkit-scrollbar,
#ai-sidebar-content::-webkit-scrollbar,
.scrolling-content-box::-webkit-scrollbar { 
    width: 6px; 
}
.ce-app-content::-webkit-scrollbar-track,
#ai-sidebar-content::-webkit-scrollbar-track,
.scrolling-content-box::-webkit-scrollbar-track { 
    background: transparent; 
}
.ce-app-content::-webkit-scrollbar-thumb,
#ai-sidebar-content::-webkit-scrollbar-thumb,
.scrolling-content-box::-webkit-scrollbar-thumb { 
    background-color: #cbd5e1; 
    border-radius: 10px; 
    border: 2px solid transparent; 
    background-clip: content-box;
}
.ce-app-content::-webkit-scrollbar-thumb:hover,
#ai-sidebar-content::-webkit-scrollbar-thumb:hover,
.scrolling-content-box::-webkit-scrollbar-thumb:hover { 
    background-color: #94a3b8; 
}

/* --- C. HEADER --- */
.ce-modal-header { 
    background-color: var(--phase-color); 
    color: white; 
    flex-shrink: 0; 
    border-bottom: none; 
    padding: 0.75rem 1.5rem; 
}
.ce-modal-header .node-icon {
    background-color: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(4px);
    border-radius: 8px;
    padding: 8px;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}
.ce-modal-header .node-icon i { 
    color: white; 
    font-size: 1.3rem; 
}
.ce-modal-header .modal-title.ce-title { 
    font-family: 'Unica One', sans-serif; 
    font-weight: 500; 
    font-size: 1.5rem; 
    letter-spacing: 0.02em;
    line-height: 1;
}
.ce-modal-header .phase-name { 
    font-size: 0.75rem; 
    text-transform: uppercase;
    font-family: 'Jost', sans-serif;
    letter-spacing: 0.05em;
    opacity: 0.9; 
}
.btn-header-action { 
    color: white; 
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    font-weight: 500; 
    font-size: 0.85rem; 
    padding: 0.4rem 0.8rem;
    transition: all 0.2s ease;
    border-radius: 6px;
}
.btn-header-action:hover { 
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
    color: white;
}
.btn-close { filter: invert(1) grayscale(100%) brightness(200%); opacity: 0.8; }
.btn-close:hover { opacity: 1; }

/* Progress Bar */
.progress-bar-container {
    padding: 0.75rem 1.5rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    flex-shrink: 0;
}
.progress-bar-container .progress-bar { background-color: var(--phase-color); }

/* --- D. TOP TAB NAVIGATION --- */
.ce-nav-tabs { 
    border-bottom: 1px solid #dee2e6; 
    padding: 0.5rem 1rem 0 1rem; 
    background-color: #ffffff; 
    flex-shrink: 0; 
}
.ce-nav-tabs .nav-link { 
    color: #64748b; 
    font-weight: 500; 
    font-size: 0.9rem;
    border: none;
    border-bottom: 3px solid transparent; 
    padding: 0.75rem 1.25rem; 
    transition: color 0.2s ease;
}
.ce-nav-tabs .nav-link:hover { color: #334155; background-color: #f8fafc; }
.ce-nav-tabs .nav-link.active { 
    border-bottom-color: var(--phase-color); 
    color: #0f172a; 
    background: transparent;
}

/* --- E. DASHBOARD & CARDS --- */
.overview-grid { align-items: start; }

/* Base Card Style */
.card {
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    background-color: #fff;
}

/* Context Cards */
.ai-context-card {
    background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);
    border-left: 4px solid var(--phase-color) !important;
}
.source-cos-card { 
    background-color: #ffffff;
    border: 1px dashed #cbd5e1;
}
.source-cos-card .ce-pill {
    font-style: normal;
    display: inline-flex;
    align-items: center;
    margin: 0 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Metric Cards */
.metric-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.metric-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
}

/* Text Areas */
.scrolling-content-box {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 6px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #334155;
}

/* --- F. DETAILS VIEW STYLES --- */
.details-form-container { max-width: 800px; margin: 0 auto; }
.btn-enhance-field { font-size: 0.75rem; padding: 0.2rem 0.6rem; }
#generate-all-details-btn { 
    background: linear-gradient(45deg, #6f42c1, #3b82f6); 
    border: none; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.1s ease;
}
#generate-all-details-btn:active { transform: scale(0.98); }

/* --- G. RESOURCES VIEW STYLES --- */
#resources-toolbar, #bulk-actions-bar { 
    background-color: #ffffff; 
    flex-shrink: 0; 
    border-bottom: 1px solid #dee2e6; 
    padding: 1rem; 
}
.btn-speculate { 
    background: linear-gradient(45deg, #6f42c1, #3b82f6); 
    border: none; 
    color: white; 
}
.btn-speculate:hover { color: white; opacity: 0.9; }
#resources-container { 
    background-color: #f8f9fa; 
    flex-grow: 1; 
    padding: 1rem;
}

.resource-card { 
    background-color: #fff; 
    border: 1px solid #e2e8f0; 
    border-radius: 0.5rem; 
    transition: all 0.2s ease; 
    cursor: pointer; 
    position: relative;
}
.resource-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border-color: #cbd5e1; 
}
.resource-card.selected { 
    border-left: 4px solid var(--phase-color); 
    background-color: #f8fafc; 
    border-color: #94a3b8;
}

/* Grid/List Toggles */
#resources-container.grid-view { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); 
    gap: 1rem; 
}
#resources-container.list-view .resource-card { margin-bottom: 0.5rem; }

.bg-primary-soft { background-color: rgba(13, 110, 253, 0.1); color: #0a58ca; }
.bg-secondary-soft { background-color: rgba(108, 117, 125, 0.1); color: #565e64; }

.resource-editor { background-color: #fff; }

/* --- H. FOOTER --- */
.ce-modal-footer { 
    background-color: #ffffff; 
    border-top: 1px solid #e2e8f0; 
    flex-shrink: 0; 
    padding: 0.75rem 1.5rem;
    box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);
}

/* ================================================== */
/* =======  23. Hidden Text Utility Class  =========== */
/* ================================================== */
.hidden-text { opacity: 0; }


/* ================================================== */
/* =======  24. CE Modal Specific Styles ============ */
/* ================================================== */
.ce-modal-body .section-heading {
    font-size: 1.4rem; color: #104a3a; text-shadow: none;
    border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem;
}
.ce-modal-body .form-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem 1.5rem; margin-bottom: 2rem;
}
.ce-modal-body .form-group label {
    display: block; margin-bottom: 0.4rem; font-family: 'Jost', sans-serif;
    font-weight: 500; font-size: 0.9rem; color: #343a40;
}
.ce-modal-body .action-row {
    margin-top: 1.5rem; margin-bottom: 1.5rem; display: flex;
    flex-wrap: wrap; gap: 0.75rem;
}

/* ================================================== */
/* =========  25. Goal Card Description Fix  ========= */
/* ================================================== */
.goal-description {
  text-align: left; /* Use left-align for natural word spacing and readability */
}

ğŸª store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

ğŸŸ¨ utilities.py:
# utilities.py

import logging
import json
import re
import uuid
from typing import Dict, List
from bs4 import BeautifulSoup

from flask import current_app

# Import AI services
from ai_service import generate_chat_response, get_grounded_data, generate_image

# Local Imports
from ce_nodes import NODES, get_valid_node_types
# Note: We delay import of models/store inside functions where necessary to avoid circular imports

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO)

# --- SSPEC Methodology Context ---
def get_sspec_scenario() -> str:
    return """
    The Structured Speculation (SSPEC) methodology is a structured approach to problem-solving.
    It involves defining a Structured Solution (SSOL), which is a high-level goal,
    broken into five phases: Discovery, Engagement, Action, Completion, and Legacy.
    Each phase contains Conditions of Satisfaction (COS), which are verifiable requirements.
    Each COS is further detailed by Conditional Elements (CEs) using specialized node types.
    """

# --- HELPER: CE Pill Rendering ---

def replace_ce_tags_with_pills(content):
    """
    Parses COS content, finds <ce> tags, and replaces them with interactive
    HTML pills. It performs a real-time lookup to check for associated resources
    and adds a visual count or 'new' indicator.
    """
    if not content:
        return ""

    # Delayed imports to avoid circular dependencies
    from app import USE_DATABASE
    from store import ce_store
    from models import CE, get_engine_and_session
    from uuid import UUID

    soup = BeautifulSoup(content, 'html.parser')
    ce_tags = soup.find_all('ce')

    for tag in ce_tags:
        ce_id_str = tag.get('id')
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        
        resource_count = 0
        
        # --- 1. Fetch Resource Count Safely ---
        try:
            if ce_id_str:
                if USE_DATABASE:
                    # Create a temporary, isolated session for this lookup
                    engine, SessionLocal = get_engine_and_session()
                    session = SessionLocal()
                    try:
                        # Verify UUID format before query
                        ce_uuid = UUID(ce_id_str)
                        ce_instance = session.query(CE).get(ce_uuid)
                        
                        if ce_instance and ce_instance.data:
                            # Access the JSON data
                            data_payload = ce_instance.data
                            # Handle case where data might be a string (SQLite edge cases) or dict
                            if isinstance(data_payload, str):
                                data_payload = json.loads(data_payload)
                                
                            resources = data_payload.get('resources', [])
                            resource_count = len(resources)
                    except Exception as db_err:
                        logging.warning(f"Error fetching CE count for {ce_id_str}: {db_err}")
                    finally:
                        session.close()
                else:
                    # Fallback to in-memory store
                    ce_data = ce_store.get(ce_id_str, {})
                    if ce_data and 'data' in ce_data:
                        resource_count = len(ce_data['data'].get('resources', []))
        except Exception as e:
            # Fail gracefully (display pill with 0 count) rather than crashing the page
            logging.error(f"Error in replace_ce_tags_with_pills: {e}")

        # --- 2. Build the New Pill HTML ---
        
        # Get node config for styling
        node_config = NODES.get(ce_type, NODES['Default'])
        node_color = node_config.get('color', '#6c757d')
        node_icon = node_config.get('icon', 'fa-solid fa-cube')

        # Main Container (Matches styles.css .ce-pill)
        # We set a CSS variable --node-color for the icon background
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-pill',
            'data-ce-id': ce_id_str,
            'data-ce-type': ce_type,
            'title': f"{ce_type} | Click to open",
            'style': f'--node-color: {node_color};' 
        })
        
        # A. Icon Section (White icon on colored background)
        icon_span = soup.new_tag('span', attrs={'class': 'ce-pill-icon'})
        i_tag = soup.new_tag('i', attrs={'class': node_icon})
        icon_span.append(i_tag)
        new_tag.append(icon_span)
        
        # B. Text Section
        text_span = soup.new_tag('span', attrs={'class': 'ce-pill-text'})
        text_span.string = ce_text
        new_tag.append(text_span)

        # C. Indicator Section (Count or "New" Dot)
        if resource_count > 0:
            # Gray pill with number
            count_badge = soup.new_tag('span', attrs={
                'class': 'badge bg-secondary ms-1 me-1 rounded-pill', 
                'style': 'font-size: 0.65em; opacity: 0.9; vertical-align: middle;'
            })
            count_badge.string = str(resource_count)
            new_tag.append(count_badge)
        else:
            # Small Green "New" Dot
            dot = soup.new_tag('span', attrs={
                'class': 'rounded-circle bg-success d-inline-block ms-1 me-1', 
                'style': 'width: 6px; height: 6px; vertical-align: middle;',
                'title': 'Ready for Speculation'
            })
            new_tag.append(dot)

        # Replace the original <ce> tag with our new structured span
        tag.replace_with(new_tag)

    return str(soup)


# --- GOAL SELECTION & INPUT ANALYSIS ---

async def generate_goal(user_input: str) -> List[Dict]:
    prompt = f"""Based on the user input '{user_input}', generate three distinct, high-level goal options. Each goal must be a JSON object with these exact keys: "domain", "title", "goal", "icon", "is_compliant". The "icon" must be a Font Awesome class. "is_compliant" must be a boolean."""
    system_instruction = "You are a JSON-only API. Your entire response MUST be a single, raw, valid JSON array of three objects."

    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="goal generation", system_instruction=system_instruction)
        ai_goals = json.loads(response_str)

        validated_goals = []
        for goal in ai_goals:
            if not isinstance(goal, dict): continue
            validated_goals.append({
                'domain': goal.get('domain', 'General'),
                'title': goal.get('title', 'Untitled Goal'),
                'goal': goal.get('goal', 'No description provided.'),
                'icon': goal.get('icon', 'fa-solid fa-question-circle'),
                'is_compliant': goal.get('is_compliant', goal.get('iscompliant', True))
            })
        return validated_goals
    except Exception as e:
        logging.error(f"Error in generate_goal: {e}", exc_info=True)
        return []

async def analyze_user_input(user_text: str) -> List[str]:
    prompt = f'Analyze the following text and extract 3-5 key themes or keywords. Text: "{user_text}". Return as a JSON object with a single key "keywords" containing an array of strings.'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="keyword extraction")
        result = json.loads(response_str)
        return result.get('keywords', [])
    except Exception as e:
        logging.error(f"Error in analyze_user_input: {e}", exc_info=True)
        return []

async def is_input_compliant(user_text: str) -> dict:
    prompt = f"""Analyze the following user input for compliance with safety and constructive use policies. Text: "{user_text}". Return a JSON object with two keys: "compliant" (boolean) and "reason"."""
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="compliance check")
        result = json.loads(response_str)
        return {"compliant": result.get('compliant', True), "reason": result.get('reason', '')}
    except Exception as e:
        logging.error(f"Error in is_input_compliant: {e}", exc_info=True)
        return {"compliant": False, "reason": "System error."}


# --- OUTCOME & CE GENERATION ---

async def generate_outcome_data(ssol_title, ssol_description, domain):
    node_types_str = ', '.join(get_valid_node_types())
    prompt = f"""
    Generate a structured solution for: '{ssol_title}' in domain '{domain}'.
    {get_sspec_scenario()}
    Response MUST be a single JSON object with keys: 'ssolsummary' (HTML string) and 'phases' (Object with 5 phase keys).
    Each phase contains an array of COS strings.
    Embed CEs in COS strings using <ce type="NodeType">CE text</ce>.
    NodeTypes: {node_types_str}.
    """
    messages = [{"role": "user", "content": prompt}]
    response_str = await generate_chat_response(messages, role="user", task="ssol generation", temperature=0.7)
    return json.loads(response_str)

async def generate_ai_data(node_type: str, cos_content: str, ssol_goal: str, agent_mode: str = 'context') -> dict:
    node_config = NODES.get(node_type, NODES['Default'])
    query_context = f"Overall Goal: '{ssol_goal}'. Requirement: '{cos_content}'."
    
    try:
        if agent_mode == 'speculate':
            # Use grounded search
            resource_keys = [f"'{f['key']}'" for f in node_config.get('resource_schema', [])]
            query = f"Find 3 diverse, real-world resources for a '{node_type}' element. Context: {query_context}. Extract: {', '.join(resource_keys)}."
            return await get_grounded_data(query, node_type)
        
        elif agent_mode == 'generate':
            # Generate details form content
            detail_fields = [f"'{f['name']}'" for f in node_config.get('details_schema', [])]
            prompt = f"As an expert, generate summary content for a {node_type} element. Context: {query_context}. Provide JSON for fields: {', '.join(detail_fields)}."
            messages = [{"role": "user", "content": prompt}]
            response_str = await generate_chat_response(messages, role="user", task="generate details")
            return json.loads(response_str)
            
        else: # Context mode
            prompt = f"Briefly explain the strategic purpose of this '{node_type}' element in the Context: {query_context}. Return JSON with key 'contextual_description'."
            messages = [{"role": "user", "content": prompt}]
            response_str = await generate_chat_response(messages, role="user", task="contextual insight")
            return json.loads(response_str)

    except Exception as e:
        logging.error(f"Error in generate_ai_data ({agent_mode}): {e}", exc_info=True)
        return {"error": str(e)}

ğŸŸª cos_table.js:
// cos_table.js (Refactored for Simplicity and Reliability)
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions (Unchanged) ---
function getBadgeClassFromStatus(status) {
    switch (status) {
        case 'Proposed': return 'bg-info';
        case 'In Progress': return 'bg-warning text-dark';
        case 'Completed': return 'bg-success';
        case 'Rejected': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State (Largely Unchanged) ---
function storeOriginalValues(cosRow) {
    const statusPill = cosRow.querySelector('.status-cell .status-pill');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountablePartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    const completionDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    cosRow.dataset.originalValues = JSON.stringify({
        status: statusPill ? statusPill.textContent.trim().toUpperCase() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountableParty: accountablePartyDisplay ? accountablePartyDisplay.textContent.trim() : '',
        completionDate: completionDateDisplay ? completionDateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        statusCell.innerHTML = `<span class="status-pill ${getBadgeClassFromStatus(original.status)}">${original.status}</span>`;
    }
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;
    const accPartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    if (accPartyDisplay) accPartyDisplay.textContent = original.accountableParty;
    const compDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    if (compDateDisplay) compDateDisplay.textContent = original.completionDate;
    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        statusCell.innerHTML = `<span class="status-pill ${getBadgeClassFromStatus(cosData.status)}">${cosData.status.toUpperCase()}</span>`;
    }
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;
    const accountablePartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    if (accountablePartyDisplay) accountablePartyDisplay.textContent = cosData.accountable_party || 'N/A';
    const completionDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    if (completionDateDisplay) completionDateDisplay.textContent = cosData.completion_date || 'N/A';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();
    const elementsToToggle = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];
    elementsToToggle.forEach(pair => {
        cosRow.querySelector(pair.display)?.classList.toggle('d-none', editing);
        cosRow.querySelector(pair.edit)?.classList.toggle('d-none', !editing);
    });

    const statusCell = cosRow.querySelector('.status-cell');
    const statusPill = statusCell.querySelector('.status-pill');
    const statusDropdown = statusCell.querySelector('select.status-edit-select');
    if (editing) {
        if (statusPill && !statusDropdown) {
            const currentStatus = statusPill.textContent.trim();
            statusPill.classList.add('d-none');
            statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentStatus));
        }
    } else {
        statusDropdown?.remove();
        statusPill?.classList.remove('d-none');
    }

    cosRow.querySelector('.edit-cos-button')?.classList.toggle('d-none', editing);
    cosRow.querySelector('.update-cos-button')?.classList.toggle('d-none', !editing);
    cosRow.querySelector('.cancel-cos-button')?.classList.toggle('d-none', !editing);
    cosRow.querySelector('.delete-cos-button')?.classList.toggle('d-none', editing);
    cosRow.querySelector('.analyze-cos-button')?.classList.toggle('d-none', editing);
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'In Progress', 'Completed', 'Rejected'];
    const optionsHtml = statuses.map(status =>
        `<option value="${status}"${status.toUpperCase() === selectedStatus.toUpperCase() ? ' selected' : ''}>${status}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select">${optionsHtml}</select>`;
}


// --- Event Handlers ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;
    
    const pill = target.closest('.ce-pill');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    const button = target.closest('button');
    if (button) {
        const cosRow = button.closest('.cos-row');
        if (!cosRow) return;
        
        event.preventDefault();
        const cosId = cosRow.dataset.cosId;

        if (button.classList.contains('edit-cos-button')) {
            handleEditCOS(cosRow);
        } else if (button.classList.contains('update-cos-button')) {
            handleUpdateCOS(cosRow, cosId);
        } else if (button.classList.contains('cancel-cos-button')) {
            revertToOriginalValues(cosRow);
        } else if (button.classList.contains('delete-cos-button')) {
            handleDeleteCOS(cosRow, cosId);
        } else if (button.classList.contains('analyze-cos-button')) {
            handleAnalyzeCOS(button, cosRow, cosId);
        }
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);
    
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const contentTextarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && contentTextarea) {
        contentTextarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }
    
    const accPartyDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const accPartyEditInput = cosRow.querySelector('.cos-accountable-party-edit');
    if (accPartyDisplay && accPartyEditInput) {
        accPartyEditInput.value = accPartyDisplay.textContent.trim() === 'N/A' ? '' : accPartyDisplay.textContent.trim();
    }
    
    const compDateDisplay = cosRow.querySelector('.cos-completion-date-display');
    const compDateEditInput = cosRow.querySelector('.cos-completion-date-edit');
    if (compDateDisplay && compDateEditInput) {
        compDateEditInput.value = compDateDisplay.textContent.trim() === 'N/A' ? '' : compDateDisplay.textContent.trim();
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountableParty = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim() || '';
    const newCompletionDate = cosRow.querySelector('.cos-completion-date-edit')?.value || '';
    const payload = { content: newContent, status: newStatus, accountable_party: newAccountableParty, completion_date: newCompletionDate };

    const updateButton = cosRow.querySelector('.update-cos-button');
    const originalButtonHtml = updateButton.innerHTML;
    updateButton.disabled = true;
    updateButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error(data.error || 'Update failed to return COS data.');
        }
    })
    .catch(error => {
        console.error('Error updating COS:', error);
        alert(`Error: ${error.message}`);
    })
    .finally(() => {
        updateButton.disabled = false;
        updateButton.innerHTML = originalButtonHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (confirm('Are you sure you want to delete this Condition of Satisfaction?')) {
        fetch(`/delete_cos/${cosId}`, {
            method: 'DELETE',
            headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(handleApiResponse)
        .then(data => {
            if (data.success) {
                cosRow.remove();
            } else {
                throw new Error(data.error || 'Deletion failed.');
            }
        })
        .catch(error => {
            console.error('Error deleting COS:', error);
            alert(`Error: ${error.message}`);
        });
    }
}

function handleAnalyzeCOS(analyzeButton, cosRow, cosId) {
    const originalButtonHtml = analyzeButton.innerHTML;
    analyzeButton.disabled = true;
    analyzeButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    fetch(`/analyze_cos/${cosId}`, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.analysis_results?.content_with_ce) {
            const contentDisplay = cosRow.querySelector('.cos-content-display');
            if (contentDisplay) {
                contentDisplay.innerHTML = data.analysis_results.content_with_ce;
            }
        } else {
            throw new Error(data.message || 'Analysis failed to return expected results.');
        }
    })
    .catch(error => {
        console.error('Error analyzing COS:', error);
        alert(`Analysis Failed: ${error.message}`);
    })
    .finally(() => {
        analyzeButton.disabled = false;
        analyzeButton.innerHTML = originalButtonHtml;
    });
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    const accordionBody = button.closest('.accordion-body');
    const ssolId = accordionBody?.dataset.ssolId;
    if (!ssolId) {
        alert('Cannot add COS: Critical data missing.');
        return;
    }

    const payload = { content: 'New Condition of Satisfaction - edit me!', status: 'Proposed', ssol_id: ssolId };
    button.disabled = true;
    const originalButtonText = button.innerHTML;
    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Adding...`;

    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            let tbody = accordionBody.querySelector('table.phase-table tbody');
            if (!tbody) {
                const phaseNameIdentifier = button.dataset.phase;
                const newTableHtml = `
                    <table class="table table-striped table-hover phase-table" id="${phaseNameIdentifier}-table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 10%;">Status</th>
                                <th scope="col" style="width: 40%;">Condition of Satisfaction</th>
                                <th scope="col" style="width: 15%;">Accountable Party</th>
                                <th scope="col" style="width: 15%;">Completion Date</th>
                                <th scope="col" class="text-end actions-header" style="width: 20%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>`;
                accordionBody.querySelector('p')?.remove();
                accordionBody.insertAdjacentHTML('afterbegin', newTableHtml);
                tbody = accordionBody.querySelector('tbody');
            }
            const newRow = createCosTableRow(data.cos);
            tbody.appendChild(newRow);
        } else {
            throw new Error(data.error || 'Failed to create COS.');
        }
    })
    .catch(error => {
        console.error('Error creating COS:', error);
        alert(`Error: ${error.message}`);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalButtonText;
    });
}

function createCosTableRow(cos) {
    const newRow = document.createElement('tr');
    newRow.className = 'cos-row';
    newRow.dataset.cosId = cos.id;
    newRow.dataset.editing = 'false';
    const cosContentHtml = cos.content || '';
    const cosContentText = stripHtmlForTextarea(cosContentHtml);

    newRow.innerHTML = `
        <td class="status-cell align-middle">
            <span class="status-pill ${getBadgeClassFromStatus(cos.status)}">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell align-middle">
            <div class="cos-content-display">${cosContentHtml}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm cos-content-textarea" rows="3">${cosContentText}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell align-middle">
            <span class="cos-accountable-party-display">${cos.accountable_party || 'N/A'}</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="${cos.accountable_party || ''}">
        </td>
        <td class="cos-completion-date-cell align-middle">
            <span class="cos-completion-date-display">${cos.completion_date || 'N/A'}</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="${cos.completion_date || ''}">
        </td>
        <td class="text-end actions-cell align-middle">
            <div class="btn-group cos-actions" role="group">
                <button class="btn btn-sm btn-primary edit-cos-button" title="Edit COS"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-success update-cos-button d-none" title="Update COS"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button d-none" title="Cancel Edit"><i class="fas fa-times"></i></button>
                <button class="btn btn-sm btn-danger delete-cos-button" title="Delete COS"><i class="fas fa-trash"></i></button>
                <button class="btn btn-sm btn-info analyze-cos-button" data-cos-id="${cos.id}" title="Analyze COS"><i class="fas fa-search-plus"></i></button>
            </div>
        </td>
    `;
    return newRow;
}


/**
 * Handles the click event on a CE pill. Gathers context and calls displayCEModal.
 * This is now a simple "launcher" for the Node Application.
 * @param {HTMLElement} pill - The CE pill element that was clicked.
 */
function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    const ceText = pill.querySelector('.ce-pill-text')?.textContent.trim() || 'Conditional Element';

    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cogs';
    showLoadingSpinner(`Analyzing ${ceType} Element...`, iconClass);

    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.querySelector('#ssol-goal')?.textContent.trim() || "SSOL Goal Not Available";
    const cosContextContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || 'COS content not found.';
    const accordionItem = cosRow?.closest('.accordion-item');
    const phaseName = accordionItem?.querySelector('.accordion-header .accordion-button')?.textContent.trim().replace(/\s*PHASE\s*$/i, "").trim() || "Unknown Phase";
    const phaseIndex = accordionItem ? Array.from(accordionItem.parentElement.children).indexOf(accordionItem) : 0;

    const payload = { 
        ce_id: ceId, 
        ce_text: ceText,
        cos_content: cosContextContent, 
        phase_name: phaseName, 
        phase_index: phaseIndex, 
        ssol_goal: ssolGoal 
    };

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) return response.json().then(err => { throw new Error(err.error) });
        return response.json();
    })
    .then(data => {
        if (data.modal_html && data.ce_data) {
            // Pass control to the main application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        } else {
            throw new Error(data.error || 'Server response was missing required data.');
        }
    })
    .catch(error => {
        console.error('Error fetching or displaying CE modal:', error);
        alert(`Could not load application. Error: ${error.message}`);
    })
    .finally(() => {
        hideLoadingSpinner();
    });
}

function triggerPdfExport(ssolId) {
    const printableElement = document.documentElement.cloneNode(true);
    const selectorsToRemove = [
        'script', '.cos-actions', '.add-cos', '#save-as-pdf-button',
        '.modal', '#dynamicModalContainer', '.cos-content-edit',
        '.cos-accountable-party-edit', '.cos-completion-date-edit',
        'select.status-edit-select', '#image-error-container'
    ];
    printableElement.querySelectorAll(selectorsToRemove.join(', ')).forEach(el => el.remove());
    printableElement.querySelectorAll('.accordion-collapse').forEach(collapse => collapse.classList.add('show'));
    printableElement.querySelectorAll('.accordion-button').forEach(button => button.classList.remove('collapsed'));
    printableElement.querySelectorAll('img').forEach(img => {
        if (img.src && !img.src.startsWith('http') && !img.src.startsWith('data:')) {
            try {
                img.src = new URL(img.getAttribute('src'), window.location.href).href;
            } catch (e) { console.warn("Could not convert image src to absolute URL:", img.src, e); }
        }
    });
    const htmlContent = printableElement.outerHTML;
    const pdfButton = document.getElementById('save-as-pdf-button');
    const originalButtonHtml = pdfButton.innerHTML;
    pdfButton.disabled = true;
    pdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    fetch(`/save_as_pdf/${ssolId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ htmlContent: htmlContent })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || `PDF generation failed.`); });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SSPEC_Solution_${ssolId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Error saving PDF:', error);
        alert(`PDF Export Error: ${error.message}`);
    })
    .finally(() => {
        pdfButton.disabled = false;
        pdfButton.innerHTML = originalButtonHtml;
    });
}

// --- Global Initialization ---
function initializePageEventListeners() {
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.removeEventListener('click', handlePhaseTableBodyClick);
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    document.querySelectorAll('.add-cos').forEach(button => {
        button.removeEventListener('click', handleAddCOSButtonClick);
        button.addEventListener('click', handleAddCOSButtonClick);
    });

    const savePdfButton = document.getElementById('save-as-pdf-button');
    savePdfButton?.addEventListener('click', (event) => {
        event.preventDefault();
        triggerPdfExport(savePdfButton.dataset.ssolId);
    });
}

document.addEventListener('DOMContentLoaded', initializePageEventListeners);
