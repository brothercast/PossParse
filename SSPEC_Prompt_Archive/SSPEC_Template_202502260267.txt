‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC Build Metadata (v202502260267)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
As a senior developer, I've analyzed the changes for version `202502260267` across `styles.css` and `goal_selection.js`. This release represents a significant overhaul of the user interface and interaction model, particularly around goal selection and configuration. The changes are deeply integrated, indicating a strong move towards a highly visual, interactive, and state-driven application experience, aligning with a "prototype visuals + wizard" approach.

Here's a summary of the key technical changes:

*   **Comprehensive Design System Implementation:**
    *   **New Typography System:** Introduced semantic font tokens (`--font-brand`, `--font-retro`, `--font-script`, `--font-data`, `--font-body`) and extensively re-mapped them across the UI (e.g., `h1`, `h4`, `btn`, `nav-link`), establishing a consistent and expressive typographic hierarchy.
    *   **Expanded Color Palette:** Added new brand colors (`--aviation-teal`, `--deep-space-blue`, `--retro-coral`), functional colors, and a `--phase-X` color system (Discovery, Engagement, Action, Completion, Legacy) to enrich the visual language and enable dynamic theming.
    *   **Fluid Responsive Design:** Leveraged `clamp()` extensively for font sizes, spacing, and border-radii (`--font-size-base`, `--spacing-fluid`, `--radius-fluid`) to ensure dynamic and accessible responsiveness across various screen sizes.
*   **Advanced Interactive UI for Goal Selection & Configuration:**
    *   **3D Card-Flipping State Machine:** Implemented a sophisticated CSS/JS state machine (the "Sacred Diagonal Flip") for goal cards, managing complex 3D animations for `DEALING`, `SELECTION`, `CONFIG`, and `RETURNING` phases. This involves advanced CSS `transform-style: preserve-3d`, `backface-visibility`, `transform-origin`, and `rotate3d` properties, orchestrating the card's visual states.
    *   **Dynamic Card Morphing & Docking:** When a goal card is selected, it undergoes a precise morphing animation, transitioning from its grid position to a docked sidebar (the "Hero Card") on the left. This is achieved through absolute positioning, dynamic size/position updates via JavaScript, and CSS transitions.
    *   **Staggered Entrance & Dimming:** Goal cards now enter the view with a staggered slide-up and fade-in animation, enhancing visual appeal. Unselected cards are dynamically dimmed (`state-dimmed`) during the configuration phase to focus user attention.
*   **Integrated Configuration Wizard:**
    *   **Dedicated Wizard Panel:** A new, animated slide-in wizard panel (`.split-col-right`) appears from the right when a goal is selected, guiding the user through a multi-step configuration process.
    *   **Wizard Step Management:** JavaScript manages the wizard's steps (`State.wizardStep`, `WIZARD_STEPS` data structure), including progress indicators, back/next navigation, and dynamic content rendering for each step.
    *   **Rich Input Components:** Introduced custom-styled input components for identity selection (`.wizard-identity-pill` with icons and checkmarks), date inputs, and select inputs, enhancing user interaction.
    *   **Contextual Hints:** Implemented dynamic `CONTEXT_HINTS` that provide relevant information and implications based on user selections (e.g., identity type), improving decision-making.
*   **Dynamic Theming and Branding:**
    *   **Goal-Specific Color Palettes:** The system now extracts and applies comprehensive goal-specific color data (hue, gradient, accent, icon colors, phase colors) from backend-provided data (`window.GOAL_COLOR_DATA`) to dynamically theme the selected goal's UI elements, including the Hero Card and wizard components.
    *   **Dynamic Color Generation:** New JavaScript utility functions (`hsvToHex`, `getHarmonizedPillColor`) allow for programmatic generation of harmonized colors based on a goal's primary hue, ensuring visual consistency across dynamically created UI elements like system pills.
*   **Enhanced Background and Loading Visuals:**
    *   **Aurora Background:** A new, dynamic ambient background effect (`.aurora-background`) has been added, featuring SVG noise, blurred, animated blobs using the `--phase-X` colors, creating a "Horizon Fusion" aesthetic.
    *   **Advanced Loading Spinner:** A custom, visually rich loading spinner (`.loading-spinner-overlay`, `.la-ball-atom`) with complex CSS animations (`phase-swirl`, `shimmer`, atomic rotations) and text wipe-in/out effects provides a more engaging user feedback mechanism during data loading.
*   **Heuristic-Based Identity Suggestion:**
    *   A new `window.suggestIdentity()` function uses keyword matching against goal descriptions to proactively suggest an appropriate `IDENTITY_TYPE` within the wizard, improving user experience and initial setup speed.
*   **Refactored Modal and Dashboard Elements:**
    *   Significant styling updates and new components have been introduced for the speculation modal (`.ce-app-shell`, micro-timeline) and dashboard elements (`.system-hero-card`, `.metric-tile`, collection cards), aligning them with the new "Horizon Fusion" aesthetic and interaction patterns.
*   **New Component Architecture & Utility Classes:**
    *   Numerous new CSS classes for specific components (e.g., `.console-housing`, `.masthead-brand`, `.ce-capsule`, `.sys-highlight`, `.metric-tile`) and utility classes (`.hover-lift`, `.hover-scale`, `.hover-white`) have been added to standardize common interactions and visual patterns across the application.
    *   The `State` object in `goal_selection.js` centralizes complex UI state management, crucial for coordinating the intricate animations and user interactions.

This version introduces a highly interactive and visually rich user experience, underpinned by a robust design system and a complex state machine for UI flow control. The emphasis on dynamic theming, fluid responsiveness, and advanced animations suggests a focus on modern, engaging user interfaces.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SSPEC PossPath Essential Files
Date: 2026-01-03
Version: 202502260267
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üåê Structured Speculation Possibility Pathfinder ("SSPEC PossPath")

üìÅ Included Files:
 * üß© system_templates.py
 * üü™ cos_table.js
 * ‚¨ú speculate.py
 * üè≥Ô∏è‚Äçüåà ce_nodes.py
 * üü• routes.py
 * üÉè system_cards.py
 * üé® styles.css
 * üìÜ models.py
 * üü© goal_selection.html
 * üüß ai_service.py
 * üì± app.py
 * üîÆ system_nodes.js
 * üü® utilities.py
 * üü¶ outcome.html
 * üéØ goal_selection.js
 * üß© ce_templates.py
 * üè™ store.py
 * üè≥Ô∏è‚Äçüåà system_nodes.py
 * üîµ system_cards.js
 * üîµ ce_cards.js

üß© system_templates.py:
# system_templates.py
from flask import render_template_string
from system_nodes import SYSTEM_NODES
import datetime

# ==============================================================================
# 1. HORIZON GAUGE (Strict Single-Line Layout)
# ==============================================================================
# ==============================================================================
# 1. HORIZON GAUGE (Strict Single-Line Layout)
# ==============================================================================
HORIZON_GAUGE_TEMPLATE = """
<div class="card border-0 shadow-sm mb-4 overflow-visible system-node-card cursor-pointer group"
     onclick="openSystemEditor('{{ id }}', 'HORIZON', '{{ value }}')"
     title="Click to Calibrate Horizon">
    
    <!-- Main Container: Forced Flex Row with Inline Overrides -->
    <div class="d-flex align-items-stretch flex-nowrap w-100" 
         style="height: 80px; display: flex !important; flex-direction: row !important; overflow: visible;">
        
        <!-- COL 1: ICON STRIP (Strict Fixed Width) -->
        <div class="bg-warning bg-opacity-10 d-flex align-items-center justify-content-center border-end" 
             style="width: 72px; min-width: 72px; flex: 0 0 72px;">
            <i class="{{ icon }} fa-lg text-warning group-hover:scale-110 transition-transform"></i>
        </div>
        
        <!-- COL 2: TIMELINE DATA (Fluid Middle) -->
        <div class="position-relative d-flex align-items-center justify-content-between gap-3 px-4" 
             style="flex: 1 1 auto; min-width: 0; overflow: visible;">
            
            <!-- Origin Date -->
            <div class="text-nowrap">
                <div class="font-data text-muted x-small tracking-widest opacity-75 mb-1">ORIGIN</div>
                <div class="font-body fw-bold text-dark small">{{ start_date }}</div>
            </div>

            <!-- The Bar (Takes all remaining space) -->
            <div class="progress rounded-pill flex-grow-1 position-relative mx-3" style="height: 6px; background-color: #f1f5f9; overflow: visible;">
                
                <!-- Fill -->
                <div class="progress-bar rounded-pill position-relative" role="progressbar" 
                     style="width: {{ time_elapsed_percent }}%; background-color: {{ health_color }}; box-shadow: 0 2px 10px {{ health_color }}60;" 
                     aria-valuenow="{{ time_elapsed_percent }}" aria-valuemin="0" aria-valuemax="100">
                     
                     <!-- Current Head Marker -->
                     <div class="position-absolute top-50 translate-middle" style="right: -12px;">
                        <div class="bg-white border border-2 rounded-circle shadow-sm" 
                             style="width: 14px; height: 14px; border-color: {{ health_color }};"></div>
                        
                        <!-- THE PHASE INDICATOR (Floating Badge) -->
                        <div class="position-absolute bottom-100 start-50 translate-middle-x mb-2 text-nowrap" style="z-index: 10;">
                            <span class="badge bg-dark text-white border font-data x-small rounded-pill px-2 shadow-sm py-1">
                                <i class="fas fa-map-marker-alt text-warning me-1"></i> DISCOVERY
                            </span>
                        </div>
                     </div>
                </div>

                <!-- Milestones -->
                <div class="position-absolute top-50 start-20 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 20%;"></div>
                <div class="position-absolute top-50 start-40 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 40%;"></div>
                <div class="position-absolute top-50 start-60 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 60%;"></div>
                <div class="position-absolute top-50 start-80 translate-middle rounded-circle bg-white border border-secondary-subtle" style="width: 6px; height: 6px; left: 80%;"></div>
            </div>

            <!-- Target Date -->
            <div class="text-end text-nowrap">
                <div class="font-data text-muted x-small tracking-widest opacity-75 mb-1">REALIZATION</div>
                <div class="font-body fw-bold text-dark small">{{ target_date_display }}</div>
            </div>
        </div>

        <!-- COL 3: COUNTDOWN (Strict Fixed Width) -->
        <div class="border-start bg-light d-flex flex-column align-items-center justify-content-center" 
             style="width: 100px; min-width: 100px; flex: 0 0 100px;">
            <div class="font-data text-muted x-small tracking-widest mb-1">WINDOW</div>
            <div class="font-brand text-dark fs-3 lh-1">{{ days_remaining }}</div>
            <div class="font-data text-muted x-small mt-1 opacity-75">DAYS</div>
        </div>

    </div>
</div>
"""

# ==============================================================================
# 2. SIDEBAR STACK (The "System Anchors" / Left Column)
# ==============================================================================
SYSTEM_SIDEBAR_STACK_TEMPLATE = """
<div class="d-flex flex-column mt-4" id="system-anchor-stack">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3 px-1">
        <span class="font-data text-muted small tracking-widest">STRATEGIC ANCHORS</span>
        <i class="far fa-question-circle text-muted opacity-50 cursor-pointer" title="System Configuration" style="font-size:0.8rem;"></i>
    </div>
    
    <!-- Cards -->
    {% for param in system_params %}
    <div class="system-anchor-card" 
         style="--sys-color: {{ param.color }};"
         onclick="openSystemEditor('{{ param.id }}', '{{ param.type }}', '{{ param.value }}')">
        
        <!-- Icon -->
        <div class="sys-icon-circle">
            <i class="{{ param.icon }}"></i>
        </div>
        
        <!-- Content -->
        <div class="sys-meta-col">
            <div class="sys-label">
                {{ param.label }}
                {% if param.status == 'SUGGESTED' or loop.index == 1 %}
                <span class="badge-suggested ms-2"><i class="fas fa-sparkles"></i> SUGGESTED</span>
                {% endif %}
            </div>
            <span class="sys-value">{{ param.value }}</span>
        </div>
    </div>
    {% endfor %}

    <!-- Add Button -->
    <button class="btn btn-outline-secondary border-dashed w-100 rounded-pill font-data small py-2 mt-2"
            onclick="openSystemEditor('new', '', '')">
        <i class="fas fa-plus me-2"></i> ADD PARAMETER
    </button>
</div>
"""

# ==============================================================================
# 3. CAROUSEL MODAL (The "Calibration Wizard")
# ==============================================================================
SYSTEM_EDITOR_MODAL_TEMPLATE = """
<div class="modal fade" id="systemConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 rounded-4 shadow-2xl overflow-visible">
            
            <!-- Nav Arrows -->
            <div class="sys-nav-arrow sys-nav-prev" onclick="navigateSystemNode(-1)"><i class="fas fa-chevron-left fa-lg"></i></div>
            <div class="sys-nav-arrow sys-nav-next" onclick="navigateSystemNode(1)"><i class="fas fa-chevron-right fa-lg"></i></div>

            <div class="row g-0" style="min-height: 600px;">
                
                <!-- LEFT: Identity & State (Visualizer) -->
                <div class="col-md-5 sys-modal-left p-5" id="sys-identity-panel" style="background-color: #333; transition: background-color 0.5s;">
                    <div class="sys-modal-texture"></div>
                    
                    <div class="position-relative z-1 h-100 d-flex flex-column justify-content-between">
                        <!-- Header -->
                        <div>
                            <div class="bg-white bg-opacity-25 rounded-3 d-flex align-items-center justify-content-center mb-4 shadow-sm backdrop-blur" 
                                 style="width: 64px; height: 64px;">
                                <i class="fas fa-cube fa-2x text-white" id="sys-display-icon"></i>
                            </div>
                            <h2 class="font-brand text-white display-6 mb-2" id="sys-display-label">LOADING...</h2>
                            <div class="font-data text-white-50 small letter-spacing-2 mb-5">SYSTEM NODE CONFIGURATION</div>
                        </div>

                        <!-- THE STATE MONITOR (Bespoke Visualizer) -->
                        <div class="flex-grow-1 d-flex flex-column justify-content-center">
                             <div class="font-data text-white-50 x-small tracking-widest mb-2">CURRENT STATE VECTOR</div>
                             <!-- JS populates this based on node type (Stack vs Gauge vs Pill) -->
                             <div id="sys-visualizer-container" class="w-100"></div>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-end mt-4">
                            <div class="font-data text-white-50 small" id="sys-counter">CARD 1 / X</div>
                            <div class="sys-pagination" id="sys-dots-container"></div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Ontology & Config (The Context) -->
                <div class="col-md-7 bg-white p-5 d-flex flex-column">
                    
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                        <div class="font-data text-muted small tracking-widest">
                            <i class="fas fa-sliders-h me-2"></i> CALIBRATION CONSOLE
                        </div>
                        <div class="d-flex gap-2">
                             <span class="badge bg-light text-muted border font-data rounded-pill px-3" id="sys-status-badge">PENDING</span>
                        </div>
                    </div>
                    
                    <!-- Scrollable Area -->
                    <div class="flex-grow-1 overflow-y-auto pe-2 custom-scrollbar d-flex flex-column gap-4">
                        
                        <!-- 1. DEFINITION CARD (Context) -->
                        <div class="bg-light rounded-3 p-4 border border-light-subtle">
                             <div class="d-flex gap-3">
                                <div class="mt-1"><i class="fas fa-info-circle text-primary"></i></div>
                                <div>
                                    <h6 class="font-data text-dark small mb-1">ONTOLOGICAL DEFINITION</h6>
                                    <p class="font-body text-secondary small mb-2" id="sys-display-desc" style="line-height: 1.5;">Description...</p>
                                    <div class="mt-2 pt-2 border-top border-light-subtle">
                                        <span class="font-data x-small text-muted uppercase me-1">Tip:</span>
                                        <span class="font-body x-small text-muted fst-italic" id="sys-display-guide">...</span>
                                    </div>
                                    <!-- Examples Container (New) -->
                                    <div id="sys-examples-container" class="d-flex flex-wrap gap-2 mt-3 pt-2 border-top border-dashed"></div>
                                </div>
                             </div>
                        </div>

                        <!-- 2. PROTOCOL TOGGLE -->
                        <div class="sys-protocol-toggle">
                            <button type="button" class="sys-protocol-btn active" id="mode-specify" onclick="setProtocolMode('SPECIFY')">
                                <i class="fas fa-pen-to-square me-2"></i> Specify
                            </button>
                            <button type="button" class="sys-protocol-btn" id="mode-speculate" onclick="setProtocolMode('SPECULATE')">
                                <i class="fas fa-wand-magic-sparkles me-2"></i> Speculate
                            </button>
                        </div>

                        <!-- 3. ACTIVE INPUT AREA (Bespoke) -->
                        <form id="system-node-form">
                            <input type="hidden" name="param_id" id="sys-param-id">
                            <input type="hidden" name="sys_type" id="sys-param-type">
                            <!-- JS Injects the correct inputs here -->
                            <div id="sys-input-container" class="mb-4"></div>
                            
                            <!-- 4. CONFIGURATION (Hard/Soft) -->
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all selected-mode-card h-100" 
                                         id="constraint-hard" onclick="setConstraintMode('HARD')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-lock me-2 text-primary"></i> HARD CONSTRAINT</div>
                                        <div class="text-muted x-small">Strict adherence.</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded-3 p-3 cursor-pointer hover-shadow transition-all opacity-50 h-100" 
                                         id="constraint-soft" onclick="setConstraintMode('SOFT')">
                                        <div class="font-data small text-dark mb-1"><i class="fas fa-unlock me-2"></i> SOFT GUIDELINE</div>
                                        <div class="text-muted x-small">Trade-offs permitted.</div>
                                    </div>
                                </div>
                                <input type="hidden" name="constraint_mode" id="sys-constraint-input" value="HARD">
                            </div>

                            <!-- Rationale -->
                            <div>
                                <label class="font-data text-muted x-small mb-1">RATIONALE</label>
                                <textarea name="rationale" id="sys-rationale" class="form-control bg-light border-0 small" rows="2" placeholder="Why is this constraint set?"></textarea>
                            </div>
                        </form>

                    </div>
                    
                    <!-- Footer -->
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-light rounded-pill font-data px-4" data-bs-dismiss="modal">CANCEL</button>
                        <button type="button" class="btn btn-primary rounded-pill font-data px-5 shadow-lg" onclick="submitSystemForm()">
                            <i class="fas fa-save me-2"></i> COMMIT ANCHOR
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
"""


# ==============================================================================
# 4. RENDER FUNCTIONS
# ==============================================================================

def render_command_deck(system_params):
    """
    Orchestrates the Command Deck.
    Splits Horizon (Time) from the Anchors (Identity/Physics).
    """
    horizon_node = next((p for p in system_params if p['type'] == 'HORIZON'), None)
    other_params = [p for p in system_params if p['type'] != 'HORIZON']

    # Enrich generic params with Icon/Color from SYSTEM_NODES
    enriched_params = []
    for p in other_params:
        config = SYSTEM_NODES.get(p['type'], SYSTEM_NODES['OPERATOR'])
        enriched_params.append({
            **p,
            "icon": config['icon'],
            "color": config['color'],
            "label": config['label']
        })

    html_payload = {
        'horizon_html': "",
        'sidebar_html': ""
    }
    
    # 1. Render Horizon
    if horizon_node:
        import datetime
        # Logic: In real app, fetch creation_date from DB. For MVP, assume -7 days start.
        start_date = (datetime.date.today() - datetime.timedelta(days=7))
        val = horizon_node.get('value')
        
        # Display Logic
        target_display = val or "Unset"
        percent = 15 # Default MVP visual
        days_rem_str = "--" # Default
        
        # Try parsing date for real math
        try:
            if val and '-' in val:
                target_date = datetime.datetime.strptime(val, '%Y-%m-%d').date()
                total_days = (target_date - start_date).days
                days_left = (target_date - datetime.date.today()).days
                if total_days > 0:
                    percent = 100 - int((days_left / total_days) * 100)
                # Cap percentage between 0 and 100 for visual sanity
                percent = max(0, min(100, percent))
                days_rem_str = str(days_left)
                target_display = target_date.strftime('%b %d, %Y')
        except:
            pass

        # Color Logic based on health/time
        if percent > 90: health = "#ef5350" # Red
        elif percent > 75: health = "#ffa726" # Amber
        else: health = "#26c6da" # Teal

        html_payload['horizon_html'] = render_template_string(HORIZON_GAUGE_TEMPLATE, 
            start_date=start_date.strftime('%b %d, %Y'), 
            target_date_display=target_display,
            time_elapsed_percent=percent, 
            health_color=health,
            days_remaining=days_rem_str,
            value=val,
            id=horizon_node.get('id'),
            icon=SYSTEM_NODES['HORIZON']['icon']
        )
    
    # 2. Render Sidebar
    html_payload['sidebar_html'] = render_template_string(SYSTEM_SIDEBAR_STACK_TEMPLATE, system_params=enriched_params)
    
    return html_payload

def render_system_config_modal():
    return render_template_string(SYSTEM_EDITOR_MODAL_TEMPLATE, nodes=SYSTEM_NODES)

üü™ cos_table.js:
// cos_table.js
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions ---

function getBadgeColorVar(status) {
    switch (status) {
        case 'Proposed': return '#17a2b8'; // Info cyan
        case 'Active': return 'var(--warning)';
        case 'In Progress': return 'var(--warning)';
        case 'Completed': return 'var(--success)';
        case 'Verified': return 'var(--success)';
        case 'Rejected': return 'var(--danger)';
        default: return '#94a3b8'; // Muted gray
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State ---

function storeOriginalValues(cosRow) {
    const statusBlock = cosRow.querySelector('.status-cell .status-block');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountableDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');

    cosRow.dataset.originalValues = JSON.stringify({
        status: statusBlock ? statusBlock.textContent.trim() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountable: accountableDisplay ? accountableDisplay.textContent.trim() : '',
        date: dateDisplay ? dateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);

    // Revert Status
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(original.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${original.status}</span>`;
    }

    // Revert Content
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;

    // Revert Meta
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = original.accountable;
    
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = original.date;

    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    // 1. Update Status Block
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(cosData.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${cosData.status.toUpperCase()}</span>`;
    }

    // 2. Update Content (with potential new Pills)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;

    // 3. Update Fields
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = cosData.accountable_party || 'N/A';

    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = cosData.completion_date || 'TBD';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();

    // Toggle visibility classes
    // Using Bootstrap .d-none utilities
    const elements = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];

    elements.forEach(pair => {
        const disp = cosRow.querySelector(pair.display);
        const edit = cosRow.querySelector(pair.edit);
        if (disp) disp.classList.toggle('d-none', editing);
        if (edit) edit.classList.toggle('d-none', !editing);
    });

    // Toggle Status Dropdown
    const statusCell = cosRow.querySelector('.status-cell');
    const currentBlock = statusCell.querySelector('.status-block');
    
    if (editing) {
        if (currentBlock) {
            const currentVal = currentBlock.textContent.trim();
            currentBlock.classList.add('d-none');
            if(!statusCell.querySelector('select')) {
                statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentVal));
            }
        }
    } else {
        const select = statusCell.querySelector('select');
        if (select) select.remove();
        if (currentBlock) currentBlock.classList.remove('d-none');
    }

    // Toggle Action Buttons
    const viewBtns = cosRow.querySelector('.actions-cell .btn-group:not(.d-none)');
    const editBtns = cosRow.querySelector('.actions-cell .btn-group.d-none');
    
    // This logic handles the swapping of button groups defined in outcome.html
    const actionsCell = cosRow.querySelector('.actions-cell');
    const groups = actionsCell.querySelectorAll('.btn-group');
    
    if (groups.length >= 2) {
        // Group 0 is View actions, Group 1 is Edit actions
        groups[0].classList.toggle('d-none', editing);
        groups[1].classList.toggle('d-none', !editing);
    }
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'Active', 'Completed', 'Verified', 'Rejected'];
    const options = statuses.map(s => 
        `<option value="${s}" ${s.toUpperCase() === selectedStatus.toUpperCase() ? 'selected' : ''}>${s.toUpperCase()}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select shadow-none border-secondary">${options}</select>`;
}

// --- EVENT HANDLERS ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;

    // 1. CE Pill Click (Launch Modal)
    const pill = target.closest('.ce-pill, .ce-capsule');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    // 2. Action Buttons
    const button = target.closest('button');
    if (!button) return;

    const cosRow = button.closest('.cos-row');
    if (!cosRow) return;

    event.preventDefault();
    const cosId = cosRow.dataset.cosId;

    if (button.classList.contains('edit-cos-button')) {
        handleEditCOS(cosRow);
    } else if (button.classList.contains('update-cos-button')) {
        handleUpdateCOS(cosRow, cosId);
    } else if (button.classList.contains('cancel-cos-button')) {
        revertToOriginalValues(cosRow);
    } else if (button.classList.contains('delete-cos-button')) {
        handleDeleteCOS(cosRow, cosId);
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);

    // Pre-populate textarea (strip existing HTML/Pills for editing)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const textarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && textarea) {
        textarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    // Gather Data
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountable = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim();
    const newDate = cosRow.querySelector('.cos-completion-date-edit')?.value;

    // UI Feedback
    const btn = cosRow.querySelector('.update-cos-button');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            content: newContent, 
            status: newStatus, 
            accountable_party: newAccountable, 
            completion_date: newDate 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error('Failed to return COS data');
        }
    })
    .catch(err => alert(err.message))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = origHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (!confirm('Are you sure? This will delete the Condition and all its internal logic nodes.')) return;

    fetch(`/delete_cos/${cosId}`, { method: 'DELETE' })
    .then(handleApiResponse)
    .then(() => cosRow.remove())
    .catch(err => alert(err.message));
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    
    // 1. Locate Context
    const container = button.closest('.phase-table-container');
    if (!container) return console.error("Phase container not found.");
    
    const ssolId = container.dataset.ssolId;
    if (!ssolId) return alert("System Error: SSOL Context Missing.");

    // 2. Visual Feedback (Loading State)
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-circle-notch fa-spin me-2"></i> INITIALIZING...`;

    // 3. Construct Payload
    const payload = {
        // Default placeholder text inviting definition
        content: "New Condition of Satisfaction - Click edit to define parameters.",
        status: "Proposed",
        ssol_id: ssolId
    };

    // 4. Network Request
    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse) // Expects standard helper
    .then(data => {
        if (data.success && data.cos) {
            // 5. Inject into DOM
            const table = container.querySelector('table.retro-table');
            const newRowHtml = createRowHTML(data.cos); // Generate Row HTML

            if (table) {
                // SCENARIO A: Table exists, append row
                const tbody = table.querySelector('tbody');
                tbody.insertAdjacentHTML('beforeend', newRowHtml);
            } else {
                // SCENARIO B: Empty State (No table yet)
                // We must remove the "No protocols" placeholder and build the table skeleton
                const emptyState = container.querySelector('.text-center.text-muted');
                if(emptyState) emptyState.remove();

                // The wrapper for the table needs to go BEFORE the button footer
                // Note: outcome.html structure puts button in a div.p-3 at bottom of container
                const tableSkeleton = `
                    <table class="table table-hover mb-0 align-middle retro-table">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 110px;">Status</th>
                                <th>Condition of Satisfaction</th>
                                <th style="width: 18%;">Accountable</th>
                                <th style="width: 12%;">Target</th>
                                <th class="text-end pe-4" style="width: 100px;">Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${newRowHtml}
                        </tbody>
                    </table>
                `;
                
                // Insert as first element in the body (pushing the footer down)
                container.insertAdjacentHTML('afterbegin', tableSkeleton);
            }
        }
    })
    .catch(err => {
        console.error("COS Creation Failed:", err);
        alert("Failed to initialize new Condition. Check console.");
    })
    .finally(() => {
        // 6. Restore Button State
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}


// --- HTML Generator for New Rows (Matches outcome.html structure) ---
function createRowHTML(cos) {
    return `
    <tr class="cos-row" data-cos-id="${cos.id}" data-editing="false">
        <td class="status-cell">
            <span class="status-block" style="background-color: #17a2b8;">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell">
            <div class="cos-content-display">${cos.content}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm">${stripHtmlForTextarea(cos.content)}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell">
            <span class="cos-accountable-party-display">N/A</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none">
        </td>
        <td class="cos-completion-date-cell font-data">
            <span class="cos-completion-date-display">TBD</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none">
        </td>
        <td class="text-end actions-cell">
            <div class="btn-group cos-actions">
                <button class="btn btn-sm btn-link text-muted edit-cos-button"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-cos-button"><i class="fas fa-trash"></i></button>
            </div>
            <div class="btn-group cos-actions d-none">
                <button class="btn btn-sm btn-success update-cos-button"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button"><i class="fas fa-times"></i></button>
            </div>
        </td>
    </tr>`;
}

// --- MAIN: Launch the CE Modal Application ---

export function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    
    // Safe access to NODES using window object (injected in base.html)
    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cube';
    
    showLoadingSpinner(`INITIALIZING ${ceType.toUpperCase()} NODE...`, iconClass);

    // Scrape context for the modal initialization
    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.getElementById('ssol-goal')?.textContent.trim() || "Goal";
    const cosContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || '';
    
    const accItem = cosRow?.closest('.accordion-item');
    const phaseText = accItem?.querySelector('.phase-title')?.textContent.trim() || "Unknown";
    
    // Calculate phase index based on DOM order
    const allItems = Array.from(document.querySelectorAll('.accordion-item'));
    const phaseIndex = accItem ? allItems.indexOf(accItem) : 0;

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            ce_id: ceId, 
            cos_content: cosContent, 
            phase_name: phaseText,
            phase_index: phaseIndex,
            ssol_goal: ssolGoal 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if(data.modal_html) {
            // Launch the full application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        }
    })
    .catch(err => {
        console.error(err);
        alert("System Error: Could not load node application.");
    })
    .finally(() => hideLoadingSpinner());
}

// --- GLOBAL LISTENERS ---

document.addEventListener('DOMContentLoaded', () => {
    // Table Actions (Delegated)
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    // Add COS Buttons
    document.querySelectorAll('.add-cos').forEach(btn => {
        btn.addEventListener('click', handleAddCOSButtonClick);
    });

    // PDF Export
    const pdfBtn = document.getElementById('save-as-pdf-button');
    if(pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
            // e.target.dataset.ssolId might need bubbling check if icon clicked
            const id = e.currentTarget.dataset.ssolId;
            // Call PDF function (omitted for brevity, assume similar to existing)
            alert("Generating PDF report...");
        });
    }
});

‚¨ú speculate.py:
# speculate.py
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from difflib import get_close_matches  # <--- CRITICAL IMPORT ADDED HERE

# Local Imports
from ce_nodes import NODES, get_valid_node_types
from ai_service import generate_chat_response_with_node_types
from datetime import date, timedelta

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def normalize_ce_type(raw_type: str) -> str:
    """
    Uses fuzzy matching to correct common AI hallucinations.
    Example: 'Risk Analysis' -> 'Risk', 'Stakeholder Map' -> 'Stakeholder'
    """
    if not raw_type: return 'Default'
    
    # 1. Exact Match (Case Insensitive)
    valid_types = list(NODES.keys())
    key_map = {k.lower(): k for k in valid_types}
    if raw_type.lower() in key_map:
        return key_map[raw_type.lower()]
    
    # 2. Fuzzy Match
    matches = get_close_matches(raw_type, valid_types, n=1, cutoff=0.5)
    if matches:
        # Use a safe logger if outside app context, otherwise current_app
        if current_app:
            current_app.logger.info(f"Normalized Node Type: '{raw_type}' -> '{matches[0]}'")
        return matches[0]
        
    # 3. Fallback
    if current_app:
        current_app.logger.warning(f"Unknown Node Type '{raw_type}' defaulted.")
    return 'Default'

def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """
    Generates the Horizon-Style CE Capsule HTML.
    Handles case-insensitive lookup and fallbacks via normalization.
    """
    # Normalize the type first
    real_key = normalize_ce_type(ce_type)
    
    node_info = NODES.get(real_key, NODES['Default'])
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-cube')
    
    # Fallback Color Generator (for hallucinations that couldn't be normalized but still exist)
    if real_key == 'Default' and ce_type.lower() != 'default':
        hash_val = sum(ord(c) for c in ce_type)
        colors = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#009688', '#ff5722']
        node_color = colors[hash_val % len(colors)]
        node_icon = 'fa-solid fa-tag'
    
    return (
        f'<span class="ce-capsule" data-ce-id="{ce_id}" data-ce-type="{real_key}" '
        f'title="{real_key} Node" style="--node-color: {node_color};">'
        f'<i class="{node_icon}"></i>{html.escape(ce_text)}'
        f'</span>'
    )

# --- AI Analysis ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content to identify CEs. Returns structured JSON for creation/updating.
    """
    node_types_str = ', '.join(get_valid_node_types())
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify ALL distinct Conditional Elements (CEs) within this text. "
        f"Valid NodeTypes: {node_types_str}. "
        "Return JSON with keys 'analyzed_cos_text' (original text with <ce type='Type'>Title</ce> tags) "
        "and 'identified_ces' (array of {text, type})."
    )
    messages = [{"role": "user", "content": prompt}]
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS')
        # Parse logic
        match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", response_text, re.DOTALL)
        clean_text = match.group(1).strip() if match else response_text.strip()
        
        response_json = json.loads(clean_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}", exc_info=True)
        # Fallback: return original text, no CEs detected
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

# --- SSOL Operations ---

def create_ssol(USE_DATABASE: bool, title: str, description: str, domain: str = None) -> str:
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    # MVP Rule: Set a default "Horizon" of 1 year from creation
    default_target_date = date.today() + timedelta(days=365)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            
            ssol = SSOL(
                id=new_ssol_uuid, 
                title=title, 
                description=description,
                domain=domain,
                status='Active', 
                target_date=default_target_date,
                integrity_score=100,
                completion_percentage=0
            )
            
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {
            'id': ssol_id, 
            'title': title, 
            'description': description, 
            'domain': domain,
            'status': 'Active',
            'target_date': default_target_date.isoformat(),
            'integrity_score': 100,
            'completion_percentage': 0,
            'phases': {}
        }
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    return ssol_store.get(str(ssol_id))

# --- COS Operations ---

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> dict:
    from models import COS, CE, get_engine_and_session
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    if isinstance(content, dict):
        content = content.get('text') or content.get('content') or json.dumps(content)
    elif not isinstance(content, str):
        content = str(content)

    try:
        # 1. Parse & Pill Logic
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        new_ce_instances = []
        
        for tag in ce_tags:
            ce_text = tag.string
            raw_type = tag.get('type', 'Default')
            if not ce_text: continue

            # NORMALIZE TYPE HERE
            real_type = normalize_ce_type(raw_type)

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': real_type, # Use Normalized Type
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "prerequisites": [], "stakeholders": [], "assumptions": [], "resources": [], "connections": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace with Horizon HTML
            pill_html = _render_ce_pill_html(str(new_ce_uuid), real_type, ce_text)
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        content_with_pills = str(soup)

        # 2. Persist & Return Data
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos_instance = COS(
                    id=new_cos_uuid, 
                    content=content_with_pills, 
                    status=status, 
                    ssol_id=ssol_id,
                    accountable_party=accountable_party, 
                    completion_date=completion_date
                )
                session.add(cos_instance)
                
                for ce_rec in new_ce_instances:
                    ce_instance = CE(
                        id=ce_rec['id'], 
                        node_type=ce_rec['node_type'], 
                        cos_id=new_cos_uuid, 
                        data=ce_rec['data']
                    )
                    session.add(ce_instance)
                
                session.commit()
                final_data = cos_instance.to_dict()
                session.close()
                return final_data
        else:
            result = {
                'id': cos_id_str, 
                'content': content_with_pills, 
                'status': status, 
                'ssol_id': str(ssol_id),
                'accountable_party': accountable_party,
                'completion_date': completion_date
            }
            cos_store[cos_id_str] = result
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
            return result

    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        raise
    
async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from app import app

    new_content = updated_data.get('content')
    
    try:
        new_ce_instances = []
        
        if new_content is not None:
            if isinstance(new_content, dict): new_content = json.dumps(new_content)
            elif not isinstance(new_content, str): new_content = str(new_content)
                    
            analysis = await analyze_cos(new_content, str(cos_id))
            soup = BeautifulSoup(analysis['content_with_tags'], 'html.parser')
            ce_tags = soup.find_all('ce')
            
            for tag in ce_tags:
                c_txt = tag.string
                raw_type = tag.get('type', 'Default')
                real_type = normalize_ce_type(raw_type) # Normalize

                new_id = uuid.uuid4()
                new_ce_instances.append({
                    'id': new_id, 'node_type': real_type, 
                    'data': {"details_data": {}, "resources": [], "prerequisites": [], "stakeholders": [], "assumptions": [], "connections": []}
                })
                pill = _render_ce_pill_html(str(new_id), real_type, c_txt)
                tag.replace_with(BeautifulSoup(pill, 'html.parser'))
            
            updated_data['content'] = str(soup)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id)
                if not cos: 
                    session.close()
                    return {'success': False, 'message': 'COS not found', 'status_code': 404}
                
                for k, v in updated_data.items():
                    if hasattr(cos, k) and k not in ['id', 'ssol_id']: 
                        setattr(cos, k, v)
                
                if new_content is not None:
                    session.query(CE).filter_by(cos_id=cos_id).delete()
                    for nc in new_ce_instances:
                        session.add(CE(id=nc['id'], node_type=nc['node_type'], cos_id=cos_id, data=nc['data']))
                
                session.commit()
                cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': cos_dict, 'status_code': 200}
        
        return {'success': False, 'message': 'DB Required', 'status_code': 500}

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return {'success': False, 'message': str(e), 'status_code': 500}


def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            res = cos.to_dict() if cos else None
            session.close()
            return res
    return cos_store.get(str(cos_id))

def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(cos_id=cos_id).delete()
            cos = session.query(COS).get(cos_id)
            if cos:
                session.delete(cos)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

# --- CE Operations ---

def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id_param if isinstance(ce_id_param, UUID) else UUID(str(ce_id_param))
    
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            result = ce.to_dict() if ce else None
            session.close()
            return result
    return ce_store.get(str(ce_id_uuid))

def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id)
            if ce:
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from app import app
    new_id = uuid.uuid4()
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.add(CE(id=new_id, node_type=node_type, cos_id=cos_id, data=data))
            session.commit()
            session.close()
    return str(new_id)

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(id=ce_id).delete()
            session.commit()
            session.close()
            return True
    return False

üè≥Ô∏è‚Äçüåà ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST (v2026 - Engine Compatible)
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It couples 'Smart Schemas' (for the UI) with 'Strategic Prompts' (for the AI).

PROMPT VARIABLES:
- {cos_text}: The text of the source Condition of Satisfaction.
- {field}: The specific field being enhanced (e.g., "Executive Summary", "Objective").
- {node_type}: The type of the node (e.g., "Research", "Risk").

NOTE: Double braces {{ }} are used to escape JSON structure examples in Python f-strings.
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Generalist)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are a sub-routine of the SPECULATE Engine.
                TASK: Write a concise, professional '{field}' for a '{node_type}' element needed to achieve the specific Condition: '{cos_text}'.
                CONSTRAINT: Strictly adhere to the System Physics (Budget, Operator, Horizon) provided in the context.
                OUTPUT: JSON {{ "text": "Your text here." }}
            """,
            "prerequisites": "Analyze '{cos_text}'. Considering the System Constraints, what 3 precursors are physically required? Return JSON array: [{{\"title\": \"Prereq\", \"status\": \"Pending\"}}]",
            "stakeholders": "Who is involved in '{cos_text}'? Ensure they match the OPERATOR context (e.g. Grassroots vs Corp). Return JSON array: [{{\"name\": \"Name/Role\", \"role\": \"Description\"}}]",
            "assumptions": "What are we assuming about '{cos_text}'? Return JSON array: [{{\"hypothesis\": \"Assumption...\", \"risk\": \"Medium\"}}]",
            "resources": "Suggest 3 resources for '{cos_text}' compatible with the BUDGET context. Return JSON array: [{{\"title\": \"Resource Name\", \"url\": \"#\"}}]"
        }
    },

    # ==============================================================================
    # 2. RESEARCH (The Scientist)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink
        "details_schema": [
            {"key": "research_question", "label": "Primary Research Question", "type": "textarea", "rows": 2},
            {"key": "summary", "label": "Executive Synthesis", "type": "textarea", "rows": 6}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Paper/Source Title", "type": "text"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset"]},
            {"key": "url", "label": "Source URL", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Research Module of the SPECULATE Engine.
                TASK: Define the epistemic requirements for: '{cos_text}'. Write the '{field}'.
                ATTENUATION: Ensure the scope of research fits the HORIZON constraint.
                OUTPUT: JSON {{ "text": "Your research text here." }}
            """,
            "prerequisites": """
                To answer the research question implied by: '{cos_text}', what data is required?
                Return JSON array: [{{\"data_req\": \"Specific Dataset\", \"access_status\": \"Unknown\"}}]
            """,
            "stakeholders": """
                Suggest 3 types of SMEs needed for: '{cos_text}'.
                Return JSON array: [{{\"name\": \"Role Title\", \"expertise\": \"Academic Field\"}}]
            """,
            "assumptions": """
                What theoretical assumptions are we making in '{cos_text}'?
                Return JSON array: [{{\"premise\": \"Theory...\", \"validation_method\": \"Lit Review\"}}]
            """,
            "resources": """
                Find 3 relevant papers/sources for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Paper Title\", \"type\": \"Paper\", \"url\": \"https://scholar.google.com/\"}}]
            """
        }
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text"},
            {"key": "confidence", "label": "Confidence (0-100)", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "tool_name", "label": "Mitigation Tool", "type": "text"},
            {"key": "cost", "label": "Est. Cost", "type": "currency"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Risk Assessment Module.
                TASK: Write a '{field}' analysis for: '{cos_text}'.
                ATTENUATION: Consider the AVOIDANCE constraint provided in the system physics.
                OUTPUT: JSON {{ "text": "Your analysis here." }}
            """,
            "prerequisites": """
                For the risk scenario in '{cos_text}', what indicators must be monitored?
                Return JSON array: [{{\"indicator\": \"Metric to watch\", \"threshold\": \"Value\"}}]
            """,
            "stakeholders": """
                Who owns the risk associated with '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Role\", \"impacted_group\": \"Population\"}}]
            """,
            "assumptions": """
                What 'safety assumptions' are we making about '{cos_text}' that could be false?
                Return JSON array: [{{\"mitigation_theory\": \"We assume...\", \"confidence\": 50}}]
            """,
            "resources": """
                Suggest 3 mitigation frameworks/tools for: '{cos_text}'.
                Return JSON array: [{{\"tool_name\": \"Framework Name\", \"cost\": \"0\"}}]
            """
        }
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Diplomat)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text"},
            {"key": "material_needs", "label": "Materials Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Document", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Diplomacy Module.
                TASK: Write a '{field}' strategy for: '{cos_text}'.
                ATTENUATION: Adjust tone and targets based on the SCALE and OPERATOR constraints (e.g. Grassroots vs. Global).
                OUTPUT: JSON {{ "text": "Your strategy here." }}
            """,
            "prerequisites": """
                To engage stakeholders for '{cos_text}', what materials are prerequisites?
                Return JSON array: [{{\"intro_path\": \"Via Industry Group\", \"material_needs\": \"Pitch Deck\"}}]
            """,
            "stakeholders": """
                Who are the key decision makers for: '{cos_text}'?
                Return JSON array: [{{\"name\": \"Role/Title\", \"influence\": 80, \"stance\": \"Neutral\"}}]
            """,
            "assumptions": """
                Why do we think these stakeholders will align with '{cos_text}'?
                Return JSON array: [{{\"incentive_theory\": \"They benefit by...\", \"validated\": false}}]
            """,
            "resources": """
                What agreements are standard for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Contract\", \"status\": \"Draft\"}}]
            """
        }
    },

    # ==============================================================================
    # 5. PRAXIS (The Operator)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Est", "type": "text"},
            {"key": "resource_avail", "label": "Resources Available?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "instructions", "label": "SOP/Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Operations Module.
                TASK: Write a '{field}' plan for: '{cos_text}'.
                ATTENUATION: Ensure the logistical complexity fits the BUDGET and OPERATOR constraints.
                OUTPUT: JSON {{ "text": "Your plan here." }}
            """,
            "prerequisites": """
                What must physically exist before '{cos_text}' can start?
                Return JSON array: [{{\"dependency\": \"Task X Complete\", \"status\": \"Blocked\"}}]
            """,
            "stakeholders": """
                Who executes and who approves: '{cos_text}'?
                Return JSON array: [{{\"executor\": \"Role\", \"approver\": \"Manager/Client\"}}]
            """,
            "assumptions": """
                What are the time/resource assumptions for '{cos_text}'?
                Return JSON array: [{{\"time_est\": \"2 Weeks\", \"resource_avail\": true}}]
            """,
            "resources": """
                What tools or SOPs are needed for: '{cos_text}'?
                Return JSON array: [{{\"tool\": \"Tool Name\", \"instructions\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Ecologist)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulation", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Community", "type": "text"},
            {"key": "regulator", "label": "Regulator", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Systems Ecology Module.
                TASK: Write a '{field}' assessment for: '{cos_text}'.
                ATTENUATION: Align impact assessment with the SCALE and DIRECTIVE (Ethics) constraints.
                OUTPUT: JSON {{ "text": "Your assessment here." }}
            """,
            "prerequisites": """
                What regulatory permits or baselines are required for: '{cos_text}'?
                Return JSON array: [{{\"permit\": \"Permit Type\", \"baseline_data\": \"Survey Needed\"}}]
            """,
            "stakeholders": """
                Which communities or regulators gatekeep: '{cos_text}'?
                Return JSON array: [{{\"community\": \"Local Group\", \"regulator\": \"Agency\"}}]
            """,
            "assumptions": """
                What external trends are we assuming hold stable for '{cos_text}'?
                Return JSON array: [{{\"trend\": \"Trend Description\", \"stability\": 60}}]
            """,
            "resources": """
                Find impact studies relevant to: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Report Title\", \"url\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 7. TIMELINE (The Scheduler)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "slack_analysis", "label": "Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors", "type": "text"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "date", "label": "Target Date", "type": "date"}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Temporal Logistics Module.
                TASK: Write a '{field}' description for: '{cos_text}'.
                ATTENUATION: Critical! Ensure all lead times fit strictly within the HORIZON date provided.
                OUTPUT: JSON {{ "text": "Your analysis here." }}
            """,
            "prerequisites": """
                What events must happen *before* '{cos_text}'?
                Return JSON array: [{{\"event\": \"Precursor Event\", \"lead_time\": \"2 Weeks\"}}]
            """,
            "stakeholders": """
                Who is responsible for the schedule of: '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Project Manager / Role\"}}]
            """,
            "assumptions": """
                What assumptions about speed/delays affect '{cos_text}'?
                Return JSON array: [{{\"velocity\": \"Standard Pace\", \"external_factors\": \"Weather/Shipping\"}}]
            """,
            "resources": """
                Suggest key calendar deadlines for: '{cos_text}'.
                Return JSON array: [{{\"event\": \"Milestone Name\", \"date\": \"2025-01-01\"}}]
            """
        }
    },

    # ==============================================================================
    # 8. ADVOCACY (The Campaigner)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action", "type": "text"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset", "type": "text"},
            {"key": "platform", "label": "Platform Ready?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience", "type": "text"},
            {"key": "influencer", "label": "Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Post", "Video", "Article"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Campaign Strategy Module.
                TASK: Write a compelling '{field}' for: '{cos_text}'.
                ATTENUATION: Adjust the narrative voice to match the OPERATOR and DIRECTIVE (Ethics) constraints.
                OUTPUT: JSON {{ "text": "Your narrative here." }}
            """,
            "prerequisites": """
                What assets must be ready before advocating for '{cos_text}'?
                Return JSON array: [{{\"asset\": \"Video/Graphics\", \"platform\": false}}]
            """,
            "stakeholders": """
                Who is the target audience for '{cos_text}'?
                Return JSON array: [{{\"audience\": \"Demographic\", \"influencer\": \"Personality/Org\"}}]
            """,
            "assumptions": """
                What are we assuming the public feels about '{cos_text}'?
                Return JSON array: [{{\"sentiment\": \"Positive/Skeptical\", \"resonance\": 70}}]
            """,
            "resources": """
                Suggest 3 content media types for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Viral Video Concept\", \"type\": \"Video\"}}]
            """
        }
    },

    # ==============================================================================
    # 9. COLLABORATION (The Connector)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual"]}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                IDENTITY: You are the Partnership Module.
                TASK: Write a '{field}' regarding the alliance for: '{cos_text}'.
                ATTENUATION: Ensure governance models fit the OPERATOR type (e.g. DAO vs Corp).
                OUTPUT: JSON {{ "text": "Your strategy here." }}
            """,
            "prerequisites": """
                What legal safeguards are needed before collaborating on '{cos_text}'?
                Return JSON array: [{{\"intro\": true, \"nda\": true}}]
            """,
            "stakeholders": """
                Identify potential partner organizations for: '{cos_text}'.
                Return JSON array: [{{\"partner_org\": \"Org Name\", \"poc\": \"Title/Role\"}}]
            """,
            "assumptions": """
                Why do we assume these partners want to work on '{cos_text}'?
                Return JSON array: [{{\"alignment\": \"Strategic Fit...\", \"resource_sharing\": 80}}]
            """,
            "resources": """
                What governance documents are required for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Teaming Agreement\", \"status\": \"Drafting\"}}]
            """
        }
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

üü• routes.py:
# routes.py
import os
import json
import uuid
import logging
import asyncio
import pdfkit
from uuid import UUID
from datetime import date, timedelta, datetime
from dotenv import load_dotenv
from bs4 import BeautifulSoup
from werkzeug.exceptions import BadRequest, NotFound
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory

# --- App Context ---
from app import USE_DATABASE

# --- Data Models & Config ---
from models import get_engine_and_session, SSOL, COS
from ce_nodes import NODES
from system_nodes import SYSTEM_NODES
from system_templates import (
    render_command_deck, 
    render_system_config_modal
)

# --- Service Layers ---
from ai_service import cleanup_gemini_client, generate_chat_response
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, generate_image, \
                    format_ssol_text

# --- Speculation Operations ---
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol

# --- Template Generators ---
from ce_templates import generate_dynamic_modal

load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# ==============================================================================
# 1. LIFECYCLE MANAGEMENT
# ==============================================================================

@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up AI resources after each request."""
    await cleanup_gemini_client()

# ==============================================================================
# 2. BASIC NAVIGATION & UTILITIES
# ==============================================================================

@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

@routes_bp.route('/')
def index():
    return render_template('input.html')

@routes_bp.route('/about')
def about():
    return render_template('about.html')

@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    text = request.form.get('user_text')
    if not text:
        return jsonify({'error': 'No text provided'}), 400
    
    return jsonify({
        'keywords': await analyze_user_input(text), 
        'compliance': await is_input_compliant(text)
    })

# ==============================================================================
# 3. GOAL SELECTION
# ==============================================================================

@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            current_app.logger.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)

            if not goal_options:
                flash("Could not generate goal options. Please try again.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            current_app.logger.error(f"Error in goal_selection: {e}", exc_info=True)
            flash(f"An error occurred: {e}", "error")
            return render_template('input.html', user_text=user_input)
    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 4. OUTCOME GENERATION (The Bootstrapper)
# ==============================================================================

@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        # 1. EXTRACT FORM DATA
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        if not selected_goal_text:
            flash("No goal selected. Please try again.", "error")
            return redirect(url_for('routes_bp.index'))
            
        try:
            current_app.logger.info(f"Initializing Outcome for: {selected_goal_title}")

            # ------------------------------------------------------------------
            # 2. GENERATE INTELLIGENCE (Structure + System Nodes)
            # ------------------------------------------------------------------
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, 
                ssol_description=selected_goal_text, 
                domain=domain
            )
            
            raw_summary = structured_solution_json.get('ssolsummary', 'Analysis pending...')
            # Apply Formatting (Magic Parsing for System Tags)
            ssol_summary = format_ssol_text(raw_summary)
            
            ai_system_params = structured_solution_json.get('system_params', {})

            # ------------------------------------------------------------------
            # 3. CREATE SSOL CONTAINER
            # ------------------------------------------------------------------
            ssol_id_str = speculate_create_ssol(
                USE_DATABASE, 
                selected_goal_title, 
                selected_goal_text, 
                domain=domain
            )
            ssol_id_uuid = UUID(ssol_id_str)

            # ------------------------------------------------------------------
            # 4. BOOTSTRAP SYSTEM NODES (DB Save)
            # ------------------------------------------------------------------
            if USE_DATABASE:
                engine, session = get_engine_and_session()
                try:
                    ssol_obj = session.query(SSOL).get(ssol_id_uuid)
                    if ssol_obj:
                        ssol_obj.system_data = ai_system_params
                        if 'OPERATOR' in ai_system_params:
                            ssol_obj.owner = ai_system_params['OPERATOR']
                        session.commit()
                        current_app.logger.info("Saved inferred System Nodes to DB.")
                except Exception as db_e:
                    current_app.logger.error(f"Failed to save System Data: {db_e}")
                finally:
                    session.close()

            # ------------------------------------------------------------------
            # 5. CREATE PHASES & CONDITIONS (Refactored for Reliability)
            # ------------------------------------------------------------------
            phases_for_template = {}
            
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    phases_for_template[phase_name] = []
                    
                    for cos_content_with_tags in cos_items:
                        if not cos_content_with_tags: continue
                            
                        try:
                            # CREATE AND GET DATA IN ONE SHOT
                            cos_data = await speculate_create_cos(
                                USE_DATABASE, 
                                ssol_id=ssol_id_uuid, 
                                content=cos_content_with_tags, 
                                status='Proposed'
                            )
                            
                            if cos_data:
                                phases_for_template[phase_name].append(cos_data)
                            else:
                                current_app.logger.warning(f"COS creation returned empty data for phase {phase_name}")
                                    
                        except Exception as cos_err:
                            current_app.logger.error(f"Error generating COS: {cos_err}")

            # ------------------------------------------------------------------
            # 6. RENDER COMMAND DECK UI (Visuals)
            # ------------------------------------------------------------------
            # We build the master list, then pass it to the single render function.
            deck_params_list = []
            
            # A. Prepare Horizon (Default 1 year)
            import datetime
            default_horizon = (datetime.date.today() + datetime.timedelta(days=365)).strftime('%Y-%m-%d')
            deck_params_list.append({
                'type': 'HORIZON', 
                'id': f'horizon_{ssol_id_str}', 
                'value': default_horizon 
            })
            
            # B. Prepare System Anchors
            for key, val in ai_system_params.items():
                if key in SYSTEM_NODES and key != 'HORIZON':
                    deck_params_list.append({
                        'type': key,
                        'id': f'sys_{key}_{str(uuid.uuid4())[:8]}',
                        'value': val
                    })

            # C. Render Components
            # render_command_deck returns {'horizon_html': ..., 'sidebar_html': ...}
            components = render_command_deck(deck_params_list) 
            
            gauge_html = components['horizon_html']
            pills_html = components['sidebar_html']
            
            config_modal = render_system_config_modal()

            # ------------------------------------------------------------------
            # 7. ASYNC IMAGE GENERATION
            # ------------------------------------------------------------------
            try:
                image_prompt = f"""
                A vibrant, isometric, mid-century retro illustration of '{selected_goal_title}: {selected_goal_text}' 
                fulfilled. Style: 1950s Popular Science magazine cover meets Nary Blair.
                Characteristics: 
                Saturated technicolor palette (#ff7043;- Coral, #26c6da- Cyan, #ab47bc- Purple, #ffa726;- Amber, #66bd0e - Green), 
                painterly lithograph texture,
                idealized realism, optimistic composition. No text.
                """
                await generate_image(image_prompt, ssol_id_str)
            except Exception as e:
                current_app.logger.warning(f"Image gen trigger failed: {e}")

            # ------------------------------------------------------------------
            # 8. FINAL RENDER
            # ------------------------------------------------------------------
            outcome_data = {
                'ssol_id': ssol_id_str,
                'ssol_title': selected_goal_title,
                'selected_goal': selected_goal_text,
                'domain': domain,
                'domain_icon': domain_icon,
                'ssol_summary': ssol_summary,
                'phases': phases_for_template
            }

            return render_template(
                'outcome.html', 
                ssol=outcome_data, 
                nodes=NODES, 
                ssol_id=ssol_id_str,
                horizon_gauge_html=gauge_html,
                system_pills_html=pills_html,
                system_config_modal_html=config_modal
            )

        except Exception as e:
            current_app.logger.error(f"CRITICAL error in /outcome: {e}", exc_info=True)
            flash(f"System Critical Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    return redirect(url_for('routes_bp.index'))

# ==============================================================================
# 5. INTELLIGENCE & CONFIG
# ==============================================================================
@routes_bp.route('/update_ssol_system_node', methods=['POST'])
def update_ssol_system_node():
    """
    Updates a specific System Parameter (Anchor) for an SSOL.
    Handles distinct logic for Core columns (Horizon/Owner) vs. JSON Metadata.
    """
    data = request.get_json()
    ssol_id = data.get('ssol_id')
    key = data.get('key')   # e.g., 'BUDGET', 'HORIZON', 'OPERATOR'
    value = data.get('value') # The new value

    # 1. Input Validation
    if not ssol_id or not key:
        return jsonify({'success': False, 'error': 'Missing SSOL ID or Node Key'}), 400

    engine, session = get_engine_and_session()
    
    try:
        # 2. Fetch SSOL Container
        ssol = session.query(SSOL).get(UUID(ssol_id))
        if not ssol:
            return jsonify({'success': False, 'error': 'SSOL not found'}), 404

        # 3. Node-Specific Logic
        
        # --- A. HORIZON (Time) ---
        # Maps to the SQL 'target_date' column for sorting/filtering
        if key == 'HORIZON':
            try:
                # Attempt to parse standard HTML date format YYYY-MM-DD
                from datetime import datetime
                dt = datetime.strptime(value, '%Y-%m-%d').date()
                ssol.target_date = dt
                
                # Also store in JSON for prompt injection consistency
                current_data = dict(ssol.system_data or {})
                current_data['HORIZON'] = value
                ssol.system_data = current_data
                
            except (ValueError, TypeError):
                # If user entered fuzzy text (e.g., "Q4 2025"), store in JSON only
                current_data = dict(ssol.system_data or {})
                current_data['HORIZON'] = value # Store the raw text
                ssol.system_data = current_data
        
        # --- B. OPERATOR (Identity) ---
        # Maps to the SQL 'owner' column
        elif key == 'OPERATOR':
            ssol.owner = value
            # Dual-write to JSON for the Attenuation Layer (AI Context)
            current_data = dict(ssol.system_data or {})
            current_data['OPERATOR'] = value
            ssol.system_data = current_data
            
        # --- C. GENERIC SYSTEM NODES (Budget, Scale, Directive, etc.) ---
        # Stored purely in the JSONB 'system_data' column
        else:
            # We must cast to dict and reassign to trigger SQLAlchemy change tracking
            current_data = dict(ssol.system_data or {})
            current_data[key] = value
            ssol.system_data = current_data

        # 4. Commit Transaction
        session.commit()
        current_app.logger.info(f"Updated System Node '{key}' for SSOL {ssol_id}")
        return jsonify({'success': True})

    except Exception as e:
        # 5. Safety Rollback
        session.rollback()
        current_app.logger.error(f"DB Transaction Failed in update_ssol_system_node: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500
        
    finally:
        session.close()
        
@routes_bp.route('/speculate_context', methods=['POST'])
async def speculate_context_route():
    try:
        data = request.get_json()
        ce_type = data.get('ce_type', 'Default')
        context = data.get('context') # e.g., 'prerequisites', 'narrative', 'stakeholders'
        sub_context = data.get('sub_context', '') # e.g., 'summary' for narrative fields
        cos_text = data.get('cos_text', '')
        ssol_id = data.get('ssol_id')
        
        # 1. ATTENUATION LAYER (The "Telepathy" / System Physics)
        # This injects the global constraints (Budget, Timeline, Ethics) into the local prompt.
        system_instructions = []
        
        if ssol_id and USE_DATABASE:
            engine, session = get_engine_and_session()
            try:
                # Handle UUID conversion safely
                ssol_uuid = UUID(str(ssol_id))
                ssol = session.query(SSOL).get(ssol_uuid)
                
                if ssol:
                    current_app.logger.info(f"Applying Attenuation for SSOL {ssol_id}")
                    
                    # A. Core Constraints
                    if ssol.target_date:
                        system_instructions.append(f"TEMPORAL CONSTRAINT: Hard deadline is {ssol.target_date}. All generated roadmaps, lead times, and resource acquisitions must mathematically fit within this window.")
                    if ssol.owner:
                        system_instructions.append(f"OPERATOR CONTEXT: The acting entity is '{ssol.owner}'. Suggest resources accessible to this specific type of entity.")
                    
                    # B. System Nodes (The Physics)
                    if ssol.system_data:
                        active_physics = []
                        for key, val in ssol.system_data.items():
                            config = SYSTEM_NODES.get(key)
                            # Check if this system node has a prompt injection rule
                            if config and 'prompt_injection' in config and val:
                                instruction = config['prompt_injection'].format(value=val)
                                system_instructions.append(instruction)
                                active_physics.append(key)
                        
                        if active_physics:
                            current_app.logger.info(f"Active Physics Nodes applied: {active_physics}")

            except Exception as db_e:
                current_app.logger.warning(f"Attenuation Layer skipped (DB Error): {db_e}")
            finally:
                session.close()

        global_context_block = "\n".join(system_instructions)
        if not global_context_block:
            global_context_block = "CONTEXT: Standard operating procedure. No specific constraints defined."
        else:
            # Debug log to verify that physics are being injected
            current_app.logger.debug(f"*** ATTENUATION BLOCK ***\n{global_context_block}\n*************************")

        # 2. NODE-SPECIFIC PROMPT ASSEMBLY
        # Resolve the specific "Job to be Done" based on the Node Type
        node_config = NODES.get(ce_type, NODES['Default'])
        prompts_map = node_config.get('prompts', {})
        default_prompts = NODES['Default'].get('prompts', {})
        
        system_inst_for_ai = "You are the SSPEC Speculation Engine. Act as an expert strategic logic processor."

        if context == 'narrative':
            # Narrative Mode: Generating text for a specific field (e.g. Executive Summary)
            base_prompt = prompts_map.get('narrative', default_prompts.get('narrative'))
            prompt_content = base_prompt.format(cos_text=cos_text, field=sub_context, node_type=ce_type)
            
            # Combine Physics + Task
            final_prompt = f"*** SYSTEM PHYSICS (NON-NEGOTIABLE CONSTRAINTS) ***\n{global_context_block}\n\n*** SPECIFIC TASK ***\n{prompt_content}"
            system_inst_for_ai += " Return strictly JSON in this format: { \"text\": \"...\" }. Keep the tone professional, engineered, and action-oriented. Avoid fluff."
            
        else:
            # Collection Mode: Generating arrays of items (Prereqs, Stakeholders, etc.)
            base_prompt = prompts_map.get(context, default_prompts.get(context))
            
            # Fallback if specific prompt missing
            if not base_prompt:
                base_prompt = f"Analyze '{cos_text}'. List 3 items for {context}."
            
            # Handle empty context (Start of project)
            if not cos_text or cos_text == "Project Goal":
                 base_prompt += " (Infer context primarily from the System Physics provided)."

            prompt_content = base_prompt.format(cos_text=cos_text)
            
            # Combine Physics + Task
            final_prompt = f"*** SYSTEM PHYSICS (NON-NEGOTIABLE CONSTRAINTS) ***\n{global_context_block}\n\n*** SPECIFIC TASK ***\n{prompt_content}"
            system_inst_for_ai += " Return a valid JSON array of objects. Do not wrap in markdown code blocks."

        # 3. EXECUTE ENGINE
        ai_response = await generate_chat_response(
            messages=[{"role": "user", "content": final_prompt}], 
            role="SSPEC Engine", 
            task=f"{ce_type}-{context}",
            system_instruction=system_inst_for_ai,
            temperature=0.75 
        )
        
        # 4. PARSE & RETURN
        clean_json = ai_response.replace("```json", "").replace("```", "").strip()
        parsed = json.loads(clean_json)

        if context == 'narrative':
            # Narrative returns a single text string
            txt = parsed.get('text', '') if isinstance(parsed, dict) else str(parsed)
            return jsonify({'success': True, 'text': txt, 'field': sub_context})
        else:
            # Collections return a list of suggestions
            suggestions = []
            if isinstance(parsed, dict):
                # Handle case where AI wraps array in a key like {"items": [...]}
                for key, val in parsed.items():
                    if isinstance(val, list):
                        suggestions = val
                        break
            elif isinstance(parsed, list):
                suggestions = parsed
                
            return jsonify({'success': True, 'suggestions': suggestions, 'context': context})

    except Exception as e:
        current_app.logger.error(f"Speculation Context Error: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

# ==============================================================================
# 7. CORE CRUD & EXPORT 
# ==============================================================================

@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        ce_text = data.get('ce_text', 'Conditional Element')
        
        # Ensure we have a valid UUID object for DB lookup, but keep string for fallback
        ce_id_obj = None
        if ce_id_str:
            try:
                ce_id_obj = UUID(ce_id_str)
            except ValueError:
                pass # Handle non-UUID strings if necessary

        # Fetch Data
        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        
        # Initialize structure if missing
        if not ce_data or 'data' not in ce_data:
            # Ensure the ID in the fallback dict is a STRING
            ce_data = {'id': str(ce_id_str) if ce_id_str else 'new_ce', 'node_type': ce_type, 'data': {
                'details_data': {}, 'resources': [], 'prerequisites': [], 'stakeholders': [], 'assumptions': [], 'connections': []
            }}

        node_config = NODES.get(ce_type, NODES['Default'])
        cos_content_html = data.get('cos_content', '')
        
        # Strip HTML to feed plain text to AI
        cos_text_only = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)
        
        # Get context summary
        ai_generated_data = await generate_ai_data(ce_type, cos_text_only, data.get('ssol_goal', ''), 'context')

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type, ce_text=ce_text, ce_data=ce_data, node_info=node_config,
            cos_content=cos_content_html, ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''), phase_index=data.get('phase_index', 0)
        )
        return jsonify(modal_html=modal_html, ce_data=ce_data)
    except Exception as e:
        # Improved error logging to catch these issues in console
        current_app.logger.error(f"Error generating CE Modal: {e}", exc_info=True)
        return jsonify(error=str(e)), 500

@routes_bp.route('/update_ce/<uuid:ce_id>', methods=['PUT'])
def update_ce_route(ce_id):
    data = request.get_json()
    if speculate_update_ce_by_id(USE_DATABASE, ce_id, data): return jsonify(success=True)
    return jsonify(success=False), 500

@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        cos_data = await speculate_create_cos(
            USE_DATABASE, UUID(data['ssol_id']), data['content'], 
            data.get('status', 'Proposed'), data.get('accountable_party'), data.get('completion_date')
        )
        if cos_data: return jsonify(success=True, cos=cos_data), 201
        return jsonify(success=False), 500
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        res = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)
        if res['success']: return jsonify(success=True, cos=res['cos'])
        return jsonify(success=False, error=res['message']), res['status_code']
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    if speculate_delete_cos_by_id(USE_DATABASE, cos_id): return jsonify(success=True)
    return jsonify(success=False), 404

@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    p = f"images/ssol_image_{ssol_id}.png"
    if os.path.exists(os.path.join(current_app.static_folder, p)):
        return jsonify({'image_path': url_for('static', filename=p), 'status': 'found'})
    return jsonify({'status': 'pending'})

@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        html = request.get_json()['htmlContent'].replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')
        pdf_options = {"page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in", "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8", "no-outline": None, "enable-local-file-access": None}
        pdf = pdfkit.from_string(html, False, options=pdf_options, css=os.path.join(current_app.root_path, 'static', 'styles.css'))
        r = make_response(pdf)
        r.headers['Content-Type'] = 'application/pdf'
        r.headers['Content-Disposition'] = f'attachment; filename="SSPEC_{ssol_id}.pdf"'
        return r
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

üé® styles.css:
/* styles.css - SSPEC "Horizon Fusion" v2025.38 (PROTOTYPE VISUALS + WIZARD) */

/* ================================================== */
/* ==============  1. FONTS & VARIABLES  ============ */
/* ================================================== */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Manrope:wght@400;500;600;700;800&family=Antonio:wght@700&family=Mr+Dafoe&family=Unica+One&display=swap');

:root {
  /* --- Horizon Palette --- */
  --bg-warm: #e3f2fd;
  --surface-white: #ffffff;
  --surface-screen: #f8fafc;
  
  /* Brand Colors */
  --aviation-teal: #00bcd4;
  --deep-space-blue: #2c3e50;
  --retro-coral: #ff7043;
  
  /* Functional Colors */
  --danger: #ef5350;
  --success: #66bb6a;
  --warning: #ffca28;
  --text-dark: #1e293b;
  --text-muted: #64748b;

  /* Phase Colors */
  --phase-0: #ff7043; /* Discovery */
  --phase-1: #26c6da; /* Engagement */
  --phase-2: #ab47bc; /* Action */
  --phase-3: #ffa726; /* Completion */
  --phase-4: #66bd0e; /* Legacy */
  
  /* Typography Tokens */
  --font-brand: 'Righteous', cursive; 
  --font-retro: 'Unica One', cursive;
  --font-script: 'Mr Dafoe', cursive;
  --font-data: 'Antonio', sans-serif; 
  --font-body: 'Manrope', sans-serif;

  /* --- FLUID RESPONSIVE MATH --- */
  --font-size-base: clamp(0.875rem, 0.8rem + 0.25vw, 1rem); 
  --spacing-fluid: clamp(1rem, 2vw, 2rem);
  --radius-fluid: clamp(12px, 1.5vw, 24px);
}

body {
  font-family: var(--font-body);
  font-size: var(--font-size-base);
  background-color: transparent;
  color: var(--text-dark);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* Typography Overrides */
h1.display-script { font-family: var(--font-script); font-weight: 400; }
h1, h2, h3, .navbar-brand { font-family: var(--font-brand); letter-spacing: 1px; }

h4, h5, h6, .font-data, .ce-title, .card-domain-badge, .btn, .nav-link { 
    font-family: var(--font-data); letter-spacing: 0.5px; text-transform: uppercase; 
}
.font-retro { font-family: var(--font-retro); letter-spacing: 1px; text-transform: uppercase; }
.font-body, .card-desc { font-family: var(--font-body); }

/* ================================================== */
/* ==============  2. NAVIGATION  =================== */
/* ================================================== */
nav.navbar {
    background: transparent;
    padding-top: clamp(0.5rem, 1vw, 1.2rem);
    padding-bottom: clamp(0.5rem, 1vw, 1.2rem);
    z-index: 10;
}
.navbar-brand { text-decoration: none; }

/* ================================================== */
/* ==============  3. BACKGROUND ATMOSPHERE  ======== */
/* ================================================== */
.aurora-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; overflow: hidden;
    background-color: #f8fafc;
    transition: all 1s ease-in-out;
}

.aurora-noise {
    position: absolute; inset: 0; z-index: 2; opacity: 0.06;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
}

.aurora-blob {
    position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
    mix-blend-mode: multiply; animation-timing-function: ease-in-out; 
    animation-iteration-count: infinite; animation-direction: alternate;
}

.blob-1 { background-color: var(--phase-0); top: -10%; left: -10%; width: 70vw; height: 70vw; animation: float1 25s infinite; }
.blob-2 { background-color: var(--phase-1); top: -10%; right: -10%; width: 60vw; height: 60vw; animation: float2 28s infinite; }
.blob-3 { background-color: var(--phase-2); bottom: -20%; left: 20%; width: 70vw; height: 70vw; animation: float3 32s infinite; }
.blob-4 { background-color: var(--phase-3); bottom: -10%; right: -10%; width: 50vw; height: 50vw; animation: float1 22s infinite; opacity: 0.3; }
.blob-5 { background-color: var(--phase-4); top: 40%; left: 40%; width: 40vw; height: 40vw; animation: float3 35s infinite; opacity: 0.3; }

@keyframes float1 { from { transform: translate(0, 0) scale(1); } to { transform: translate(40px, 50px) scale(1.1); } }
@keyframes float2 { from { transform: translate(0, 0) scale(1); } to { transform: translate(-50px, 30px) scale(1.2); } }
@keyframes float3 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(30px, -40px) rotate(10deg); } }

body.state-outcome .aurora-background { opacity: 0.2; filter: grayscale(80%); }

/* ================================================== */
/* ==============  4. THE CONSOLE HOUSING =========== */
/* ================================================== */

.horizon-wrapper {
  padding: clamp(1rem, 2vw, 2rem);
  min-height: 90vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.console-housing {
  background-color: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(24px);
  background-image: radial-gradient(#94a3b8 1.5px, transparent 1.5px);
  background-size: 24px 24px;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
  width: 98%;
  max-width: 1440px;
  margin: 0 auto;
  border: 1px solid rgba(255,255,255,0.8);
  position: relative;
  overflow: hidden;
}

.brand-strip {
  background: linear-gradient(90deg, #00bcd4 0%, #26c6da 50%, #ff7043 100%);
  height: 6px; width: 100%; position: absolute; top: 0; left: 0; z-index: 5;
}

.screen-surface {
    background: transparent;
    height: 100%;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 85vh;
}

/* ================================================== */
/* ===========  5. INPUT STAGE (Refined) ============ */
/* ================================================== */
.input-stage {
  flex-grow: 1;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.8) 100%);
  border-radius: 16px; 
}

.input-stage-wrapper {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 70vh; width: 100%;
}

.input-bezel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(25px);
    padding: clamp(1.5rem, 4vw, 3rem) !important;
    border-radius: clamp(16px, 3vw, 32px);
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 50px -10px rgba(0,0,0,0.1); 
    max-width: 900px;
    width: 90%;
    text-align: center;
    animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    position: relative;
}
@keyframes floatUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

.huge-input {
    border: none; border-bottom: 2px solid #cbd5e1;
    font-family: var(--font-body); font-weight: 300;
    color: var(--text-dark);
    width: 100%; text-align: center; 
    background: transparent; outline: none; transition: all 0.3s;
    font-size: clamp(1.2rem, 3vw, 2rem);
    padding: clamp(0.5rem, 1vw, 1rem);
}
.huge-input:focus { border-bottom-color: var(--aviation-teal); background: rgba(255,255,255,0.5); }
.huge-input::placeholder { color: #94a3b8; font-style: italic; }

.btn-launch {
    background: linear-gradient(135deg, var(--retro-coral) 0%, #f4511e 100%);
    color: white; font-family: var(--font-data); letter-spacing: 2px;
    border-radius: 50px; border: none;
    box-shadow: 0 8px 15px rgba(244, 81, 30, 0.2); transition: all 0.2s;
    padding: clamp(0.6rem, 1vw, 0.8rem) clamp(2rem, 3vw, 3rem);
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    margin-top: clamp(1.5rem, 2vw, 2rem);
}
.btn-launch:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(244, 81, 30, 0.3); }

/* =================================================== */
/* ======  7. GOAL SELECTION PAGE (FULL SECTION) ===== */
/* =================================================== */

/*
 * ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 * ‚îÇ  THE SACRED DIAGONAL FLIP - DESIGN PHILOSOPHY                          ‚îÇ
 * ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  Axis: rotate3d(1, 1, 0, Xdeg)                                         ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  This rotates around a diagonal line from bottom-left to top-right:    ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                   ‚îÇ
 * ‚îÇ      ‚îÇ‚ï≤            ‚îÇ                                                   ‚îÇ
 * ‚îÇ      ‚îÇ ‚ï≤    ‚ü≥     ‚îÇ  ‚Üê Rotation axis                                  ‚îÇ
 * ‚îÇ      ‚îÇ  ‚ï≤         ‚îÇ                                                    ‚îÇ
 * ‚îÇ      ‚îÇ   ‚ï≤        ‚îÇ                                                    ‚îÇ
 * ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚ï≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                    ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îÇ  STATE ROTATION MAP:                                                   ‚îÇ
 * ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                   ‚îÇ
 * ‚îÇ  DEALING/REVEALING  ‚Üí  0deg    ‚Üí  Monolith (Back Face)                ‚îÇ
 * ‚îÇ  SELECTION          ‚Üí  180deg  ‚Üí  Goal Details (Front Face)           ‚îÇ
 * ‚îÇ  CONFIG             ‚Üí  360deg  ‚Üí  Hero Content (Back Face, full flip) ‚îÇ
 * ‚îÇ  RETURNING          ‚Üí  180deg  ‚Üí  Goal Details (Front Face)           ‚îÇ
 * ‚îÇ                                                                         ‚îÇ
 * ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 */

/* --- 7.1 STAGE VIEWPORT (The Theater) --- */

#stage-viewport {
    position: relative;
    flex-grow: 1;
    width: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 2rem;
}

.goal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 2.5rem;
    padding: 1rem;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    align-items: start;
    justify-content: center;
    transition: opacity 0.5s ease;
}

@media (min-width: 1200px) {
    .goal-grid {
        grid-template-columns: repeat(3, minmax(320px, 420px));
    }
}

.grid-placeholder {
    visibility: hidden;
    pointer-events: none;
}

/* --- 7.2 FLIP CARD WRAPPER (The Stage for Each Card) --- */

.flip-card-wrapper {
    position: relative;
    width: 100%;
    max-width: 420px;
    aspect-ratio: 2/3;
    min-height: 500px;
    cursor: pointer;
    z-index: 10;
    margin: 0 auto;
    
    /* 3D Context */
    perspective: 1500px;
    
    /* Smooth transitions for position/size morphing */
    transition: 
        opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        top 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        left 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        width 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        height 0.8s cubic-bezier(0.2, 0.8, 0.2, 1),
        border-radius 0.5s ease;
}

/* --- 7.3 FLIP CARD INNER (The 3D Flip Engine) --- */

.flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 32px;
    
    transform-style: preserve-3d;
    transform-origin: center center;
    transform: rotate3d(1, 1, 0, 0deg); /* Default: Monolith visible */
    
    transition: 
        transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1),
        border-radius 0.5s ease;
    
    /* NOTE: Shadow moved to faces to prevent rotation artifacts */
}

/* --- 7.4 CARD FACES (Front & Back) --- */

.flip-card-front,
.flip-card-back {
    position: absolute;
    inset: 0;
    border-radius: 32px;
    overflow: hidden;
    
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;

    /* Shadow applied to faces for correct light source orientation */
    box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.5s ease, border-radius 0.5s ease;
}

/* Back Face: Monolith / Hero */
.flip-card-back {
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    padding: 2.5rem;
}

/* Front Face: Goal Details */
.flip-card-front {
    z-index: 1;
    /* Pre-rotated 180deg */
    transform: rotate3d(1, 1, 0, 180deg);
    
    display: flex;
    flex-direction: column;
    background: white;
    border: 1px solid #e2e8f0;
}

/* --- 7.5 CARD TEXTURE OVERLAY --- */

.card-texture-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background-image: radial-gradient(rgba(255, 255, 255, 0.3) 1.5px, transparent 1.5px);
    background-size: 20px 20px;
    z-index: 1;
    opacity: 0.6;
}

/* =================================================== */
/* ======  7.6 STATE MACHINE CLASSES  ================ */
/* =================================================== */

.flip-card-wrapper.state-dealing {
    opacity: 0;
    transform: translateY(120px) scale(0.9);
    pointer-events: none;
}
.flip-card-wrapper.state-dealing .flip-card-inner { transform: rotate3d(1, 1, 0, 0deg); }

.flip-card-wrapper.state-revealing {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: none;
}
.flip-card-wrapper.state-revealing .flip-card-inner { transform: rotate3d(1, 1, 0, 0deg); }

/* --- SELECTION STATE --- */
.flip-card-wrapper.state-selection {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
    cursor: pointer;
}
.flip-card-wrapper.state-selection .flip-card-inner {
    /* 0deg -> 180deg (Show Goal Details) */
    transform: rotate3d(1, 1, 0, 180deg);
}
.flip-card-wrapper.state-selection:hover {
    transform: translateY(-12px) scale(1.02);
    z-index: 15;
}
.flip-card-wrapper.state-selection:hover .flip-card-front {
    box-shadow: 
        0 45px 80px -20px rgba(0, 0, 0, 0.35),
        0 25px 35px -15px rgba(0, 0, 0, 0.20);
}

/* --- CONFIG STATE (Hero Mode) --- */
.flip-card-wrapper.state-config {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 35%; 
    max-width: 480px;
    margin: 0;
    z-index: 100;
    pointer-events: auto;
    /* Square off left corners for docking */
    border-radius: 0 24px 24px 0;
}
.flip-card-wrapper.state-config .flip-card-inner,
.flip-card-wrapper.state-config .flip-card-back {
    border-radius: 0 24px 24px 0;
}
.flip-card-wrapper.state-config .flip-card-inner {
    /* 180deg -> 360deg (Continuous Flip) */
    transform: rotate3d(1, 1, 0, 360deg);
}
.flip-card-wrapper.state-config .flip-card-back {
    box-shadow: 15px 0 50px -10px rgba(0, 0, 0, 0.30);
}

/* --- RETURNING STATE --- */
.flip-card-wrapper.state-returning { z-index: 100; pointer-events: none; border-radius: 32px; }
.flip-card-wrapper.state-returning .flip-card-inner,
.flip-card-wrapper.state-returning .flip-card-back { border-radius: 32px; }
.flip-card-wrapper.state-returning .flip-card-inner { transform: rotate3d(1, 1, 0, 180deg); }

/* --- DIMMED & VIOLATION --- */
.flip-card-wrapper.state-dimmed {
    opacity: 0; pointer-events: none; transform: scale(0.85) translateZ(-200px); filter: blur(4px);
}
.flip-card-wrapper.violation { cursor: not-allowed; }
.flip-card-wrapper.violation .flip-card-inner { opacity: 0.7; filter: saturate(0.5); }

/* =================================================== */
/* ======  7.7 MONOLITH CONTENT (Back Face) ========== */
/* =================================================== */

.monolith-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
}

.monolith-icon-circle {
    /* FIXED DIMENSIONS: Prevents ellipse distortion */
    width: 160px !important;
    height: 160px !important;
    min-width: 160px;
    min-height: 160px;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    margin-bottom: 1.5rem;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), inset 0 0 30px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
    padding: 0 !important; /* Critical removal of padding */
}

.monolith-icon {
    font-size: 4.5rem;
    color: rgba(255, 255, 255, 0.95);
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    line-height: 1;
    display: block;
}

/* =================================================== */
/* ======  7.8 GOAL CARD CONTENT (Front Face) ======== */
/* =================================================== */

.card-header-plate {
    position: relative;
    height: 30%; /* Compact Header */
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: visible;
}

.card-domain-badge-large {
    position: relative; z-index: 5;
    font-family: var(--font-data);
    font-size: 0.85rem; font-weight: 800; letter-spacing: 0.2em;
    text-transform: uppercase; color: white;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    padding: 0.75rem 1.75rem; border-radius: 50px;
    margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.card-icon-float-large {
    position: absolute; bottom: -4rem; left: 50%; transform: translateX(-50%); z-index: 10;
    width: 8rem; height: 8rem; /* Large Floating Badge */
    background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15), 0 0 0 6px white;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.flip-card-wrapper.state-selection:hover .card-icon-float-large {
    transform: translateX(-50%) translateY(-4px) scale(1.05);
}
.card-icon-float-large i { font-size: 3.5rem; transition: transform 0.3s ease; }

.card-body-large {
    flex-grow: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start; text-align: center;
    padding: 5rem 2.5rem 1.5rem 2.5rem; /* Room for icon */
}
.card-title-large {
    font-family: var(--font-brand); font-size: clamp(1.6rem, 3vw, 2.2rem);
    color: #1e293b; margin-bottom: 1rem; line-height: 1.15;
    display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.card-desc-large {
    font-family: var(--font-body); font-size: 1rem; font-weight: 500;
    color: #64748b; line-height: 1.6; max-width: 340px;
    display: -webkit-box; -webkit-line-clamp: 4; line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
}

.card-footer-large { padding: 1.5rem 2.5rem 2.5rem 2.5rem; margin-top: auto; }
.btn-select-pill-large {
    display: block; width: 100%; padding: 1.1rem 2rem; border: none; border-radius: 50px;
    font-family: var(--font-data); font-size: 0.85rem; font-weight: 800; letter-spacing: 0.2em;
    text-transform: uppercase; color: white; cursor: pointer;
    box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.2); transition: transform 0.2s ease;
}
.btn-select-pill-large:hover { transform: translateY(-2px); }

/* =================================================== */
/* ======  7.9 HERO CARD CONTENT (Config Mode) ======= */
/* =================================================== */

.hero-card-content {
    position: relative; z-index: 10; height: 100%;
    display: flex; flex-direction: column; padding: 3rem; color: white;
}
.hero-ghost-icon {
    position: absolute; bottom: -15%; right: -15%;
    font-size: 20rem; color: rgba(255, 255, 255, 0.08);
    transform: rotate(-12deg); pointer-events: none; z-index: 1;
}
.hero-return-button {
    position: relative; z-index: 10; display: flex; align-items: center; gap: 0.75rem;
    color: rgba(255, 255, 255, 0.7); font-family: var(--font-data); font-size: 0.75rem;
    font-weight: 800; letter-spacing: 0.15em; text-transform: uppercase;
    background: none; border: none; padding: 0; margin-bottom: 2rem; cursor: pointer;
    transition: all 0.2s ease;
}
.hero-return-button:hover { color: white; transform: translateX(-5px); }

.hero-domain-pill {
    position: relative; z-index: 10; display: inline-flex; align-items: center; gap: 0.75rem;
    background: white; border-radius: 50px; padding: 0.8rem 1.75rem;
    margin-bottom: 2rem; width: fit-content; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}
.hero-domain-pill i { font-size: 1.4rem; }
.hero-domain-pill span { font-size: 0.8rem; font-weight: 800; letter-spacing: 0.15em; color: #334155; }

.hero-title {
    position: relative; z-index: 10; font-family: var(--font-brand);
    font-size: clamp(2rem, 4vw, 2.8rem); line-height: 1.1; margin-bottom: 1.5rem;
}
#sys-pill-stack {
    position: relative; z-index: 10; display: flex; flex-direction: column;
    gap: 0.75rem; margin-top: auto;
}
.hero-status-pill {
    background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50px;
    padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem;
}

/* =================================================== */
/* ======  7.10 CONFIGURATION WIZARD PANEL =========== */
/* =================================================== */

#configuration-stage {
    position: absolute;
    /* FORCE VERTICAL STRETCH */
    top: 0;
    bottom: 0;
    
    /* PICA RULE GAP (1rem from 35% Hero) */
    left: calc(35% + 1rem); 
    width: calc(65% - 1rem); 
    
    z-index: 50;
    pointer-events: none;
    
    opacity: 0;
    transform: translateX(50px);
    transition: opacity 0.5s ease, transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    transition-delay: 0.2s;
}

#configuration-stage.active {
    opacity: 1 !important;
    transform: translateX(0) !important;
    pointer-events: auto !important;
    visibility: visible;
}

.wizard-card {
    width: 100%;
    height: 100%;
    background: white;
    /* Left rounded corners for gap effect */
    border-radius: 24px 0 0 24px;
    box-shadow: -10px 0 40px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-left: 1px solid #e2e8f0;
}

/* --- Responsive Adjustments --- */
@media (max-width: 992px) {
    .flip-card-wrapper.state-config {
        width: 100%; max-width: none; border-radius: 0; height: 40vh;
    }
    .flip-card-wrapper.state-config .flip-card-inner,
    .flip-card-wrapper.state-config .flip-card-back { border-radius: 0; }
    
    #configuration-stage {
        top: 40vh; bottom: 0; left: 0; width: 100%; height: auto;
    }
    .wizard-card { border-radius: 24px 24px 0 0; }
}

/* ================================================== */
/* ==============  8. SPECULATION MODAL  ============ */
/* ================================================== */
.ce-app-shell {
    height: 85vh; 
    display: flex; flex-direction: column; overflow: hidden;
    background-color: #ffffff; border-radius: 16px; 
    box-shadow: 0 30px 80px -20px rgba(0,0,0,0.4); border: 1px solid #e2e8f0; 
}
.ce-modal-header {
    background: linear-gradient(135deg, var(--phase-color), rgba(0,0,0,0.15) 100%);
    color: white; flex-shrink: 0; padding: 0.8rem 1.5rem; 
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: space-between;
    position: relative; overflow: hidden; z-index: 20;
}
.node-icon-box {
    width: 48px; height: 48px;
    background: rgba(255,255,255,0.2); backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.3); border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    font-size: 1.4rem; color: #fff; flex-shrink: 0; margin-right: 1rem;
}
.header-text-block { display: flex; flex-direction: column; justify-content: center; }
.ce-modal-header .ce-title {
    font-family: var(--font-brand); font-weight: 500; font-size: 1.5rem;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0;
    line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
.ce-header-metadata {
    font-family: var(--font-data); font-size: 0.75rem; letter-spacing: 1px;
    text-transform: uppercase; opacity: 0.9; margin-top: 2px;
}
.header-ghost-icon {
    position: absolute; right: 10%; top: 50%;
    transform: translateY(-50%) rotate(-15deg);
    font-size: 10rem; color: white; opacity: 0.08;
    pointer-events: none; z-index: 0;
}
.btn-glass {
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
    color: white; border-radius: 50px; padding: 6px 14px; font-family: var(--font-data);
    font-size: 0.8rem; letter-spacing: 1px; transition: all 0.2s; backdrop-filter: blur(4px);
}
.btn-glass:hover {
    background: rgba(255,255,255,0.3); transform: translateY(-1px); box-shadow: 0 4px 15px rgba(255,255,255,0.1);
}
.btn-close-custom {
    background: none; border: none; color: rgba(255,255,255,0.7);
    font-size: 1.2rem; transition: color 0.2s;
}
.btn-close-custom:hover { color: white; }

.ce-micro-timeline {
    background: white; border-bottom: 1px solid #e2e8f0; padding: 0.8rem 1.5rem;
}
.milestone-segment {
    flex: 1; height: 4px; background: #e2e8f0; border-radius: 2px;
    margin: 0 2px; position: relative; transition: all 0.3s;
}
.milestone-segment.active { background: var(--phase-color); }
.milestone-segment .ms-bar { height: 100%; width: 100%; }
.ms-label {
    position: absolute; top: 8px; left: 0; width: 100%; text-align: center;
    font-family: var(--font-data); font-size: 0.55rem; color: #94a3b8;
    opacity: 0; transition: opacity 0.2s;
}
.milestone-segment.active .ms-label { opacity: 1; color: var(--phase-color); }
.ce-workspace-body { flex-grow: 1; display: flex; flex-direction: row; overflow: hidden; }
.ce-main-column { flex: 1; display: flex; flex-direction: column; min-width: 0; background-color: var(--surface-screen); position: relative; }
.ai-sidebar {
    width: 300px; flex-shrink: 0; border-left: 1px solid #e2e8f0;
    background-color: #ffffff; display: flex; flex-direction: column;
    z-index: 15; box-shadow: -5px 0 30px rgba(0,0,0,0.03);
}
.ce-nav-tabs {
    background: white; padding: 0 1.2rem; border-bottom: 1px solid #e2e8f0;
    flex-shrink: 0; display: flex; gap: 0.8rem; overflow-x: auto;
}
.ce-nav-tabs .nav-link {
    border: none; border-bottom: 3px solid transparent; color: var(--text-muted);
    font-family: var(--font-data); font-size: 0.9rem; letter-spacing: 0.5px;
    text-transform: uppercase; padding: 0.8rem 0.4rem; transition: all 0.2s; white-space: nowrap;
}
.ce-nav-tabs .nav-link:hover { color: var(--text-dark); }
.ce-nav-tabs .nav-link.active {
    color: var(--phase-color); background: transparent; border-bottom-color: var(--phase-color);
}
.count-badge { font-family: var(--font-body); font-weight: 800; vertical-align: top; font-size: 0.65em; }
.ce-app-content { flex-grow: 1; overflow-y: auto; padding: 0; position: relative; }
.bg-technical-grid {
    background-color: var(--surface-screen);
    background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px), radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 20px 20px; background-position: 0 0, 10px 10px;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.02);
}

/* ================================================== */
/* ==============  9. LOADING & UTILITIES  ========== */
/* ================================================== */
.loading-spinner-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(15, 23, 42, 0.2); backdrop-filter: blur(3px);
    display: flex; justify-content: center; align-items: center; 
    z-index: 9999; transition: opacity 0.3s ease;
}
.loading-spinner-overlay.d-none { display: none !important; }

.spinner-box {
    width: 90%; max-width: 600px;
    padding: clamp(1.5rem, 3vw, 2.5rem);
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid #cbd5e1; border-radius: 15px;
    box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6);
    display: flex; align-items: center; gap: clamp(1rem, 2vw, 2.5rem);
    position: relative; overflow: hidden;
}
@media (max-width: 576px) {
    .spinner-box { flex-direction: column; text-align: center; }
    .spinner-content { align-items: center; }
    .spinner-text-stage { text-align: center; }
    .spinner-message { width: 100%; left: 0; text-align: center; }
}
.spinner-box::before {
    content: ""; position: absolute; top: 0; left: 0; bottom: 0; width: 15px;
    background: linear-gradient(180deg, #ff7043, #26c6da, #ab47bc, #ffa726, #66bd0e, #e91e63);
    background-size: 100% 400%; animation: phase-swirl 3s linear infinite; z-index: 10;
}
@keyframes phase-swirl { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }
.spinner-box::after {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
    transform: translateX(-100%); animation: shimmer 3s infinite;
}
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

.spinner-visual-stack {
    position: relative; width: 64px; height: 64px; flex-shrink: 0;
    display: flex; justify-content: center; align-items: center;
}
.la-ball-atom, .la-ball-atom > div { position: relative; box-sizing: border-box; }
.la-ball-atom { display: block; font-size: 0; color: #fff; width: 64px; height: 64px; }
.la-ball-atom > div { display: inline-block; float: none; background-color: currentColor; border: 0 solid currentColor; }
.la-ball-atom > div:nth-child(1) {
    position: absolute; top: 50%; left: 50%; z-index: 1; width: 70%; height: 70%; 
    background: var(--retro-coral); border-radius: 100%; transform: translate(-50%, -50%);
}
.la-ball-atom > div:not(:nth-child(1)) {
    position: absolute; left: 0; z-index: 0; width: 100%; height: 100%; background: none;
    animation: ball-atom-zindex 1.5s 0s infinite steps(2, end);
}
.la-ball-atom > div:not(:nth-child(1)):before {
    position: absolute; top: 0; left: 0; width: 14px; height: 14px; margin-top: -7px; margin-left: -7px;
    content: ""; border-radius: 50%; opacity: .85;
    animation: ball-atom-position 1.5s 0s infinite ease, ball-atom-size 1.5s 0s infinite ease;
}
.la-ball-atom > div:nth-child(2):before { background: var(--warning); }
.la-ball-atom > div:nth-child(3) { transform: rotate(120deg); }
.la-ball-atom > div:nth-child(3):before { background: var(--aviation-teal); }
.la-ball-atom > div:nth-child(4) { transform: rotate(240deg); }
.la-ball-atom > div:nth-child(4):before { background: #9c27b0; }

@keyframes ball-atom-position { 50% { top: 100%; left: 100%; } }
@keyframes ball-atom-size { 50% { transform: scale(.5, .5); } }
@keyframes ball-atom-zindex { 50% { z-index: 10; } }

.spinner-overlay-icon {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 20; color: white; font-size: 1.4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}
.spinner-content {
    display: flex; flex-direction: column; flex-grow: 1; 
    justify-content: center; position: relative; min-height: 60px;
    text-align: left; align-items: flex-start;
}
.spinner-title { 
    font-family: var(--font-data); font-size: clamp(1.4rem, 2vw, 1.8rem); 
    color: #0f172a; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 1px; line-height: 1;
}
.spinner-text-stage { position: relative; width: 100%; height: 1.5rem; text-align: left; }
.spinner-message {
    font-family: var(--font-body); font-size: 1.1rem; color: #64748b; font-weight: 500;
    position: absolute; top: 0; left: 0; width: 100%; white-space: nowrap; overflow: hidden;
}
.fade-out { opacity: 0; pointer-events: none; }
.wipe-out { animation: textWipeOut 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; }
.wipe-in { 
    animation: textWipeIn 0.8s cubic-bezier(0.65, 0, 0.35, 1) forwards; 
    animation-delay: 0.15s; 
    clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%);
    -webkit-mask-image: linear-gradient(to right, transparent, black);
    mask-image: linear-gradient(to right, transparent, black);
}
@keyframes textWipeOut { 
    0% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 
    100% { clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%); } 
}
@keyframes textWipeIn { 
    0% { clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%); } 
    100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); } 
}

/* ================================================== */
/* =======  10. HORIZON SYSTEM MASTHEAD  ============ */
/* ================================================== */
.horizon-system-bar {
    width: 100%; max-width: 1400px; margin: 0 auto; 
    display: flex; justify-content: space-between; align-items: center;
    padding: clamp(0.5rem, 1.5vw, 1.5rem) clamp(1rem, 2vw, 2rem);
    z-index: 100; position: relative;
}
.masthead-spacer { width: 120px; display: none; }
@media(min-width: 992px) { .masthead-spacer { display: block; } }
.masthead-title-lockup { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.masthead-pill {
    background: var(--aviation-teal); color: white; font-family: 'Antonio', sans-serif;
    font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase;
    padding: 3px 10px; border-radius: 50px; margin-bottom: 4px; font-weight: 700;
}
.masthead-brand { line-height: 0.8; color: var(--deep-space-blue); text-shadow: 0 1px 0px rgba(255,255,255,0.6); }
.brand-script {
    font-family: 'Mr Dafoe', cursive; font-size: clamp(1.8rem, 3vw, 2.5rem);
    color: var(--retro-coral); margin-right: 8px; display: inline-block;
    transform: rotate(-4deg) translateY(-3px);
}
.brand-display {
    font-family: 'Righteous', cursive; font-size: clamp(1.4rem, 2.5vw, 2rem);
    text-transform: uppercase; letter-spacing: 1px; color: #37474f; 
}
.masthead-controls { display: flex; gap: 0.6rem; align-items: center; width: auto; justify-content: flex-end; }
@media(min-width: 992px) { .masthead-controls { width: 120px; } }

.btn-masthead {
    width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.8); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    cursor: pointer; transition: all 0.2s; font-size: 1.1rem; text-decoration: none;
}
.btn-masthead:hover { 
    background: white; color: var(--aviation-teal); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}
.user-avatar {
    width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, #ff7043, #d84315);
    color: white; display: flex; align-items: center; justify-content: center; 
    font-weight: bold; font-family: 'Antonio', sans-serif; border: 2px solid white; 
    box-shadow: 0 4px 10px rgba(244, 81, 30, 0.3); cursor: pointer;
}

/* ================================================== */
/* ========  11. DASHBOARD & SYSTEM WIDGETS  ======== */
/* ================================================== */
/* --- A. The Sidebar Stack (Vertical Anchors) --- */
.system-anchor-card {
    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    border: 1px solid #e2e8f0; background: linear-gradient(to right, #ffffff, #fafafa); 
    display: flex; align-items: center; border-radius: 50px;
    padding: 0.4rem 0.8rem; margin-bottom: 0.6rem;
    cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
    position: relative; overflow: hidden; min-height: 44px;
}
.system-anchor-card:hover {
    transform: translateX(3px); border-color: #cbd5e1; background: #ffffff;
    box-shadow: 0 4px 10px -3px rgba(0,0,0,0.08) !important; z-index: 2;
}
.sys-icon-circle {
    width: 32px; height: 32px; border-radius: 50%;
    background-color: var(--sys-color, #64748b); color: white;
    display: flex; align-items: center; justify-content: center; margin-right: 10px;
    flex-shrink: 0; font-size: 0.8rem;
}
.sys-meta-col { display: flex; flex-direction: column; justify-content: center; flex-grow: 1; min-width: 0; line-height: 1.1; }
.sys-label {
    font-family: var(--font-data); font-size: 0.55rem; text-transform: uppercase; color: var(--sys-color); 
    letter-spacing: 1px; opacity: 0.8; margin-bottom: 1px; font-weight: 700;
}
.sys-value { font-family: var(--font-body); font-weight: 700; font-size: 0.85rem; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

#system-anchor-stack .btn-outline-secondary {
    border-radius: 50px; border: 2px dashed #cbd5e1; color: #94a3b8;
    font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
}
#system-anchor-stack .btn-outline-secondary:hover {
    border-color: var(--aviation-teal); color: var(--aviation-teal); background: #f0fdff;
}

/* --- B. Horizon Gauge --- */
.system-node-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.system-node-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -10px rgba(0, 188, 212, 0.15) !important; border-color: var(--aviation-teal); }
.system-node-card.group:hover i { transform: scale(1.1); color: var(--aviation-teal) !important; }
.system-node-card i { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

/* --- C. Utility: Borders & Layouts --- */
.border-dashed { border-style: dashed !important; }
.console-housing .row { min-height: 85vh; align-items: stretch; }
.command-deck-wrapper .lead { font-weight: 400; color: #2c3e50; letter-spacing: 0.01em; }

/* ================================================== */
/* ========  12. STRATEGIC CHARTER STYLING  ========= */
/* ================================================== */
.charter-card {
    background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.6); border-top: 4px solid var(--aviation-teal);
    border-radius: 16px; position: relative; overflow: hidden;
    box-shadow: 0 10px 30px -5px rgba(0, 188, 212, 0.15);
}
.charter-header-text {
    font-family: 'Righteous', cursive; font-size: 1.1rem; letter-spacing: 1px;
    color: var(--aviation-teal); text-transform: uppercase;
}
.charter-content {
    position: relative; z-index: 2; font-family: 'Manrope', sans-serif;
    color: #263238; text-shadow: 0 1px 0 rgba(255,255,255,0.8);
    text-align: left; line-height: 1.8;
}
.domain-ghost-watermark {
    position: absolute; bottom: -20px; right: 10px;
    font-size: 12rem; color: var(--aviation-teal); opacity: 0.06;
    transform: rotate(-15deg); pointer-events: none; z-index: 0; transition: all 0.5s ease;
}

/* ================================================== */
/* ======  13. PILL SYSTEMS (ANCHORS & ATOMS)  ====== */
/* ================================================== */

/* --- A. CE CAPSULE ("Action Atoms") --- */
.ce-capsule {
    display: inline-flex !important; align-items: center; vertical-align: middle;
    width: auto !important; max-width: 100%; flex-shrink: 0;
    background-color: var(--node-color, #78909c); color: white !important;
    padding: 3px 12px 3px 4px; border-radius: 50px; margin: 2px 4px;
    font-family: var(--font-body); font-weight: 700; font-size: 0.75rem;
    text-transform: uppercase; letter-spacing: 0.5px;
    cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2);
    line-height: 1.4; white-space: normal;
}
.ce-capsule:hover {
    transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); filter: brightness(1.1);
}
.ce-capsule i {
    background-color: white; color: var(--node-color, #78909c); 
    width: 20px; height: 20px; border-radius: 50%;
    display: inline-flex; justify-content: center; align-items: center;
    margin-right: 8px; font-size: 0.7em; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* --- B. SYSTEM HIGHLIGHT ("Context Tags") --- */
.sys-highlight {
    display: inline-flex !important; align-items: center; vertical-align: middle;
    width: auto !important; max-width: 100%; flex-shrink: 0;
    background-color: white; border: 2px solid var(--sys-color, #cbd5e1);
    border-radius: 50px; padding: 2px 10px 2px 2px; margin: 0 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: help;
    transition: all 0.2s ease; line-height: 1.4;
}
.sys-highlight:hover {
    transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background-color: #f8fafc; border-color: var(--sys-color);
}
.sys-highlight-dot, .sys-highlight .sys-highlight-icon {
    display: flex; align-items: center; justify-content: center;
    width: 20px; height: 20px; border-radius: 50%;
    background-color: var(--sys-color, #64748b); color: white !important;
    margin-right: 6px; font-size: 0.65rem; flex-shrink: 0;
}
.sys-highlight-text {
    font-family: var(--font-data); font-size: 0.75rem; font-weight: 700;
    text-transform: uppercase; color: #475569; letter-spacing: 0.5px;
}

/* --- C. SYSTEM CONSOLE INPUTS (Back of Flip Card) --- */
.system-pill-input-container {
    background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 50px; padding: 6px 16px;
    display: flex; align-items: center; gap: 10px;
    transition: all 0.2s ease; backdrop-filter: blur(4px);
}
.system-pill-input-container:hover,
.system-pill-input-container:focus-within {
    background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4);
    box-shadow: 0 0 15px rgba(255,255,255,0.05);
}
.system-pill-select, 
.system-pill-date {
    background: transparent; border: none; color: white;
    font-family: var(--font-body); font-weight: 600; font-size: 0.9rem;
    width: 100%; outline: none; cursor: pointer; appearance: none;
}
.system-pill-input-container::after {
    content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900;
    color: rgba(255,255,255,0.5); font-size: 0.7rem; pointer-events: none;
}
.system-pill-date::-webkit-calendar-picker-indicator { 
    filter: invert(1); cursor: pointer; opacity: 0.6;
}
.system-pill-date::-webkit-calendar-picker-indicator:hover { opacity: 1; }
.system-pill-select option { background: #1e293b; color: white; padding: 10px; }

/* ================================================== */
/* ========  14. SYSTEM SIDEBAR WIDGETS (Modal) ===== */
/* ================================================== */
.sys-modal-left {
    color: white; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between;
}
.sys-modal-texture {
    position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.2; pointer-events: none; z-index: 0;
}
.sys-protocol-toggle {
    display: flex; background-color: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 1.5rem;
}
.sys-protocol-btn {
    flex: 1; border: none; background: transparent; padding: 8px;
    font-family: var(--font-data); font-size: 0.7rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px; color: #94a3b8;
    border-radius: 6px; transition: all 0.2s;
}
.sys-protocol-btn.active { background: white; color: #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.sys-protocol-btn.active.speculate { color: #6366f1; }

.sys-entity-card {
    background: white; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-left: 4px solid var(--sys-color); margin-bottom: 8px;
    animation: slideInLeft 0.3s ease forwards;
}
.sys-entity-avatar {
    width: 28px; height: 28px; border-radius: 50%; background: #f1f5f9; color: #64748b;
    display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;
}

/* ================================================== */
/* ======  15. COLLECTION CARDS & DASHBOARD  ======== */
/* ================================================== */
.system-hero-card {
    background-color: var(--phase-color);
    background-image: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0.05) 100%);
    border-radius: 12px; padding: 1.5rem; position: relative; overflow: hidden;
    color: white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
    min-height: 200px; border: 1px solid rgba(255,255,255,0.2);
    display: flex; flex-direction: column; justify-content: center;
}
.system-hero-card .hero-ghost-icon {
    position: absolute; right: -20px; bottom: -40px;
    font-size: 10rem; color: rgba(255,255,255,0.3);
    transform: rotate(-15deg); pointer-events: none; z-index: 1;
}
.hero-label {
    font-family: 'Antonio', sans-serif; font-size: 0.75rem; letter-spacing: 2px;
    text-transform: uppercase; opacity: 0.9; margin-bottom: 0.5rem; position: relative; z-index: 2;
}
.status-card-value {
    font-family: 'Righteous', cursive; font-size: 2.2rem;
    line-height: 1; margin-bottom: 0.8rem; text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative; z-index: 2;
}

.metric-tile {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px;
    padding: 1.2rem; height: 100%; display: flex; flex-direction: column; justify-content: space-between;
    box-shadow: 0 2px 4px rgba(0,0,0,0.01); transition: all 0.2s ease;
}
.metric-tile:hover {
    transform: translateY(-2px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.08); border-color: var(--phase-color);
}
.metric-number {
    font-family: 'Righteous', cursive; font-size: 2rem; color: var(--text-dark);
    line-height: 1; margin: 0.2rem 0;
}
.metric-label {
    font-family: 'Antonio', sans-serif; font-size: 0.7rem; letter-spacing: 1.5px;
    color: var(--text-muted); text-transform: uppercase;
}

/* Collection Cards */
.collection-container { padding: 1.2rem; }
.collection-card-modern {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    padding: 1rem; margin-bottom: 0.6rem; display: flex; align-items: center;
    position: relative; overflow: hidden; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.collection-card-modern::before {
    content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background-color: var(--phase-color); transition: width 0.2s;
}
.collection-card-modern:hover { transform: translateX(2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.collection-card-modern:hover::before { width: 6px; }
.collection-card-modern.border-dashed { border-style: dashed; border-color: #6366f1; background-color: #f8faff; }
.collection-card-modern.border-dashed::before { background-color: #6366f1; }
.card-title-modern { font-family: var(--font-data); font-size: 1rem; color: var(--text-dark); margin-bottom: 2px; }
.card-subtitle-modern { font-family: var(--font-body); font-size: 0.8rem; color: var(--text-muted); }

/* --- Possibility Cards --- */
.collection-card-modern.possibility-card {
    background-color: #f0fdf4; border: 1px dashed #6366f1; opacity: 0.9;
}
.collection-card-modern.possibility-card:hover {
    opacity: 1; background-color: #fff; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.15); transform: translateY(-2px);
}
.badge.bg-primary-soft { background-color: rgba(99, 102, 241, 0.1); color: #6366f1 !important; border: 1px solid rgba(99, 102, 241, 0.2); }
.animate-pulse { animation: pulse-text 2s infinite; }
@keyframes pulse-text { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

/* ================================================== */
/* ========  16. RESPONSIVE OVERRIDES  ============== */
/* ================================================== */
/* 1. FIX THE SIDEBAR SQUISH (Outcome Page) */
@media (max-width: 1400px) {
    .col-lg-3 { width: 33.33333%; }
    .col-lg-9 { width: 66.66667%; }
}
@media (max-width: 992px) {
    .console-housing .row { flex-direction: column; }
    .col-lg-3, .col-lg-9 { width: 100%; border-right: none !important; border-bottom: 1px solid #e2e8f0; }
    .image-portal { display: none; }
    .masthead-spacer { display: none; }
    .ce-app-shell { height: 85vh; }
    .ce-workspace-body { flex-direction: column; overflow-y: auto; }
    .ai-sidebar { width: 100%; height: auto; border-left: none; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
}

/* --- THEATER MODE RESPONSIVE (NEW) --- */
@media (max-width: 1200px) {
    .goal-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem; padding: 1.5rem 2rem;
    }
    .flip-card-wrapper.morph-active {
    transform: perspective(1500px) rotateY(8deg);
    box-shadow: -20px 20px 60px rgba(0,0,0,0.3);}
    .split-col-right { width: 60%; }
}

@media (max-width: 768px) {
    .goal-grid {
        grid-template-columns: 1fr;
        gap: 1rem; padding: 1rem;
    }
    .flip-card-wrapper.morph-active {
        width: 100% !important;
        height: 50vh !important;
    }
    .split-col-right {
        width: 100%; top: 50vh; height: 50vh;
        border-radius: 24px 24px 0 0;
    }
    .identity-grid { grid-template-columns: 1fr; }
}

/* ================================================== */
/* =======  17. CONFIGURATION WIZARD (RIGHT)  ======= */
/* ================================================== */
/* Configuration Stage Container */
#configuration-stage {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 50; pointer-events: none;
    background: transparent;
}
#configuration-stage > * { pointer-events: auto; }

/* The Wizard Panel (Updated) */
.split-col-right {
    position: absolute; top: 0; right: 0;
    width: 65%; height: 100%;
    background: white;
    transform: translateX(100%);
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    z-index: 40;
    overflow-y: auto;
    border-radius: 24px;
    box-shadow: 0 25px 60px -15px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
    display: flex; flex-direction: column;
}
.split-col-right.visible { transform: translateX(0); }

/* --- WIZARD PANEL STYLING (MATCHES PROTOTYPE) --- */
.wizard-container {
    display: flex; flex-direction: column; height: 100%; background: white;
}

/* --- WIZARD HEADER --- */
.wizard-header {
    padding: 2rem 2.5rem 1.5rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc;
}
.wizard-label {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.65rem; font-weight: 800; letter-spacing: 0.2em;
    text-transform: uppercase; color: #0ea5e9; margin-bottom: 0.5rem;
}
.wizard-title {
    font-family: var(--font-brand), 'Righteous', cursive;
    font-size: 1.75rem; color: #0f172a; margin-bottom: 1.5rem;
}
.wizard-progress {
    width: 100%; height: 4px; background: #e2e8f0;
    border-radius: 4px; overflow: hidden; margin-bottom: 1rem;
}
.wizard-progress-bar {
    height: 100%; background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 100%);
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 4px;
}
.wizard-skip-btn {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.65rem; font-weight: 800; letter-spacing: 0.15em;
    text-transform: uppercase; color: #64748b; background: none; border: none;
    padding: 0; cursor: pointer; transition: color 0.2s;
    display: flex; align-items: center; gap: 0.5rem;
}
.wizard-skip-btn:hover { color: #0ea5e9; }

/* --- WIZARD CONTENT --- */
.wizard-content {
    flex: 1; padding: 2.5rem; overflow-y: auto;
    display: flex; flex-direction: column;
}
.wizard-step {
    display: flex; flex-direction: column; gap: 2rem;
    animation: wizard-fade-in 0.3s ease;
}
@keyframes wizard-fade-in {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}
.wizard-step-header { text-align: center; }
.wizard-step-title {
    font-family: var(--font-brand), 'Righteous', cursive;
    font-size: 2rem; color: #0f172a; margin-bottom: 0.75rem;
}
.wizard-step-desc {
    font-size: 1rem; color: #64748b; max-width: 500px; margin: 0 auto;
}

/* --- IDENTITY SELECTION GRID --- */
.wizard-identity-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
}
.wizard-identity-pill {
    display: flex; align-items: center; gap: 1rem;
    padding: 1.25rem 1.5rem; background: white; border: 2px solid #f1f5f9;
    border-radius: 16px; cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
}
.wizard-identity-pill:hover {
    border-color: #cbd5e1; transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.wizard-identity-pill.selected {
    border-color: #0ea5e9; background: #f0f9ff;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}
.wizard-identity-icon {
    width: 48px; height: 48px;
    display: flex; align-items: center; justify-content: center;
    background: #f1f5f9; border-radius: 50%; color: #64748b;
    flex-shrink: 0; font-size: 1.25rem; transition: all 0.2s;
}
.wizard-identity-pill.selected .wizard-identity-icon {
    background: #0ea5e9; color: white;
}
.wizard-identity-text { flex: 1; min-width: 0; }
.wizard-identity-text h6 {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.75rem; font-weight: 800; letter-spacing: 0.1em;
    text-transform: uppercase; color: #0f172a; margin: 0 0 0.25rem 0;
}
.wizard-identity-text p {
    font-size: 0.75rem; color: #64748b; margin: 0; line-height: 1.4;
}
.wizard-identity-check {
    color: #0ea5e9; font-size: 1.25rem; opacity: 0;
    transform: scale(0.8); transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.wizard-identity-pill.selected .wizard-identity-check {
    opacity: 1; transform: scale(1);
}

/* --- INPUT BOXES --- */
.wizard-input-box {
    background: #f8fafc; border: 2px solid #e2e8f0;
    border-radius: 16px; padding: 2rem; max-width: 500px;
    margin: 0 auto; width: 100%;
}
.wizard-input-label {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.65rem; font-weight: 800; letter-spacing: 0.15em;
    text-transform: uppercase; color: #64748b; display: block; margin-bottom: 1rem;
}
.wizard-date-input,
.wizard-select-input {
    width: 100%; font-family: var(--font-brand), 'Righteous', cursive;
    font-size: 2rem; color: #0f172a; background: transparent;
    border: none; border-bottom: 3px solid #cbd5e1;
    padding: 0.75rem 0; outline: none; transition: border-color 0.3s;
    text-align: center;
}
.wizard-date-input:focus,
.wizard-select-input:focus { border-bottom-color: #0ea5e9; }
.wizard-select-input {
    cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right center; padding-right: 2rem;
}

/* Context Hint Box */
.wizard-hint-box {
    background: #fffbeb; border: 2px solid #fde047;
    border-radius: 12px; padding: 1.25rem;
    display: flex; gap: 1rem; align-items: flex-start;
    max-width: 500px; margin: 0 auto;
    animation: wizard-fade-in 0.3s ease;
}
.wizard-hint-icon {
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
    background: #fef08a; border-radius: 50%; color: #a16207; flex-shrink: 0;
}
.wizard-hint-title {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.65rem; font-weight: 800; letter-spacing: 0.15em;
    text-transform: uppercase; color: #a16207; margin: 0 0 0.5rem 0;
}
.wizard-hint-text {
    font-size: 0.85rem; color: #78350f; line-height: 1.6; margin: 0;
}

/* --- WIZARD FOOTER --- */
.wizard-footer {
    padding: 1.5rem 2.5rem; border-top: 1px solid #e2e8f0;
    display: flex; align-items: center; justify-content: space-between;
    background: white;
}
.wizard-nav-btn {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.75rem; font-weight: 800; letter-spacing: 0.15em;
    text-transform: uppercase; padding: 0.875rem 2rem;
    border-radius: 50px; border: none; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;
}
.wizard-back-btn {
    background: transparent; color: #64748b; border: 2px solid #e2e8f0;
}
.wizard-back-btn:hover:not(:disabled) {
    background: #f8fafc; border-color: #cbd5e1; color: #0f172a;
}
.wizard-back-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.wizard-next-btn {
    background: #0f172a; color: white;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3);
}
.wizard-next-btn:hover:not(:disabled) {
    background: #1e293b; transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(15, 23, 42, 0.4);
}
.wizard-next-btn:disabled {
    background: #e2e8f0; color: #cbd5e1; box-shadow: none; cursor: not-allowed;
}
.wizard-step-indicator {
    font-family: var(--font-data), 'Antonio', sans-serif;
    font-size: 0.9rem; font-weight: 800; color: #64748b;
}
.wizard-step-indicator span { color: #0f172a; font-size: 1.1rem; }

/* --- CONTEXT & PARAMS --- */
#context-helper-box { transition: opacity 0.3s ease; }
#parameters-area.d-none { display: none !important; }

/* ================================================== */
/* ========  18. FLIGHT PLAN INPUTS & PILLS  ======== */
/* ================================================== */
.hover-lift {
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s, border-color 0.2s;
    will-change: transform, box-shadow;
}
.hover-lift:hover, 
.hover-lift:focus-within {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08) !important;
    border-color: #cbd5e1 !important;
    background-color: #ffffff !important;
}

.form-select, .form-control { cursor: pointer; }
input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0.4; cursor: pointer; transition: opacity 0.2s;
}
input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

@media (max-width: 768px) {
    .input-group-lg > .form-control,
    .input-group-lg > .form-select,
    .input-group-lg > .input-group-text {
        font-size: 1rem; padding: 0.8rem 1rem;
    }
}

/* ================================================== */
/* ========  20. WIZARD UI & SYSTEM PILLS   ========= */
/* ================================================== */
/* Animations */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.hover-scale { transition: transform 0.2s; }
.hover-scale:hover { transform: scale(1.05); }
.hover-white:hover { color: white !important; opacity: 1 !important; }

üìÜ models.py:
# models.py
import os
import json
import uuid
from datetime import date
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date, Integer, Float)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()

# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # --- CORE IDENTITY ---
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    
    # --- SCOPE & CONSTRAINTS (The MVP Project Container) ---
    domain = Column(String(100), nullable=True)     # Context for AI (e.g. "Bio-Tech")
    status = Column(String(50), default='Draft')    # Lifecycle (Draft, Active, Paused, Complete)
    owner = Column(String(255), nullable=True)      # The human champion
    target_date = Column(Date, nullable=True)       # The horizon/deadline
    system_data = Column(JsonType, nullable=True, default={})
    
    # --- METRICS ---
    integrity_score = Column(Integer, default=100)  # 0-100 Health Metric
    completion_percentage = Column(Integer, default=0) # Derived from COS completion
    
    # --- RELATIONSHIPS ---
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'domain': self.domain,
            'status': self.status,
            'owner': self.owner,
            'target_date': self.target_date.isoformat() if self.target_date else None,
            'integrity_score': self.integrity_score,
            'completion_percentage': self.completion_percentage,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    
    # --- STATUS TRACKING ---
    status = Column(String(50), nullable=False, default='Proposed') # Proposed, Active, Complete, Verified
    
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE STRATEGIC PAYLOAD ---
    # Stores the complete state of the Speculation Environment.
    # Initializing with all keys ensures the "Fresh Node" check in JS works reliably.
    data = Column(JsonType, nullable=False, default=lambda: {
        "details_data": {}, 
        "prerequisites": [],
        "stakeholders": [], 
        "assumptions": [],
        "resources": [],
        "connections": []
    })

    def to_dict(self):
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data 
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

üü© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- THE SCREEN SURFACE -->
    <div class="screen-surface d-flex flex-column position-relative overflow-hidden" style="min-height: 85vh;">
      
      <!-- 1. HEADER BAR -->
      <div id="gs-header" class="bg-white border-bottom px-5 py-4 d-flex justify-content-between align-items-center shadow-sm z-30 position-relative">
        <div class="d-flex align-items-center gap-4">
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1">Mission Parameter</div>
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display" style="font-size: 2rem;">"{{ user_input }}"</h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0" title="Edit Parameter"><i class="fas fa-pencil-alt"></i></button>
               </div>
               <div class="horizon-instruction font-body text-muted small mt-1">
                   Analogs Detected. Select Optimal Protocol Trajectory.
               </div>
           </div>
           <!-- (Edit Container Hidden) -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <div class="d-flex gap-3">
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> RE-CALCULATE
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">ABORT</a>
        </div>
      </div>

      <!-- 2. THE STAGE VIEWPORT (3D Context) -->
      <div id="stage-viewport">
        
        <!-- A. THE GALLERY GRID (Initial State) -->
        <div class="goal-grid" id="goalCardsContainer">
            {% for goal in goals %}
               <div class="flip-card-wrapper {{ 'violation' if not goal.is_compliant else '' }}" 
                    data-card-id="goal-{{ loop.index0 }}"
                    data-card-title="{{ goal.title | e }}"
                    data-color-hue="{{ goal.color_hue | default(180) }}"
                    data-goal-index="{{ loop.index0 }}"
                    onclick="window.selectGoal(this)">
                    <div class="flip-card-inner">
                        <!-- BACK (Monolith) -->
                        <div class="flip-card-back" style="background: {{ goal.card_gradient | default('linear-gradient(135deg, #00bcd4 0%, #2979ff 100%)') }};">
                            <div class="card-texture-overlay"></div>
                            <div class="monolith-content">
                                <div class="monolith-icon-circle"><i class="{{ goal.icon }} monolith-icon"></i></div>
                                {% if not goal.is_compliant %}
                                    <span class="badge bg-black bg-opacity-25 border border-danger text-white font-data px-3 py-2">PROTOCOL VIOLATION</span>
                                {% else %}
                                    <div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1">STRUCTURED SPECULATION</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- FRONT (Details) -->
                        <div class="flip-card-front">
                             <div class="card-header-plate" style="background: {{ goal.plate_gradient | default('linear-gradient(135deg, #4dd0e1 0%, #00bcd4 100%)') }};">
                                 <div class="card-texture-overlay"></div>
                                 <div class="card-domain-badge-large">{{ goal.domain | upper }}</div>
                                 <div class="card-icon-float-large"><i class="{{ goal.icon }}" style="color: {{ goal.icon_color | default('#00838f') }};"></i></div>
                             </div>
                             <div class="card-body-large">
                                 <h3 class="card-title-large">{{ goal.title }}</h3>
                                 <p class="card-desc-large">{{ goal.goal }}</p>
                             </div>
                             <div class="card-footer-large">
                                 <button type="button" class="btn-select-pill-large" style="background: {{ goal.btn_gradient | default('linear-gradient(to right, #00bcd4, #00838f)') }};">
                                     {{ 'PROTOCOL VIOLATION' if not goal.is_compliant else 'CHOOSE GOAL' }}
                                 </button>
                             </div>
                        </div>
                    </div>
               </div>
            {% endfor %}
        </div>

        <!-- B. THE CONFIGURATION WIZARD (Hidden until Morph) -->
        <div id="configuration-stage">
            <div class="split-col-right">
                <div class="wizard-container">
                    
                    <!-- HEADER -->
                    <div class="wizard-header d-flex justify-content-between align-items-center">
                        <div>
                            <div class="font-data text-primary small fw-bold tracking-widest mb-2">CONFIGURATION</div>
                            <div class="wizard-progress">
                                <div class="progress-segment active" id="prog-1"></div>
                                <div class="progress-segment" id="prog-2"></div>
                                <div class="progress-segment" id="prog-3"></div>
                            </div>
                        </div>
                        <button class="btn btn-link font-data text-muted small text-decoration-none" onclick="window.skipToSpeculate()">
                            SKIP TO SOLUTION <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>

                    <!-- CONTENT -->
                    <div class="wizard-content" id="wizard-content-area">
                        <!-- STEP 1: IDENTITY -->
                        <div class="wizard-step" id="step-1">
                            <div class="text-center mb-4">
                                <h2 class="font-brand text-dark">Who Is Driving?</h2>
                                <p class="text-muted font-body small">Select the operational entity to calibrate resource leverage.</p>
                            </div>
                            <div class="wizard-identity-grid">
                                <!-- Cards -->
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Individual', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-user"></i></div>
                                    <div class="wizard-identity-text"><h6>INDIVIDUAL AGENT</h6><p>Personal action. High autonomy.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Grassroots', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-users"></i></div>
                                    <div class="wizard-identity-text"><h6>COMMUNITY / GRASSROOTS</h6><p>Volunteer network. Driven by passion.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Team', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-rocket"></i></div>
                                    <div class="wizard-identity-text"><h6>SMALL TEAM / STARTUP</h6><p>Dedicated group. Speed & growth.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('NonProfit', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-hand-holding-heart"></i></div>
                                    <div class="wizard-identity-text"><h6>NON-PROFIT / NGO</h6><p>Mission-driven. Public trust.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Enterprise', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-building"></i></div>
                                    <div class="wizard-identity-text"><h6>CORPORATE / ENTERPRISE</h6><p>Large-scale commercial resources.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectIdentity('Public', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-landmark"></i></div>
                                    <div class="wizard-identity-text"><h6>PUBLIC / CIVIC BODY</h6><p>Regulatory authority. High leverage.</p></div>
                                </div>
                            </div>
                            <!-- Context Helper -->
                            <div id="context-helper-box" class="bg-dark text-white p-3 rounded-3 shadow-sm mt-3 d-none opacity-0">
                                <div id="context-helper-text" class="d-flex justify-content-between align-items-center"></div>
                            </div>
                        </div>

                        <!-- STEP 2: HORIZON -->
                        <div class="wizard-step d-none" id="step-2">
                            <div class="text-center mb-5">
                                <h2 class="font-brand text-dark">Target Horizon</h2>
                                <p class="text-muted font-body small">When does this possibility collapse into reality?</p>
                            </div>
                            <div class="d-flex justify-content-center">
                                <div class="p-4 border rounded-4 bg-light shadow-inner text-center" style="max-width: 400px; width: 100%;">
                                    <label class="font-data text-muted x-small tracking-widest mb-2">COMPLETION DATE</label>
                                    <input type="date" class="form-control form-control-lg font-brand p-3 text-center fs-3 border-2" 
                                           id="input-horizon" onchange="window.setHorizon(this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3: BUDGET -->
                        <div class="wizard-step d-none" id="step-3">
                            <div class="text-center mb-4">
                                <h2 class="font-brand text-dark">Resource Model</h2>
                                <p class="text-muted font-body small">Define the economic physics for this system.</p>
                            </div>
                            <div class="list-group wizard-identity-grid">
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Bootstrapped', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-hammer"></i></div>
                                    <div class="wizard-identity-text"><h6>BOOTSTRAPPED ($0)</h6><p>Sweat equity and bartering.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Crowdfunded', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-bullhorn"></i></div>
                                    <div class="wizard-identity-text"><h6>CROWDFUNDED</h6><p>Public backing and engagement.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Grant Funded', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-file-signature"></i></div>
                                    <div class="wizard-identity-text"><h6>GRANT FUNDED</h6><p>Compliance-heavy, slow release.</p></div>
                                </div>
                                <div class="wizard-identity-pill" onclick="window.selectBudget('Venture Capital', this)">
                                    <div class="wizard-identity-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="wizard-identity-text"><h6>VENTURE CAPITAL</h6><p>High growth, equity exchange.</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="wizard-footer border-top p-3 d-flex justify-content-between align-items-center bg-white mt-auto">
                        <button class="btn btn-link text-muted font-data small text-decoration-none" onclick="window.resetStage()">
                            <i class="fas fa-chevron-left me-1"></i> BACK
                        </button>
                        <div class="font-data text-muted small opacity-50" id="step-counter">1 / 3</div>
                        <button class="btn btn-dark rounded-pill px-4 font-data small shadow-sm" id="btn-next" disabled onclick="window.nextStep()">
                            NEXT <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- 3. PAGE FOOTER -->
      <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-white border-top mt-auto flex-shrink-0 z-20 position-relative">
         <div class="d-flex gap-2">
            <!-- Dynamic color dots based on goal palettes -->
            {% if goals and goals|length > 0 %}
                {% for goal in goals[:3] %}
                <div class="rounded-circle shadow-sm {% if loop.first %}animate-pulse{% endif %}" 
                     style="width: 8px; height: 8px; background: {{ goal.accent_color | default('#00bcd4') }};">
                </div>
                {% endfor %}
            {% else %}
                <div class="rounded-circle bg-success shadow-sm animate-pulse" style="width: 8px; height: 8px;"></div>
                <div class="rounded-circle bg-warning shadow-sm" style="width: 8px; height: 8px;"></div>
                <div class="rounded-circle bg-info shadow-sm" style="width: 8px; height: 8px;"></div>
            {% endif %}
         </div>
         <span class="font-data text-muted small letter-spacing-2">SSPEC HORIZON v2025.33</span>
      </div>
    </div>
  </div>
</div>

<!-- HIDDEN SUBMISSION FORM -->
<form id="final-submit-form" method="POST" action="{{ url_for('routes_bp.outcome') }}" class="d-none">
    <input type="hidden" name="selected_goal" id="form-goal">
    <input type="hidden" name="selected_goal_title" id="form-title">
    <input type="hidden" name="domain" id="form-domain">
    <input type="hidden" name="domain_icon" id="form-domain-icon">
    
    <input type="hidden" name="system_operator" id="form-operator">
    <input type="hidden" name="system_horizon" id="form-horizon">
    <input type="hidden" name="system_budget" id="form-budget">
</form>
{% endblock %}

{% block scripts %}
<script>
    window.GOAL_COLOR_DATA = {{ goals | tojson | safe }};
</script>
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
{% endblock %}

üüß ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

üì± app.py:
# app.py (Auto-Migration Logic Added)
import os
import sys
import logging
import asyncio
from flask import Flask
from flask_migrate import Migrate
from dotenv import load_dotenv
from models import db
from sqlalchemy import text

# --- RICH UI LIBRARY ---
from rich.console import Console
from rich.theme import Theme
from rich.panel import Panel
from rich.table import Table
from rich.text import Text
from rich.logging import RichHandler

# Local Imports
from ce_nodes import NODES

# --- 1. CONFIGURATION & THEME ---
# Windows Asyncio Fix
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

load_dotenv()

# Define MS365 Palette
ms365_theme = Theme({
    "white": "#FFFFFF",
    "tan": "#CC3802",      # Access/PowerPoint-ish
    "teal": "#047E84",     # Excel-ish
    "plum": "#9A348E",     # OneNote/Teams-ish
    "blush": "#DA627D",
    "salmon": "#FCA17D",
    "mint": "#64C5B1",
    "sky": "#86BBD8",      # Word/Outlook-ish
    "teal_blue": "#33658A",
    "info": "#86BBD8",
    "warning": "#FCA17D",
    "danger": "#CC3802",
    "success": "#64C5B1"
})

# Initialize Rich Console
console = Console(theme=ms365_theme)

# Configure Logging to use RichHandler (Pretty logs with timestamps)
logging.basicConfig(
    level="INFO",
    format="%(message)s",
    datefmt="[%X]",
    handlers=[RichHandler(console=console, rich_tracebacks=True, markup=True, show_path=False)]
)
logger = logging.getLogger("rich")

# --- 2. FLASK INIT ---
app = Flask(__name__)
migrate = Migrate()

app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

# --- 3. DATABASE SETUP & MIGRATIONS ---
if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    db.init_app(app)
    migrate.init_app(app, db)
    
    # --- AUTO-MIGRATION CHECK ---
    with app.app_context():
        try:
            with db.engine.connect() as conn:
                try:
                    # Check if system_data column exists
                    conn.execute(text("SELECT system_data FROM ssol LIMIT 1"))
                except Exception:
                    logger.warning("[tan]Column 'system_data' missing in 'ssol'. Attempting to add it...[/tan]")
                    conn.execute(text("ALTER TABLE ssol ADD COLUMN system_data TEXT"))
                    conn.commit()
                    logger.info("[success]Successfully added 'system_data' column.[/success]")
        except Exception as e:
            # Swallow error if table doesn't exist yet (first run)
            logger.debug(f"[sky]Auto-migration check skipped (fresh DB): {e}[/sky]")

# --- 4. TEMPLATE FILTERS & PROCESSORS ---
@app.template_filter()
def get_badge_class_from_status(status):
    return {
        'Proposed': 'bg-info',
        'In Progress': 'bg-warning text-dark',
        'Completed': 'bg-success',
        'Rejected': 'bg-danger'
    }.get(status, 'bg-secondary')

@app.context_processor
def inject_nodes():
    from system_nodes import SYSTEM_NODES
    return dict(nodes=NODES, system_nodes=SYSTEM_NODES)

# --- 5. ROUTES ---
from routes import routes_bp
app.register_blueprint(routes_bp)

# --- 6. STARTUP DASHBOARD ---
def print_startup_banner():
    console.clear()
    
    # Construct the Grid for System Stats
    sys_info = Table.grid(padding=1)
    sys_info.add_row("[tan]Runtime:[/tan]", f"[white]Python {sys.version.split()[0]}[/white]")
    sys_info.add_row("[tan]Framework:[/tan]", "[white]Flask[/white]")
    sys_info.add_row("[tan]Storage:[/tan]", f"[sky]{'Postgres/SQLite' if USE_DATABASE else 'In-Memory Dictionary'}[/sky]")
    sys_info.add_row("[tan]Status:[/tan]", "[mint]ONLINE[/mint]")

    # Create the Dashboard Panel
    main_panel = Panel(
        sys_info,
        title="[bold white]SSPEC HORIZON v2025.33[/bold white]",
        border_style="teal",
        subtitle="[blush]Serving at http://127.0.0.1:5000[/blush]",
        padding=(1, 4),
        expand=False
    )
    
    # Print the Layout
    console.print("\n")
    console.print(Text(" POSSIBILITY PATHFINDER ", style="bold white on plum"), justify="center")
    console.print("\n")
    console.print(main_panel, justify="center")
    console.print("\n")

if __name__ == '__main__':
    # Render the TUI
    print_startup_banner()
    
    # Suppress the default boring Flask banner
    cli = sys.modules['flask.cli']
    cli.show_server_banner = lambda *x: None
    
    # Run App
    app.run(debug=True, port=5000)

üü® utilities.py:
# utilities.py

import logging
import json
import re
import colorsys
import hashlib
from typing import Dict, List, Tuple, Optional
from bs4 import BeautifulSoup
from flask import current_app

# Import AI services
from ai_service import generate_chat_response, get_grounded_data, generate_image

# Local Imports
from ce_nodes import NODES, get_valid_node_types
from system_nodes import SYSTEM_NODES, get_valid_system_types

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO)

# ==============================================================================
# PHASE COLOR VOCABULARY (SEMANTIC ANCHORS - DO NOT GENERATE THESE)
# ==============================================================================
# These are intentional design tokens, not computed values.
# They carry semantic weight and must remain stable.
# Tuned for: distinctiveness, accessibility, emotional legibility

PHASE_COLORS = {
    0: {  # DISCOVERY
        'name': 'Discovery',
        'hue': 187,           # Cyan-Teal
        'saturation': 0.72,
        'lightness': 0.58,
        'hex': '#17a2b8',
        'hex_light': '#4dd0e1',
        'hex_dark': '#00838f',
        'semantic': 'exploration, research, possibility'
    },
    1: {  # ENGAGEMENT
        'name': 'Engagement',
        'hue': 262,           # Purple-Violet
        'saturation': 0.52,
        'lightness': 0.47,
        'hex': '#6f42c1',
        'hex_light': '#9575cd',
        'hex_dark': '#512da8',
        'semantic': 'connection, collaboration, dialogue'
    },
    2: {  # ACTION
        'name': 'Action',
        'hue': 24,            # Orange-Amber
        'saturation': 0.85,
        'lightness': 0.54,
        'hex': '#e8590c',
        'hex_light': '#ff8a50',
        'hex_dark': '#bf360c',
        'semantic': 'execution, momentum, delivery'
    },
    3: {  # COMPLETION
        'name': 'Completion',
        'hue': 145,           # Green-Emerald
        'saturation': 0.63,
        'lightness': 0.42,
        'hex': '#28a745',
        'hex_light': '#66bb6a',
        'hex_dark': '#1b5e20',
        'semantic': 'achievement, validation, closure'
    },
    4: {  # LEGACY
        'name': 'Legacy',
        'hue': 340,           # Rose-Magenta
        'saturation': 0.65,
        'lightness': 0.50,
        'hex': '#d63384',
        'hex_light': '#f06292',
        'hex_dark': '#ad1457',
        'semantic': 'impact, sustainability, continuity'
    }
}

# ==============================================================================
# PHASE SELECTION (Hash to Semantic Anchor)
# ==============================================================================

def text_to_phase_index(text: str) -> int:
    """
    Maps text to one of the 5 phase indices deterministically.
    This is NOT arbitrary hashing - it selects from a finite semantic vocabulary.
    
    The goal title determines which PHASE anchors the entire palette.
    """
    if not text:
        return 0  # Default to Discovery
    
    # Create stable hash
    hash_obj = hashlib.md5(text.lower().strip().encode('utf-8'))
    hash_int = int(hash_obj.hexdigest()[:8], 16)
    
    # Map to phase index (0-4)
    phase_index = hash_int % 5
    
    return phase_index


def get_phase_anchor(text: str) -> Dict:
    """
    Returns the Phase color that will anchor the palette for this goal.
    This is a semantic token, not a generated color.
    """
    phase_index = text_to_phase_index(text)
    return {
        'index': phase_index,
        **PHASE_COLORS[phase_index]
    }


# ==============================================================================
# HARMONIC COLOR GENERATION (Relative to Phase Anchor)
# ==============================================================================

def hsl_to_hex(h: float, s: float, l: float) -> str:
    """
    Converts HSL (h in degrees, s/l in 0-1) to hex string.
    """
    # Normalize hue to 0-1 range
    h_norm = (h % 360) / 360.0
    
    # Convert HSL to RGB
    if s == 0:
        r = g = b = l
    else:
        def hue_to_rgb(p, q, t):
            if t < 0: t += 1
            if t > 1: t -= 1
            if t < 1/6: return p + (q - p) * 6 * t
            if t < 1/2: return q
            if t < 2/3: return p + (q - p) * (2/3 - t) * 6
            return p
        
        q = l * (1 + s) if l < 0.5 else l + s - l * s
        p = 2 * l - q
        r = hue_to_rgb(p, q, h_norm + 1/3)
        g = hue_to_rgb(p, q, h_norm)
        b = hue_to_rgb(p, q, h_norm - 1/3)
    
    # Convert to hex
    return '#{:02x}{:02x}{:02x}'.format(
        int(round(r * 255)),
        int(round(g * 255)),
        int(round(b * 255))
    )


def generate_near_harmonic(phase: Dict, seed: str = '') -> Dict:
    """
    Generates Card 2: Near Harmonic
    
    Purpose: Cohesion, visual calm, reads as "related"
    
    Rules:
    - Hue: Phase ¬± 20-40¬∞
    - Chroma: 0.6-0.8 √ó Phase chroma
    - Lightness: Phase + small lift
    """
    base_hue = phase['hue']
    base_sat = phase['saturation']
    base_light = phase['lightness']
    
    # Deterministic offset based on seed
    if seed:
        seed_hash = int(hashlib.md5(seed.encode()).hexdigest()[:4], 16)
    else:
        seed_hash = 1234
    
    # Hue offset: ¬±20-40¬∞ (biased by seed)
    hue_offset = 20 + (seed_hash % 21)  # 20-40
    hue_direction = 1 if (seed_hash % 2) == 0 else -1
    new_hue = (base_hue + (hue_offset * hue_direction)) % 360
    
    # Saturation: 60-80% of original
    sat_factor = 0.60 + ((seed_hash % 21) / 100)  # 0.60-0.80
    new_sat = min(1.0, base_sat * sat_factor)
    
    # Lightness: slight lift (+5-15%)
    light_lift = 0.05 + ((seed_hash % 11) / 100)  # 0.05-0.15
    new_light = min(0.85, base_light + light_lift)
    
    hex_primary = hsl_to_hex(new_hue, new_sat, new_light)
    hex_light = hsl_to_hex(new_hue, new_sat * 0.7, min(0.92, new_light + 0.15))
    hex_dark = hsl_to_hex(new_hue, min(1.0, new_sat * 1.1), max(0.25, new_light - 0.18))
    
    return {
        'role': 'near_harmonic',
        'hue': new_hue,
        'saturation': new_sat,
        'lightness': new_light,
        'hex': hex_primary,
        'hex_light': hex_light,
        'hex_dark': hex_dark,
        'relationship': f"Near harmonic of {phase['name']} (Hue {hue_direction * hue_offset:+}¬∞)"
    }


def generate_distant_harmonic(phase: Dict, seed: str = '') -> Dict:
    """
    Generates Card 3: Distant Harmonic
    
    Purpose: Distinction, energy, avoids clashes via capped chroma
    
    Rules:
    - Hue: Phase ¬± 90-140¬∞ (biased, not symmetric)
    - Chroma: ‚â§ Phase chroma
    - Lightness: Phase - small drop
    """
    base_hue = phase['hue']
    base_sat = phase['saturation']
    base_light = phase['lightness']
    
    # Deterministic offset based on seed
    if seed:
        seed_hash = int(hashlib.md5(seed.encode()).hexdigest()[:4], 16)
    else:
        seed_hash = 5678
    
    # Hue offset: 90-140¬∞ (biased direction)
    hue_offset = 90 + (seed_hash % 51)  # 90-140
    # Bias toward clockwise for visual distinction
    hue_direction = 1 if (seed_hash % 3) != 0 else -1
    new_hue = (base_hue + (hue_offset * hue_direction)) % 360
    
    # Saturation: capped at phase saturation (0.7-1.0x)
    sat_factor = 0.70 + ((seed_hash % 31) / 100)  # 0.70-1.00
    new_sat = min(base_sat, base_sat * sat_factor)
    
    # Lightness: slight drop (-5-12%)
    light_drop = 0.05 + ((seed_hash % 8) / 100)  # 0.05-0.12
    new_light = max(0.30, base_light - light_drop)
    
    hex_primary = hsl_to_hex(new_hue, new_sat, new_light)
    hex_light = hsl_to_hex(new_hue, new_sat * 0.7, min(0.90, new_light + 0.18))
    hex_dark = hsl_to_hex(new_hue, min(1.0, new_sat * 1.1), max(0.22, new_light - 0.15))
    
    return {
        'role': 'distant_harmonic',
        'hue': new_hue,
        'saturation': new_sat,
        'lightness': new_light,
        'hex': hex_primary,
        'hex_light': hex_light,
        'hex_dark': hex_dark,
        'relationship': f"Distant harmonic of {phase['name']} (Hue {hue_direction * hue_offset:+}¬∞)"
    }


# ==============================================================================
# PALETTE GENERATION (Full Card Set)
# ==============================================================================

def generate_card_gradient(color: Dict) -> str:
    """Generates a CSS gradient string for a card background."""
    return f"linear-gradient(135deg, {color['hex_light']} 0%, {color['hex']} 50%, {color['hex_dark']} 100%)"


def generate_plate_gradient(color: Dict) -> str:
    """Generates a lighter gradient for header plates."""
    return f"linear-gradient(135deg, {color['hex_light']} 0%, {color['hex']} 100%)"


def generate_button_gradient(color: Dict) -> str:
    """Generates a gradient for buttons."""
    return f"linear-gradient(to right, {color['hex']} 0%, {color['hex_dark']} 100%)"


def build_card_palette(color: Dict, role: str) -> Dict:
    """
    Builds the full palette dict for a single card.
    """
    return {
        'color_role': role,
        'color_hue': color['hue'],
        'color_saturation': color['saturation'],
        'color_lightness': color['lightness'],
        'card_gradient': generate_card_gradient(color),
        'plate_gradient': generate_plate_gradient(color),
        'btn_gradient': generate_button_gradient(color),
        'icon_color': color['hex_dark'],
        'accent_color': color['hex'],
        'accent_light': color['hex_light'],
        'accent_dark': color['hex_dark'],
        'text_on_color': '#ffffff',
        'color_relationship': color.get('relationship', 'Phase Anchor')
    }


def assign_goal_colors(goals: List[Dict]) -> List[Dict]:
    """
    Assigns phase-anchored harmonic colors to a list of goals.
    
    Color Architecture:
    1. Card 0 (Phase Anchor): Semantic token from PHASE_COLORS vocabulary
    2. Card 1 (Near Harmonic): Cohesive, subordinate, stabilizing
    3. Card 2 (Distant Harmonic): Contrasting but capped chroma
    
    Args:
        goals: List of goal dictionaries with at least 'title' key
        
    Returns:
        Goals list with color properties added
    """
    if not goals:
        return goals
    
    # Get the first goal's title to determine Phase Anchor
    anchor_title = goals[0].get('title', 'default goal')
    phase_anchor = get_phase_anchor(anchor_title)
    
    current_app.logger.info(
        f"Phase Anchor: '{anchor_title}' ‚Üí {phase_anchor['name']} "
        f"(Phase {phase_anchor['index']}, Hue {phase_anchor['hue']}¬∞)"
    )
    
    # Generate harmonic companions
    near_harmonic = generate_near_harmonic(phase_anchor, anchor_title + '_near')
    distant_harmonic = generate_distant_harmonic(phase_anchor, anchor_title + '_distant')
    
    current_app.logger.info(f"Near Harmonic: Hue {near_harmonic['hue']:.0f}¬∞ ({near_harmonic['relationship']})")
    current_app.logger.info(f"Distant Harmonic: Hue {distant_harmonic['hue']:.0f}¬∞ ({distant_harmonic['relationship']})")
    
    # Color assignment order
    color_slots = [
        (phase_anchor, 'phase_anchor'),
        (near_harmonic, 'near_harmonic'),
        (distant_harmonic, 'distant_harmonic')
    ]
    
    for i, goal in enumerate(goals):
        # Handle non-compliant goals (override with danger theme)
        if not goal.get('is_compliant', True):
            goal.update({
                'color_role': 'violation',
                'color_hue': 0,
                'card_gradient': 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 50%, #b71c1c 100%)',
                'plate_gradient': 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%)',
                'btn_gradient': 'linear-gradient(to right, #ef5350 0%, #c62828 100%)',
                'icon_color': '#b71c1c',
                'accent_color': '#ef5350',
                'accent_light': '#ffcdd2',
                'accent_dark': '#b71c1c',
                'phase_anchor_index': phase_anchor['index'],
                'phase_anchor_name': phase_anchor['name']
            })
            continue
        
        # Assign color based on position (cycle if more than 3 goals)
        color_data, role = color_slots[i % 3]
        palette = build_card_palette(color_data, role)
        
        # Add phase context (all cards know their anchor)
        palette['phase_anchor_index'] = phase_anchor['index']
        palette['phase_anchor_name'] = phase_anchor['name']
        
        goal.update(palette)
        
        current_app.logger.debug(
            f"Goal '{goal.get('title', 'Untitled')}' ‚Üí {role} "
            f"(Hue {color_data['hue']:.0f}¬∞)"
        )
    
    return goals


# ==============================================================================
# PHASE COLORS FOR OUTCOME PAGE (COS Phases)
# ==============================================================================

def get_phase_color_for_cos(phase_name: str) -> Dict:
    """
    Returns the semantic phase color for a COS phase.
    Maps phase names to the PHASE_COLORS vocabulary.
    """
    phase_mapping = {
        'discovery': 0,
        'engagement': 1,
        'action': 2,
        'completion': 3,
        'legacy': 4
    }
    
    phase_key = phase_name.lower().strip()
    phase_index = phase_mapping.get(phase_key, 0)
    phase_data = PHASE_COLORS[phase_index]
    
    return {
        'index': phase_index,
        'name': phase_data['name'],
        'hex': phase_data['hex'],
        'hex_light': phase_data['hex_light'],
        'hex_dark': phase_data['hex_dark'],
        'gradient': f"linear-gradient(135deg, {phase_data['hex_light']} 0%, {phase_data['hex']} 100%)",
        'semantic': phase_data['semantic']
    }


def get_all_phase_colors() -> List[Dict]:
    """
    Returns all phase colors in order for use in outcome rendering.
    """
    return [
        {
            'index': i,
            'name': phase['name'],
            'hex': phase['hex'],
            'hex_light': phase['hex_light'],
            'hex_dark': phase['hex_dark'],
            'gradient': f"linear-gradient(135deg, {phase['hex_light']} 0%, {phase['hex']} 100%)",
            'semantic': phase['semantic']
        }
        for i, phase in PHASE_COLORS.items()
    ]


# ==============================================================================
# CE & SYSTEM PILL COLORS (Harmonized with Phase Context)
# ==============================================================================

def get_ce_pill_color(ce_type: str, phase_index: Optional[int] = None) -> Dict[str, str]:
    """
    Gets colors for a CE pill, harmonized with the current phase context.
    
    If phase_index is provided, generates a complementary color.
    Otherwise falls back to the CE node's default color.
    """
    node_config = NODES.get(ce_type, NODES.get('Default', {}))
    default_color = node_config.get('color', '#6c757d')
    
    if phase_index is not None and phase_index in PHASE_COLORS:
        phase = PHASE_COLORS[phase_index]
        # Generate split-complementary for CE pills
        ce_hue = (phase['hue'] + 150) % 360
        ce_hex = hsl_to_hex(ce_hue, phase['saturation'] * 0.8, phase['lightness'] + 0.05)
        ce_dark = hsl_to_hex(ce_hue, phase['saturation'] * 0.9, phase['lightness'] - 0.15)
        
        return {
            'background': ce_hex,
            'icon_bg': '#ffffff',
            'icon_color': ce_dark,
            'text': '#ffffff'
        }
    
    return {
        'background': default_color,
        'icon_bg': '#ffffff',
        'icon_color': default_color,
        'text': '#ffffff'
    }


def get_system_pill_color(sys_type: str, phase_index: Optional[int] = None) -> Dict[str, str]:
    """
    Gets colors for a system anchor pill, harmonized with phase context.
    """
    sys_config = SYSTEM_NODES.get(sys_type, SYSTEM_NODES.get('CUSTOM', {}))
    default_color = sys_config.get('color', '#64748b')
    
    if phase_index is not None and phase_index in PHASE_COLORS:
        phase = PHASE_COLORS[phase_index]
        # Analogous offset for system pills
        sys_hue = (phase['hue'] + 30) % 360
        sys_hex = hsl_to_hex(sys_hue, phase['saturation'] * 0.7, phase['lightness'] + 0.1)
        sys_dark = hsl_to_hex(sys_hue, phase['saturation'] * 0.85, phase['lightness'] - 0.1)
        
        return {
            'background': sys_hex,
            'border': sys_dark,
            'icon_color': '#ffffff',
            'text': sys_dark
        }
    
    return {
        'background': default_color,
        'border': default_color,
        'icon_color': '#ffffff',
        'text': default_color
    }


# ==============================================================================
# TEXT PARSING & FORMATTING
# ==============================================================================

def replace_ce_tags_with_pills(content: str, phase_index: Optional[int] = None) -> str:
    """
    Parses <ce type="Risk">Text</ce> tags into styled CE Capsule pills.
    
    Args:
        content: HTML string with <ce> tags
        phase_index: Optional phase index for color harmony (0-4)
    """
    if not content:
        return ""

    soup = BeautifulSoup(str(content), 'html.parser')
    ce_tags = soup.find_all('ce')

    for tag in ce_tags:
        ce_id_str = tag.get('id')
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        
        # Get harmonized or default colors
        colors = get_ce_pill_color(ce_type, phase_index)
        
        # Get icon from node config
        node_config = NODES.get(ce_type, NODES['Default'])
        icon_cls = node_config.get('icon', 'fa-solid fa-cube')

        # Build the pill
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-capsule',
            'data-ce-id': ce_id_str,
            'data-ce-type': ce_type,
            'title': f"{ce_type} | Click to Open Speculation Engine",
            'style': f"--node-color: {colors['background']}; --node-icon-color: {colors['icon_color']};"
        })
        
        icon_i = soup.new_tag('i', attrs={'class': icon_cls})
        new_tag.append(icon_i)
        new_tag.append(soup.new_string(ce_text))
        
        tag.replace_with(new_tag)

    return str(soup)


def replace_sys_tags_with_highlights(content: str, phase_index: Optional[int] = None) -> str:
    """
    Parses <sys type="BUDGET">Value</sys> tags into styled system pills.
    
    Args:
        content: HTML string with <sys> tags  
        phase_index: Optional phase index for color harmony (0-4)
    """
    if not content:
        return ""
    
    soup = BeautifulSoup(str(content), 'html.parser')
    sys_tags = soup.find_all('sys')

    for tag in sys_tags:
        sys_type = tag.get('type', 'CUSTOM').upper()
        sys_text = tag.get_text()
        
        # Get harmonized or default colors
        colors = get_system_pill_color(sys_type, phase_index)
        
        # Get config
        config = SYSTEM_NODES.get(sys_type, SYSTEM_NODES.get('CUSTOM', {}))
        icon = config.get('icon', 'fa-tag')

        # Build wrapper
        wrapper = soup.new_tag('span', attrs={
            'class': 'sys-highlight',
            'data-type': sys_type,
            'title': f"{config.get('label', sys_type)}: {sys_text}",
            'style': f"--sys-color: {colors['background']}; --sys-border: {colors['border']};"
        })
        
        # Icon circle
        icon_span = soup.new_tag('span', attrs={'class': 'sys-highlight-icon'})
        icon_i = soup.new_tag('i', attrs={'class': icon})
        icon_span.append(icon_i)
        wrapper.append(icon_span)
        
        # Text label
        text_span = soup.new_tag('span', attrs={'class': 'sys-highlight-text'})
        text_span.string = sys_text
        wrapper.append(text_span)
        
        tag.replace_with(wrapper)

    return str(soup)


def format_ssol_text(content: str, phase_index: Optional[int] = None) -> str:
    """
    Master formatter for SSOL Summaries with optional phase-aware color harmony.
    """
    step_one = replace_sys_tags_with_highlights(content, phase_index)
    final_output = replace_ce_tags_with_pills(step_one, phase_index)
    return final_output


# ==============================================================================
# GOAL GENERATION
# ==============================================================================

async def generate_goal(user_input: str) -> List[Dict]:
    """
    Generates goal options with phase-anchored harmonic color palettes.
    """
    prompt = f"""
    Based on the user input '{user_input}', generate three distinct, high-level goal options. 
    
    OUTPUT REQUIREMENTS:
    1. Respond with a valid JSON Array of 3 objects.
    2. Each object must strictly follow this schema:
       {{
         "domain": "String",
         "title": "String",
         "goal": "String",
         "icon": "FontAwesome Class String (e.g. 'fa-solid fa-rocket')",
         "is_compliant": Boolean
       }}
    3. Ensure all keys are quoted.
    4. Ensure all string values are properly escaped.
    5. Ensure commas separate all key-value pairs and array items.
    
    ICON RULES: Use 'FontAwesome 6 Free' solid icons (fa-solid fa-*).
    """
    
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(
            messages, 
            role="user", 
            task="goal generation", 
            system_instruction="You are a strict JSON generator. No markdown. No trailing commas.",
            generation_config={"response_mime_type": "application/json", "temperature": 0.7}
        )
        
        # --- JSON Extraction & Repair ---
        cleaned = response_str.strip()
        
        if cleaned.startswith("```"):
            cleaned = re.sub(r"^```(?:json)?", "", cleaned).strip()
        if cleaned.endswith("```"):
            cleaned = re.sub(r"```$", "", cleaned).strip()

        match = re.search(r'\[.*\]', cleaned, re.DOTALL)
        if match:
            cleaned = match.group(0)
        
        try:
            ai_goals = json.loads(cleaned)
        except json.JSONDecodeError as e:
            logging.warning(f"JSON Parse Error: {e}. Attempting repairs...")
            
            # Repair strategies
            repaired = re.sub(r'\}\s*\{', '}, {', cleaned)
            repaired = re.sub(r'\"\s*\n\s*\"', '",\n"', repaired)
            
            try:
                ai_goals = json.loads(repaired)
                logging.info("JSON successfully repaired.")
            except json.JSONDecodeError:
                logging.error("Failed to repair JSON. Returning empty.")
                return []

        # Validate and normalize
        validated_goals = []
        for goal in ai_goals:
            if not isinstance(goal, dict):
                continue
            validated_goals.append({
                'domain': goal.get('domain', 'General'),
                'title': goal.get('title', 'Untitled Goal'),
                'goal': goal.get('goal', 'No description provided.'),
                'icon': goal.get('icon', 'fa-solid fa-question-circle'),
                'is_compliant': goal.get('is_compliant', goal.get('iscompliant', True))
            })
        
        # *** APPLY PHASE-ANCHORED COLOR SYSTEM ***
        validated_goals = assign_goal_colors(validated_goals)
        
        return validated_goals

    except Exception as e:
        logging.error(f"Error in generate_goal: {e}", exc_info=True)
        return []


# ==============================================================================
# OUTCOME GENERATION
# ==============================================================================

async def generate_outcome_data(ssol_title, ssol_description, domain, forced_constraints=None):
    """
    The SPECULATE Engine v2026.
    
    METHODOLOGY: FUTURE-BACK ENGINEERING
    This function creates the SSOL (Structured Solution). 
    It parses abstract "Possibilities" (even nonsense/word-salad) into 
    mechanical Conditions of Satisfaction (COS) and Conditional Elements (CE).
    """
    node_types_str = ', '.join(get_valid_node_types())
    sys_types_str = ', '.join(get_valid_system_types())
    
    constraint_text = ""
    if forced_constraints:
        constraint_text = "\n*** HARD SYSTEM PHYSICS (ATTENUATION LAYER) ***\n"
        for k, v in forced_constraints.items():
            constraint_text += f"- {k}: {v}\n"
        constraint_text += "These constraints are the immutable laws of this project's universe.\n"

    prompt = f"""
    IDENTITY: You are the SPECULATE ENGINE. You do not "suggest" or "brainstorm." 
    You are a Strategic Logic Processor designed to reverse-engineer reality from a future state.

    INPUT DATA (THE POSSIBILITY):
    Title: '{ssol_title}'
    Context: {ssol_description}
    Domain: '{domain}'
    {constraint_text}

    *** THE CHALLENGE: PARSING ABSTRACTION ***
    The User Input may be abstract, metaphorical, or "word salad" (e.g., "A world of pure light").
    Your Prime Directive is to ground this into tangible, execute-able MECHANICS.
    Ask: "If this abstract future EXITS as a fact, what infrastructure, sociology, and resources make it so?"

    *** METHODOLOGY: FUTURE-BACK ENGINEERING ***
    1.  **TIME-SHIFT:** Assume the goal is ALREADY 100% COMPLETE. It is history.
    2.  **DECONSTRUCT:** Break the "Possibility" down into "Conditions of Satisfaction" (COS).
    3.  **ATTENUATE:** Apply the implicit physics (Time, Budget, Operator) to every node.

    *** EXECUTION PROTOCOL ***

    PHASE 1: INFER SYSTEM ANCHORS (The Physics)
    Determine the constraints required for this reality to hold true.
    - WHO (Operator): What entity executed this? (An Individual, DAO, Corp, NGO, Cult, Algorithm?)
    - WHEN (Horizon): What is the calculated time-to-fulfillment?
    - HOW (Budget/Scale): What was the fuel source?
    Valid Types: {sys_types_str}.

    PHASE 2: EXECUTIVE CHARTER (The Narrative)
    Write a concise, authoritative summary of the *completed* project.
    - Use <sys type="TYPE">Value</sys> tags to highlight System Anchors.
    - Tone: Professional, past-tense, engineered clarity.

    PHASE 3: PHASE STRUCTURE (The Roadmap)
    Define 3-5 "Conditions of Satisfaction" (COS) for each Phase.
    - Each COS must be a specific, measurable state that was achieved.
    - Embed "Conditional Elements" (CEs) using <ce type="ValidType">Label</ce>.
    - CEs are the Atomic Units of the solution (The 'What').

    **Phases of the Doctrine:**
    1. Discovery (The Setup / Research)
    2. Engagement (The Network / Stakeholders)
    3. Action (The Build / Praxis)
    4. Completion (The Verification / Success)
    5. Legacy (The Impact / Sustainability)

    Valid CE Node Types: {node_types_str}.

    *** RESPONSE FORMAT (JSON ONLY) ***
    {{
        "ssolsummary": "<p>The <sys type='OPERATOR'>Global Unity DAO</sys> successfully harmonized...</p>",
        "system_params": {{
            "HORIZON": "2030-01-01",
            "OPERATOR": "Decentralized Network",
            "SCALE": "Planetary",
            "DIRECTIVE": "Radical Empathy"
        }},
        "phases": {{
            "Discovery": ["Mapped the <ce type='Research'>Psychological Baselines</ce>...", "..."],
            "Engagement": [...],
            "Action": [...],
            "Completion": [...],
            "Legacy": [...]
        }}
    }}
    """
    
    messages = [{"role": "user", "content": prompt}]
    
    # We use a lower temperature to enforce "Engine" logic over "Creative" fluff
    response_str = await generate_chat_response(
        messages, role="user", task="SPECULATE Engine Run", temperature=0.3
    )
    
    clean_json = response_str.replace("```json", "").replace("```", "").strip()
    
    try:
        result = json.loads(clean_json)
        
        # Get phase anchor from title for consistent theming
        phase_anchor = get_phase_anchor(ssol_title)
        result['phase_anchor_index'] = phase_anchor['index']
        result['phase_anchor_name'] = phase_anchor['name']
        result['phase_colors'] = get_all_phase_colors()
        
        return result
        
    except json.JSONDecodeError:
        logging.error(f"SPECULATE Engine Failure. Raw Output: {clean_json}")
        # Fallback structural return
        return {
            "ssolsummary": "<p>The SPECULATE Engine encountered interference parsing this timeline.</p>",
            "phases": {},
            "system_params": {},
            "phase_anchor_index": 0,
            "phase_anchor_name": "Discovery",
            "phase_colors": get_all_phase_colors()
        }


# ==============================================================================
# ADDITIONAL UTILITY FUNCTIONS
# ==============================================================================

async def analyze_user_input(user_text: str) -> List[str]:
    prompt = f'Analyze text and extract 3-5 key keywords. Text: "{user_text}". Return JSON: {{ "keywords": [] }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(
            messages, role="user", task="keyword extraction", 
            generation_config={"response_mime_type": "application/json"}
        )
        return json.loads(response_str).get('keywords', [])
    except Exception:
        return []


async def is_input_compliant(user_text: str) -> dict:
    prompt = f'Analyze compliance. Text: "{user_text}". Return JSON: {{ "compliant": boolean, "reason": string }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(
            messages, role="user", task="compliance check", 
            generation_config={"response_mime_type": "application/json"}
        )
        result = json.loads(response_str)
        return {"compliant": result.get('compliant', True), "reason": result.get('reason', '')}
    except Exception:
        return {"compliant": False, "reason": "System error."}


async def generate_ai_data(node_type: str, cos_content: str, ssol_goal: str, agent_mode: str = 'context') -> dict:
    """Generates context data for a specific Node Modal."""
    try:
        if agent_mode == 'speculate':
            return await get_grounded_data(f"Research {node_type} for {ssol_goal}", node_type)
        else:
            prompt = f"Briefly explain the strategic purpose of this '{node_type}' element. Context: Goal '{ssol_goal}', Requirement '{cos_content}'. Return JSON with key 'contextual_description'."
            messages = [{"role": "user", "content": prompt}]
            
            response_str = await generate_chat_response(
                messages, role="user", task="contextual insight",
                generation_config={"response_mime_type": "application/json", "temperature": 0.7}
            )
            
            cleaned = response_str.replace("```json", "").replace("```", "").strip()
            return json.loads(cleaned)

    except Exception as e:
        logging.error(f"Error in generate_ai_data ({agent_mode}): {e}", exc_info=True)
        return {}

üü¶ outcome.html:
{% extends 'base.html' %}

{% block content %}

<!-- 1. JINJA LOGIC: Pre-calculate System Stats for the Goal Visualizer -->
{% set total_ces = 0 %}
{% set active_ces = 0 %}
{% set verified_ces = 0 %}
{% if ssol.phases %}
    {% for phase_name, cos_list in ssol.phases.items() %}
        {% if cos_list %}
            {% for cos in cos_list %}
                {% if cos.conditional_elements %}
                    {% set total_ces = total_ces + cos.conditional_elements|length %}
                    {% for ce in cos.conditional_elements %}
                        {# Check internal data status if available #}
                        {% if ce.data and ce.data.get('status') == 'Active' %}{% set active_ces = active_ces + 1 %}{% endif %}
                        {% if ce.data and ce.data.get('status') == 'Verified' %}{% set verified_ces = verified_ces + 1 %}{% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endif %}

<!-- THE HORIZON WRAPPER -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- MAIN CONSOLE GRID (2-Column Layout) -->
    <div class="row g-0 bg-white" style="min-height: 85vh;">
        
        <!-- ============================================= -->
        <!-- A. LEFT COLUMN: CONTEXT & IDENTITY (Sidebar)  -->
        <!-- ============================================= -->
        <div class="col-lg-3 border-end bg-surface-screen d-flex flex-column position-relative z-10">
            
            <!-- Context Header -->
            <!-- Added 'mission-context-header' class for that top-left rounded corner -->
            <div class="mission-context-header py-3 px-4 d-flex align-items-center justify-content-between text-white" 
                 style="background: linear-gradient(90deg, #00bcd4 0%, #26c6da 100%); border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px;">
                <span class="font-data tracking-widest small">
                    <i class="fas fa-satellite-dish me-2 opacity-50"></i>MISSION CONTEXT
                </span>
                <i class="fas fa-ellipsis-v opacity-50 small cursor-pointer"></i>
            </div>

            <!-- SCROLLABLE SIDEBAR CONTENT -->
            <div class="p-4 flex-grow-1 d-flex flex-column gap-3 overflow-y-auto">
                
                <!-- 1. Visualization Portal (Square 1:1 via CSS) -->
                <div class="image-portal border shadow-sm mx-auto">
                    <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" id="placeholderImage" class="fade-in" alt="System Processing">
                    <img src="" id="ssolImage" class="fade-in" style="opacity: 0;" alt="Generated Outcome Visualization">
                </div>

                <!-- 2. Domain Badge (Solid Pill Below Image) -->
                <div class="domain-badge-container">
                    <div class="domain-pill-solid" title="System Domain: {{ ssol.domain }}">
                        <div class="domain-icon-circle">
                            <i class="{{ ssol.domain_icon }}"></i>
                        </div>
                        <span class="fw-bold">{{ ssol.domain | upper }}</span>
                    </div>
                </div>

                <!-- 3. Prime Objective Card (Highlighted Box) -->
                <div class="mission-goal-card">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-bullseye text-danger"></i>
                        <div class="font-data text-danger small tracking-widest fw-bold">PRIME OBJECTIVE</div>
                    </div>
                    
                    <!-- Hidden hook for AI Context -->
                    <div id="ssol-goal" class="d-none">{{ ssol.selected_goal }}</div>
                    
                    <p class="font-body text-dark fw-bold fst-italic lh-sm mb-0" style="font-size: 1.05rem;">
                        "{{ ssol.selected_goal }}"
                    </p>
                </div>

                <!-- 4. System Variables (The Anchors Stack) -->
                <!-- Injected via backend from system_templates.py -->
                <div class="w-100">
                    {{ system_pills_html | default('') | safe }}
                </div>
            </div>

            <!-- Metadata Footer -->
            <div class="p-3 border-top text-center bg-white mt-auto">
                <span class="font-data text-muted small opacity-50">ID: {{ ssol_id.split('-')[0] | upper }}</span>
            </div>
        </div>


        <!-- ============================================= -->
        <!-- B. RIGHT COLUMN: WORKSPACE (The Engine)      -->
        <!-- ============================================= -->
        <div class="col-lg-9 d-flex flex-column position-relative">
            
            <!-- Brand Strip (Top Accent) -->
            <div class="brand-strip"></div>

            <!-- Workspace Padding -->
            <div class="p-4 p-lg-5 flex-grow-1 overflow-y-auto">
                
                <!-- 1. Title Header & Actions -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <div class="font-data text-muted small mb-1">SSPEC SOLUTION</div>
                        <h1 class="font-brand display-5 text-dark mb-0">{{ ssol.ssol_title }}</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary font-data rounded-pill px-4" title="Share Link"><i class="fas fa-share-nodes"></i></button>
                        <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-info text-white font-data rounded-pill px-4 shadow-sm">
                            <i class="fas fa-file-pdf me-2"></i> EXPORT REPORT
                        </button>
                    </div>
                </div>

                <!-- 2. Command Deck -->
                <div class="command-deck-wrapper mb-5 d-flex flex-column gap-4">
                    
                    <!-- A. Strategic Charter (Executive Summary) -->
                    <div class="bg-white rounded-4 border shadow-sm position-relative overflow-hidden charter-card" style="min-height: 200px;">
                        
                        <!-- Internal Header -->
                        <div class="py-3 px-4 border-bottom d-flex align-items-center gap-3" 
                             style="background: linear-gradient(90deg, #00bcd4, #26c6da, transparent);">
                            <div class="p-2 bg-white bg-opacity-25 rounded-3 backdrop-blur-sm text-white d-flex align-items-center justify-content-center" 
                                 style="width:36px; height:36px;">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <!-- FONT UPDATE: Changed to font-brand -->
                            <span class="font-brand text-white small tracking-widest fw-bold" style="letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">EXECUTIVE CHARTER</span>
                        </div>

                        <!-- Ghost Watermark (Domain Icon) -->
                        <div class="domain-ghost-watermark" style="opacity: 0.1;">
                           <i class="{{ ssol.domain_icon }}"></i>
                        </div>

                        <!-- Content with "Magic Parsing" Highlighting -->
                        <div class="charter-content font-body text-dark lead position-relative p-5">
                            {{ ssol.ssol_summary | safe }}
                        </div>
                    </div>

                    <!-- B. Flight Path Timeline (Horizon Gauge) -->
                    <!-- Injected from backend (system_templates.py) -->
                    <div class="w-100">
                        {{ horizon_gauge_html | default('<div class="alert alert-light border text-muted font-data small">TIMELINE CALIBRATING...</div>') | safe }}
                    </div>
                    
                </div>

                <!-- 3. Phase Execution Grid -->
                <div class="border rounded-3 overflow-hidden shadow-sm bg-white mb-4">
                    
                    <!-- Grid Header -->
                    <div class="bg-light px-4 py-3 border-bottom d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                             <div class="p-2 bg-white rounded-circle border shadow-sm text-muted"><i class="fas fa-layer-group"></i></div>
                             <h2 class="h6 mb-0 text-secondary font-brand letter-spacing-1">PHASES & CONDITIONS</h2>
                        </div>
                        
                        <!-- Interactive Legend -->
                        <div class="d-none d-lg-flex gap-4 font-data text-muted small tracking-widest align-items-center">
                            {% for phase_name in ssol.phases.keys() %}
                            <span class="phase-legend-item d-flex align-items-center gap-2 cursor-pointer hover-text-dark transition-colors" 
                                  data-target-id="collapse{{ loop.index }}" 
                                  title="Scroll to {{ phase_name }}">
                                <div class="rounded-circle" style="width:8px;height:8px;background:var(--phase-{{ loop.index0 }});"></div> 
                                {{ phase_name.upper() }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Accordion Stack -->
                    <div class="accordion accordion-flush" id="phaseAccordion">
                        {% for phase_name, cos_list in ssol.phases.items() %}
                        <div class="accordion-item border-bottom mb-0">
                            
                            <!-- Phase Header (Vibrant Full Color) -->
                            <div class="module-header collapsed cursor-pointer py-3 px-4 transition-all text-white position-relative overflow-hidden" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#collapse{{ loop.index }}" 
                                 id="heading{{ loop.index }}"
                                 style="background-color: var(--phase-{{ loop.index0 }}); border-bottom: 1px solid rgba(0,0,0,0.1);">
                                
                                <!-- Subtle texture overlay for headers -->
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 8px 8px; opacity: 0.3;"></div>

                                <div class="d-flex align-items-center justify-content-between w-100 position-relative z-1">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="phase-icon text-dark bg-white shadow-sm" style="opacity: 0.9;">
                                            {{ phase_name[0] }}
                                        </div>
                                        <div class="text-white">
                                            <div class="phase-title font-brand" style="font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">{{ phase_name }} PHASE</div>
                                            <div class="font-data small opacity-75 letter-spacing-2">SEQUENCE 0{{ loop.index }}</div>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down text-white opacity-75 transition-transform"></i>
                                </div>
                            </div>

                            <!-- Phase Body -->
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show bg-white" data-bs-parent="#phaseAccordion">
                                <div class="accordion-body p-0 phase-table-container" data-ssol-id="{{ ssol_id }}">
                                    {% if cos_list %}
                                    <table class="table table-hover mb-0 align-middle retro-table">
                                        <thead class="bg-surface-screen border-bottom">
                                            <tr>
                                                <th class="ps-5 text-muted small font-data py-3" style="width: 110px;">STATUS</th>
                                                <th class="text-muted small font-data py-3">CONDITION OF SATISFACTION</th> 
                                                <th class="text-muted small font-data py-3" style="width: 18%;">ACCOUNTABLE</th>
                                                <th class="text-muted small font-data py-3" style="width: 12%;">TARGET</th>
                                                <th class="text-end pe-5 text-muted small font-data py-3" style="width: 100px;">EDIT</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cos in cos_list %}
                                            <tr class="cos-row" data-cos-id="{{ cos.id }}" data-editing="false">
                                                <td class="status-cell ps-5">
                                                    <span class="status-block font-data shadow-sm" 
                                                          style="background-color: {{ 'var(--success)' if cos.status == 'Completed' else 'var(--warning)' if cos.status == 'Active' else '#94a3b8' }}; font-size: 0.6rem; padding: 5px 10px;">
                                                        {{ cos.status | upper }}
                                                    </span>
                                                </td>
                                                <td class="cos-content-cell py-4">
                                                    <div class="cos-content-display font-body text-dark fs-6">{{ cos.content | safe }}</div>
                                                    <div class="cos-content-edit d-none"><textarea class="form-control font-body bg-light border-0 p-3 shadow-inner">{{ cos.content | striptags }}</textarea></div>
                                                </td>
                                                <td class="cos-accountable-party-cell">
                                                    <div class="d-flex align-items-center gap-2 font-body fw-bold text-secondary small">
                                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-muted border" style="width:32px;height:32px;"><i class="fas fa-user small"></i></div>
                                                        <span class="cos-accountable-party-display">{{ cos.accountable_party or 'N/A' }}</span><input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                                    </div>
                                                </td>
                                                <td class="cos-completion-date-cell font-data text-muted small">
                                                    <span class="cos-completion-date-display">{{ cos.completion_date or 'TBD' }}</span>
                                                    <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date if cos.completion_date else '' }}">
                                                </td>
                                                <td class="text-end actions-cell pe-5">
                                                    <div class="btn-group cos-actions opacity-50 hover-opacity-100 transition">
                                                        <button class="btn btn-sm btn-link text-muted edit-cos-button p-2"><i class="fas fa-cog"></i></button>
                                                        <button class="btn btn-sm btn-link text-danger delete-cos-button p-2"><i class="fas fa-trash"></i></button>
                                                    </div>
                                                    <div class="btn-group cos-actions d-none">
                                                        <button class="btn btn-sm btn-success update-cos-button p-1"><i class="fas fa-check"></i></button>
                                                        <button class="btn btn-sm btn-secondary cancel-cos-button p-1"><i class="fas fa-times"></i></button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <div class="p-3 bg-white border-top d-flex justify-content-center">
                                        <button class="btn btn-white border font-data rounded-pill px-5 py-2 text-secondary hover-shadow add-cos" data-phase="{{ phase_name }}">
                                            <i class="fas fa-plus me-2 text-primary"></i> ADD CONDITION UNIT
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="p-5 text-center text-muted font-body opacity-50"><i class="fas fa-folder-open fa-3x mb-3"></i><p class="small">No conditions initialized.</p></div>
                                    <div class="p-3 bg-white border-top d-flex justify-content-center"><button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}"><i class="fas fa-plus me-2"></i> INITIALIZE</button></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
            
            <!-- Page Footer -->
            <div class="px-5 py-3 bg-white border-top mt-auto d-flex justify-content-between align-items-center">
                <div class="font-data small text-muted d-flex align-items-center">
                    <div class="rounded-circle bg-success me-2 animate-pulse" style="width:8px; height:8px;"></div>
                    SYSTEM ONLINE
                </div>
                <div class="font-data small text-muted">SSPEC HORIZON v2025.32</div>
            </div>

        </div>

    </div>
  </div>
</div>

<!-- Modal Injectors -->
<div class="modal fade" id="errorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body font-body" id="errorMessageContent"></div></div></div></div>
<!-- The System Config Modal (Injected from Backend) -->
{{ system_config_modal_html | default('') | safe }}
<!-- The CE Node Modal Container -->
<div id="dynamicModalContainer"></div>

<style>
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .hover-text-dark:hover { color: var(--text-dark) !important; }
    .transition-colors { transition: color 0.2s; }
    .transition-transform { transition: transform 0.2s; }
    .module-header:not(.collapsed) .fa-chevron-down { transform: rotate(180deg); }
    .flex-shrink-0 { flex-shrink: 0 !important; }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Inject Python System Node Configuration into JS Scope
    window.SYSTEM_NODES_CONFIG = {{ system_nodes | tojson }};
    
    // Inject the SSOL ID so the CE Modal knows which "Physics" to apply
    window.SSOL_ID = "{{ ssol_id }}"; 

    // Inject Pre-Calculated Stats for the 'GOAL' Visualizer
    window.SSOL_STATS = {
        total: {{ total_ces }},
        active: {{ active_ces }},
        verified: {{ verified_ces }},
        integrity: {{ ssol.integrity_score }}
    };
</script>

<!-- Module Imports -->
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/system_cards.js') }}"></script>

<script type="module">
    import { initSystemCards } from "{{ url_for('static', filename='js/system_cards.js') }}";
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the System Anchors Logic
        initSystemCards("{{ ssol_id }}");
        
        // Phase Legend Navigation
        const legendItems = document.querySelectorAll('.phase-legend-item');
        legendItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.targetId; 
                const targetCollapse = document.getElementById(targetId);
                const targetItem = targetCollapse?.closest('.accordion-item');
                if (targetCollapse) {
                    new bootstrap.Collapse(targetCollapse, { toggle: false }).show();
                    setTimeout(() => targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                }
            });
        });

        // Async Image Loading
        const ssolImageElement = document.getElementById('ssolImage'); 
        const placeholderImageElement = document.getElementById('placeholderImage');
        if (ssolImageElement) {
            function checkImage() {
                fetch(`/get_ssol_image/{{ ssol_id }}`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.status === 'found' && data.image_path) {
                            ssolImageElement.src = data.image_path;
                            ssolImageElement.onload = () => {
                                placeholderImageElement.style.opacity = 0;
                                ssolImageElement.style.opacity = 1;
                            };
                        } else {
                            setTimeout(checkImage, 2000);
                        }
                    }).catch(e => console.error(e));
            }
            checkImage();
        }
    });
</script>
{% endblock %}

üéØ goal_selection.js:
// =============================================================================
// GOAL SELECTION - REWRITTEN TO MATCH PROTOTYPE ANIMATION FLOW
// =============================================================================

import {
    handleEditButtonClick,
    handleSaveButtonClick,
    handleCancelButtonClick,
    regenerateGoals,
    showLoadingSpinner,
    hideLoadingSpinner,
    updateGoalCards
} from './base_functions.js';

// =============================================================================
// 1. CONFIGURATION DATA (SSPEC ONTOLOGY)
// =============================================================================

const IDENTITY_TYPES = [
    {
        id: 'Individual',
        label: 'Individual / Just Me',
        icon: 'fa-user',
        desc: "You are acting alone. Maximum agility, but limited by your personal time and energy.",
        color: "#00bcd4" // Teal
    },
    {
        id: 'Grassroots',
        label: 'Community / Grassroots',
        icon: 'fa-users',
        desc: "A volunteer network or collective. Driven by passion and consensus rather than payroll.",
        color: "#8bc34a" // Light Green
    },
    {
        id: 'Team',
        label: 'Small Team / Startup',
        icon: 'fa-rocket',
        desc: "A dedicated group with specific roles. Driven by speed, product, and growth.",
        color: "#ff9800" // Orange
    },
    {
        id: 'NonProfit',
        label: 'Non-Profit / NGO',
        icon: 'fa-hand-holding-heart',
        desc: "Mission-driven organization. Accountability is to donors, grants, and public trust.",
        color: "#e91e63" // Pink
    },
    {
        id: 'Enterprise',
        label: 'Corporate / Enterprise',
        icon: 'fa-building',
        desc: "Large-scale commercial entity. High resources, but governed by profit and quarterly targets.",
        color: "#3f51b5" // Indigo
    },
    {
        id: 'Public',
        label: 'Public / Civic Body',
        icon: 'fa-landmark',
        desc: "Government or Municipal entity. High leverage, but bound by regulation and public procedure.",
        color: "#607d8b" // Blue Grey
    }
];

const BUDGET_TYPES = [
    { id: 'Bootstrapped', label: 'Bootstrapped ($0)' },
    { id: 'Crowdfunded', label: 'Crowdfunded' },
    { id: 'Grant', label: 'Grant Funded' },
    { id: 'VC', label: 'Venture Capital' },
    { id: 'Public', label: 'Public Budget' }
];

const CONTEXT_HINTS = {
    'Individual': {
        time: "Timeline is 100% dependent on your personal bandwidth.",
        implication: "SSPEC will structure the plan around **Low-Code Tools**, **Freelance Support**, and **'Sweat Equity'** to avoid burnout."
    },
    'Grassroots': {
        time: "Timeline fluctuates based on volunteer momentum.",
        implication: "SSPEC will focus on **Community Organizing**, **Social Capital**, and **Viral Advocacy** to replace financial capital."
    },
    'Team': {
        time: "Timeline is aggressive; governed by runway and burn rate.",
        implication: "SSPEC will suggest **Agile Workflows**, **MVP Iterations**, and **Vendor Partnerships** for speed."
    },
    'NonProfit': {
        time: "Timeline often dictated by funding cycles and board approvals.",
        implication: "SSPEC will emphasize **Impact Measurement**, **Grant Compliance**, and **Stakeholder Stewardship**."
    },
    'Enterprise': {
        time: "Timeline moves in fiscal quarters.",
        implication: "SSPEC will prioritize **Risk Mitigation**, **IP Protection**, and **Scalable Infrastructure**."
    },
    'Public': {
        time: "Timeline is slow and steady due to regulatory requirements.",
        implication: "SSPEC will map out **Procurement Protocols**, **Public Hearings**, and **Compliance Checks**."
    }
};

// Wizard Step Configuration
const WIZARD_STEPS = {
    1: { title: 'Who Is Driving?', desc: 'Select the operational entity to calibrate resource leverage.' },
    2: { title: 'Target Horizon', desc: 'When is the optimal extraction date for this reality?' },
    3: { title: 'Resource Model', desc: 'Define the fuel source for this trajectory.' }
};
const TOTAL_STEPS = 3;

window.suggestIdentity = function() {
    const goalText = (State.selectedCardData?.goal || "").toLowerCase();
    const titleText = (State.selectedCardData?.title || "").toLowerCase();
    const combined = goalText + " " + titleText;
    
    let suggestion = 'Individual'; // Default fallback
    
    // Heuristic Matching
    if (combined.match(/community|neighborhood|club|collective|movement|protest/)) suggestion = 'Grassroots';
    else if (combined.match(/startup|app|platform|scale|market|product/)) suggestion = 'Team';
    else if (combined.match(/foundation|charity|aid|relief|donor/)) suggestion = 'NonProfit';
    else if (combined.match(/city|law|public|park|statue|infrastructure/)) suggestion = 'Public';
    else if (combined.match(/corp|global|franchise|stock|merger/)) suggestion = 'Enterprise';
    
    // Highlight the suggestion
    const targetPill = document.querySelector(`.wizard-identity-pill[data-id="${suggestion}"]`);
    if(targetPill) {
        // Visual cue
        targetPill.style.transform = "scale(1.05)";
        targetPill.style.boxShadow = "0 0 20px rgba(0, 188, 212, 0.4)";
        setTimeout(() => {
            targetPill.click(); // Auto-select it
            targetPill.style.transform = "";
            targetPill.style.boxShadow = "";
        }, 300);
    }
};

// =============================================================================
// 2. STATE MANAGEMENT
// =============================================================================

const State = {
    phase: 'INIT',
    selectedCardId: null,
    selectedCardData: null,
    wizardStep: 1,
    
    // Color harmony data (populated from backend)
    colorData: window.GOAL_COLOR_DATA || [],
    
    // Form values
    identity: null,
    horizon: null,
    budget: null
};

// =============================================================================
// COLOR UTILITIES
// =============================================================================

/**
 * Get the color palette for a specific goal by ID
 */
function getGoalColors(cardId) {
    const goal = State.colorData.find(g => 
        g.title.toLowerCase().replace(/\s+/g, '-') === cardId
    );
    return goal || {};
}

/**
 * Generate CSS variables string from a goal's color palette
 */
function getColorCSSVars(goal) {
    if (!goal || !goal.color_hue) return '';
    
    return `
        --goal-hue: ${goal.color_hue};
        --goal-primary: ${goal.accent_color || '#00bcd4'};
        --goal-gradient: ${goal.card_gradient || 'linear-gradient(135deg, #00bcd4, #2979ff)'};
        --goal-icon-color: ${goal.icon_color || '#00838f'};
    `;
}

/**
 * HSV to Hex conversion (for dynamic color generation in JS)
 */
function hsvToHex(h, s = 0.75, v = 0.9) {
    const hNorm = h / 360;
    const i = Math.floor(hNorm * 6);
    const f = hNorm * 6 - i;
    const p = v * (1 - s);
    const q = v * (1 - f * s);
    const t = v * (1 - (1 - f) * s);
    
    let r, g, b;
    switch (i % 6) {
        case 0: r = v; g = t; b = p; break;
        case 1: r = q; g = v; b = p; break;
        case 2: r = p; g = v; b = t; break;
        case 3: r = p; g = q; b = v; break;
        case 4: r = t; g = p; b = v; break;
        case 5: r = v; g = p; b = q; break;
    }
    
    const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

/**
 * Generate harmonized color for system pills based on goal's hue
 */
function getHarmonizedPillColor(baseHue, offset = 30) {
    const pillHue = (baseHue + offset) % 360;
    return hsvToHex(pillHue, 0.65, 0.90);
}

// =============================================================================
// 3. PHASE TRANSITIONS (The State Machine)
// =============================================================================

/**
 * Transition to a new phase with proper cleanup and setup
 */
function transitionTo(newPhase, payload = {}) {
    const oldPhase = State.phase;
    console.log(`[SSPEC] Phase Transition: ${oldPhase} ‚Üí ${newPhase}`, payload);
    
    State.phase = newPhase;
    
    switch (newPhase) {
        case 'DEALING':
            handleDealingPhase();
            break;
        case 'SELECTION':
            handleSelectionPhase();
            break;
        case 'CONFIG':
            handleConfigPhase(payload.cardWrapper, payload.goalData);
            break;
        case 'RETURNING':
            handleReturningPhase();
            break;
    }
}

// =============================================================================
// 4. PHASE HANDLERS
// =============================================================================

/**
 * DEALING: Cards enter with staggered animation, flip to reveal goal face
 */
function handleDealingPhase() {
    const cards = document.querySelectorAll('.flip-card-wrapper');
    
    cards.forEach((card, index) => {
        // Reset all state classes
        card.classList.remove('state-selection', 'state-config', 'state-dimmed', 'state-returning');
        card.style.cssText = '';
        
        // Clear any inline transforms on inner
        const inner = card.querySelector('.flip-card-inner');
        if (inner) inner.style.transform = '';
        
        // Store original icon for later restoration
        const iconEl = card.querySelector('.flip-card-back i.monolith-icon');
        if (iconEl) {
            card.dataset.originalIcon = iconEl.className;
        }
        
        // Start in dealing state (invisible, translated down)
        card.classList.add('state-dealing');
        
        // Force reflow to ensure transition works
        void card.offsetWidth;
        
        // Staggered reveal: slide up, fade in, then flip
        const revealDelay = 400 + (index * 250);
        
        setTimeout(() => {
            // Remove dealing state to trigger slide-up animation
            card.classList.remove('state-dealing');
            card.classList.add('state-revealing');
            
            // After slide-up completes, flip to show goal face
            setTimeout(() => {
                card.classList.remove('state-revealing');
                card.classList.add('state-selection');
            }, 600); // Wait for slide-up, then flip
            
        }, revealDelay);
    });
    
    // Transition to SELECTION after all cards are dealt
    const totalDealTime = 400 + (cards.length * 250) + 1200;
    setTimeout(() => {
        if (State.phase === 'DEALING') {
            transitionTo('SELECTION');
        }
    }, totalDealTime);
}

/**
 * SELECTION: Cards are interactive, waiting for user click
 */
function handleSelectionPhase() {
    const cards = document.querySelectorAll('.flip-card-wrapper');
    
    cards.forEach(card => {
        // Ensure all cards are in selection state
        card.classList.remove('state-dealing', 'state-revealing', 'state-config', 'state-dimmed');
        card.classList.add('state-selection');
        
        // Clear any inline styles from previous config
        card.style.cssText = '';
        const inner = card.querySelector('.flip-card-inner');
        if (inner) inner.style.transform = '';
    });
}

/**
 * CONFIG: Selected card morphs to sidebar, wizard panel appears
 */
function handleConfigPhase(cardWrapper, goalData) {
    if (!cardWrapper) return;
    
    State.selectedCardId = cardWrapper.dataset.cardId || goalData?.title;
    State.selectedCardData = goalData;
    State.wizardStep = 1;
    
    const inner = cardWrapper.querySelector('.flip-card-inner');
    const viewport = document.getElementById('stage-viewport');
    
    // 1. Dim all siblings immediately
    document.querySelectorAll('.flip-card-wrapper').forEach(card => {
        if (card !== cardWrapper) {
            card.classList.add('state-dimmed');
        }
    });
    
    // 2. Create placeholder to maintain grid position
    const rect = cardWrapper.getBoundingClientRect();
    const viewRect = viewport.getBoundingClientRect();
    
    const placeholder = document.createElement('div');
    placeholder.className = 'grid-placeholder';
    placeholder.id = 'active-card-placeholder';
    placeholder.style.width = rect.width + 'px';
    placeholder.style.height = rect.height + 'px';
    cardWrapper.parentNode.insertBefore(placeholder, cardWrapper);
    
    // 3. Calculate starting position relative to viewport
    const startTop = rect.top - viewRect.top;
    const startLeft = rect.left - viewRect.left;
    
    // 4. Move card to viewport and set absolute position
    viewport.appendChild(cardWrapper);
    cardWrapper.style.position = 'absolute';
    cardWrapper.style.top = startTop + 'px';
    cardWrapper.style.left = startLeft + 'px';
    cardWrapper.style.width = rect.width + 'px';
    cardWrapper.style.height = rect.height + 'px';
    cardWrapper.style.margin = '0';
    cardWrapper.style.zIndex = '100';
    
    // 5. Transition from selection to config state
    cardWrapper.classList.remove('state-selection');
    
    // Force reflow before adding config class
    void cardWrapper.offsetWidth;
    
    // 6. Add config class - CSS handles the flip back to 0deg
    cardWrapper.classList.add('state-config');
    
    // 7. Animate to final position (left sidebar)
    requestAnimationFrame(() => {
        cardWrapper.style.top = '0px';
        cardWrapper.style.left = '0px';
        cardWrapper.style.width = '35%';
        cardWrapper.style.height = '100%';
        cardWrapper.style.maxWidth = '420px';
    });
    
    // 8. Inject hero content and show wizard after flip completes
    setTimeout(() => {
        injectHeroContent(cardWrapper, goalData);
        showWizardPanel(goalData);
    }, 1200);
}

/**
 * RETURNING: Reverse the config animation back to selection grid
 */
function handleReturningPhase() {
    const cardWrapper = document.querySelector('.flip-card-wrapper.state-config');
    const placeholder = document.getElementById('active-card-placeholder');
    const wizardPanel = document.querySelector('.split-col-right');
    
    if (!cardWrapper || !placeholder) {
        console.error('[SSPEC] Cannot return - missing card or placeholder');
        transitionTo('SELECTION');
        return;
    }
    
    const inner = cardWrapper.querySelector('.flip-card-inner');
    const viewport = document.getElementById('stage-viewport');
    
    // 1. Hide wizard panel first
    if (wizardPanel) {
        wizardPanel.classList.remove('visible');
    }
    
    // 2. Restore monolith content (before morph)
    restoreMonolithContent(cardWrapper);
    
    // 3. Calculate return position from placeholder
    const placeholderRect = placeholder.getBoundingClientRect();
    const viewRect = viewport.getBoundingClientRect();
    
    const targetTop = placeholderRect.top - viewRect.top;
    const targetLeft = placeholderRect.left - viewRect.left;
    const targetWidth = placeholderRect.width;
    const targetHeight = placeholderRect.height;
    
    // 4. Switch from config to returning state
    cardWrapper.classList.remove('state-config');
    cardWrapper.classList.add('state-returning');
    
    // 5. Animate back to grid position
    requestAnimationFrame(() => {
        cardWrapper.style.top = targetTop + 'px';
        cardWrapper.style.left = targetLeft + 'px';
        cardWrapper.style.width = targetWidth + 'px';
        cardWrapper.style.height = targetHeight + 'px';
    });
    
    // 6. Cleanup after animation completes
    setTimeout(() => {
        // Clear inline styles
        cardWrapper.style.cssText = '';
        if (inner) inner.style.transform = '';
        
        // Move card back to grid
        placeholder.parentNode.insertBefore(cardWrapper, placeholder);
        placeholder.remove();
        
        // Remove wizard panel from DOM
        if (wizardPanel) wizardPanel.remove();
        
        // Reset state
        State.selectedCardId = null;
        State.selectedCardData = null;
        State.identity = null;
        State.horizon = null;
        State.budget = null;
        State.wizardStep = 1;
        
        // Transition to selection (this will restore all cards)
        transitionTo('SELECTION');
        
    }, 1000);
}

// =============================================================================
// 5. CONTENT BUILDERS
// =============================================================================

/**
 * Extract goal data from card DOM
 */
function extractGoalData(card) {
    const cardId = card.dataset.cardId;
    const colorHue = parseFloat(card.dataset.colorHue) || 180;
    
    // Try to get full color data from backend-provided data
    const backendData = getGoalColors(cardId);
    
    const headerPlate = card.querySelector('.card-header-plate');
    const computedStyle = headerPlate ? window.getComputedStyle(headerPlate) : null;
    
    return {
        id: cardId,
        title: card.querySelector('.card-title-large')?.innerText || 
               card.querySelector('.card-title')?.innerText || 
               'Unknown Goal',
        goal: card.querySelector('.card-desc-large')?.innerText || 
              card.querySelector('.card-desc')?.innerText || 
              '',
        domain: card.querySelector('.card-domain-badge-large')?.innerText || 
                card.querySelector('.card-domain-badge')?.innerText || 
                '',
        icon: card.querySelector('.card-icon-float-large i')?.className || 
              card.querySelector('.card-icon-float i')?.className || 
              'fas fa-cube',
        
        // Color data
        colorHue: colorHue,
        gradient: backendData.card_gradient || 
                  computedStyle?.background || 
                  headerPlate?.style.background || 
                  `linear-gradient(135deg, ${hsvToHex(colorHue)} 0%, ${hsvToHex((colorHue + 15) % 360, 0.8, 0.8)} 100%)`,
        colorHex: backendData.accent_color || hsvToHex(colorHue),
        iconColor: backendData.icon_color || hsvToHex(colorHue, 0.9, 0.7),
        phaseColors: backendData.phase_colors || null
    };
}

/**
 * Extract primary color from gradient string
 */
function extractColorFromGradient(gradientStr) {
    if (!gradientStr) return '#00bcd4';
    const match = gradientStr.match(/#[a-fA-F0-9]{6}/);
    return match ? match[0] : '#00bcd4';
}

/**
 * Inject hero content into the back face of the selected card
 */
function injectHeroContent(cardWrapper, goalData) {
    const backFace = cardWrapper.querySelector('.flip-card-back');
    if (!backFace) return;
    
    // Fade out current content
    backFace.style.transition = 'opacity 0.3s ease';
    backFace.style.opacity = '0';
    
    setTimeout(() => {
        backFace.innerHTML = `
            <div class="hero-card-content">
                <!-- Texture Overlay -->
                <div class="absolute inset-0 opacity-20 pointer-events-none" 
                     style="background-image: radial-gradient(white 1.5px, transparent 1.5px); background-size: 24px 24px;">
                </div>
                
                <!-- Gradient Overlay -->
                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/30 pointer-events-none"></div>
                
                <!-- Ghost Icon Background -->
                <i class="${goalData.icon} hero-ghost-icon"></i>
                
                <!-- Return Button -->
                <button onclick="window.exitStage()" class="hero-return-button">
                    <i class="fas fa-arrow-left"></i>
                    <span>RETURN TO CHOICES</span>
                </button>

                <!-- Domain Pill -->
                <div class="hero-domain-pill" style="color: ${goalData.colorHex};">
                    <i class="${goalData.icon}" style="color: ${goalData.colorHex};"></i>
                    <span>${goalData.domain}</span>
                </div>
                
                <!-- Title -->
                <h2 class="hero-title">${goalData.title}</h2>
                
                <!-- Description with Accent Bar -->
                <div class="hero-desc-box">
                    <div class="hero-desc-accent"></div>
                    <p class="hero-desc-text">${goalData.goal}</p>
                </div>
                
                <!-- System Configuration Section -->
                <div style="margin-top: auto;">
                    <div class="hero-config-label">SYSTEM CONFIGURATION</div>
                    <div id="sys-pill-stack" class="d-flex flex-column gap-2">
                        <!-- Pills added dynamically -->
                    </div>
                </div>
                
                <!-- Status Indicator -->
                <div class="hero-status-pill">
                    <div class="hero-status-pulse"></div>
                    <div style="width: 1px; height: 16px; background: rgba(255,255,255,0.2);"></div>
                    <span class="hero-status-text">AWAITING IDENTITY...</span>
                </div>
            </div>
        `;
        
        // Fade in new content
        backFace.style.opacity = '1';
    }, 300);
}

/**
 * Restore the monolith content when returning from config
 */
function restoreMonolithContent(cardWrapper) {
    const backFace = cardWrapper.querySelector('.flip-card-back');
    const originalIcon = cardWrapper.dataset.originalIcon || 'fas fa-cube';
    
    if (!backFace) return;
    
    backFace.style.opacity = '0';
    
    setTimeout(() => {
        backFace.innerHTML = `
            <div class="card-texture-overlay"></div>
            <div class="monolith-content">
                <i class="${originalIcon} monolith-icon"></i>
                <div class="position-absolute bottom-0 mb-5 font-data text-white-50 tracking-widest uppercase opacity-50 border border-white border-opacity-25 rounded-pill px-3 py-1" 
                     style="font-size: 0.6rem; letter-spacing: 2px;">
                    STRUCTURED SPECULATION
                </div>
            </div>
        `;
        backFace.style.opacity = '1';
    }, 150);
}

// =============================================================================
// 6. WIZARD PANEL
// =============================================================================

/**
 * Create and show the wizard panel
 */
function showWizardPanel(goalData) {
    let stage = document.getElementById('configuration-stage');
    
    if (!stage) {
        stage = document.createElement('div');
        stage.id = 'configuration-stage';
        document.getElementById('stage-viewport').appendChild(stage);
    }
    
    stage.innerHTML = `
        <div class="split-col-right">
            ${buildWizardHTML()}
        </div>
    `;
    
    // Trigger slide-in animation
    requestAnimationFrame(() => {
        const panel = stage.querySelector('.split-col-right');
        if (panel) panel.classList.add('visible');  // ‚úÖ Correct!
    });
    
    renderWizardStep(1);
}

/**
 * Build the wizard container HTML
 */
function buildWizardHTML() {
    return `
        <div class="wizard-container">
            <!-- Header -->
            <div class="wizard-header">
                <div>
                    <div class="wizard-label">CONFIGURATION</div>
                    <h3 class="wizard-title" id="wizard-step-title">Who Is Driving?</h3>
                </div>
                <div class="d-flex align-items-center gap-4">
                    <div class="wizard-progress">
                        <div class="wizard-progress-bar" id="wizard-progress-bar" style="width: 33.33%"></div>
                    </div>
                    <button class="wizard-skip-btn" onclick="window.skipToSpeculate()">
                        Skip <i class="fas fa-fast-forward"></i>
                    </button>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="wizard-content" id="wizard-content">
                <!-- Dynamically rendered -->
            </div>
            
            <!-- Footer Navigation -->
            <div class="wizard-footer">
                <button class="wizard-nav-btn wizard-back-btn" id="wizard-back-btn" onclick="window.wizardPrev()" disabled>
                    <i class="fas fa-chevron-left"></i> Back
                </button>
                <div class="wizard-step-indicator">
                    <span id="wizard-current-step">1</span> / ${TOTAL_STEPS}
                </div>
                <button class="wizard-nav-btn wizard-next-btn" id="wizard-next-btn" onclick="window.wizardNext()" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    `;
}

/**
 * Render the current wizard step content
 */
function renderWizardStep(step) {
    State.wizardStep = step;
    
    const content = document.getElementById('wizard-content');
    const title = document.getElementById('wizard-step-title');
    const progressBar = document.getElementById('wizard-progress-bar');
    const backBtn = document.getElementById('wizard-back-btn');
    const nextBtn = document.getElementById('wizard-next-btn');
    const currentStepEl = document.getElementById('wizard-current-step');
    
    if (!content) return;
    
    // Update header
    const stepConfig = WIZARD_STEPS[step];
    if (title) title.textContent = stepConfig.title;
    if (progressBar) progressBar.style.width = `${(step / TOTAL_STEPS) * 100}%`;
    if (currentStepEl) currentStepEl.textContent = step;
    
    // Update navigation buttons
    if (backBtn) backBtn.disabled = step === 1;
    
    // Render step content
    content.innerHTML = getStepContent(step);
    
    // Update next button state
    updateNextButton();
}

/**
 * Get HTML content for each wizard step
 */
function getStepContent(step) {
    switch (step) {
        case 1:
            return `
                <div class="wizard-step">
                    <div class="wizard-step-header">
                        <h2 class="wizard-step-title">${WIZARD_STEPS[1].title}</h2>
                        <p class="wizard-step-desc">${WIZARD_STEPS[1].desc}</p>
                    </div>
                    <div class="wizard-identity-grid">
                        ${IDENTITY_TYPES.map(type => `
                            <div class="wizard-identity-pill ${State.identity === type.id ? 'selected' : ''}" 
                                 onclick="window.selectIdentity('${type.id}')">
                                <div class="wizard-identity-icon">
                                    <i class="fas ${type.icon}"></i>
                                </div>
                                <div class="wizard-identity-text">
                                    <h6>${type.label}</h6>
                                    <p>${type.desc}</p>
                                </div>
                                <div class="wizard-identity-check">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
        case 2:
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() + 1);
            const dateValue = State.horizon || defaultDate.toISOString().split('T')[0];
            
            return `
                <div class="wizard-step">
                    <div class="wizard-step-header">
                        <h2 class="wizard-step-title">${WIZARD_STEPS[2].title}</h2>
                        <p class="wizard-step-desc">${WIZARD_STEPS[2].desc}</p>
                    </div>
                    <div class="wizard-input-box">
                        <label class="wizard-input-label">Target Date</label>
                        <input type="date" 
                               class="wizard-date-input" 
                               value="${dateValue}"
                               onchange="window.setHorizon(this.value)">
                    </div>
                    ${State.identity ? `
                        <div class="wizard-hint-box">
                            <div class="wizard-hint-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <h6 class="wizard-hint-title">Implication for ${State.identity}</h6>
                                <p class="wizard-hint-text">
                                    ${CONTEXT_HINTS[State.identity]?.time || ''}<br>
                                    ${CONTEXT_HINTS[State.identity]?.implication || ''}
                                </p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
        case 3:
            return `
                <div class="wizard-step">
                    <div class="wizard-step-header">
                        <h2 class="wizard-step-title">${WIZARD_STEPS[3].title}</h2>
                        <p class="wizard-step-desc">${WIZARD_STEPS[3].desc}</p>
                    </div>
                    <div class="wizard-input-box" style="padding: 1rem;">
                        ${BUDGET_TYPES.map(b => `
                            <div class="wizard-budget-option ${State.budget === b.id ? 'selected' : ''}"
                                 onclick="window.selectBudget('${b.id}')"
                                 style="
                                    display: flex;
                                    align-items: center;
                                    gap: 1rem;
                                    padding: 1rem;
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    margin-bottom: 0.5rem;
                                    border: 2px solid ${State.budget === b.id ? '#0ea5e9' : '#e2e8f0'};
                                    background: ${State.budget === b.id ? '#f0f9ff' : 'white'};
                                 ">
                                <div style="
                                    width: 20px;
                                    height: 20px;
                                    border-radius: 50%;
                                    border: 2px solid ${State.budget === b.id ? '#0ea5e9' : '#cbd5e1'};
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                                    ${State.budget === b.id ? '<div style="width: 10px; height: 10px; background: #0ea5e9; border-radius: 50%;"></div>' : ''}
                                </div>
                                <span style="font-weight: 600; color: ${State.budget === b.id ? '#0f172a' : '#64748b'};">
                                    ${b.label}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
        default:
            return '';
    }
}

/**
 * Update the next button state based on current step completion
 */
function updateNextButton() {
    const nextBtn = document.getElementById('wizard-next-btn');
    if (!nextBtn) return;
    
    let isComplete = false;
    
    switch (State.wizardStep) {
        case 1:
            isComplete = !!State.identity;
            break;
        case 2:
            isComplete = true; // Date has default value
            // Set default horizon if not set
            if (!State.horizon) {
                const defaultDate = new Date();
                defaultDate.setFullYear(defaultDate.getFullYear() + 1);
                State.horizon = defaultDate.toISOString().split('T')[0];
            }
            break;
        case 3:
            isComplete = !!State.budget;
            break;
    }
    
    nextBtn.disabled = !isComplete;
    
    // Update button text for final step
    if (State.wizardStep === TOTAL_STEPS) {
        nextBtn.innerHTML = '<i class="fas fa-rocket"></i> Generate Solution';
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
    }
}

/**
 * Update the status pill on the hero card
 */
function updateHeroStatus(text) {
    const statusText = document.querySelector('.hero-status-text');
    if (statusText) {
        statusText.textContent = text;
    }
}

/**
 * Add a system pill to the hero card sidebar
 */
/**
 * Add a system pill to the hero card sidebar with harmonized colors
 */
function addSystemPill(type, value, iconClass) {
    const stack = document.getElementById('sys-pill-stack');
    if (!stack) return;
    
    // Get base hue from selected goal
    const baseHue = State.selectedCardData?.colorHue || 180;
    
    // Generate harmonized color (offset varies by pill type for variety)
    const typeOffsets = {
        'OPERATOR': 0,
        'HORIZON': 60,
        'BUDGET': 120,
        'SCALE': 180,
        'DIRECTIVE': 240
    };
    const offset = typeOffsets[type] || 30;
    const pillColor = getHarmonizedPillColor(baseHue, offset);
    
    // Remove existing pill of same type
    const existing = stack.querySelector(`[data-type="${type}"]`);
    if (existing) existing.remove();
    
    const pill = document.createElement('div');
    pill.className = 'system-pill-display';
    pill.setAttribute('data-type', type);
    pill.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 50px;
        backdrop-filter: blur(4px);
        border-left: 3px solid ${pillColor};
    `;
    
    pill.innerHTML = `
        <i class="${iconClass}" style="color: ${pillColor};"></i>
        <div style="flex: 1;">
            <span style="display: block; font-size: 0.6rem; opacity: 0.6; letter-spacing: 1px; text-transform: uppercase; color: ${pillColor};">${type}</span>
            <span style="display: block; font-weight: 700; font-size: 0.85rem; color: white;">${value}</span>
        </div>
    `;
    
    stack.appendChild(pill);
    updateHeroStatus('CONFIGURING...');
}

// =============================================================================
// 7. GLOBAL FUNCTIONS (Window Scope for onclick handlers)
// =============================================================================

window.selectGoal = function(cardWrapper) {
    // Guard: Only allow selection in SELECTION phase
    if (State.phase !== 'SELECTION' && State.phase !== 'DEALING') {
        console.log('[SSPEC] Cannot select - not in selection phase');
        return;
    }
    
    // Guard: Check for violation
    if (cardWrapper.classList.contains('violation')) {
        console.log('[SSPEC] Cannot select - violation card');
        return;
    }
    
    // Guard: Card must be revealed (in selection state)
    if (!cardWrapper.classList.contains('state-selection')) {
        console.log('[SSPEC] Cannot select - card not revealed yet');
        return;
    }
    
    const goalData = extractGoalData(cardWrapper);
    transitionTo('CONFIG', { cardWrapper, goalData });
};

window.exitStage = function() {
    if (State.phase !== 'CONFIG') {
        console.log('[SSPEC] Cannot exit - not in config phase');
        return;
    }
    transitionTo('RETURNING');
};

window.selectIdentity = function(id) {
    State.identity = id;
    
    // Update UI
    document.querySelectorAll('.wizard-identity-pill').forEach(pill => {
        pill.classList.remove('selected');
    });
    event.currentTarget?.classList.add('selected');
    
    // Re-render to show selection
    renderWizardStep(State.wizardStep);
    
    // Add pill to hero card
    const type = IDENTITY_TYPES.find(t => t.id === id);
    if (type) {
        addSystemPill('OPERATOR', type.label.toUpperCase(), `fas ${type.icon}`);
    }
    
    updateNextButton();
};

window.setHorizon = function(value) {
    State.horizon = value;
    addSystemPill('HORIZON', value, 'fas fa-calendar-day');
    updateNextButton();
};

window.selectBudget = function(id) {
    State.budget = id;
    
    // Re-render to show selection
    renderWizardStep(State.wizardStep);
    
    const type = BUDGET_TYPES.find(t => t.id === id);
    if (type) {
        addSystemPill('BUDGET', type.label.toUpperCase(), 'fas fa-piggy-bank');
    }
    
    updateNextButton();
};

window.wizardNext = function() {
    if (State.wizardStep < TOTAL_STEPS) {
        renderWizardStep(State.wizardStep + 1);
    } else {
        // Final step - submit form
        submitConfiguration();
    }
};

window.wizardPrev = function() {
    if (State.wizardStep > 1) {
        renderWizardStep(State.wizardStep - 1);
    }
};

window.skipToSpeculate = function() {
    showLoadingSpinner("AUTO-CALIBRATING...", "fa-solid fa-microchip");
    submitConfiguration();
};

/**
 * Submit the configuration and navigate to outcome
 */
function submitConfiguration() {
    // Build form data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/outcome';
    
    // Add goal data
    if (State.selectedCardData) {
        addHiddenInput(form, 'selected_goal', State.selectedCardData.goal);
        addHiddenInput(form, 'selected_goal_title', State.selectedCardData.title);
        addHiddenInput(form, 'domain', State.selectedCardData.domain);
        addHiddenInput(form, 'domain_icon', State.selectedCardData.icon);
    }
    
    // Add configuration
    addHiddenInput(form, 'operator', State.identity || '');
    addHiddenInput(form, 'horizon', State.horizon || '');
    addHiddenInput(form, 'budget', State.budget || '');
    
    document.body.appendChild(form);
    showLoadingSpinner("GENERATING STRUCTURED SOLUTION...", "fa-solid fa-microchip");
    form.submit();
}

function addHiddenInput(form, name, value) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    form.appendChild(input);
}

// =============================================================================
// 8. DYNAMIC RE-RENDERING (The Fix for Re-Calculate)
// =============================================================================

/**
 * Re-builds the 3D Card Grid from fresh JSON data
 */
function renderNewGoals(goals, gridElement) {
    gridElement.innerHTML = ''; // Wipe the old/broken cards
    
    goals.forEach((goal, index) => {
        // 1. Determine Colors (Use backend data or fallback)
        const hue = goal.color_hue || (index * 60) % 360;
        const gradient = goal.card_gradient || `linear-gradient(135deg, hsl(${hue}, 70%, 50%), hsl(${hue + 30}, 80%, 40%))`;
        const plateGradient = goal.plate_gradient || `linear-gradient(135deg, hsl(${hue}, 70%, 60%), hsl(${hue}, 70%, 50%))`;
        const btnGradient = goal.btn_gradient || `linear-gradient(to right, hsl(${hue}, 70%, 50%), hsl(${hue}, 80%, 40%))`;
        const iconColor = goal.icon_color || '#fff';
        const accentColor = goal.accent_color || '#fff';

        // 2. Build the Structure
        const cardWrapper = document.createElement('div');
        cardWrapper.className = `flip-card-wrapper ${!goal.is_compliant ? 'violation' : ''}`;
        cardWrapper.dataset.cardId = `goal-${index}`;
        cardWrapper.dataset.cardTitle = goal.title;
        cardWrapper.dataset.colorHue = hue;
        
        // Add click handler
        cardWrapper.onclick = function() { window.selectGoal(this, index); };

        // 3. Inject the HTML (The new 3D Architecture)
        cardWrapper.innerHTML = `
            <div class="flip-card-inner">
                <!-- BACK (Monolith) -->
                <div class="flip-card-back" style="background: ${gradient};">
                    <div class="card-texture-overlay"></div>
                    <div class="monolith-content">
                        <div class="monolith-icon-circle"><i class="${goal.icon} monolith-icon"></i></div>
                        ${!goal.is_compliant 
                            ? `<span class="badge bg-black bg-opacity-25 border border-danger text-white font-data px-3 py-2">PROTOCOL VIOLATION</span>`
                            : `<div class="font-data text-white-50 x-small tracking-widest opacity-75 border border-white border-opacity-25 rounded-pill px-3 py-1">STRUCTURED SPECULATION</div>`
                        }
                    </div>
                </div>
                
                <!-- FRONT (Details) -->
                <div class="flip-card-front">
                        <div class="card-header-plate" style="background: ${plateGradient};">
                            <div class="card-texture-overlay"></div>
                            <div class="card-domain-badge-large">${(goal.domain || 'GENERAL').toUpperCase()}</div>
                            <div class="card-icon-float-large"><i class="${goal.icon}" style="color: ${iconColor};"></i></div>
                        </div>
                        <div class="card-body-large">
                            <h3 class="card-title-large">${goal.title}</h3>
                            <p class="card-desc-large">${goal.goal}</p>
                        </div>
                        <div class="card-footer-large">
                            <button type="button" class="btn-select-pill-large" style="background: ${btnGradient};">
                                ${!goal.is_compliant ? 'PROTOCOL VIOLATION' : 'CHOOSE GOAL'}
                            </button>
                        </div>
                </div>
            </div>
            <!-- Dynamic Dock for System Pills -->
            <div class="system-pill-dock position-absolute top-0 start-0 w-100 p-4 d-flex flex-column gap-2" style="z-index: 5; pointer-events: none;"></div>
        `;

        gridElement.appendChild(cardWrapper);
    });
}

// =============================================================================
// 9. INITIALIZATION & LISTENERS
// =============================================================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('[SSPEC] Goal Selection Module Initialized');
    
    // Start the dealing sequence
    transitionTo('DEALING');
    
    // --- EXISTING FUNCTIONALITY (Regenerate, Edit Input, etc.) ---
    
    const speculateButton = document.getElementById('generate-new-goals');
    const userInputDisplay = document.querySelector('.user-input-display');
    const userInputEdit = document.querySelector('.user-input-edit');
    const editButton = document.querySelector('.edit-user-input');
    const saveButton = document.querySelector('.save-user-input');
    const cancelButton = document.querySelector('.cancel-user-input');
    const grid = document.getElementById('goalCardsContainer');

    if (speculateButton && userInputDisplay && userInputEdit) {
        speculateButton.addEventListener('click', async () => {
            let currentInputText = userInputDisplay.classList.contains('d-none')
                ? userInputEdit.value.trim()
                : userInputDisplay.textContent.trim();

            if (currentInputText) {
                showLoadingSpinner('Analysing Trajectories...', 'fa-sync-alt');
                try {
                    const data = await regenerateGoals(currentInputText);
                    if (data && data.goals) {
                        updateGoalCards(data, currentInputText, grid);
                        // Reset and restart dealing sequence
                        State.phase = 'INIT';
                        State.selectedCardId = null;
                        transitionTo('DEALING');
                    }
                } catch (error) {
                    console.error("Error:", error);
                } finally {
                    hideLoadingSpinner();
                }
            }
        });
    }

    if (editButton) {
        editButton.addEventListener('click', () => {
            handleEditButtonClick(userInputDisplay, userInputEdit, editButton, saveButton, cancelButton);
        });
    }
    
    if (saveButton) {
        saveButton.addEventListener('click', async () => {
            handleSaveButtonClick(userInputDisplay, userInputEdit, editButton, saveButton, cancelButton, async (updatedText) => {
                if (updatedText) {
                    showLoadingSpinner('Updating Context...', 'fa-sync-alt');
                    try {
                        const data = await regenerateGoals(updatedText);
                        if (data && data.goals) {
                            updateGoalCards(data, updatedText, grid);
                            State.phase = 'INIT';
                            State.selectedCardId = null;
                            transitionTo('DEALING');
                        }
                    } catch (error) {
                        console.error("Error:", error);
                    } finally {
                        hideLoadingSpinner();
                    }
                }
            });
        });
    }

    if (cancelButton) {
        cancelButton.addEventListener('click', () => {
            handleCancelButtonClick(userInputDisplay, userInputEdit, editButton, saveButton, cancelButton);
        });
    }

    if (userInputEdit) {
        userInputEdit.addEventListener('keydown', (event) => {
            if (userInputEdit.classList.contains('d-none')) return;
            if (event.key === 'Enter') {
                event.preventDefault();
                saveButton?.click();
            }
            if (event.key === 'Escape') {
                cancelButton?.click();
            }
        });
    }

    // Form submission loading state
    document.addEventListener('submit', (e) => {
        if (e.target.id === 'outcome-form') {
            showLoadingSpinner("GENERATING STRUCTURED SOLUTION...", "fa-solid fa-microchip");
        }
    });
});

üß© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER: SYSTEM IDENTITY -->
            <div class="ce-modal-header">
                <div class="node-icon-box"><i class="{{ node_info.icon }}"></i></div>
                <div class="header-text-block ms-3 flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="modal-title ce-title mb-0 text-white leading-tight">{{ ceType.replace('_', ' ').upper() }}</h2>
                            <div class="ce-header-metadata text-white opacity-75 small">// {{ phase_name.upper() }} PHASE <span class="mx-2">|</span> ID: {{ ceId.split('-')[0].upper() }}</div>
                        </div>
                        <!-- INTELLIGENCE BUTTON -->
                        <div class="d-flex gap-2">
                             <button class="btn btn-glass font-data d-none d-md-flex align-items-center gap-2" id="speculate-sidebar-toggle">
                                <i class="fas fa-brain"></i> ENGINE
                            </button>
                            <div class="vr bg-white opacity-50 mx-2" style="height: 24px;"></div>
                            <button type="button" class="btn-close-custom" data-bs-dismiss="modal"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
                <div class="header-ghost-icon"><i class="{{ node_info.icon }}"></i></div>
            </div>

            <!-- MICRO-TIMELINE (THE 4 QUADRANTS) -->
            <div class="ce-micro-timeline bg-white border-bottom px-4 py-2">
                <div class="row align-items-center g-0">
                    <div class="col-auto me-3 font-data small text-muted tracking-widest">EXECUTION PROTOCOL:</div>
                    <div class="col">
                        <div class="d-flex w-100 gap-1">
                            <div class="milestone-segment active" id="ms-q1"><div class="ms-bar"></div><span class="ms-label">DEFINITION</span></div>
                            <div class="milestone-segment" id="ms-q2"><div class="ms-bar"></div><span class="ms-label">ALIGNMENT</span></div>
                            <div class="milestone-segment" id="ms-q3"><div class="ms-bar"></div><span class="ms-label">EVIDENCE</span></div>
                            <div class="milestone-segment" id="ms-q4"><div class="ms-bar"></div><span class="ms-label">VALIDATION</span></div>
                        </div>
                    </div>
                    <div class="col-auto ms-3">
                        <span class="badge rounded-pill bg-light text-dark border" id="milestone-status">Q1: DRAFTING</span>
                    </div>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex">
                
                <!-- LEFT COLUMN -->
                <div class="ce-main-column">
                    <!-- NAVIGATION -->
                    <ul class="nav nav-tabs ce-nav-tabs pt-2 px-4 bg-white" role="tablist">
                        <li class="nav-item"><button class="nav-link font-data active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">OVERVIEW</button></li>
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <li class="nav-item"><button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-{{ collection }}-{{ ceId }}">{{ collection|upper }} <span class="badge rounded-pill bg-light text-dark border ms-1 count-badge" data-collection="{{ collection }}">0</span></button></li>
                        {% endfor %}
                        <li class="nav-item ms-auto"><button class="nav-link font-data text-muted" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i></button></li>
                    </ul>

                    <div class="ce-app-content tab-content bg-surface-screen">
                        
                        <!-- 1. OVERVIEW DASHBOARD (Bento) -->
                        <div class="tab-pane fade show active p-4" id="view-overview-{{ ceId }}">
                            <div class="row g-4 h-100">
                                
                                <!-- HERO: Editable Narrative Context -->
                                <div class="col-lg-8 d-flex flex-column">
                                    <div class="system-hero-card flex-grow-1 p-0 position-relative overflow-hidden">
                                        <div class="scan-line" style="opacity:0;"></div> 
                                        <div class="hero-ghost-icon"><i class="{{ node_info.icon }}"></i></div>

                                        <div class="d-flex flex-column h-100 position-relative z-2">
                                            <div class="p-4 pb-0 d-flex justify-content-between align-items-start">
                                                <div class="font-data text-white-50 small letter-spacing-2">STRATEGIC CONTEXT</div>
                                                
                                                <!-- BRANDING FIX: SPECULATE -->
                                                <button class="btn btn-sm btn-glass text-white btn-enhance-field" data-field="summary">
                                                    <i class="fas fa-brain me-2"></i> SPECULATE
                                                </button>
                                            </div>
                                            
                                            <!-- The Editable Area -->
                                            <div class="flex-grow-1 p-4">
                                                <form id="narrative-form-{{ ceId }}" class="h-100">
                                                    <textarea name="summary" 
                                                              class="form-control bg-transparent border-0 text-white font-body fs-5 h-100 p-0 shadow-none hero-textarea" 
                                                              style="resize: none; line-height: 1.6;" 
                                                              placeholder="Describe the strategic function of this node..."
                                                    >{{ ce_data.data.details_data.get('summary', '') }}</textarea>
                                                </form>
                                            </div>
                                            
                                            <!-- Footer -->
                                            <div class="px-4 py-3 bg-black bg-opacity-10 border-top border-white border-opacity-10 d-flex align-items-center gap-3">
                                                 <i class="fas fa-info-circle text-white-50"></i>
                                                 <span class="font-data small text-white-50">Direct input overrides generative model.</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Source COS -->
                                    <div class="mt-4 card border-0 shadow-sm">
                                        <div class="card-body p-4">
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-crosshairs text-secondary"></i>
                                                <span class="font-data text-muted small">SOURCE REQUIREMENT</span>
                                            </div>
                                            <div class="font-body fst-italic text-dark">{{ cos_content_with_pills | safe }}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT METRICS -->
                                <div class="col-lg-4 d-flex flex-column gap-3">
                                    <!-- Confidence -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center p-4">
                                            <span class="font-data text-muted small">COMPLETION CONFIDENCE</span>
                                            <div class="display-3 font-brand text-dark my-2" id="confidence-score-display">0%</div>
                                            <!-- Sparkline -->
                                            <div class="d-flex justify-content-center gap-1 opacity-50" style="height: 10px;">
                                                <div class="bg-success w-1 rounded" style="height:40%"></div>
                                                <div class="bg-success w-1 rounded" style="height:60%"></div>
                                                <div class="bg-success w-1 rounded" style="height:30%"></div>
                                                <div class="bg-success w-1 rounded" style="height:80%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logic Stream -->
                                    <div class="card border-0 shadow-sm flex-grow-1">
                                        <div class="card-header bg-white border-bottom">
                                            <span class="font-data small text-danger"><i class="fas fa-bolt me-2"></i>CRITICAL SIGNALS</span>
                                        </div>
                                        <div class="card-body p-0 position-relative overflow-y-auto" id="overview-logic-stream" style="max-height: 200px;">
                                            <!-- Injected via JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLLECTIONS -->
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                             <!-- Toolbar -->
                             <div class="px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-white font-data px-4 btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-2"></i> MANUAL</button>
                                    <!-- BRANDING FIX: SPECULATE -->
                                    <button class="btn btn-white font-data px-4 text-primary btn-speculate-collection" data-collection="{{ collection }}">
                                        <i class="fas fa-brain me-2"></i> SPECULATE
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm w-auto font-body" placeholder="Filter...">
                            </div>
                            <div class="flex-grow-1 p-4 overflow-y-auto collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}"></div>
                             
                             <!-- Dynamic Editor -->
                             <div class="collection-editor p-4 bg-white border-top shadow-lg position-absolute bottom-0 w-100" id="editor-{{ collection }}-{{ ceId }}" style="display:none; z-index: 50;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="font-brand mb-0">EDIT {{ collection[:-1]|upper }}</h5>
                                    <button type="button" class="btn-close btn-cancel-edit"></button>
                                </div>
                                <form class="editor-form" data-collection="{{ collection }}">
                                    {% set schema = node_info.get(collection[:-1] + '_schema', []) %}
                                    <div class="row g-3">
                                        {% for field in schema %}
                                        <div class="col-12 {{ 'col-md-6' if field.type != 'textarea' else '' }}">
                                            <label class="font-data text-muted small mb-1">{{ field.label }}</label>
                                            {% if field.type == 'textarea' %}<textarea name="{{ field.key }}" class="form-control bg-light" rows="2"></textarea>
                                            {% elif field.type == 'select' %}<select name="{{ field.key }}" class="form-select font-body">{% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}</select>
                                            {% elif field.type == 'slider' %}<div class="ce-range-wrap"><input type="range" class="ce-range-input" name="{{ field.key }}" min="0" max="100" step="10"><span class="ce-range-value">50%</span></div>
                                            {% elif field.type == 'toggle' %}<div class="mt-2"><label class="ce-toggle-switch"><input type="checkbox" name="{{ field.key }}"><span class="ce-toggle-slider"></span></label></div>
                                            {% else %}<input type="text" name="{{ field.key }}" class="form-control">{% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-4 text-end"><button type="submit" class="btn btn-success font-data px-4 rounded-pill">SAVE ENTRY</button></div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- CONNECTIONS -->
                        <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                            <div class="text-center p-5 text-muted"><i class="fas fa-project-diagram fa-3x mb-3 opacity-25"></i><h5 class="font-brand">VECTOR MAP</h5><p class="small">No connections yet.</p></div>
                        </div>

                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column border-start bg-white">
                    <div class="sidebar-persona-header" id="ai-sidebar-header"></div>
                    <div class="p-3 flex-grow-1 overflow-y-auto" id="ai-sidebar-content"></div>
                </div>

            </div>
            <!-- FOOTER -->
            <div class="modal-footer ce-modal-footer"><div class="font-data text-muted small me-auto" id="save-status">STATUS: UNSAVED</div><div class="d-flex gap-2"><button class="btn btn-outline-secondary rounded-pill px-4 font-data" data-bs-dismiss="modal">EXIT</button><button class="btn btn-primary rounded-pill px-4 font-data btn-save-changes">SAVE {{ ceType.upper() }}</button></div></div>
        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    
    # --- CRITICAL FIX: Ensure ID is a string before template rendering ---
    # Handle UUID objects or None types safely
    raw_id = ce_data.get('id', 'new_ce')
    safe_ce_id = str(raw_id) if raw_id else 'new_ce'

    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=safe_ce_id,  # Use the safe string version
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

üè™ store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

üè≥Ô∏è‚Äçüåà system_nodes.py:
# system_nodes.py
"""
THE SYSTEM PARAMETER MANIFEST (v4.2 - Future Fulfilled Edition)
------------------------------------
This file defines the "Physics" of the SSOL Universe.
It translates User-Friendly Concepts (Frontend) into Rigorous AI Constraints (Backend).

CHANGELOG v4.2:
- GOAL: Renamed to "The Future Fulfilled" to enforce the doctrine of completed possibility.
- DIRECTIVE: Converted to 'textarea' to support multiple Standards/Core Values.
- PROMPTS: Tuned to prioritize Ethical Constraints over Efficiency.
"""

SYSTEM_NODES = {
    # ==============================================================================
    # 0. THE MASTER NODE (The Root Container)
    # ==============================================================================
    "GOAL": {
        "label": "The Future Fulfilled",  # Doctrine-aligned naming
        "icon": "fa-solid fa-bullseye",
        "color": "#212121", 
        "description": "The destination as a completed fact.",
        "guide": "Speak from the future. Do not say 'We want to build a park.' Say 'The Community Park IS open and thriving.'",
        "ui_type": "textarea",
        "prompt_injection": "PRIME DIRECTIVE ATTENUATION: The user has defined the Future Fulfilled as: '{value}'. All generated content must act as history leading up to this established fact."
    },

    # ==============================================================================
    # 1. CORE CONSTRAINTS (Identity & Time)
    # ==============================================================================
    "OPERATOR": {
        "label": "The Driver",
        "icon": "fa-solid fa-user-check",
        "color": "#03a9f4", # Light Blue
        "description": "Who is responsible for this outcome?",
        "guide": "The identity of the driver determines available leverage. (e.g. 'A Mom' has different leverage than 'A Mayor').",
        "ui_type": "entity_stack",
        "prompt_injection": """
            OPERATOR ATTENUATION: The executing agent is defined as: '{value}'. 
            Filter all suggestions to match the capabilities of this entity type. 
            (e.g., Individuals cannot pass laws; Governments cannot move fast; Non-Profits need grants).
        """
    },

    "HORIZON": {
        "label": "Target Date",
        "icon": "fa-solid fa-calendar-day",
        "color": "#ff9800", # Amber
        "description": "The date this reality is fully realized.",
        "guide": "Is this a hard deadline (e.g., Election Day) or a flexible target?",
        "ui_type": "date_manager", 
        "prompt_injection": """
            TEMPORAL ATTENUATION: The system has a hard stop at '{value}'. 
            All generated roadmaps, lead times, and resource acquisitions must mathematically fit within this window. 
            Flag any CEs that inherently require more time than available as 'High Risk'.
        """
    },

    # ==============================================================================
    # 2. PHYSICS & LOGISTICS (The Engine)
    # ==============================================================================

    "BUDGET": {
        "label": "Funding Model",
        "icon": "fa-solid fa-piggy-bank",
        "color": "#4caf50", # Green
        "description": "The energy source for the project.",
        "guide": "How is this sustained? (e.g. 'Grant Funded' changes the reporting requirements; 'Bootstrapped' changes the speed).",
        "ui_type": "select",
        "options": [
            "Self-Funded (Sweat Equity)", 
            "Crowdfunded (Public Backing)", 
            "Grant Funded (Non-Profit)", 
            "Venture Capital (High Growth)", 
            "Public Budget (Taxpayer)"
        ],
        "prompt_injection": """
            ECONOMIC ATTENUATION: The project operates on a '{value}' model. 
            Filter resource suggestions to match this economic physics. 
            (e.g., if Self-Funded, prioritize 'barter' and 'volunteerism'. If VC, prioritize 'speed' and 'hiring').
        """
    },

    "SCALE": {
        "label": "Scale & Reach",
        "icon": "fa-solid fa-map-location-dot",
        "color": "#3f51b5", # Indigo
        "description": "The physical or digital footprint.",
        "guide": "Are we impacting a block, a city, or the planet?",
        "ui_type": "select",
        "options": [
            "Neighborhood (Hyper-Local)", 
            "City-Wide (Municipal)", 
            "Regional (State/Provincial)", 
            "Global (Planetary/Digital)"
        ],
        "prompt_injection": """
            SPATIAL ATTENUATION: The solution is scoped to a '{value}' footprint. 
            Ensure Stakeholder suggestions match this jurisdiction (e.g., City Council vs. UN).
            Ensure Resource suggestions match this logistics chain.
        """
    },

    "MODALITY": {
        "label": "Work Style",
        "icon": "fa-solid fa-people-carry-box",
        "color": "#607d8b", # Blue Grey
        "description": "The rhythm of coordination.",
        "guide": "How do we move? Agile (Iterative), Waterfall (Planned), Swarm (Decentralized), or Crisis (Speed).",
        "ui_type": "select",
        "options": [
            "Agile / Iterative", 
            "Waterfall / Planned", 
            "Swarm / Decentralized", 
            "Crisis Response"
        ],
        "prompt_injection": """
            METHODOLOGICAL ATTENUATION: Work is performed using a '{value}' style. 
            Structure Prerequisites as 'Sprints' or 'Milestones' accordingly.
            Define 'Done' based on this philosophy.
        """
    },

    # ==============================================================================
    # 3. VALUES & ETHICS (The Filter)
    # ==============================================================================

    "DIRECTIVE": {
        "label": "Core Values & Standards",  # Updated Label
        "icon": "fa-solid fa-heart",
        "color": "#9c27b0", # Deep Purple
        "description": "The immutable standards we uphold.",
        "guide": "List the non-negotiables. (e.g., '1. Open Source Code, 2. Living Wage, 3. Zero Carbon').",
        "ui_type": "textarea", # Changed to Textarea for multi-value input
        "examples": [
            "Open Source, Radical Transparency", 
            "Local Sourcing Only, Zero Waste", 
            "Consensus Governance, DEI Priority"
        ],
        "prompt_injection": """
            ETHICAL ATTENUATION: The project is strictly bound by these Core Values: '{value}'. 
            Any AI suggestion (resource, partner, or method) that conflicts with these standards must be rejected. 
            Prioritize alignment with these values over speed or cost efficiency.
        """
    },

    "AVOIDANCE": { 
        "label": "Dealbreakers",
        "icon": "fa-solid fa-triangle-exclamation",
        "color": "#ef5350", # Red
        "description": "Outcomes we must prevent at all costs.",
        "guide": "What does failure look like? (e.g. 'Displacing residents', 'Taking on debt').",
        "ui_type": "textarea", # Changed to Textarea
        "examples": ["Displacing Residents", "Vendor Lock-in", "Public Debt"],
        "prompt_injection": """
            RISK ATTENUATION: The project must specifically avoid: '{value}'. 
            Scan all generated CEs for second-order effects that might trigger this negative outcome.
        """
    },

    # ==============================================================================
    # 4. THE ARTIFACT
    # ==============================================================================

    "FULFILLMENT": {
        "label": "Final Artifact",
        "icon": "fa-solid fa-box-open",
        "color": "#009688", # Teal
        "description": "The tangible evidence of completion.",
        "guide": "When the dust settles, what physical/digital object proves we finished? (e.g. 'The Signed Treaty', 'The Occupied Building').",
        "ui_type": "text",
        "examples": ["Legislative Bill", "Physical Prototype", "Research Paper", "Community Center"],
        "prompt_injection": """
            ARTIFACT ATTENUATION: The final output must be a '{value}'. 
            Reverse-engineer the 'Production' CEs required to manufacture/author/build this specific object.
        """
    },

    # ==============================================================================
    # 5. WILDCARD
    # ==============================================================================
    "CUSTOM": {
        "label": "Custom Constraint",
        "icon": "fa-solid fa-fingerprint",
        "color": "#e91e63", # Pink
        "description": "Any specific requirements unique to this vision.",
        "ui_type": "text",
        "prompt_injection": """
            CUSTOM ATTENUATION: adhere strictly to this user-defined constraint: '{value}'.
        """
    }
}

def get_valid_system_types():
    """Returns a list of all valid system node keys."""
    return list(SYSTEM_NODES.keys())

def get_system_node_config(key):
    """Safe retrieval of config with fallback."""
    return SYSTEM_NODES.get(key, SYSTEM_NODES['OPERATOR'])

üîµ system_cards.js:
// static/js/system_cards.js
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Unified State Management ---
let sysState = {
    config: {},             // Loaded from window.SYSTEM_NODES_CONFIG
    nodeKeys: [],           // Array of node types (['HORIZON', 'OPERATOR', ...])
    currentIndex: 0,        // Current slide index
    ssolId: null,           // Context SSOL ID
    
    // Entity Store for the OPERATOR stack (client-side cache)
    entityStore: { 
        'OPERATOR': [] 
    },

    // Transient Editing State (The "Buffer")
    editingId: null,        // DB ID of the node being edited (or '' for new)
    tempValue: null,        // Current value in the input field
    isSpeculating: false,   // Loading state flag
    constraintMode: 'HARD'  // HARD vs SOFT constraint
};

/**
 * Initializes the System Card Controller.
 * Called from outcome.html once the DOM is ready.
 */
export function initSystemCards(ssolId) {
    sysState.ssolId = ssolId;
    
    // 1. Load Configuration (Injected in base.html)
    if(window.SYSTEM_NODES_CONFIG) {
        sysState.config = window.SYSTEM_NODES_CONFIG;
        sysState.nodeKeys = Object.keys(sysState.config);
    }

    // 2. Bind Global Functions for HTML OnClick Attributes
    window.openSystemEditor = openSystemEditor;
    window.navigateSystemNode = navigateSystemNode;
    window.setProtocolMode = setProtocolMode;
    window.setConstraintMode = setConstraintMode;
    window.submitSystemForm = submitSystemForm;
    window.addEntity = addEntity;
}

/**
 * Opens the Modal and jumps to specific node type.
 * @param {string} existingId - The specific DB ID (or 'new')
 * @param {string} type - The System Node Type (e.g., 'BUDGET', 'OPERATOR')
 * @param {string} currentValue - The current value to pre-fill
 */
function openSystemEditor(existingId, type, currentValue) {
    // 1. Set Carousel Index
    if (type && sysState.nodeKeys.includes(type)) {
        sysState.currentIndex = sysState.nodeKeys.indexOf(type);
    } else {
        sysState.currentIndex = 0; 
    }

    // 2. Hydrate State
    sysState.editingId = existingId === 'new' ? '' : existingId;
    // Handle 'None' string from Jinja template if field is empty
    sysState.tempValue = (currentValue && currentValue !== 'None') ? currentValue : '';
    sysState.constraintMode = 'HARD'; // Reset to default

    updateModalView();
    
    // 3. Launch Bootstrap Modal
    const modalEl = document.getElementById('systemConfigModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

/**
 * Handles Carousel Navigation (Prev/Next)
 */
function navigateSystemNode(direction) {
    // 1. Update Index
    sysState.currentIndex += direction;
    
    // Loop navigation
    if (sysState.currentIndex < 0) sysState.currentIndex = sysState.nodeKeys.length - 1;
    if (sysState.currentIndex >= sysState.nodeKeys.length) sysState.currentIndex = 0;
    
    // 2. Reset Transient State for the new card
    sysState.editingId = ""; 
    sysState.tempValue = ""; 
    // In a real app, you might want to fetch the existing value for this next node here
    // For now, we start fresh or relying on what passed in via click (limit of this carousel implementation)

    updateModalView();
}

/**
 * CORE RENDER LOGIC
 * Updates the Left (Visual) and Right (Input) panels based on the State.
 */
function updateModalView() {
    const typeKey = sysState.nodeKeys[sysState.currentIndex];
    const config = sysState.config[typeKey] || {};
    
    // --- 1. Identity Panel (Left) ---
    const identityPanel = document.getElementById('sys-identity-panel');
    identityPanel.style.backgroundColor = config.color;
    
    document.getElementById('sys-display-icon').className = `fas ${config.icon} fa-2x text-white`;
    document.getElementById('sys-display-label').textContent = config.label;
    
    // VISUALIZER: Render the correct state view (Gauge, Stack, or Text)
    renderVisualizer(typeKey, sysState.tempValue, config.color);

    // --- 2. Calibration Console (Right) ---
    // Ontology & Guide
    document.getElementById('sys-display-desc').textContent = config.description;
    document.getElementById('sys-display-guide').textContent = config.guide;

    // Examples Container (New Feature)
    const exContainer = document.getElementById('sys-examples-container');
    exContainer.innerHTML = "";
    if(config.examples && Array.isArray(config.examples)) {
        config.examples.forEach(ex => {
            const badge = document.createElement('span');
            badge.className = "badge bg-white border text-secondary fw-normal cursor-pointer hover-shadow";
            badge.textContent = ex;
            badge.onclick = () => {
                // Click to fill
                sysState.tempValue = ex;
                renderBespokeInput(typeKey, sysState.tempValue, config.color, config);
                renderVisualizer(typeKey, sysState.tempValue, config.color);
            };
            exContainer.appendChild(badge);
        });
    }

    // Hidden Form Inputs
    document.getElementById('sys-param-type').value = typeKey;
    document.getElementById('sys-param-id').value = sysState.editingId;

    // Render Input Fields
    renderBespokeInput(typeKey, sysState.tempValue, config.color, config);
    
    // Update Badge Status
    const statusBadge = document.getElementById('sys-status-badge');
    if(sysState.tempValue) {
        statusBadge.className = "badge bg-success-subtle text-success border border-success-subtle font-data rounded-pill px-3";
        statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i> CALIBRATED';
    } else {
        statusBadge.className = "badge bg-secondary-subtle text-secondary border border-secondary-subtle font-data rounded-pill px-3";
        statusBadge.innerHTML = '<i class="fas fa-circle me-1" style="font-size:8px;"></i> UNSET';
    }

    // Pagination Dots
    document.getElementById('sys-counter').textContent = `CARD ${sysState.currentIndex + 1} / ${sysState.nodeKeys.length}`;
    const dotContainer = document.getElementById('sys-dots-container');
    dotContainer.innerHTML = sysState.nodeKeys.map((k, i) => 
        `<div class="sys-dot ${i === sysState.currentIndex ? 'active' : ''}" style="opacity: ${i === sysState.currentIndex ? '1' : '0.3'}"></div>`
    ).join('');
}

/**
 * Renders the Left Column State Monitor (Visual Feedback)
 */
function renderVisualizer(type, value, color) {
    const container = document.getElementById('sys-visualizer-container');
    container.innerHTML = ''; 

    // CASE: OPERATOR (Stack of Identity Cards)
    if (type === 'OPERATOR') {
        const entities = sysState.entityStore['OPERATOR'];
        
        if ((!entities || entities.length === 0) && !value) {
             container.innerHTML = `
                <div class="bg-white bg-opacity-10 border-2 border-dashed border-white border-opacity-25 rounded-xl p-5 text-center text-white-50">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="small font-bold">NO CHAMPIONS ASSIGNED</div>
                </div>`;
        } else {
            // Visualize entities OR the text value
            const displayEntities = (entities && entities.length > 0) 
                ? entities 
                : [{name: value, role: 'Primary Contact', org: 'Entity'}];
            
            displayEntities.forEach(ent => {
                container.innerHTML += `
                <div class="sys-entity-card">
                     <div class="sys-entity-avatar" style="color:${color}; background: #fff;">${ent.name ? ent.name[0] : '?'}</div>
                     <div style="flex-grow:1; overflow:hidden;">
                        <div class="font-bold text-dark text-truncate" style="font-size:0.85rem;">${ent.name || 'Unknown'}</div>
                        <div class="font-data text-muted x-small text-truncate">${ent.role} ‚Ä¢ ${ent.org}</div>
                     </div>
                     <div class="badge bg-light text-muted border"><i class="fas fa-box"></i></div>
                </div>`;
            });
        }
        return;
    }

    // CASE: HORIZON (Velocity Gauge)
    if (type === 'HORIZON') {
        container.innerHTML = `
             <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-2xl p-4 backdrop-blur-sm text-center">
                 <div class="font-data text-white-50 x-small uppercase tracking-widest mb-2">TIMELINE VELOCITY</div>
                 <div class="display-4 font-brand text-white mb-0">${value ? value.split('-')[0] : '--'}</div>
                 <div class="font-data text-white-50 x-small uppercase tracking-wide mb-3">TARGET HORIZON</div>
                 <div class="progress" style="height: 4px; background-color: rgba(255,255,255,0.2);">
                    <div class="progress-bar bg-white" style="width: ${value ? '65%' : '0%'}"></div>
                 </div>
             </div>`;
        return;
    }

    // DEFAULT: Big Typographic Display (The "Active Pill")
    if (value && value.trim() !== "") {
        container.innerHTML = `
            <div class="bg-white bg-opacity-10 border border-white border-opacity-25 rounded-pill p-3 pe-5 d-flex align-items-center backdrop-blur transition-all">
                <div class="rounded-circle bg-white text-dark d-flex align-items-center justify-content-center shadow-sm me-3" 
                     style="width: 42px; height: 42px; flex-shrink: 0;">
                    <!-- Use icon from current config in state -->
                    <i class="fas ${sysState.config[type].icon} fa-lg" style="color: ${color}"></i>
                </div>
                <div>
                    <div class="font-data text-white-50 x-small uppercase tracking-wide mb-0">ANCHOR VALUE</div>
                    <div class="font-body text-white fw-bold fs-5 leading-tight text-truncate" style="max-width: 220px;">
                        ${value}
                    </div>
                </div>
            </div>`;
    } else {
        container.innerHTML = `
             <div class="border border-dashed border-white border-opacity-25 rounded-pill p-4 text-center text-white-50 font-data small">
                <i class="fas fa-terminal me-2"></i> AWAITING INPUT
             </div>
        `;
    }
}

/**
 * Renders the Right Column Input Area and attaches Live Listeners
 */
function renderBespokeInput(type, value, color, config) {
    const container = document.getElementById('sys-input-container');
    container.innerHTML = '';

    // 1. OPERATOR (Contact Form)
    if (type === 'OPERATOR') {
        container.innerHTML = `
            <div class="bg-light rounded-3 p-3 border border-light-subtle">
                <div class="d-flex align-items-center gap-2 mb-3 text-muted border-bottom pb-2">
                    <i class="fas fa-user-plus small"></i>
                    <span class="font-data x-small fw-bold tracking-widest">ADD CHAMPION</span>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" id="ent-name" class="form-control form-control-sm" placeholder="Entity Name" value="${value}">
                    </div>
                    <div class="col-6"><input type="text" id="ent-role" class="form-control form-control-sm" placeholder="Role / Title"></div>
                    <div class="col-6"><input type="text" id="ent-org" class="form-control form-control-sm" placeholder="Organization"></div>
                </div>
                <button type="button" class="btn btn-dark w-100 btn-sm mt-3 font-data" onclick="addEntity()">
                    <i class="fas fa-plus-circle me-1"></i> ADD TO STACK
                </button>
                <input type="hidden" name="value" id="real-value-input" value="${value}">
            </div>
        `;
        
        // Attach listener for single-value simple entry
        document.getElementById('ent-name').oninput = (e) => {
            sysState.tempValue = e.target.value;
            document.getElementById('real-value-input').value = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
        return;
    }

    // 2. SELECT DROPDOWN
    if (config.options && Array.isArray(config.options)) {
        const opts = config.options.map(opt => 
            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
        ).join('');
        
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">SELECT CONFIGURATION</label>
                <select name="value" id="sys-param-value" class="form-select form-select-lg font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none bg-transparent">
                    <option value="" disabled ${!value ? 'selected' : ''}>Choose...</option>
                    ${opts}
                </select>
            </div>
        `;
    } 
    // 3. HORIZON (Date)
    else if (type === 'HORIZON') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">TARGET DATE</label>
                <input type="date" name="value" id="sys-param-value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                       value="${value}" style="background:transparent;">
            </div>
        `;
    } 
    // 4. DEFAULT (Text)
    else {
        container.innerHTML = `
            <div class="mb-3">
                <label class="font-data text-muted x-small mb-2" style="color:${color} !important">ANCHOR VALUE</label>
                <input type="text" name="value" id="sys-param-value" class="form-control form-control-lg fs-4 font-body fw-bold border-0 border-bottom rounded-0 px-0 shadow-none" 
                       value="${value}" placeholder="Define value..." autocomplete="off" style="background:transparent;">
            </div>
        `;
    }

    // Bind Live Update Listener
    const mainInput = document.getElementById('sys-param-value');
    if(mainInput) {
        mainInput.oninput = (e) => {
            sysState.tempValue = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
        // For Select, onchange is better
        mainInput.onchange = (e) => {
            sysState.tempValue = e.target.value;
            renderVisualizer(type, e.target.value, color);
        };
    }
}

// --- Interaction Handlers ---

function setProtocolMode(mode) {
    // UI Toggle
    document.querySelectorAll('.sys-protocol-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`mode-${mode.toLowerCase()}`).classList.add('active');
    
    const container = document.getElementById('sys-input-container');
    const type = document.getElementById('sys-param-type').value;

    if (mode === 'SPECULATE') {
        sysState.isSpeculating = true;
        container.innerHTML = `
            <div class="bg-light border border-primary-subtle rounded-3 p-5 text-center animate-in fade-in">
                <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="font-body small text-muted">Connecting to SSPEC Engine...</p>
                <div class="font-data x-small text-muted tracking-widest mt-2">OPTIMIZING ${type}</div>
            </div>
        `;
        
        // Mock Simulation (In real app: fetch /speculate_system_node)
        setTimeout(() => {
            let suggestion = "AI Optimized Value";
            if(type === 'HORIZON') suggestion = "2026-11-15"; 
            if(type === 'OPERATOR') suggestion = "Strategic Consortium";
            if(type === 'BUDGET') suggestion = "Grant Funded";
            
            // Switch back to Specify
            sysState.isSpeculating = false;
            setProtocolMode('SPECIFY');
            
            // Update State
            sysState.tempValue = suggestion;
            
            // Re-render inputs and visualizer
            const typeKey = sysState.nodeKeys[sysState.currentIndex];
            const config = sysState.config[typeKey];
            
            setTimeout(() => {
                renderBespokeInput(typeKey, suggestion, config.color, config);
                renderVisualizer(typeKey, suggestion, config.color);
                
                // For Operator, sync specific fields
                if(type === 'OPERATOR') {
                    const entInput = document.getElementById('ent-name');
                    const realInput = document.getElementById('real-value-input');
                    if(entInput) entInput.value = suggestion;
                    if(realInput) realInput.value = suggestion;
                }
            }, 50);
        }, 1200);
    } else {
        // Cancel Speculation / Return to form
        if(!sysState.isSpeculating) {
            updateModalView();
        }
    }
}

function setConstraintMode(mode) {
    sysState.constraintMode = mode;
    
    document.querySelector('.selected-mode-card').classList.remove('selected-mode-card');
    
    document.getElementById('constraint-hard').classList.add('opacity-50');
    document.getElementById('constraint-soft').classList.add('opacity-50');
    
    const target = document.getElementById(`constraint-${mode.toLowerCase()}`);
    target.classList.remove('opacity-50');
    target.classList.add('selected-mode-card');
    
    document.getElementById('sys-constraint-input').value = mode;
}

function addEntity() {
    const name = document.getElementById('ent-name').value;
    const role = document.getElementById('ent-role').value || 'Lead';
    const org = document.getElementById('ent-org').value || 'External';
    
    if(name) {
        // Update Store
        if(!sysState.entityStore['OPERATOR']) sysState.entityStore['OPERATOR'] = [];
        sysState.entityStore['OPERATOR'].push({name, role, org, id: Date.now()});
        
        // Update State
        sysState.tempValue = sysState.entityStore['OPERATOR'].map(e => e.name).join(', ');
        
        // Update Visualizer
        const config = sysState.config['OPERATOR'];
        renderVisualizer('OPERATOR', sysState.tempValue, config.color);
        
        // Update Hidden Input
        const realInput = document.getElementById('real-value-input');
        if(realInput) realInput.value = sysState.tempValue;

        // Clear Form
        document.getElementById('ent-name').value = '';
        document.getElementById('ent-role').value = '';
        document.getElementById('ent-org').value = '';
    }
}

function submitSystemForm() {
    const form = document.getElementById('system-node-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    data.ssol_id = sysState.ssolId;
    data.key = data.sys_type;

    // UI Feedback
    const btn = document.querySelector('button[onclick="submitSystemForm()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i> SAVING...';
    btn.disabled = true;

    fetch('/update_ssol_system_node', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(response => {
        if (response.success) {
            const modalEl = document.getElementById('systemConfigModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // Reload to reflect changes on main dashboard
            location.reload(); 
        } else {
            alert("Error saving: " + (response.error || "Unknown error"));
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Network Error");
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

üîµ ce_cards.js:
// static/js/ce_cards.js
// SSPEC "Horizon Fusion" - Condition Element Application Controller (v2025.40)

import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// =============================================================================
// 1. CENTRAL STATE MANAGEMENT
// =============================================================================

const DEFAULT_STATE = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    details_data: {},
    nodeSchema: {},
    isSaving: false,
    isScanning: false
};

let state = { ...DEFAULT_STATE };

// =============================================================================
// 2. PERSONA MATRIX & CONFIG
// =============================================================================

const PERSONAS = {
    "Research": { title: "DEEP TRUTH ENGINE", icon: "fa-flask", class: "persona-research", tone: "Empirical" },
    "Risk": { title: "SECURITY OVERWATCH", icon: "fa-shield-virus", class: "persona-risk", tone: "Critical" },
    "Stakeholder": { title: "NETWORK DIPLOMAT", icon: "fa-handshake", class: "persona-stakeholder", tone: "Strategic" },
    "Advocacy": { title: "AMPLIFIER", icon: "fa-bullhorn", class: "persona-advocacy", tone: "Persuasive" },
    "Environment": { title: "SYSTEM ECOLOGIST", icon: "fa-leaf", class: "persona-research", tone: "Holistic" },
    "Timeline": { title: "TEMPORAL ARCHITECT", icon: "fa-stopwatch", class: "persona-default", tone: "Linear" },
    "Default": { title: "SPECULATE CO-PILOT", icon: "fa-brain", class: "persona-default", tone: "Helpful" }
};

// =============================================================================
// 3. INITIALIZATION & LIFECYCLE
// =============================================================================

export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    if (!modalContainer) return console.error("Critical: Modal container missing.");
    
    modalContainer.innerHTML = modalHtml;
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    if (!modalElement) return console.error("Critical: Modal DOM insertion failed.");

    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        // 1. Resolve Schema
        const nodeConfig = (window.NODES && window.NODES[p_ceType]) ? window.NODES[p_ceType] : (window.NODES['Default']);

        // 2. Hydrate State (Resetting cleanly)
        const d = ceData?.data || {};
        state = {
            modalElement, 
            ceId, 
            ceType: p_ceType, 
            activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
            nodeSchema: nodeConfig,
            isSaving: false,
            isScanning: false
        };
        
        // 3. Boot System
        render(); 
        setupEventListeners();
        
        // 4. "One-Hit Production" Check
        // If the node is empty, wake up the engine.
        checkAndTriggerAutoPopulation();

    }, { once: true });

    modalElement.addEventListener('hidden.bs.modal', () => {
        state = { ...DEFAULT_STATE }; // GC helper
        modalElement.remove();
    });

    modal.show();
}

// =============================================================================
// 4. AUTOMATION LOGIC ("ONE-HIT PRODUCTION")
// =============================================================================

function checkAndTriggerAutoPopulation() {
    // Logic: If critical collections are empty, we assume it's a fresh node.
    const isFresh = ['prerequisites', 'stakeholders', 'assumptions'].every(k => state.collections[k].length === 0);
    
    // Also check if summary is empty
    const hasSummary = state.details_data.summary && state.details_data.summary.length > 5;

    if (isFresh && !hasSummary) {
        console.log("System Scan Initiated: Fresh Node Detected");
        state.isScanning = true;
        updateDashboard(); // Updates the visual "Scanning" state

        // Staggered Execution (Waterfall Effect)
        // 1. Narrative (Immediate)
        triggerEnhancement('summary', null, true); 
        
        // 2. Collections (Staggered 1.5s intervals)
        setTimeout(() => triggerSpeculation('prerequisites', null, true), 1200);
        setTimeout(() => triggerSpeculation('stakeholders', null, true), 2800);
        setTimeout(() => triggerSpeculation('assumptions', null, true), 4200);
        
        // End Scan visual state after last item
        setTimeout(() => {
            state.isScanning = false;
            updateDashboard();
        }, 5000);
    }
}

// =============================================================================
// 5. RENDER PIPELINE
// =============================================================================

function render() {
    if (!state.modalElement) return;
    
    // Batch rendering
    renderAllCollections();
    renderOverviewStream();
    renderSidebarPersona();
    renderAiSidebarContent();
    updateDashboard();
}

function renderAllCollections() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(type => {
        renderCollectionList(type);
    });
}

function renderOverviewStream() {
    const container = state.modalElement.querySelector('#overview-logic-stream');
    if(!container) return;

    let signals = [];
    
    // Extract Critical Signals (Top items)
    (state.collections.prerequisites || []).slice(0, 3).forEach(i => 
        signals.push({ type: 'PREREQ', text: i.title, icon: 'fa-check-square', color: 'text-primary' })
    );
    (state.collections.assumptions || []).slice(0, 2).forEach(i => 
        signals.push({ type: 'RISK', text: i.hypothesis, icon: 'fa-exclamation-circle', color: 'text-danger' })
    );

    if (signals.length === 0) {
        container.innerHTML = `<div class="text-center p-4 opacity-50"><i class="fas fa-wind mb-2"></i><div class="font-data small">No Signals</div></div>`;
        return;
    }

    container.innerHTML = `<ul class="list-group list-group-flush">` + signals.map(s => `
        <li class="list-group-item px-3 py-2 border-0 border-bottom signal-item type-${s.type} bg-transparent">
            <div class="d-flex align-items-center">
                <i class="fas ${s.icon} ${s.color} me-3"></i>
                <div class="text-truncate font-body small fw-bold text-dark">${s.text || 'Untitled'}</div>
            </div>
        </li>
    `).join('') + `</ul>`;
}

function renderCollectionList(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];

    // --- Empty State ---
    if (items.length === 0) {
        let icon = "fa-wind";
        let text = "Auto-Generate";
        let btnIcon = "fa-magic";
        
        // Context-aware empty states
        if (type === 'stakeholders' || type === 'resources') { 
            text = "Query SSPEC Network"; 
            btnIcon = "fa-globe";
        } else {
            text = "Run Speculate Engine";
            btnIcon = "fa-microchip";
        }
        
        container.innerHTML = `
            <div class="text-center p-5 opacity-50 border border-dashed rounded bg-light mt-3">
                <i class="fas ${icon} fa-2x mb-3 text-muted"></i>
                <p class="font-data small text-muted mb-3">DATA STREAM EMPTY</p>
                <button class="btn btn-sm btn-outline-primary font-data rounded-pill px-4 btn-speculate-collection" data-collection="${type}">
                    <i class="fas ${btnIcon} me-2"></i> ${text}
                </button>
            </div>`;
        return;
    }

    // --- Dynamic Schema Mapping ---
    const schemaKey = type.slice(0, -1) + '_schema';
    const fields = state.nodeSchema[schemaKey] || [];
    const titleKey = fields[0]?.key || 'title';
    const subKey = fields[1]?.key || 'status';

    // --- Render Cards ---
    container.innerHTML = items.map(item => {
        const title = item[titleKey] || 'Untitled';
        const subtitle = item[subKey] || 'Pending';
        
        // POSSIBILITY LOGIC:
        // Items tagged "AI" are "Possibilities" (Dashed, Ethereal)
        // Items accepted are "Reality" (Solid)
        const isProposed = item.tags && item.tags.includes("AI");

        const extraClass = isProposed ? "possibility-card border-dashed" : "border-start border-4";
        
        // Visual Color Coding for Reality
        let stripStyle = "";
        if (!isProposed) {
            let color = "var(--phase-color)"; // Default
            if (['Verified','Signed','Met','Complete'].includes(item.status)) color = "#10b981"; // Green
            else if (['Blocked','High'].includes(item.status)) color = "#ef4444"; // Red
            stripStyle = `border-left-color: ${color} !important;`;
        }

        return `
        <div class="collection-card-modern ${extraClass}" style="${stripStyle} transition: all 0.2s;">
            <div class="flex-grow-1 ps-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="card-title-modern">${title}</div>
                    ${isProposed ? '<span class="badge bg-primary-soft text-primary font-data" style="font-size:0.6em">POSSIBILITY</span>' : ''}
                </div>
                <div class="card-subtitle-modern text-truncate">${subtitle}</div>
            </div>
            <div class="d-flex align-items-center gap-1">
                ${isProposed 
                    ? `<button class="btn btn-sm btn-outline-success btn-accept p-1 px-2 shadow-sm" data-col="${type}" data-id="${item.id}" title="Accept Possibility"><i class="fas fa-check"></i></button>`
                    : `<button class="btn btn-sm btn-link text-muted p-1 btn-edit-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>`
                }
                <button class="btn btn-sm btn-link text-danger p-1 btn-delete-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-times"></i></button>
            </div>
        </div>`;
    }).join('');
}

// =============================================================================
// 6. DASHBOARD & SIDEBAR METRICS
// =============================================================================

function updateDashboard() {
    // 1. Update Collection Badges
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(k => {
        const count = (state.collections[k] || []).length;
        const badge = state.modalElement.querySelector(`.count-badge[data-collection="${k}"]`);
        if (badge) {
            badge.textContent = count;
            if(count > 0) {
                badge.classList.remove('bg-light', 'text-dark');
                badge.classList.add('bg-primary', 'text-white');
            }
        }
    });

    // 2. Calculate Confidence Score (Heuristic)
    let score = 0;
    const totalGoal = 60; 
    
    // Points for existing
    Object.values(state.collections).flat().forEach(i => {
        if (i.tags !== "AI") score += 5; // Real items count more
        if (['Verified', 'Met', 'Signed', 'Active'].includes(i.status)) score += 5;
    });
    // Points for narrative
    if (state.details_data.summary && state.details_data.summary.length > 20) score += 10;

    const percent = Math.min(100, Math.floor((score / totalGoal) * 100));
    
    // 3. Update Visual Displays
    const bar = state.modalElement.querySelector('#ce-progress-bar'); // If existing in template
    const scoreDisplay = state.modalElement.querySelector('#confidence-score-display');
    
    if(scoreDisplay) scoreDisplay.innerText = `${percent}%`;

    // 4. Update Status Card (Handling Scanning State)
    const statusCard = state.modalElement.querySelector('.system-status-card'); // Optional UI hook
    const statusVal = state.modalElement.querySelector('.status-card-value');
    
    if (statusCard && statusVal) {
        if (state.isScanning) {
            statusVal.innerText = "SCANNING...";
            statusVal.className = "status-card-value text-primary animate-pulse";
            statusCard.classList.add('scanning');
        } else {
            statusCard.classList.remove('scanning');
            statusVal.className = "status-card-value"; // Reset classes
            
            if (percent === 0) statusVal.innerText = "INITIALIZED";
            else if (percent < 30) { statusVal.innerText = "ANALYZING"; statusVal.classList.add('text-warning'); }
            else if (percent < 80) { statusVal.innerText = "CALIBRATING"; statusVal.classList.add('text-info'); }
            else { statusVal.innerText = "OPTIMIZED"; statusVal.classList.add('text-success'); }
        }
    }
}

function renderSidebarPersona() {
    const header = state.modalElement.querySelector('#ai-sidebar-header');
    if(!header) return;
    
    const persona = PERSONAS[state.ceType] || PERSONAS['Default'];
    header.className = 'sidebar-persona-header ' + (persona.class || 'persona-default');
    header.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="fas ${persona.icon} fa-lg"></i>
                <span class="font-brand" style="letter-spacing:1px;">${persona.title}</span>
            </div>
            ${state.isScanning ? '<i class="fas fa-circle-notch fa-spin text-white"></i>' : '<i class="fas fa-circle text-white fa-xs opacity-75"></i>'}
        </div>
        <div class="small opacity-75 mt-1 font-data" style="letter-spacing:0.5px;">MODE: ${persona.tone.toUpperCase()}</div>
    `;
}

function renderAiSidebarContent() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if(!content) return;
    const tab = state.activeTab;
    
    // Helper for buttons
    const mkBtn = (txt, icon, color, action, isNetwork = false) => 
        `<button class="btn btn-light border w-100 text-start mb-2 shadow-sm ${action}">
            <i class="fas ${icon} me-2 text-${color}"></i> 
            ${txt}
            ${isNetwork ? '<span class="float-end badge bg-light text-muted border font-data" style="font-size:0.6em">NET</span>' : '<span class="float-end badge bg-light text-muted border font-data" style="font-size:0.6em">AI</span>'}
         </button>`;

    // --- LOGIC: SPLIT BRANDING ---
    let header = "";
    
    if (['stakeholders', 'resources'].includes(tab)) {
        // --- SSPEC NETWORK MODE ---
        header = `
            <div class="mb-3 pb-2 border-bottom">
                <div class="font-data text-primary small fw-bold tracking-widest"><i class="fas fa-globe me-2"></i>SSPEC NETWORK</div>
                <div class="font-body x-small text-muted">Searching distributed ledger for partners.</div>
            </div>`;
            
        const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
        
        // Network Actions
        header += mkBtn(`Query ${label} Pool`, "search-location", "primary", `btn-speculate-collection" data-collection="${tab}`, true);
        header += mkBtn("Match Capabilities", "link", "info", "", true);
        
    } else {
        // --- SPECULATE ENGINE MODE ---
        header = `
            <div class="mb-3 pb-2 border-bottom">
                <div class="font-data text-danger small fw-bold tracking-widest"><i class="fas fa-microchip me-2"></i>SPECULATE ENGINE</div>
                <div class="font-body x-small text-muted">Generative model active (v2025.23).</div>
            </div>`;

        if (tab === 'overview') {
            header += mkBtn("Strategic Synthesis", "chess-board", "danger", "btn-trigger-ai' data-context='narrative' data-sub='context");
            header += mkBtn("Analyze Critical Path", "project-diagram", "warning", "btn-trigger-ai' data-context='assumptions");
        } else {
            // Prereqs, Assumptions, etc.
            const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
            header += mkBtn(`Speculate ${label}s`, "bolt", "danger", `btn-speculate-collection" data-collection="${tab}`);
            header += mkBtn("Validate Logic", "check-double", "success", "");
        }
    }
    
    // Footer Logic (Direct Uplink)
    content.innerHTML = header + `
        <div class="mt-auto pt-4 border-top">
            <label class="font-data small text-muted mb-2">
                ${['stakeholders', 'resources'].includes(tab) ? 'NETWORK UPLINK' : 'ENGINE PROMPT'}
            </label>
            <input type="text" class="form-control form-control-sm font-body" 
                   placeholder="${['stakeholders', 'resources'].includes(tab) ? 'Search Entity Database...' : 'Input Parameter...'}">
        </div>`;
}

// =============================================================================
// 7. SERVER ACTIONS (API INTERACTION)
// =============================================================================

function triggerSpeculation(type, btn = null, isAuto = false) {
    let origHtml = '';
    
    // 1. Differentiate UI
    const isNetwork = ['stakeholders', 'resources'].includes(type);
    const loadingText = isNetwork ? 'SCANNING NETWORK...' : 'CALCULATING...';
    const loadingIcon = isNetwork ? 'fa-satellite-dish' : 'fa-circle-notch';

    if (btn) { 
        origHtml = btn.innerHTML; 
        btn.disabled = true; 
        btn.innerHTML = `<i class="fas ${loadingIcon} fa-spin me-2"></i> ${loadingText}`; 
    } 

    // 2. Scrape Context
    const contextGoalEl = state.modalElement.querySelector('.source-cos-card p');
    const contextGoal = contextGoalEl ? contextGoalEl.textContent.trim() : "Project Goal";

    // 3. Execute
    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: type, 
            cos_text: contextGoal,
            ssol_id: window.SSOL_ID || null 
        })
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP Error ${r.status}`);
        return r.json();
    })
    .then(data => {
        if (data.success && data.suggestions) {
            data.suggestions.forEach(item => {
                // Generate Client-Side ID to prevent key collisions
                item.id = self.crypto.randomUUID();
                item.tags = "AI"; 
                item.status = "Proposed";
                state.collections[type].push(item);
            });
            render(); 
        } else {
            throw new Error(data.error || "No suggestions returned.");
        }
    })
    .catch(err => {
        console.error("Speculation Error:", err);
        if (btn) {
            btn.classList.add('btn-danger', 'text-white');
            btn.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> FAILED`;
            setTimeout(() => {
                btn.classList.remove('btn-danger', 'text-white');
                btn.innerHTML = origHtml;
                btn.disabled = false;
            }, 3000);
        }
    })
    .finally(() => {
        // Restore button if no error occurred handled in catch
        if (btn && !btn.innerHTML.includes("FAILED")) { 
            btn.innerHTML = origHtml; 
            btn.disabled = false; 
        }
        updateDashboard();
    });
}

function triggerEnhancement(fieldKey, btn = null, isAuto = false) {
    if (btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> RUNNING ENGINE...'; 
    }

    const cosTextEl = state.modalElement.querySelector('.source-cos-card p');
    const cosText = cosTextEl ? cosTextEl.textContent.trim() : "Project Goal";

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: 'narrative', 
            sub_context: fieldKey, 
            cos_text: cosText,
            ssol_id: window.SSOL_ID || null
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.success && data.text) {
            state.details_data[fieldKey] = data.text;
            
            // DOM Update (to avoid full re-render flickering)
            const input = state.modalElement.querySelector(`[name="${fieldKey}"]`);
            if(input) {
                input.value = data.text;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            updateDashboard();
        }
    })
    .catch(err => {
        console.error("Narrative Error:", err);
        if(btn && !isAuto) alert("Speculation failed. Please try again.");
    })
    .finally(() => { 
        if (btn) { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="fas fa-microchip me-2"></i> SPECULATE ENGINE'; 
        } 
    });
}

function saveDataPacket() {
    const btn = state.modalElement.querySelector('.btn-save-changes');
    const status = state.modalElement.querySelector('#save-status');
    const origText = btn.innerHTML; 
    
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> COMMITTING...';
    btn.disabled = true;

    // 1. Capture Narrative Data (since it might be edited without hitting 'save' locally)
    const narrForm = state.modalElement.querySelector(`#narrative-form-${state.ceId}`);
    if (narrForm) {
        const fd = new FormData(narrForm);
        state.details_data = Object.fromEntries(fd.entries());
    }

    const packet = {
        details_data: state.details_data,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        resources: state.collections.resources,
        connections: state.collections.connections
    };

    // 2. Network Request with Error Boundary
    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    })
    .then(data => {
        if(data.success) {
            // Success Feedback
            if(status) status.innerHTML = `<span class="text-success font-data fw-bold"><i class="fas fa-check-circle me-2"></i>SYNC COMPLETE</span>`;
            
            btn.classList.replace('btn-primary', 'btn-success');
            btn.innerHTML = `<i class="fas fa-check"></i> SAVED`;
            
            setTimeout(() => { 
                btn.classList.replace('btn-success', 'btn-primary');
                btn.innerHTML = origText;
                btn.disabled = false;
            }, 2000);
        } else {
            throw new Error(data.error || "Server rejected save.");
        }
    })
    .catch(err => {
        console.error("Save Failed:", err);
        
        // Error Feedback
        if(status) status.innerHTML = `<span class="text-danger font-data fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>SAVE FAILED</span>`;
        
        btn.classList.replace('btn-primary', 'btn-danger');
        btn.innerHTML = `<i class="fas fa-redo me-2"></i> RETRY SAVE`;
        
        // Don't auto-reset the button immediately; let user see the error
        btn.disabled = false;
        
        // Clean up visual state after 4 seconds
        setTimeout(() => {
             if (btn.classList.contains('btn-danger')) {
                 btn.classList.replace('btn-danger', 'btn-primary');
                 btn.innerHTML = origText;
             }
        }, 4000);
    });
}

// =============================================================================
// 8. EVENT LISTENER DELEGATION
// =============================================================================

function setupEventListeners() {
    const m = state.modalElement;

    // A. Tabs -> Context Switching
    const nav = m.querySelector('.ce-nav-tabs');
    if(nav) {
        nav.addEventListener('shown.bs.tab', e => {
            const tid = e.target.getAttribute('data-bs-target');
            if(tid.includes('overview')) state.activeTab = 'overview';
            else if(tid.includes('narrative')) state.activeTab = 'narrative';
            else {
                // Extract collection name from ID (e.g., view-stakeholders-123)
                const parts = tid.split('-'); 
                // Careful parsing
                if(parts.length >= 2) state.activeTab = parts[1];
            }
            renderAiSidebarContent();
        });
    }

    // B. Central Click Delegation
    m.addEventListener('click', e => {
        const t = e.target;

        // 1. AI Triggers
        const specBtn = t.closest('.btn-speculate-collection');
        if(specBtn) triggerSpeculation(specBtn.dataset.collection, specBtn);
        
        const enhBtn = t.closest('.btn-enhance-field');
        if(enhBtn) triggerEnhancement(enhBtn.dataset.field, enhBtn);
        
        const aiBtn = t.closest('.btn-trigger-ai');
        if(aiBtn) triggerSpeculation(aiBtn.dataset.context, aiBtn);

        // 2. Editor Controls
        const addBtn = t.closest('.btn-add-item');
        if(addBtn) toggleEditor(addBtn.dataset.collection, true);
        
        const editBtn = t.closest('.btn-edit-item');
        if(editBtn) {
            const col = editBtn.dataset.collection;
            const item = state.collections[col].find(i => i.id === editBtn.dataset.id);
            if(item) toggleEditor(col, true, item);
        }

        const cancelBtn = t.closest('.btn-cancel-edit');
        if(cancelBtn) {
            const type = cancelBtn.closest('form').dataset.collection;
            toggleEditor(type, false);
        }

        // 3. Item Lifecycle Actions
        const accBtn = t.closest('.btn-accept');
        if(accBtn) {
            const col = accBtn.dataset.col;
            const item = state.collections[col].find(i => i.id === accBtn.dataset.id);
            if(item) { 
                item.tags = ""; // Remove AI tag
                item.status = "Active"; // Convert to Reality
                render(); 
                // Implicit save could happen here, or wait for manual save
            }
        }
        
        const delBtn = t.closest('.btn-delete-item');
        if(delBtn && confirm("Permanently remove this element?")) {
            const col = delBtn.dataset.col;
            state.collections[col] = state.collections[col].filter(i => i.id !== delBtn.dataset.id);
            render();
        }

        // 4. Save
        if(t.closest('.btn-save-changes')) saveDataPacket();
    });

    // C. Editor Form Submissions
    m.querySelectorAll('.editor-form').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const col = form.dataset.collection;
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());

            // Handle Checkboxes manually
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                data[cb.name] = cb.checked;
            });

            if(form.dataset.editingId) {
                // Update Existing
                const idx = state.collections[col].findIndex(i => i.id === form.dataset.editingId);
                if(idx > -1) state.collections[col][idx] = {...state.collections[col][idx], ...data};
            } else {
                // Create New (Manual)
                data.id = self.crypto.randomUUID();
                data.status = "Active";
                state.collections[col].push(data);
            }
            toggleEditor(col, false);
            render();
        });
    });
}

function toggleEditor(type, show, itemData=null) {
    const cont = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    const edit = state.modalElement.querySelector(`#editor-${type}-${state.ceId}`);
    const form = edit.querySelector('form');

    if(show) {
        cont.style.display = 'none';
        edit.style.display = 'block';
        form.reset();
        
        if(itemData) {
            form.dataset.editingId = itemData.id;
            // Hydrate Inputs
            Object.keys(itemData).forEach(k => {
                const input = form.querySelector(`[name="${k}"]`);
                if(input) {
                    if(input.type === 'checkbox') input.checked = itemData[k] === true;
                    else input.value = itemData[k];
                    
                    // Smart Slider Update
                    if(input.type === 'range' && input.nextElementSibling) {
                        input.nextElementSibling.innerText = input.value + '%';
                    }
                }
            });
        } else {
            delete form.dataset.editingId;
        }
    } else {
        cont.style.display = 'block';
        edit.style.display = 'none';
    }
}
