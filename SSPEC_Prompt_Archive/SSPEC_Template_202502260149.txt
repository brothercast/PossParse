â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC Build Metadata (v202502260149)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
As a senior developer, I've analyzed the changes for version `202502260149`. This release introduces significant UI/UX enhancements, focusing on dynamic interactions, modern aesthetics, and improved content presentation across the `goal_selection` and `outcome` pages.

Here's a summary of the technical changes:

### `styles.css`

*   **Expanded Color Palette**: Introduced new CSS variables for `bg-warm`, `surface-screen`, and a comprehensive set of `phase-0` to `phase-4` colors (Discovery, Engagement, Action, Legacy) to standardize thematic styling across different stages.
*   **Refined Typography System**: Established a more consistent and distinct typography, assigning specific font families (`Righteous`, `Manrope`, `Antonio`) to headings, brand elements, data displays, and body text, along with `letter-spacing` and `text-transform` rules.
*   **Enhanced Console Housing UI**:
    *   The main `console-housing` component now supports a `max-width: 1400px` for wider layouts and features a sophisticated double-border effect (`::after` pseudo-element).
    *   Introduced `brand-strip` as a decorative top bar for headers, enhancing the "console" aesthetic.
*   **Advanced 3D Card Flip Animation**:
    *   Implemented a complex, physics-based 3D flip animation for `.flip-card` elements using `perspective`, `transform-style: preserve-3d`, `backface-visibility`, and `rotate3d` transitions with a long `2.2s cubic-bezier` easing for a "Monolith" effect.
    *   Cards now have initial `opacity: 0` and use `slide-up-deal` keyframes for a staggered "dealing" animation.
    *   Added `card-pattern-overlay` for subtle texture on card backgrounds.
*   **New UI Components & States**:
    *   `status-block`: A dedicated, highly stylized component for displaying status indicators with bold, uppercase text, rounded corners, and shadows, designed for clarity and prominence.
    *   `module-header`: Stylized accordion headers with dynamic `border-left-color` based on phase, and `hover` effects.
    *   `phase-icon`: Circular icons within module headers, supporting `backdrop-filter: blur`.
    *   `rejected` state for `flip-card` now includes specific background, border, and button styling to visually indicate non-compliant goals.
*   **General UI Polish**: Numerous adjustments to padding, shadows, borders, and transitions across components like `input-bezel`, `btn-launch`, `image-portal`, `domain-badge`, `ce-pill`, and `retro-table` for a more cohesive and modern look.
*   **Loading & Utility Animations**: Added `loading-spinner-overlay` with `backdrop-filter` for a modern loading experience, and `fade-in` utility animation.

### `outcome.html`

*   **Responsive Header Layout**: The main outcome header (`screen-surface`) now uses a `d-flex flex-column flex-md-row` layout, enabling a responsive sidebar-content arrangement for better adaptability across screen sizes.
*   **Dynamic Image Loading**: Implemented client-side JavaScript to fetch a generated SSOL image (`/get_ssol_image/<ssolId>`) asynchronously, smoothly transitioning from a placeholder GIF to the actual image with a fade-in effect.
*   **Custom "Phases & Conditions" Table**:
    *   **Removed Tabulator Dependency**: The `tabulator-tables` CSS and JavaScript imports have been removed, indicating a full shift from a third-party table library to a custom HTML `retro-table` implementation.
    *   **Inline Editing for COS**: The table now supports client-side inline editing for Condition of Satisfaction (COS) `content`, `accountable_party`, and `completion_date` fields, toggled by dedicated edit/update/cancel buttons.
    *   Phase accordion headers (`module-header`) are dynamically styled with `background-color` and `border-left-color` using the new `--phase-{{ loop.index0 }}` CSS variables.
    *   COS items utilize the new `status-block` component for a visually distinct status display, dynamically colored based on their status.
    *   Added an "Add Protocol Unit" button to dynamically add new COS items to each phase.
*   **PDF Export Integration**: Introduced an "EXPORT PDF" button with `data-ssol-id`, signaling an integration point for server-side PDF generation.
*   **Error Handling**: Included a generic Bootstrap `errorModal` for displaying system errors to the user.

### `goal_selection.html`

*   **Interactive User Input Editing**: Added functionality to display the initial `user_input` and allow for inline editing directly on the page, complete with save and cancel actions.
*   **Goal Regeneration**: Introduced a "Speculate New" button (`generate-new-goals`) to trigger the generation of new goal sets.
*   **Dynamic Card Styling**: Goal cards now feature dynamic background gradients and icon colors for both the front and back faces, varying based on `is_compliant` status or `loop.index0` for visual diversity.
*   **Enhanced Card Interaction & Visuals**:
    *   The 3D flip animation is now fully implemented, revealing goal details.
    *   Non-compliant goals are clearly marked with a "Protocol Violation" badge and a disabled selection button, leveraging the new `.rejected` CSS class.
    *   **Staggered Animations**: Both the `flip-card` elements and their inner `flip-card-inner` components use `animation-delay` and `data-delay` attributes (respectively) to create a visually engaging staggered "deal" and "flip" effect upon page load.
*   **Updated Scripting**: A new `goal_selection.js` module is now responsible for handling the client-side logic for user input editing, goal regeneration, and the card flip animations.

In summary, this version represents a significant step forward in the application's user interface and interactivity, providing a more modern, dynamic, and engaging experience, particularly in how goals are presented and managed. The shift away from Tabulator for the outcome tables implies a move towards more tailored and potentially lightweight control over data display and interaction.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC PossPath Essential Files
Date: 2025-11-22
Version: 202502260149
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŒ Structured Speculation Possibility Pathfinder ("SSPEC PossPath")
Essential app files:
ğŸ¨ styles.css:
/* styles.css - SSPEC "Horizon Edition" (v2025.19 - MASTER SYSTEM) */

/* ================================================== */
/* ==============  1. FONTS & VARIABLES  ============ */
/* ================================================== */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Manrope:wght@400;500;700;800&family=Antonio:wght@700&display=swap');

:root {
  /* --- Horizon Palette --- */
  --bg-warm: #e3f2fd;
  --surface-white: #ffffff;
  --surface-screen: #f8fafc;
  
  /* Brand Colors */
  --aviation-teal: #00bcd4;
  --deep-space-blue: #2c3e50;
  --retro-coral: #ff7043;
  
  /* Functional Colors */
  --danger: #ef5350;
  --success: #66bb6a;
  --warning: #ffca28;
  --text-dark: #37474f;
  --text-muted: #90a4ae;

  /* Phase Colors (Used in Outcome & Goal Selection) */
  --phase-0: #ff7043; /* Discovery - Coral */
  --phase-1: #26c6da; /* Engagement - Cyan */
  --phase-2: #ab47bc; /* Action - Purple */
  --phase-3: #ffa726; /* Legacy - Amber */
  --phase-4: #66bd0e; /* Legacy - Green (Alt) */
}

body {
  font-family: 'Manrope', sans-serif;
  background-color: var(--bg-warm);
  background-image: radial-gradient(at 50% 0%, #ffffff 0%, #e1f5fe 100%);
  background-attachment: fixed;
  color: var(--text-dark);
  padding-bottom: 5rem;
}

/* Typography Overrides */
h1, h2, h3, .font-brand, .modal-title, .navbar-brand, .card-title { 
    font-family: 'Righteous', cursive; letter-spacing: 1px; 
}
h4, h5, h6, .font-data, .ce-title, .card-domain-badge, .btn-select-pill { 
    font-family: 'Antonio', sans-serif; letter-spacing: 0.5px; text-transform: uppercase; 
}
.font-body, .card-desc { font-family: 'Manrope', sans-serif; }

/* ================================================== */
/* ==============  2. THE CONSOLE HOUSING =========== */
/* ================================================== */
/* Wraps all pages (Input, Goal, Outcome) */

.horizon-wrapper {
  padding: 2rem 1rem;
  min-height: 100vh;
  display: flex;
  justify-content: center;
}

.console-housing {
  background-color: #ffffff;
  border-radius: 32px;
  box-shadow: 
    0 30px 60px -12px rgba(0,96,100,0.25),
    0 0 0 1px rgba(0,0,0,0.02);
  padding: 16px;
  border: 4px solid #ffffff;
  position: relative;
  overflow: visible;
  width: 100%;
  max-width: 1400px; /* Wide enough for 3 cards */
}

.console-housing::after {
  content: ''; position: absolute; inset: 0; border-radius: 32px;
  border: 2px solid rgba(0,188,212,0.3); pointer-events: none; z-index: 100;
}

.screen-surface {
  background: var(--surface-screen);
  border-radius: 20px;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
  border: 1px solid #e2e8f0;
  overflow: hidden;
  position: relative;
  min-height: 600px;
  display: flex;
  flex-direction: column;
}

/* Brand Strip (Used in Outcome Header) */
.brand-strip {
  background: linear-gradient(90deg, var(--aviation-teal) 0%, #26c6da 100%);
  height: 6px;
  width: 100%;
  position: absolute;
  top: 0; left: 0;
}

/* ================================================== */
/* ===========  3. INPUT STAGE (input.html) ========= */
/* ================================================== */

.input-stage {
  flex-grow: 1;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
  background-size: 30px 30px;
}

.input-bezel {
  background: white; padding: 3rem; border-radius: 24px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
  max-width: 700px; width: 100%; text-align: center;
}

.huge-input {
  border: none; border-bottom: 3px solid #e0e0e0;
  font-family: 'Manrope', sans-serif; font-size: 1.5rem; font-weight: 300;
  width: 100%; text-align: center; padding: 1rem; outline: none; background: transparent;
  transition: all 0.3s;
}
.huge-input:focus { border-bottom-color: var(--aviation-teal); }

.btn-launch {
  background: linear-gradient(135deg, #ff7043 0%, #f4511e 100%);
  color: white; font-family: 'Antonio', sans-serif; font-size: 1.2rem; letter-spacing: 2px;
  padding: 1rem 3rem; border-radius: 50px; border: none;
  box-shadow: 0 10px 20px rgba(244, 81, 30, 0.3); transition: transform 0.1s;
  display: inline-flex; align-items: center; gap: 10px;
}
.btn-launch:hover { transform: translateY(-2px); }


/* ================================================== */
/* ======  4. GOAL SELECTION (Monolith Flip) ======== */
/* ================================================== */

/* The Grid Container */
.goal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 3rem;
    padding: 3rem;
    perspective: 2500px; /* CRITICAL: This enables the 3D flip depth */
    align-items: start;
}

/* The Card Wrapper */
.flip-card {
  background-color: transparent;
  height: 480px;
  width: 100%;
  cursor: pointer;
  position: relative;
  opacity: 0; /* Starts hidden for "Deal" animation */
  animation: slide-up-deal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

@keyframes slide-up-deal {
  from { opacity: 0; transform: translateY(60px); }
  to { opacity: 1; transform: translateY(0); }
}

/* The Inner Flipper */
.flip-card-inner {
  position: relative; width: 100%; height: 100%; text-align: center;
  /* The 2.2s "Monolith" Physics */
  transition: transform 2.2s cubic-bezier(0.19, 1, 0.22, 1);
  transform-style: preserve-3d;
  transform-origin: center center;
  /* Start: Face Down (0deg on Diagonal 1,1,0) */
  transform: rotate3d(1, 1, 0, 0deg);
}

/* Trigger this class via JS to flip */
.flip-card.revealed .flip-card-inner {
  transform: rotate3d(1, 1, 0, 180deg);
}

/* Hover Lift Effect */
.flip-card.revealed:hover .flip-card-inner {
  transform: rotate3d(1, 1, 0, 180deg) translateY(-10px);
}

/* Faces (Shared) */
.flip-card-front, .flip-card-back {
  position: absolute; width: 100%; height: 100%;
  backface-visibility: hidden; border-radius: 24px;
  box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
  overflow: hidden; background: white;
  -webkit-font-smoothing: antialiased;
}

/* --- BACK (Face Down) --- */
.flip-card-back {
  z-index: 2; border: 4px solid white;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transform: rotate3d(0,0,0,0);
}

/* --- FRONT (Face Up) --- */
.flip-card-front {
  z-index: 1; 
  /* Pre-rotate 180 on diagonal so it matches the flip destination */
  transform: rotate3d(1, 1, 0, 180deg);
  display: flex; flex-direction: column; justify-content: space-between; padding: 0;
  border: 1px solid #e0e0e0;
}

/* Card Content Styling */
.card-header-plate {
  height: 120px; width: 100%; position: relative;
  display: flex; align-items: center; justify-content: center;
}

.card-icon-float {
  position: absolute; bottom: -32px; left: 50%; transform: translateX(-50%);
  width: 64px; height: 64px; background: white; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 4px solid white;
}

.card-domain-badge {
  position: absolute; top: 16px;
  background: rgba(255,255,255,0.25); backdrop-filter: blur(4px);
  padding: 4px 12px; border-radius: 20px; color: white;
  font-family: 'Antonio', sans-serif; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase;
  border: 1px solid rgba(255,255,255,0.4);
}

.card-body { padding: 48px 24px 20px 24px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.card-title { font-size: 1.5rem; color: #263238; margin-bottom: 0.75rem; line-height: 1.2; }
.card-desc { font-size: 0.9rem; color: #607d8b; line-height: 1.6; }
.card-footer { padding: 0 24px 32px 24px; }

.btn-select-pill {
  width: 100%; padding: 14px 0; border-radius: 50px; border: none;
  font-family: 'Antonio', sans-serif; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase;
  color: white; cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.btn-select-pill:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

/* Rejected State Overrides */
.flip-card.rejected .card-body { background: #fffaf9; }
.flip-card.rejected .flip-card-front { border-color: #ffcdd2; }
.flip-card.rejected .btn-select-pill { background: #d32f2f !important; cursor: not-allowed; opacity: 0.9; }

.card-pattern-overlay {
  position: absolute; inset: 0;
  background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
  background-size: 24px 24px; pointer-events: none;
}


/* ================================================== */
/* ==============  5. OUTCOME DASHBOARD  ============ */
/* ================================================== */

/* Header Sidebar */
.header-sidebar {
  background-color: #f8fafc; border-right: 1px solid #e2e8f0;
  padding: 2rem; display: flex; flex-direction: column; align-items: center; text-align: center;
}

.image-portal {
  width: 100%; aspect-ratio: 1/1; border-radius: 16px;
  background: white; border: 4px solid white;
  box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
  position: relative; overflow: hidden; margin-bottom: 1.5rem;
}
.image-portal img { width: 100%; height: 100%; object-fit: cover; }
.image-portal::after {
  content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
  background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent); pointer-events: none;
}

/* Domain Badge (Outcome Page Style) */
.domain-badge {
  display: inline-flex; align-items: center; gap: 8px;
  background: white; border: 1px solid #cbd5e1; border-radius: 50px;
  padding: 6px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* ================================================== */
/* ============  6. PHASE ACCORDIONS & TABLES ======= */
/* ================================================== */

.module-header {
  padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; transition: all 0.2s ease;
  border-left: 6px solid transparent; background-color: #fff;
  margin-bottom: 1px; border-radius: 4px;
}
.module-header:hover { filter: brightness(0.98); transform: translateY(-1px); }

/* Phase Icons */
.module-header .phase-icon {
  width: 32px; height: 32px; background: rgba(255,255,255,0.25);
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-family: 'Righteous', cursive; color: white; backdrop-filter: blur(2px);
}

.retro-table { width: 100%; border-collapse: collapse; }
.retro-table thead th {
  background-color: #f1f5f9; color: #64748b;
  font-family: 'Antonio', sans-serif; font-size: 0.8rem; text-transform: uppercase;
  letter-spacing: 1px; padding: 12px 16px; border-bottom: 2px solid #e2e8f0;
}
.retro-table td {
  padding: 16px; border-bottom: 1px dashed #e2e8f0;
  vertical-align: middle; font-size: 0.9rem; color: #334155;
}

/* ================================================== */
/* ============  7. CAPSULE PILLS (CEs)  ============ */
/* ================================================== */

.ce-pill, .ce-capsule {
  display: inline-flex; align-items: center;
  padding: 3px 10px 3px 4px; margin: 0 3px;
  border-radius: 50px; /* Capsule shape */
  font-family: 'Manrope', sans-serif; font-size: 0.75rem; font-weight: 700;
  letter-spacing: 0.02em; color: white;
  background-color: var(--node-color, #78909c);
  border: 1px solid rgba(255,255,255,0.4);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  cursor: pointer; transition: transform 0.1s;
}

.ce-pill:hover, .ce-capsule:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.ce-pill-icon, .ce-icon-box {
  display: inline-flex; align-items: center; justify-content: center;
  width: 18px; height: 18px; border-radius: 50%;
  margin-right: 6px; background: white; color: var(--node-color, #78909c);
}

.ce-pill-text { padding: 0; font-weight: inherit; color: inherit; }

/* Status Block (Replacement for standard pill) */
.status-block {
  font-family: 'Manrope', sans-serif;
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  padding: 6px 12px;
  border-radius: 8px;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 0 rgba(0,0,0,0.1);
  color: #fff;
  display: inline-block;
  text-align: center;
  min-width: 80px;
}

/* ================================================== */
/* ===========  8. MODAL (Speculation)  ============= */
/* ================================================== */

.ce-app-shell {
  height: 90vh; display: flex; flex-direction: column; overflow: hidden;
  background-color: #ffffff; border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  border: 4px solid white;
}

.ce-modal-header {
  background: linear-gradient(135deg, var(--phase-color), rgba(0,0,0,0.1));
  color: white; padding: 1rem 1.5rem; border: none;
}

.ce-nav-tabs .nav-link {
  border: none; background: transparent; color: #64748b;
  font-family: 'Antonio', sans-serif; letter-spacing: 1px; text-transform: uppercase;
  padding: 1rem 0; margin-right: 2rem; border-bottom: 3px solid transparent;
}
.ce-nav-tabs .nav-link.active {
  color: #0f172a; border-bottom-color: var(--phase-color);
}

/* Speculation Cards */
.card.proposed-item {
  border: 2px dashed var(--phase-color); background-color: #fdfdfd;
}
.badge-proposed {
  background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;
  font-family: 'Antonio', sans-serif; padding: 0.35em 0.6em;
}

/* AI Sidebar */
.ai-sidebar {
  width: 360px; background-color: #f8fafc; border-left: 1px solid #e2e8f0;
}

/* ================================================== */
/* ==============  9. UTILITIES  ==================== */
/* ================================================== */

.loading-spinner-overlay {
  background-color: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(8px);
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; justify-content: center; align-items: center; z-index: 9999;
}
.spinner-box {
  background: white; border-radius: 50%; width: 200px; height: 200px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 4px solid #fff;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  text-align: center; padding: 20px;
}

/* Animations */
.fade-in { animation: fadeIn 0.5s forwards; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

ğŸ³ï¸â€ğŸŒˆ ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It couples 'Smart Schemas' (for the UI) with 'Strategic Prompts' (for the AI).

PROMPT VARIABLES:
- {cos_text}: The text of the source Condition of Satisfaction.
- {field}: The specific field being enhanced (e.g., "Executive Summary", "Objective").
- {node_type}: The type of the node (e.g., "Research", "Risk").

NOTE: Double braces {{ }} are used to escape JSON structure examples in Python f-strings.
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Generalist)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Strategic Project Manager. Write a concise, professional '{field}' 
                for a '{node_type}' element needed to achieve this goal: '{cos_text}'.
                Focus on clarity, actionability, and value.
                Return JSON: {{ "text": "Your text here." }}
            """,
            "prerequisites": "Analyze '{cos_text}'. List 3 precursors needed. Return JSON array: [{{\"title\": \"Prereq\", \"status\": \"Pending\"}}]",
            "stakeholders": "Who is involved in '{cos_text}'? Return JSON array: [{{\"name\": \"Name/Role\", \"role\": \"Description\"}}]",
            "assumptions": "What are we assuming about '{cos_text}'? Return JSON array: [{{\"hypothesis\": \"Assumption...\", \"risk\": \"Medium\"}}]",
            "resources": "Suggest 3 general resources for '{cos_text}'. Return JSON array: [{{\"title\": \"Resource Name\", \"url\": \"#\"}}]"
        }
    },

    # ==============================================================================
    # 2. RESEARCH (The Scientist)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink
        "details_schema": [
            {"key": "research_question", "label": "Primary Research Question", "type": "textarea", "rows": 2},
            {"key": "summary", "label": "Executive Synthesis", "type": "textarea", "rows": 6}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Paper/Source Title", "type": "text"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset"]},
            {"key": "url", "label": "Source URL", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Lead Researcher. Write a precise '{field}' to address knowledge gaps regarding: '{cos_text}'.
                Ensure the language is objective, evidence-based, and methodologically sound.
                Return JSON: {{ "text": "Your research text here." }}
            """,
            "prerequisites": """
                To answer the research question implied by: '{cos_text}', what data or baseline access is needed first?
                Return JSON array: [{{\"data_req\": \"Specific Dataset\", \"access_status\": \"Unknown\"}}]
            """,
            "stakeholders": """
                Suggest 3 types of Subject Matter Experts (SMEs) needed for: '{cos_text}'.
                Return JSON array: [{{\"name\": \"Role Title\", \"expertise\": \"Academic Field\"}}]
            """,
            "assumptions": """
                What theoretical assumptions are we making in '{cos_text}' that require validation?
                Return JSON array: [{{\"premise\": \"Theory...\", \"validation_method\": \"Lit Review\"}}]
            """,
            "resources": """
                Find 3 relevant academic papers, datasets, or whitepapers for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Paper Title\", \"type\": \"Paper\", \"url\": \"https://scholar.google.com/\"}}]
            """
        }
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text"},
            {"key": "confidence", "label": "Confidence (0-100)", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "tool_name", "label": "Mitigation Tool", "type": "text"},
            {"key": "cost", "label": "Est. Cost", "type": "currency"}
        ],
        "prompts": {
            "narrative": """
                Act as a Chief Risk Officer. Write a '{field}' analysis for the threat context of: '{cos_text}'.
                Focus on severity, probability, and concrete mitigation steps. Avoid vague reassurances.
                Return JSON: {{ "text": "Your risk analysis here." }}
            """,
            "prerequisites": """
                For the risk scenario in '{cos_text}', what monitoring or indicators must be established first?
                Return JSON array: [{{\"indicator\": \"Metric to watch\", \"threshold\": \"Value\"}}]
            """,
            "stakeholders": """
                Who owns the risk associated with '{cos_text}' and who suffers if it fails?
                Return JSON array: [{{\"owner\": \"Role\", \"impacted_group\": \"Population\"}}]
            """,
            "assumptions": """
                What 'safety assumptions' are we making about '{cos_text}' that could be false?
                Return JSON array: [{{\"mitigation_theory\": \"We assume...\", \"confidence\": 50}}]
            """,
            "resources": """
                Suggest 3 standard frameworks or tools to mitigate risks in: '{cos_text}'.
                Return JSON array: [{{\"tool_name\": \"Framework Name\", \"cost\": \"0\"}}]
            """
        }
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Diplomat)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text"},
            {"key": "material_needs", "label": "Materials Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Document", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Community Organizer or Diplomat. Write a '{field}' that defines how to engage partners for: '{cos_text}'.
                Focus on shared value, incentives, and relationship building.
                Return JSON: {{ "text": "Your engagement strategy here." }}
            """,
            "prerequisites": """
                To engage stakeholders for '{cos_text}', what introductions or materials are prerequisites?
                Return JSON array: [{{\"intro_path\": \"Via Industry Group\", \"material_needs\": \"Pitch Deck\"}}]
            """,
            "stakeholders": """
                Who are the key decision makers or influencers for: '{cos_text}'?
                Return JSON array: [{{\"name\": \"Role/Title\", \"influence\": 80, \"stance\": \"Neutral\"}}]
            """,
            "assumptions": """
                Why do we think these stakeholders will align with '{cos_text}'?
                Return JSON array: [{{\"incentive_theory\": \"They benefit by...\", \"validated\": false}}]
            """,
            "resources": """
                What agreements or contracts are standard for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Contract\", \"status\": \"Draft\"}}]
            """
        }
    },

    # ==============================================================================
    # 5. PRAXIS (The Operator)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Est", "type": "text"},
            {"key": "resource_avail", "label": "Resources Available?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "instructions", "label": "SOP/Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Operations Director. Write a '{field}' plan to execute: '{cos_text}'.
                Focus on logistics, friction points, and clear definitions of 'done'.
                Return JSON: {{ "text": "Your operational plan here." }}
            """,
            "prerequisites": """
                What must literally be completed before the task '{cos_text}' can physically start?
                Return JSON array: [{{\"dependency\": \"Task X Complete\", \"status\": \"Blocked\"}}]
            """,
            "stakeholders": """
                Who executes and who approves the action: '{cos_text}'?
                Return JSON array: [{{\"executor\": \"Role\", \"approver\": \"Manager/Client\"}}]
            """,
            "assumptions": """
                What are the logistical assumptions regarding time and availability for '{cos_text}'?
                Return JSON array: [{{\"time_est\": \"2 Weeks\", \"resource_avail\": true}}]
            """,
            "resources": """
                What software, hardware, or SOPs are needed to perform: '{cos_text}'?
                Return JSON array: [{{\"tool\": \"Tool Name\", \"instructions\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Ecologist)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulation", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Community", "type": "text"},
            {"key": "regulator", "label": "Regulator", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Environmental Scientist or Systems Analyst. Write a '{field}' assessment regarding: '{cos_text}'.
                Focus on systemic impacts, circularity, and regulatory landscapes.
                Return JSON: {{ "text": "Your impact assessment here." }}
            """,
            "prerequisites": """
                What regulatory permits or environmental baselines are required for: '{cos_text}'?
                Return JSON array: [{{\"permit\": \"Permit Type\", \"baseline_data\": \"Survey Needed\"}}]
            """,
            "stakeholders": """
                Which communities or regulatory bodies act as gatekeepers for: '{cos_text}'?
                Return JSON array: [{{\"community\": \"Local Group\", \"regulator\": \"Agency\"}}]
            """,
            "assumptions": """
                What trends (market or climate) are we assuming will hold stable for '{cos_text}'?
                Return JSON array: [{{\"trend\": \"Trend Description\", \"stability\": 60}}]
            """,
            "resources": """
                Find Environmental Impact Statements or Market Studies relevant to: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Report Title\", \"url\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 7. TIMELINE (The Scheduler)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "slack_analysis", "label": "Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors", "type": "text"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "date", "label": "Target Date", "type": "date"}
        ],
        "prompts": {
            "narrative": """
                Act as a Project Scheduler. Write a '{field}' description for the milestone: '{cos_text}'.
                Focus on critical path dependencies, slack times, and sequencing.
                Return JSON: {{ "text": "Your timeline analysis here." }}
            """,
            "prerequisites": """
                What events must happen *before* the milestone '{cos_text}' can occur?
                Return JSON array: [{{\"event\": \"Precursor Event\", \"lead_time\": \"2 Weeks\"}}]
            """,
            "stakeholders": """
                Who is responsible for keeping the schedule for: '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Project Manager / Role\"}}]
            """,
            "assumptions": """
                What assumptions about speed or external delays affect '{cos_text}'?
                Return JSON array: [{{\"velocity\": \"Standard Pace\", \"external_factors\": \"Weather/Shipping\"}}]
            """,
            "resources": """
                Suggest key calendar events or deadlines associated with: '{cos_text}'.
                Return JSON array: [{{\"event\": \"Milestone Name\", \"date\": \"2025-01-01\"}}]
            """
        }
    },

    # ==============================================================================
    # 8. ADVOCACY (The Campaigner)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action", "type": "text"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset", "type": "text"},
            {"key": "platform", "label": "Platform Ready?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience", "type": "text"},
            {"key": "influencer", "label": "Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Post", "Video", "Article"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Campaign Strategist. Write a compelling '{field}' to support the goal: '{cos_text}'.
                Focus on emotion, resonance, and a clear call to action.
                Return JSON: {{ "text": "Your campaign narrative here." }}
            """,
            "prerequisites": """
                What creative assets or platform accounts must be ready before advocating for '{cos_text}'?
                Return JSON array: [{{\"asset\": \"Video/Graphics\", \"platform\": false}}]
            """,
            "stakeholders": """
                Who is the target audience for '{cos_text}' and who influences them?
                Return JSON array: [{{\"audience\": \"Demographic\", \"influencer\": \"Personality/Org\"}}]
            """,
            "assumptions": """
                What are we assuming the public feels about '{cos_text}'?
                Return JSON array: [{{\"sentiment\": \"Positive/Skeptical\", \"resonance\": 70}}]
            """,
            "resources": """
                Suggest 3 types of content content media for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Viral Video Concept\", \"type\": \"Video\"}}]
            """
        }
    },

    # ==============================================================================
    # 9. COLLABORATION (The Connector)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual"]}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Partnership Lead. Write a '{field}' regarding the alliance for: '{cos_text}'.
                Focus on shared values, resource exchange, and long-term synergy.
                Return JSON: {{ "text": "Your partnership strategy here." }}
            """,
            "prerequisites": """
                What introductions or legal safeguards (NDAs) are needed before collaborating on '{cos_text}'?
                Return JSON array: [{{\"intro\": true, \"nda\": true}}]
            """,
            "stakeholders": """
                Identify potential partner organizations for: '{cos_text}'.
                Return JSON array: [{{\"partner_org\": \"Org Name\", \"poc\": \"Title/Role\"}}]
            """,
            "assumptions": """
                Why do we assume these partners want to work on '{cos_text}'?
                Return JSON array: [{{\"alignment\": \"Strategic Fit...\", \"resource_sharing\": 80}}]
            """,
            "resources": """
                What governance documents are required for this collaboration: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Teaming Agreement\", \"status\": \"Drafting\"}}]
            """
        }
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

ğŸ”µ ce_cards.js:
// ce_cards.js (The Speculation Environment Controller - Phase 4 Final)

// --- STATE MANAGEMENT ---
let state = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    // Unified storage for all list-based data
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    // Storage for text-based form data (Narrative)
    details_data: {},
    isSaving: false,
    sidebarContext: 'Overview'
};

// --- INITIALIZATION ---

/**
 * Main entry point called by the parent page to launch the modal.
 * @param {string} modalHtml - The raw HTML string of the modal shell.
 * @param {string} ceId - The UUID of the Conditional Element.
 * @param {string} p_ceType - The Node Type (e.g., 'Risk', 'Research').
 * @param {object} ceData - The existing data payload from the database.
 */
export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    modalContainer.innerHTML = modalHtml;
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    
    // Bootstrap Modal Instance
    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        // Hydrate State from DB or set defaults
        const d = ceData?.data || {};
        state = {
            modalElement, 
            ceId, 
            ceType: p_ceType, 
            activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
            isSaving: false,
            sidebarContext: 'Overview'
        };
        
        render(); 
        setupEventListeners();
        
        // --- THE "ONE-HIT" TRIGGER ---
        checkAndTriggerAutoPopulation();

    }, { once: true });

    // Cleanup on close
    modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.remove();
    });

    modal.show();
}

// --- AUTOMATION LOGIC ---

function checkAndTriggerAutoPopulation() {
    // Heuristic: If all collections are empty, this is a "Fresh Node".
    const isFresh = ['prerequisites', 'stakeholders', 'assumptions'].every(key => 
        state.collections[key].length === 0
    );

    if (isFresh) {
        console.log("Fresh Node Detected. Initiating System Scan...");
        
        // Visual Feedback in the Status Card
        const statusValue = state.modalElement.querySelector('.status-card-value');
        if (statusValue) {
            statusValue.innerHTML = '<span class="text-primary"><i class="fas fa-circle-notch fa-spin"></i> INITIATING...</span>';
        }

        // 1. Draft the Narrative Summary first
        triggerEnhancement('summary', null, true);

        // 2. Sequential Generation of Strategic Layers (Staggered for effect)
        // We don't generate Resources automatically yet, just the logic layers.
        setTimeout(() => triggerSpeculation('prerequisites'), 1000);
        setTimeout(() => triggerSpeculation('stakeholders'), 2500);
        setTimeout(() => triggerSpeculation('assumptions'), 4000);
    }
}

// --- RENDER PIPELINE ---

function render() {
    if (!state.modalElement) return;
    
    renderAllCollections();
    updateDashboard(); // Calculates progress and updates metrics
    renderAiSidebar();
}

function renderAllCollections() {
    // Loop through each collection type and render its specific list
    ['prerequisites', 'stakeholders', 'assumptions', 'resources', 'connections'].forEach(type => {
        renderCollectionList(type);
    });
}

/**
 * Renders cards for a specific collection. Handles "Ghost States" and "Proposed Items".
 */
function renderCollectionList(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];
    
    // 1. GHOST STATE (Empty Tab)
    if (items.length === 0) {
        let emptyMsg = "No items defined.";
        let btnText = "Auto-Generate";
        let icon = "fa-wind";

        if (type === 'prerequisites') { emptyMsg = "Define dependencies to clear the path."; btnText = "Speculate Prerequisites"; icon = "fa-tasks"; }
        if (type === 'stakeholders') { emptyMsg = "Map the human network."; btnText = "Query SSPEC Network"; icon = "fa-users"; }
        if (type === 'assumptions') { emptyMsg = "Identify risks and theories."; btnText = "Analyze Risks"; icon = "fa-shield-alt"; }
        if (type === 'resources') { emptyMsg = "Gather evidence and assets."; btnText = "Find Resources"; icon = "fa-database"; }

        container.innerHTML = `
            <div class="ghost-state">
                <div class="ghost-icon-container"><i class="fas ${icon} fa-2x"></i></div>
                <h5 class="text-uppercase mb-2" style="font-family:'Unica One'">System Standing By</h5>
                <p class="text-muted small mb-4">${emptyMsg}</p>
                <button class="btn btn-primary px-4 btn-speculate-collection shadow-sm" data-collection="${type}">
                    <i class="fas fa-magic me-2"></i> ${btnText}
                </button>
            </div>`;
        return;
    }

    // 2. CARD LIST
    container.innerHTML = items.map(item => {
        // Smart Title detection based on schema variations
        const mainText = item.title || item.name || item.hypothesis || item.risk_vector || item.event || 'Untitled';
        const subText = item.role || item.risk || item.status || item.impact || item.url || '';
        
        // "Proposed" (AI) vs "Active" (User) detection
        const isProposed = item.tags && (item.tags.includes("AI") || item.tags.includes("Proposed"));
        
        // Styling logic
        const cardClass = isProposed 
            ? 'card mb-2 proposed-item' 
            : 'card mb-2 border shadow-sm collection-card';
        
        const badge = isProposed 
            ? `<span class="badge badge-proposed border ms-2">AI PROPOSED</span>` 
            : '';

        // Button Logic
        let actionsHtml = '';
        if (isProposed) {
            actionsHtml = `
                <button class="btn btn-sm btn-outline-success btn-accept-item me-1" title="Accept" data-collection="${type}" data-id="${item.id}"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-light text-danger btn-delete-item" title="Reject" data-collection="${type}" data-id="${item.id}"><i class="fas fa-times"></i></button>
            `;
        } else {
            actionsHtml = `
                <button class="btn btn-sm btn-light text-muted btn-edit-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>
                <button class="btn btn-sm btn-light text-danger btn-delete-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-trash"></i></button>
            `;
        }

        return `
        <div class="${cardClass}">
            <div class="card-body p-3 d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                    <div class="d-flex align-items-center mb-1">
                        <h6 class="fw-bold mb-0 text-dark">${mainText}</h6>
                        ${badge}
                    </div>
                    <div class="small text-muted text-truncate" style="max-width: 450px;">${subText}</div>
                </div>
                <div class="btn-group">
                    ${actionsHtml}
                </div>
            </div>
        </div>`;
    }).join('');
}

// --- DASHBOARD NERVOUS SYSTEM ---

function updateDashboard() {
    // 1. Update Tab Badges (e.g., "Prerequisites (3)")
    ['prerequisites', 'stakeholders', 'assumptions', 'resources', 'connections'].forEach(key => {
        const count = (state.collections[key] || []).length;
        const badge = state.modalElement.querySelector(`.count-badge[data-collection="${key}"]`);
        if (badge) {
            badge.textContent = count;
            if(count > 0) {
                badge.classList.remove('bg-light', 'text-dark');
                badge.classList.add('bg-primary', 'text-white');
            }
        }
    });

    // 2. Calculate "Readiness" (Analog Progress)
    // This logic mimics "checking off" items for the project phase.
    let points = 0;
    let maxPoints = 60; // Hypothetical goal
    
    // Points for items existing
    Object.values(state.collections).flat().forEach(item => {
        points += 5;
        // Bonus points for verified status
        if (item.status === 'Verified' || item.status === 'Met' || item.status === 'Signed') {
            points += 5; 
        }
    });

    // Points for Narrative fields
    if (state.details_data.summary && state.details_data.summary.length > 10) points += 10;
    
    const percentage = Math.min(100, Math.floor((points / maxPoints) * 100));

    // Update UI Bars
    const bar = state.modalElement.querySelector('#ce-progress-bar');
    const label = state.modalElement.querySelector('#ce-progress-label');
    if (bar) bar.style.width = `${percentage}%`;
    if (label) label.textContent = `${percentage}%`;

    // 3. Update Main Status Text based on Readiness
    const statusText = state.modalElement.querySelector('.status-card-value');
    
    // Don't overwrite the "INITIATING" spinner if it's active
    if (statusText && !statusText.innerHTML.includes('fa-spin')) { 
        if (percentage === 0) statusText.textContent = "INITIALIZED";
        else if (percentage < 30) statusText.textContent = "CALIBRATING";
        else if (percentage < 80) statusText.textContent = "ACTIVE";
        else statusText.innerHTML = "<span class='text-success'>OPTIMIZED</span>";
    }
}

function renderAiSidebar() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if (!content) return;

    let actionsHtml = '';
    const ctx = state.activeTab; // e.g., 'prerequisites'

    // Context-Aware Sidebar Actions
    if (ctx === 'overview') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-search-dollar me-2 text-success"></i> Analyze Cost Impact</button>
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-exclamation-triangle me-2 text-warning"></i> Identify Critical Risks</button>
        `;
    } else if (ctx === 'stakeholders') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-user-plus me-2 text-primary"></i> Suggest Key Players</button>
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-handshake me-2 text-info"></i> Draft Outreach Email</button>
        `;
    } else if (ctx === 'narrative' || ctx === 'details') {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-magic me-2 text-purple"></i> Polish Narrative Tone</button>
        `;
    } else {
        actionsHtml = `
            <button class="btn btn-sm btn-light w-100 text-start mb-2 border shadow-sm"><i class="fas fa-lightbulb me-2 text-warning"></i> Generate Ideas</button>
        `;
    }

    content.innerHTML = `
        <div class="mb-4">
            <h6 class="small fw-bold text-muted text-uppercase mb-3">Active Context: ${ctx.toUpperCase()}</h6>
            ${actionsHtml}
        </div>
        <div class="mt-auto border-top pt-3">
            <label class="small fw-bold text-muted mb-1">Ask SPECULATE</label>
            <div class="input-group">
                <input type="text" class="form-control form-control-sm" placeholder="Query this node...">
                <button class="btn btn-primary btn-sm"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    `;
}

// --- SPECULATE ENGINE ACTIONS ---

/**
 * Triggers generation for a collection list (e.g., generating 3 prerequisites).
 */
function triggerSpeculation(collectionType, buttonElement = null) {
    let originalHtml = '';
    if(buttonElement) {
        originalHtml = buttonElement.innerHTML;
        buttonElement.disabled = true;
        buttonElement.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Thinking...`;
    }

    // Scrape context (Source COS) from the DOM
    const cosText = state.modalElement.querySelector('.source-cos-card p')?.textContent.trim() || "Goal";

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            ce_type: state.ceType,
            context: collectionType, // 'prerequisites', etc.
            cos_text: cosText,
            current_items: state.collections[collectionType]
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success && data.suggestions) {
            data.suggestions.forEach(item => {
                item.id = self.crypto.randomUUID();
                item.tags = "AI"; // Mark as Proposed
                item.status = "Pending Review";
                state.collections[collectionType].push(item);
            });
            render(); // Re-render to show new items
        } else {
            console.error("Speculation failed:", data.error);
        }
    })
    .catch(err => console.error("Network error:", err))
    .finally(() => {
        if(buttonElement) {
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalHtml;
        }
        // If we triggered the "SCANNING" state, clear it now
        const statusText = state.modalElement.querySelector('.status-card-value');
        if (statusText && statusText.textContent.includes('INITIATING')) {
            updateDashboard(); // Re-run logic to set correct text
        }
    });
}

/**
 * Triggers text enhancement for specific fields (e.g., rewriting the summary).
 */
function triggerEnhancement(fieldKey, buttonElement = null, isAuto = false) {
    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    const cosText = state.modalElement.querySelector('.source-cos-card p')?.textContent.trim() || "Goal";

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            ce_type: state.ceType,
            context: 'narrative', // Special context routed in Python
            sub_context: fieldKey, // e.g., 'summary'
            cos_text: cosText
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.text) {
            state.details_data[fieldKey] = data.text;
            // Update the textarea immediately if visible
            const input = state.modalElement.querySelector(`[name="${fieldKey}"]`);
            if (input) input.value = data.text;
            updateDashboard();
        }
    })
    .finally(() => {
        if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-magic"></i>';
        }
    });
}

// --- EVENT HANDLING & EDITORS ---

function setupEventListeners() {
    const modal = state.modalElement;

    // 1. Context Switching (Tabs)
    const navTabs = modal.querySelector('.ce-nav-tabs');
    if(navTabs) {
        navTabs.addEventListener('shown.bs.tab', event => {
            const targetId = event.target.getAttribute('data-bs-target'); // #view-prerequisites-ID
            // Extract middle part (e.g. 'prerequisites')
            // Handle potential ID format variations safely
            if (targetId.includes('overview')) state.activeTab = 'overview';
            else if (targetId.includes('details')) state.activeTab = 'narrative'; // Mapped to 'Narrative'
            else {
                const parts = targetId.split('-');
                if(parts.length >= 2) state.activeTab = parts[1]; 
            }
            renderAiSidebar();
        });
    }

    // 2. Unified Click Delegation
    modal.addEventListener('click', event => {
        const t = event.target;

        // --- BUTTONS: Speculate / Enhance ---
        const specBtn = t.closest('.btn-speculate-collection');
        if (specBtn) triggerSpeculation(specBtn.dataset.collection, specBtn);

        const enhanceBtn = t.closest('.btn-enhance-field');
        if (enhanceBtn) triggerEnhancement(enhanceBtn.dataset.field, enhanceBtn);

        // --- BUTTONS: Add / Edit / Cancel ---
        const addBtn = t.closest('.btn-add-item');
        if (addBtn) toggleEditor(addBtn.dataset.collection, true);

        const cancelBtn = t.closest('.btn-cancel-edit');
        if (cancelBtn) {
            // Find which editor we are in
            const form = cancelBtn.closest('form');
            toggleEditor(form.dataset.collection, false);
        }

        const editBtn = t.closest('.btn-edit-item');
        if (editBtn) {
            const type = editBtn.dataset.collection;
            const id = editBtn.dataset.id;
            const item = state.collections[type].find(i => i.id === id);
            if(item) toggleEditor(type, true, item);
        }

        // --- BUTTONS: Item Actions (Accept / Delete) ---
        const acceptBtn = t.closest('.btn-accept-item');
        if (acceptBtn) {
            const type = acceptBtn.dataset.collection;
            const item = state.collections[type].find(i => i.id === acceptBtn.dataset.id);
            if (item) {
                item.tags = ""; // Remove AI tag
                item.status = "Active"; // Promote to Active
                render(); // Re-render to change style from dashed to solid
            }
        }

        const deleteBtn = t.closest('.btn-delete-item');
        if (deleteBtn) {
            if(confirm("Remove this item?")) {
                const type = deleteBtn.dataset.collection;
                state.collections[type] = state.collections[type].filter(i => i.id !== deleteBtn.dataset.id);
                render();
            }
        }

        // --- BUTTONS: Main Save ---
        if (t.closest('.btn-save-changes')) saveDataPacket();
    });

    // 3. Form Submission (Generic Editor)
    modal.addEventListener('submit', event => {
        if (event.target.classList.contains('editor-form')) {
            event.preventDefault();
            const form = event.target;
            const type = form.dataset.collection;
            const fd = new FormData(form);
            const newData = Object.fromEntries(fd.entries());

            if (form.dataset.editingId) {
                // Update Existing
                const idx = state.collections[type].findIndex(i => i.id === form.dataset.editingId);
                if (idx > -1) state.collections[type][idx] = { ...state.collections[type][idx], ...newData };
            } else {
                // Create New
                newData.id = self.crypto.randomUUID();
                state.collections[type].push(newData);
            }
            
            toggleEditor(type, false);
            render();
        }
    });

    // 4. Narrative Inputs (Auto-save to state on typing)
    const detailForm = modal.querySelector(`#narrative-form-${state.ceId}`);
    if (detailForm) {
        detailForm.addEventListener('input', (e) => {
            state.details_data[e.target.name] = e.target.value;
            // No full render() here to avoid losing focus, just quiet state update
            updateDashboard(); // Update progress bar silently
        });
    }
}

function toggleEditor(type, show, itemData = null) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    const editor = state.modalElement.querySelector(`#editor-${type}-${state.ceId}`);
    const form = editor.querySelector('form');

    if (show) {
        container.style.display = 'none';
        editor.style.display = 'block';
        form.reset();
        if (itemData) {
            form.dataset.editingId = itemData.id;
            // Populate fields
            Object.keys(itemData).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if(input) {
                    if(input.type === 'checkbox') input.checked = true; 
                    else input.value = itemData[key];
                }
            });
        } else {
            delete form.dataset.editingId;
        }
    } else {
        container.style.display = 'block';
        editor.style.display = 'none';
    }
}

function saveDataPacket() {
    if (state.isSaving) return;
    state.isSaving = true;
    const btn = state.modalElement.querySelector('.btn-save-changes');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';

    // Construct Packet
    const packet = {
        details_data: state.details_data,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        resources: state.collections.resources,
        connections: state.collections.connections
    };

    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            const status = state.modalElement.querySelector('#save-status');
            if(status) status.innerHTML = `<i class="fas fa-check-circle text-success"></i> Saved at ${new Date().toLocaleTimeString()}`;
            
            btn.classList.replace('btn-primary', 'btn-success');
            btn.innerHTML = '<i class="fas fa-check"></i> Saved';
            setTimeout(() => {
                btn.classList.replace('btn-success', 'btn-primary');
                btn.innerHTML = originalHtml;
            }, 2000);
        }
    })
    .catch(err => {
        console.error("Save failed", err);
        alert("Failed to save data packet.");
    })
    .finally(() => {
        state.isSaving = false;
    });
}

ğŸŸ§ ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

ğŸŸª cos_table.js:
// cos_table.js (Refactored for Simplicity and Reliability)
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions (Unchanged) ---
function getBadgeClassFromStatus(status) {
    switch (status) {
        case 'Proposed': return 'bg-info';
        case 'In Progress': return 'bg-warning text-dark';
        case 'Completed': return 'bg-success';
        case 'Rejected': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State (Largely Unchanged) ---
function storeOriginalValues(cosRow) {
    const statusPill = cosRow.querySelector('.status-cell .status-pill');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountablePartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    const completionDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    cosRow.dataset.originalValues = JSON.stringify({
        status: statusPill ? statusPill.textContent.trim().toUpperCase() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountableParty: accountablePartyDisplay ? accountablePartyDisplay.textContent.trim() : '',
        completionDate: completionDateDisplay ? completionDateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        statusCell.innerHTML = `<span class="status-pill ${getBadgeClassFromStatus(original.status)}">${original.status}</span>`;
    }
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;
    const accPartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    if (accPartyDisplay) accPartyDisplay.textContent = original.accountableParty;
    const compDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    if (compDateDisplay) compDateDisplay.textContent = original.completionDate;
    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        statusCell.innerHTML = `<span class="status-pill ${getBadgeClassFromStatus(cosData.status)}">${cosData.status.toUpperCase()}</span>`;
    }
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;
    const accountablePartyDisplay = cosRow.querySelector('.cos-accountable-party-cell .cos-accountable-party-display');
    if (accountablePartyDisplay) accountablePartyDisplay.textContent = cosData.accountable_party || 'N/A';
    const completionDateDisplay = cosRow.querySelector('.cos-completion-date-cell .cos-completion-date-display');
    if (completionDateDisplay) completionDateDisplay.textContent = cosData.completion_date || 'N/A';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();
    const elementsToToggle = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];
    elementsToToggle.forEach(pair => {
        cosRow.querySelector(pair.display)?.classList.toggle('d-none', editing);
        cosRow.querySelector(pair.edit)?.classList.toggle('d-none', !editing);
    });

    const statusCell = cosRow.querySelector('.status-cell');
    const statusPill = statusCell.querySelector('.status-pill');
    const statusDropdown = statusCell.querySelector('select.status-edit-select');
    if (editing) {
        if (statusPill && !statusDropdown) {
            const currentStatus = statusPill.textContent.trim();
            statusPill.classList.add('d-none');
            statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentStatus));
        }
    } else {
        statusDropdown?.remove();
        statusPill?.classList.remove('d-none');
    }

    cosRow.querySelector('.edit-cos-button')?.classList.toggle('d-none', editing);
    cosRow.querySelector('.update-cos-button')?.classList.toggle('d-none', !editing);
    cosRow.querySelector('.cancel-cos-button')?.classList.toggle('d-none', !editing);
    cosRow.querySelector('.delete-cos-button')?.classList.toggle('d-none', editing);
    cosRow.querySelector('.analyze-cos-button')?.classList.toggle('d-none', editing);
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'In Progress', 'Completed', 'Rejected'];
    const optionsHtml = statuses.map(status =>
        `<option value="${status}"${status.toUpperCase() === selectedStatus.toUpperCase() ? ' selected' : ''}>${status}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select">${optionsHtml}</select>`;
}


// --- Event Handlers ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;
    
    const pill = target.closest('.ce-pill');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    const button = target.closest('button');
    if (button) {
        const cosRow = button.closest('.cos-row');
        if (!cosRow) return;
        
        event.preventDefault();
        const cosId = cosRow.dataset.cosId;

        if (button.classList.contains('edit-cos-button')) {
            handleEditCOS(cosRow);
        } else if (button.classList.contains('update-cos-button')) {
            handleUpdateCOS(cosRow, cosId);
        } else if (button.classList.contains('cancel-cos-button')) {
            revertToOriginalValues(cosRow);
        } else if (button.classList.contains('delete-cos-button')) {
            handleDeleteCOS(cosRow, cosId);
        } else if (button.classList.contains('analyze-cos-button')) {
            handleAnalyzeCOS(button, cosRow, cosId);
        }
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);
    
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const contentTextarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && contentTextarea) {
        contentTextarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }
    
    const accPartyDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const accPartyEditInput = cosRow.querySelector('.cos-accountable-party-edit');
    if (accPartyDisplay && accPartyEditInput) {
        accPartyEditInput.value = accPartyDisplay.textContent.trim() === 'N/A' ? '' : accPartyDisplay.textContent.trim();
    }
    
    const compDateDisplay = cosRow.querySelector('.cos-completion-date-display');
    const compDateEditInput = cosRow.querySelector('.cos-completion-date-edit');
    if (compDateDisplay && compDateEditInput) {
        compDateEditInput.value = compDateDisplay.textContent.trim() === 'N/A' ? '' : compDateDisplay.textContent.trim();
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountableParty = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim() || '';
    const newCompletionDate = cosRow.querySelector('.cos-completion-date-edit')?.value || '';
    const payload = { content: newContent, status: newStatus, accountable_party: newAccountableParty, completion_date: newCompletionDate };

    const updateButton = cosRow.querySelector('.update-cos-button');
    const originalButtonHtml = updateButton.innerHTML;
    updateButton.disabled = true;
    updateButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error(data.error || 'Update failed to return COS data.');
        }
    })
    .catch(error => {
        console.error('Error updating COS:', error);
        alert(`Error: ${error.message}`);
    })
    .finally(() => {
        updateButton.disabled = false;
        updateButton.innerHTML = originalButtonHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (confirm('Are you sure you want to delete this Condition of Satisfaction?')) {
        fetch(`/delete_cos/${cosId}`, {
            method: 'DELETE',
            headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(handleApiResponse)
        .then(data => {
            if (data.success) {
                cosRow.remove();
            } else {
                throw new Error(data.error || 'Deletion failed.');
            }
        })
        .catch(error => {
            console.error('Error deleting COS:', error);
            alert(`Error: ${error.message}`);
        });
    }
}

function handleAnalyzeCOS(analyzeButton, cosRow, cosId) {
    const originalButtonHtml = analyzeButton.innerHTML;
    analyzeButton.disabled = true;
    analyzeButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    fetch(`/analyze_cos/${cosId}`, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.analysis_results?.content_with_ce) {
            const contentDisplay = cosRow.querySelector('.cos-content-display');
            if (contentDisplay) {
                contentDisplay.innerHTML = data.analysis_results.content_with_ce;
            }
        } else {
            throw new Error(data.message || 'Analysis failed to return expected results.');
        }
    })
    .catch(error => {
        console.error('Error analyzing COS:', error);
        alert(`Analysis Failed: ${error.message}`);
    })
    .finally(() => {
        analyzeButton.disabled = false;
        analyzeButton.innerHTML = originalButtonHtml;
    });
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    const accordionBody = button.closest('.accordion-body');
    const ssolId = accordionBody?.dataset.ssolId;
    if (!ssolId) {
        alert('Cannot add COS: Critical data missing.');
        return;
    }

    const payload = { content: 'New Condition of Satisfaction - edit me!', status: 'Proposed', ssol_id: ssolId };
    button.disabled = true;
    const originalButtonText = button.innerHTML;
    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Adding...`;

    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            let tbody = accordionBody.querySelector('table.phase-table tbody');
            if (!tbody) {
                const phaseNameIdentifier = button.dataset.phase;
                const newTableHtml = `
                    <table class="table table-striped table-hover phase-table" id="${phaseNameIdentifier}-table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 10%;">Status</th>
                                <th scope="col" style="width: 40%;">Condition of Satisfaction</th>
                                <th scope="col" style="width: 15%;">Accountable Party</th>
                                <th scope="col" style="width: 15%;">Completion Date</th>
                                <th scope="col" class="text-end actions-header" style="width: 20%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>`;
                accordionBody.querySelector('p')?.remove();
                accordionBody.insertAdjacentHTML('afterbegin', newTableHtml);
                tbody = accordionBody.querySelector('tbody');
            }
            const newRow = createCosTableRow(data.cos);
            tbody.appendChild(newRow);
        } else {
            throw new Error(data.error || 'Failed to create COS.');
        }
    })
    .catch(error => {
        console.error('Error creating COS:', error);
        alert(`Error: ${error.message}`);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalButtonText;
    });
}

function createCosTableRow(cos) {
    const newRow = document.createElement('tr');
    newRow.className = 'cos-row';
    newRow.dataset.cosId = cos.id;
    newRow.dataset.editing = 'false';
    const cosContentHtml = cos.content || '';
    const cosContentText = stripHtmlForTextarea(cosContentHtml);

    newRow.innerHTML = `
        <td class="status-cell align-middle">
            <span class="status-pill ${getBadgeClassFromStatus(cos.status)}">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell align-middle">
            <div class="cos-content-display">${cosContentHtml}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm cos-content-textarea" rows="3">${cosContentText}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell align-middle">
            <span class="cos-accountable-party-display">${cos.accountable_party || 'N/A'}</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="${cos.accountable_party || ''}">
        </td>
        <td class="cos-completion-date-cell align-middle">
            <span class="cos-completion-date-display">${cos.completion_date || 'N/A'}</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="${cos.completion_date || ''}">
        </td>
        <td class="text-end actions-cell align-middle">
            <div class="btn-group cos-actions" role="group">
                <button class="btn btn-sm btn-primary edit-cos-button" title="Edit COS"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-success update-cos-button d-none" title="Update COS"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button d-none" title="Cancel Edit"><i class="fas fa-times"></i></button>
                <button class="btn btn-sm btn-danger delete-cos-button" title="Delete COS"><i class="fas fa-trash"></i></button>
                <button class="btn btn-sm btn-info analyze-cos-button" data-cos-id="${cos.id}" title="Analyze COS"><i class="fas fa-search-plus"></i></button>
            </div>
        </td>
    `;
    return newRow;
}


/**
 * Handles the click event on a CE pill. Gathers context and calls displayCEModal.
 * This is now a simple "launcher" for the Node Application.
 * @param {HTMLElement} pill - The CE pill element that was clicked.
 */
function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    const ceText = pill.querySelector('.ce-pill-text')?.textContent.trim() || 'Conditional Element';

    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cogs';
    showLoadingSpinner(`Analyzing ${ceType} Element...`, iconClass);

    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.querySelector('#ssol-goal')?.textContent.trim() || "SSOL Goal Not Available";
    const cosContextContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || 'COS content not found.';
    const accordionItem = cosRow?.closest('.accordion-item');
    const phaseName = accordionItem?.querySelector('.accordion-header .accordion-button')?.textContent.trim().replace(/\s*PHASE\s*$/i, "").trim() || "Unknown Phase";
    const phaseIndex = accordionItem ? Array.from(accordionItem.parentElement.children).indexOf(accordionItem) : 0;

    const payload = { 
        ce_id: ceId, 
        ce_text: ceText,
        cos_content: cosContextContent, 
        phase_name: phaseName, 
        phase_index: phaseIndex, 
        ssol_goal: ssolGoal 
    };

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) return response.json().then(err => { throw new Error(err.error) });
        return response.json();
    })
    .then(data => {
        if (data.modal_html && data.ce_data) {
            // Pass control to the main application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        } else {
            throw new Error(data.error || 'Server response was missing required data.');
        }
    })
    .catch(error => {
        console.error('Error fetching or displaying CE modal:', error);
        alert(`Could not load application. Error: ${error.message}`);
    })
    .finally(() => {
        hideLoadingSpinner();
    });
}

function triggerPdfExport(ssolId) {
    const printableElement = document.documentElement.cloneNode(true);
    const selectorsToRemove = [
        'script', '.cos-actions', '.add-cos', '#save-as-pdf-button',
        '.modal', '#dynamicModalContainer', '.cos-content-edit',
        '.cos-accountable-party-edit', '.cos-completion-date-edit',
        'select.status-edit-select', '#image-error-container'
    ];
    printableElement.querySelectorAll(selectorsToRemove.join(', ')).forEach(el => el.remove());
    printableElement.querySelectorAll('.accordion-collapse').forEach(collapse => collapse.classList.add('show'));
    printableElement.querySelectorAll('.accordion-button').forEach(button => button.classList.remove('collapsed'));
    printableElement.querySelectorAll('img').forEach(img => {
        if (img.src && !img.src.startsWith('http') && !img.src.startsWith('data:')) {
            try {
                img.src = new URL(img.getAttribute('src'), window.location.href).href;
            } catch (e) { console.warn("Could not convert image src to absolute URL:", img.src, e); }
        }
    });
    const htmlContent = printableElement.outerHTML;
    const pdfButton = document.getElementById('save-as-pdf-button');
    const originalButtonHtml = pdfButton.innerHTML;
    pdfButton.disabled = true;
    pdfButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    fetch(`/save_as_pdf/${ssolId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ htmlContent: htmlContent })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || `PDF generation failed.`); });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SSPEC_Solution_${ssolId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Error saving PDF:', error);
        alert(`PDF Export Error: ${error.message}`);
    })
    .finally(() => {
        pdfButton.disabled = false;
        pdfButton.innerHTML = originalButtonHtml;
    });
}

// --- Global Initialization ---
function initializePageEventListeners() {
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.removeEventListener('click', handlePhaseTableBodyClick);
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    document.querySelectorAll('.add-cos').forEach(button => {
        button.removeEventListener('click', handleAddCOSButtonClick);
        button.addEventListener('click', handleAddCOSButtonClick);
    });

    const savePdfButton = document.getElementById('save-as-pdf-button');
    savePdfButton?.addEventListener('click', (event) => {
        event.preventDefault();
        triggerPdfExport(savePdfButton.dataset.ssolId);
    });
}

document.addEventListener('DOMContentLoaded', initializePageEventListeners);

ğŸ“± app.py:
# app.py (Final Refactor using Application Factory Pattern)
import os
import logging
import asyncio
import sys
from flask import Flask
from flask_migrate import Migrate
from dotenv import load_dotenv
from models import db # Only import the 'db' object from models
import colorlog
from ce_nodes import NODES

# --- FIX for asyncio on Windows ---
# This is the standard fix for `RuntimeError: Event loop is closed` on Windows.
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
# --- END FIX ---

load_dotenv()

# --- 1. Create App and Extension Instances (Uninitialized) ---
app = Flask(__name__)
migrate = Migrate() # Create the Migrate object, but don't connect it to the app yet.

# --- App Configuration ---
app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

# --- Logger Configuration ---
handler = colorlog.StreamHandler()
handler.setFormatter(colorlog.ColoredFormatter(
    '%(log_color)s%(asctime)s - %(name)s - %(levelname)s - %(message)s'
))
logger = logging.getLogger()
logger.setLevel(logging.INFO)
if not logger.handlers:
    logger.addHandler(handler)

# --- Jinja Filter ---
@app.template_filter()
def get_badge_class_from_status(status):
   return {
       'Proposed': 'bg-info',
       'In Progress': 'bg-warning text-dark',
       'Completed': 'bg-success',
       'Rejected': 'bg-danger'
   }.get(status, 'bg-secondary')

@app.context_processor
def inject_nodes():
    """Injects the NODES dictionary into all templates."""
    return dict(nodes=NODES)

# --- 2. Initialize Extensions Conditionally ---
# This is the core of the fix. We now initialize the extensions inside the 'if' block.
if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    app.config['SQLALCHEMY_ECHO'] = os.environ.get('SQLALCHEMY_ECHO', 'False').lower() in ('true', '1', 't')

    # Now, connect the db and migrate objects to the configured app.
    # This ensures the 'db' command is registered only when USE_DATABASE is true.
    db.init_app(app)
    migrate.init_app(app, db)

# --- 3. Blueprint Registration ---
# Import blueprints AFTER the app is configured.
from routes import routes_bp
app.register_blueprint(routes_bp)

# --- Main Execution (for `python app.py`) ---
if __name__ == '__main__':
    # This block is for direct execution and is not run by the 'flask' command.
    app.run(debug=True, port=5000)

ğŸŸ¥ routes.py:
# routes.py
import os
import json
import uuid
import logging
import asyncio
import pdfkit
from uuid import UUID
from dotenv import load_dotenv
from bs4 import BeautifulSoup
from app import USE_DATABASE
from ce_nodes import NODES
from werkzeug.exceptions import BadRequest, NotFound
from models import get_engine_and_session, SSOL, COS
from ce_templates import generate_dynamic_modal
from ai_service import cleanup_gemini_client, generate_chat_response
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, generate_image
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol

load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# --- Lifecycle Management ---
@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up AI resources after each request."""
    await cleanup_gemini_client()

# --- Utility Routes ---
@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

# --- Basic Pages ---
@routes_bp.route('/')
def index():
    return render_template('input.html')

@routes_bp.route('/about')
def about():
    return render_template('about.html')

# --- Goal Selection ---
@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            current_app.logger.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)

            if not goal_options:
                flash("Could not generate goal options. Please try again or rephrase your input.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            current_app.logger.error(f"Unexpected error in goal_selection: {e}", exc_info=True)
            flash(f"An unexpected error occurred: {e}", "error")
            return render_template('input.html', user_text=user_input)
    return redirect(url_for('routes_bp.index'))

# --- Outcome Generation ---
@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        if not selected_goal_text:
            flash("No goal selected. Please try again.", "error")
            return redirect(url_for('routes_bp.index'))
            
        try:
            # Create SSOL
            ssol_id_str = speculate_create_ssol(
            USE_DATABASE, 
            selected_goal_title, 
            selected_goal_text, 
            domain=domain
        )
            ssol_id_uuid = UUID(ssol_id_str)
            current_app.logger.info(f"SSOL created with ID: {ssol_id_str}")
            
            # Generate Structure
            current_app.logger.info("Generating structured solution from AI...")
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, ssol_description=selected_goal_text, domain=domain
            )
            ssol_summary = structured_solution_json.get('ssolsummary', 'AI failed to generate a summary.')

            # Save COS items
            current_app.logger.info("Saving generated COS and their CEs...")
            phases_for_template = {}
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    phases_for_template[phase_name] = []
                    for cos_content_with_tags in cos_items:
                        if cos_content_with_tags:
                            new_cos_id_str = await speculate_create_cos(
                                USE_DATABASE, ssol_id=ssol_id_uuid, content=cos_content_with_tags, status='Proposed'
                            )
                            newly_created_cos = speculate_get_cos_by_id(USE_DATABASE, UUID(new_cos_id_str))
                            if newly_created_cos:
                                phases_for_template[phase_name].append(newly_created_cos.to_dict() if USE_DATABASE else newly_created_cos)

            outcome_data_for_template = {
                'ssol_id': ssol_id_str,
                'ssol_title': selected_goal_title,
                'selected_goal': selected_goal_text,
                'domain': domain,
                'domain_icon': domain_icon,
                'ssol_summary': ssol_summary,
                'phases': phases_for_template,
            }

            # Async Image Generation (Non-blocking/Graceful fail)
            try:
                current_app.logger.info("Dispatching image generation task...")
                image_prompt = f"""A vibrant, isometric, mid-century retro illustration of '{selected_goal_title}: {selected_goal_text}' 
                                    fulfilled, painterly lithograph style, 1950s Popular Science magazine cover, 
                                    saturated colors, idealized realism, optimistic composition, featuring 
                                    people of diverse ethnicities, ages, genders, and abilities, no text.
                                    """
                await generate_image(image_prompt, ssol_id_str)
            except Exception as img_exc:
                current_app.logger.error(f"Image generation failed for SSOL {ssol_id_str}: {img_exc}")

            return render_template('outcome.html', ssol=outcome_data_for_template, nodes=NODES, ssol_id=ssol_id_str)

        except Exception as e:
            current_app.logger.error(f"CRITICAL error in /outcome: {e}", exc_info=True)
            flash(f"A critical error occurred while generating the solution. Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    return redirect(url_for('routes_bp.index'))


# --- Modal Generation (The Speculation Environment Shell) ---
@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        ce_text = data.get('ce_text', 'Conditional Element')

        ce_id_obj = UUID(ce_id_str) if ce_id_str else None
        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        
        # Initialize data structure if empty or missing
        if not ce_data or 'data' not in ce_data:
            ce_data = {
                'id': ce_id_str, 
                'node_type': ce_type, 
                'data': {
                    'details_data': {}, 
                    'resources': [],
                    'prerequisites': [],
                    'stakeholders': [],
                    'assumptions': [],
                    'connections': []
                }
            }

        node_config = NODES.get(ce_type, NODES['Default'])
        
        # Get basic context (Overview) from AI
        cos_content_html = data.get('cos_content', '')
        cos_content_text = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)
        
        ai_generated_data = await generate_ai_data(
            node_type=ce_type,
            cos_content=cos_content_text,
            ssol_goal=data.get('ssol_goal', ''),
            agent_mode='context'
        )

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type,
            ce_text=ce_text,
            ce_data=ce_data,
            node_info=node_config,
            cos_content=cos_content_html,
            ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''),
            phase_index=data.get('phase_index', 0)
        )
        
        return jsonify(modal_html=modal_html, ce_data=ce_data)

    except Exception as e:
        current_app.logger.error(f"Error in get_ce_modal_route: {e}", exc_info=True)
        return jsonify(error=f"An error occurred: {str(e)}"), 500


# --- THE UNIVERSAL INTELLIGENCE ROUTE (The Brain) ---
@routes_bp.route('/speculate_context', methods=['POST'])
async def speculate_context_route():
    """
    The Universal Brain of the Speculation Environment.
    It handles two types of requests:
    1. 'collections': Generating lists of items (Prerequisites, Stakeholders, etc.)
    2. 'narrative': generating text for specific details fields (Summary, Context, etc.)
    """
    try:
        data = request.get_json()
        ce_type = data.get('ce_type')           # e.g. 'Research', 'Risk'
        context = data.get('context')           # e.g. 'prerequisites', 'narrative'
        sub_context = data.get('sub_context')   # e.g. 'summary' (only for narrative)
        cos_text = data.get('cos_text', 'Achieve the goal.')

        # 1. Load Node Configuration & Prompts
        # Fallback to Default if the specific node type isn't found
        node_config = NODES.get(ce_type, NODES['Default'])
        prompts_map = node_config.get('prompts', {})
        
        # Ensure we have access to Default prompts if the specific node misses one
        default_prompts = NODES['Default'].get('prompts', {})

        final_prompt = ""
        system_instruction = "You are the SPECULATE Engine. Respond ONLY with valid JSON. Do not use markdown formatting."

        # 2. Branch Logic: Narrative vs. Collections
        if context == 'narrative':
            # --- Narrative Mode (Text Generation) ---
            
            # Try to find a specific narrative prompt, otherwise use a smart fallback
            raw_prompt = prompts_map.get('narrative', default_prompts.get('narrative'))
            
            if not raw_prompt:
                # Hard fallback if not defined in nodes yet
                raw_prompt = """
                Act as a strategic project manager. Write a professional 1-paragraph '{field}' 
                for a '{node_type}' element needed to achieve: '{cos_text}'.
                Focus on clarity, actionability, and value.
                Return strictly JSON: {{ "text": "Your generated text here." }}
                """
            
            # Inject the specific field name (e.g. 'Executive Summary') and context
            field_label = sub_context.replace('_', ' ').title() if sub_context else "Description"
            final_prompt = raw_prompt.format(
                cos_text=cos_text, 
                field=field_label, 
                node_type=ce_type
            )

        else:
            # --- Collection Mode (List Generation) ---
            
            # Retrieve the specific collection prompt (e.g., for 'prerequisites')
            raw_prompt = prompts_map.get(context, default_prompts.get(context))
            
            if not raw_prompt:
                # Hard fallback
                raw_prompt = f"Analyze '{cos_text}'. List 3 strategic items for {{context}}. Return JSON array."
            
            # Inject context
            final_prompt = raw_prompt.format(cos_text=cos_text)

        # 3. Execute SPECULATE Engine (AI Call)
        current_app.logger.info(f"Speculating {ce_type} -> {context} ({sub_context or 'list'})")
        
        ai_response_str = await generate_chat_response(
            messages=[{"role": "user", "content": final_prompt}], 
            role="Speculate Engine", 
            task=f"Speculate {context}",
            system_instruction=system_instruction,
            temperature=0.7
        )
        
        # 4. Clean and Parse JSON
        try:
            # Strip Markdown backticks if present (Common LLM artifact)
            cleaned_response = ai_response_str.replace("```json", "").replace("```", "").strip()
            parsed_json = json.loads(cleaned_response)
        except json.JSONDecodeError:
            current_app.logger.warning(f"Failed to parse AI JSON: {ai_response_str}")
            return jsonify({'success': False, 'error': 'AI returned invalid format. Please try again.'}), 500

        # 5. Return Formatted Data
        if context == 'narrative':
            # Expecting object: { "text": "..." }
            text_content = parsed_json.get('text', '') if isinstance(parsed_json, dict) else str(parsed_json)
            return jsonify({
                'success': True, 
                'text': text_content, 
                'field': sub_context
            })
        else:
            # Expecting list: [ {...}, {...} ]
            # Handle case where AI wraps list in a root object like { "items": [...] }
            if isinstance(parsed_json, dict):
                # Try to find the first list value
                for key, val in parsed_json.items():
                    if isinstance(val, list):
                        suggestions = val
                        break
                else:
                    suggestions = [] # Fallback
            elif isinstance(parsed_json, list):
                suggestions = parsed_json
            else:
                suggestions = []

            return jsonify({
                'success': True, 
                'suggestions': suggestions, 
                'context': context
            })

    except Exception as e:
        current_app.logger.error(f"Speculation Error in routes: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

# --- Data Operations (CRUD) ---

@routes_bp.route('/update_ce/<uuid:ce_id>', methods=['PUT'])
def update_ce_route(ce_id):
    try:
        data = request.get_json()
        if not data: raise BadRequest('No JSON payload')
        
        # We store the entire structure (collections + details) in the 'data' JSON column
        success = speculate_update_ce_by_id(USE_DATABASE, ce_id, data)
        
        if success:
            return jsonify(success=True), 200
        return jsonify(success=False, error="Update failed"), 500
    except Exception as e:
        current_app.logger.error(f"Error updating CE {ce_id}: {e}")
        return jsonify(success=False, error=str(e)), 500


@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        new_cos_id = await speculate_create_cos(
            USE_DATABASE, 
            UUID(data['ssol_id']), 
            data['content'], 
            data.get('status', 'Proposed'),
            data.get('accountable_party'),
            data.get('completion_date')
        )
        if new_cos_id:
            cos_obj = speculate_get_cos_by_id(USE_DATABASE, UUID(new_cos_id))
            return jsonify(success=True, cos=cos_obj.to_dict() if USE_DATABASE else cos_obj), 201
        return jsonify(success=False, error="Creation failed"), 500
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        result = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)
        if result['success']: return jsonify(success=True, cos=result['cos'])
        return jsonify(success=False, error=result['message']), result['status_code']
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    if speculate_delete_cos_by_id(USE_DATABASE, cos_id):
        return jsonify(success=True)
    return jsonify(success=False, error="Deletion failed"), 404


# --- Image & Export Operations ---

@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    img_path = f"images/ssol_image_{ssol_id}.png"
    full_path = os.path.join(current_app.static_folder, img_path)
    if os.path.exists(full_path):
        return jsonify({'image_path': url_for('static', filename=img_path), 'status': 'found'})
    return jsonify({'status': 'pending_or_not_found'}), 200

@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        data = request.get_json()
        if not data or 'htmlContent' not in data:
            raise ValueError("Invalid request: No HTML content provided.")
        html_content = data['htmlContent']

        css_file_path = os.path.join(current_app.root_path, 'static', 'styles.css')
        css_param = css_file_path if os.path.exists(css_file_path) else None

        # Convert relative paths to absolute
        html_content = html_content.replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')

        options = {
            "page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in",
            "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8",
            "no-outline": None, "enable-local-file-access": None,
        }

        pdf = pdfkit.from_string(html_content, False, options=options, css=css_param)

        response = make_response(pdf)
        response.headers['Content-Type'] = 'application/pdf'
        response.headers['Content-Disposition'] = f'attachment; filename="SSPEC_Solution_{ssol_id}.pdf"'
        return response

    except Exception as e:
        current_app.logger.error(f"Exception in save_as_pdf for SSOL {ssol_id}: {e}", exc_info=True)
        return jsonify(success=False, error=str(e)), 500

# --- Input Analysis ---

@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    try:
        txt = request.form.get('user_text')
        if not txt: return jsonify({'error': 'No text'}), 400
        return jsonify({
            'keywords': await analyze_user_input(txt), 
            'compliance': await is_input_compliant(txt)
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

ğŸŸ¨ utilities.py:
# utilities.py

import logging
import json
import re
import uuid
from typing import Dict, List
from bs4 import BeautifulSoup

from flask import current_app

# Import AI services
from ai_service import generate_chat_response, get_grounded_data, generate_image

# Local Imports
from ce_nodes import NODES, get_valid_node_types
# Note: We delay import of models/store inside functions where necessary to avoid circular imports

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO)

# --- SSPEC Methodology Context ---
def get_sspec_scenario() -> str:
    return """
    The Structured Speculation (SSPEC) methodology is a structured approach to problem-solving.
    It involves defining a Structured Solution (SSOL), which is a high-level goal,
    broken into five phases: Discovery, Engagement, Action, Completion, and Legacy.
    Each phase contains Conditions of Satisfaction (COS), which are verifiable requirements.
    Each COS is further detailed by Conditional Elements (CEs) using specialized node types.
    """

# --- HELPER: CE Pill Rendering ---

def replace_ce_tags_with_pills(content):
    """
    Parses COS content, finds <ce> tags, and replaces them with interactive
    HTML pills. It performs a real-time lookup to check for associated resources
    and adds a visual count or 'new' indicator.
    """
    if not content:
        return ""

    # Delayed imports to avoid circular dependencies
    from app import USE_DATABASE
    from store import ce_store
    from models import CE, get_engine_and_session
    from uuid import UUID

    soup = BeautifulSoup(content, 'html.parser')
    ce_tags = soup.find_all('ce')

    for tag in ce_tags:
        ce_id_str = tag.get('id')
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        
        resource_count = 0
        
        # --- 1. Fetch Resource Count Safely ---
        try:
            if ce_id_str:
                if USE_DATABASE:
                    # Create a temporary, isolated session for this lookup
                    engine, SessionLocal = get_engine_and_session()
                    session = SessionLocal()
                    try:
                        # Verify UUID format before query
                        ce_uuid = UUID(ce_id_str)
                        ce_instance = session.query(CE).get(ce_uuid)
                        
                        if ce_instance and ce_instance.data:
                            # Access the JSON data
                            data_payload = ce_instance.data
                            # Handle case where data might be a string (SQLite edge cases) or dict
                            if isinstance(data_payload, str):
                                data_payload = json.loads(data_payload)
                                
                            resources = data_payload.get('resources', [])
                            resource_count = len(resources)
                    except Exception as db_err:
                        logging.warning(f"Error fetching CE count for {ce_id_str}: {db_err}")
                    finally:
                        session.close()
                else:
                    # Fallback to in-memory store
                    ce_data = ce_store.get(ce_id_str, {})
                    if ce_data and 'data' in ce_data:
                        resource_count = len(ce_data['data'].get('resources', []))
        except Exception as e:
            # Fail gracefully (display pill with 0 count) rather than crashing the page
            logging.error(f"Error in replace_ce_tags_with_pills: {e}")

        # --- 2. Build the New Pill HTML ---
        
        # Get node config for styling
        node_config = NODES.get(ce_type, NODES['Default'])
        node_color = node_config.get('color', '#6c757d')
        node_icon = node_config.get('icon', 'fa-solid fa-cube')

        # Main Container (Matches styles.css .ce-pill)
        # We set a CSS variable --node-color for the icon background
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-pill',
            'data-ce-id': ce_id_str,
            'data-ce-type': ce_type,
            'title': f"{ce_type} | Click to open",
            'style': f'--node-color: {node_color};' 
        })
        
        # A. Icon Section (White icon on colored background)
        icon_span = soup.new_tag('span', attrs={'class': 'ce-pill-icon'})
        i_tag = soup.new_tag('i', attrs={'class': node_icon})
        icon_span.append(i_tag)
        new_tag.append(icon_span)
        
        # B. Text Section
        text_span = soup.new_tag('span', attrs={'class': 'ce-pill-text'})
        text_span.string = ce_text
        new_tag.append(text_span)

        # C. Indicator Section (Count or "New" Dot)
        if resource_count > 0:
            # Gray pill with number
            count_badge = soup.new_tag('span', attrs={
                'class': 'badge bg-secondary ms-1 me-1 rounded-pill', 
                'style': 'font-size: 0.65em; opacity: 0.9; vertical-align: middle;'
            })
            count_badge.string = str(resource_count)
            new_tag.append(count_badge)
        else:
            # Small Green "New" Dot
            dot = soup.new_tag('span', attrs={
                'class': 'rounded-circle bg-success d-inline-block ms-1 me-1', 
                'style': 'width: 6px; height: 6px; vertical-align: middle;',
                'title': 'Ready for Speculation'
            })
            new_tag.append(dot)

        # Replace the original <ce> tag with our new structured span
        tag.replace_with(new_tag)

    return str(soup)


# --- GOAL SELECTION & INPUT ANALYSIS ---

async def generate_goal(user_input: str) -> List[Dict]:
    prompt = f"""
    Based on the user input '{user_input}', generate three distinct, high-level goal options. 
    Each goal must be a JSON object with these exact keys: "domain", "title", "goal", "icon", "is_compliant". 
    
    ICON RULES (CRITICAL):
    1. Use valid 'FontAwesome 6 Free' class names (e.g., 'fa-solid fa-robot').
    2. DO NOT guess v7 icons. Stick to established v6 Solid icons.
    3. Ensure the icon is from the 'Free' set, not 'Pro'.
    
    "is_compliant" must be a boolean.
    """
    
    system_instruction = "You are a JSON-only API. Your entire response MUST be a single, raw, valid JSON array of three objects."
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="goal generation", system_instruction=system_instruction)
        ai_goals = json.loads(response_str)

        validated_goals = []
        for goal in ai_goals:
            if not isinstance(goal, dict): continue
            validated_goals.append({
                'domain': goal.get('domain', 'General'),
                'title': goal.get('title', 'Untitled Goal'),
                'goal': goal.get('goal', 'No description provided.'),
                'icon': goal.get('icon', 'fa-solid fa-question-circle'),
                'is_compliant': goal.get('is_compliant', goal.get('iscompliant', True))
            })
        return validated_goals
    except Exception as e:
        logging.error(f"Error in generate_goal: {e}", exc_info=True)
        return []

async def analyze_user_input(user_text: str) -> List[str]:
    prompt = f'Analyze the following text and extract 3-5 key themes or keywords. Text: "{user_text}". Return as a JSON object with a single key "keywords" containing an array of strings.'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="keyword extraction")
        result = json.loads(response_str)
        return result.get('keywords', [])
    except Exception as e:
        logging.error(f"Error in analyze_user_input: {e}", exc_info=True)
        return []

async def is_input_compliant(user_text: str) -> dict:
    prompt = f"""Analyze the following user input for compliance with safety and constructive use policies. Text: "{user_text}". Return a JSON object with two keys: "compliant" (boolean) and "reason"."""
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="compliance check")
        result = json.loads(response_str)
        return {"compliant": result.get('compliant', True), "reason": result.get('reason', '')}
    except Exception as e:
        logging.error(f"Error in is_input_compliant: {e}", exc_info=True)
        return {"compliant": False, "reason": "System error."}


# --- OUTCOME & CE GENERATION ---

async def generate_outcome_data(ssol_title, ssol_description, domain):
    node_types_str = ', '.join(get_valid_node_types())
    prompt = f"""
    Generate a structured solution for: '{ssol_title}' in domain '{domain}'.
    {get_sspec_scenario()}
    
    Response MUST be a single JSON object with keys: 'ssolsummary' (HTML string) and 'phases' (Object with 5 phase keys).
    Each phase contains an array of COS strings.
    
    FORMATTING RULES FOR CEs:
    1. You MUST identify MULTIPLE Conditional Elements within a single COS if they represent distinct concepts (e.g., a tool AND a person AND a policy).
    2. Embed them using <ce type="NodeType">Label</ce>.
    3. The "Label" text inside the tags must be a concise TITLE (2-5 words). Do not wrap whole sentences.
    
    Example:
    Input: "We need to get approval from the City Council and buy a 3D Printer."
    Good Output: "We need to get <ce type='Stakeholder'>City Council Approval</ce> and acquire a <ce type='Resource'>3D Printer</ce>."
    
    Valid NodeTypes: {node_types_str}.
    """
    messages = [{"role": "user", "content": prompt}]
    response_str = await generate_chat_response(messages, role="user", task="ssol generation", temperature=0.7)
    return json.loads(response_str)

async def generate_ai_data(node_type: str, cos_content: str, ssol_goal: str, agent_mode: str = 'context') -> dict:
    node_config = NODES.get(node_type, NODES['Default'])
    query_context = f"Overall Goal: '{ssol_goal}'. Requirement: '{cos_content}'."
    
    try:
        if agent_mode == 'speculate':
            # Use grounded search
            resource_keys = [f"'{f['key']}'" for f in node_config.get('resource_schema', [])]
            query = f"Find 3 diverse, real-world resources for a '{node_type}' element. Context: {query_context}. Extract: {', '.join(resource_keys)}."
            return await get_grounded_data(query, node_type)
        
        elif agent_mode == 'generate':
            # Generate details form content
            detail_fields = [f"'{f['name']}'" for f in node_config.get('details_schema', [])]
            prompt = f"As an expert, generate summary content for a {node_type} element. Context: {query_context}. Provide JSON for fields: {', '.join(detail_fields)}."
            messages = [{"role": "user", "content": prompt}]
            response_str = await generate_chat_response(messages, role="user", task="generate details")
            return json.loads(response_str)
            
        else: # Context mode
            prompt = f"Briefly explain the strategic purpose of this '{node_type}' element in the Context: {query_context}. Return JSON with key 'contextual_description'."
            messages = [{"role": "user", "content": prompt}]
            response_str = await generate_chat_response(messages, role="user", task="contextual insight")
            return json.loads(response_str)

    except Exception as e:
        logging.error(f"Error in generate_ai_data ({agent_mode}): {e}", exc_info=True)
        return {"error": str(e)}

â¬œ speculate.py:
# speculate.py
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from ce_nodes import NODES, get_valid_node_types
from ai_service import generate_chat_response_with_node_types
from datetime import date, timedelta

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """Helper function to generate the standard HTML for a CE pill."""
    node_info = NODES.get(ce_type, NODES['Default'])
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-question-circle')
    
    return (
        f'<span class="ce-pill" data-ce-id="{ce_id}" data-ce-type="{ce_type}" style="--node-color: {node_color};">'
        f'<span class="ce-pill-icon"><i class="{node_icon}"></i></span>'
        f'<span class="ce-pill-text">{html.escape(ce_text)}</span>'
        f'</span>'
    )

# --- AI Analysis ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content to identify CEs. Returns structured JSON for creation/updating.
    """
    node_types_str = ', '.join(get_valid_node_types())
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify ALL distinct Conditional Elements (CEs) within this text. "
        f"Valid NodeTypes: {node_types_str}. "
        "Return JSON with keys 'analyzed_cos_text' (original text with <ce type='Type'>Title</ce> tags) "
        "and 'identified_ces' (array of {text, type})."
    )
    messages = [{"role": "user", "content": prompt}]
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS')
        # Parse logic
        match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", response_text, re.DOTALL)
        clean_text = match.group(1).strip() if match else response_text.strip()
        
        response_json = json.loads(clean_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}", exc_info=True)
        # Fallback: return original text, no CEs detected
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

# --- SSOL Operations ---

def create_ssol(USE_DATABASE: bool, title: str, description: str, domain: str = None) -> str:
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    # MVP Rule: Set a default "Horizon" of 1 year from creation
    default_target_date = date.today() + timedelta(days=365)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            
            ssol = SSOL(
                id=new_ssol_uuid, 
                title=title, 
                description=description,
                domain=domain,
                status='Active', 
                target_date=default_target_date,
                integrity_score=100,
                completion_percentage=0
            )
            
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {
            'id': ssol_id, 
            'title': title, 
            'description': description, 
            'domain': domain,
            'status': 'Active',
            'target_date': default_target_date.isoformat(),
            'integrity_score': 100,
            'completion_percentage': 0,
            'phases': {}
        }
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    else:
        return ssol_store.get(str(ssol_id))

# --- COS Operations ---

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> str:
    from models import COS, CE, get_engine_and_session
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    try:
        # 1. Parse Tags
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        
        new_ce_instances = []
        
        # 2. Create CEs from tags
        for tag in ce_tags:
            ce_text = tag.string
            ce_type = tag.get('type')
            if not ce_text or not ce_type: continue

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': ce_type,
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "prerequisites": [], "stakeholders": [], "assumptions": [], "resources": [], "connections": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace tag with Pill HTML
            pill_html = _render_ce_pill_html(str(new_ce_uuid), ce_type, ce_text)
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        content_with_pills = str(soup)

        # 3. Persist
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos_instance = COS(
                    id=new_cos_uuid, 
                    content=content_with_pills, 
                    status=status, 
                    ssol_id=ssol_id,
                    accountable_party=accountable_party, 
                    completion_date=completion_date
                )
                session.add(cos_instance)
                
                for ce_rec in new_ce_instances:
                    ce_instance = CE(
                        id=ce_rec['id'], 
                        node_type=ce_rec['node_type'], 
                        cos_id=new_cos_uuid, 
                        data=ce_rec['data']
                    )
                    session.add(ce_instance)
                
                session.commit()
                session.close()
        else:
            cos_store[cos_id_str] = {'id': cos_id_str, 'content': content_with_pills, 'status': status, 'ssol_id': str(ssol_id)}
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
        
        return cos_id_str

    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        raise

async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from store import cos_store, ce_store
    from app import app

    new_content = updated_data.get('content')
    
    try:
        new_ce_instances = []
        
        # If content changed, re-analyze and generate pills/CEs
        if new_content is not None:
            analysis = await analyze_cos(new_content, str(cos_id))
            soup = BeautifulSoup(analysis['content_with_tags'], 'html.parser')
            ce_tags = soup.find_all('ce')
            
            for tag in ce_tags:
                c_txt, c_type = tag.string, tag.get('type')
                new_id = uuid.uuid4()
                new_ce_instances.append({
                    'id': new_id, 
                    'node_type': c_type, 
                    'data': {"details_data": {}, "resources": []}
                })
                pill = _render_ce_pill_html(str(new_id), c_type, c_txt)
                tag.replace_with(BeautifulSoup(pill, 'html.parser'))
            
            updated_data['content'] = str(soup)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id)
                if not cos: 
                    session.close()
                    return {'success': False, 'message': 'COS not found', 'status_code': 404}
                
                for k, v in updated_data.items():
                    if hasattr(cos, k) and k not in ['id', 'ssol_id']: 
                        setattr(cos, k, v)
                
                # If content changed, flush old CEs and add new ones
                if new_content is not None:
                    session.query(CE).filter_by(cos_id=cos_id).delete()
                    for nc in new_ce_instances:
                        session.add(CE(id=nc['id'], node_type=nc['node_type'], cos_id=cos_id, data=nc['data']))
                
                session.commit()
                cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': cos_dict}
        
        return {'success': False, 'message': 'DB Required', 'status_code': 500}

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return {'success': False, 'message': str(e), 'status_code': 500}

def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            session.close()
            return cos
    return cos_store.get(str(cos_id))

def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(cos_id=cos_id).delete()
            cos = session.query(COS).get(cos_id)
            if cos:
                session.delete(cos)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

# --- CE Operations ---

def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id_param if isinstance(ce_id_param, UUID) else UUID(str(ce_id_param))
    
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            result = ce.to_dict() if ce else None
            session.close()
            return result
    return ce_store.get(str(ce_id_uuid))

def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id)
            if ce:
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from app import app
    new_id = uuid.uuid4()
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.add(CE(id=new_id, node_type=node_type, cos_id=cos_id, data=data))
            session.commit()
            session.close()
    return str(new_id)

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(id=ce_id).delete()
            session.commit()
            session.close()
            return True
    return False

ğŸŸ¦ outcome.html:
{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- 1. MISSION HEADER SCREEN -->
    <div class="screen-surface d-flex flex-column flex-md-row bg-white mb-4">
        
        <!-- Left Sidebar: Visuals & Stats -->
        <div class="header-sidebar col-md-3">
            <!-- Image Portal -->
            <div class="image-portal">
                <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" id="placeholderImage" class="fade-in">
                <img src="" id="ssolImage" class="fade-in" style="opacity: 0;">
            </div>
            
            <!-- Domain Sector -->
            <div class="mb-4 w-100">
                <div class="font-data text-muted small mb-1">DOMAIN SECTOR</div>
                <div class="domain-badge mx-auto">
                    <i class="{{ ssol.domain_icon }} text-info"></i>
                    <span class="font-body fw-bold small text-dark ms-2">{{ ssol.domain | upper }}</span>
                </div>
            </div>

            <!-- Goal -->
            <div class="w-100 text-start border-top pt-3">
                <div class="font-data text-muted small mb-2">SYSTEM GOAL</div>
                <div id="ssol-goal" class="d-none">{{ ssol.selected_goal }}</div>
                <p class="font-body small text-muted fst-italic lh-sm">"{{ ssol.selected_goal }}"</p>
            </div>
        </div>

        <!-- Right Content: Brief -->
        <div class="col-md-9 p-4 p-md-5 position-relative">
            <div class="brand-strip"></div>
            
            <div class="d-flex justify-content-between align-items-start mb-4 mt-2">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge bg-info font-data rounded-1 text-white">SSPEC SOLUTION</span>
                        <span class="font-data text-muted">#{{ ssol_id.split('-')[0] | upper }}</span>
                    </div>
                    <h1 class="display-5 text-dark mb-0">{{ ssol.ssol_title }}</h1>
                </div>
                
                <!-- Action Deck -->
                <div class="d-flex gap-2">
                    <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-sm btn-info text-white font-data rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
                        <i class="fas fa-file-pdf"></i> EXPORT PDF
                    </button>
                </div>
            </div>

            <!-- Summary Box -->
            <div class="bg-light p-4 rounded-3 border position-relative overflow-hidden">
                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                   <i class="fas fa-sparkles fa-3x text-secondary"></i>
                </div>
                <div class="font-body text-dark" style="line-height: 1.8;">
                    {{ ssol.ssol_summary | safe }}
                </div>
            </div>
            
            <!-- Decorative Data Strip -->
            <div class="d-flex align-items-center gap-1 mt-4 opacity-50">
                <div class="rounded-1 bg-secondary" style="width: 40px; height: 6px;"></div>
                <div class="rounded-1 bg-secondary" style="width: 20px; height: 6px;"></div>
                <div class="rounded-1 bg-light flex-grow-1" style="height: 6px;"></div>
                <div class="rounded-1 bg-info" style="width: 60px; height: 6px;"></div>
            </div>
        </div>
    </div>

    <!-- 2. DATA GRID (Phases) -->
    <div class="screen-surface bg-light min-vh-50 d-flex flex-column">
        
        <!-- Grid Header -->
        <div class="bg-white border-bottom px-4 py-4 d-flex justify-content-between align-items-center shadow-sm z-10">
            <h2 class="h5 mb-0 text-secondary font-brand letter-spacing-1">PHASES & CONDITIONS</h2>
            <div class="d-none d-md-flex gap-4 font-data text-muted small tracking-widest">
                <span><i class="fas fa-circle text-danger small me-1"></i>Discovery</span>
                <span><i class="fas fa-circle text-info small me-1"></i>Engagement</span>
                <span><i class="fas fa-circle text-primary small me-1"></i>Action</span>
                <span><i class="fas fa-circle text-warning small me-1"></i>Legacy</span>
            </div>
        </div>

        <!-- Module Stack (The Accordions) -->
        <div class="p-4 overflow-y-auto flex-grow-1">
            <div class="accordion" id="phaseAccordion">
                {% for phase_name, cos_list in ssol.phases.items() %}
                <div class="accordion-item border-0 mb-3 bg-transparent">
                    <!-- Custom Header -->
                    <div class="module-header collapsed" 
                         data-bs-toggle="collapse" 
                         data-bs-target="#collapse{{ loop.index }}" 
                         style="background-color: var(--phase-{{ loop.index0 }}); border-left-color: var(--phase-{{ loop.index0 }});">
                        
                        <div class="d-flex align-items-center gap-3">
                            <div class="phase-icon">{{ phase_name[0] }}</div>
                            <div>
                                <div class="phase-title">{{ phase_name }} PHASE</div>
                                <div class="font-data text-white-50 small">SEQUENCE 0{{ loop.index }}</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-white"></i>
                    </div>

                    <!-- Custom Body -->
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show module-content" data-bs-parent="#phaseAccordion">
                        <div class="accordion-body p-0 phase-table-container" data-ssol-id="{{ ssol_id }}">
                            {% if cos_list %}
                            <table class="retro-table">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Status</th>
                                        <th>Condition Protocol</th>
                                        <th style="width: 18%;">Accountable</th>
                                        <th style="width: 12%;">Target</th>
                                        <th class="text-end" style="width: 100px;">Edit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cos in cos_list %}
                                    <tr class="cos-row" data-cos-id="{{ cos.id }}" data-editing="false">
                                        <!-- Status -->
                                        <td class="status-cell">
                                            <span class="status-block" style="background-color: {{ 'var(--success)' if cos.status == 'Completed' else 'var(--warning)' if cos.status == 'Active' else '#94a3b8' }}">
                                                {{ cos.status | upper }}
                                            </span>
                                        </td>
                                        <!-- Content (Rich Text) -->
                                        <td class="cos-content-cell">
                                            <div class="cos-content-display">{{ cos.content | safe }}</div>
                                            <div class="cos-content-edit d-none">
                                                <textarea class="form-control form-control-sm">{{ cos.content | striptags }}</textarea>
                                            </div>
                                        </td>
                                        <!-- Accountable -->
                                        <td class="cos-accountable-party-cell">
                                            <div class="d-flex align-items-center gap-2 fw-bold text-secondary small">
                                                <div class="bg-light rounded-circle p-1 d-flex align-items-center justify-content-center" style="width:24px;height:24px;"><i class="fas fa-user small"></i></div>
                                                <span class="cos-accountable-party-display">{{ cos.accountable_party or 'N/A' }}</span>
                                                <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="{{ cos.accountable_party }}">
                                            </div>
                                        </td>
                                        <!-- Date -->
                                        <td class="cos-completion-date-cell font-data">
                                            <span class="cos-completion-date-display">{{ cos.completion_date or 'TBD' }}</span>
                                            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="{{ cos.completion_date }}">
                                        </td>
                                        <!-- Actions -->
                                        <td class="text-end actions-cell">
                                            <div class="btn-group cos-actions">
                                                <button class="btn btn-sm btn-link text-muted edit-cos-button"><i class="fas fa-cog"></i></button>
                                                <button class="btn btn-sm btn-link text-danger delete-cos-button"><i class="fas fa-trash"></i></button>
                                            </div>
                                            <div class="btn-group cos-actions d-none"> <!-- Edit Mode Actions -->
                                                <button class="btn btn-sm btn-success update-cos-button"><i class="fas fa-check"></i></button>
                                                <button class="btn btn-sm btn-secondary cancel-cos-button"><i class="fas fa-times"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <!-- Add Button Footer -->
                            <div class="p-3 bg-light border-top d-flex justify-content-center">
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}">
                                    <i class="fas fa-plus me-2"></i> ADD PROTOCOL UNIT
                                </button>
                            </div>
                            {% else %}
                            <div class="p-5 text-center text-muted font-body">
                                <i class="fas fa-folder-open fa-2x mb-3 opacity-25"></i>
                                <p>No protocols initialized for this phase.</p>
                            </div>
                            <div class="p-3 bg-light border-top d-flex justify-content-center">
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}">
                                    <i class="fas fa-plus me-2"></i> INITIALIZE PROTOCOL
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Footer Status -->
        <div class="px-4 py-3 bg-white border-top d-flex justify-content-between align-items-center">
            <div class="font-data small text-muted d-flex align-items-center">
                <div class="rounded-circle bg-success me-2 animate-pulse" style="width:8px; height:8px;"></div>
                SYSTEM ONLINE
            </div>
            <div class="font-data small text-muted">SSPEC HORIZON EDITION v2025.18</div>
        </div>

    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title font-brand">SYSTEM ERROR</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body font-body">
                <div id="errorMessageContent">Unknown Error</div>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Modal Container -->
<div id="dynamicModalContainer"></div>

<style>
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
{% endblock %}

{% block scripts %}
<!-- Load Modules -->
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>

<!-- Tabulator Dependencies -->
<link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

<!-- Image Loading Logic -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const ssolId = "{{ ssol_id }}"; 
    const ssolImageElement = document.getElementById('ssolImage'); 
    const placeholderImageElement = document.getElementById('placeholderImage');
    
    // Image Fetch Logic (Same as before, ensuring visual transition)
    if (ssolImageElement && placeholderImageElement) {
        const defaultPath = "{{ url_for('static', filename='images/sspec_default.png') }}";
        
        function checkImage() {
            fetch(`/get_ssol_image/${ssolId}`)
                .then(r => r.json())
                .then(data => {
                    if(data.status === 'found' && data.image_path) {
                        ssolImageElement.src = data.image_path;
                        ssolImageElement.onload = () => {
                            placeholderImageElement.style.opacity = 0;
                            ssolImageElement.style.opacity = 1;
                        };
                    } else {
                        setTimeout(checkImage, 2000);
                    }
                })
                .catch(e => console.error(e));
        }
        checkImage();
    }
  });
</script>
{% endblock %}

ğŸª store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

ğŸ§© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER (Refactored per Prototype) -->
            <div class="modal-header ce-modal-header">
                <div class="node-icon"><i class="{{ node_info.icon }}"></i></div>
                <div class="ms-2 flex-grow-1">
                    <!-- Row 1: Title & Badge -->
                    <div class="ce-header-title-row">
                        <h5 class="modal-title ce-title">{{ ceType.upper() }} NODE</h5>
                        <div class="phase-badge">{{ phase_name.upper() }} PHASE</div>
                    </div>
                    <!-- Row 2: Metadata -->
                    <div class="ce-header-metadata">
                        // {{ ce_text }} // STRUCTURED SOLUTION // ID: {{ ceId.split('-')[0] }}
                    </div>
                </div>
                
                <div class="ms-auto d-flex align-items-center gap-2">
                     <!-- Visual Status Pill -->
                     <div class="bg-white bg-opacity-25 rounded-pill px-3 py-1 me-3 text-white small fw-bold border border-white border-opacity-25 d-none d-md-block">
                        <i class="fas fa-circle text-success me-1" style="font-size:6px; vertical-align:middle;"></i> ONLINE
                     </div>
                     
                     <button class="btn btn-header-action" id="speculate-sidebar-toggle" title="Toggle Intelligence">
                        <i class="fas fa-columns"></i>
                    </button>
                    <button type="button" class="btn btn-header-action" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0">
                
                <!-- LEFT: MAIN CONTENT -->
                <div class="ce-main-column">
                    
                    <!-- TABS (Consolidated) -->
                    <ul class="nav nav-tabs ce-nav-tabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}"><i class="fas fa-home"></i> Overview</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-prerequisites-{{ ceId }}"><i class="fas fa-tasks"></i> Prerequisites</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-stakeholders-{{ ceId }}"><i class="fas fa-users"></i> Stakeholders</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-assumptions-{{ ceId }}"><i class="fas fa-shield-alt"></i> Assumptions</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-resources-{{ ceId }}"><i class="fas fa-database"></i> Resources</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i> Connections</button></li>
                    </ul>

                    <div class="ce-app-content tab-content">
                        
                        <!-- 1. OVERVIEW TAB (Now includes Narrative) -->
                        <div class="tab-pane fade show active" id="view-overview-{{ ceId }}">
                            
                            <div class="content-header">Overview</div>
                            
                            <div class="row g-4 mb-5">
                                <!-- Big Status Card -->
                                <div class="col-md-7">
                                    <div class="dashboard-status-card">
                                        <div class="status-card-label">Current State</div>
                                        <div class="status-card-value mb-2">Awaiting Input<span class="text-warning" style="vertical-align: middle; font-size: 2rem; line-height:0;">â€¢</span></div>
                                        <p class="text-muted mb-0" style="max-width: 90%;">
                                            This node is currently initialized. To begin, select the <strong>Speculate</strong> action on any tab to generate a strategic draft.
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Confidence / Metrics -->
                                <div class="col-md-5">
                                    <div class="row g-3 h-100">
                                        <div class="col-6">
                                            <div class="metric-card-modern h-100 d-flex flex-column justify-content-center text-center">
                                                <div class="metric-value count-badge" data-collection="prerequisites">0</div>
                                                <div class="metric-label">Prerequisites</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="metric-card-modern h-100 d-flex flex-column justify-content-center text-center">
                                                <div class="metric-value count-badge" data-collection="stakeholders">0</div>
                                                <div class="metric-label">Stakeholders</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="metric-card-modern h-100 d-flex flex-column justify-content-center text-center">
                                                <div class="metric-value count-badge" data-collection="assumptions">0</div>
                                                <div class="metric-label">Assumptions</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="metric-card-modern h-100 d-flex flex-column justify-content-center text-center">
                                                <div class="metric-value text-success">Online</div>
                                                <div class="metric-label">Status</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Merged Narrative Section -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="content-header mb-0">Executive Narrative</div>
                                        <button class="btn btn-sm btn-link text-decoration-none" onclick="document.getElementById('narrative-details').classList.toggle('d-none')">
                                            Expand / Edit <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Display (Summary only) -->
                                    <div class="p-4 bg-white rounded border shadow-sm mb-4">
                                        <div class="d-flex gap-3">
                                            <div class="text-muted"><i class="fas fa-quote-left fa-2x opacity-25"></i></div>
                                            <div>
                                                <h6 class="fw-bold text-dark">Synopsis</h6>
                                                <p class="mb-0 text-muted">
                                                    {{ ce_data.data.details_data.get('summary', 'No narrative generated yet. Use the AI to draft an executive summary.') }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hidden Editing Form (Folded here instead of separate tab) -->
                                    <div id="narrative-details" class="d-none">
                                        <form id="narrative-form-{{ ceId }}" class="bg-white p-4 border rounded">
                                            {% for field in node_info.details_schema %}
                                            <div class="mb-3">
                                                <label class="small fw-bold text-uppercase text-muted">{{ field.label }}</label>
                                                <textarea name="{{ field.key }}" class="form-control bg-light" rows="3">{{ ce_data.data.details_data.get(field.key, '') }}</textarea>
                                            </div>
                                            {% endfor %}
                                            <div class="text-end">
                                                <button type="button" class="btn btn-primary btn-sm btn-save-changes">Save Narrative</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-top">
                                <div class="content-header">Source Condition</div>
                                <div class="p-3 border border-dashed rounded text-muted fst-italic">
                                    {{ cos_content_with_pills | safe }}
                                </div>
                            </div>

                        </div>

                        <!-- 2-5. COLLECTIONS (Loop with Descriptions) -->
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <div class="tab-pane fade h-100 d-flex flex-column" id="view-{{ collection }}-{{ ceId }}">
                            <div class="content-header">{{ collection|upper }}</div>
                            
                            <!-- Contextual Blurb -->
                            <p class="tab-context-description">
                                {% if collection == 'prerequisites' %}
                                    Identify dependencies and critical paths that must be cleared before this node is valid.
                                {% elif collection == 'stakeholders' %}
                                    Map the human network, institutions, and key decision-makers required for success.
                                {% elif collection == 'assumptions' %}
                                    List unvalidated risks and hypotheses that could jeopardize the outcome.
                                {% elif collection == 'resources' %}
                                    Gather files, links, and evidentiary support to verify this condition.
                                {% endif %}
                            </p>

                            <!-- Toolbar -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm px-3 btn-add-item" data-collection="{{ collection }}">
                                        <i class="fas fa-plus me-2"></i> Manual Entry
                                    </button>
                                    <!-- "One-Hit" Generator Button -->
                                    <button class="btn btn-outline-primary btn-sm px-3 btn-speculate-collection" data-collection="{{ collection }}">
                                        <i class="fas fa-magic me-2"></i> Auto-Generate
                                    </button>
                                </div>
                                <div class="input-group input-group-sm" style="width: 250px;">
                                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" class="form-control" placeholder="Filter...">
                                </div>
                            </div>

                            <!-- List -->
                            <div class="flex-grow-1 overflow-y-auto collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}">
                                <!-- JS Renders Cards Here -->
                            </div>

                            <!-- Hidden Form -->
                            <div class="collection-editor mt-3 bg-white border p-4 shadow-sm rounded" id="editor-{{ collection }}-{{ ceId }}" style="display: none;">
                                <div class="d-flex justify-content-between mb-3">
                                    <h6 class="fw-bold text-uppercase">Edit Entry</h6>
                                    <button type="button" class="btn-close btn-cancel-edit"></button>
                                </div>
                                <form class="editor-form" data-collection="{{ collection }}">
                                    {% set schema = node_info.get(collection[:-1] + '_schema', []) %}
                                    {% for field in schema %}
                                    <div class="mb-3">
                                        <label class="form-label small text-muted fw-bold">{{ field.label }}</label>
                                        {% if field.type == 'textarea' %}
                                            <textarea name="{{ field.key }}" class="form-control"></textarea>
                                        {% elif field.type == 'select' %}
                                            <select name="{{ field.key }}" class="form-select">{% for o in field.options %}<option value="{{ o }}">{{ o }}</option>{% endfor %}</select>
                                        {% else %}
                                            <input type="text" name="{{ field.key }}" class="form-control">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-success btn-sm">Save Item</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- CONNECTIONS -->
                        <div class="tab-pane fade" id="view-connections-{{ ceId }}">
                            <div class="content-header">CONNECTIONS</div>
                            <p class="tab-context-description">Visualize and manage dependencies between this node and other elements of the Structured Solution.</p>
                            <div class="text-center p-5 text-muted border border-dashed rounded mt-4">
                                <i class="fas fa-project-diagram fa-3x mb-3 opacity-25"></i>
                                <h5>No active connections.</h5>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- RIGHT: INTELLIGENCE SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column">
                    <div class="p-3 border-bottom bg-white">
                        <h6 class="text-uppercase fw-bold mb-1" style="font-family:'Unica One'; letter-spacing:1px; font-size:1.1rem;">Intelligence</h6>
                        <div class="small text-muted"><i class="fas fa-circle text-success me-1" style="font-size:6px; vertical-align:middle;"></i> ONLINE</div>
                    </div>
                    <div class="p-3 overflow-y-auto flex-grow-1" id="ai-sidebar-content"></div>
                </div>

            </div>
        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    # FIX: Force UUID to String to prevent 'uuid' has no attribute 'split' error
    ce_id_str = str(ce_data.get('id', 'new_ce'))
    
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    
    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=ce_id_str,  # Passing the safe string
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

ğŸ“† models.py:
# models.py
import os
import json
import uuid
from datetime import date
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date, Integer, Float)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()

# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # --- CORE IDENTITY ---
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    
    # --- SCOPE & CONSTRAINTS (The MVP Project Container) ---
    domain = Column(String(100), nullable=True)     # Context for AI (e.g. "Bio-Tech")
    status = Column(String(50), default='Draft')    # Lifecycle (Draft, Active, Paused, Complete)
    owner = Column(String(255), nullable=True)      # The human champion
    target_date = Column(Date, nullable=True)       # The horizon/deadline
    
    # --- METRICS ---
    integrity_score = Column(Integer, default=100)  # 0-100 Health Metric
    completion_percentage = Column(Integer, default=0) # Derived from COS completion
    
    # --- RELATIONSHIPS ---
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'domain': self.domain,
            'status': self.status,
            'owner': self.owner,
            'target_date': self.target_date.isoformat() if self.target_date else None,
            'integrity_score': self.integrity_score,
            'completion_percentage': self.completion_percentage,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    
    # --- STATUS TRACKING ---
    status = Column(String(50), nullable=False, default='Proposed') # Proposed, Active, Complete, Verified
    
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE STRATEGIC PAYLOAD ---
    # Stores the complete state of the Speculation Environment.
    # Initializing with all keys ensures the "Fresh Node" check in JS works reliably.
    data = Column(JsonType, nullable=False, default=lambda: {
        "details_data": {}, 
        "prerequisites": [],
        "stakeholders": [], 
        "assumptions": [],
        "resources": [],
        "connections": []
    })

    def to_dict(self):
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data 
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

ğŸŸ© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER -->
<div class="horizon-wrapper">
  <div class="console-housing">
    <div class="screen-surface" style="min-height: 80vh;">
      
      <!-- 1. HEADER BAR (User Input & Reset) -->
      <div class="bg-white border-bottom px-4 py-4 d-flex justify-content-between align-items-center shadow-sm position-relative" style="z-index: 20;">
        <div class="d-flex align-items-center gap-4">
           <!-- Edit Input Wrapper -->
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1">User Input</div>
               <h2 class="font-brand text-dark m-0 user-input-display" style="font-size: 1.75rem;">"{{ user_input }}"</h2>
           </div>
           
           <!-- Hidden Edit Form -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>

           <button class="btn btn-sm btn-link text-muted edit-user-input" title="Edit Input"><i class="fas fa-pencil-alt"></i></button>
        </div>

        <div class="d-flex gap-3">
             <button type="button" class="btn btn-sm btn-outline-primary font-data fw-bold text-uppercase rounded-pill px-4" id="generate-new-goals">
               <span class="refresh-icon me-2"><i class="fas fa-sync-alt"></i></span> Speculate New
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light text-info font-data fw-bold text-uppercase rounded-pill px-4 border">
               Reset
             </a>
        </div>
      </div>

      <!-- 2. THE GOAL GRID -->
      <div class="goal-grid flex-grow-1 d-flex align-items-center justify-content-center" id="goalCardsContainer">
        
        {% for goal in goals %}
          <!-- Card Wrapper with Staggered Deal Animation -->
          <div class="flip-card {{ 'rejected' if not goal.is_compliant else '' }}" style="animation-delay: {{ loop.index0 * 0.2 }}s;">
            <div class="flip-card-inner" data-delay="{{ 1200 + (loop.index0 * 600) }}">
              
              <!-- BACK (Face Down - Visible First) -->
              <!-- Dynamic Gradient based on Index or Compliance -->
              <div class="flip-card-back" 
                   style="background: {{ 'linear-gradient(135deg, #ffeb3b 0%, #ff9800 40%, #d32f2f 100%)' if not goal.is_compliant else 
                           ('linear-gradient(135deg, #ff7043 0%, #f4511e 100%)' if loop.index0 % 3 == 0 else 
                           'linear-gradient(135deg, #26c6da 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 
                           'linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%)') }};">
                
                <div class="card-pattern-overlay"></div>
                <div class="position-relative z-2 d-flex flex-column align-items-center">
                  <div class="bg-white bg-opacity-25 p-4 rounded-circle border border-2 border-white border-opacity-50 shadow-lg mb-3 backdrop-blur">
                    <i class="{{ goal.icon }} fa-3x text-white drop-shadow"></i>
                  </div>
                  
                  {% if not goal.is_compliant %}
                  <div class="font-data text-white small text-uppercase bg-black bg-opacity-25 px-3 py-1 rounded-pill border border-white border-opacity-25 mt-2">
                    Protocol Violation
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- FRONT (Face Up - Hidden First) -->
              <div class="flip-card-front">
                <!-- Header Plate -->
                <div class="card-header-plate" style="background: {{ 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%)' if not goal.is_compliant else ('linear-gradient(135deg, #ffcc80 0%, #ff7043 100%)' if loop.index0 % 3 == 0 else 'linear-gradient(135deg, #80deea 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 'linear-gradient(135deg, #e1bee7 0%, #ab47bc 100%)') }};">
                    <div class="card-domain-badge">{{ goal.domain | upper }}</div>
                    <div class="card-icon-float">
                        <i class="{{ goal.icon }} fa-2x" style="color: {{ '#ef5350' if not goal.is_compliant else ('#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc') }};"></i>
                    </div>
                </div>

                <div class="card-body">
                  <h3 class="card-title">{{ goal.title }}</h3>
                  <p class="card-desc text-muted small">{{ goal.goal }}</p>
                </div>

                <!-- Action Footer -->
                <div class="card-footer bg-transparent border-0">
                    {% if goal.is_compliant %}
                      <form action="/outcome" method="post">
                        <input type="hidden" name="selected_goal" value="{{ goal.goal }}">
                        <input type="hidden" name="domain" value="{{ goal.domain }}">
                        <input type="hidden" name="domain_icon" value="{{ goal.icon }}">
                        <input type="hidden" name="selected_goal_title" value="{{ goal.title }}">
                        
                        <button type="submit" 
                                class="btn-select-pill w-100" 
                                style="background-color: {{ '#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc' }};">
                          SELECT PROTOCOL
                        </button>
                      </form>
                    {% else %}
                      <button class="btn-select-pill w-100" style="background-color: #ef5350; cursor: not-allowed; opacity: 0.8;">
                          PROTOCOL VIOLATION
                      </button>
                    {% endif %}
                </div>
              </div>

            </div>
          </div>
          {% endfor %}
          
        </div>
      </div>

    </div>
    
    <!-- Footer Status -->
    <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-light border-top">
       <div class="d-flex gap-2">
          <div class="rounded-circle bg-success shadow-sm" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-warning shadow-sm" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-info shadow-sm" style="width: 8px; height: 8px;"></div>
       </div>
       <span class="font-data text-muted small letter-spacing-2">SSPEC HORIZON v2025.17</span>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>
<script>
    // Inline Script for Triggering the Flip Animation
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.flip-card-inner');
        cards.forEach(card => {
            const delay = parseInt(card.dataset.delay) || 1000;
            setTimeout(() => {
                card.closest('.flip-card').classList.add('revealed');
            }, delay);
        });
    });
</script>
{% endblock %}
