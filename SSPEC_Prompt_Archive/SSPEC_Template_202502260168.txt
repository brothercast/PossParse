â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC Build Metadata (v202502260168)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
The changes in version 202502260168 represent a significant architectural and UI/UX overhaul, introducing a sophisticated framework for defining and managing project "System Nodes" and "Complex Entities" (CEs), with a strong emphasis on AI-driven generative capabilities.

Here's a summary of the technical changes:

*   **Major UI/UX Redesign and Modernization (`outcome.html`)**:
    *   Introduced a new, structured layout with "Horizon Wrapper," "Command Deck," and "Data Grid" sections, giving the application a more advanced "console" aesthetic.
    *   Implemented visual enhancements such as an `image-portal` with loading animations for generated SSOL visualizations and decorative design elements (`brand-strip`, `Data Strip Decoration`).
    *   Enhanced display of key SSOL metadata, including `DOMAIN SECTOR`, `PRIME OBJECTIVE`, `SSPEC SOLUTION ID`, and `SSOL TITLE`.
    *   Dynamic injection of server-generated HTML for `horizon_gauge_html` (timeline) and `system_pills_html` (strategic anchors), making the page content more adaptable.
    *   Updated terminology for clarity, specifically restoring "Condition of Satisfaction" for table headers and "ADD CONDITION" for buttons.
    *   Added a new "Export to PDF" button, indicating a new reporting feature.

*   **Introduction of "System Nodes" / "Strategic Anchors" (`system_nodes.py`, `outcome.html`)**:
    *   A new core configuration module, `system_nodes.py`, defines a manifest of 12+ "System Nodes" (e.g., `OPERATOR`, `DIRECTIVE`, `SCALE`, `BUDGET`).
    *   These nodes act as "Strategic Anchors" or "Fixed Future" parameters for an SSOL, each with a `label`, `icon`, `color`, `description`, `examples`, and a critical `prompt_injection` field.
    *   The `prompt_injection` fields are designed to inject specific contextual constraints and characteristics into an underlying AI model, facilitating AI-driven backcasting and generation of project logic.
    *   These nodes are likely rendered visually via `system_pills_html` on the `outcome.html` page, providing a high-level overview of the SSOL's core parameters.

*   **Enhanced Client-Side Conditions of Satisfaction (COS) Management (`cos_table.js`)**:
    *   Implemented full client-side CRUD (Create, Read, Update, Delete) functionality for Conditions of Satisfaction (COS) directly within the `outcome.html` table.
    *   Enabled in-line editing for COS content, status, accountable party, and completion date, complete with "Edit," "Update," and "Cancel" actions for a smoother user experience.
    *   Introduced a dynamic "Add Condition" feature that allows users to add new COS rows to any phase, intelligently handling the creation of the table structure if a phase was previously empty.
    *   Improved visual feedback during user interactions, such as loading spinners and status updates for API calls.
    *   Centralized API error handling through `handleApiResponse` for consistent feedback.

*   **New "Complex Entity" (CE) Dynamic Modal System (`system_templates.py`, `cos_table.js`, `ce_cards.js` - implied as imported)**:
    *   Clicking on "CE Pills" (embedded within COS content) now launches a highly dynamic and feature-rich modal (defined by `BASE_MODAL_TEMPLATE` in `system_templates.py`).
    *   This modal serves as a dedicated "application" interface for managing Complex Entities, featuring:
        *   A customizable header displaying the CE type, ID, associated phase, and a "Toggle Intelligence" button for the AI engine.
        *   A "Readiness Bar" to visualize "Analysis Depth" or progress within the CE.
        *   Tabbed navigation (e.g., `OVERVIEW`, `NARRATIVE`, `PREREQUISITES`, `STAKEHOLDERS`, `ASSUMPTIONS`, `RESOURCES`, `CONNECTIONS`) for organizing CE data.
        *   Dynamic form generation for narrative details and collection items, based on schemas defined in `node_info`.
        *   "Collection" management with "Manual" and "Auto-Gen" (AI-driven) options, including a hidden editor for item details.
        *   An "AI Sidebar" and "Enhance" buttons, indicating deep integration with an AI speculation engine for content generation and contextual insights.
        *   A dynamic save button tailored to the specific CE type.
    *   The modal's appearance is dynamically themed based on the associated phase's index, leveraging CSS variables (`--phase-color`).

*   **Deep AI Integration for Project Planning and Content Generation**:
    *   The `prompt_injection` fields in `system_nodes.py` directly enable an underlying AI model to understand and apply specific project constraints and characteristics during its generative processes.
    *   Features like "Enhance" buttons for narrative fields, "Auto-Gen" for collection items, and the dedicated "AI Sidebar" within the CE modal, indicate a robust AI-assisted project planning capability.
    *   The `ai_generated_data` passed to the CE modal suggests that the AI provides initial contextual descriptions and insights.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SSPEC PossPath Essential Files
Date: 2025-11-27
Version: 202502260168
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸŒ Structured Speculation Possibility Pathfinder ("SSPEC PossPath")
Essential app files:
â¬œ speculate.py:
# speculate.py
import re
import os
import html
import json
import uuid
from uuid import UUID
import logging
from bs4 import BeautifulSoup
from flask import current_app
from ce_nodes import NODES, get_valid_node_types
from ai_service import generate_chat_response_with_node_types
from datetime import date, timedelta

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- Helper function to render a CE pill ---
def _render_ce_pill_html(ce_id: str, ce_type: str, ce_text: str) -> str:
    """Helper function to generate the standard HTML for a CE pill."""
    node_info = NODES.get(ce_type, NODES['Default'])
    node_color = node_info.get('color', '#6c757d')
    node_icon = node_info.get('icon', 'fa-solid fa-question-circle')
    
    return (
        f'<span class="ce-pill" data-ce-id="{ce_id}" data-ce-type="{ce_type}" style="--node-color: {node_color};">'
        f'<span class="ce-pill-icon"><i class="{node_icon}"></i></span>'
        f'<span class="ce-pill-text">{html.escape(ce_text)}</span>'
        f'</span>'
    )

# --- AI Analysis ---

async def analyze_cos(cos_content: str, cos_id: str = None) -> dict:
    """
    Analyzes COS content to identify CEs. Returns structured JSON for creation/updating.
    """
    node_types_str = ', '.join(get_valid_node_types())
    prompt = (
        f"Analyze the following Condition of Satisfaction (COS) text: '{cos_content}'. "
        "Identify ALL distinct Conditional Elements (CEs) within this text. "
        f"Valid NodeTypes: {node_types_str}. "
        "Return JSON with keys 'analyzed_cos_text' (original text with <ce type='Type'>Title</ce> tags) "
        "and 'identified_ces' (array of {text, type})."
    )
    messages = [{"role": "user", "content": prompt}]
    try:
        response_text = await generate_chat_response_with_node_types(messages, role='COS Analysis', task='Analyze COS')
        # Parse logic
        match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", response_text, re.DOTALL)
        clean_text = match.group(1).strip() if match else response_text.strip()
        
        response_json = json.loads(clean_text)
        return {
            'content_with_tags': response_json.get("analyzed_cos_text", cos_content),
            'identified_ces': response_json.get("identified_ces", [])
        }
    except Exception as e:
        current_app.logger.error(f"Error in analyze_cos: {e}", exc_info=True)
        # Fallback: return original text, no CEs detected
        return {'content_with_tags': html.escape(cos_content), 'identified_ces': []}

# --- SSOL Operations ---

def create_ssol(USE_DATABASE: bool, title: str, description: str, domain: str = None) -> str:
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app

    # MVP Rule: Set a default "Horizon" of 1 year from creation
    default_target_date = date.today() + timedelta(days=365)

    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            new_ssol_uuid = uuid.uuid4()
            
            ssol = SSOL(
                id=new_ssol_uuid, 
                title=title, 
                description=description,
                domain=domain,
                status='Active', 
                target_date=default_target_date,
                integrity_score=100,
                completion_percentage=0
            )
            
            session.add(ssol)
            session.commit()
            ssol_id_to_return = str(new_ssol_uuid)
            session.close()
            return ssol_id_to_return
    else:
        ssol_id = str(uuid.uuid4())
        ssol_store[ssol_id] = {
            'id': ssol_id, 
            'title': title, 
            'description': description, 
            'domain': domain,
            'status': 'Active',
            'target_date': default_target_date.isoformat(),
            'integrity_score': 100,
            'completion_percentage': 0,
            'phases': {}
        }
        return ssol_id

def get_ssol_by_id(USE_DATABASE: bool, ssol_id: UUID):
    from models import SSOL, get_engine_and_session
    from store import ssol_store
    from app import app
    if USE_DATABASE:
        if not isinstance(ssol_id, UUID): ssol_id = UUID(str(ssol_id))
        with app.app_context():
            engine, session = get_engine_and_session()
            ssol = session.query(SSOL).get(ssol_id)
            session.close()
            return ssol
    else:
        return ssol_store.get(str(ssol_id))

# --- COS Operations ---

async def create_cos(USE_DATABASE: bool, ssol_id: UUID, content: str, status: str, accountable_party: str = None, completion_date=None) -> str:
    from models import COS, CE, get_engine_and_session
    from store import ce_store, cos_store
    from app import app

    new_cos_uuid = uuid.uuid4()
    cos_id_str = str(new_cos_uuid)

    # Safety Check: Content must be string
    if isinstance(content, dict):
        content = content.get('text') or content.get('content') or json.dumps(content)
    elif not isinstance(content, str):
        content = str(content)

    try:
        # 1. Parse Tags
        soup = BeautifulSoup(content, 'html.parser')
        ce_tags = soup.find_all('ce')
        
        new_ce_instances = []
        
        # 2. Create CEs from tags
        for tag in ce_tags:
            ce_text = tag.string
            ce_type = tag.get('type')
            if not ce_text or not ce_type: continue

            new_ce_uuid = uuid.uuid4()
            ce_record = {
                'id': new_ce_uuid,
                'node_type': ce_type,
                'cos_id': new_cos_uuid,
                'data': {"details_data": {}, "prerequisites": [], "stakeholders": [], "assumptions": [], "resources": [], "connections": []}
            }
            new_ce_instances.append(ce_record)
            
            # Replace tag with Pill HTML
            pill_html = _render_ce_pill_html(str(new_ce_uuid), ce_type, ce_text)
            tag.replace_with(BeautifulSoup(pill_html, 'html.parser'))

        content_with_pills = str(soup)

        # 3. Persist
        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos_instance = COS(
                    id=new_cos_uuid, 
                    content=content_with_pills, 
                    status=status, 
                    ssol_id=ssol_id,
                    accountable_party=accountable_party, 
                    completion_date=completion_date
                )
                session.add(cos_instance)
                
                for ce_rec in new_ce_instances:
                    ce_instance = CE(
                        id=ce_rec['id'], 
                        node_type=ce_rec['node_type'], 
                        cos_id=new_cos_uuid, 
                        data=ce_rec['data']
                    )
                    session.add(ce_instance)
                
                session.commit()
                session.close()
        else:
            cos_store[cos_id_str] = {'id': cos_id_str, 'content': content_with_pills, 'status': status, 'ssol_id': str(ssol_id)}
            for ce_rec in new_ce_instances:
                ce_store[str(ce_rec['id'])] = ce_rec
        
        return cos_id_str

    except Exception as e:
        current_app.logger.error(f"Error creating COS: {e}", exc_info=True)
        raise

# --- THIS WAS THE MISSING FUNCTION ---
async def update_cos_by_id(USE_DATABASE: bool, cos_id: UUID, updated_data: dict) -> dict:
    from models import COS, CE, get_engine_and_session
    from store import cos_store, ce_store
    from app import app

    new_content = updated_data.get('content')
    
    try:
        new_ce_instances = []
        
        # If content changed, re-analyze and generate pills/CEs
        if new_content is not None:
            # Safety Check again
            if isinstance(new_content, dict):
                new_content = new_content.get('text') or json.dumps(new_content)
            elif not isinstance(new_content, str):
                new_content = str(new_content)
                    
            analysis = await analyze_cos(new_content, str(cos_id))
            soup = BeautifulSoup(analysis['content_with_tags'], 'html.parser')
            ce_tags = soup.find_all('ce')
            
            for tag in ce_tags:
                c_txt, c_type = tag.string, tag.get('type')
                new_id = uuid.uuid4()
                new_ce_instances.append({
                    'id': new_id, 
                    'node_type': c_type, 
                    'data': {"details_data": {}, "resources": [], "prerequisites": [], "stakeholders": [], "assumptions": [], "connections": []}
                })
                pill = _render_ce_pill_html(str(new_id), c_type, c_txt)
                tag.replace_with(BeautifulSoup(pill, 'html.parser'))
            
            updated_data['content'] = str(soup)

        if USE_DATABASE:
            with app.app_context():
                engine, session = get_engine_and_session()
                cos = session.query(COS).get(cos_id)
                if not cos: 
                    session.close()
                    return {'success': False, 'message': 'COS not found', 'status_code': 404}
                
                for k, v in updated_data.items():
                    if hasattr(cos, k) and k not in ['id', 'ssol_id']: 
                        setattr(cos, k, v)
                
                # If content changed, flush old CEs and add new ones
                if new_content is not None:
                    session.query(CE).filter_by(cos_id=cos_id).delete()
                    for nc in new_ce_instances:
                        session.add(CE(id=nc['id'], node_type=nc['node_type'], cos_id=cos_id, data=nc['data']))
                
                session.commit()
                cos_dict = cos.to_dict()
                session.close()
                return {'success': True, 'cos': cos_dict}
        
        return {'success': False, 'message': 'DB Required', 'status_code': 500}

    except Exception as e:
        current_app.logger.error(f"Error updating COS {cos_id}: {e}", exc_info=True)
        return {'success': False, 'message': str(e), 'status_code': 500}

def get_cos_by_id(USE_DATABASE: bool, cos_id: UUID):
    from models import COS, get_engine_and_session
    from store import cos_store
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            cos = session.query(COS).get(cos_id)
            
            # Convert to dict inside session to avoid DetachedInstanceError
            if cos:
                data = cos.to_dict()
                session.close()
                return data
            
            session.close()
            return None
    return cos_store.get(str(cos_id))

def delete_cos_by_id(USE_DATABASE: bool, cos_id: UUID) -> bool:
    from models import COS, CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(cos_id=cos_id).delete()
            cos = session.query(COS).get(cos_id)
            if cos:
                session.delete(cos)
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

# --- CE Operations ---

def get_ce_by_id(USE_DATABASE: bool, ce_id_param):
    from models import CE, get_engine_and_session
    from store import ce_store
    from app import app
    
    ce_id_uuid = ce_id_param if isinstance(ce_id_param, UUID) else UUID(str(ce_id_param))
    
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id_uuid)
            result = ce.to_dict() if ce else None
            session.close()
            return result
    return ce_store.get(str(ce_id_uuid))

def update_ce_by_id(USE_DATABASE: bool, ce_id: UUID, ce_data: dict) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            ce = session.query(CE).get(ce_id)
            if ce:
                ce.data = ce_data
                session.commit()
                session.close()
                return True
            session.close()
            return False
    return False

def create_ce(USE_DATABASE: bool, node_type: str, cos_id: UUID, data: dict) -> str:
    from models import CE, get_engine_and_session
    from app import app
    new_id = uuid.uuid4()
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.add(CE(id=new_id, node_type=node_type, cos_id=cos_id, data=data))
            session.commit()
            session.close()
    return str(new_id)

def delete_ce_by_id(USE_DATABASE: bool, ce_id: UUID) -> bool:
    from models import CE, get_engine_and_session
    from app import app
    if USE_DATABASE:
        with app.app_context():
            engine, session = get_engine_and_session()
            session.query(CE).filter_by(id=ce_id).delete()
            session.commit()
            session.close()
            return True
    return False

ðŸŽ¨ styles.css:
/* styles.css - SSPEC "Horizon Fusion" v2025.25 (DEFINITIVE MASTER) */

/* ================================================== */
/* ==============  1. FONTS & VARIABLES  ============ */
/* ================================================== */
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Manrope:wght@400;500;600;700&family=Antonio:wght@700&family=Mr+Dafoe&family=Unica+One&display=swap');

:root {
  /* --- Horizon Palette --- */
  --bg-warm: #e3f2fd;
  --surface-white: #ffffff;
  --surface-screen: #f8fafc;
  
  /* Brand Colors */
  --aviation-teal: #00bcd4;
  --deep-space-blue: #2c3e50;
  --retro-coral: #ff7043;
  
  /* Functional Colors */
  --danger: #ef5350;
  --success: #66bb6a;
  --warning: #ffca28;
  --text-dark: #1e293b;
  --text-muted: #64748b;

  /* Phase Colors (Horizon Standard) */
  --phase-0: #ff7043; /* Discovery - Coral */
  --phase-1: #26c6da; /* Engagement - Cyan */
  --phase-2: #ab47bc; /* Action - Purple */
  --phase-3: #ffa726; /* Completion - Amber */
  --phase-4: #66bd0e; /* Legacy - Green */
  
  /* Typography Tokens */
  --font-brand: 'Righteous', cursive; 
  --font-retro: 'Unica One', cursive;
  --font-script: 'Mr Dafoe', cursive;
  --font-data: 'Antonio', sans-serif; 
  --font-body: 'Manrope', sans-serif;
}

body {
  font-family: var(--font-body);
  /* Background handled by Section 3 (Aurora) */
  background-color: transparent;
  color: var(--text-dark);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Typography Overrides */
h1.display-script { font-family: var(--font-script); font-weight: 400; }
h1, h2, h3, .navbar-brand { font-family: var(--font-brand); letter-spacing: 1px; }

/* Data / UI Fonts */
h4, h5, h6, .font-data, .ce-title, .card-domain-badge, .btn, .nav-link { 
    font-family: var(--font-data); letter-spacing: 0.5px; text-transform: uppercase; 
}
.font-retro { font-family: var(--font-retro); letter-spacing: 1px; text-transform: uppercase; }
.font-body, .card-desc { font-family: var(--font-body); }

/* ================================================== */
/* ==============  2. NAVIGATION  =================== */
/* ================================================== */
nav.navbar {
    background: transparent;
    padding-top: 1.5rem; padding-bottom: 1.5rem;
    z-index: 10;
}
.navbar-brand { text-decoration: none; }

/* ================================================== */
/* ==============  3. BACKGROUND ATMOSPHERE  ======== */
/* ================================================== */
.aurora-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; overflow: hidden;
    background-color: #f8fafc; /* Lightest slate base */
    transition: all 1s ease-in-out;
}

/* Texture */
.aurora-noise {
    position: absolute; inset: 0; z-index: 2; opacity: 0.06;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
}

/* Living Blobs */
.aurora-blob {
    position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5;
    mix-blend-mode: multiply; animation-timing-function: ease-in-out; 
    animation-iteration-count: infinite; animation-direction: alternate;
}

.blob-1 { background-color: var(--phase-0); top: -10%; left: -10%; width: 70vw; height: 70vw; animation: float1 25s infinite; }
.blob-2 { background-color: var(--phase-1); top: -10%; right: -10%; width: 60vw; height: 60vw; animation: float2 28s infinite; }
.blob-3 { background-color: var(--phase-2); bottom: -20%; left: 20%; width: 70vw; height: 70vw; animation: float3 32s infinite; }
.blob-4 { background-color: var(--phase-3); bottom: -10%; right: -10%; width: 50vw; height: 50vw; animation: float1 22s infinite; opacity: 0.3; }
.blob-5 { background-color: var(--phase-4); top: 40%; left: 40%; width: 40vw; height: 40vw; animation: float3 35s infinite; opacity: 0.3; }

@keyframes float1 { from { transform: translate(0, 0) scale(1); } to { transform: translate(40px, 50px) scale(1.1); } }
@keyframes float2 { from { transform: translate(0, 0) scale(1); } to { transform: translate(-50px, 30px) scale(1.2); } }
@keyframes float3 { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(30px, -40px) rotate(10deg); } }

/* Outcome Mode: Dimmed */
body.state-outcome .aurora-background { opacity: 0.2; filter: grayscale(80%); }

/* ================================================== */
/* ==============  4. THE CONSOLE HOUSING =========== */
/* ================================================== */
.horizon-wrapper {
  padding: 2rem 1rem; 
  min-height: 85vh;
  display: flex; 
  justify-content: center;
}

.console-housing {
  background-color: rgba(255,255,255,0.9);
  backdrop-filter: blur(24px);
  border-radius: 32px;
  box-shadow: 0 30px 60px -12px rgba(0,96,100,0.25);
  padding: 16px;
  border: 4px solid #ffffff;
  width: 100%;
  /* RESTORED WIDTH: Tightened from 1800px back to a focused console width */
  max-width: 1320px; 
  position: relative;
}
  
/* The Inner Glowing Rim */
.console-housing::after {
  content: ''; position: absolute; inset: 0; border-radius: 24px;
  border: 2px solid rgba(0,188,212,0.25); /* Aviation Teal Glow */
  pointer-events: none; z-index: 100;
  margin: -2px; /* Offset to hug the white border */
}

.screen-surface {
  background: var(--surface-screen);
  border-radius: 16px;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.04);
  border: 1px solid #e2e8f0;
  overflow: hidden; 
  position: relative;
  /* min-height removed so it fits content snugly if needed */
  display: flex; 
  flex-direction: column;
}

/* The rainbow strip at the top */
.brand-strip {
  background: linear-gradient(90deg, var(--aviation-teal) 0%, #26c6da 50%, var(--retro-coral) 100%);
  height: 8px; width: 100%; position: absolute; top: 0; left: 0; z-index: 5;
}

/* ================================================== */
/* ===========  5. INPUT STAGE (The Bezel) ========== */
/* ================================================== */
.input-stage {
  flex-grow: 1;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  /* GRID APPLIED HERE ONLY (Inside the machine) */
  background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
  background-size: 30px 30px;
  /* Vignette */
  background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.8) 100%),
              radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
  background-size: 100% 100%, 30px 30px;
  border-radius: 16px; /* Match screen surface inner radius */
}

.input-stage-wrapper {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 80vh; width: 100%;
}

.input-bezel {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(25px);
    padding: 5rem; 
    border-radius: 40px;
    /* RESTORED: The Glassy Double Bezel */
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 
        0 30px 70px -15px rgba(0,0,0,0.15), /* Deep Drop */
        0 0 0 8px rgba(255, 255, 255, 0.3), /* Outer Glass Ring */
        inset 0 0 20px rgba(255,255,255,0.5); /* Inner Glow */
    max-width: 1100px; width: 90%;
    text-align: center;
    animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    position: relative;
}
@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

.huge-input {
    border: none; border-bottom: 3px solid #cbd5e1;
    font-family: var(--font-body); font-size: 2rem; font-weight: 300;
    color: var(--text-dark);
    width: 100%; text-align: center; padding: 1.5rem;
    background: transparent; outline: none; transition: all 0.3s;
}
.huge-input:focus { border-bottom-color: var(--aviation-teal); background: rgba(255,255,255,0.5); }
.huge-input::placeholder { color: #94a3b8; font-style: italic; }

.btn-launch {
    background: linear-gradient(135deg, var(--retro-coral) 0%, #f4511e 100%);
    color: white; font-family: var(--font-data); font-size: 1.2rem; letter-spacing: 2px;
    padding: 1rem 3.5rem; border-radius: 50px; border: none;
    box-shadow: 0 10px 20px rgba(244, 81, 30, 0.3); transition: all 0.2s;
    margin-top: 2rem;
}
.btn-launch:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(244, 81, 30, 0.4); }


/* ================================================== */
/* ======  6. GOAL SELECTION (Monolith Flip) ======== */
/* ================================================== */
.goal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap: 3rem; 
    padding: 4rem; 
    perspective: 2500px;
    justify-content: center;
    /* RESTORED: The Dot Grid behind the cards */
    background-color: #f8fafc;
    background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 24px 24px;
    /* Inner Shadow to create depth for the grid area */
    box-shadow: inset 0 0 40px rgba(0,0,0,0.03);
}

.flip-card {
    height: 520px; width: 100%; cursor: pointer; position: relative;
    opacity: 0; 
    animation: slide-up-deal 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
@keyframes slide-up-deal { from { opacity: 0; transform: translateY(60px); } to { opacity: 1; transform: translateY(0); } }

.flip-card-inner {
    position: relative; width: 100%; height: 100%;
    /* The Heavy Monolith Physics Easing */
    transition: transform 2.2s cubic-bezier(0.19, 1, 0.22, 1);
    transform-style: preserve-3d; 
    transform-origin: center center;
    /* START STATE: 0 degrees on the DIAGONAL Axis (X=1, Y=1, Z=0) */
    transform: rotate3d(1, 1, 0, 0deg);
}

/* THE TRIGGER: Rotate 180 degrees on the Diagonal Axis */
.flip-card.revealed .flip-card-inner { 
    transform: rotate3d(1, 1, 0, 180deg); 
}

.flip-card-front, .flip-card-back {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden; border-radius: 24px;
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
    overflow: hidden; background: white;
    -webkit-font-smoothing: antialiased;
}

/* --- BACK (Starts Visible, Face Down relative to flip axis) --- */
.flip-card-back { 
    z-index: 2; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    border: 4px solid white;
    /* No rotation needed, it starts facing the user */
    transform: rotate3d(0,0,0,0); 
}

/* --- FRONT (Starts Hidden, Pre-Rotated Diagonally) --- */
.flip-card-front { 
    z-index: 1; 
    /* Pre-rotate 180deg on the SAME 1,1,0 axis so it matches up when flipped */
    transform: rotate3d(1, 1, 0, 180deg); 
    display: flex; flex-direction: column; justify-content: space-between; padding: 0;
    border: 1px solid #e2e8f0;
}

/* Card Content Styling */
.card-header-plate { height: 140px; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; }

.card-domain-badge {
    position: absolute; top: 20px;
    background: rgba(255,255,255,0.3); backdrop-filter: blur(4px);
    padding: 6px 16px; border-radius: 20px; color: white;
    font-family: var(--font-data); font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.5);
}

.card-icon-float {
    position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%);
    width: 70px; height: 70px; background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 4px solid white;
}

.card-body { padding: 50px 30px 20px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
.card-title { font-size: 1.5rem; color: #263238; margin-bottom: 0.75rem; line-height: 1.2; }
.card-footer { padding: 0 30px 30px; }

.btn-select-pill {
    width: 100%; padding: 16px 0; border-radius: 50px; border: none;
    font-family: var(--font-data); font-size: 0.9rem; letter-spacing: 2px;
    color: white; cursor: pointer; transition: all 0.2s;
}
.btn-select-pill:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); }

/* Rejected State */
.flip-card.rejected .card-body { background: #fff1f0; }
.flip-card.rejected .flip-card-front { border-color: #ffcdd2; }
.flip-card.rejected .btn-select-pill { background: var(--danger) !important; cursor: not-allowed; opacity: 0.8; }

/* Pattern Overlay */
.card-pattern-overlay {
  position: absolute; inset: 0;
  background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
  background-size: 24px 24px; pointer-events: none;
}

/* ================================================== */
/* ==============  7. OUTCOME DASHBOARD  ============ */
/* ================================================== */
.header-sidebar {
    background-color: #f8fafc; border-right: 1px solid #e2e8f0;
    padding: 2.5rem; display: flex; flex-direction: column; align-items: center; text-align: center;
}

.image-portal {
    width: 100%; aspect-ratio: 1/1; border-radius: 20px;
    background: white; border: 4px solid white;
    box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
    position: relative; overflow: hidden; margin-bottom: 1.5rem;
}
/* Stacking fix for Image Fade */
.image-portal img {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; transition: opacity 0.8s ease-in-out;
}

.domain-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: white; border: 1px solid #cbd5e1; border-radius: 50px;
    padding: 8px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Accordion & Tables */
.module-header {
    padding: 1.2rem 2rem; display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; border-left: 6px solid transparent; background-color: #fff;
    margin-bottom: 1px; border-radius: 6px; transition: all 0.2s;
}
.module-header:hover { transform: translateX(4px); }
.phase-icon {
    width: 32px; height: 32px; background: rgba(255,255,255,0.25); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-brand); color: white; backdrop-filter: blur(2px);
}

.retro-table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
.retro-table thead th {
    background-color: #f8fafc; font-family: var(--font-data); 
    letter-spacing: 1px; padding: 12px 20px; border-bottom: 2px solid #e2e8f0;
}
.retro-table td { padding: 16px 20px; border-bottom: 1px dashed #e2e8f0; vertical-align: middle; }

.phase-title {
    /* NEW: Using Righteous font */
    font-family: var(--font-brand); 
    font-size: 1.2rem; 
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* Legend Items (Clickable) */
.phase-legend-item {
    cursor: pointer;
    transition: all 0.2s;
    padding: 4px 8px;
    border-radius: 4px;
}
.phase-legend-item:hover {
    background-color: rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

/* CE Pills */
.ce-pill, .ce-capsule {
  display: inline-flex; align-items: center; padding: 3px 10px 3px 4px; margin: 0 3px;
  border-radius: 50px; 
  color: white; background-color: var(--node-color, #78909c);
  border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  cursor: pointer; transition: transform 0.1s;
  font-family: var(--font-body); font-size: 0.75rem; font-weight: 700;
}
.ce-pill:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

/* The Icon Circle: White BG, Colored Icon */
.ce-pill-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 18px; height: 18px; border-radius: 50%; margin-right: 6px;
  background: white; color: var(--node-color, #78909c);
}
.status-block {
  font-family: var(--font-data); font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  padding: 6px 12px; border-radius: 8px; display: inline-block; min-width: 80px; text-align: center; color: white;
}

/* ================================================== */
/* ==============  8. SPECULATION MODAL  ============ */
/* ================================================== */

/* --- A. The App Shell (Horizon Layout) --- */
.ce-app-shell {
    height: 90vh; /* Fixed viewport height */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-color: #ffffff;
    border-radius: 16px; /* Modern Radius */
    box-shadow: 
        0 30px 80px -20px rgba(0,0,0,0.4),
        0 0 0 1px rgba(0,0,0,0.05);
    border: 4px solid #ffffff; /* White bezel */
}

/* --- B. The System Identity Header --- */
.ce-modal-header {
    /* Dynamic Phase Color + Texture */
    background: linear-gradient(135deg, var(--phase-color), rgba(0,0,0,0.15) 100%);
    color: white;
    flex-shrink: 0;
    padding: 1rem 2rem;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    overflow: hidden; /* Clips the ghost icon */
    z-index: 20;
}

/* Icon Box */
.node-icon-box {
    width: 56px; height: 56px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    font-size: 1.8rem; color: #fff;
    flex-shrink: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    margin-right: 1.2rem;
}

/* Text Stack */
.header-text-block {
    display: flex; flex-direction: column; justify-content: center;
}
.ce-modal-header .ce-title {
    font-family: var(--font-brand);
    font-weight: 500;
    font-size: 2rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0;
    line-height: 1;
    text-shadow: 0 2px 5px rgba(0,0,0,0.15);
}
.ce-header-metadata {
    font-family: var(--font-data);
    font-size: 0.8rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    opacity: 0.9;
    margin-top: 4px;
}

/* Giant Ghost Icon (Background) */
.header-ghost-icon {
    position: absolute;
    right: 15%; 
    top: 50%;
    transform: translateY(-50%) rotate(-15deg);
    font-size: 12rem;
    color: white;
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
}

/* Header Controls */
.btn-glass {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    border-radius: 50px;
    padding: 8px 18px;
    font-family: var(--font-data);
    font-size: 0.9rem;
    letter-spacing: 1px;
    transition: all 0.2s;
    backdrop-filter: blur(4px);
}
.btn-glass:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(255,255,255,0.1);
}
.btn-close-custom {
    background: none; border: none;
    color: rgba(255,255,255,0.7);
    font-size: 1.5rem; transition: color 0.2s;
}
.btn-close-custom:hover { color: white; }


/* --- C. Readiness Bar --- */
.progress-bar-container {
    background: white;
    padding: 0;
    height: 6px; 
    flex-shrink: 0;
    border-bottom: 1px solid #e2e8f0;
    z-index: 19;
}
.progress-bar-container .progress-bar { 
    background-color: var(--phase-color);
    box-shadow: 0 2px 10px var(--phase-color);
}


/* --- D. Workspace Layout (Split View) --- */
.ce-workspace-body {
    flex-grow: 1;
    display: flex;
    flex-direction: row;
    overflow: hidden;
}

.ce-main-column {
    flex: 1;
    display: flex; flex-direction: column;
    min-width: 0;
    background-color: var(--surface-screen);
    position: relative;
}

/* Sidebar */
.ai-sidebar {
    width: 340px;
    flex-shrink: 0;
    border-left: 1px solid #e2e8f0;
    background-color: #ffffff;
    display: flex; flex-direction: column;
    z-index: 15;
    box-shadow: -5px 0 30px rgba(0,0,0,0.03);
}


/* --- E. Tab Navigation --- */
.ce-nav-tabs {
    background: white;
    padding: 0 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    flex-shrink: 0;
    display: flex; gap: 1rem;
}
.ce-nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-data);
    font-size: 1rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    padding: 1rem 0.4rem;
    transition: all 0.2s;
}
.ce-nav-tabs .nav-link:hover { color: var(--text-dark); }
.ce-nav-tabs .nav-link.active {
    color: var(--phase-color);
    background: transparent;
    border-bottom-color: var(--phase-color);
}
/* Tab Counts */
.count-badge { font-family: var(--font-body); font-weight: 800; vertical-align: top; font-size: 0.65em; }


/* --- F. Content Area & Grids --- */
.ce-app-content {
    flex-grow: 1; overflow-y: auto; padding: 0; position: relative;
}

/* The Lithographic Grid Pattern (High Density Vibe) */
.bg-technical-grid {
    background-color: var(--surface-screen);
    background-image: 
        radial-gradient(#cbd5e1 1.5px, transparent 1.5px),
        radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.02);
}


/* --- G. THE DASHBOARD (Hero & Metrics) --- */

/* 1. System Hero Card (Strategic Context) */
.system-hero-card {
    background-color: var(--phase-color);
    background-image: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.1) 100%);
    border-radius: 16px;
    padding: 2rem;
    position: relative;
    overflow: hidden;
    color: white;
    box-shadow: 0 15px 40px -10px rgba(0,0,0,0.2);
    min-height: 220px;
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; flex-direction: column; justify-content: space-between;
}

/* The Massive Ghost Icon */
.system-hero-card .hero-ghost-icon {
    position: absolute;
    right: -10px; bottom: -30px;
    font-size: 14rem;
    color: white; opacity: 0.1;
    transform: rotate(-10deg);
    pointer-events: none;
    z-index: 1;
}

/* Typography inside Hero */
.hero-label {
    font-family: var(--font-data); font-size: 0.8rem; letter-spacing: 2px;
    text-transform: uppercase; opacity: 0.9; margin-bottom: 0.5rem;
    position: relative; z-index: 2;
}

/* 2. Dashboard Status Panel (Compact) */
.dashboard-status-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-left: 5px solid var(--phase-color);
    border-radius: 12px;
    position: relative; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}
.status-card-value {
    font-family: var(--font-brand); font-size: 2.5rem; 
    color: var(--text-dark); line-height: 1.1; margin-bottom: 5px;
}
/* Scan Line (For "Active/Scanning" State) */
.scan-line {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, transparent 0%, rgba(var(--phase-color), 0.15) 50%, transparent 100%);
    opacity: 0; pointer-events: none; z-index: 0;
}
.system-hero-card.scanning .scan-line, .dashboard-status-card.scanning .scan-line { 
    opacity: 1; animation: scanDown 2.5s infinite ease-in-out; 
}
@keyframes scanDown { 0% { transform: translateY(-150%); } 100% { transform: translateY(150%); } }

/* 3. Metric Tiles (Grid) */
.metric-tile {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px;
    text-align: center; height: 100%; display: flex; flex-direction: column;
    justify-content: center; padding: 1.2rem;
    transition: all 0.2s ease;
}
.metric-tile:hover {
    transform: translateY(-2px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.08); border-color: #cbd5e1;
}
.metric-number {
    font-family: var(--font-brand); font-size: 2rem; color: var(--text-dark); line-height: 1.1;
}
.metric-label {
    font-family: var(--font-data); font-size: 0.7rem; letter-spacing: 1px;
    color: var(--text-muted); text-transform: uppercase; margin-top: 4px;
}

/* --- H. Collection Cards (Vertical Strips) --- */
.collection-container { padding: 1.5rem; }

.collection-card-modern {
    background: white; border: 1px solid #e2e8f0; border-radius: 10px;
    padding: 1.2rem; margin-bottom: 0.8rem;
    display: flex; align-items: center;
    position: relative; overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
/* The Color Strip */
.collection-card-modern::before {
    content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
    background-color: var(--phase-color); transition: width 0.2s;
}
.collection-card-modern:hover { transform: translateX(4px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
.collection-card-modern:hover::before { width: 8px; }

/* AI Proposed Variant */
.collection-card-modern.border-dashed {
    border-style: dashed; border-color: #6366f1; background-color: #f8faff;
}
.collection-card-modern.border-dashed::before { background-color: #6366f1; }

.card-title-modern { font-family: var(--font-data); font-size: 1.1rem; color: var(--text-dark); margin-bottom: 2px; }
.card-subtitle-modern { font-family: var(--font-body); font-size: 0.85rem; color: var(--text-muted); }


/* --- I. The Intelligence Sidebar --- */
/* Sidebar Header Gradient */
.sidebar-persona-header {
    color: white; padding: 1rem; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Default */
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: background 0.3s;
}
/* Context Gradients */
.persona-research { background: linear-gradient(135deg, #00b09b, #96c93d); }
.persona-risk { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
.persona-stakeholder { background: linear-gradient(135deg, #ffb347, #ffcc33); }
.persona-advocacy { background: linear-gradient(135deg, #f12711, #f5af19); }
.persona-default { background: linear-gradient(135deg, #667eea, #764ba2); }

#ai-sidebar-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

.btn-gradient-purple {
    background: linear-gradient(45deg, #6f42c1, #3b82f6); border: none; color: white;
    font-family: var(--font-data); letter-spacing: 1px;
}
.btn-gradient-purple:hover { color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3); }

/* --- J. Footer --- */
.ce-modal-footer { 
    background-color: #ffffff; border-top: 1px solid #e2e8f0; 
    flex-shrink: 0; padding: 0.8rem 1.5rem;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.02);
}

/* --- K. Smart Widgets --- */
/* Range Slider */
.ce-range-input { 
    -webkit-appearance: none; appearance: none; width: 100%; height: 6px; 
    background: #e2e8f0; border-radius: 10px; outline: none;
}
.ce-range-input::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 18px; height: 18px; 
    border-radius: 50%; background: var(--phase-color, #6366f1); border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s ease;
}
.ce-range-input::-webkit-slider-thumb:hover { transform: scale(1.2); }

/* Toggle Switch */
.ce-toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.ce-toggle-slider {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1; border-radius: 34px; transition: .4s; cursor: pointer;
}
.ce-toggle-slider:before {
    content: ""; position: absolute; height: 18px; width: 18px;
    left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s;
}
input:checked + .ce-toggle-slider { background-color: var(--phase-color, #10b981); }
input:checked + .ce-toggle-slider:before { transform: translateX(20px); }

/* ================================================== */
/* ==============  9. LOADING SPINNER  ============== */
/* ================================================== */
.loading-spinner-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(15, 23, 42, 0.4);
    display: flex; justify-content: center; align-items: center; z-index: 9999;
}

.spinner-box {
    min-width: 450px; padding: 1.5rem 2rem;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #cbd5e1; border-left: 6px solid var(--aviation-teal);
    border-radius: 4px;
    box-shadow: 0 20px 40px -5px rgba(0,0,0,0.2);
    display: flex; align-items: center; gap: 1.5rem;
    position: relative; overflow: hidden;
}

.spinner-icon { font-size: 2rem; color: var(--aviation-teal); animation: spin 2s linear infinite; }
.spinner-title { font-family: var(--font-data); font-size: 1.2rem; letter-spacing: 1px; color: #1e293b; }
.spinner-text { font-family: var(--font-body); font-size: 0.9rem; color: #64748b; }

.spinner-box::after {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    transform: translateX(-100%); animation: shimmer 2s infinite;
}

/* Animations */
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.fade-in { animation: fadeIn 0.5s forwards; }

/* ================================================== */
/* =======  10. HORIZON SYSTEM MASTHEAD  ============ */
/* ================================================== */
.horizon-system-bar {
    width: 100%; 
    max-width: 1400px;
    margin: 0 auto; /* Center the bar itself */
    display: flex; 
    justify-content: space-between; /* Space items across full width */
    align-items: center;
    padding: 1.5rem 2rem; 
    z-index: 100; 
    position: relative;
}

/* Left Spacer */
.masthead-spacer { width: 140px; } 

/* Center Lockup */
.masthead-title-lockup {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.masthead-pill {
    background: var(--aviation-teal);
    color: white;
    font-family: 'Antonio', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 50px;
    margin-bottom: 6px;
    box-shadow: 0 2px 8px rgba(0,188,212,0.3);
    font-weight: 700;
}

.masthead-brand {
    line-height: 0.8;
    color: var(--deep-space-blue); /* Dark Blue */
    text-shadow: 0 2px 0px rgba(255,255,255,0.6);
}

.brand-script {
    font-family: 'Mr Dafoe', cursive;
    font-size: 2.8rem;
    color: var(--retro-coral); /* Pop Color */
    margin-right: 10px;
    display: inline-block;
    transform: rotate(-4deg) translateY(-4px);
    text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
}

.brand-display {
    font-family: 'Righteous', cursive;
    font-size: 2.4rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #37474f; /* Slate */
}

/* Right Controls */
.masthead-controls { 
    display: flex; gap: 0.8rem; align-items: center; width: 140px; justify-content: flex-end;
}

.btn-masthead {
    width: 42px; height: 42px; 
    border-radius: 50%; 
    background: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.8); 
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    cursor: pointer; transition: all 0.2s;
    font-size: 1.1rem;
    text-decoration: none;
}
.btn-masthead:hover { 
    background: white; color: var(--aviation-teal); transform: translateY(-2px); 
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 38px; height: 38px; 
    border-radius: 50%; 
    background: linear-gradient(135deg, #ff7043, #d84315);
    color: white; 
    display: flex; align-items: center; justify-content: center; 
    font-weight: bold;
    font-family: 'Antonio', sans-serif; 
    border: 2px solid white; 
    box-shadow: 0 4px 10px rgba(244, 81, 30, 0.3);
    cursor: pointer;
}

ðŸ”µ ce_cards.js:
// ce_cards.js (The Speculation Environment Controller - Horizon Fusion v2025.23)

import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- 1. STATE MANAGEMENT ---
let state = {
    modalElement: null,
    ceId: null,
    ceType: null,
    activeTab: 'overview',
    collections: {
        prerequisites: [],
        stakeholders: [],
        assumptions: [],
        resources: [],
        connections: []
    },
    details_data: {},
    nodeSchema: {},
    isSaving: false
};

// --- 2. PERSONA MATRIX ---
const PERSONAS = {
    "Research": { title: "DEEP TRUTH ENGINE", icon: "fa-flask", class: "persona-research", tone: "Empirical" },
    "Risk": { title: "SECURITY OVERWATCH", icon: "fa-shield-virus", class: "persona-risk", tone: "Critical" },
    "Stakeholder": { title: "NETWORK DIPLOMAT", icon: "fa-handshake", class: "persona-stakeholder", tone: "Strategic" },
    "Advocacy": { title: "AMPLIFIER", icon: "fa-bullhorn", class: "persona-advocacy", tone: "Persuasive" },
    "Environment": { title: "SYSTEM ECOLOGIST", icon: "fa-leaf", class: "persona-research", tone: "Holistic" },
    "Timeline": { title: "TEMPORAL ARCHITECT", icon: "fa-stopwatch", class: "persona-default", tone: "Linear" },
    "Default": { title: "SPECULATE CO-PILOT", icon: "fa-brain", class: "persona-default", tone: "Helpful" }
};

// --- 3. INITIALIZATION ---

export function displayCEModal(modalHtml, ceId, p_ceType, ceData) {
    const modalContainer = document.getElementById('dynamicModalContainer');
    modalContainer.innerHTML = modalHtml;
    
    const modalElement = document.getElementById(`ceModal-${ceId}`);
    if (!modalElement) return console.error("Modal element not found.");

    const modal = new bootstrap.Modal(modalElement);

    modalElement.addEventListener('shown.bs.modal', () => {
        // 1. Resolve Schema
        const nodeConfig = (window.NODES && window.NODES[p_ceType]) ? window.NODES[p_ceType] : (window.NODES['Default']);

        // 2. Hydrate State
        const d = ceData?.data || {};
        state = {
            modalElement, 
            ceId, 
            ceType: p_ceType, 
            activeTab: 'overview',
            collections: {
                prerequisites: d.prerequisites || [],
                stakeholders: d.stakeholders || [],
                assumptions: d.assumptions || [],
                resources: d.resources || [],
                connections: d.connections || []
            },
            details_data: d.details_data || {},
            nodeSchema: nodeConfig,
            isSaving: false
        };
        
        // 3. Boot System
        render(); 
        setupEventListeners();
        
        // 4. Auto-Start ("One-Hit" Check)
        checkAndTriggerAutoPopulation();

    }, { once: true });

    modalElement.addEventListener('hidden.bs.modal', () => modalElement.remove());
    modal.show();
}

// --- 4. AUTOMATION LOGIC ---

function checkAndTriggerAutoPopulation() {
    const isFresh = ['prerequisites', 'stakeholders', 'assumptions'].every(k => state.collections[k].length === 0);
    
    if (isFresh) {
        console.log("System Scan Initiated: Fresh Node Detected");
        
        const statusCard = state.modalElement.querySelector('.system-status-card');
        const statusValue = state.modalElement.querySelector('.status-card-value');
        
        if (statusCard && statusValue) {
            statusValue.innerText = "SCANNING...";
            statusValue.classList.add('text-primary');
            statusCard.classList.add('scanning'); 
        }

        triggerEnhancement('summary', null); 
        setTimeout(() => triggerSpeculation('prerequisites'), 1200);
        setTimeout(() => triggerSpeculation('stakeholders'), 2800);
        setTimeout(() => triggerSpeculation('assumptions'), 4200);
    }
}

// --- 5. RENDER PIPELINE ---

function render() {
    if (!state.modalElement) return;
    renderAllCollections();
    renderOverviewStream();
    renderSidebarPersona();
    renderAiSidebarContent();
    updateDashboard();
}

function renderAllCollections() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(type => {
        renderCollectionList(type);
    });
}

function renderOverviewStream() {
    const container = state.modalElement.querySelector('#overview-logic-stream');
    if(!container) return;

    let signals = [];
    (state.collections.prerequisites || []).slice(0, 3).forEach(i => 
        signals.push({ type: 'PREREQ', text: i.title, icon: 'fa-check-square', color: 'text-primary' })
    );
    (state.collections.assumptions || []).slice(0, 2).forEach(i => 
        signals.push({ type: 'RISK', text: i.hypothesis, icon: 'fa-exclamation-circle', color: 'text-danger' })
    );

    if (signals.length === 0) {
        container.innerHTML = `<div class="text-center p-4 opacity-50"><i class="fas fa-wind mb-2"></i><div class="font-data small">No Signals</div></div>`;
        return;
    }

    container.innerHTML = `<ul class="list-group list-group-flush">` + signals.map(s => `
        <li class="list-group-item px-3 py-2 border-0 border-bottom signal-item type-${s.type}">
            <div class="d-flex align-items-center">
                <i class="fas ${s.icon} ${s.color} me-3"></i>
                <div class="text-truncate font-body small fw-bold text-dark">${s.text || 'Untitled'}</div>
            </div>
        </li>
    `).join('') + `</ul>`;
}

function renderCollectionList(type) {
    const container = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    if (!container) return;

    const items = state.collections[type] || [];

    if (items.length === 0) {
        let icon = "fa-wind";
        let text = "Auto-Generate";
        if (type === 'prerequisites') { icon = "fa-list-check"; text = "Speculate Prerequisites"; }
        if (type === 'stakeholders') { icon = "fa-users-viewfinder"; text = "Query Network"; }
        
        container.innerHTML = `
            <div class="text-center p-5 opacity-50 border border-dashed rounded bg-light mt-3">
                <i class="fas ${icon} fa-2x mb-3 text-muted"></i>
                <p class="font-data small text-muted mb-3">DATA STREAM EMPTY</p>
                <button class="btn btn-sm btn-outline-primary font-data rounded-pill px-4 btn-speculate-collection" data-collection="${type}">
                    <i class="fas fa-magic me-2"></i> ${text}
                </button>
            </div>`;
        return;
    }

    const schemaKey = type.slice(0, -1) + '_schema';
    const fields = state.nodeSchema[schemaKey] || [];
    const titleKey = fields[0]?.key || 'title';
    const subKey = fields[1]?.key || 'status';

    container.innerHTML = items.map(item => {
        const title = item[titleKey] || 'Untitled';
        const subtitle = item[subKey] || 'Pending';
        const isProposed = item.tags && item.tags.includes("AI");

        const extraClass = isProposed ? "border-dashed" : "";
        let stripColor = "var(--phase-color)";
        
        if (isProposed) stripColor = "#6366f1"; 
        else if (['Verified','Signed','Met'].includes(item.status)) stripColor = "#10b981"; 

        return `
        <div class="collection-card-modern ${extraClass}" style="position:relative;">
            <div style="position:absolute; left:0; top:0; bottom:0; width:5px; background-color:${stripColor};"></div>
            <div class="flex-grow-1 ps-2">
                <div class="d-flex align-items-center gap-2">
                    <div class="card-title-modern">${title}</div>
                    ${isProposed ? '<span class="badge bg-primary-soft text-primary font-data" style="font-size:0.6em">PROPOSED</span>' : ''}
                </div>
                <div class="card-subtitle-modern text-truncate">${subtitle}</div>
            </div>
            <div class="d-flex align-items-center gap-1">
                ${isProposed 
                    ? `<button class="btn btn-sm btn-outline-success btn-accept p-1 px-2 shadow-sm" data-col="${type}" data-id="${item.id}" title="Accept"><i class="fas fa-check"></i></button>`
                    : `<button class="btn btn-sm btn-link text-muted p-1 btn-edit-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>`
                }
                <button class="btn btn-sm btn-link text-danger p-1 btn-delete-item" data-collection="${type}" data-id="${item.id}"><i class="fas fa-times"></i></button>
            </div>
        </div>`;
    }).join('');
}

// --- 6. DASHBOARD & METRICS ---

function updateDashboard() {
    ['prerequisites', 'stakeholders', 'assumptions', 'resources'].forEach(k => {
        const count = (state.collections[k] || []).length;
        const badge = state.modalElement.querySelector(`.count-badge[data-collection="${k}"]`);
        if (badge) {
            badge.textContent = count;
            if(count > 0) {
                badge.classList.remove('bg-light', 'text-dark');
                badge.classList.add('bg-primary', 'text-white');
            }
        }
    });

    let score = 0;
    const totalGoal = 60; 

    Object.values(state.collections).flat().forEach(i => {
        score += 5; 
        if (['Verified', 'Met', 'Signed', 'Active'].includes(i.status)) score += 5;
    });
    if (state.details_data.summary && state.details_data.summary.length > 20) score += 10;

    const percent = Math.min(100, Math.floor((score / totalGoal) * 100));
    
    const bar = state.modalElement.querySelector('#ce-progress-bar');
    const lbl = state.modalElement.querySelector('#ce-progress-label');
    if(bar) bar.style.width = `${percent}%`;
    if(lbl) lbl.innerText = `${percent}%`;

    const statusCard = state.modalElement.querySelector('.system-status-card');
    const statusVal = state.modalElement.querySelector('.status-card-value');
    
    if (statusVal && !statusCard.classList.contains('scanning')) {
        statusVal.classList.remove('text-primary');
        if (percent === 0) statusVal.innerText = "INITIALIZED";
        else if (percent < 30) statusVal.innerText = "ANALYZING";
        else if (percent < 80) statusVal.innerText = "CALIBRATING";
        else statusVal.innerHTML = "<span class='text-success'>OPTIMIZED</span>";
    }
}

function renderSidebarPersona() {
    const header = state.modalElement.querySelector('#ai-sidebar-header');
    if(!header) return;
    
    const persona = PERSONAS[state.ceType] || PERSONAS['Default'];
    header.className = 'sidebar-persona-header ' + (persona.class || 'persona-default');
    header.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="fas ${persona.icon} fa-lg"></i>
                <span class="font-brand" style="letter-spacing:1px;">${persona.title}</span>
            </div>
            <i class="fas fa-circle text-white fa-xs opacity-75 animate-pulse"></i>
        </div>
        <div class="small opacity-75 mt-1 font-data" style="letter-spacing:0.5px;">MODE: ${persona.tone.toUpperCase()}</div>
    `;
}

function renderAiSidebarContent() {
    const content = state.modalElement.querySelector('#ai-sidebar-content');
    if(!content) return;
    const tab = state.activeTab;
    const mkBtn = (txt, icon, color, action) => 
        `<button class="btn btn-light border w-100 text-start mb-2 shadow-sm ${action}"><i class="fas ${icon} me-2 text-${color}"></i> ${txt}</button>`;

    let html = `<h6 class="font-data text-muted small mb-3">AVAILABLE PROTOCOLS</h6>`;

    if (tab === 'overview') {
        html += mkBtn("Strategic Analysis", "chess-board", "primary", "btn-trigger-ai' data-context='narrative' data-sub='context");
        html += mkBtn("Critical Risk Scan", "shield-alt", "danger", "btn-trigger-ai' data-context='assumptions");
    } else if (['prerequisites','stakeholders','assumptions','resources'].includes(tab)) {
        const label = tab.charAt(0).toUpperCase() + tab.slice(1, -1);
        html += `<button class="btn btn-gradient-purple w-100 text-start mb-2 shadow-sm text-white btn-speculate-collection" data-collection="${tab}"><i class="fas fa-bolt me-2"></i> Speculate ${label}s</button>`;
        html += `<div class="small text-muted mb-2 mt-2 font-data">Refinement</div>`;
        html += mkBtn("Validate Entries", "check-double", "success", "");
    } else {
        html += mkBtn("Auto-Draft Content", "magic", "purple", "btn-enhance-field' data-field='summary");
    }
    
    content.innerHTML = html + `<div class="mt-auto pt-4 border-top"><label class="font-data small text-muted mb-2">DIRECT UPLINK</label><input type="text" class="form-control form-control-sm font-body" placeholder="Query the Engine..."></div>`;
}

// --- 7. SERVER ACTIONS ---

function triggerSpeculation(type, btn = null) {
    let origHtml = '';
    if(btn) { origHtml = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; }
    else { updateDashboard(); }

    const contextGoal = state.modalElement.querySelector('.source-cos-card p')?.textContent.trim();

    fetch('/speculate_context', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, 
            context: type, 
            cos_text: contextGoal 
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.suggestions) {
            data.suggestions.forEach(i => {
                i.id = self.crypto.randomUUID();
                i.tags = "AI"; 
                i.status = "Proposed";
                state.collections[type].push(i);
            });
            render(); 
        }
    })
    .finally(() => {
        if(btn) { btn.disabled = false; btn.innerHTML = origHtml; }
        const statusCard = state.modalElement.querySelector('.system-status-card');
        if(statusCard) statusCard.classList.remove('scanning');
        updateDashboard();
    });
}

function triggerEnhancement(fieldKey, btn = null) {
    if(btn) { btn.innerHTML = '<i class="fas fa-spin fa-spinner"></i>'; }
    const contextGoal = state.modalElement.querySelector('.source-cos-card p')?.textContent.trim();

    fetch('/speculate_context', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            ce_type: state.ceType, context: 'narrative', sub_context: fieldKey, cos_text: contextGoal 
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.text) {
            state.details_data[fieldKey] = data.text;
            const input = state.modalElement.querySelector(`[name="${fieldKey}"]`);
            if(input) input.value = data.text;
            updateDashboard();
        }
    })
    .finally(() => { if(btn) btn.innerHTML = '<i class="fas fa-magic"></i> ENHANCE'; });
}

function saveDataPacket() {
    const btn = state.modalElement.querySelector('.btn-save-changes');
    const orig = btn.innerHTML; // Capture the dynamic "SAVE RISK" text
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> COMMITTING...';

    // Scrape Narrative Form if it exists
    const narrForm = state.modalElement.querySelector(`#narrative-form-${state.ceId}`);
    if (narrForm) {
        const fd = new FormData(narrForm);
        state.details_data = Object.fromEntries(fd.entries());
    }

    // Build Packet
    const packet = {
        details_data: state.details_data,
        prerequisites: state.collections.prerequisites,
        stakeholders: state.collections.stakeholders,
        assumptions: state.collections.assumptions,
        resources: state.collections.resources,
        connections: state.collections.connections
    };

    fetch(`/update_ce/${state.ceId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(packet)
    })
    .then(r => r.json())
    .then(data => {
        if(data.success) {
            const status = state.modalElement.querySelector('#save-status');
            // Contextual success message
            if(status) status.innerHTML = `<span class="text-success font-data">${state.ceType.toUpperCase()} COMMITTED</span>`;
            
            btn.classList.remove('btn-primary'); btn.classList.add('btn-success');
            btn.innerHTML = `<i class="fas fa-check"></i> SAVED`;
            
            setTimeout(() => { 
                btn.classList.remove('btn-success'); btn.classList.add('btn-primary');
                btn.innerHTML = orig; // Restore "SAVE RISK"
            }, 1500);
        }
    });
}

// --- 8. EVENT LISTENERS ---

function setupEventListeners() {
    const m = state.modalElement;

    // Tabs -> Context Switching
    const nav = m.querySelector('.ce-nav-tabs');
    if(nav) {
        nav.addEventListener('shown.bs.tab', e => {
            const tid = e.target.getAttribute('data-bs-target');
            if(tid.includes('overview')) state.activeTab = 'overview';
            else if(tid.includes('narrative')) state.activeTab = 'narrative';
            else {
                const p = tid.split('-'); if(p.length > 1) state.activeTab = p[1];
            }
            renderAiSidebarContent();
        });
    }

    // Central Click Handler
    m.addEventListener('click', e => {
        const t = e.target;

        // 1. Suggest / Enhance / AI Triggers
        const specBtn = t.closest('.btn-speculate-collection');
        if(specBtn) triggerSpeculation(specBtn.dataset.collection, specBtn);
        
        const enhBtn = t.closest('.btn-enhance-field');
        if(enhBtn) triggerEnhancement(enhBtn.dataset.field, enhBtn);
        
        const aiBtn = t.closest('.btn-trigger-ai');
        if(aiBtn) triggerSpeculation(aiBtn.dataset.context, aiBtn);

        // 2. Editor Controls
        const addBtn = t.closest('.btn-add-item');
        if(addBtn) toggleEditor(addBtn.dataset.collection, true);
        
        const editBtn = t.closest('.btn-edit-item');
        if(editBtn) {
            const col = editBtn.dataset.collection;
            const item = state.collections[col].find(i => i.id === editBtn.dataset.id);
            if(item) toggleEditor(col, true, item);
        }

        const cancelBtn = t.closest('.btn-cancel-edit');
        if(cancelBtn) {
            const type = cancelBtn.closest('form').dataset.collection;
            toggleEditor(type, false);
        }

        // 3. Item Actions
        const accBtn = t.closest('.btn-accept');
        if(accBtn) {
            const col = accBtn.dataset.col;
            const item = state.collections[col].find(i => i.id === accBtn.dataset.id);
            if(item) { item.tags = ""; item.status = "Active"; render(); }
        }
        
        const delBtn = t.closest('.btn-delete-item');
        if(delBtn && confirm("Purge item?")) {
            const col = delBtn.dataset.col;
            state.collections[col] = state.collections[col].filter(i => i.id !== delBtn.dataset.id);
            render();
        }

        // 4. Save
        if(t.closest('.btn-save-changes')) saveDataPacket();
    });

    // Forms
    m.querySelectorAll('.editor-form').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            const col = form.dataset.collection;
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());

            // Handle Smart Widget (Checkboxes) manually
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                data[cb.name] = cb.checked;
            });

            if(form.dataset.editingId) {
                const idx = state.collections[col].findIndex(i => i.id === form.dataset.editingId);
                if(idx > -1) state.collections[col][idx] = {...state.collections[col][idx], ...data};
            } else {
                data.id = self.crypto.randomUUID();
                data.status = "Active";
                state.collections[col].push(data);
            }
            toggleEditor(col, false);
            render();
        });
    });
}

function toggleEditor(type, show, itemData=null) {
    const cont = state.modalElement.querySelector(`#container-${type}-${state.ceId}`);
    const edit = state.modalElement.querySelector(`#editor-${type}-${state.ceId}`);
    const form = edit.querySelector('form');

    if(show) {
        cont.style.display = 'none';
        edit.style.display = 'block';
        form.reset();
        if(itemData) {
            form.dataset.editingId = itemData.id;
            Object.keys(itemData).forEach(k => {
                const input = form.querySelector(`[name="${k}"]`);
                if(input) {
                    if(input.type === 'checkbox') input.checked = itemData[k] === true;
                    else input.value = itemData[k];
                    // Smart Slider Update
                    if(input.type === 'range' && input.nextElementSibling) input.nextElementSibling.innerText = input.value + '%';
                }
            });
        } else delete form.dataset.editingId;
    } else {
        cont.style.display = 'block';
        edit.style.display = 'none';
    }
}

ðŸ“† models.py:
# models.py
import os
import json
import uuid
from datetime import date
from dotenv import load_dotenv
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import (create_engine, Column, String, ForeignKey, inspect, 
                        TEXT, TypeDecorator, Text, Date, Integer, Float)
from sqlalchemy.dialects.postgresql import UUID, JSONB
from sqlalchemy.orm import scoped_session, sessionmaker, relationship
from sqlalchemy.ext.declarative import declarative_base

load_dotenv()
db = SQLAlchemy()
Base = declarative_base()

# A generic JSON type for compatibility with different database backends (e.g., SQLite)
class JsonEncodedDict(TypeDecorator):
    """Enables JSON storage by encoding and decoding on the fly."""
    impl = TEXT

    def process_bind_param(self, value, dialect):
        if value is None:
            return None
        return json.dumps(value)

    def process_result_value(self, value, dialect):
        if value is None:
            return None
        return json.loads(value)

# Use the efficient native JSONB type if on PostgreSQL, otherwise use our text-based fallback.
JsonType = JSONB if 'postgresql' in os.environ.get('SQLALCHEMY_DATABASE_URI', '') else JsonEncodedDict


class SSOL(db.Model):
    __tablename__ = 'ssol'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # --- CORE IDENTITY ---
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    
    # --- SCOPE & CONSTRAINTS (The MVP Project Container) ---
    domain = Column(String(100), nullable=True)     # Context for AI (e.g. "Bio-Tech")
    status = Column(String(50), default='Draft')    # Lifecycle (Draft, Active, Paused, Complete)
    owner = Column(String(255), nullable=True)      # The human champion
    target_date = Column(Date, nullable=True)       # The horizon/deadline
    
    # --- METRICS ---
    integrity_score = Column(Integer, default=100)  # 0-100 Health Metric
    completion_percentage = Column(Integer, default=0) # Derived from COS completion
    
    # --- RELATIONSHIPS ---
    cos = relationship('COS', back_populates='ssol', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'title': self.title,
            'description': self.description,
            'domain': self.domain,
            'status': self.status,
            'owner': self.owner,
            'target_date': self.target_date.isoformat() if self.target_date else None,
            'integrity_score': self.integrity_score,
            'completion_percentage': self.completion_percentage,
            'cos': [c.to_dict() for c in self.cos]
        }

class COS(db.Model):
    __tablename__ = 'cos'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    
    # --- STATUS TRACKING ---
    status = Column(String(50), nullable=False, default='Proposed') # Proposed, Active, Complete, Verified
    
    accountable_party = Column(String(255), nullable=True)
    completion_date = Column(Date, nullable=True)
    
    ssol_id = Column(UUID(as_uuid=True), ForeignKey('ssol.id'), nullable=False)
    ssol = relationship('SSOL', back_populates='cos')
    conditional_elements = relationship('CE', back_populates='cos', cascade="all, delete-orphan")

    def to_dict(self):
        return {
            'id': str(self.id),
            'content': self.content,
            'status': self.status,
            'accountable_party': self.accountable_party,
            'completion_date': self.completion_date.isoformat() if self.completion_date else None,
            'ssol_id': str(self.ssol_id),
            'conditional_elements': [ce.to_dict() for ce in self.conditional_elements]
        }

class CE(db.Model):
    __tablename__ = 'ce'
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    node_type = Column(String(50), nullable=False, default='Default')
    
    cos_id = Column(UUID(as_uuid=True), ForeignKey('cos.id'), nullable=False)
    cos = relationship('COS', back_populates='conditional_elements')

    # --- THE STRATEGIC PAYLOAD ---
    # Stores the complete state of the Speculation Environment.
    # Initializing with all keys ensures the "Fresh Node" check in JS works reliably.
    data = Column(JsonType, nullable=False, default=lambda: {
        "details_data": {}, 
        "prerequisites": [],
        "stakeholders": [], 
        "assumptions": [],
        "resources": [],
        "connections": []
    })

    def to_dict(self):
        return {
            'id': str(self.id),
            'node_type': self.node_type,
            'cos_id': str(self.cos_id),
            'data': self.data 
        }


def get_engine_and_session():
    engine = create_engine(os.environ.get('SQLALCHEMY_DATABASE_URI'))
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    session = scoped_session(SessionLocal)
    return engine, session


def create_tables_if_not_exist(engine):
     if not inspect(engine).has_table("ssol"):
          Base.metadata.create_all(engine)

ðŸŸ¦ outcome.html:
{% extends 'base.html' %}

{% block content %}
<!-- THE HORIZON WRAPPER -->
<div class="horizon-wrapper">
  <div class="console-housing">
    
    <!-- 1. COMMAND DECK (Top Section) -->
    <div class="screen-surface d-flex flex-column flex-md-row bg-white mb-4">
        
        <!-- A. IDENTITY SIDEBAR (Visuals & Stats) -->
        <div class="header-sidebar col-md-3">
            <!-- Image Portal -->
            <div class="image-portal">
                <img src="{{ url_for('static', filename='images/SSPEC_Logo_Motion.gif') }}" id="placeholderImage" class="fade-in" alt="Loading Animation">
                <img src="" id="ssolImage" class="fade-in" style="opacity: 0;" alt="Generated Visualization">
            </div>
            
            <!-- Domain Sector -->
            <div class="mb-4 w-100 text-center">
                <div class="font-data text-muted small mb-1">DOMAIN SECTOR</div>
                <div class="domain-badge mx-auto d-inline-flex align-items-center px-3 py-1 border rounded-pill">
                    <i class="{{ ssol.domain_icon }} text-info me-2"></i>
                    <span class="font-body fw-bold small text-dark">{{ ssol.domain | upper }}</span>
                </div>
            </div>

            <!-- System Goal -->
            <div class="w-100 text-start border-top pt-3">
                <div class="font-data text-muted small mb-2">PRIME OBJECTIVE</div>
                <!-- Hidden input for JS hooks -->
                <div id="ssol-goal" class="d-none">{{ ssol.selected_goal }}</div>
                <p class="font-body small text-muted fst-italic lh-sm">"{{ ssol.selected_goal }}"</p>
            </div>
        </div>

        <!-- B. STRATEGIC CANVAS (Right Content) -->
        <div class="col-md-9 p-4 p-md-5 position-relative bg-light">
            <div class="brand-strip"></div>
            
            <!-- Title Row -->
            <div class="d-flex justify-content-between align-items-start mb-4 mt-2">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge bg-info font-data rounded-1 text-white px-2 py-1">SSPEC SOLUTION</span>
                        <span class="font-data text-muted">#{{ ssol_id.split('-')[0] | upper }}</span>
                    </div>
                    <h1 class="text-dark mb-0 display-5" style="line-height:1;">{{ ssol.ssol_title }}</h1>
                </div>
                
                <!-- Action Deck -->
                <div class="d-flex gap-2">
                    <button id="save-as-pdf-button" data-ssol-id="{{ ssol_id }}" class="btn btn-sm btn-info text-white font-data rounded-pill px-4 shadow-sm d-flex align-items-center gap-2">
                        <i class="fas fa-file-pdf"></i> EXPORT
                    </button>
                </div>
            </div>

            <!-- *** THE COMMAND DECK *** -->
            <div class="command-deck-wrapper">
                
                <!-- 1. The Horizon Gauge (Time/Timeline) -->
                <!-- Passed from backend based on system_templates.py -->
                {{ horizon_gauge_html | default('<div class="alert alert-light border text-muted font-data small">TIMELINE NOT ESTABLISHED</div>') | safe }}

                <!-- 2. Strategic Charter (Narrative + Anchors) -->
                <div class="bg-white p-4 rounded-4 border shadow-sm position-relative overflow-hidden">
                    
                    <!-- Watermark -->
                    <div class="position-absolute top-0 end-0 p-3 opacity-10">
                       <i class="fas fa-quote-right fa-4x text-secondary"></i>
                    </div>
                    
                    <!-- The Narrative -->
                    <div class="font-body text-dark lead position-relative z-1 mb-4" style="line-height: 1.6; font-size: 1.05rem;">
                        {{ ssol.ssol_summary | safe }}
                    </div>

                    <!-- The System Pills (Strategic Anchors) -->
                    <!-- Passed from backend based on system_templates.py -->
                    {{ system_pills_html | default('') | safe }}
                
                </div>

            </div>
            <!-- END COMMAND DECK -->

            <!-- Data Strip Decoration -->
            <div class="d-flex align-items-center gap-1 mt-4 opacity-50">
                <div class="rounded-1 bg-secondary" style="width: 40px; height: 4px;"></div>
                <div class="rounded-1 bg-secondary" style="width: 20px; height: 4px;"></div>
                <div class="rounded-1 bg-light flex-grow-1" style="height: 4px;"></div>
                <div class="rounded-1 bg-info" style="width: 60px; height: 4px;"></div>
            </div>
        </div>
    </div>

    <!-- 2. DATA GRID (Phases) -->
    <div class="screen-surface bg-white min-vh-50 d-flex flex-column">
        
        <!-- Header -->
        <div class="bg-light border-bottom px-4 py-4 d-flex justify-content-between align-items-center shadow-sm z-10">
            <h2 class="h5 mb-0 text-secondary font-brand letter-spacing-1">PHASES & CONDITIONS</h2>
            <!-- Legend... -->
        </div>

        <!-- Accordion -->
        <div class="p-4 overflow-y-auto flex-grow-1 bg-white">
            <div class="accordion" id="phaseAccordion">
                {% for phase_name, cos_list in ssol.phases.items() %}
                <div class="accordion-item border-0 mb-4 bg-transparent shadow-sm rounded-3 overflow-hidden">
                    
                    <!-- Header... -->

                    <!-- Body -->
                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse show module-content bg-white border border-top-0 rounded-bottom-3" data-bs-parent="#phaseAccordion">
                        <div class="accordion-body p-0 phase-table-container" data-ssol-id="{{ ssol_id }}">
                            {% if cos_list %}
                            <table class="table table-hover mb-0 align-middle retro-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4" style="width: 110px;">Status</th>
                                        
                                        <!-- RESTORED TERMINOLOGY -->
                                        <th>Condition of Satisfaction</th> 
                                        
                                        <th style="width: 18%;">Accountable</th>
                                        <th style="width: 12%;">Target</th>
                                        <th class="text-end pe-4" style="width: 100px;">Edit</th>
                                    </tr>
                                </thead>
                                <!-- ... Table Body ... -->
                            </table>
                            <!-- Add Button -->
                            <div class="p-3 bg-white border-top d-flex justify-content-center">
                                <!-- RESTORED BUTTON LABEL -->
                                <button class="btn btn-sm btn-white border font-data rounded-pill px-4 text-secondary hover-shadow add-cos" data-phase="{{ phase_name }}">
                                    <i class="fas fa-plus me-2 text-primary"></i> ADD CONDITION
                                </button>
                            </div>
                            {% else %}
                            <!-- Empty State -->
                            <div class="p-3 bg-white border-top d-flex justify-content-center">
                                <button class="btn btn-sm btn-outline-secondary rounded-pill px-4 font-data add-cos" data-phase="{{ phase_name }}">
                                    <i class="fas fa-plus me-2"></i> INITIALIZE COS
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Footer Status -->
        <div class="px-4 py-3 bg-light border-top d-flex justify-content-between align-items-center mt-auto">
            <div class="font-data small text-muted d-flex align-items-center">
                <div class="rounded-circle bg-success me-2 animate-pulse" style="width:8px; height:8px;"></div>
                SYSTEM ONLINE
            </div>
            <div class="font-data small text-muted">SSPEC HORIZON v2025.23</div>
        </div>

    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-body font-body" id="errorMessageContent"></div></div></div>
</div>

<!-- Config Modal Injection -->
{{ system_config_modal_html | default('') | safe }}

<!-- Dynamic Container -->
<div id="dynamicModalContainer"></div>

<style>
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/cos_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/ce_cards.js') }}"></script>
<!-- Include JS for System Modal interaction here if needed, or inside base -->
<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    // Legend Interaction
    const legendItems = document.querySelectorAll('.phase-legend-item');
    legendItems.forEach(item => {
        item.addEventListener('click', () => {
            const targetId = item.dataset.targetId; 
            const targetCollapse = document.getElementById(targetId);
            const targetItem = targetCollapse?.closest('.accordion-item');
            if (targetCollapse) {
                new bootstrap.Collapse(targetCollapse, { toggle: false }).show();
                setTimeout(() => targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
            }
        });
    });

    // Image Fetch
    const ssolId = "{{ ssol_id }}"; 
    const ssolImageElement = document.getElementById('ssolImage'); 
    const placeholderImageElement = document.getElementById('placeholderImage');
    if (ssolImageElement) {
        function checkImage() {
            fetch(`/get_ssol_image/${ssolId}`)
                .then(r => r.json())
                .then(data => {
                    if(data.status === 'found' && data.image_path) {
                        ssolImageElement.src = data.image_path;
                        ssolImageElement.onload = () => {
                            placeholderImageElement.style.opacity = 0;
                            ssolImageElement.style.opacity = 1;
                        };
                    } else {
                        setTimeout(checkImage, 2000);
                    }
                }).catch(e => console.error(e));
        }
        checkImage();
    }
  });
</script>
{% endblock %}

ðŸ§© ce_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER (System Identity) -->
            <div class="ce-modal-header">
                <div class="node-icon-box">
                    <i class="{{ node_info.icon }}"></i>
                </div>
                <div class="header-text-block">
                    <h2 class="modal-title ce-title mb-0 text-white leading-tight">
                        {{ ceType.replace('_', ' ').upper() }}
                    </h2>
                    <div class="ce-header-metadata text-white opacity-75 small">
                        // {{ phase_name.upper() }} PHASE <span class="mx-2">|</span> ID: {{ ceId.split('-')[0].upper() }}
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3 text-white position-relative" style="z-index:10;">
                     <button class="btn btn-glass font-data d-none d-md-flex align-items-center gap-2" id="speculate-sidebar-toggle" title="Toggle Intelligence">
                        <i class="fas fa-brain"></i> ENGINE
                    </button>
                    <div class="vr bg-white opacity-50 mx-2" style="height: 24px;"></div>
                    <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="header-ghost-icon">
                    <i class="{{ node_info.icon }}"></i>
                </div>
            </div>

            <!-- READINESS BAR -->
            <div class="progress-bar-container">
                <div class="d-flex justify-content-between align-items-center mb-1" style="line-height:1;">
                    <span class="font-data small text-muted" style="font-size: 0.65rem; letter-spacing: 1px;">ANALYSIS DEPTH</span>
                    <span id="ce-progress-label" class="font-data small fw-bold text-muted">0%</span>
                </div>
                <div class="progress" style="height: 4px;">
                    <div id="ce-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex">
                
                <!-- LEFT COLUMN -->
                <div class="ce-main-column">
                    <ul class="nav nav-tabs ce-nav-tabs pt-2 px-4 bg-white" role="tablist">
                        <li class="nav-item"><button class="nav-link font-data active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">OVERVIEW</button></li>
                        <li class="nav-item"><button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-narrative-{{ ceId }}">NARRATIVE</button></li>
                        
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <li class="nav-item">
                            <button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-{{ collection }}-{{ ceId }}">
                                {{ collection|upper }} 
                                <span class="badge rounded-pill bg-light text-dark border ms-1 count-badge" data-collection="{{ collection }}">0</span>
                            </button>
                        </li>
                        {% endfor %}
                        
                        <li class="nav-item ms-auto"><button class="nav-link font-data text-muted" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i></button></li>
                    </ul>

                    <!-- CONTENT AREA -->
                    <div class="ce-app-content tab-content flex-grow-1 overflow-y-auto bg-surface-screen position-relative">
                        <div class="bg-technical-grid position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none; z-index: 0;"></div>
                        
                        <div class="position-relative p-4" style="z-index: 1;">
                            
                            <!-- 1. OVERVIEW -->
                            <div class="tab-pane fade show active" id="view-overview-{{ ceId }}">
                                <div class="row g-4">
                                    <div class="col-lg-8">
                                        <div class="system-status-card">
                                            <div class="status-ghost"><i class="{{ node_info.icon }}"></i></div>
                                            <div class="scan-overlay" style="display:none;"></div>
                                            <div class="font-data text-white-50 small mb-2 letter-spacing-2">SYSTEM STATUS</div>
                                            <div class="status-card-value text-white display-4 font-brand mb-4 text-shadow-sm">INITIALIZED</div>
                                            <div class="p-3 rounded bg-white bg-opacity-10 border border-white border-opacity-25 backdrop-blur">
                                                <div class="d-flex gap-3">
                                                    <i class="fas fa-info-circle text-white mt-1"></i>
                                                    <div>
                                                        <div class="font-data text-white small mb-1">CONTEXTUAL INSIGHT</div>
                                                        <p class="font-body text-white mb-0 small opacity-90">
                                                            {{ ai_generated_data.contextual_description or 'System standby. Speculation engine ready.' }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="card metric-card border-0 shadow-sm h-100">
                                            <div class="card-body d-flex flex-column justify-content-center text-center p-4">
                                                <div class="font-data text-muted small mb-2">RESOURCE DENSITY</div>
                                                <div class="display-2 font-brand text-secondary resource-counter">0</div>
                                            </div>
                                            <div class="card-footer bg-light border-top-0 text-center p-3">
                                                <span class="badge bg-success font-data"><span id="verified-counter">0</span> VERIFIED</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 card border-0 shadow-sm">
                                    <div class="card-body p-4">
                                        <h6 class="font-data text-muted small mb-3">SOURCE CONDITION PROTOCOL</h6>
                                        <div class="font-body fst-italic text-dark fs-5">{{ cos_content_with_pills | safe }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. NARRATIVE -->
                            <div class="tab-pane fade" id="view-narrative-{{ ceId }}">
                                <div class="details-form-container mx-auto" style="max-width: 900px;">
                                    <form id="narrative-form-{{ ceId }}">
                                    {% for field in node_info.details_schema %}
                                    <div class="mb-5">
                                        <div class="d-flex justify-content-between align-items-end mb-2 border-bottom pb-2">
                                            <label class="font-data text-dark h5 mb-0">{{ field.label }}</label>
                                            <button type="button" class="btn btn-sm btn-link text-decoration-none font-data text-primary btn-enhance-field" data-field="{{ field.key }}"><i class="fas fa-magic me-1"></i> ENHANCE</button>
                                        </div>
                                        <textarea name="{{ field.key }}" class="form-control border-0 bg-white shadow-sm p-4 font-body fs-6" rows="5" placeholder="Drafting strategy...">{{ ce_data.data.details_data.get(field.key, '') }}</textarea>
                                    </div>
                                    {% endfor %}
                                    </form>
                                </div>
                            </div>

                            <!-- 3-6. COLLECTIONS -->
                            {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                            <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="btn-group shadow-sm">
                                        <button class="btn btn-white font-data px-4 btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-2 text-muted"></i> MANUAL</button>
                                        <button class="btn btn-white font-data px-4 text-primary btn-speculate-collection" data-collection="{{ collection }}"><i class="fas fa-brain me-2"></i> AUTO-GEN</button>
                                    </div>
                                    <input type="text" class="form-control w-auto border-0 shadow-sm font-body" placeholder="Search {{ collection }}...">
                                </div>
                                <div class="collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}"></div>
                                
                                <!-- EDITOR (Hidden) -->
                                <div class="collection-editor p-4 bg-white border-top shadow-lg position-absolute bottom-0 start-0 w-100" id="editor-{{ collection }}-{{ ceId }}" style="display:none; z-index: 50;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="font-brand">NEW ENTRY</h5>
                                        <button type="button" class="btn-close btn-cancel-edit"></button>
                                    </div>
                                    <form class="editor-form" data-collection="{{ collection }}">
                                        {% set schema_key = collection[:-1] + '_schema' %} 
                                        {% set schema = node_info.get(schema_key, []) %}
                                        <div class="row g-3">
                                            {% for field in schema %}
                                            <div class="col-12 {{ 'col-md-6' if field.type != 'textarea' else '' }}">
                                                <label class="font-data text-muted small mb-1">{{ field.label }}</label>
                                                {% if field.type == 'textarea' %}
                                                    <textarea name="{{ field.key }}" class="form-control bg-light" rows="2"></textarea>
                                                {% elif field.type == 'select' %}
                                                    <select name="{{ field.key }}" class="form-select font-body">{% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}</select>
                                                {% elif field.type == 'slider' %}
                                                    <div class="ce-range-wrap"><input type="range" class="ce-range-input" name="{{ field.key }}" min="0" max="100" step="10"><span class="ce-range-value">50%</span></div>
                                                {% elif field.type == 'toggle' %}
                                                    <div class="mt-2"><label class="ce-toggle-switch"><input type="checkbox" name="{{ field.key }}"><span class="ce-toggle-slider"></span></label></div>
                                                {% else %}
                                                    <input type="text" name="{{ field.key }}" class="form-control">
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-4 text-end"><button type="submit" class="btn btn-success font-data px-4 rounded-pill">SAVE ENTRY</button></div>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- CONNECTIONS -->
                            <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                                <div class="text-center p-5 opacity-50"><i class="fas fa-project-diagram fa-4x mb-3"></i><h4 class="font-brand text-muted">NETWORK GRAPH</h4><p>No active vector connections.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column border-start bg-white">
                    <div class="sidebar-persona-header" id="ai-sidebar-header"></div>
                    <div class="p-3 flex-grow-1 overflow-y-auto" id="ai-sidebar-content"></div>
                </div>

            </div>
            
            <!-- FOOTER: DYNAMIC SAVE BUTTON -->
            <div class="modal-footer ce-modal-footer bg-white border-top d-flex justify-content-between">
                <div class="font-data text-muted small" id="save-status">STATUS: UNSAVED</div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary font-data px-4 rounded-pill" data-bs-dismiss="modal">EXIT</button>
                    <!-- Updated to show CE Type dynamically -->
                    <button type="button" class="btn btn-primary font-data px-4 rounded-pill btn-save-changes">
                        SAVE {{ ceType.upper() }}
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    ce_id_str = str(ce_data.get('id', 'new_ce'))
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=ce_id_str,
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

ðŸ”µ system_cards.js:


ðŸ³ï¸â€ðŸŒˆ ce_nodes.py:
# ce_nodes.py
"""
THE SPECULATION ENVIRONMENT MANIFEST
------------------------------------
This file defines the DNA for every Node Application in the SSPEC system.
It couples 'Smart Schemas' (for the UI) with 'Strategic Prompts' (for the AI).

PROMPT VARIABLES:
- {cos_text}: The text of the source Condition of Satisfaction.
- {field}: The specific field being enhanced (e.g., "Executive Summary", "Objective").
- {node_type}: The type of the node (e.g., "Research", "Risk").

NOTE: Double braces {{ }} are used to escape JSON structure examples in Python f-strings.
"""

NODES = {
    # ==============================================================================
    # 1. DEFAULT (The Generalist)
    # ==============================================================================
    "Default": {
        "definition": "General purpose speculation node.",
        "icon": "fa-solid fa-cube",
        "color": "#95a5a6",
        "details_schema": [
            {"key": "summary", "label": "Executive Summary", "type": "textarea", "rows": 4},
            {"key": "context", "label": "Strategic Context", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "title", "label": "Condition", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Pending", "Met"]},
            {"key": "confidence", "label": "Confidence", "type": "slider"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Name", "type": "text"},
            {"key": "role", "label": "Role", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "hypothesis", "label": "Hypothesis", "type": "text"},
            {"key": "risk", "label": "Risk Level", "type": "select", "options": ["Low", "High"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Resource Title", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Strategic Project Manager. Write a concise, professional '{field}' 
                for a '{node_type}' element needed to achieve this goal: '{cos_text}'.
                Focus on clarity, actionability, and value.
                Return JSON: {{ "text": "Your text here." }}
            """,
            "prerequisites": "Analyze '{cos_text}'. List 3 precursors needed. Return JSON array: [{{\"title\": \"Prereq\", \"status\": \"Pending\"}}]",
            "stakeholders": "Who is involved in '{cos_text}'? Return JSON array: [{{\"name\": \"Name/Role\", \"role\": \"Description\"}}]",
            "assumptions": "What are we assuming about '{cos_text}'? Return JSON array: [{{\"hypothesis\": \"Assumption...\", \"risk\": \"Medium\"}}]",
            "resources": "Suggest 3 general resources for '{cos_text}'. Return JSON array: [{{\"title\": \"Resource Name\", \"url\": \"#\"}}]"
        }
    },

    # ==============================================================================
    # 2. RESEARCH (The Scientist)
    # ==============================================================================
    "Research": {
        "definition": "A workspace for finding, synthesizing, and analyzing truth.",
        "icon": "fa-solid fa-flask",
        "color": "#ec407a", # Pink
        "details_schema": [
            {"key": "research_question", "label": "Primary Research Question", "type": "textarea", "rows": 2},
            {"key": "summary", "label": "Executive Synthesis", "type": "textarea", "rows": 6}
        ],
        "prerequisite_schema": [
            {"key": "data_req", "label": "Data Requirement", "type": "text"},
            {"key": "access_status", "label": "Access", "type": "select", "options": ["Open", "Restricted", "Purchased"]}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Subject Matter Expert", "type": "text"},
            {"key": "expertise", "label": "Field of Study", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "premise", "label": "Theoretical Premise", "type": "text"},
            {"key": "validation_method", "label": "Validation Method", "type": "select", "options": ["Lit Review", "Experiment", "Interview"]}
        ],
        "resource_schema": [
            {"key": "title", "label": "Paper/Source Title", "type": "text"},
            {"key": "type", "label": "Type", "type": "select", "options": ["Paper", "Article", "Dataset"]},
            {"key": "url", "label": "Source URL", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as a Lead Researcher. Write a precise '{field}' to address knowledge gaps regarding: '{cos_text}'.
                Ensure the language is objective, evidence-based, and methodologically sound.
                Return JSON: {{ "text": "Your research text here." }}
            """,
            "prerequisites": """
                To answer the research question implied by: '{cos_text}', what data or baseline access is needed first?
                Return JSON array: [{{\"data_req\": \"Specific Dataset\", \"access_status\": \"Unknown\"}}]
            """,
            "stakeholders": """
                Suggest 3 types of Subject Matter Experts (SMEs) needed for: '{cos_text}'.
                Return JSON array: [{{\"name\": \"Role Title\", \"expertise\": \"Academic Field\"}}]
            """,
            "assumptions": """
                What theoretical assumptions are we making in '{cos_text}' that require validation?
                Return JSON array: [{{\"premise\": \"Theory...\", \"validation_method\": \"Lit Review\"}}]
            """,
            "resources": """
                Find 3 relevant academic papers, datasets, or whitepapers for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Paper Title\", \"type\": \"Paper\", \"url\": \"https://scholar.google.com/\"}}]
            """
        }
    },

    # ==============================================================================
    # 3. RISK (The Immune System)
    # ==============================================================================
    "Risk": {
        "definition": "Identifies threats, calculates exposure, and engineers resilience.",
        "icon": "fa-solid fa-shield-virus",
        "color": "#e53935", # Red
        "details_schema": [
            {"key": "risk_vector", "label": "Primary Risk Vector", "type": "text"},
            {"key": "scenario", "label": "Worst-Case Scenario", "type": "textarea", "rows": 3},
            {"key": "resilience_strategy", "label": "Resilience Strategy", "type": "textarea", "rows": 3}
        ],
        "prerequisite_schema": [
            {"key": "indicator", "label": "Early Warning Indicator", "type": "text"},
            {"key": "threshold", "label": "Trigger Threshold", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Risk Owner", "type": "text"},
            {"key": "impacted_group", "label": "Impacted Group", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "mitigation_theory", "label": "Mitigation Theory", "type": "text"},
            {"key": "confidence", "label": "Confidence (0-100)", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "tool_name", "label": "Mitigation Tool", "type": "text"},
            {"key": "cost", "label": "Est. Cost", "type": "currency"}
        ],
        "prompts": {
            "narrative": """
                Act as a Chief Risk Officer. Write a '{field}' analysis for the threat context of: '{cos_text}'.
                Focus on severity, probability, and concrete mitigation steps. Avoid vague reassurances.
                Return JSON: {{ "text": "Your risk analysis here." }}
            """,
            "prerequisites": """
                For the risk scenario in '{cos_text}', what monitoring or indicators must be established first?
                Return JSON array: [{{\"indicator\": \"Metric to watch\", \"threshold\": \"Value\"}}]
            """,
            "stakeholders": """
                Who owns the risk associated with '{cos_text}' and who suffers if it fails?
                Return JSON array: [{{\"owner\": \"Role\", \"impacted_group\": \"Population\"}}]
            """,
            "assumptions": """
                What 'safety assumptions' are we making about '{cos_text}' that could be false?
                Return JSON array: [{{\"mitigation_theory\": \"We assume...\", \"confidence\": 50}}]
            """,
            "resources": """
                Suggest 3 standard frameworks or tools to mitigate risks in: '{cos_text}'.
                Return JSON array: [{{\"tool_name\": \"Framework Name\", \"cost\": \"0\"}}]
            """
        }
    },

    # ==============================================================================
    # 4. STAKEHOLDER (The Diplomat)
    # ==============================================================================
    "Stakeholder": {
        "definition": "Maps the human network, alignment, and value exchange.",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#ffca28", # Amber
        "details_schema": [
            {"key": "alignment_goal", "label": "Alignment Goal", "type": "textarea"},
            {"key": "value_proposition", "label": "Value Proposition", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "intro_path", "label": "Introduction Pathway", "type": "text"},
            {"key": "material_needs", "label": "Materials Needed", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "name", "label": "Contact Name", "type": "text"},
            {"key": "influence", "label": "Influence (0-100)", "type": "slider"},
            {"key": "stance", "label": "Stance", "type": "select", "options": ["Champion", "Neutral", "Blocker"]}
        ],
        "assumption_schema": [
            {"key": "incentive_theory", "label": "Incentive Theory", "type": "text"},
            {"key": "validated", "label": "Confirmed?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Document", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Draft", "Sent", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Community Organizer or Diplomat. Write a '{field}' that defines how to engage partners for: '{cos_text}'.
                Focus on shared value, incentives, and relationship building.
                Return JSON: {{ "text": "Your engagement strategy here." }}
            """,
            "prerequisites": """
                To engage stakeholders for '{cos_text}', what introductions or materials are prerequisites?
                Return JSON array: [{{\"intro_path\": \"Via Industry Group\", \"material_needs\": \"Pitch Deck\"}}]
            """,
            "stakeholders": """
                Who are the key decision makers or influencers for: '{cos_text}'?
                Return JSON array: [{{\"name\": \"Role/Title\", \"influence\": 80, \"stance\": \"Neutral\"}}]
            """,
            "assumptions": """
                Why do we think these stakeholders will align with '{cos_text}'?
                Return JSON array: [{{\"incentive_theory\": \"They benefit by...\", \"validated\": false}}]
            """,
            "resources": """
                What agreements or contracts are standard for: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Contract\", \"status\": \"Draft\"}}]
            """
        }
    },

    # ==============================================================================
    # 5. PRAXIS (The Operator)
    # ==============================================================================
    "Praxis": {
        "definition": "The physics of doing. Tasks, friction, and execution.",
        "icon": "fa-solid fa-rocket",
        "color": "#5c6bc0", # Indigo
        "details_schema": [
            {"key": "objective", "label": "Operational Objective", "type": "textarea", "rows": 2},
            {"key": "friction_analysis", "label": "Friction Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "dependency", "label": "Hard Dependency", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Blocked", "Ready"]}
        ],
        "stakeholder_schema": [
            {"key": "executor", "label": "Executor", "type": "text"},
            {"key": "approver", "label": "Approver", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "time_est", "label": "Time Est", "type": "text"},
            {"key": "resource_avail", "label": "Resources Available?", "type": "toggle"}
        ],
        "resource_schema": [
            {"key": "tool", "label": "Tool/Platform", "type": "text"},
            {"key": "instructions", "label": "SOP/Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Operations Director. Write a '{field}' plan to execute: '{cos_text}'.
                Focus on logistics, friction points, and clear definitions of 'done'.
                Return JSON: {{ "text": "Your operational plan here." }}
            """,
            "prerequisites": """
                What must literally be completed before the task '{cos_text}' can physically start?
                Return JSON array: [{{\"dependency\": \"Task X Complete\", \"status\": \"Blocked\"}}]
            """,
            "stakeholders": """
                Who executes and who approves the action: '{cos_text}'?
                Return JSON array: [{{\"executor\": \"Role\", \"approver\": \"Manager/Client\"}}]
            """,
            "assumptions": """
                What are the logistical assumptions regarding time and availability for '{cos_text}'?
                Return JSON array: [{{\"time_est\": \"2 Weeks\", \"resource_avail\": true}}]
            """,
            "resources": """
                What software, hardware, or SOPs are needed to perform: '{cos_text}'?
                Return JSON array: [{{\"tool\": \"Tool Name\", \"instructions\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 6. ENVIRONMENT (The Ecologist)
    # ==============================================================================
    "Environment": {
        "definition": "Analysis of physical, market, and systemic ecosystems.",
        "icon": "fa-solid fa-leaf",
        "color": "#66bb6a", # Green
        "details_schema": [
            {"key": "ecosystem", "label": "Target Ecosystem", "type": "text"},
            {"key": "impact_assessment", "label": "Impact Assessment", "type": "textarea", "rows": 4}
        ],
        "prerequisite_schema": [
            {"key": "permit", "label": "Permit/Regulation", "type": "text"},
            {"key": "baseline_data", "label": "Baseline Data", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "community", "label": "Community", "type": "text"},
            {"key": "regulator", "label": "Regulator", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "trend", "label": "Market/Climate Trend", "type": "text"},
            {"key": "stability", "label": "Stability Confidence", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Report/Study", "type": "text"},
            {"key": "url", "label": "Link", "type": "link"}
        ],
        "prompts": {
            "narrative": """
                Act as an Environmental Scientist or Systems Analyst. Write a '{field}' assessment regarding: '{cos_text}'.
                Focus on systemic impacts, circularity, and regulatory landscapes.
                Return JSON: {{ "text": "Your impact assessment here." }}
            """,
            "prerequisites": """
                What regulatory permits or environmental baselines are required for: '{cos_text}'?
                Return JSON array: [{{\"permit\": \"Permit Type\", \"baseline_data\": \"Survey Needed\"}}]
            """,
            "stakeholders": """
                Which communities or regulatory bodies act as gatekeepers for: '{cos_text}'?
                Return JSON array: [{{\"community\": \"Local Group\", \"regulator\": \"Agency\"}}]
            """,
            "assumptions": """
                What trends (market or climate) are we assuming will hold stable for '{cos_text}'?
                Return JSON array: [{{\"trend\": \"Trend Description\", \"stability\": 60}}]
            """,
            "resources": """
                Find Environmental Impact Statements or Market Studies relevant to: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Report Title\", \"url\": \"#\"}}]
            """
        }
    },

    # ==============================================================================
    # 7. TIMELINE (The Scheduler)
    # ==============================================================================
    "Timeline": {
        "definition": "Sequence, tempo, and critical path management.",
        "icon": "fa-solid fa-stopwatch",
        "color": "#ba68c8", # Purple
        "details_schema": [
            {"key": "milestone_name", "label": "Major Milestone", "type": "text"},
            {"key": "slack_analysis", "label": "Buffer Analysis", "type": "textarea"}
        ],
        "prerequisite_schema": [
            {"key": "event", "label": "Preceding Event", "type": "text"},
            {"key": "lead_time", "label": "Lead Time", "type": "text"}
        ],
        "stakeholder_schema": [
            {"key": "owner", "label": "Schedule Owner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "velocity", "label": "Velocity Assumption", "type": "text"},
            {"key": "external_factors", "label": "External Factors", "type": "text"}
        ],
        "resource_schema": [
            {"key": "event", "label": "Event", "type": "text"},
            {"key": "date", "label": "Target Date", "type": "date"}
        ],
        "prompts": {
            "narrative": """
                Act as a Project Scheduler. Write a '{field}' description for the milestone: '{cos_text}'.
                Focus on critical path dependencies, slack times, and sequencing.
                Return JSON: {{ "text": "Your timeline analysis here." }}
            """,
            "prerequisites": """
                What events must happen *before* the milestone '{cos_text}' can occur?
                Return JSON array: [{{\"event\": \"Precursor Event\", \"lead_time\": \"2 Weeks\"}}]
            """,
            "stakeholders": """
                Who is responsible for keeping the schedule for: '{cos_text}'?
                Return JSON array: [{{\"owner\": \"Project Manager / Role\"}}]
            """,
            "assumptions": """
                What assumptions about speed or external delays affect '{cos_text}'?
                Return JSON array: [{{\"velocity\": \"Standard Pace\", \"external_factors\": \"Weather/Shipping\"}}]
            """,
            "resources": """
                Suggest key calendar events or deadlines associated with: '{cos_text}'.
                Return JSON array: [{{\"event\": \"Milestone Name\", \"date\": \"2025-01-01\"}}]
            """
        }
    },

    # ==============================================================================
    # 8. ADVOCACY (The Campaigner)
    # ==============================================================================
    "Advocacy": {
        "definition": "Building momentum, narratives, and public will.",
        "icon": "fa-solid fa-bullhorn",
        "color": "#ff7043", # Orange
        "details_schema": [
            {"key": "core_narrative", "label": "Core Narrative", "type": "textarea", "rows": 3},
            {"key": "call_to_action", "label": "Call to Action", "type": "text"}
        ],
        "prerequisite_schema": [
            {"key": "asset", "label": "Creative Asset", "type": "text"},
            {"key": "platform", "label": "Platform Ready?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "audience", "label": "Target Audience", "type": "text"},
            {"key": "influencer", "label": "Influencer/Partner", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "sentiment", "label": "Sentiment Assumption", "type": "text"},
            {"key": "resonance", "label": "Resonance Score", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Campaign Asset", "type": "text"},
            {"key": "type", "label": "Format", "type": "select", "options": ["Post", "Video", "Article"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Campaign Strategist. Write a compelling '{field}' to support the goal: '{cos_text}'.
                Focus on emotion, resonance, and a clear call to action.
                Return JSON: {{ "text": "Your campaign narrative here." }}
            """,
            "prerequisites": """
                What creative assets or platform accounts must be ready before advocating for '{cos_text}'?
                Return JSON array: [{{\"asset\": \"Video/Graphics\", \"platform\": false}}]
            """,
            "stakeholders": """
                Who is the target audience for '{cos_text}' and who influences them?
                Return JSON array: [{{\"audience\": \"Demographic\", \"influencer\": \"Personality/Org\"}}]
            """,
            "assumptions": """
                What are we assuming the public feels about '{cos_text}'?
                Return JSON array: [{{\"sentiment\": \"Positive/Skeptical\", \"resonance\": 70}}]
            """,
            "resources": """
                Suggest 3 types of content content media for: '{cos_text}'.
                Return JSON array: [{{\"title\": \"Viral Video Concept\", \"type\": \"Video\"}}]
            """
        }
    },

    # ==============================================================================
    # 9. COLLABORATION (The Connector)
    # ==============================================================================
    "Collaboration": {
        "definition": "Synergy, partnerships, and joint ventures.",
        "icon": "fa-solid fa-handshake",
        "color": "#4dd0e1", # Cyan
        "details_schema": [
            {"key": "synergy_goal", "label": "Synergy Goal", "type": "textarea"},
            {"key": "governance", "label": "Governance Model", "type": "select", "options": ["Informal", "MOU", "Contractual"]}
        ],
        "prerequisite_schema": [
            {"key": "intro", "label": "Warm Intro Needed?", "type": "toggle"},
            {"key": "nda", "label": "NDA Required?", "type": "toggle"}
        ],
        "stakeholder_schema": [
            {"key": "partner_org", "label": "Partner Organization", "type": "text"},
            {"key": "poc", "label": "Point of Contact", "type": "text"}
        ],
        "assumption_schema": [
            {"key": "alignment", "label": "Alignment Assumption", "type": "textarea"},
            {"key": "resource_sharing", "label": "Sharing Willingness", "type": "slider"}
        ],
        "resource_schema": [
            {"key": "title", "label": "Agreement", "type": "text"},
            {"key": "status", "label": "Status", "type": "select", "options": ["Drafting", "Signed"]}
        ],
        "prompts": {
            "narrative": """
                Act as a Partnership Lead. Write a '{field}' regarding the alliance for: '{cos_text}'.
                Focus on shared values, resource exchange, and long-term synergy.
                Return JSON: {{ "text": "Your partnership strategy here." }}
            """,
            "prerequisites": """
                What introductions or legal safeguards (NDAs) are needed before collaborating on '{cos_text}'?
                Return JSON array: [{{\"intro\": true, \"nda\": true}}]
            """,
            "stakeholders": """
                Identify potential partner organizations for: '{cos_text}'.
                Return JSON array: [{{\"partner_org\": \"Org Name\", \"poc\": \"Title/Role\"}}]
            """,
            "assumptions": """
                Why do we assume these partners want to work on '{cos_text}'?
                Return JSON array: [{{\"alignment\": \"Strategic Fit...\", \"resource_sharing\": 80}}]
            """,
            "resources": """
                What governance documents are required for this collaboration: '{cos_text}'?
                Return JSON array: [{{\"title\": \"MOU/Teaming Agreement\", \"status\": \"Drafting\"}}]
            """
        }
    }
}

def get_valid_node_types():
    """Returns a list of all valid node type keys."""
    return list(NODES.keys())

ðŸ§© system_templates.py:
# ce_templates.py
from flask import render_template_string
from utilities import replace_ce_tags_with_pills

BASE_MODAL_TEMPLATE = """
<div class="modal fade ceModal" id="ceModal-{{ ceId }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-xl-down modal-xl" role="document">
        <div class="modal-content ce-app-shell" data-phase-index="{{ phase_index }}" style="--phase-color: var(--phase-{{ phase_index }});">
            
            <!-- HEADER (System Identity) -->
            <div class="ce-modal-header">
                <div class="node-icon-box">
                    <i class="{{ node_info.icon }}"></i>
                </div>
                <div class="header-text-block">
                    <h2 class="modal-title ce-title mb-0 text-white leading-tight">
                        {{ ceType.replace('_', ' ').upper() }}
                    </h2>
                    <div class="ce-header-metadata text-white opacity-75 small">
                        // {{ phase_name.upper() }} PHASE <span class="mx-2">|</span> ID: {{ ceId.split('-')[0].upper() }}
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3 text-white position-relative" style="z-index:10;">
                     <button class="btn btn-glass font-data d-none d-md-flex align-items-center gap-2" id="speculate-sidebar-toggle" title="Toggle Intelligence">
                        <i class="fas fa-brain"></i> ENGINE
                    </button>
                    <div class="vr bg-white opacity-50 mx-2" style="height: 24px;"></div>
                    <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="header-ghost-icon">
                    <i class="{{ node_info.icon }}"></i>
                </div>
            </div>

            <!-- READINESS BAR -->
            <div class="progress-bar-container">
                <div class="d-flex justify-content-between align-items-center mb-1" style="line-height:1;">
                    <span class="font-data small text-muted" style="font-size: 0.65rem; letter-spacing: 1px;">ANALYSIS DEPTH</span>
                    <span id="ce-progress-label" class="font-data small fw-bold text-muted">0%</span>
                </div>
                <div class="progress" style="height: 4px;">
                    <div id="ce-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- WORKSPACE -->
            <div class="modal-body ce-workspace-body p-0 d-flex">
                
                <!-- LEFT COLUMN -->
                <div class="ce-main-column">
                    <ul class="nav nav-tabs ce-nav-tabs pt-2 px-4 bg-white" role="tablist">
                        <li class="nav-item"><button class="nav-link font-data active" data-bs-toggle="tab" data-bs-target="#view-overview-{{ ceId }}">OVERVIEW</button></li>
                        <li class="nav-item"><button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-narrative-{{ ceId }}">NARRATIVE</button></li>
                        
                        {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                        <li class="nav-item">
                            <button class="nav-link font-data" data-bs-toggle="tab" data-bs-target="#view-{{ collection }}-{{ ceId }}">
                                {{ collection|upper }} 
                                <span class="badge rounded-pill bg-light text-dark border ms-1 count-badge" data-collection="{{ collection }}">0</span>
                            </button>
                        </li>
                        {% endfor %}
                        
                        <li class="nav-item ms-auto"><button class="nav-link font-data text-muted" data-bs-toggle="tab" data-bs-target="#view-connections-{{ ceId }}"><i class="fas fa-project-diagram"></i></button></li>
                    </ul>

                    <!-- CONTENT AREA -->
                    <div class="ce-app-content tab-content flex-grow-1 overflow-y-auto bg-surface-screen position-relative">
                        <div class="bg-technical-grid position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none; z-index: 0;"></div>
                        
                        <div class="position-relative p-4" style="z-index: 1;">
                            
                            <!-- 1. OVERVIEW -->
                            <div class="tab-pane fade show active" id="view-overview-{{ ceId }}">
                                <div class="row g-4">
                                    <div class="col-lg-8">
                                        <div class="system-status-card">
                                            <div class="status-ghost"><i class="{{ node_info.icon }}"></i></div>
                                            <div class="scan-overlay" style="display:none;"></div>
                                            <div class="font-data text-white-50 small mb-2 letter-spacing-2">SYSTEM STATUS</div>
                                            <div class="status-card-value text-white display-4 font-brand mb-4 text-shadow-sm">INITIALIZED</div>
                                            <div class="p-3 rounded bg-white bg-opacity-10 border border-white border-opacity-25 backdrop-blur">
                                                <div class="d-flex gap-3">
                                                    <i class="fas fa-info-circle text-white mt-1"></i>
                                                    <div>
                                                        <div class="font-data text-white small mb-1">CONTEXTUAL INSIGHT</div>
                                                        <p class="font-body text-white mb-0 small opacity-90">
                                                            {{ ai_generated_data.contextual_description or 'System standby. Speculation engine ready.' }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="card metric-card border-0 shadow-sm h-100">
                                            <div class="card-body d-flex flex-column justify-content-center text-center p-4">
                                                <div class="font-data text-muted small mb-2">RESOURCE DENSITY</div>
                                                <div class="display-2 font-brand text-secondary resource-counter">0</div>
                                            </div>
                                            <div class="card-footer bg-light border-top-0 text-center p-3">
                                                <span class="badge bg-success font-data"><span id="verified-counter">0</span> VERIFIED</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 card border-0 shadow-sm">
                                    <div class="card-body p-4">
                                        <h6 class="font-data text-muted small mb-3">SOURCE CONDITION PROTOCOL</h6>
                                        <div class="font-body fst-italic text-dark fs-5">{{ cos_content_with_pills | safe }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. NARRATIVE -->
                            <div class="tab-pane fade" id="view-narrative-{{ ceId }}">
                                <div class="details-form-container mx-auto" style="max-width: 900px;">
                                    <form id="narrative-form-{{ ceId }}">
                                    {% for field in node_info.details_schema %}
                                    <div class="mb-5">
                                        <div class="d-flex justify-content-between align-items-end mb-2 border-bottom pb-2">
                                            <label class="font-data text-dark h5 mb-0">{{ field.label }}</label>
                                            <button type="button" class="btn btn-sm btn-link text-decoration-none font-data text-primary btn-enhance-field" data-field="{{ field.key }}"><i class="fas fa-magic me-1"></i> ENHANCE</button>
                                        </div>
                                        <textarea name="{{ field.key }}" class="form-control border-0 bg-white shadow-sm p-4 font-body fs-6" rows="5" placeholder="Drafting strategy...">{{ ce_data.data.details_data.get(field.key, '') }}</textarea>
                                    </div>
                                    {% endfor %}
                                    </form>
                                </div>
                            </div>

                            <!-- 3-6. COLLECTIONS -->
                            {% for collection in ['prerequisites', 'stakeholders', 'assumptions', 'resources'] %}
                            <div class="tab-pane fade d-flex flex-column h-100" id="view-{{ collection }}-{{ ceId }}">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="btn-group shadow-sm">
                                        <button class="btn btn-white font-data px-4 btn-add-item" data-collection="{{ collection }}"><i class="fas fa-plus me-2 text-muted"></i> MANUAL</button>
                                        <button class="btn btn-white font-data px-4 text-primary btn-speculate-collection" data-collection="{{ collection }}"><i class="fas fa-brain me-2"></i> AUTO-GEN</button>
                                    </div>
                                    <input type="text" class="form-control w-auto border-0 shadow-sm font-body" placeholder="Search {{ collection }}...">
                                </div>
                                <div class="collection-container" id="container-{{ collection }}-{{ ceId }}" data-collection="{{ collection }}"></div>
                                
                                <!-- EDITOR (Hidden) -->
                                <div class="collection-editor p-4 bg-white border-top shadow-lg position-absolute bottom-0 start-0 w-100" id="editor-{{ collection }}-{{ ceId }}" style="display:none; z-index: 50;">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="font-brand">NEW ENTRY</h5>
                                        <button type="button" class="btn-close btn-cancel-edit"></button>
                                    </div>
                                    <form class="editor-form" data-collection="{{ collection }}">
                                        {% set schema_key = collection[:-1] + '_schema' %} 
                                        {% set schema = node_info.get(schema_key, []) %}
                                        <div class="row g-3">
                                            {% for field in schema %}
                                            <div class="col-12 {{ 'col-md-6' if field.type != 'textarea' else '' }}">
                                                <label class="font-data text-muted small mb-1">{{ field.label }}</label>
                                                {% if field.type == 'textarea' %}
                                                    <textarea name="{{ field.key }}" class="form-control bg-light" rows="2"></textarea>
                                                {% elif field.type == 'select' %}
                                                    <select name="{{ field.key }}" class="form-select font-body">{% for option in field.options %}<option value="{{ option }}">{{ option }}</option>{% endfor %}</select>
                                                {% elif field.type == 'slider' %}
                                                    <div class="ce-range-wrap"><input type="range" class="ce-range-input" name="{{ field.key }}" min="0" max="100" step="10"><span class="ce-range-value">50%</span></div>
                                                {% elif field.type == 'toggle' %}
                                                    <div class="mt-2"><label class="ce-toggle-switch"><input type="checkbox" name="{{ field.key }}"><span class="ce-toggle-slider"></span></label></div>
                                                {% else %}
                                                    <input type="text" name="{{ field.key }}" class="form-control">
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-4 text-end"><button type="submit" class="btn btn-success font-data px-4 rounded-pill">SAVE ENTRY</button></div>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- CONNECTIONS -->
                            <div class="tab-pane fade p-4" id="view-connections-{{ ceId }}">
                                <div class="text-center p-5 opacity-50"><i class="fas fa-project-diagram fa-4x mb-3"></i><h4 class="font-brand text-muted">NETWORK GRAPH</h4><p>No active vector connections.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="ai-sidebar d-flex flex-column border-start bg-white">
                    <div class="sidebar-persona-header" id="ai-sidebar-header"></div>
                    <div class="p-3 flex-grow-1 overflow-y-auto" id="ai-sidebar-content"></div>
                </div>

            </div>
            
            <!-- FOOTER: DYNAMIC SAVE BUTTON -->
            <div class="modal-footer ce-modal-footer bg-white border-top d-flex justify-content-between">
                <div class="font-data text-muted small" id="save-status">STATUS: UNSAVED</div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary font-data px-4 rounded-pill" data-bs-dismiss="modal">EXIT</button>
                    <!-- Updated to show CE Type dynamically -->
                    <button type="button" class="btn btn-primary font-data px-4 rounded-pill btn-save-changes">
                        SAVE {{ ceType.upper() }}
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>
"""

async def generate_dynamic_modal(ce_type, ce_text, ce_data, node_info, cos_content, ai_generated_data, phase_name, phase_index):
    ce_id_str = str(ce_data.get('id', 'new_ce'))
    cos_content_with_pills = replace_ce_tags_with_pills(cos_content)
    return render_template_string(
        BASE_MODAL_TEMPLATE,
        ceId=ce_id_str,
        ceType=ce_type,
        ce_text=ce_text,
        ce_data=ce_data,
        node_info=node_info,
        cos_content_with_pills=cos_content_with_pills,
        ai_generated_data=ai_generated_data,
        phase_name=phase_name,
        phase_index=phase_index
    )

ðŸŸ¥ routes.py:
# routes.py
import os
import json
import uuid
import logging
import asyncio
import pdfkit
from uuid import UUID
from dotenv import load_dotenv
from bs4 import BeautifulSoup
from app import USE_DATABASE
from ce_nodes import NODES
from werkzeug.exceptions import BadRequest, NotFound
from models import get_engine_and_session, SSOL, COS
from ce_templates import generate_dynamic_modal
from ai_service import cleanup_gemini_client, generate_chat_response
from flask import Blueprint, render_template, request, flash, redirect, url_for, \
                    jsonify, make_response, current_app, send_from_directory
from utilities import generate_goal, analyze_user_input, is_input_compliant, \
                    generate_outcome_data, generate_ai_data, generate_image
from speculate import get_ce_by_id as speculate_get_ce_by_id, \
                      update_ce_by_id as speculate_update_ce_by_id, \
                      create_cos as speculate_create_cos, \
                      get_cos_by_id as speculate_get_cos_by_id, \
                      update_cos_by_id as speculate_update_cos_by_id, \
                      delete_cos_by_id as speculate_delete_cos_by_id, \
                      analyze_cos as speculate_analyze_cos, \
                      create_ssol as speculate_create_ssol

load_dotenv()

routes_bp = Blueprint('routes_bp', __name__)

# --- Lifecycle Management ---
@routes_bp.teardown_app_request
async def teardown_request(exception=None):
    """Clean up AI resources after each request."""
    await cleanup_gemini_client()

# --- Utility Routes ---
@routes_bp.route('/favicon.ico')
def favicon():
    return send_from_directory(os.path.join(current_app.root_path, 'static'), 'favicon.ico', mimetype='image/vnd.microsoft.icon')

# --- Basic Pages ---
@routes_bp.route('/')
def index():
    return render_template('input.html')

@routes_bp.route('/about')
def about():
    return render_template('about.html')

# --- Goal Selection ---
@routes_bp.route('/goal_selection', methods=['POST'])
async def goal_selection():
    if request.method == 'POST':
        user_input = request.form['user_text'].strip()
        if not user_input:
            flash("Please enter your possibility or goal.", "error")
            return render_template('input.html')
        try:
            current_app.logger.info(f"User Input: '{user_input}'. Calling generate_goal...")
            goal_options = await generate_goal(user_input)

            if not goal_options:
                flash("Could not generate goal options. Please try again or rephrase your input.", "warning")
                return render_template('input.html')

            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return jsonify(goals=goal_options, user_input=user_input)

            return render_template('goal_selection.html', goals=goal_options, user_input=user_input)
        except Exception as e:
            current_app.logger.error(f"Unexpected error in goal_selection: {e}", exc_info=True)
            flash(f"An unexpected error occurred: {e}", "error")
            return render_template('input.html', user_text=user_input)
    return redirect(url_for('routes_bp.index'))

# --- Outcome Generation ---
@routes_bp.route('/outcome', methods=['POST'])
async def outcome():
    if request.method == 'POST':
        selected_goal_text = request.form.get('selected_goal', '').strip()
        domain = request.form.get('domain', '').strip()
        selected_goal_title = request.form.get('selected_goal_title', '').strip()
        domain_icon = request.form.get('domain_icon', '').strip()

        if not selected_goal_text:
            flash("No goal selected. Please try again.", "error")
            return redirect(url_for('routes_bp.index'))
            
        try:
            # 1. Create SSOL Container (The Vehicle)
            # We pass the domain so the AI knows the context immediately.
            ssol_id_str = speculate_create_ssol(
                USE_DATABASE, 
                selected_goal_title, 
                selected_goal_text, 
                domain=domain
            )
            ssol_id_uuid = UUID(ssol_id_str)
            current_app.logger.info(f"SSOL created with ID: {ssol_id_str}")
            
            # 2. Generate Structure via AI (The Map)
            current_app.logger.info("Generating structured solution from AI...")
            structured_solution_json = await generate_outcome_data(
                ssol_title=selected_goal_title, 
                ssol_description=selected_goal_text, 
                domain=domain
            )
            ssol_summary = structured_solution_json.get('ssolsummary', 'AI failed to generate a summary.')

            # 3. Save COS Items (The Route)
            current_app.logger.info("Saving generated COS and their CEs...")
            phases_for_template = {}
            
            if 'phases' in structured_solution_json:
                for phase_name, cos_items in structured_solution_json['phases'].items():
                    phases_for_template[phase_name] = []
                    for cos_content_with_tags in cos_items:
                        if cos_content_with_tags:
                            # A. Create the COS record (Auto-generates CEs internally)
                            new_cos_id_str = await speculate_create_cos(
                                USE_DATABASE, 
                                ssol_id=ssol_id_uuid, 
                                content=cos_content_with_tags, 
                                status='Proposed'
                            )
                            
                            # B. Retrieve the Full Data Object
                            # NOTE: We updated get_cos_by_id to return a DICTIONARY to prevent
                            # "DetachedInstanceError" when accessing relationships outside the session.
                            newly_created_cos_dict = speculate_get_cos_by_id(
                                USE_DATABASE, 
                                UUID(new_cos_id_str)
                            )
                            
                            # C. Add to Template Data
                            if newly_created_cos_dict:
                                phases_for_template[phase_name].append(newly_created_cos_dict)

            outcome_data_for_template = {
                'ssol_id': ssol_id_str,
                'ssol_title': selected_goal_title,
                'selected_goal': selected_goal_text,
                'domain': domain,
                'domain_icon': domain_icon,
                'ssol_summary': ssol_summary,
                'phases': phases_for_template,
            }

            # 4. Async Image Generation (The "Vibe")
            # Non-blocking; the frontend polls for this image separately.
            try:
                current_app.logger.info("Dispatching image generation task...")
                image_prompt = f"""A vibrant, isometric, mid-century retro illustration of '{selected_goal_title}: {selected_goal_text}' 
                                    fulfilled, painterly lithograph style, 1950s Popular Science magazine cover, 
                                    saturated colors, idealized realism, optimistic composition, featuring 
                                    people of diverse ethnicities, ages, genders, and abilities, no text.
                                    """
                await generate_image(image_prompt, ssol_id_str)
            except Exception as img_exc:
                # Don't crash the app if the image fails
                current_app.logger.error(f"Image generation failed for SSOL {ssol_id_str}: {img_exc}")

            return render_template('outcome.html', ssol=outcome_data_for_template, nodes=NODES, ssol_id=ssol_id_str)

        except Exception as e:
            current_app.logger.error(f"CRITICAL error in /outcome: {e}", exc_info=True)
            flash(f"A critical error occurred while generating the solution. Error: {e}", "error")
            return redirect(url_for('routes_bp.index'))

    return redirect(url_for('routes_bp.index'))

# --- Modal Generation (The Speculation Environment Shell) ---
@routes_bp.route('/get_ce_modal/<string:ce_type>', methods=['POST'])
async def get_ce_modal_route(ce_type):
    try:
        data = request.get_json()
        ce_id_str = data.get('ce_id')
        ce_text = data.get('ce_text', 'Conditional Element')

        ce_id_obj = UUID(ce_id_str) if ce_id_str else None
        ce_data = speculate_get_ce_by_id(USE_DATABASE, ce_id_obj) if ce_id_obj else {}
        
        # Initialize data structure if empty or missing
        if not ce_data or 'data' not in ce_data:
            ce_data = {
                'id': ce_id_str, 
                'node_type': ce_type, 
                'data': {
                    'details_data': {}, 
                    'resources': [],
                    'prerequisites': [],
                    'stakeholders': [],
                    'assumptions': [],
                    'connections': []
                }
            }

        node_config = NODES.get(ce_type, NODES['Default'])
        
        # Get basic context (Overview) from AI
        cos_content_html = data.get('cos_content', '')
        cos_content_text = BeautifulSoup(cos_content_html, 'html.parser').get_text(separator=' ', strip=True)
        
        ai_generated_data = await generate_ai_data(
            node_type=ce_type,
            cos_content=cos_content_text,
            ssol_goal=data.get('ssol_goal', ''),
            agent_mode='context'
        )

        modal_html = await generate_dynamic_modal(
            ce_type=ce_type,
            ce_text=ce_text,
            ce_data=ce_data,
            node_info=node_config,
            cos_content=cos_content_html,
            ai_generated_data=ai_generated_data,
            phase_name=data.get('phase_name', ''),
            phase_index=data.get('phase_index', 0)
        )
        
        return jsonify(modal_html=modal_html, ce_data=ce_data)

    except Exception as e:
        current_app.logger.error(f"Error in get_ce_modal_route: {e}", exc_info=True)
        return jsonify(error=f"An error occurred: {str(e)}"), 500


# --- THE UNIVERSAL INTELLIGENCE ROUTE (The Brain) ---
@routes_bp.route('/speculate_context', methods=['POST'])
async def speculate_context_route():
    """
    The Universal Brain of the Speculation Environment.
    It handles two types of requests:
    1. 'collections': Generating lists of items (Prerequisites, Stakeholders, etc.)
    2. 'narrative': generating text for specific details fields (Summary, Context, etc.)
    """
    try:
        data = request.get_json()
        ce_type = data.get('ce_type')           # e.g. 'Research', 'Risk'
        context = data.get('context')           # e.g. 'prerequisites', 'narrative'
        sub_context = data.get('sub_context')   # e.g. 'summary' (only for narrative)
        cos_text = data.get('cos_text', 'Achieve the goal.')

        # 1. Load Node Configuration & Prompts
        # Fallback to Default if the specific node type isn't found
        node_config = NODES.get(ce_type, NODES['Default'])
        prompts_map = node_config.get('prompts', {})
        
        # Ensure we have access to Default prompts if the specific node misses one
        default_prompts = NODES['Default'].get('prompts', {})

        final_prompt = ""
        system_instruction = "You are the SPECULATE Engine. Respond ONLY with valid JSON. Do not use markdown formatting."

        # 2. Branch Logic: Narrative vs. Collections
        if context == 'narrative':
            # --- Narrative Mode (Text Generation) ---
            
            # Try to find a specific narrative prompt, otherwise use a smart fallback
            raw_prompt = prompts_map.get('narrative', default_prompts.get('narrative'))
            
            if not raw_prompt:
                # Hard fallback if not defined in nodes yet
                raw_prompt = """
                Act as a strategic project manager. Write a professional 1-paragraph '{field}' 
                for a '{node_type}' element needed to achieve: '{cos_text}'.
                Focus on clarity, actionability, and value.
                Return strictly JSON: {{ "text": "Your generated text here." }}
                """
            
            # Inject the specific field name (e.g. 'Executive Summary') and context
            field_label = sub_context.replace('_', ' ').title() if sub_context else "Description"
            final_prompt = raw_prompt.format(
                cos_text=cos_text, 
                field=field_label, 
                node_type=ce_type
            )

        else:
            # --- Collection Mode (List Generation) ---
            
            # Retrieve the specific collection prompt (e.g., for 'prerequisites')
            raw_prompt = prompts_map.get(context, default_prompts.get(context))
            
            if not raw_prompt:
                # Hard fallback
                raw_prompt = f"Analyze '{cos_text}'. List 3 strategic items for {{context}}. Return JSON array."
            
            # Inject context
            final_prompt = raw_prompt.format(cos_text=cos_text)

        # 3. Execute SPECULATE Engine (AI Call)
        current_app.logger.info(f"Speculating {ce_type} -> {context} ({sub_context or 'list'})")
        
        ai_response_str = await generate_chat_response(
            messages=[{"role": "user", "content": final_prompt}], 
            role="Speculate Engine", 
            task=f"Speculate {context}",
            system_instruction=system_instruction,
            temperature=0.7
        )
        
        # 4. Clean and Parse JSON
        try:
            # Strip Markdown backticks if present (Common LLM artifact)
            cleaned_response = ai_response_str.replace("```json", "").replace("```", "").strip()
            parsed_json = json.loads(cleaned_response)
        except json.JSONDecodeError:
            current_app.logger.warning(f"Failed to parse AI JSON: {ai_response_str}")
            return jsonify({'success': False, 'error': 'AI returned invalid format. Please try again.'}), 500

        # 5. Return Formatted Data
        if context == 'narrative':
            # Expecting object: { "text": "..." }
            text_content = parsed_json.get('text', '') if isinstance(parsed_json, dict) else str(parsed_json)
            return jsonify({
                'success': True, 
                'text': text_content, 
                'field': sub_context
            })
        else:
            # Expecting list: [ {...}, {...} ]
            # Handle case where AI wraps list in a root object like { "items": [...] }
            if isinstance(parsed_json, dict):
                # Try to find the first list value
                for key, val in parsed_json.items():
                    if isinstance(val, list):
                        suggestions = val
                        break
                else:
                    suggestions = [] # Fallback
            elif isinstance(parsed_json, list):
                suggestions = parsed_json
            else:
                suggestions = []

            return jsonify({
                'success': True, 
                'suggestions': suggestions, 
                'context': context
            })

    except Exception as e:
        current_app.logger.error(f"Speculation Error in routes: {e}", exc_info=True)
        return jsonify({'success': False, 'error': str(e)}), 500

# --- Data Operations (CRUD) ---

@routes_bp.route('/update_ce/<uuid:ce_id>', methods=['PUT'])
def update_ce_route(ce_id):
    try:
        data = request.get_json()
        if not data: raise BadRequest('No JSON payload')
        
        # We store the entire structure (collections + details) in the 'data' JSON column
        success = speculate_update_ce_by_id(USE_DATABASE, ce_id, data)
        
        if success:
            return jsonify(success=True), 200
        return jsonify(success=False, error="Update failed"), 500
    except Exception as e:
        current_app.logger.error(f"Error updating CE {ce_id}: {e}")
        return jsonify(success=False, error=str(e)), 500


@routes_bp.route('/create_cos', methods=['POST'])
async def create_cos_route():
    try:
        data = request.get_json()
        new_cos_id = await speculate_create_cos(
            USE_DATABASE, 
            UUID(data['ssol_id']), 
            data['content'], 
            data.get('status', 'Proposed'),
            data.get('accountable_party'),
            data.get('completion_date')
        )
        if new_cos_id:
            cos_obj = speculate_get_cos_by_id(USE_DATABASE, UUID(new_cos_id))
            return jsonify(success=True, cos=cos_obj.to_dict() if USE_DATABASE else cos_obj), 201
        return jsonify(success=False, error="Creation failed"), 500
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/update_cos/<uuid:cos_id>', methods=['PUT'])
async def update_cos_route(cos_id):
    try:
        data = request.get_json()
        result = await speculate_update_cos_by_id(USE_DATABASE, cos_id, data)
        if result['success']: return jsonify(success=True, cos=result['cos'])
        return jsonify(success=False, error=result['message']), result['status_code']
    except Exception as e:
        return jsonify(success=False, error=str(e)), 500

@routes_bp.route('/delete_cos/<uuid:cos_id>', methods=['DELETE'])
def delete_cos_route(cos_id):
    if speculate_delete_cos_by_id(USE_DATABASE, cos_id):
        return jsonify(success=True)
    return jsonify(success=False, error="Deletion failed"), 404


# --- Image & Export Operations ---

@routes_bp.route('/get_ssol_image/<uuid:ssol_id>')
def get_ssol_image_route(ssol_id):
    img_path = f"images/ssol_image_{ssol_id}.png"
    full_path = os.path.join(current_app.static_folder, img_path)
    if os.path.exists(full_path):
        return jsonify({'image_path': url_for('static', filename=img_path), 'status': 'found'})
    return jsonify({'status': 'pending_or_not_found'}), 200

@routes_bp.route('/save_as_pdf/<uuid:ssol_id>', methods=['POST'])
def save_as_pdf(ssol_id):
    try:
        data = request.get_json()
        if not data or 'htmlContent' not in data:
            raise ValueError("Invalid request: No HTML content provided.")
        html_content = data['htmlContent']

        css_file_path = os.path.join(current_app.root_path, 'static', 'styles.css')
        css_param = css_file_path if os.path.exists(css_file_path) else None

        # Convert relative paths to absolute
        html_content = html_content.replace('src="/static/', f'src="{url_for("static", filename="", _external=True)}')

        options = {
            "page-size": "Letter", "margin-top": "0.75in", "margin-right": "0.75in",
            "margin-bottom": "0.75in", "margin-left": "0.75in", "encoding": "UTF-8",
            "no-outline": None, "enable-local-file-access": None,
        }

        pdf = pdfkit.from_string(html_content, False, options=options, css=css_param)

        response = make_response(pdf)
        response.headers['Content-Type'] = 'application/pdf'
        response.headers['Content-Disposition'] = f'attachment; filename="SSPEC_Solution_{ssol_id}.pdf"'
        return response

    except Exception as e:
        current_app.logger.error(f"Exception in save_as_pdf for SSOL {ssol_id}: {e}", exc_info=True)
        return jsonify(success=False, error=str(e)), 500

# --- Input Analysis ---

@routes_bp.route('/analyze_input', methods=['POST'])
async def analyze_input_route():
    try:
        txt = request.form.get('user_text')
        if not txt: return jsonify({'error': 'No text'}), 400
        return jsonify({
            'keywords': await analyze_user_input(txt), 
            'compliance': await is_input_compliant(txt)
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

ðŸ“± app.py:
# app.py (Final Refactor using Application Factory Pattern)
import os
import logging
import asyncio
import sys
from flask import Flask
from flask_migrate import Migrate
from dotenv import load_dotenv
from models import db # Only import the 'db' object from models
import colorlog
from ce_nodes import NODES

# --- FIX for asyncio on Windows ---
# This is the standard fix for `RuntimeError: Event loop is closed` on Windows.
if sys.platform == "win32":
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
# --- END FIX ---

load_dotenv()

# --- 1. Create App and Extension Instances (Uninitialized) ---
app = Flask(__name__)
migrate = Migrate() # Create the Migrate object, but don't connect it to the app yet.

# --- App Configuration ---
app.secret_key = os.environ.get('SECRET_KEY', 'a_very_secret_default_key')
USE_DATABASE = os.environ.get('USE_DATABASE', 'False').lower() in ('true', '1', 't', 'y', 'yes')

# --- Logger Configuration ---
handler = colorlog.StreamHandler()
handler.setFormatter(colorlog.ColoredFormatter(
    '%(log_color)s%(asctime)s - %(name)s - %(levelname)s - %(message)s'
))
logger = logging.getLogger()
logger.setLevel(logging.INFO)
if not logger.handlers:
    logger.addHandler(handler)

# --- Jinja Filter ---
@app.template_filter()
def get_badge_class_from_status(status):
   return {
       'Proposed': 'bg-info',
       'In Progress': 'bg-warning text-dark',
       'Completed': 'bg-success',
       'Rejected': 'bg-danger'
   }.get(status, 'bg-secondary')

@app.context_processor
def inject_nodes():
    """Injects the NODES dictionary into all templates."""
    return dict(nodes=NODES)

# --- 2. Initialize Extensions Conditionally ---
# This is the core of the fix. We now initialize the extensions inside the 'if' block.
if USE_DATABASE:
    app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('SQLALCHEMY_DATABASE_URI')
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    app.config['SQLALCHEMY_ECHO'] = os.environ.get('SQLALCHEMY_ECHO', 'False').lower() in ('true', '1', 't')

    # Now, connect the db and migrate objects to the configured app.
    # This ensures the 'db' command is registered only when USE_DATABASE is true.
    db.init_app(app)
    migrate.init_app(app, db)

# --- 3. Blueprint Registration ---
# Import blueprints AFTER the app is configured.
from routes import routes_bp
app.register_blueprint(routes_bp)

# --- Main Execution (for `python app.py`) ---
if __name__ == '__main__':
    # This block is for direct execution and is not run by the 'flask' command.
    app.run(debug=True, port=5000)

ðŸŸ¨ utilities.py:
# utilities.py

import logging
import json
import re
import uuid
from typing import Dict, List
from bs4 import BeautifulSoup
from flask import current_app

# Import AI services
from ai_service import generate_chat_response, get_grounded_data, generate_image

# Local Imports
from ce_nodes import NODES, get_valid_node_types

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO)

# --- HELPER: CE Pill Rendering ---

def replace_ce_tags_with_pills(content):
    """
    Parses COS content, finds <ce> tags, and replaces them with interactive
    HTML pills using the Horizon styling structure.
    """
    if not content:
        return ""

    # Delayed imports to avoid circular dependencies with models
    from app import USE_DATABASE
    from store import ce_store
    from models import CE, get_engine_and_session
    from uuid import UUID

    soup = BeautifulSoup(str(content), 'html.parser')
    ce_tags = soup.find_all('ce')

    for tag in ce_tags:
        ce_id_str = tag.get('id')
        ce_type = tag.get('type', 'Default')
        ce_text = tag.get_text()
        
        resource_count = 0
        
        # --- 1. Fetch Resource Count (Optional, for badges) ---
        try:
            if ce_id_str:
                if USE_DATABASE:
                    engine, SessionLocal = get_engine_and_session()
                    session = SessionLocal()
                    try:
                        ce_uuid = UUID(ce_id_str)
                        ce_instance = session.query(CE).get(ce_uuid)
                        if ce_instance and ce_instance.data:
                            data_payload = ce_instance.data
                            if isinstance(data_payload, str):
                                data_payload = json.loads(data_payload)
                            resources = data_payload.get('resources', [])
                            resource_count = len(resources)
                    except Exception as db_err:
                        logging.warning(f"Error fetching CE count: {db_err}")
                    finally:
                        session.close()
                else:
                    # Fallback for in-memory store
                    ce_data = ce_store.get(ce_id_str, {})
                    if ce_data and 'data' in ce_data:
                        resource_count = len(ce_data['data'].get('resources', []))
        except Exception as e:
            logging.error(f"Error in replace_ce_tags_with_pills: {e}")

        # --- 2. Build Horizon Pill HTML ---
        
        # Get node config
        node_config = NODES.get(ce_type, NODES['Default'])
        node_color = node_config.get('color', '#6c757d')
        node_icon = node_config.get('icon', 'fa-solid fa-cube')

        # Container (Capsule)
        new_tag = soup.new_tag('span', attrs={
            'class': 'ce-pill', 
            'data-ce-id': ce_id_str,
            'data-ce-type': ce_type,
            'title': f"{ce_type} | Click to Configure",
            'style': f'--node-color: {node_color};' 
        })
        
        # Icon Box
        icon_span = soup.new_tag('span', attrs={'class': 'ce-pill-icon'})
        i_tag = soup.new_tag('i', attrs={'class': node_icon})
        icon_span.append(i_tag)
        new_tag.append(icon_span)
        
        # Text
        text_span = soup.new_tag('span', attrs={'class': 'ce-pill-text'})
        text_span.string = ce_text
        new_tag.append(text_span)

        # Optional Count Badge
        if resource_count > 0:
            count_badge = soup.new_tag('span', attrs={
                'class': 'badge bg-secondary ms-1 rounded-pill', 
                'style': 'font-size: 0.6em; opacity: 0.8;'
            })
            count_badge.string = str(resource_count)
            new_tag.append(count_badge)

        tag.replace_with(new_tag)

    return str(soup)


# --- GOAL SELECTION & INPUT ANALYSIS ---

async def generate_goal(user_input: str) -> List[Dict]:
    prompt = f"""
    Based on the user input '{user_input}', generate three distinct, high-level goal options. 
    Each goal must be a JSON object with keys: "domain", "title", "goal", "icon", "is_compliant". 
    
    ICON RULES:
    Use 'FontAwesome 6 Free' classes (e.g., 'fa-solid fa-rocket').
    
    Output Format: JSON Array of 3 objects.
    """
    
    system_instruction = "You are a JSON-only API."
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="goal generation", system_instruction=system_instruction)
        # Clean markdown
        response_str = response_str.replace("```json", "").replace("```", "").strip()
        
        ai_goals = json.loads(response_str)

        validated_goals = []
        for goal in ai_goals:
            if not isinstance(goal, dict): continue
            validated_goals.append({
                'domain': goal.get('domain', 'General'),
                'title': goal.get('title', 'Untitled Goal'),
                'goal': goal.get('goal', 'No description provided.'),
                'icon': goal.get('icon', 'fa-solid fa-question-circle'),
                'is_compliant': goal.get('is_compliant', goal.get('iscompliant', True))
            })
        return validated_goals
    except Exception as e:
        logging.error(f"Error in generate_goal: {e}", exc_info=True)
        return []

async def analyze_user_input(user_text: str) -> List[str]:
    prompt = f'Analyze the text and extract 3-5 key themes. Text: "{user_text}". Return JSON object: {{ "keywords": [] }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="keyword extraction")
        response_str = response_str.replace("```json", "").replace("```", "").strip()
        result = json.loads(response_str)
        return result.get('keywords', [])
    except Exception as e:
        return []

async def is_input_compliant(user_text: str) -> dict:
    prompt = f'Analyze compliance. Text: "{user_text}". Return JSON: {{ "compliant": boolean, "reason": string }}'
    try:
        messages = [{"role": "user", "content": prompt}]
        response_str = await generate_chat_response(messages, role="user", task="compliance check")
        response_str = response_str.replace("```json", "").replace("```", "").strip()
        result = json.loads(response_str)
        return {"compliant": result.get('compliant', True), "reason": result.get('reason', '')}
    except Exception as e:
        return {"compliant": False, "reason": "System error."}


# --- OUTCOME & CE GENERATION ---

async def generate_outcome_data(ssol_title, ssol_description, domain):
    node_types_str = ', '.join(get_valid_node_types())
    
    prompt = f"""
    Act as a Visionary Systems Architect.
    GOAL: Generate a Structured Solution (SSOL) for: '{ssol_title}' in domain '{domain}'.
    CONTEXT: {ssol_description}
    
    FRAMEWORK INSTRUCTIONS:
    The solution must follow the SSPEC 5-Phase Methodology. 
    For each phase, you must define 3-5 "Conditions of Satisfaction" (COS).
    
    CRITICAL LOGIC FOR COS:
    1. A COS is not a task; it is a STATE OF REALITY. 
    2. Collectively, the COS list must act as a "Checksum" for the phase. If all COS are marked "Complete", the Phase must be undeniably finished.
    3. Phrasing: Use passive past tense or future perfect tense (e.g., "Permits have been acquired" NOT "Acquire permits").
    
    PHASE DEFINITIONS:
    - Discovery: The feasibility and parameters are fully defined.
    - Engagement: The network, stakeholders, and permissions are locked in.
    - Action: The physical or digital execution is performed.
    - Completion: The output is verified against the integrity score.
    - Legacy: The systemic impact is secured for the future.

    FORMATTING RULES FOR CEs:
    Embed "Conditional Elements" (CEs) directly into the COS text using XML tags:
    <ce type="NodeType">Label</ce>
    
    Example: 
    "A binding MOU has been signed by the <ce type='Stakeholder'>Regional Director</ce> covering all <ce type='Risk'>Liability Concerns</ce>."
    
    Valid Types: {node_types_str}.
    
    Response Format (JSON ONLY):
    {{
        "ssolsummary": "<p>...</p>",
        "phases": {{
            "Discovery": ["COS Sentence 1...", "COS Sentence 2..."],
            "Engagement": [...],
            "Action": [...],
            "Completion": [...],
            "Legacy": [...]
        }}
    }}
    """
    
    # Increase temp slightly for creative problem solving
    messages = [{"role": "user", "content": prompt}]
    response_str = await generate_chat_response(messages, role="user", task="ssol generation", temperature=0.7)
    
    # Clean markdown wrappers if present
    clean_json = response_str.replace("```json", "").replace("```", "").strip()
    
    try:
        return json.loads(clean_json)
    except json.JSONDecodeError:
        logging.error(f"Failed to parse AI JSON for SSOL. Response: {clean_json}")
        return {
            "ssolsummary": "<p>Error generating solution structure. Please try again.</p>",
            "phases": {}
        }


async def generate_ai_data(node_type: str, cos_content: str, ssol_goal: str, agent_mode: str = 'context') -> dict:
    """Generates context data for a specific Node Modal."""
    node_config = NODES.get(node_type, NODES['Default'])
    query_context = f"Overall Goal: '{ssol_goal}'. Requirement: '{cos_content}'."
    
    try:
        if agent_mode == 'speculate':
            # Use grounded search (Placeholder logic for now)
            return await get_grounded_data(f"Research {node_type} for {ssol_goal}", node_type)
            
        else: # Context mode (Narrative generation)
            prompt = f"Briefly explain the strategic purpose of this '{node_type}' element in the Context: {query_context}. Return JSON with key 'contextual_description'."
            messages = [{"role": "user", "content": prompt}]
            response_str = await generate_chat_response(messages, role="user", task="contextual insight")
            response_str = response_str.replace("```json", "").replace("```", "").strip()
            return json.loads(response_str)

    except Exception as e:
        logging.error(f"Error in generate_ai_data ({agent_mode}): {e}", exc_info=True)
        return {}

ðŸª store.py:
# store.py  
ssol_store = {}  
cos_store = {}  
ce_store = {}  

ðŸ³ï¸â€ðŸŒˆ system_nodes.py:
# system_nodes.py
"""
THE SYSTEM PARAMETER MANIFEST (v2.5)
------------------------------------
This file defines the "System Nodes" (Strategic Anchors) for an SSOL.

ONTOLOGICAL STANCE:
These parameters act as the "Fixed Future." The AI is instructed to treat these 
not as goals to be attempted, but as realities that have already occurred.
All speculative logic involves "looking back" from this fulfilled state 
to determine what necessary components (CEs) brought it into existence.
"""

SYSTEM_NODES = {
    # ==============================================================================
    # 1. IDENTITY & GOVERNANCE (Who "Did" This?)
    # ==============================================================================
    
    "OPERATOR": {
        "label": "Operator Identity",
        "icon": "fa-solid fa-user-astronaut",
        "color": "#607d8b", # Slate Blue
        "description": "The entity responsible for this fulfillment.",
        "examples": ["Grassroots Org", "University Lab", "Series-A Startup"],
        "prompt_injection": """
            OPERATIONAL CONTEXT: This result was achieved by an entity operating as a '{value}'. 
            Ensure all speculative history reflects the resources and limitations typical of this entity type.
        """
    },

    "DIRECTIVE": {
        "label": "Prime Directive",
        "icon": "fa-solid fa-fingerprint",
        "color": "#ab47bc", # Horizon Purple
        "description": "The guiding ethos that was preserved throughout.",
        "examples": ["Open Source Forever", "Leave No Trace", "Radical Transparency"],
        "prompt_injection": """
            ETHICAL MANDATE: Throughout the project's lifecycle, the directive '{value}' was strictly upheld. 
            Reject any 'means' that would have violated this 'end'.
        """
    },

    "AUTHORITY": {
        "label": "Governance Model",
        "icon": "fa-solid fa-gavel",
        "color": "#795548", # Brown
        "description": "How decisions were validated.",
        "examples": ["Benevolent Dictator", "DAO / Consensus", "Academic Board"],
        "prompt_injection": """
            GOVERNANCE STRUCTURE: Critical decisions were validated via '{value}'. 
            Identify Stakeholders who held veto power in this model.
        """
    },

    # ==============================================================================
    # 2. SCOPE & SCALE (The Physics of the Project)
    # ==============================================================================

    "SCALE": {
        "label": "Geographic Scope",
        "icon": "fa-solid fa-earth-americas",
        "color": "#3f51b5", # Indigo
        "description": "The physical or digital reach of the completed project.",
        "examples": ["Hyper-Local", "National", "Global / International"],
        "prompt_injection": """
            GEOGRAPHIC REACH: The solution successfully operated at a '{value}' scale. 
            Ensure legal, logistic, and cultural considerations match this footprint.
        """
    },

    "TOLERANCE": {
        "label": "Risk Appetite",
        "icon": "fa-solid fa-scale-unbalanced",
        "color": "#ff5722", # Deep Orange
        "description": "The philosophical approach to failure and experimentation.",
        "examples": ["Move Fast & Break Things", "Zero Failure Tolerance", "Academic Rigor"],
        "prompt_injection": """
            RISK PROFILE: The project operated with '{value}'. 
            Adjust the safety margins and validation steps in the Risk Nodes accordingly.
        """
    },

    # ==============================================================================
    # 3. THE FULFILLED REALITY (The "Done" State)
    # ==============================================================================

    "FULFILLMENT": {
        "label": "Delivery Fulfilled",
        "icon": "fa-solid fa-box-open",
        "color": "#26c6da", # Horizon Cyan
        "description": "The tangible reality that exists now that the work is done.",
        "examples": ["Operational Clinic", "Published Law", "Manufactured Widget"],
        "prompt_injection": """
            FUTURE PERFECT STANCE: The project has successfully delivered a '{value}'. 
            Treat this object/state as real and tangible. Work backward to identify the physical components required to assemble it.
        """
    },

    "TARGET": {
        "label": "Proof of Completion",
        "icon": "fa-solid fa-crosshairs",
        "color": "#66bb6a", # Success Green
        "description": "The metrics that proved the phase was complete.",
        "examples": ["N=500 Responses", "$1M Revenue", "Zero Carbon Certificate"],
        "prompt_injection": """
            VERIFICATION: We know the project was successful because we measured '{value}'. 
            Ensure the 'Action Phase' includes the specific mechanisms required to capture and verify this data.
        """
    },

    # ==============================================================================
    # 4. CONSTRAINTS & CONNECTIONS (The How)
    # ==============================================================================

    "TIMELINE": {
        "label": "Event Horizon",
        "icon": "fa-solid fa-calendar-check",
        "color": "#ffa726", # Warning Amber
        "description": "The date when the possibility became reality.",
        "examples": ["By Q3 2026", "Before the Election", "In 18 Months"],
        "prompt_injection": """
            TEMPORAL BACKCASTING: The project was completed by '{value}'. 
            Reverse-engineer the timeline from this date. If a Prerequisite takes 6 months, place it 6 months prior to this horizon.
        """
    },

    "BUDGET": {
        "label": "Economic Fuel",
        "icon": "fa-solid fa-coins",
        "color": "#8d6e63", # Bronze
        "description": "The capital constraints that shaped the solution.",
        "examples": ["Bootstrapped ($0)", "Grant Funded", "Venture Scale"],
        "prompt_injection": """
            ECONOMIC REALITY: The solution was architected within a '{value}' model. 
            Do not suggest resources or hiring plans that exceed this capital structure.
        """
    },

    "GAP": {
        "label": "The Catalyst",
        "icon": "fa-solid fa-puzzle-piece",
        "color": "#ef5350", # Danger Red
        "description": "The critical partnership or asset that bridged the gap.",
        "examples": ["University IRB", "Manufacturing Partner", "Legislative Sponsor"],
        "prompt_injection": """
            NETWORK CRITICALITY: Success was impossible without acquiring '{value}'. 
            In the 'Engagement Phase', identify the specific node where this partnership was secured.
        """
    },

    "LEGACY": {
        "label": "Enduring Impact",
        "icon": "fa-solid fa-seedling",
        "color": "#66bd0e", # Legacy Green
        "description": "What remains operative after the project team disbands.",
        "examples": ["Open Database", "Self-Sustaining Fund", "Community Charter"],
        "prompt_injection": """
            LEGACY DESIGN: After the 'Completion Phase', a '{value}' remained active. 
            Ensure the 'Legacy Phase' contains CEs that establish the governance and maintenance of this asset.
        """
    },

    # ==============================================================================
    # 5. THE WILDCARD (Extensibility)
    # ==============================================================================
    "CUSTOM": {
        "label": "Custom Parameter",
        "icon": "fa-solid fa-star",
        "color": "#ec407a", # Pink
        "description": "A unique constraint or attribute specific to this SSOL.",
        "examples": ["Specific Location", "Rare Material", "Family Commitment"],
        "prompt_injection": """
            SPECIAL CONDITION: Consider the custom parameter '{value}' as a primary constraint for all generated logic.
        """
    }
}

def get_valid_system_types():
    """Returns a list of all valid system node keys."""
    return list(SYSTEM_NODES.keys())

def get_system_node_config(key):
    """Safe retrieval of config with fallback."""
    return SYSTEM_NODES.get(key, SYSTEM_NODES['OPERATOR'])

ðŸŸª cos_table.js:
// cos_table.js
import { displayCEModal } from './ce_cards.js';
import { showLoadingSpinner, hideLoadingSpinner } from './base_functions.js';

// --- Utility Functions ---

function getBadgeColorVar(status) {
    switch (status) {
        case 'Proposed': return '#17a2b8'; // Info cyan
        case 'Active': return 'var(--warning)';
        case 'In Progress': return 'var(--warning)';
        case 'Completed': return 'var(--success)';
        case 'Verified': return 'var(--success)';
        case 'Rejected': return 'var(--danger)';
        default: return '#94a3b8'; // Muted gray
    }
}

function handleApiResponse(response) {
    if (!response.ok) {
        return response.json().then(errorData => {
            const message = errorData.error || errorData.message || JSON.stringify(errorData);
            throw new Error(`Server responded with ${response.status}: ${message}`);
        });
    }
    return response.json();
}

// --- DOM Manipulation & State ---

function storeOriginalValues(cosRow) {
    const statusBlock = cosRow.querySelector('.status-cell .status-block');
    const contentDisplay = cosRow.querySelector('.cos-content-cell .cos-content-display');
    const accountableDisplay = cosRow.querySelector('.cos-accountable-party-display');
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');

    cosRow.dataset.originalValues = JSON.stringify({
        status: statusBlock ? statusBlock.textContent.trim() : 'PROPOSED',
        contentHTML: contentDisplay ? contentDisplay.innerHTML : '',
        accountable: accountableDisplay ? accountableDisplay.textContent.trim() : '',
        date: dateDisplay ? dateDisplay.textContent.trim() : ''
    });
}

function revertToOriginalValues(cosRow) {
    if (!cosRow.dataset.originalValues) return;
    const original = JSON.parse(cosRow.dataset.originalValues);

    // Revert Status
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(original.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${original.status}</span>`;
    }

    // Revert Content
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = original.contentHTML;

    // Revert Meta
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = original.accountable;
    
    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = original.date;

    toggleEditModeUI(cosRow, false);
}

function updateRowDisplay(cosRow, cosData) {
    // 1. Update Status Block
    const statusCell = cosRow.querySelector('.status-cell');
    if (statusCell) {
        const color = getBadgeColorVar(cosData.status);
        statusCell.innerHTML = `<span class="status-block" style="background-color: ${color};">${cosData.status.toUpperCase()}</span>`;
    }

    // 2. Update Content (with potential new Pills)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    if (contentDisplay) contentDisplay.innerHTML = cosData.content;

    // 3. Update Fields
    const accDisplay = cosRow.querySelector('.cos-accountable-party-display');
    if (accDisplay) accDisplay.textContent = cosData.accountable_party || 'N/A';

    const dateDisplay = cosRow.querySelector('.cos-completion-date-display');
    if (dateDisplay) dateDisplay.textContent = cosData.completion_date || 'TBD';
}

function toggleEditModeUI(cosRow, editing) {
    cosRow.dataset.editing = editing.toString();

    // Toggle visibility classes
    // Using Bootstrap .d-none utilities
    const elements = [
        { display: '.cos-content-display', edit: '.cos-content-edit' },
        { display: '.cos-accountable-party-display', edit: '.cos-accountable-party-edit' },
        { display: '.cos-completion-date-display', edit: '.cos-completion-date-edit' }
    ];

    elements.forEach(pair => {
        const disp = cosRow.querySelector(pair.display);
        const edit = cosRow.querySelector(pair.edit);
        if (disp) disp.classList.toggle('d-none', editing);
        if (edit) edit.classList.toggle('d-none', !editing);
    });

    // Toggle Status Dropdown
    const statusCell = cosRow.querySelector('.status-cell');
    const currentBlock = statusCell.querySelector('.status-block');
    
    if (editing) {
        if (currentBlock) {
            const currentVal = currentBlock.textContent.trim();
            currentBlock.classList.add('d-none');
            if(!statusCell.querySelector('select')) {
                statusCell.insertAdjacentHTML('beforeend', createStatusDropdown(currentVal));
            }
        }
    } else {
        const select = statusCell.querySelector('select');
        if (select) select.remove();
        if (currentBlock) currentBlock.classList.remove('d-none');
    }

    // Toggle Action Buttons
    const viewBtns = cosRow.querySelector('.actions-cell .btn-group:not(.d-none)');
    const editBtns = cosRow.querySelector('.actions-cell .btn-group.d-none');
    
    // This logic handles the swapping of button groups defined in outcome.html
    const actionsCell = cosRow.querySelector('.actions-cell');
    const groups = actionsCell.querySelectorAll('.btn-group');
    
    if (groups.length >= 2) {
        // Group 0 is View actions, Group 1 is Edit actions
        groups[0].classList.toggle('d-none', editing);
        groups[1].classList.toggle('d-none', !editing);
    }
}

function stripHtmlForTextarea(htmlString) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlString;
    return tempDiv.textContent || tempDiv.innerText || "";
}

function createStatusDropdown(selectedStatus) {
    const statuses = ['Proposed', 'Active', 'Completed', 'Verified', 'Rejected'];
    const options = statuses.map(s => 
        `<option value="${s}" ${s.toUpperCase() === selectedStatus.toUpperCase() ? 'selected' : ''}>${s.toUpperCase()}</option>`
    ).join('');
    return `<select class="form-select form-select-sm status-edit-select shadow-none border-secondary">${options}</select>`;
}

// --- EVENT HANDLERS ---

function handlePhaseTableBodyClick(event) {
    const target = event.target;

    // 1. CE Pill Click (Launch Modal)
    const pill = target.closest('.ce-pill, .ce-capsule');
    if (pill) {
        event.preventDefault();
        handleCEPillClick(pill);
        return;
    }

    // 2. Action Buttons
    const button = target.closest('button');
    if (!button) return;

    const cosRow = button.closest('.cos-row');
    if (!cosRow) return;

    event.preventDefault();
    const cosId = cosRow.dataset.cosId;

    if (button.classList.contains('edit-cos-button')) {
        handleEditCOS(cosRow);
    } else if (button.classList.contains('update-cos-button')) {
        handleUpdateCOS(cosRow, cosId);
    } else if (button.classList.contains('cancel-cos-button')) {
        revertToOriginalValues(cosRow);
    } else if (button.classList.contains('delete-cos-button')) {
        handleDeleteCOS(cosRow, cosId);
    }
}

function handleEditCOS(cosRow) {
    if (cosRow.dataset.editing === 'true') return;
    storeOriginalValues(cosRow);

    // Pre-populate textarea (strip existing HTML/Pills for editing)
    const contentDisplay = cosRow.querySelector('.cos-content-display');
    const textarea = cosRow.querySelector('.cos-content-edit textarea');
    if (contentDisplay && textarea) {
        textarea.value = stripHtmlForTextarea(contentDisplay.innerHTML);
    }

    toggleEditModeUI(cosRow, true);
}

function handleUpdateCOS(cosRow, cosId) {
    // Gather Data
    const newContent = cosRow.querySelector('.cos-content-edit textarea')?.value.trim() || '';
    const newStatus = cosRow.querySelector('.status-edit-select')?.value || 'Proposed';
    const newAccountable = cosRow.querySelector('.cos-accountable-party-edit')?.value.trim();
    const newDate = cosRow.querySelector('.cos-completion-date-edit')?.value;

    // UI Feedback
    const btn = cosRow.querySelector('.update-cos-button');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;

    fetch(`/update_cos/${cosId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            content: newContent, 
            status: newStatus, 
            accountable_party: newAccountable, 
            completion_date: newDate 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success && data.cos) {
            updateRowDisplay(cosRow, data.cos);
            toggleEditModeUI(cosRow, false);
        } else {
            throw new Error('Failed to return COS data');
        }
    })
    .catch(err => alert(err.message))
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = origHtml;
    });
}

function handleDeleteCOS(cosRow, cosId) {
    if (!confirm('Are you sure? This will delete the Condition and all its internal logic nodes.')) return;

    fetch(`/delete_cos/${cosId}`, { method: 'DELETE' })
    .then(handleApiResponse)
    .then(() => cosRow.remove())
    .catch(err => alert(err.message));
}

function handleAddCOSButtonClick(event) {
    const button = event.currentTarget;
    
    // 1. Locate Context
    const container = button.closest('.phase-table-container');
    if (!container) return console.error("Phase container not found.");
    
    const ssolId = container.dataset.ssolId;
    if (!ssolId) return alert("System Error: SSOL Context Missing.");

    // 2. Visual Feedback (Loading State)
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-circle-notch fa-spin me-2"></i> INITIALIZING...`;

    // 3. Construct Payload
    const payload = {
        // Default placeholder text inviting definition
        content: "New Condition of Satisfaction - Click edit to define parameters.",
        status: "Proposed",
        ssol_id: ssolId
    };

    // 4. Network Request
    fetch(`/create_cos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(handleApiResponse) // Expects standard helper
    .then(data => {
        if (data.success && data.cos) {
            // 5. Inject into DOM
            const table = container.querySelector('table.retro-table');
            const newRowHtml = createRowHTML(data.cos); // Generate Row HTML

            if (table) {
                // SCENARIO A: Table exists, append row
                const tbody = table.querySelector('tbody');
                tbody.insertAdjacentHTML('beforeend', newRowHtml);
            } else {
                // SCENARIO B: Empty State (No table yet)
                // We must remove the "No protocols" placeholder and build the table skeleton
                const emptyState = container.querySelector('.text-center.text-muted');
                if(emptyState) emptyState.remove();

                // The wrapper for the table needs to go BEFORE the button footer
                // Note: outcome.html structure puts button in a div.p-3 at bottom of container
                const tableSkeleton = `
                    <table class="table table-hover mb-0 align-middle retro-table">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 110px;">Status</th>
                                <th>Condition of Satisfaction</th>
                                <th style="width: 18%;">Accountable</th>
                                <th style="width: 12%;">Target</th>
                                <th class="text-end pe-4" style="width: 100px;">Edit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${newRowHtml}
                        </tbody>
                    </table>
                `;
                
                // Insert as first element in the body (pushing the footer down)
                container.insertAdjacentHTML('afterbegin', tableSkeleton);
            }
        }
    })
    .catch(err => {
        console.error("COS Creation Failed:", err);
        alert("Failed to initialize new Condition. Check console.");
    })
    .finally(() => {
        // 6. Restore Button State
        button.disabled = false;
        button.innerHTML = originalHtml;
    });
}

// --- HELPER: Row Generator (Ensures visual consistency) ---
function createRowHTML(cos) {
    // Uses Horizon classes: status-block, retro-table alignment
    return `
    <tr class="cos-row" data-cos-id="${cos.id}" data-editing="false">
        <!-- Status -->
        <td class="status-cell ps-4">
            <span class="status-block font-data shadow-sm" 
                  style="background-color: #17a2b8; font-size: 0.6rem; padding: 4px 8px;">
                PROPOSED
            </span>
        </td>
        
        <!-- Content -->
        <td class="cos-content-cell py-3">
            <div class="cos-content-display font-body text-dark">${cos.content}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm font-body bg-light border-0 p-2">${cos.content.replace(/<[^>]*>?/gm, '')}</textarea>
            </div>
        </td>
        
        <!-- Accountable -->
        <td class="cos-accountable-party-cell">
            <div class="d-flex align-items-center gap-2 font-body fw-bold text-secondary small">
                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-muted border" style="width:28px;height:28px;"><i class="fas fa-user small"></i></div>
                <span class="cos-accountable-party-display">${cos.accountable_party || 'N/A'}</span>
                <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none" value="${cos.accountable_party || ''}">
            </div>
        </td>
        
        <!-- Date -->
        <td class="cos-completion-date-cell font-data text-muted small">
            <span class="cos-completion-date-display">${cos.completion_date || 'TBD'}</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none" value="${cos.completion_date || ''}">
        </td>
        
        <!-- Actions -->
        <td class="text-end actions-cell pe-4">
            <div class="btn-group cos-actions opacity-50 hover-opacity-100 transition">
                <button class="btn btn-sm btn-link text-muted edit-cos-button p-1"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-cos-button p-1"><i class="fas fa-trash"></i></button>
            </div>
            <div class="btn-group cos-actions d-none">
                <button class="btn btn-sm btn-success update-cos-button p-1"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button p-1"><i class="fas fa-times"></i></button>
            </div>
        </td>
    </tr>`;
}

// --- HTML Generator for New Rows (Matches outcome.html structure) ---
function createRowHTML(cos) {
    return `
    <tr class="cos-row" data-cos-id="${cos.id}" data-editing="false">
        <td class="status-cell">
            <span class="status-block" style="background-color: #17a2b8;">${cos.status.toUpperCase()}</span>
        </td>
        <td class="cos-content-cell">
            <div class="cos-content-display">${cos.content}</div>
            <div class="cos-content-edit d-none">
                <textarea class="form-control form-control-sm">${stripHtmlForTextarea(cos.content)}</textarea>
            </div>
        </td>
        <td class="cos-accountable-party-cell">
            <span class="cos-accountable-party-display">N/A</span>
            <input type="text" class="form-control form-control-sm cos-accountable-party-edit d-none">
        </td>
        <td class="cos-completion-date-cell font-data">
            <span class="cos-completion-date-display">TBD</span>
            <input type="date" class="form-control form-control-sm cos-completion-date-edit d-none">
        </td>
        <td class="text-end actions-cell">
            <div class="btn-group cos-actions">
                <button class="btn btn-sm btn-link text-muted edit-cos-button"><i class="fas fa-cog"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-cos-button"><i class="fas fa-trash"></i></button>
            </div>
            <div class="btn-group cos-actions d-none">
                <button class="btn btn-sm btn-success update-cos-button"><i class="fas fa-check"></i></button>
                <button class="btn btn-sm btn-secondary cancel-cos-button"><i class="fas fa-times"></i></button>
            </div>
        </td>
    </tr>`;
}

// --- MAIN: Launch the CE Modal Application ---

function handleCEPillClick(pill) {
    const ceId = pill.dataset.ceId;
    const ceType = pill.dataset.ceType || "Default";
    
    // Safe access to NODES using window object (injected in base.html)
    const iconClass = (window.NODES && window.NODES[ceType]?.icon) || 'fas fa-cube';
    
    showLoadingSpinner(`INITIALIZING ${ceType.toUpperCase()} NODE...`, iconClass);

    // Scrape context for the modal initialization
    const cosRow = pill.closest('.cos-row');
    const ssolGoal = document.getElementById('ssol-goal')?.textContent.trim() || "Goal";
    const cosContent = cosRow?.querySelector('.cos-content-display')?.innerHTML || '';
    
    const accItem = cosRow?.closest('.accordion-item');
    const phaseText = accItem?.querySelector('.phase-title')?.textContent.trim() || "Unknown";
    
    // Calculate phase index based on DOM order
    const allItems = Array.from(document.querySelectorAll('.accordion-item'));
    const phaseIndex = accItem ? allItems.indexOf(accItem) : 0;

    fetch(`/get_ce_modal/${encodeURIComponent(ceType)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            ce_id: ceId, 
            cos_content: cosContent, 
            phase_name: phaseText,
            phase_index: phaseIndex,
            ssol_goal: ssolGoal 
        })
    })
    .then(handleApiResponse)
    .then(data => {
        if(data.modal_html) {
            // Launch the full application controller
            displayCEModal(data.modal_html, ceId, ceType, data.ce_data);
        }
    })
    .catch(err => {
        console.error(err);
        alert("System Error: Could not load node application.");
    })
    .finally(() => hideLoadingSpinner());
}

// --- GLOBAL LISTENERS ---

document.addEventListener('DOMContentLoaded', () => {
    // Table Actions (Delegated)
    document.querySelectorAll('.phase-table-container').forEach(container => {
        container.addEventListener('click', handlePhaseTableBodyClick);
    });

    // Add COS Buttons
    document.querySelectorAll('.add-cos').forEach(btn => {
        btn.addEventListener('click', handleAddCOSButtonClick);
    });

    // PDF Export
    const pdfBtn = document.getElementById('save-as-pdf-button');
    if(pdfBtn) {
        pdfBtn.addEventListener('click', (e) => {
            // e.target.dataset.ssolId might need bubbling check if icon clicked
            const id = e.currentTarget.dataset.ssolId;
            // Call PDF function (omitted for brevity, assume similar to existing)
            alert("Generating PDF report...");
        });
    }
});

ðŸŸ§ ai_service.py:
import os
import json
import uuid
import logging
import asyncio
import re
from contextvars import ContextVar
from google import genai
from google.genai import types
from google.genai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from io import BytesIO
from dotenv import load_dotenv
from flask import current_app

# This import might seem unused but is needed for get_valid_node_types() if called from this module
from ce_nodes import get_valid_node_types

# --- Configuration & Initialization ---
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def sanitize_filename(filename: str) -> str:
    """Sanitizes a string to be a valid filename."""
    return re.sub(r'[^a-zA-Z0-9_.-]', '_', filename)

google_gemini_api_key = os.environ.get("GOOGLE_GEMINI_API")
gemini_model_name = os.getenv("GEMINI_MODEL_NAME")
gemini_thinking_model_name = os.getenv("GEMINI_THINKING_MODEL_NAME")
gemini_image_model_name = os.getenv("GEMINI_IMAGE_MODEL_NAME")

# --- ContextVar for Request-Scoped Client ---
_gemini_client_context: ContextVar = ContextVar('gemini_client', default=None)

def get_gemini_client():
    client = _gemini_client_context.get()
    if client is None:
        logging.info("Initializing Gemini client for current request context...")
        if not google_gemini_api_key:
            logging.error("CRITICAL: GOOGLE_GEMINI_API key is missing.")
            raise ConnectionError("Google Gemini API key is not configured.")
        client = genai.Client(api_key=google_gemini_api_key)
        _gemini_client_context.set(client)
        logging.info("Gemini client initialized successfully for this context.")
    return client

async def cleanup_gemini_client():
    client = _gemini_client_context.get()
    if client is not None and hasattr(client, 'aio'):
        try:
            if hasattr(client.aio, '_api_client') and hasattr(client.aio._api_client, '_aiohttp_session'):
                session = client.aio._api_client._aiohttp_session
                if session and not session.closed:
                    await session.close()
                    logging.debug("Closed aiohttp session for Gemini client in this context.")
        except Exception as e:
            logging.warning(f"Error closing Gemini client session: {e}")
        finally:
            _gemini_client_context.set(None)

# --- Core AI Functions ---

async def send_request_to_gemini(messages, generation_config=None, model=None, logger=None):
    if logger is None: logger = current_app.logger
    try:
        client = get_gemini_client()
        model_to_use = model or gemini_model_name
        logger.debug(f"Sending request to Gemini model '{model_to_use}' with messages: {messages}")
        contents = []
        for message in messages:
            if isinstance(message, dict) and 'role' in message and 'content' in message:
                role = 'model' if message['role'] in ['assistant', 'model'] else 'user'
                contents.append(types.Content(role=role, parts=[types.Part(text=message['content'])]))
            else:
                logger.warning(f"Invalid message format: {message}. Skipping this message.")

        if generation_config is None:
            generation_config = types.GenerateContentConfig(safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
        elif isinstance(generation_config, dict):
            generation_config.setdefault('safety_settings', [
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ])
            generation_config = types.GenerateContentConfig(**generation_config)

        response = await client.aio.models.generate_content(
            model=model_to_use,
            contents=contents,
            config=generation_config
        )
        logger.debug(f"Gemini API response: {response.text}")
        return response.text
    except Exception as e:
        logger.error(f"Error sending request to Gemini API: {e}", exc_info=True)
        raise

async def generate_chat_response(messages, role, task, model=None, temperature=0.75, retries=3, backoff_factor=2, logger=None, generation_config=None, system_instruction=None):
    if logger is None: logger = current_app.logger
    processed_messages = []
    for msg in messages:
        if msg.get('role') == 'system':
            if not processed_messages or processed_messages[0].get('role') != 'user':
                processed_messages.insert(0, {'role': 'user', 'content': msg['content']})
            else:
                processed_messages[0]['content'] = f"{msg['content']}\n\n{processed_messages[0]['content']}"
        else:
            processed_messages.append(msg)
    if system_instruction:
        if not processed_messages or processed_messages[0].get('role') != 'user':
            processed_messages.insert(0, {'role': 'user', 'content': system_instruction})
        else:
            processed_messages[0]['content'] = f"{system_instruction}\n\n{processed_messages[0]['content']}"

    model_to_use = model or gemini_thinking_model_name
    if generation_config is None:
        generation_config = types.GenerateContentConfig(
            temperature=temperature, top_p=0.95, top_k=40, max_output_tokens=8192,
            safety_settings=[
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
                types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            ]
        )
    elif isinstance(generation_config, dict):
        generation_config.setdefault('safety_settings', [
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
            types.SafetySetting(category=HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=HarmBlockThreshold.BLOCK_ONLY_HIGH),
        ])
        generation_config.setdefault('max_output_tokens', 8192)
        generation_config = types.GenerateContentConfig(**generation_config)

    last_exception = None
    for retry_attempt in range(retries):
        try:
            logger.debug(f"Sending request to Gemini (attempt {retry_attempt + 1}) for task '{task}'")
            raw_response = await send_request_to_gemini(processed_messages, generation_config, model_to_use, logger)
            response_content = raw_response
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_response, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                first_bracket = raw_response.find('[')
                first_curly = raw_response.find('{')
                start_index = -1
                if first_bracket != -1 and first_curly != -1:
                    start_index = min(first_bracket, first_curly)
                elif first_bracket != -1:
                    start_index = first_bracket
                else:
                    start_index = first_curly
                if start_index != -1:
                    start_char = raw_response[start_index]
                    end_char = ']' if start_char == '[' else '}'
                    end_index = raw_response.rfind(end_char)
                    if end_index > start_index:
                        response_content = raw_response[start_index : end_index + 1].strip()
            return response_content
        except Exception as e:
            last_exception = e
            if retry_attempt < retries - 1:
                sleep_time = backoff_factor ** (retry_attempt + 1)
                logger.warning(f"Error in generate_chat_response: {e}. Retrying in {sleep_time} seconds.")
                await asyncio.sleep(sleep_time)
            else:
                logger.error(f"Error in generate_chat_response: {e}. All retries exhausted.")
    if last_exception:
        raise last_exception

async def generate_chat_response_with_node_types(messages, role, task, temperature=0.75, retries=3, backoff_factor=2, logger=None):
    if logger is None: logger = current_app.logger
    node_types = get_valid_node_types()
    node_types_str = ', '.join(node_types)
    system_instruction = f"You are a helpful assistant. Please respond with information in JSON format. Valid Node Types: {node_types_str} **The response should be valid JSON.**"
    return await generate_chat_response(messages, role, task, temperature=temperature, retries=retries, backoff_factor=backoff_factor, logger=logger, system_instruction=system_instruction)

async def get_grounded_data(query, ce_type):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        model = gemini_thinking_model_name
        contents = [types.Content(role="user", parts=[types.Part.from_text(text=query)])]
        tools = [types.Tool(google_search=types.GoogleSearch())]
        generation_config = types.GenerateContentConfig(
            temperature=0.4, top_p=0.95, top_k=40, max_output_tokens=8192
        )
        response = await client.aio.models.generate_content(
            model=model,
            contents=contents,
            tools=tools,
            config=generation_config
        )
        response_content = ""
        if response and response.text:
            raw_text = response.text
            match = re.search(r"```(?:json)?\s*([\s\S]*?)\s*```", raw_text, re.DOTALL)
            if match:
                response_content = match.group(1).strip()
            else:
                start = raw_text.find('{')
                end = raw_text.rfind('}')
                if start != -1 and end != -1 and end > start:
                    response_content = raw_text[start:end+1]
                else:
                    logger.warning(f"No JSON found in grounded Gemini response. Raw: {raw_text}")
        else:
            logger.warning(f"Grounded Gemini response or text is None. Full response: {response}")

        if response_content:
            try:
                grounded_data = json.loads(response_content)
                return grounded_data
            except json.JSONDecodeError as e:
                logger.error(f"JSONDecode Error in get_grounded_data: {e}. Content: '{response_content}'")
                return None
        else:
            return None
    except Exception as e:
        logger.error(f"Error in get_grounded_data: {e}", exc_info=True)
        return None

async def generate_image(prompt: str, ssol_id: str):
    logger = current_app.logger
    try:
        client = get_gemini_client()
        logger.debug(f"generate_image (Gemini) - Sending prompt to API: '{prompt}'")
        
        generation_config = types.GenerateContentConfig(
            response_modalities=["TEXT", "IMAGE"]
        )
        
        # Now, make the API call using the defined config.
        response = await client.aio.models.generate_content(
            model=gemini_image_model_name,
            contents=prompt,
            config=generation_config
        )
   

        image_part = None
        for candidate in response.candidates:
            for part in candidate.content.parts:
                if part.inline_data is not None and part.inline_data.mime_type.startswith('image/'):
                    image_part = part
                    break
            if image_part:
                break

        if not image_part:
            raise ValueError("No image data found in Gemini response")

        image_bytes = image_part.inline_data.data
        image = Image.open(BytesIO(image_bytes))
        image_filename = f"ssol_image_{ssol_id}.png"
        sanitized_filename = sanitize_filename(image_filename)
        static_folder = current_app.static_folder
        image_folder = os.path.join(static_folder, 'images')
        os.makedirs(image_folder, exist_ok=True)
        image_file_path = os.path.join(image_folder, sanitized_filename)
        image.save(image_file_path)
        web_path = os.path.join('images', sanitized_filename).replace("\\", "/")
        logger.info(f"Image for SSOL {ssol_id} saved to: {web_path}")
        return web_path
    except Exception as e:
        logger.error(f"Error in generate_image for SSOL {ssol_id}: {e}", exc_info=True)
        raise

ðŸŸ© goal_selection.html:
{% extends 'base.html' %}

{% block content %}
<div class="horizon-wrapper">
  <div class="console-housing">
    <div class="screen-surface d-flex flex-column" style="min-height: 80vh;">
      
      <!-- 1. HEADER BAR -->
      <div class="bg-white border-bottom px-5 py-4 d-flex justify-content-between align-items-center shadow-sm z-20 flex-shrink-0">
        <div class="d-flex align-items-center gap-4">
           
           <!-- User Input Group -->
           <div id="user-input-display-container">
               <div class="font-data text-muted small text-uppercase letter-spacing-1 mb-1">Mission Parameter</div>
               
               <div class="d-flex align-items-center gap-3">
                   <h2 class="font-brand text-dark m-0 user-input-display" style="font-size: 2rem;">"{{ user_input }}"</h2>
                   <button class="btn btn-sm btn-link text-muted edit-user-input p-0" title="Edit"><i class="fas fa-pencil-alt"></i></button>
               </div>

               <!-- Horizon Instruction -->
               <div class="horizon-instruction">
                   Analogs Detected. Select Optimal Protocol Trajectory.
               </div>
           </div>
           
           <!-- Hidden Edit Form -->
           <div id="user-input-edit-container" class="d-none align-items-center gap-2">
               <input type="text" class="form-control form-control-lg font-brand user-input-edit" value="{{ user_input }}">
               <button class="btn btn-sm btn-success save-user-input"><i class="fas fa-check"></i></button>
               <button class="btn btn-sm btn-secondary cancel-user-input"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <div class="d-flex gap-3">
             <!-- "Speculate New" triggers JS in goal_selection.js -->
             <button type="button" class="btn btn-sm btn-outline-primary font-data rounded-pill px-4" id="generate-new-goals">
               <i class="fas fa-sync-alt me-2"></i> Re-Calculate
             </button>
             <a href="{{ url_for('routes_bp.index') }}" class="btn btn-sm btn-light border font-data rounded-pill px-4">
               Abort
             </a>
        </div>
      </div>

      <!-- 2. THE GOAL GRID -->
      <div class="goal-grid flex-grow-1 d-flex align-items-center justify-content-center bg-light" id="goalCardsContainer">
        
        {% for goal in goals %}
           <div class="flip-card {{ 'rejected' if not goal.is_compliant else '' }}" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
            <div class="flip-card-inner" data-delay="{{ 800 + (loop.index0 * 300) }}">
              
              <!-- BACK (Face Down) -->
              <div class="flip-card-back" 
                   style="background: {{ 'linear-gradient(135deg, #ffeb3b 0%, #ff9800 40%, #d32f2f 100%)' if not goal.is_compliant else 
                           ('linear-gradient(135deg, #ff7043 0%, #f4511e 100%)' if loop.index0 % 3 == 0 else 
                           'linear-gradient(135deg, #26c6da 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 
                           'linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%)') }};">
                <div class="card-pattern-overlay"></div>
                <div class="position-relative z-2 d-flex flex-column align-items-center">
                  <div class="bg-white bg-opacity-25 p-4 rounded-circle border border-2 border-white border-opacity-50 shadow-lg mb-3 backdrop-blur">
                    <i class="{{ goal.icon }} fa-3x text-white drop-shadow"></i>
                  </div>
                  {% if not goal.is_compliant %}
                  <div class="font-data text-white small bg-black bg-opacity-25 px-3 py-1 rounded-pill border border-white border-opacity-25 mt-2">Protocol Violation</div>
                  {% endif %}
                </div>
              </div>

              <!-- FRONT (Face Up) -->
              <div class="flip-card-front">
                <div class="card-header-plate" style="background: {{ 'linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%)' if not goal.is_compliant else ('linear-gradient(135deg, #ffcc80 0%, #ff7043 100%)' if loop.index0 % 3 == 0 else 'linear-gradient(135deg, #80deea 0%, #00bcd4 100%)' if loop.index0 % 3 == 1 else 'linear-gradient(135deg, #e1bee7 0%, #ab47bc 100%)') }};">
                    <div class="card-domain-badge shadow-sm">{{ goal.domain | upper }}</div>
                    <div class="card-icon-float">
                        <i class="{{ goal.icon }} fa-2x" style="color: {{ '#ef5350' if not goal.is_compliant else ('#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc') }};"></i>
                    </div>
                </div>

                <div class="card-body">
                  <h3 class="card-title">{{ goal.title }}</h3>
                  <p class="card-desc">{{ goal.goal }}</p>
                </div>

                <div class="card-footer bg-transparent border-0 pb-4">
                    {% if goal.is_compliant %}
                      <!-- The Outcome Form -->
                      <form action="{{ url_for('routes_bp.outcome') }}" method="post" class="outcome-form">
                        <input type="hidden" name="selected_goal" value="{{ goal.goal }}">
                        <input type="hidden" name="domain" value="{{ goal.domain }}">
                        <input type="hidden" name="domain_icon" value="{{ goal.icon }}">
                        <input type="hidden" name="selected_goal_title" value="{{ goal.title }}">
                        
                        <button type="submit" 
                                class="btn-select-pill w-100 shadow-md" 
                                style="background-color: {{ '#ff7043' if loop.index0 % 3 == 0 else '#00bcd4' if loop.index0 % 3 == 1 else '#ab47bc' }};">
                          INITIALIZE
                        </button>
                      </form>
                    {% else %}
                      <button class="btn-select-pill w-100" style="background-color: #ef5350; cursor: not-allowed; opacity: 0.8;">VIOLATION</button>
                    {% endif %}
                </div>
              </div>

            </div>
          </div>
        {% endfor %}
          
      </div>
    
    <!-- 3. FOOTER -->
    <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-white border-top mt-auto flex-shrink-0">
       <div class="d-flex gap-2">
          <div class="rounded-circle bg-success shadow-sm animate-pulse" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-warning shadow-sm" style="width: 8px; height: 8px;"></div>
          <div class="rounded-circle bg-info shadow-sm" style="width: 8px; height: 8px;"></div>
       </div>
       <span class="font-data text-muted small letter-spacing-2">SSPEC HORIZON v2025.23</span>
    </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Core logic for regenerations/edit (if kept external) -->
<script type="module" src="{{ url_for('static', filename='js/goal_selection.js') }}"></script>

<script type="module">
    import { showLoadingSpinner } from '{{ url_for("static", filename="js/base_functions.js") }}';

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Trigger Flip Animations on Load
        const cards = document.querySelectorAll('.flip-card-inner');
        cards.forEach(card => {
            const delay = parseInt(card.dataset.delay) || 1000;
            setTimeout(() => {
                card.closest('.flip-card').classList.add('revealed');
            }, delay);
        });

        // 2. Intercept Outcome Form Submission for HUD Spinner
        const forms = document.querySelectorAll('.outcome-form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                // The form will submit naturally, we just fire the visual overlay immediately
                const title = this.querySelector('input[name="selected_goal_title"]').value;
                const domain = this.querySelector('input[name="domain"]').value;
                
                // Show the Horizon HUD Spinner
                showLoadingSpinner(`INITIALIZING: ${title.toUpperCase()}`, "fa-solid fa-network-wired");
            });
        });
        
        // 3. Loading State for Regeneration Button
        const regenBtn = document.getElementById('generate-new-goals');
        if(regenBtn) {
            regenBtn.addEventListener('click', () => {
                 // Let goal_selection.js handle the fetch, but show spinner visually
                 // Note: goal_selection.js should ideally call hideLoadingSpinner() when done.
                 // If not, the page reload that often happens on regeneration will clear it.
                 showLoadingSpinner("SPECULATING NEW TRAJECTORIES", "fa-sync fa-spin");
            });
        }
    });
</script>
{% endblock %}
